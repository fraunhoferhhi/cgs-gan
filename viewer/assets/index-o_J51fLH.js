var Xk=Object.defineProperty;var jk=(h,e,t)=>e in h?Xk(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var rt=(h,e,t)=>jk(h,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const Yk="RenderFrame",Kk="RenderFrameTime",Qk="RenderPass",$k="RenderPassDetail",Zk="RenderAction",Jk="RenderTargetAlloc",e9="TextureAlloc",t9="ShaderAlloc",s9="ShaderCompile",i9="VRAM.Texture",a9="VRAM.Vb",n9="VRAM.Ib",r9="VRAM.Sb",o9="BindGroupAlloc",l9="BindGroupFormatAlloc",h9="RenderPipelineAlloc",c9="ComputePipelineAlloc",u9="PipelineLayoutAlloc",d9="Element",f9="Textures",p9="RenderQueue",tF="GpuTimings",bD="2.7.7",sF="af50405";function Db(h,e){for(const t in e){const s=e[t];Array.isArray(s)?h[t]=Db([],s):s&&typeof s=="object"?h[t]=Db({},s):h[t]=s}return h}const iF={create(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,h=>{const e=Math.random()*16|0;return(h==="x"?e:e&3|8).toString(16)})}},bt={delimiter:"/",join(...h){let e=h[0];for(let t=0;t<h.length-1;t++){const s=h[t],i=h[t+1];if(i[0]===bt.delimiter){e=i;continue}s&&i&&s[s.length-1]!==bt.delimiter&&i[0]!==bt.delimiter?e+=bt.delimiter+i:e+=i}return e},normalize(h){const e=h.startsWith(bt.delimiter),t=h.endsWith(bt.delimiter),s=h.split("/");let i="",a=[];for(let n=0;n<s.length;n++)if(s[n]!==""&&s[n]!=="."){if(s[n]===".."&&a.length>0){a=a.slice(0,a.length-2);continue}n>0&&a.push(bt.delimiter),a.push(s[n])}return i=a.join(""),!e&&i[0]===bt.delimiter&&(i=i.slice(1)),t&&i[i.length-1]!==bt.delimiter&&(i+=bt.delimiter),i},split(h){const e=h.lastIndexOf(bt.delimiter);return e!==-1?[h.substring(0,e),h.substring(e+1)]:["",h]},getBasename(h){return bt.split(h)[1]},getDirectory(h){return bt.split(h)[0]},getExtension(h){const e=h.split("?")[0].split(".").pop();return e!==h?`.${e}`:""},isRelativePath(h){return h.charAt(0)!=="/"&&h.match(/:\/\//)===null},extractPath(h){let e="";const t=h.split("/");let s=0;if(t.length>1)if(bt.isRelativePath(h))if(t[0]===".")for(s=0;s<t.length-1;++s)e+=s===0?t[s]:`/${t[s]}`;else if(t[0]==="..")for(s=0;s<t.length-1;++s)e+=s===0?t[s]:`/${t[s]}`;else for(e=".",s=0;s<t.length-1;++s)e+=`/${t[s]}`;else for(s=0;s<t.length-1;++s)e+=s===0?t[s]:`/${t[s]}`;return e}},m9=()=>{let h=!1;try{const e=Object.defineProperty({},"passive",{get:function(){return h=!0,!1}});window.addEventListener("testpassive",null,e),window.removeEventListener("testpassive",null,e)}catch{}return h},gh=typeof navigator<"u"?navigator.userAgent:"",Fc=typeof window<"u"?"browser":typeof global<"u"?"node":"worker",Vv=/android/i.test(gh)?"android":/ip(?:[ao]d|hone)/i.test(gh)?"ios":/windows/i.test(gh)?"windows":/mac os/i.test(gh)?"osx":/linux/i.test(gh)?"linux":/cros/i.test(gh)?"cros":null,_9=Fc!=="browser"?null:/Chrome\/|Chromium\/|Edg.*\//.test(gh)?"chrome":/Safari\//.test(gh)?"safari":/Firefox\//.test(gh)?"firefox":"other",g9=/xbox/i.test(gh),y9=Fc==="browser"&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),v9=Fc==="browser"&&(!!navigator.getGamepads||!!navigator.webkitGetGamepads),S9=typeof Worker<"u",b9=m9(),Ct={name:Vv,environment:Fc,global:(typeof globalThis<"u"&&globalThis)??(Fc==="browser"&&window)??(Fc==="node"&&global)??(Fc==="worker"&&self),browser:Fc==="browser",worker:Fc==="worker",desktop:["windows","osx","linux","cros"].includes(Vv),mobile:["android","ios"].includes(Vv),ios:Vv==="ios",android:Vv==="android",xbox:g9,gamepads:v9,touch:y9,workers:S9,passiveEvents:b9,browserName:_9},aF="abcdefghijklmnopqrstuvwxyz",nF="ABCDEFGHIJKLMNOPQRSTUVWXYZ",x9=aF+nF,NM=55296,rF=56319,vI=56320,T9=57343,E9=8205,SI=127462,bI=127487,A9=127995,C9=127999,w9=8400,R9=8447,FM=65024,BM=65039;function UM(h,e=0){const t=h.length;if(e<0||e>=t)return null;const s=h.charCodeAt(e);if(t>1&&s>=NM&&s<=rF){const i=h.charCodeAt(e+1);if(i>=vI&&i<=T9)return{code:(s-NM)*1024+i-vI+65536,long:!0}}return{code:s,long:!1}}function rd(h,e,t){if(!h)return!1;const s=UM(h);if(s){const i=s.code;return i>=e&&i<=t}return!1}function M9(h,e){if(e===h.length-1)return 1;if(rd(h[e],NM,rF)){const t=h.substring(e,e+2),s=h.substring(e+2,e+4);return rd(s,A9,C9)||rd(t,SI,bI)&&rd(s,SI,bI)?4:rd(s,FM,BM)?3:2}return rd(h[e+1],FM,BM)?2:1}const Ed={ASCII_LOWERCASE:aF,ASCII_UPPERCASE:nF,ASCII_LETTERS:x9,format(h,...e){for(let t=0;t<e.length;t++)h=h.replace(`{${t}}`,e[t]);return h},getCodePoint(h,e){const t=UM(h,e);return t&&t.code},getCodePoints(h){if(typeof h!="string")throw new TypeError("Not a string");let e=0;const t=[];let s;for(;s=UM(h,e);)t.push(s.code),e+=s.long?2:1;return t},getSymbols(h){if(typeof h!="string")throw new TypeError("Not a string");let e=0;const t=h.length,s=[];let i=0,a;for(;e<t;){if(i+=M9(h,e+i),a=h[e+i],rd(a,w9,R9)&&(a=h[e+i++]),rd(a,FM,BM)&&(a=h[e+i++]),a&&a.charCodeAt(0)===E9){a=h[e+i++];continue}const n=h.substring(e,e+i);s.push(n),e+=i,i=0}return s},fromCodePoint(){const h=[];let e,t,s;for(let i=0;i<arguments.length;++i)e=Number(arguments[i]),t=e-65536,s=e>65535?[(t>>10)+55296,t%1024+56320]:[e],h.push(String.fromCharCode.apply(null,s));return h.join("")}};class oF{constructor(e,t,s,i,a=!1){this._removed=!1,this.handler=e,this.name=t,this.callback=s,this.scope=i,this._once=a}off(){this._removed||this.handler.offByHandle(this)}on(e,t,s=this){return this.handler._addCallback(e,t,s,!1)}once(e,t,s=this){return this.handler._addCallback(e,t,s,!0)}set removed(e){e&&(this._removed=!0)}get removed(){return this._removed}}class Qe{initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(e,t,s,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){const n=this._callbackActive.get(e);n&&n===this._callbacks.get(e)&&this._callbackActive.set(e,n.slice())}const a=new oF(this,e,t,s,i);return this._callbacks.get(e).push(a),a}on(e,t,s=this){return this._addCallback(e,t,s,!1)}once(e,t,s=this){return this._addCallback(e,t,s,!0)}off(e,t,s){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(const[i,a]of this._callbackActive)this._callbacks.has(i)&&this._callbacks.get(i)===a&&this._callbackActive.set(i,a.slice());if(e)if(t){const i=this._callbacks.get(e);if(!i)return this;for(let a=0;a<i.length;a++)i[a].callback===t&&(s&&i[a].scope!==s||(i[a].removed=!0,i.splice(a,1),a--));i.length===0&&this._callbacks.delete(e)}else{const i=this._callbacks.get(e);if(i){for(let a=0;a<i.length;a++)i[a].removed=!0;this._callbacks.delete(e)}}else{for(const i of this._callbacks.values())for(let a=0;a<i.length;a++)i[a].removed=!0;this._callbacks.clear()}return this}offByHandle(e){const t=e.name;e.removed=!0,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());const s=this._callbacks.get(t);if(!s)return this;const i=s.indexOf(e);return i!==-1&&(s.splice(i,1),s.length===0&&this._callbacks.delete(t)),this}fire(e,t,s,i,a,n,r,l,u){if(!e)return this;const f=this._callbacks.get(e);if(!f)return this;let _;this._callbackActive.has(e)?this._callbackActive.get(e)!==f&&(_=f.slice()):this._callbackActive.set(e,f);for(let g=0;(_||this._callbackActive.get(e))&&g<(_||this._callbackActive.get(e)).length;g++){const y=(_||this._callbackActive.get(e))[g];if(y.callback&&(y.callback.call(y.scope,t,s,i,a,n,r,l,u),y._once)){const v=this._callbacks.get(e),x=v?v.indexOf(y):-1;if(x!==-1){this._callbackActive.get(e)===v&&this._callbackActive.set(e,this._callbackActive.get(e).slice());const C=this._callbacks.get(e);if(!C)continue;C[x].removed=!0,C.splice(x,1),C.length===0&&this._callbacks.delete(e)}}}return _||this._callbackActive.delete(e),this}hasEvent(e){var t;return!!((t=this._callbacks.get(e))!=null&&t.length)}constructor(){this._callbacks=new Map,this._callbackActive=new Map}}class lF{push(e,t){if(this._index[e])throw Error(`Key already in index ${e}`);const s=this._list.push(t)-1;this._index[e]=s}has(e){return this._index[e]!==void 0}get(e){const t=this._index[e];return t!==void 0?this._list[t]:null}remove(e){const t=this._index[e];if(t!==void 0){this._list.splice(t,1),delete this._index[e];for(e in this._index){const s=this._index[e];s>t&&(this._index[e]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(const e in this._index)delete this._index[e]}constructor(){this._list=[],this._index={}}}const D9=h=>{const e={};let t=e;return()=>(t===e&&(t=h()),t)},lh=class lh{static loadScript(e,t){const s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>{t(null)},s.onerror=()=>{t(`Failed to load script='${e}'`)},document.body.appendChild(s)}static loadWasm(e,t,s){const i=lh.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;i?lh.loadScript(i,a=>{if(a)s(a,null);else{const n=window[e];window[e]=void 0,n({locateFile:()=>t.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then(r=>{s(null,r)})}}):s("No supported wasm modules found.",null)}static getModule(e){return lh.modules.hasOwnProperty(e)||(lh.modules[e]={config:null,initializing:!1,instance:null,callbacks:[]}),lh.modules[e]}static initialize(e,t){if(t.initializing)return;const s=t.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(t.initializing=!0,lh.loadWasm(e,s,(i,a)=>{i?s.errorHandler?s.errorHandler(i):console.error(`failed to initialize module=${e} error=${i}`):(t.instance=a,t.callbacks.forEach(n=>{n(a)}))}))}};lh.modules={},lh.wasmSupported=D9(()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch{}return!1});let Cp=lh;class Pb{static setConfig(e,t){const s=Cp.getModule(e);s.config=t,s.callbacks.length>0&&Cp.initialize(e,s)}static getConfig(e){var t,s;return(s=(t=Cp.modules)==null?void 0:t[e])==null?void 0:s.config}static getInstance(e,t){const s=Cp.getModule(e);s.instance?t(s.instance):(s.callbacks.push(t),s.config&&Cp.initialize(e,s))}}class xD{constructor(e){this.offset=0,this.arraybuffer=e,this.dataView=new DataView(e)}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e=0){this.offset=e}skip(e){this.offset+=e}align(e){this.offset=this.offset+e-1&~(e-1)}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){let t="";for(let s=0;s<e;++s)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(e){for(let t=0;t<e.length;++t)e[t]=this.readU8()}readLine(){const e=this.dataView;let t="";for(;!(this.offset>=e.byteLength);){const s=String.fromCharCode(this.readU8());if(s===`
`)break;t+=s}return t}}class Lb{constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(e){let t=0,s=this.items.length-1;const i=e[this._sortBy];let a,n;for(;t<=s;)a=Math.floor((t+s)/2),n=this.items[a][this._sortBy],n<=i?t=a+1:n>i&&(s=a-1);return t}_doSort(e,t){const s=this._sortBy;return e[s]-t[s]}insert(e){const t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++}append(e){this.items.push(e),this.length++}remove(e){const t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)}sort(){const e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),e!==null&&(this.loopIndex=this.items.indexOf(e))}}const Cb=class Cb extends Qe{constructor(e){super(),this._index={},this._list=[],this._parent=e}add(...e){let t=!1;const s=this._processArguments(e,!0);if(!s.length)return t;for(let i=0;i<s.length;i++)this._index[s[i]]||(t=!0,this._index[s[i]]=!0,this._list.push(s[i]),this.fire("add",s[i],this._parent));return t&&this.fire("change",this._parent),t}remove(...e){let t=!1;if(!this._list.length)return t;const s=this._processArguments(e,!0);if(!s.length)return t;for(let i=0;i<s.length;i++)this._index[s[i]]&&(t=!0,delete this._index[s[i]],this._list.splice(this._list.indexOf(s[i]),1),this.fire("remove",s[i],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;const e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}has(...e){return this._list.length?this._has(this._processArguments(e)):!1}_has(e){if(!this._list.length||!e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].length===1){if(this._index[e[t][0]])return!0}else{let s=!0;for(let i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){const s=[];let i=[];if(!e||!e.length)return s;for(let a=0;a<e.length;a++)if(e[a]instanceof Array){t||(i=[]);for(let n=0;n<e[a].length;n++)typeof e[a][n]=="string"&&(t?s.push(e[a][n]):i.push(e[a][n]));!t&&i.length&&s.push(i)}else typeof e[a]=="string"&&(t?s.push(e[a]):s.push([e[a]]));return s}get size(){return this._list.length}};Cb.EVENT_ADD="add",Cb.EVENT_REMOVE="remove",Cb.EVENT_CHANGE="change";let Ib=Cb;const oo=typeof window<"u"&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now;function P9(h){let e="";if((h.authority||h.scheme)&&(h.host||h.hostpath))throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(h.host&&h.hostpath)throw new Error("Can't have 'host' and 'hostpath' option");if(h.path&&h.hostpath)throw new Error("Can't have 'path' and 'hostpath' option");return h.scheme&&(e+=`${h.scheme}:`),h.authority&&(e+=`//${h.authority}`),h.host&&(e+=h.host),h.path&&(e+=h.path),h.hostpath&&(e+=h.hostpath),h.query&&(e+=`?${h.query}`),h.fragment&&(e+=`#${h.fragment}`),e}const L9=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class cA{constructor(e){const t=e.match(L9);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}toString(){let e="";return this.scheme&&(e+=`${this.scheme}:`),this.authority&&(e+=`//${this.authority}`),e+=this.path,this.query&&(e+=`?${this.query}`),this.fragment&&(e+=`#${this.fragment}`),e}getQuery(){const e={};if(this.query){const t=decodeURIComponent(this.query).split("&");for(const s of t){const i=s.split("=");e[i[0]]=i[1]}}return e}setQuery(e){let t="";for(const s in e)e.hasOwnProperty(s)&&(t!==""&&(t+="&"),t+=`${encodeURIComponent(s)}=${encodeURIComponent(e[s])}`);this.query=t}}const wb=class wb{static set(e,t=!0){}static get(e){return wb._traceChannels.has(e)}};wb._traceChannels=new Set,wb.stack=!1;let CA=wb;const hF=0,X2=1,zM=4,cF=5,ge={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp(h,e,t){return h>=t?t:h<=e?e:h},intToBytes24(h){const e=h>>16&255,t=h>>8&255,s=h&255;return[e,t,s]},intToBytes32(h){const e=h>>24&255,t=h>>16&255,s=h>>8&255,i=h&255;return[e,t,s,i]},bytesToInt24(h,e,t){return h.length&&(t=h[2],e=h[1],h=h[0]),h<<16|e<<8|t},bytesToInt32(h,e,t,s){return h.length&&(s=h[3],t=h[2],e=h[1],h=h[0]),(h<<24|e<<16|t<<8|s)>>>0},lerp(h,e,t){return h+(e-h)*ge.clamp(t,0,1)},lerpAngle(h,e,t){return e-h>180&&(e-=360),e-h<-180&&(e+=360),ge.lerp(h,e,ge.clamp(t,0,1))},powerOfTwo(h){return h!==0&&!(h&h-1)},nextPowerOfTwo(h){return h--,h|=h>>1,h|=h>>2,h|=h>>4,h|=h>>8,h|=h>>16,h++,h},nearestPowerOfTwo(h){return Math.pow(2,Math.round(Math.log(h)/Math.log(2)))},random(h,e){const t=e-h;return Math.random()*t+h},smoothstep(h,e,t){return t<=h?0:t>=e?1:(t=(t-h)/(e-h),t*t*(3-2*t))},smootherstep(h,e,t){return t<=h?0:t>=e?1:(t=(t-h)/(e-h),t*t*t*(t*(t*6-15)+10))},roundUp(h,e){return e===0?h:Math.ceil(h/e)*e},between(h,e,t,s){const i=Math.min(e,t),a=Math.max(e,t);return s?h>=i&&h<=a:h>i&&h<a}},Oi=class Oi{constructor(e=0,t=0,s=0,i=1){const a=e.length;a===3||a===4?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=e[3]??1):(this.r=e,this.g=t,this.b=s,this.a=i)}clone(){const e=this.constructor;return new e(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i=1){return this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}linear(e=this){return this.r=Math.pow(e.r,2.2),this.g=Math.pow(e.g,2.2),this.b=Math.pow(e.b,2.2),this.a=e.a,this}gamma(e=this){return this.r=Math.pow(e.r,1/2.2),this.g=Math.pow(e.g,1/2.2),this.b=Math.pow(e.b,1/2.2),this.a=e.a,this}mulScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}fromString(e){const t=parseInt(e.replace("#","0x"),16);let s;return e.length>7?s=ge.intToBytes32(t):(s=ge.intToBytes24(t),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}fromArray(e,t=0){return this.r=e[t]??this.r,this.g=e[t+1]??this.g,this.b=e[t+2]??this.b,this.a=e[t+3]??this.a,this}toString(e,t){const{r:s,g:i,b:a,a:n}=this;if(t||s>1||i>1||a>1)return`${s.toFixed(3)}, ${i.toFixed(3)}, ${a.toFixed(3)}, ${n.toFixed(3)}`;let r=`#${((1<<24)+(Math.round(s*255)<<16)+(Math.round(i*255)<<8)+Math.round(a*255)).toString(16).slice(1)}`;if(e===!0){const l=Math.round(n*255).toString(16);this.a<16/255?r+=`0${l}`:r+=l}return r}toArray(e=[],t=0,s=!0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,s&&(e[t+3]=this.a),e}};Oi.BLACK=Object.freeze(new Oi(0,0,0,1)),Oi.BLUE=Object.freeze(new Oi(0,0,1,1)),Oi.CYAN=Object.freeze(new Oi(0,1,1,1)),Oi.GRAY=Object.freeze(new Oi(.5,.5,.5,1)),Oi.GREEN=Object.freeze(new Oi(0,1,0,1)),Oi.MAGENTA=Object.freeze(new Oi(1,0,1,1)),Oi.RED=Object.freeze(new Oi(1,0,0,1)),Oi.WHITE=Object.freeze(new Oi(1,1,1,1)),Oi.YELLOW=Object.freeze(new Oi(1,1,0,1));let xe=Oi;class uF{constructor(e,t=0){this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}evaluate(e,t=!1){(t||e<this._left||e>=this._right)&&this._reset(e);let s;const i=this._curve.type;if(i===cF)s=this._p0;else{const a=this._recip===0?0:(e-this._left)*this._recip;i===hF?s=ge.lerp(this._p0,this._p1,a):i===X2?s=ge.lerp(this._p0,this._p1,a*a*(3-2*a)):s=this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,a)}return s}_reset(e){const t=this._curve.keys,s=t.length;if(!s)this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0;else if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let i=0;for(;e>=t[i+1][0];)i++;this._left=t[i][0],this._right=t[i+1][0];const a=1/(this._right-this._left);this._recip=isFinite(a)?a:0,this._p0=t[i][1],this._p1=t[i+1][1],this._curve.type===zM&&this._calcTangents(t,i)}}_calcTangents(e,t){let s;const i=e[t],a=e[t+1];let n;if(t===0?s=[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:s=e[t-1],t===e.length-2?n=[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:n=e[t+2],this._curve.type===zM){const r=2*(a[0]-i[0])/(a[0]-s[0]),l=2*(a[0]-i[0])/(n[0]-i[0]);this._m0=this._curve.tension*(isFinite(r)?r:0)*(a[1]-s[1]),this._m1=this._curve.tension*(isFinite(l)?l:0)*(n[1]-i[1])}else{const r=(a[0]-i[0])/(i[0]-s[0]),l=(a[0]-i[0])/(n[0]-a[0]),u=i[1]+(s[1]-i[1])*(isFinite(r)?r:0),f=a[1]+(n[1]-a[1])*(isFinite(l)?l:0),_=this._curve.tension;this._m0=_*(a[1]-u),this._m1=_*(f-i[1])}}_evaluateHermite(e,t,s,i,a){const n=a*a,r=a+a,l=1-a,u=l*l;return e*((1+r)*u)+s*(a*u)+t*(n*(3-r))+i*(n*(a-1))}}class so{constructor(e){if(this.keys=[],this.type=X2,this.tension=.5,this._eval=new uF(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){const s=this.keys,i=s.length;let a=0;for(;a<i&&!(s[a][0]>e);a++);const n=[e,t];return this.keys.splice(a,0,n),n}get(e){return this.keys[e]}sort(){this.keys.sort((e,t)=>e[0]-t[0])}value(e){return this._eval.evaluate(e,!0)}closest(e){const t=this.keys,s=t.length;let i=2,a=null;for(let n=0;n<s;n++){const r=Math.abs(e-t[n][0]);if(i>=r)i=r,a=t[n];else break}return a}clone(){const e=new this.constructor;return e.keys=this.keys.map(t=>[...t]),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);const t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){const i=this.quantize(e);for(let a=0;a<i.length;++a)i[a]=Math.min(s,Math.max(t,i[a]));return i}}class Ad{constructor(...e){if(this.curves=[],this._type=X2,e.length>1)for(let t=0;t<e.length;t++)this.curves.push(new so(e[t]));else if(e.length===0)this.curves.push(new so);else{const t=e[0];if(typeof t=="number")for(let s=0;s<t;s++)this.curves.push(new so);else for(let s=0;s<t.length;s++)this.curves.push(new so(t[s]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){const s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){const e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);const t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let a=0;a<t;a++){const n=new uF(this.curves[a]);for(let r=0;r<e;r++)s[r*t+a]=n.evaluate(i*r)}return s}quantizeClamped(e,t,s){const i=this.quantize(e);for(let a=0;a<i.length;++a)i[a]=Math.min(s,Math.max(t,i[a]));return i}}const kM=new Float32Array(1),xI=new Int32Array(kM.buffer);class Xc{static float2Half(e){kM[0]=e;const t=xI[0];let s=t>>16&32768,i=t>>12&2047;const a=t>>23&255;return a<103?s:a>142?(s|=31744,s|=(a===255?0:1)&&t&8388607,s):a<113?(i|=2048,s|=(i>>114-a)+(i>>113-a&1),s):(s|=a-112<<10|i>>1,s+=i&1,s)}static float2RGBA8(e,t){kM[0]=e;const s=xI[0];t.r=(s>>24&255)/255,t.g=(s>>16&255)/255,t.b=(s>>8&255)/255,t.a=(s&255)/255}}class dF{static concentric(e,t){const s=[];s.push(0,0);const i=2*Math.PI/e/t;for(let a=1;a<=e;a++){const n=a/e,r=2*Math.PI*n,l=Math.max(1,Math.floor(r/i)),u=2*Math.PI/l;for(let f=0;f<l;f++){const _=f*u,g=n*Math.cos(_),y=n*Math.sin(_);s.push(g,y)}}return s}}const Ni=class Ni{constructor(e=0,t=0,s=0){e.length===3?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){const e=this.constructor;return new e(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){const s=e.x,i=e.y,a=e.z,n=t.x,r=t.y,l=t.z;return this.x=i*l-r*a,this.y=a*n-l*s,this.z=s*r-n*i,this}distance(e){const t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){const t=this.x*e.x+this.y*e.y+this.z*e.z,s=e.x*e.x+e.y*e.y+e.z*e.z,i=t/s;return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this.z=e[t+2]??this.z,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}};Ni.ZERO=Object.freeze(new Ni(0,0,0)),Ni.HALF=Object.freeze(new Ni(.5,.5,.5)),Ni.ONE=Object.freeze(new Ni(1,1,1)),Ni.UP=Object.freeze(new Ni(0,1,0)),Ni.DOWN=Object.freeze(new Ni(0,-1,0)),Ni.RIGHT=Object.freeze(new Ni(1,0,0)),Ni.LEFT=Object.freeze(new Ni(-1,0,0)),Ni.FORWARD=Object.freeze(new Ni(0,0,-1)),Ni.BACK=Object.freeze(new Ni(0,0,1));let H=Ni;const Vg=class Vg{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){const e=this.constructor;return new e().copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e=new H){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new H){return e.set(this.data[3],this.data[4],this.data[5])}getZ(e=new H){return e.set(this.data[6],this.data[7],this.data[8])}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){const e=this.data;return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===1&&e[5]===0&&e[6]===0&&e[7]===0&&e[8]===1}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return`[${this.data.join(", ")}]`}transpose(e=this){const t=e.data,s=this.data;if(t===s){let i;i=t[1],s[1]=t[3],s[3]=i,i=t[2],s[2]=t[6],s[6]=i,i=t[5],s[5]=t[7],s[7]=i}else s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=t[1],s[4]=t[4],s[5]=t[7],s[6]=t[2],s[7]=t[5],s[8]=t[8];return this}setFromMat4(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}setFromQuat(e){const t=e.x,s=e.y,i=e.z,a=e.w,n=t+t,r=s+s,l=i+i,u=t*n,f=t*r,_=t*l,g=s*r,y=s*l,v=i*l,x=a*n,C=a*r,M=a*l,w=this.data;return w[0]=1-(g+v),w[1]=f+M,w[2]=_-C,w[3]=f-M,w[4]=1-(u+v),w[5]=y+x,w[6]=_+C,w[7]=y-x,w[8]=1-(u+g),this}invertMat4(e){const t=e.data,s=t[0],i=t[1],a=t[2],n=t[4],r=t[5],l=t[6],u=t[8],f=t[9],_=t[10],g=_*r-l*f,y=-_*i+a*f,v=l*i-a*r,x=-_*n+l*u,C=_*s-a*u,M=-l*s+a*n,w=f*n-r*u,T=-f*s+i*u,R=r*s-i*n,D=s*g+i*x+a*w;if(D===0)this.setIdentity();else{const I=1/D,U=this.data;U[0]=g*I,U[1]=y*I,U[2]=v*I,U[3]=x*I,U[4]=C*I,U[5]=M*I,U[6]=w*I,U[7]=T*I,U[8]=R*I}return this}transformVector(e,t=new H){const s=this.data,{x:i,y:a,z:n}=e;return t.x=i*s[0]+a*s[3]+n*s[6],t.y=i*s[1]+a*s[4]+n*s[7],t.z=i*s[2]+a*s[5]+n*s[8],t}};Vg.IDENTITY=Object.freeze(new Vg),Vg.ZERO=Object.freeze(new Vg().set([0,0,0,0,0,0,0,0,0]));let ol=Vg;const Xa=class Xa{constructor(e=0,t=0){e.length===2?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){const e=this.constructor;return new e(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){const t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s}return this}rotate(e){const t=Math.atan2(this.x,this.y)+e*ge.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*s,this.y=Math.cos(t)*s,this}angle(){return Math.atan2(this.x,this.y)*ge.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*ge.RAD_TO_DEG}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this}toString(){return`[${this.x}, ${this.y}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}};Xa.ZERO=Object.freeze(new Xa(0,0)),Xa.HALF=Object.freeze(new Xa(.5,.5)),Xa.ONE=Object.freeze(new Xa(1,1)),Xa.UP=Object.freeze(new Xa(0,1)),Xa.DOWN=Object.freeze(new Xa(0,-1)),Xa.RIGHT=Object.freeze(new Xa(1,0)),Xa.LEFT=Object.freeze(new Xa(-1,0));let Ee=Xa;const dd=class dd{constructor(e=0,t=0,s=0,i=0){e.length===4?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){const e=this.constructor;return new e(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=e.w*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this.z=e[t+2]??this.z,this.w=e[t+3]??this.w,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}};dd.ZERO=Object.freeze(new dd(0,0,0,0)),dd.HALF=Object.freeze(new dd(.5,.5,.5,.5)),dd.ONE=Object.freeze(new dd(1,1,1,1));let Ie=dd;const Gv=new Ee,Ho=new H,sh=new H,ih=new H,aE=new H,Mp=class Mp{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(e,t,s,i,a){a?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s)}add2(e,t){const s=e.data,i=t.data,a=this.data;return a[0]=s[0]+i[0],a[1]=s[1]+i[1],a[2]=s[2]+i[2],a[3]=s[3]+i[3],a[4]=s[4]+i[4],a[5]=s[5]+i[5],a[6]=s[6]+i[6],a[7]=s[7]+i[7],a[8]=s[8]+i[8],a[9]=s[9]+i[9],a[10]=s[10]+i[10],a[11]=s[11]+i[11],a[12]=s[12]+i[12],a[13]=s[13]+i[13],a[14]=s[14]+i[14],a[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){const e=this.constructor;return new e().copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){const e=this.data;return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}mul2(e,t){const s=e.data,i=t.data,a=this.data,n=s[0],r=s[1],l=s[2],u=s[3],f=s[4],_=s[5],g=s[6],y=s[7],v=s[8],x=s[9],C=s[10],M=s[11],w=s[12],T=s[13],R=s[14],D=s[15];let I,U,O,N;return I=i[0],U=i[1],O=i[2],N=i[3],a[0]=n*I+f*U+v*O+w*N,a[1]=r*I+_*U+x*O+T*N,a[2]=l*I+g*U+C*O+R*N,a[3]=u*I+y*U+M*O+D*N,I=i[4],U=i[5],O=i[6],N=i[7],a[4]=n*I+f*U+v*O+w*N,a[5]=r*I+_*U+x*O+T*N,a[6]=l*I+g*U+C*O+R*N,a[7]=u*I+y*U+M*O+D*N,I=i[8],U=i[9],O=i[10],N=i[11],a[8]=n*I+f*U+v*O+w*N,a[9]=r*I+_*U+x*O+T*N,a[10]=l*I+g*U+C*O+R*N,a[11]=u*I+y*U+M*O+D*N,I=i[12],U=i[13],O=i[14],N=i[15],a[12]=n*I+f*U+v*O+w*N,a[13]=r*I+_*U+x*O+T*N,a[14]=l*I+g*U+C*O+R*N,a[15]=u*I+y*U+M*O+D*N,this}mulAffine2(e,t){const s=e.data,i=t.data,a=this.data,n=s[0],r=s[1],l=s[2],u=s[4],f=s[5],_=s[6],g=s[8],y=s[9],v=s[10],x=s[12],C=s[13],M=s[14];let w,T,R;return w=i[0],T=i[1],R=i[2],a[0]=n*w+u*T+g*R,a[1]=r*w+f*T+y*R,a[2]=l*w+_*T+v*R,a[3]=0,w=i[4],T=i[5],R=i[6],a[4]=n*w+u*T+g*R,a[5]=r*w+f*T+y*R,a[6]=l*w+_*T+v*R,a[7]=0,w=i[8],T=i[9],R=i[10],a[8]=n*w+u*T+g*R,a[9]=r*w+f*T+y*R,a[10]=l*w+_*T+v*R,a[11]=0,w=i[12],T=i[13],R=i[14],a[12]=n*w+u*T+g*R+x,a[13]=r*w+f*T+y*R+C,a[14]=l*w+_*T+v*R+M,a[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t=new H){const s=this.data,{x:i,y:a,z:n}=e;return t.x=i*s[0]+a*s[4]+n*s[8]+s[12],t.y=i*s[1]+a*s[5]+n*s[9]+s[13],t.z=i*s[2]+a*s[6]+n*s[10]+s[14],t}transformVector(e,t=new H){const s=this.data,{x:i,y:a,z:n}=e;return t.x=i*s[0]+a*s[4]+n*s[8],t.y=i*s[1]+a*s[5]+n*s[9],t.z=i*s[2]+a*s[6]+n*s[10],t}transformVec4(e,t=new Ie){const s=this.data,{x:i,y:a,z:n,w:r}=e;return t.x=i*s[0]+a*s[4]+n*s[8]+r*s[12],t.y=i*s[1]+a*s[5]+n*s[9]+r*s[13],t.z=i*s[2]+a*s[6]+n*s[10]+r*s[14],t.w=i*s[3]+a*s[7]+n*s[11]+r*s[15],t}setLookAt(e,t,s){ih.sub2(e,t).normalize(),sh.copy(s).normalize(),Ho.cross(sh,ih).normalize(),sh.cross(ih,Ho);const i=this.data;return i[0]=Ho.x,i[1]=Ho.y,i[2]=Ho.z,i[3]=0,i[4]=sh.x,i[5]=sh.y,i[6]=sh.z,i[7]=0,i[8]=ih.x,i[9]=ih.y,i[10]=ih.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,a,n){const r=2*a,l=t-e,u=i-s,f=n-a,_=this.data;return _[0]=r/l,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=r/u,_[6]=0,_[7]=0,_[8]=(t+e)/l,_[9]=(i+s)/u,_[10]=(-n-a)/f,_[11]=-1,_[12]=0,_[13]=0,_[14]=-r*n/f,_[15]=0,this}setPerspective(e,t,s,i,a){return Mp._getPerspectiveHalfSize(Gv,e,t,s,a),this.setFrustum(-Gv.x,Gv.x,-Gv.y,Gv.y,s,i)}setOrtho(e,t,s,i,a,n){const r=this.data;return r[0]=2/(t-e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(i-s),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(n-a),r[11]=0,r[12]=-(t+e)/(t-e),r[13]=-(i+s)/(i-s),r[14]=-(n+a)/(n-a),r[15]=1,this}setFromAxisAngle(e,t){t*=ge.DEG_TO_RAD;const{x:s,y:i,z:a}=e,n=Math.cos(t),r=Math.sin(t),l=1-n,u=l*s,f=l*i,_=this.data;return _[0]=u*s+n,_[1]=u*i+r*a,_[2]=u*a-r*i,_[3]=0,_[4]=u*i-r*a,_[5]=f*i+n,_[6]=f*a+r*s,_[7]=0,_[8]=u*a+r*i,_[9]=f*a-s*r,_[10]=l*a*a+n,_[11]=0,_[12]=0,_[13]=0,_[14]=0,_[15]=1,this}setTranslate(e,t,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){const i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){const a=this.data;return a[0]=s*.5,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=i*.5,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=.5,a[11]=0,a[12]=e+s*.5,a[13]=t+i*.5,a[14]=.5,a[15]=1,this}setReflection(e,t){const s=e.x,i=e.y,a=e.z,n=this.data;return n[0]=1-2*s*s,n[1]=-2*s*i,n[2]=-2*s*a,n[3]=0,n[4]=-2*s*i,n[5]=1-2*i*i,n[6]=-2*i*a,n[7]=0,n[8]=-2*s*a,n[9]=-2*i*a,n[10]=1-2*a*a,n[11]=0,n[12]=-2*s*t,n[13]=-2*i*t,n[14]=-2*a*t,n[15]=1,this}invert(e=this){const t=e.data,s=t[0],i=t[1],a=t[2],n=t[3],r=t[4],l=t[5],u=t[6],f=t[7],_=t[8],g=t[9],y=t[10],v=t[11],x=t[12],C=t[13],M=t[14],w=t[15],T=s*l-i*r,R=s*u-a*r,D=s*f-n*r,I=i*u-a*l,U=i*f-n*l,O=a*f-n*u,N=_*C-g*x,z=_*M-y*x,X=_*w-v*x,Y=g*M-y*C,F=g*w-v*C,q=y*w-v*M,G=T*q-R*F+D*Y+I*X-U*z+O*N;if(G===0)this.setIdentity();else{const W=1/G,k=this.data;k[0]=(l*q-u*F+f*Y)*W,k[1]=(-i*q+a*F-n*Y)*W,k[2]=(C*O-M*U+w*I)*W,k[3]=(-g*O+y*U-v*I)*W,k[4]=(-r*q+u*X-f*z)*W,k[5]=(s*q-a*X+n*z)*W,k[6]=(-x*O+M*D-w*R)*W,k[7]=(_*O-y*D+v*R)*W,k[8]=(r*F-l*X+f*N)*W,k[9]=(-s*F+i*X-n*N)*W,k[10]=(x*U-C*D+w*T)*W,k[11]=(-_*U+g*D-v*T)*W,k[12]=(-r*Y+l*z-u*N)*W,k[13]=(s*Y-i*z+a*N)*W,k[14]=(-x*I+C*R-M*T)*W,k[15]=(_*I-g*R+y*T)*W}return this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){const i=t.x,a=t.y,n=t.z,r=t.w,l=s.x,u=s.y,f=s.z,_=i+i,g=a+a,y=n+n,v=i*_,x=i*g,C=i*y,M=a*g,w=a*y,T=n*y,R=r*_,D=r*g,I=r*y,U=this.data;return U[0]=(1-(M+T))*l,U[1]=(x+I)*l,U[2]=(C-D)*l,U[3]=0,U[4]=(x-I)*u,U[5]=(1-(v+T))*u,U[6]=(w+R)*u,U[7]=0,U[8]=(C+D)*f,U[9]=(w-R)*f,U[10]=(1-(v+M))*f,U[11]=0,U[12]=e.x,U[13]=e.y,U[14]=e.z,U[15]=1,this}transpose(e=this){const t=e.data,s=this.data;if(t===s){let i;i=t[1],s[1]=t[4],s[4]=i,i=t[2],s[2]=t[8],s[8]=i,i=t[3],s[3]=t[12],s[12]=i,i=t[6],s[6]=t[9],s[9]=i,i=t[7],s[7]=t[13],s[13]=i,i=t[11],s[11]=t[14],s[14]=i}else s[0]=t[0],s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=t[1],s[5]=t[5],s[6]=t[9],s[7]=t[13],s[8]=t[2],s[9]=t[6],s[10]=t[10],s[11]=t[14],s[12]=t[3],s[13]=t[7],s[14]=t[11],s[15]=t[15];return this}getTranslation(e=new H){return e.set(this.data[12],this.data[13],this.data[14])}getX(e=new H){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new H){return e.set(this.data[4],this.data[5],this.data[6])}getZ(e=new H){return e.set(this.data[8],this.data[9],this.data[10])}getScale(e=new H){return this.getX(Ho),this.getY(sh),this.getZ(ih),e.set(Ho.length(),sh.length(),ih.length()),e}get scaleSign(){return this.getX(Ho),this.getY(sh),this.getZ(ih),Ho.cross(Ho,sh),Ho.dot(ih)<0?-1:1}setFromEulerAngles(e,t,s){e*=ge.DEG_TO_RAD,t*=ge.DEG_TO_RAD,s*=ge.DEG_TO_RAD;const i=Math.sin(-e),a=Math.cos(-e),n=Math.sin(-t),r=Math.cos(-t),l=Math.sin(-s),u=Math.cos(-s),f=this.data;return f[0]=r*u,f[1]=-r*l,f[2]=n,f[3]=0,f[4]=a*l+u*i*n,f[5]=a*u-i*n*l,f[6]=-r*i,f[7]=0,f[8]=i*l-a*u*n,f[9]=u*i+a*n*l,f[10]=a*r,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,this}getEulerAngles(e=new H){this.getScale(aE);const t=aE.x,s=aE.y,i=aE.z;if(t===0||s===0||i===0)return e.set(0,0,0);const a=this.data,n=Math.asin(-a[2]/t),r=Math.PI*.5;let l,u;return n<r?n>-r?(l=Math.atan2(a[6]/s,a[10]/i),u=Math.atan2(a[1]/t,a[0]/t)):(u=0,l=-Math.atan2(a[4]/s,a[5]/s)):(u=0,l=Math.atan2(a[4]/s,a[5]/s)),e.set(l,n,u).mulScalar(ge.RAD_TO_DEG)}toString(){return`[${this.data.join(", ")}]`}};Mp.IDENTITY=Object.freeze(new Mp),Mp.ZERO=Object.freeze(new Mp().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));let Me=Mp;const Gg=class Gg{constructor(e=0,t=0,s=0,i=1){e.length===4?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}clone(){const e=this.constructor;return new e(this.x,this.y,this.z,this.w)}conjugate(e=this){return this.x=e.x*-1,this.y=e.y*-1,this.z=e.z*-1,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){let t=Math.acos(this.w)*2;const s=Math.sin(t/2);return s!==0?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*ge.RAD_TO_DEG}getEulerAngles(e=new H){let t,s,i;const a=this.x,n=this.y,r=this.z,l=this.w,u=2*(l*n-a*r);return u<=-.99999?(t=2*Math.atan2(a,l),s=-Math.PI/2,i=0):u>=.99999?(t=2*Math.atan2(a,l),s=Math.PI/2,i=0):(t=Math.atan2(2*(l*a+n*r),1-2*(a*a+n*n)),s=Math.asin(u),i=Math.atan2(2*(l*r+a*n),1-2*(n*n+r*r))),e.set(t,s,i).mulScalar(ge.RAD_TO_DEG)}invert(e=this){return this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){const t=this.x,s=this.y,i=this.z,a=this.w,n=e.x,r=e.y,l=e.z,u=e.w;return this.x=a*n+t*u+s*l-i*r,this.y=a*r+s*u+i*n-t*l,this.z=a*l+i*u+t*r-s*n,this.w=a*u-t*n-s*r-i*l,this}mulScalar(e,t=this){return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e,this}mul2(e,t){const s=e.x,i=e.y,a=e.z,n=e.w,r=t.x,l=t.y,u=t.z,f=t.w;return this.x=n*r+s*f+i*u-a*l,this.y=n*l+i*f+a*r-s*u,this.z=n*u+a*f+s*l-i*r,this.w=n*f-s*r-i*l-a*u,this}normalize(e=this){let t=e.length();return t===0?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){t*=.5*ge.DEG_TO_RAD;const s=Math.sin(t),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof H){const _=e;e=_.x,t=_.y,s=_.z}const i=.5*ge.DEG_TO_RAD;e*=i,t*=i,s*=i;const a=Math.sin(e),n=Math.cos(e),r=Math.sin(t),l=Math.cos(t),u=Math.sin(s),f=Math.cos(s);return this.x=a*l*f-n*r*u,this.y=n*r*f+a*l*u,this.z=n*l*u-a*r*f,this.w=n*l*f+a*r*u,this}setFromMat4(e){const t=e.data;let s=t[0],i=t[1],a=t[2],n=t[4],r=t[5],l=t[6],u=t[8],f=t[9],_=t[10],g;return g=s*s+i*i+a*a,g===0?this.set(0,0,0,1):(g=1/Math.sqrt(g),s*=g,i*=g,a*=g,g=n*n+r*r+l*l,g===0?this.set(0,0,0,1):(g=1/Math.sqrt(g),n*=g,r*=g,l*=g,g=u*u+f*f+_*_,g===0?this.set(0,0,0,1):(g=1/Math.sqrt(g),u*=g,f*=g,_*=g,_<0?s>r?this.set(1+s-r-_,i+n,u+a,l-f):this.set(i+n,1-s+r-_,l+f,u-a):s<-r?this.set(u+a,l+f,1-s-r+_,i-n):this.set(l-f,u-a,i-n,1+s+r+_),this.mulScalar(1/this.length()))))}setFromDirections(e,t){const s=1+e.dot(t);return s<Number.EPSILON?Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x,this.w=0):(this.x=0,this.y=-e.z,this.z=e.y,this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=s),this.normalize()}slerp(e,t,s){const i=e.x,a=e.y,n=e.z,r=e.w;let l=t.x,u=t.y,f=t.z,_=t.w,g=r*_+i*l+a*u+n*f;if(g<0&&(_=-_,l=-l,u=-u,f=-f,g=-g),Math.abs(g)>=1)return this.w=r,this.x=i,this.y=a,this.z=n,this;const y=Math.acos(g),v=Math.sqrt(1-g*g);if(Math.abs(v)<.001)return this.w=r*.5+_*.5,this.x=i*.5+l*.5,this.y=a*.5+u*.5,this.z=n*.5+f*.5,this;const x=Math.sin((1-s)*y)/v,C=Math.sin(s*y)/v;return this.w=r*x+_*C,this.x=i*x+l*C,this.y=a*x+u*C,this.z=n*x+f*C,this}transformVector(e,t=new H){const s=e.x,i=e.y,a=e.z,n=this.x,r=this.y,l=this.z,u=this.w,f=u*s+r*a-l*i,_=u*i+l*s-n*a,g=u*a+n*i-r*s,y=-n*s-r*i-l*a;return t.x=f*u+y*-n+_*-l-g*-r,t.y=_*u+y*-r+g*-n-f*-l,t.z=g*u+y*-l+f*-r-_*-n,t}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}};Gg.IDENTITY=Object.freeze(new Gg(0,0,0,1)),Gg.ZERO=Object.freeze(new Gg(0,0,0,0));let Ne=Gg;const tg=new H,sg=new H,TI=new H,EI=new H,I9=new H;class wt{constructor(e,t){this.center=new H,this.halfExtents=new H(.5,.5,.5),this._min=new H,this._max=new H,e&&this.center.copy(e),t&&this.halfExtents.copy(t)}add(e){const t=this.center,s=t.x,i=t.y,a=t.z,n=this.halfExtents,r=n.x,l=n.y,u=n.z;let f=s-r,_=s+r,g=i-l,y=i+l,v=a-u,x=a+u;const C=e.center,M=C.x,w=C.y,T=C.z,R=e.halfExtents,D=R.x,I=R.y,U=R.z,O=M-D,N=M+D,z=w-I,X=w+I,Y=T-U,F=T+U;O<f&&(f=O),N>_&&(_=N),z<g&&(g=z),X>y&&(y=X),Y<v&&(v=Y),F>x&&(x=F),t.x=(f+_)*.5,t.y=(g+y)*.5,t.z=(v+x)*.5,n.x=(_-f)*.5,n.y=(y-g)*.5,n.z=(x-v)*.5}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new wt(this.center,this.halfExtents)}intersects(e){const t=this.getMax(),s=this.getMin(),i=e.getMax(),a=e.getMin();return s.x<=i.x&&t.x>=a.x&&s.y<=i.y&&t.y>=a.y&&s.z<=i.z&&t.z>=a.z}_intersectsRay(e,t){const s=tg.copy(this.getMin()).sub(e.origin),i=sg.copy(this.getMax()).sub(e.origin),a=e.direction;a.x===0?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=a.x,i.x/=a.x),a.y===0?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=a.y,i.y/=a.y),a.z===0?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=a.z,i.z/=a.z);const n=TI.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),r=EI.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),l=Math.min(Math.min(r.x,r.y),r.z),u=Math.max(Math.max(n.x,n.y),n.z),f=l>=u&&u>=0;return f&&t.copy(e.direction).mulScalar(u).add(e.origin),f}_fastIntersectsRay(e){const t=tg,s=sg,i=TI,a=EI,n=I9,r=e.direction;return t.sub2(e.origin,this.center),a.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),i.mul2(t,r),!(a.x>this.halfExtents.x&&i.x>=0||a.y>this.halfExtents.y&&i.y>=0||a.z>this.halfExtents.z&&i.z>=0||(n.set(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)),s.cross(r,t),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),s.x>this.halfExtents.y*n.z+this.halfExtents.z*n.y)||s.y>this.halfExtents.x*n.z+this.halfExtents.z*n.x||s.z>this.halfExtents.x*n.y+this.halfExtents.y*n.x)}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){const t=this.getMin(),s=this.getMax();return!(e.x<t.x||e.x>s.x||e.y<t.y||e.y>s.y||e.z<t.z||e.z>s.z)}setFromTransformedAabb(e,t,s=!1){const i=e.center,a=e.halfExtents,n=t.data;let r=n[0],l=n[4],u=n[8],f=n[1],_=n[5],g=n[9],y=n[2],v=n[6],x=n[10];if(s){let C=r*r+l*l+u*u;if(C>0){const M=1/Math.sqrt(C);r*=M,l*=M,u*=M}if(C=f*f+_*_+g*g,C>0){const M=1/Math.sqrt(C);f*=M,_*=M,g*=M}if(C=y*y+v*v+x*x,C>0){const M=1/Math.sqrt(C);y*=M,v*=M,x*=M}}this.center.set(n[12]+r*i.x+l*i.y+u*i.z,n[13]+f*i.x+_*i.y+g*i.z,n[14]+y*i.x+v*i.y+x*i.z),this.halfExtents.set(Math.abs(r)*a.x+Math.abs(l)*a.y+Math.abs(u)*a.z,Math.abs(f)*a.x+Math.abs(_)*a.y+Math.abs(g)*a.z,Math.abs(y)*a.x+Math.abs(v)*a.y+Math.abs(x)*a.z)}static computeMinMax(e,t,s,i=e.length/3){if(i>0){let a=e[0],n=e[1],r=e[2],l=a,u=n,f=r;const _=i*3;for(let g=3;g<_;g+=3){const y=e[g],v=e[g+1],x=e[g+2];y<a&&(a=y),v<n&&(n=v),x<r&&(r=x),y>l&&(l=y),v>u&&(u=v),x>f&&(f=x)}t.set(a,n,r),s.set(l,u,f)}}compute(e,t){wt.computeMinMax(e,tg,sg,t),this.setMinMax(tg,sg)}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){const t=this.getMin(),s=this.getMax();let i=0;const a=["x","y","z"];for(let n=0;n<3;++n){let r=0;const l=e.center[a[n]],u=t[a[n]],f=s[a[n]];let _=0;l<u&&(_=u-l,r+=_*_),l>f&&(_=l-f,r+=_*_),i+=r}return i}_expand(e,t){tg.add2(this.getMin(),e),sg.add2(this.getMax(),t),this.setMinMax(tg,sg)}}const nE=new H,O9=new H;class T1{constructor(e=new H,t=.5){this.center=e,this.radius=t}containsPoint(e){const t=nE.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){const s=nE.copy(e.origin).sub(this.center),i=s.dot(O9.copy(e.direction).normalize()),a=s.dot(s)-this.radius*this.radius;if(a>0&&i>0)return!1;const n=i*i-a;if(n<0)return!1;const r=Math.abs(-i-Math.sqrt(n));return t&&t.copy(e.direction).mulScalar(r).add(e.origin),!0}intersectsBoundingSphere(e){nE.sub2(e.center,this.center);const t=e.radius+this.radius;return nE.lengthSq()<=t*t}}class E1{constructor(e=H.UP,t=0){this.normal=new H,this.normal.copy(e),this.distance=t}clone(){const e=this.constructor;return new e().copy(this)}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}intersectsLine(e,t,s){const i=this.distance,a=this.normal.dot(e)+i,n=this.normal.dot(t)+i,r=a/(a-n),l=r>=0&&r<=1;return l&&s&&s.lerp(e,t,r),l}intersectsRay(e,t){const s=this.normal.dot(e.direction);if(s===0)return!1;const i=-(this.normal.dot(e.origin)+this.distance)/s;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0}normalize(){const e=1/this.normal.length();return this.normal.mulScalar(e),this.distance*=e,this}set(e,t,s,i){return this.normal.set(e,t,s),this.distance=i,this}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}}class fF{constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=new E1}clone(){const e=this.constructor;return new e().copy(this)}copy(e){for(let t=0;t<6;t++)this.planes[t].copy(e.planes[t]);return this}setFromMat4(e){const[t,s,i,a,n,r,l,u,f,_,g,y,v,x,C,M]=e.data,w=this.planes;w[0].set(a-t,u-n,y-f,M-v).normalize(),w[1].set(a+t,u+n,y+f,M+v).normalize(),w[2].set(a+s,u+r,y+_,M+x).normalize(),w[3].set(a-s,u-r,y-_,M-x).normalize(),w[4].set(a-i,u-l,y-g,M-C).normalize(),w[5].set(a+i,u+l,y+g,M+C).normalize()}containsPoint(e){for(let t=0;t<6;t++){const{normal:s,distance:i}=this.planes[t];if(s.dot(e)+i<=0)return!1}return!0}containsSphere(e){const{center:t,radius:s}=e;let i=0;for(let a=0;a<6;a++){const{normal:n,distance:r}=this.planes[a],l=n.dot(t)+r;if(l<=-s)return 0;l>s&&i++}return i===6?2:1}}class ll{constructor(e,t){this.origin=new H,this.direction=H.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t)}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}}const rE=new ll,AI=new H,Hw=new T1,N9=new Me;class F9{constructor(e=new Me,t){this.halfExtents=new H(.5,.5,.5),t&&this.halfExtents.copy(t),this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new wt(new H,this.halfExtents)}set worldTransform(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert()}get worldTransform(){return this._worldTransform}intersectsRay(e,t){if(this._modelTransform.transformPoint(e.origin,rE.origin),this._modelTransform.transformVector(e.direction,rE.direction),t){const s=this._aabb._intersectsRay(rE,t);return N9.copy(this._modelTransform).invert().transformPoint(t,t),s}return this._aabb._fastIntersectsRay(rE)}containsPoint(e){return this._modelTransform.transformPoint(e,AI),this._aabb.containsPoint(AI)}intersectsBoundingSphere(e){return this._modelTransform.transformPoint(e.center,Hw.center),Hw.radius=e.radius,!!this._aabb.intersectsBoundingSphere(Hw)}}const Ww=new H,qw=new H,Xw=new H,jw=new H,Yw=new H,CI=1e-6;class pF{constructor(e=H.ZERO,t=H.ZERO,s=H.ZERO){this.v0=new H,this.v1=new H,this.v2=new H,this.set(e,t,s)}set(e,t,s){return this.v0.copy(e),this.v1.copy(t),this.v2.copy(s),this}intersectsRay(e,t){Ww.sub2(this.v1,this.v0),qw.sub2(this.v2,this.v0),Xw.cross(e.direction,qw);const s=Ww.dot(Xw);if(s>-1e-6&&s<CI)return!1;const i=1/s;jw.sub2(e.origin,this.v0);const a=i*jw.dot(Xw);if(a<0||a>1)return!1;Yw.cross(jw,Ww);const n=i*e.direction.dot(Yw);if(n<0||a+n>1)return!1;const r=i*qw.dot(Yw);return r>CI?(t instanceof H&&t.copy(e.direction).mulScalar(r).add(e.origin),!0):!1}toString(){return`[${this.v0.toString()}, ${this.v1.toString()}, ${this.v2.toString()}]`}}const A1="linear",j2="inverse",TD="exponential",Zs=0,Oe=1,O0=2,Y2=0,wi=1,mF=2,B9=3,ED=4,_F=5,N0=6,U9=7,F0=8,z9=9,k9=10,AD=11,CD=12,Qa=0,V9=1,gF=2,yF=3,vF=4,wD=1,G9=2,H9=4,RD=8,SF=16,bF=32,xF=64,K2=128,W9=256,_r=0,Ob=1,MD=2,wA=3,Jp=1,em=2,_0=4,q9=0,X9=1,j9=2,Y9=3,K9=4,Q9=5,Xs=0,jc=1,e0=2,TF=3,Je=0,Vt=1,vm=2,Sm=3,bm=4,lo=5,EF=0,Nb=1,Fb=2,RA=3,AF=4,CF=5,wF=6,Sh=7,Bb=0,ho=1,Th=2,Q2=0,$2=1,B0=2,xm=3,U0=4,Tm=5,pl=6,Lt=7,z0=8,C1=9,Em=10,k0=11,Js=12,w1=13,Ri=14,gr=15,il=16,Fd=17,Yc=18,V0=19,ki=20,G0=21,R1=22,M1=23,Am=24,Cm=25,H0=26,W0=27,Z2=28,J2=29,eC=30,D1=31,P1=32,tC=33,L1=34,I1=35,O1=36,Jd=37,N1=38,sC=39,F1=40,B1=41,U1=42,z1=43,k1=44,iC=45,V1=46,q0=47,G1=48,kn=49,X0=50,H1=51,wm=52,j0=53,Ub=54,zb=55,kb=56,Vb=61,Gb=62,Hb=63,W1=64,aC=65,nC=66,rC=67,Wb=68,Cd=69,yr=new Map([[Q2,{name:"A8",size:1,ldr:!0}],[wm,{name:"R8",size:1,ldr:!0}],[$2,{name:"L8",size:1,ldr:!0}],[B0,{name:"LA8",size:2,ldr:!0}],[j0,{name:"RG8",size:2,ldr:!0}],[xm,{name:"RGB565",size:2,ldr:!0}],[U0,{name:"RGBA5551",size:2,ldr:!0}],[Tm,{name:"RGBA4",size:2,ldr:!0}],[pl,{name:"RGB8",size:4,ldr:!0}],[Lt,{name:"RGBA8",size:4,ldr:!0,srgbFormat:ki}],[X0,{name:"R16F",size:2}],[H1,{name:"RG16F",size:4}],[k0,{name:"RGB16F",size:8}],[Js,{name:"RGBA16F",size:8}],[w1,{name:"RGB32F",size:16}],[Ri,{name:"RGBA32F",size:16}],[gr,{name:"R32F",size:4}],[il,{name:"DEPTH",size:4}],[Cd,{name:"DEPTH16",size:2}],[Fd,{name:"DEPTHSTENCIL",size:4}],[Yc,{name:"111110F",size:4}],[V0,{name:"SRGB8",size:4,ldr:!0,srgb:!0}],[ki,{name:"SRGBA8",size:4,ldr:!0,srgb:!0}],[D1,{name:"BGRA8",size:4,ldr:!0}],[W1,{name:"SBGRA8",size:4,ldr:!0,srgb:!0}],[z0,{name:"DXT1",blockSize:8,ldr:!0,srgbFormat:Ub}],[C1,{name:"DXT3",blockSize:16,ldr:!0,srgbFormat:zb}],[Em,{name:"DXT5",blockSize:16,ldr:!0,srgbFormat:kb}],[G0,{name:"ETC1",blockSize:8,ldr:!0}],[R1,{name:"ETC2_RGB",blockSize:8,ldr:!0,srgbFormat:Vb}],[M1,{name:"ETC2_RGBA",blockSize:16,ldr:!0,srgbFormat:Gb}],[Am,{name:"PVRTC_2BPP_RGB_1",ldr:!0,blockSize:8}],[Cm,{name:"PVRTC_2BPP_RGBA_1",ldr:!0,blockSize:8}],[H0,{name:"PVRTC_4BPP_RGB_1",ldr:!0,blockSize:8}],[W0,{name:"PVRTC_4BPP_RGBA_1",ldr:!0,blockSize:8}],[Z2,{name:"ASTC_4x4",blockSize:16,ldr:!0,srgbFormat:Hb}],[J2,{name:"ATC_RGB",blockSize:8,ldr:!0}],[eC,{name:"ATC_RGBA",blockSize:16,ldr:!0}],[aC,{name:"BC6H_RGBF",blockSize:16}],[nC,{name:"BC6H_RGBUF",blockSize:16}],[rC,{name:"BC7_RGBA",blockSize:16,ldr:!0,srgbFormat:Wb}],[Ub,{name:"DXT1_SRGB",blockSize:8,ldr:!0,srgb:!0}],[zb,{name:"DXT3_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[kb,{name:"DXT5_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[Vb,{name:"ETC2_SRGB",blockSize:8,ldr:!0,srgb:!0}],[Gb,{name:"ETC2_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[Hb,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:!0,srgb:!0}],[Wb,{name:"BC7_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[P1,{name:"R8I",size:1,isInt:!0}],[tC,{name:"R8U",size:1,isInt:!0}],[L1,{name:"R16I",size:2,isInt:!0}],[I1,{name:"R16U",size:2,isInt:!0}],[O1,{name:"R32I",size:4,isInt:!0}],[Jd,{name:"R32U",size:4,isInt:!0}],[N1,{name:"RG8I",size:2,isInt:!0}],[sC,{name:"RG8U",size:2,isInt:!0}],[F1,{name:"RG16I",size:4,isInt:!0}],[B1,{name:"RG16U",size:4,isInt:!0}],[U1,{name:"RG32I",size:8,isInt:!0}],[z1,{name:"RG32U",size:8,isInt:!0}],[k1,{name:"RGBA8I",size:4,isInt:!0}],[iC,{name:"RGBA8U",size:4,isInt:!0}],[V1,{name:"RGBA16I",size:8,isInt:!0}],[q0,{name:"RGBA16U",size:8,isInt:!0}],[G1,{name:"RGBA32I",size:16,isInt:!0}],[kn,{name:"RGBA32U",size:16,isInt:!0}]]),qb=h=>{var e;return((e=yr.get(h))==null?void 0:e.blockSize)!==void 0},Xb=h=>{var e;return((e=yr.get(h))==null?void 0:e.srgb)===!0},kc=h=>{var e;return((e=yr.get(h))==null?void 0:e.isInt)===!0},q1=h=>{var e;return((e=yr.get(h))==null?void 0:e.srgbFormat)||h},RF=h=>{for(const[e,t]of yr)if(t.srgbFormat===h)return e;return h},MF=h=>{const e=yr.get(h);return!!(e!=null&&e.ldr&&!(e!=null&&e.srgb))},DD=h=>{switch(h){case gr:case w1:case Ri:return Float32Array;case O1:case U1:case G1:return Int32Array;case Jd:case z1:case kn:return Uint32Array;case L1:case F1:case V1:return Int16Array;case j0:case I1:case B1:case q0:case xm:case U0:case Tm:case X0:case H1:case k0:case Js:return Uint16Array;case P1:case N1:case k1:return Int8Array;default:return Uint8Array}},Y0=0,X1=1,PD=2,oC=3,al=4,hl=5,wd=6,kt="POSITION",$a="NORMAL",po="TANGENT",co="BLENDWEIGHT",gn="BLENDINDICES",Qi="COLOR",VM="TEXCOORD",Za="TEXCOORD0",Mh="TEXCOORD1",Rm="TEXCOORD2",Mm="TEXCOORD3",Dm="TEXCOORD4",Pm="TEXCOORD5",Lm="TEXCOORD6",Im="TEXCOORD7",MA="ATTR0",DA="ATTR1",LD="ATTR2",ID="ATTR3",OD="ATTR4",DF="ATTR5",PF="ATTR6",LF="ATTR7",g0="ATTR8",y0="ATTR9",IF="ATTR10",OF="ATTR11",lC="ATTR12",K0="ATTR13",hC="ATTR14",tm="ATTR15",ND=1,Gp=0,$9=1,NF=2,FF=3,Z9=4,BF=5,J9=6,eV=7,uA=0,FD=1,GM=2,vr="default",Eh="rgbm",jb="rgbe",v0="rgbp",S0="swizzleGGGR",tV=0,sV=1,iV=2,aV=3,BD="1d",bh="2d",bd="2d-array",xd="cube",UD="cube-array",Hp="3d",Om=0,j1=1,b0=2,Bd=3,sm=4,UF="none",PA="cube",HM="equirect",zF="octahedral",Sr="glsl",Ja="wgsl",ml=0,io=1,_l=2,Dh=3,jt=4,Ai=5,it=6,Y1=7,Wp=0,Ud=1,Vn=2,zd=3,Fn=4,kd=5,Rd=6,Md=7,Dd=8,x0=9,T0=10,E0=11,Yb=12,A0=13,im=14,kF=15,VF=16,K1=17,GF=18,HF=19,WF=20,Q1=21,$1=22,cC=23,zD=24,qF=25,am=26,nm=27,rm=28,om=29,lm=30,Z1=31,J1=32,hm=33,ex=34,tx=35,cm=36,sx=37,ix=38,Kb=39,uC=40,dC=41,XF=42,jF=43,YF=44,KF=45,QF=46,$F=47,ZF=48,JF=49,WM=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],kD=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],VD=new Map;kD.forEach((h,e)=>{h.forEach(t=>VD.set(t,e))});const nV=new Uint8Array([jt,jt,it,it,it,it,jt,jt,jt,jt,jt,jt,it,it,it,jt,jt,it,jt,jt,jt,it,it,it,it,jt,Ai,Ai,Ai,Ai,jt,Ai,jt,jt,Ai,jt,jt,Ai,jt,jt,Ai,jt,jt,Ai,jt,Ai,jt,Ai,jt,Ai]),lb="webgl2",GD="webgpu",hb="null",Vd=1,Gd=2,HD=4,eB="ldr",sb="ldr_srgb",tB="hdr",WD=1,qD=2,XD=4,jD=8,YD=16,KD=32,QD=64,$D=128,sB=255,Qb=0,Q0=1,um=2,ZD=["view","mesh","mesh_ub"],ax="default",fC="_unused_float_uniform",qp=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],t0=[1,1,2,2,4,4,4,2],rV=["INT8","UINT8","INT16","UINT16","INT32","UINT32","FLOAT32","FLOAT16"],oV={Int8Array:ml,Uint8Array:io,Int16Array:_l,Uint16Array:Dh,Int32Array:jt,Uint32Array:Ai,Float32Array:it},$b=[Uint8Array,Uint16Array,Uint32Array],iB=[1,2,4],Bt={};Bt[kt]=0;Bt[$a]=1;Bt[co]=2;Bt[gn]=3;Bt[Qi]=4;Bt[Za]=5;Bt[Mh]=6;Bt[Rm]=7;Bt[Mm]=8;Bt[Dm]=9;Bt[Pm]=10;Bt[Lm]=11;Bt[Im]=12;Bt[po]=13;Bt[MA]=0;Bt[DA]=1;Bt[LD]=2;Bt[ID]=3;Bt[OD]=4;Bt[DF]=5;Bt[PF]=6;Bt[LF]=7;Bt[g0]=8;Bt[y0]=9;Bt[IF]=10;Bt[OF]=11;Bt[lC]=12;Bt[K0]=13;Bt[hC]=14;Bt[tm]=15;const lV="1.51",hV="1.55",cV="1.56",uV="1.57",dV="1.58",fV="1.60",pV="1.62",aB="1.65",mV="1.70",_V="2.1",gV="2.3",yV="2.5",vV="2.6",SV="2.7",bV="modulepreload",xV=function(h){return"/"+h},wI={},RI=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){let n=function(u){return Promise.all(u.map(f=>Promise.resolve(f).then(_=>({status:"fulfilled",value:_}),_=>({status:"rejected",reason:_}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),l=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=n(t.map(u=>{if(u=xV(u),u in wI)return;wI[u]=!0;const f=u.endsWith(".css"),_=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${_}`))return;const g=document.createElement("link");if(g.rel=f?"stylesheet":bV,f||(g.as="script"),g.crossOrigin="",g.href=u,l&&g.setAttribute("nonce",l),document.head.appendChild(g),f)return new Promise((y,v)=>{g.addEventListener("load",y),g.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${u}`)))})}))}function a(n){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=n,window.dispatchEvent(r),!r.defaultPrevented)throw n}return i.then(n=>{for(const r of n||[])r.status==="rejected"&&a(r.reason);return e().catch(a)})};let TV=0;class pC{constructor(e,t){this.slot=-1,this.scopeId=null,this.name=e,this.visibility=t}}class nx extends pC{}class JD extends pC{constructor(e,t,s=!1){super(e,t),this.format="",this.readOnly=s}}class Zb extends pC{constructor(e,t,s=bh,i=Om,a=!0,n=null){super(e,t),this.textureDimension=s,this.sampleType=i,this.hasSampler=a,this.samplerName=n??`${e}_sampler`}}class nB extends pC{constructor(e,t=Lt,s=bh,i=!0,a=!1){super(e,HD),this.format=t,this.textureDimension=s,this.write=i,this.read=a}}class Nm{constructor(e,t){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=TV++;let s=0;t.forEach(a=>{a.slot=s++,a instanceof Zb&&a.hasSampler&&s++,a instanceof nx?this.uniformBufferFormats.push(a):a instanceof Zb?this.textureFormats.push(a):a instanceof nB?this.storageTextureFormats.push(a):a instanceof JD&&this.storageBufferFormats.push(a)}),this.device=e;const i=e.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach((a,n)=>this.bufferFormatsMap.set(a.name,n)),this.textureFormatsMap=new Map,this.textureFormats.forEach((a,n)=>{this.textureFormatsMap.set(a.name,n),a.scopeId=i.resolve(a.name)}),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach((a,n)=>{this.storageTextureFormatsMap.set(a.name,n),a.scopeId=i.resolve(a.name)}),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach((a,n)=>{this.storageBufferFormatsMap.set(a.name,n),a.scopeId=i.resolve(a.name)}),this.impl=e.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(e){const t=this.textureFormatsMap.get(e);return t!==void 0?this.textureFormats[t]:null}getStorageTexture(e){const t=this.storageTextureFormatsMap.get(e);return t!==void 0?this.storageTextureFormats[t]:null}loseContext(){}}class Xn{get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",()=>{this.remove(e)}),e.on("devicelost",()=>{var s,i;(i=(s=this._cache.get(e))==null?void 0:s.loseContext)==null||i.call(s,e)})),this._cache.get(e)}remove(e){var t,s;(s=(t=this._cache.get(e))==null?void 0:t.destroy)==null||s.call(t,e),this._cache.delete(e)}constructor(){this._cache=new Map}}class fr{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,s=1){return 1+Math.floor(Math.log2(Math.max(e,t,s)))}static calcLevelGpuSize(e,t,s,i){var _;const a=yr.get(i),n=((_=yr.get(i))==null?void 0:_.size)??0;if(n>0)return e*t*s*n;const r=a.blockSize??0;let l=Math.floor((e+3)/4);const u=Math.floor((t+3)/4),f=Math.floor((s+3)/4);return(i===Am||i===Cm)&&(l=Math.max(Math.floor(l/2),1)),l*u*f*r}static calcGpuSize(e,t,s,i,a,n){let r=0;for(;r+=fr.calcLevelGpuSize(e,t,s,i),!(!a||e===1&&t===1&&s===1);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),s=Math.max(s>>1,1);return r*(n?6:1)}}let EV=0;class Ge{constructor(e,t={}){this._gpuSize=0,this.id=EV++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=uA,this.renderVersionDirty=0,this._storage=!1,this._numLevels=0,this.device=e,this.name=t.name??"",this._width=Math.floor(t.width??4),this._height=Math.floor(t.height??4),this._format=t.format??Lt,this._compressed=qb(this._format),this._integerFormat=kc(this._format),this._integerFormat&&(t.minFilter=Je,t.magFilter=Je),this._volume=t.volume??!1,this._depth=Math.floor(t.depth??1),this._arrayLength=Math.floor(t.arrayLength??0),this._storage=t.storage??!1,this._cubemap=t.cubemap??!1,this._flipY=t.flipY??!1,this._premultiplyAlpha=t.premultiplyAlpha??!1,this._mipmaps=t.mipmaps??!0,this._numLevelsRequested=t.numLevels,t.numLevels!==void 0&&(this._numLevels=t.numLevels),this._updateNumLevel(),this._minFilter=t.minFilter??lo,this._magFilter=t.magFilter??Vt,this._anisotropy=t.anisotropy??1,this._addressU=t.addressU??Zs,this._addressV=t.addressV??Zs,this._addressW=t.addressW??Zs,this._compareOnRead=t.compareOnRead??!1,this._compareFunc=t.compareFunc??Nb,this._type=t.hasOwnProperty("type")?t.type:vr,this.projection=UF,this._cubemap?this.projection=PA:t.projection&&t.projection!==PA&&(this.projection=t.projection),this._levels=t.levels;const s=!!t.levels;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.recreateImpl(s),e.textures.push(this)}destroy(){const e=this.device;if(e){const t=e.textures.indexOf(this);t!==-1&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}recreateImpl(e=!0){var s;const{device:t}=this;(s=this.impl)==null||s.destroy(t),this.impl=null,this.impl=t.createTextureImpl(this),this.dirtyAll(),e&&this.upload()}resize(e,t,s=1){const i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(s),this._updateNumLevel(),this.impl=i.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion}_updateNumLevel(){const e=this.mipmaps?fr.calcMipLevelsCount(this.width,this.height):1,t=this._numLevelsRequested;this._numLevels=Math.min(t??e,e),this._mipmaps=this._numLevels>1}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(kc(this._format)||(this._minFilter=e,this.propertyChanged(WD)))}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(kc(this._format)||(this._magFilter=e,this.propertyChanged(qD)))}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(XD))}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(jD))}get addressV(){return this._addressV}set addressW(e){this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(YD))}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(KD))}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(QD))}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged($D))}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||kc(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const e=this.pot&&this._mipmaps&&!(this._compressed&&this._levels.length===1);return fr.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set type(e){this._type!==e&&(this._type=e,this.device._shadersDirty=!0)}get type(){return this._type}set srgb(e){const t=Xb(this.format);if(e!==t)if(e){const s=q1(this.format);this._format!==s&&(this._format=s,this.recreateImpl(),this.device._shadersDirty=!0)}else{const s=RF(this.format);this._format!==s&&(this._format=s,this.recreateImpl(),this.device._shadersDirty=!0)}}get srgb(){return Xb(this.format)}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return ge.powerOfTwo(this._width)&&ge.powerOfTwo(this._height)}get encoding(){switch(this.type){case Eh:return"rgbm";case jb:return"rgbe";case v0:return"rgbp"}return MF(this.format)?"srgb":"linear"}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(sB)}lock(e={}){e.level??(e.level=0),e.face??(e.face=0),e.mode??(e.mode=GM),this._lockedMode=e.mode,this._lockedLevel=e.level;const t=this.cubemap?this._levels[e.face]:this._levels;if(t[e.level]===null){const s=Math.max(1,this._width>>e.level),i=Math.max(1,this._height>>e.level),a=Math.max(1,this._depth>>e.level),n=new ArrayBuffer(fr.calcLevelGpuSize(s,i,a,this._format));t[e.level]=new(DD(this._format))(n)}return t[e.level]}setSource(e,t=0){let s=!1,i,a;if(this._cubemap){if(e[0]){i=e[0].width||0,a=e[0].height||0;for(let n=0;n<6;n++){const r=e[n];if(!r||r.width!==i||r.height!==a||!this.device._isBrowserInterface(r)){s=!0;break}}}else s=!0;if(!s)for(let n=0;n<6;n++)this._levels[t][n]!==e[n]&&(this._levelsUpdated[t][n]=!0)}else this.device._isBrowserInterface(e)||(s=!0),s||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),e instanceof HTMLVideoElement?(i=e.videoWidth,a=e.videoHeight):(i=e.width,a=e.height));if(s)if(this._width=4,this._height=4,this._cubemap)for(let n=0;n<6;n++)this._levels[t][n]=null,this._levelsUpdated[t][n]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else t===0&&(this._width=i,this._height=a),this._levels[t]=e;(this._invalid!==s||!s)&&(this._invalid=s,this.upload())}getSource(e=0){return this._levels[e]}unlock(){this._lockedMode,this._lockedMode===GM&&this.upload(),this._lockedLevel=-1,this._lockedMode=uA}upload(){var e,t;this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,(t=(e=this.impl).uploadImmediate)==null||t.call(e,this.device,this)}read(e,t,s,i,a={}){var n,r;return(r=(n=this.impl).read)==null?void 0:r.call(n,e,t,s,i,a)}}const AV={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]};class CV{destroy(){this.map.forEach(e=>{e.destroy()})}constructor(){this.map=new Map}}const wV=new Xn,Xp=(h,e)=>{const t=wV.get(h,()=>new CV);if(!t.map.has(e)){const s=new Ge(h,{name:`built-in-texture-${e}`,width:1,height:1,format:Lt}),i=s.lock(),a=AV[e];i.set(a),s.unlock(),t.map.set(e,s)}return t.map.get(e)};let RV=0;class eP{constructor(){this.offsets=[]}}class $0{constructor(e,t,s){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=RV++,this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(ax,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){const s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=!0)}setStorageBuffer(e,t){const s=this.format.storageBufferFormatsMap.get(e);this.storageBuffers[s]!==t&&(this.storageBuffers[s]=t,this.dirty=!0)}setTexture(e,t){const s=this.format.textureFormatsMap.get(e);this.textures[s]!==t?(this.textures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(e,t){const s=this.format.storageTextureFormatsMap.get(e);this.storageTextures[s]!==t?(this.storageTextures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}updateUniformBuffers(){for(let e=0;e<this.uniformBuffers.length;e++)this.uniformBuffers[e].update()}update(){const{textureFormats:e,storageTextureFormats:t,storageBufferFormats:s}=this.format;for(let i=0;i<e.length;i++){const a=e[i];let n=a.scopeId.value;n||(a.name==="uSceneDepthMap"&&(n=Xp(this.device,"white")),a.name==="uSceneColorMap"&&(n=Xp(this.device,"pink")),n||(n=Xp(this.device,"pink"))),this.setTexture(a.name,n)}for(let i=0;i<t.length;i++){const a=t[i],n=a.scopeId.value;this.setStorageTexture(a.name,n)}for(let i=0;i<s.length;i++){const a=s[i],n=a.scopeId.value;this.setStorageBuffer(a.name,n)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let i=0;i<this.uniformBuffers.length;i++){const a=this.uniformBuffers[i];this.uniformBufferOffsets[i]=a.offset,this.renderVersionUpdated<a.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}const Os={set(h,e,t,s=1){return h&~(s<<t)|e<<t},get(h,e,t=1){return h>>e&t},all(h,e,t=1){const s=t<<e;return(h&s)===s},any(h,e,t=1){return(h&t<<e)!==0}},oE=7,Qu=15,MI=0,DI=3,PI=7,LI=11,II=14,OI=18,qM=22,NI=23,FI=24,BI=25,UI=26,MV=15,DV=qM,hh=class hh{constructor(e=!1,t=Qa,s=wi,i=Y2,a,n,r,l=!0,u=!0,f=!0,_=!0){this.target0=0,this.setColorBlend(t,s,i),this.setAlphaBlend(a??t,n??s,r??i),this.setColorWrite(l,u,f,_),this.blend=e}set blend(e){this.target0=Os.set(this.target0,e?1:0,UI)}get blend(){return Os.all(this.target0,UI)}setColorBlend(e,t,s){this.target0=Os.set(this.target0,e,MI,oE),this.target0=Os.set(this.target0,t,DI,Qu),this.target0=Os.set(this.target0,s,PI,Qu)}setAlphaBlend(e,t,s){this.target0=Os.set(this.target0,e,LI,oE),this.target0=Os.set(this.target0,t,II,Qu),this.target0=Os.set(this.target0,s,OI,Qu)}setColorWrite(e,t,s,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return Os.get(this.target0,MI,oE)}get colorSrcFactor(){return Os.get(this.target0,DI,Qu)}get colorDstFactor(){return Os.get(this.target0,PI,Qu)}get alphaOp(){return Os.get(this.target0,LI,oE)}get alphaSrcFactor(){return Os.get(this.target0,II,Qu)}get alphaDstFactor(){return Os.get(this.target0,OI,Qu)}set redWrite(e){this.target0=Os.set(this.target0,e?1:0,qM)}get redWrite(){return Os.all(this.target0,qM)}set greenWrite(e){this.target0=Os.set(this.target0,e?1:0,NI)}get greenWrite(){return Os.all(this.target0,NI)}set blueWrite(e){this.target0=Os.set(this.target0,e?1:0,FI)}get blueWrite(){return Os.all(this.target0,FI)}set alphaWrite(e){this.target0=Os.set(this.target0,e?1:0,BI)}get alphaWrite(){return Os.all(this.target0,BI)}get allWrite(){return Os.get(this.target0,DV,MV)}copy(e){return this.target0=e.target0,this}clone(){return new this.constructor().copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}};hh.NOBLEND=Object.freeze(new hh),hh.NOWRITE=Object.freeze(new hh(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1)),hh.ALPHABLEND=Object.freeze(new hh(!0,Qa,N0,F0)),hh.ADDBLEND=Object.freeze(new hh(!0,Qa,wi,wi));let ms=hh;class rx{get(e){let t=this.map.get(e);return t===void 0&&(t=this.id++,this.map.set(e,t)),t}constructor(){this.map=new Map,this.id=0}}const PV=new rx,zI=7,kI=0,VI=3,fd=class fd{constructor(e=RA,t=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t}set test(e){this.func=e?RA:Sh,this.updateKey()}get test(){return this.func!==Sh}set write(e){this.data=Os.set(this.data,e?1:0,VI),this.updateKey()}get write(){return Os.all(this.data,VI)}set func(e){this.data=Os.set(this.data,e,kI,zI),this.updateKey()}get func(){return Os.get(this.data,kI,zI)}set depthBias(e){this._depthBias=e,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return new this.constructor().copy(this)}updateKey(){const{data:e,_depthBias:t,_depthBiasSlope:s}=this,i=`${e}-${t}-${s}`;this.key=PV.get(i)}equals(e){return this.key===e.key}};fd.DEFAULT=Object.freeze(new fd),fd.NODEPTH=Object.freeze(new fd(Sh,!1)),fd.WRITEDEPTH=Object.freeze(new fd(Sh,!0));let $i=fd;class rB{equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}constructor(){this.globalId=0,this.revision=0}}let GI=0;class LV{constructor(){GI++,this.version=new rB,this.version.globalId=GI}increment(){this.version.revision++}}class oB{constructor(e){this.name=e,this.value=null,this.versionObject=new LV}toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}}class lB{constructor(e){this.name=e,this.variables=new Map}resolve(e){return this.variables.has(e)||this.variables.set(e,new oB(e)),this.variables.get(e)}removeValue(e){for(const t in this.variables){const s=this.variables[t];s.value===e&&(s.value=null)}}}let IV=0;class jn{constructor(e,t,s,i){this.usage=_r,this.usage=(i==null?void 0:i.usage)??_r,this.device=e,this.format=t,this.numVertices=s,this.id=IV++,this.impl=e.createVertexBufferImpl(this,t,i),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes);const a=i==null?void 0:i.data;a?this.setData(a):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength!==this.numBytes?!1:(this.storage=e,this.unlock(),!0)}}function sl(h){if(h==null)return 0;let e=0;for(let t=0,s=h.length;t<s;t++)e=(e<<5)-e+h.charCodeAt(t),e|=0;return e}function tP(h){let t=2166136261;for(let s=0;s<h.length;s++)t^=h[s],t*=16777619;return t>>>0}const OV=new rx,NV=[2,4,8,12,16],FV=new Xn;class en{constructor(e,t,s){this.device=e,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=s===void 0,this.instancing=!1,this.size=t.reduce((n,r)=>n+Math.ceil(r.components*t0[r.type]/4)*4,0);let i=0,a;for(let n=0,r=t.length;n<r;n++){const l=t[n];a=l.components*t0[l.type],s&&(i=ge.roundUp(i,a));const u=l.asInt??!1,f=u?!1:l.normalize??!1,_={name:l.semantic,offset:s?i:l.hasOwnProperty("offset")?l.offset:i,stride:s?a:l.hasOwnProperty("stride")?l.stride:this.size,dataType:l.type,numComponents:l.components,normalize:f,size:a,asInt:u};this._elements.push(_),s?i+=a*s:i+=Math.ceil(a/4)*4,l.semantic===Za?this.hasUv0=!0:l.semantic===Mh?this.hasUv1=!0:l.semantic===Qi?this.hasColor=!0:l.semantic===po&&(this.hasTangents=!0)}s&&(this.verticesByteSize=i),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(e){return FV.get(e,()=>new en(e,[{semantic:lC,components:4,type:it},{semantic:K0,components:4,type:it},{semantic:hC,components:4,type:it},{semantic:tm,components:4,type:it}]))}static isElementValid(e,t){const s=t.components*t0[t.type];return!(e.isWebGPU&&!NV.includes(s))}update(){this._evaluateHash()}_evaluateHash(){const e=[],t=[],s=this._elements.length;for(let a=0;a<s;a++){const{name:n,dataType:r,numComponents:l,normalize:u,offset:f,stride:_,size:g,asInt:y}=this._elements[a],v=n+r+l+u+y;e.push(v);const x=v+f+_+g;t.push(x)}e.sort();const i=e.join();this.batchingHash=sl(i),this.shaderProcessingHashString=i,this.renderingHashString=t.join("_"),this.renderingHash=OV.get(this.renderingHashString)}}const BV=new rx,R2=class R2{set func(e){this._func=e,this._dirty=!0}get func(){return this._func}set ref(e){this._ref=e,this._dirty=!0}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=!0}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=!0}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=!0}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=!0}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=!0}get writeMask(){return this._writeMask}constructor(e={}){this._dirty=!0,this._func=e.func??Sh,this._ref=e.ref??0,this._readMask=e.readMask??255,this._writeMask=e.writeMask??255,this._fail=e.fail??Gp,this._zfail=e.zfail??Gp,this._zpass=e.zpass??Gp,this._evalKey()}_evalKey(){const{_func:e,_ref:t,_fail:s,_zfail:i,_zpass:a,_readMask:n,_writeMask:r}=this,l=`${e},${t},${s},${i},${a},${n},${r}`;this._key=BV.get(l),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return new this.constructor().copy(this)}};R2.DEFAULT=Object.freeze(new R2);let pr=R2;const M2=class M2 extends Qe{constructor(e,t){var s,i,a,n,r,l;super(),this.backBuffer=null,this.backBufferSize=new Ee,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL2=!1,this.isHdr=!1,this.maxColorAttachments=1,this.maxSamples=1,this.supportsCompute=!1,this.supportsStorageTextureRead=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.insideRenderPass=!1,this.supportsUniformBuffers=!1,this.supportsClipDistances=!1,this.textureRG11B10Renderable=!1,this.textureFloatFilterable=!1,this.blendState=new ms,this.depthState=new $i,this.stencilEnabled=!1,this.stencilFront=new pr,this.stencilBack=new pr,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:Jp|em},this.clientRect={width:0,height:0},this._shadersDirty=!1,this.capsDefines=new Map,this.canvas=e,"setAttribute"in e&&e.setAttribute("data-engine",`PlayCanvas ${bD}`),this.initOptions={...t},(s=this.initOptions).alpha??(s.alpha=!0),(i=this.initOptions).depth??(i.depth=!0),(a=this.initOptions).stencil??(a.stencil=!0),(n=this.initOptions).antialias??(n.antialias=!0),(r=this.initOptions).powerPreference??(r.powerPreference="high-performance"),(l=this.initOptions).displayFormat??(l.displayFormat=eB),this._maxPixelRatio=Ct.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let u=Y0;u<=wd;u++)this._primsPerFrame[u]=0;this._renderTargetCreationTime=0,this.scope=new lB("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){const e=new en(this,[{semantic:kt,components:2,type:it}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new jn(this,e,4,{data:t})}initCapsDefines(){const{capsDefines:e}=this;e.clear(),this.textureFloatFilterable&&e.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&e.set("CAPS_TEXTURE_FLOAT_RENDERABLE","")}destroy(){var e,t,s;this.fire("destroy"),(e=this.quadVertexBuffer)==null||e.destroy(),this.quadVertexBuffer=null,(t=this.dynamicBuffers)==null||t.destroy(),this.dynamicBuffers=null,(s=this.gpuProfiler)==null||s.destroy(),this.gpuProfiler=null}onDestroyShader(e){this.fire("destroy:shader",e);const t=this.shaders.indexOf(e);t!==-1&&this.shaders.splice(t,1)}postDestroy(){this.scope=null,this.canvas=null}loseContext(){var e;this.contextLost=!0,this.backBufferSize.set(-1,-1);for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext();(e=this.gpuProfiler)==null||e.loseContext()}restoreContext(){var e,t;this.contextLost=!1,this.initializeRenderState(),this.initializeContextCaches();for(const s of this.buffers)s.unlock();(t=(e=this.gpuProfiler)==null?void 0:e.restoreContext)==null||t.call(e)}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new ms,this.depthState=new $i,this.cullMode=jc,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new xe(0,0,0,0)}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,s,i){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e}setIndexBuffer(e){this.indexBuffer=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}clearVertexBuffer(){this.vertexBuffers.length=0}clearIndexBuffer(){this.indexBuffer=null}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e))}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement}resizeCanvas(e,t){const s=Math.min(this._maxPixelRatio,Ct.browser?window.devicePixelRatio:1),i=Math.floor(e*s),a=Math.floor(t*s);(i!==this.canvas.width||a!==this.canvas.height)&&this.setResolution(i,a)}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(M2.EVENT_RESIZE,e,t)}updateClientRect(){if(Ct.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else{const e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(e){}endRenderPass(e){}startComputePass(e){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){}computeDispatch(e,t="Unnamed"){}getRenderableHdrFormat(e=[Yc,Js,Ri],t=!0,s=1){for(let i=0;i<e.length;i++){const a=e[i];switch(a){case Yc:{if(this.textureRG11B10Renderable)return a;break}case Js:if(this.textureHalfFloatRenderable)return a;break;case Ri:if(this.isWebGPU&&s>1)continue;if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return a;break}}}validateAttributes(e,t,s){}};M2.EVENT_RESIZE="resizecanvas";let _s=M2,UV=0;class fs{constructor(e={}){var i,a,n,r,l;this.id=UV++;const t=((i=e.colorBuffer)==null?void 0:i.device)??((a=e.colorBuffers)==null?void 0:a[0].device)??((n=e.depthBuffer)==null?void 0:n.device)??e.graphicsDevice;this._device=t;const{maxSamples:s}=this._device;if(this._samples=Math.min(e.samples??1,s),t.isWebGPU&&(this._samples=this._samples>1?s:1),this._colorBuffer=e.colorBuffer,e.colorBuffer&&(this._colorBuffers=[e.colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=e.face??0,this._depthBuffer){const u=this._depthBuffer._format;u===il||u===Cd?(this._depth=!0,this._stencil=!1):u===Fd?(this._depth=!0,this._stencil=!0):u===gr&&this._depthBuffer.device.isWebGPU&&this._samples>1?(this._depth=!0,this._stencil=!1):(this._depth=!1,this._stencil=!1)}else this._depth=e.depth??!0,this._stencil=e.stencil??!1;e.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0])),this.autoResolve=e.autoResolve??!0,this.name=e.name,this.name||(this.name=(r=this._colorBuffer)==null?void 0:r.name),this.name||(this.name=(l=this._depthBuffer)==null?void 0:l.name),this.name||(this.name="Untitled"),this.flipY=e.flipY??!1,this._mipLevel=e.mipLevel??0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=e.mipLevel===void 0,this.validateMrt(),this.impl=t.createRenderTargetImpl(this)}destroy(){const e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){const e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){var e,t;(e=this._depthBuffer)==null||e.destroy(),this._depthBuffer=null,(t=this._colorBuffers)==null||t.forEach(s=>{s.destroy()}),this._colorBuffers=null,this._colorBuffer=null}resize(e,t){var s,i;if(this.width!==e||this.height!==t){if(this.mipLevel>0)return;const a=this._device;this.destroyFrameBuffers(),a.renderTarget===this&&a.setRenderTarget(null),(s=this._depthBuffer)==null||s.resize(e,t),(i=this._colorBuffers)==null||i.forEach(n=>{n.resize(e,t)}),this.validateMrt(),this.impl=a.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(e=!0,t=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,s){if(!this._device)if(e._device)this._device=e._device;else return!1;return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){var t;return(t=this._colorBuffers)==null?void 0:t[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){var t,s;let e=((t=this._colorBuffer)==null?void 0:t.width)||((s=this._depthBuffer)==null?void 0:s.width)||this._device.width;return this._mipLevel>0&&(e=fr.calcLevelDimension(e,this._mipLevel)),e}get height(){var t,s;let e=((t=this._colorBuffer)==null?void 0:t.height)||((s=this._depthBuffer)==null?void 0:s.height)||this._device.height;return this._mipLevel>0&&(e=fr.calcLevelDimension(e,this._mipLevel)),e}isColorBufferSrgb(e=0){if(this.device.backBuffer===this)return Xb(this.device.backBufferFormat);const t=this.getColorBuffer(e);return t?Xb(t.format):!1}}class zV{update(e){this.destroy();const t=e.device,s=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(s)}destroy(){this.bindGroup=null}createDescriptor(e,t){const s=[],i=t.format,a=t.format.uniformBufferFormats;t.uniformBuffers.forEach((f,_)=>{const g=a[_].slot,y=f.persistent?f.impl.buffer:f.allocation.gpuBuffer.buffer;s.push({binding:g,resource:{buffer:y,offset:0,size:f.format.byteSize}})});const n=t.format.textureFormats;t.textures.forEach((f,_)=>{const g=f.impl,y=i.textureFormats[_],v=n[_].slot,x=g.getView(e);if(s.push({binding:v,resource:x}),y.hasSampler){const C=g.getSampler(e,y.sampleType);s.push({binding:v+1,resource:C})}});const r=t.format.storageTextureFormats;t.storageTextures.forEach((f,_)=>{const g=f.impl,y=r[_].slot,v=g.getView(e);s.push({binding:y,resource:v})});const l=t.format.storageBufferFormats;return t.storageBuffers.forEach((f,_)=>{const g=f.impl.buffer,y=l[_].slot;s.push({binding:y,resource:{buffer:g}})}),{layout:t.format.impl.bindGroupLayout,entries:s}}}class Kw{static shaderStage(e){let t=0;return e&Vd&&(t|=GPUShaderStage.VERTEX),e&Gd&&(t|=GPUShaderStage.FRAGMENT),e&HD&&(t|=GPUShaderStage.COMPUTE),t}}const ze=[];ze[Q2]="";ze[$2]="";ze[B0]="";ze[wm]="r8unorm";ze[j0]="rg8unorm";ze[xm]="";ze[U0]="";ze[Tm]="";ze[pl]="rgba8unorm";ze[Lt]="rgba8unorm";ze[z0]="bc1-rgba-unorm";ze[C1]="bc2-rgba-unorm";ze[Em]="bc3-rgba-unorm";ze[k0]="";ze[Js]="rgba16float";ze[X0]="r16float";ze[H1]="rg16float";ze[w1]="";ze[Ri]="rgba32float";ze[gr]="r32float";ze[il]="depth32float";ze[Cd]="depth16unorm";ze[Fd]="depth24plus-stencil8";ze[Yc]="rg11b10ufloat";ze[V0]="";ze[ki]="rgba8unorm-srgb";ze[G0]="";ze[R1]="etc2-rgb8unorm";ze[M1]="etc2-rgba8unorm";ze[Am]="";ze[Cm]="";ze[H0]="";ze[W0]="";ze[Z2]="astc-4x4-unorm";ze[J2]="";ze[eC]="";ze[D1]="bgra8unorm";ze[W1]="bgra8unorm-srgb";ze[P1]="r8sint";ze[tC]="r8uint";ze[L1]="r16sint";ze[I1]="r16uint";ze[O1]="r32sint";ze[Jd]="r32uint";ze[N1]="rg8sint";ze[sC]="rg8uint";ze[F1]="rg16sint";ze[B1]="rg16uint";ze[U1]="rg32sint";ze[z1]="rg32uint";ze[k1]="rgba8sint";ze[iC]="rgba8uint";ze[V1]="rgba16sint";ze[q0]="rgba16uint";ze[G1]="rgba32sint";ze[kn]="rgba32uint";ze[aC]="bc6h-rgb-float";ze[nC]="bc6h-rgb-ufloat";ze[rC]="bc7-rgba-unorm";ze[Ub]="bc1-rgba-unorm-srgb";ze[zb]="bc2-rgba-unorm-srgb";ze[kb]="bc3-rgba-unorm-srgb";ze[Vb]="etc2-rgb8unorm-srgb";ze[Gb]="etc2-rgba8unorm-srgb";ze[Wb]="bc7-rgba-unorm-srgb";ze[Hb]="astc-4x4-unorm-srgb";const Z0=[];Z0[Om]="filtering";Z0[j1]="non-filtering";Z0[b0]="comparison";Z0[Bd]="comparison";Z0[sm]="comparison";const J0=[];J0[Om]="float";J0[j1]="unfilterable-float";J0[b0]="depth";J0[Bd]="sint";J0[sm]="uint";const kV=new rx;class VV{constructor(e){const t=e.device,{key:s,desc:i}=this.createDescriptor(e);this.key=kV.get(s),this.bindGroupLayout=t.wgpu.createBindGroupLayout(i)}destroy(){this.bindGroupLayout=null}loseContext(){}createDescriptor(e){const t=[];let s="";return e.uniformBufferFormats.forEach(a=>{const n=Kw.shaderStage(a.visibility);s+=`#${a.slot}U:${n}`,t.push({binding:a.slot,visibility:n,buffer:{type:"uniform",hasDynamicOffset:!0}})}),e.textureFormats.forEach(a=>{const n=Kw.shaderStage(a.visibility),r=a.sampleType,l=a.textureDimension,u=!1,f=J0[r];if(s+=`#${a.slot}T:${n}-${f}-${l}-${u}`,t.push({binding:a.slot,visibility:n,texture:{sampleType:f,viewDimension:l,multisampled:u}}),a.hasSampler){const _=Z0[r];s+=`#${a.slot+1}S:${n}-${_}`,t.push({binding:a.slot+1,visibility:n,sampler:{type:_}})}}),e.storageTextureFormats.forEach(a=>{const{format:n,textureDimension:r}=a,{read:l,write:u}=a;s+=`#${a.slot}ST:${n}-${r}-${l?"r1":"r0"}-${u?"w1":"w0"}`,t.push({binding:a.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:l?u?"read-write":"read-only":"write-only",format:ze[n],viewDimension:r}})}),e.storageBufferFormats.forEach(a=>{const n=a.readOnly,r=Kw.shaderStage(a.visibility);s+=`#${a.slot}SB:${r}-${n?"ro":"rw"}`,t.push({binding:a.slot,visibility:r,buffer:{type:n?"read-only-storage":"storage"}})}),{key:s,desc:{entries:t}}}}class mC{constructor(e=0){this.buffer=null,this.usageFlags=0,this.usageFlags=e}destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}allocate(e,t){this.buffer=e.wgpu.createBuffer({size:t,usage:this.usageFlags})}unlock(e,t){const s=e.wgpu;if(!this.buffer){const r=t.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(e,r)}const i=t.byteOffset??0,a=new Uint8Array(t.buffer??t,i,t.byteLength),n=new Uint8Array(this.buffer.size);n.set(a),s.queue.writeBuffer(this.buffer,0,n,0,n.length)}read(e,t,s,i){return e.readStorageBuffer(this,t,s,i)}write(e,t,s,i,a){e.writeStorageBuffer(this,t,s,i,a)}clear(e,t,s){e.clearStorageBuffer(this,t,s)}}class GV extends mC{constructor(e,t){super(SF|(t!=null&&t.storage?K2:0)),this.format=null,this.format=e.format===ho?"uint16":"uint32"}unlock(e){const t=e.device;super.unlock(t,e.storage)}}const HV={equals(h,e){if(h.length!==e.length)return!1;for(let t=0;t<h.length;t++)if(h[t]!==e[t])return!1;return!0}},Qc=[];Qc[ml]="sint8";Qc[io]="uint8";Qc[_l]="sint16";Qc[Dh]="uint16";Qc[jt]="sint32";Qc[Ai]="uint32";Qc[it]="float32";Qc[Y1]="float16";const $c=[];$c[ml]="snorm8";$c[io]="unorm8";$c[_l]="snorm16";$c[Dh]="unorm16";$c[jt]="sint32";$c[Ai]="uint32";$c[it]="float32";$c[Y1]="float16";class WV{get(e,t=null){const s=this.getKey(e,t);let i=this.cache.get(s);return i||(i=this.create(e,t),this.cache.set(s,i)),i}getKey(e,t=null){return`${e==null?void 0:e.renderingHashString}-${t==null?void 0:t.renderingHashString}`}create(e,t){const s=[],i=a=>{const n=a.interleaved,r=a.instancing?"instance":"vertex";let l=[];const u=a.elements.length;for(let f=0;f<u;f++){const _=a.elements[f],g=Bt[_.name],y=_.normalize?$c:Qc;l.push({shaderLocation:g,offset:n?_.offset:0,format:`${y[_.dataType]}${_.numComponents>1?`x${_.numComponents}`:""}`}),(!n||f===u-1)&&(s.push({attributes:l,arrayStride:_.stride,stepMode:r}),l=[])}};return e&&i(e),t&&i(t),s}constructor(){this.cache=new Map}}class hB{constructor(e){this.device=e}getPipelineLayout(e){const t=[];e.forEach(a=>{t.push(a.bindGroupLayout)});const s={bindGroupLayouts:t};return this.device.wgpu.createPipelineLayout(s)}}const qV=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],HI=["add","subtract","reverse-subtract","min","max"],lE=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],Qw=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],XV=["none","back","front"],ig=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],jV=["","uint16","uint32"];class YV{}class KV extends hB{constructor(e){super(e),this.lookupHashes=new Uint32Array(14),this.vertexBufferLayout=new WV,this.cache=new Map}get(e,t,s,i,a,n,r,l,u,f,_,g,y){var I,U,O;const v=e.type;i&&v!==oC&&v!==hl&&(i=void 0);const x=this.lookupHashes;x[0]=v,x[1]=a.id,x[2]=f,x[3]=u.key,x[4]=l.key,x[5]=(t==null?void 0:t.renderingHash)??0,x[6]=(s==null?void 0:s.renderingHash)??0,x[7]=n.impl.key,x[8]=((I=r[0])==null?void 0:I.key)??0,x[9]=((U=r[1])==null?void 0:U.key)??0,x[10]=((O=r[2])==null?void 0:O.key)??0,x[11]=_?g.key:0,x[12]=_?y.key:0,x[13]=i??0;const C=tP(x);let M=this.cache.get(C);if(M)for(let N=0;N<M.length;N++){const z=M[N];if(HV.equals(z.hashes,x))return z.pipeline}const w=qV[v],T=this.getPipelineLayout(r),R=this.vertexBufferLayout.get(t,s),D=new YV;return D.hashes=new Uint32Array(x),D.pipeline=this.create(w,i,a,n,T,l,u,R,f,_,g,y),M?M.push(D):M=[D],this.cache.set(C,M),D.pipeline}getBlend(e){let t;return e.blend&&(t={color:{operation:HI[e.colorOp],srcFactor:lE[e.colorSrcFactor],dstFactor:lE[e.colorDstFactor]},alpha:{operation:HI[e.alphaOp],srcFactor:lE[e.alphaSrcFactor],dstFactor:lE[e.alphaDstFactor]}}),t}getDepthStencil(e,t,s,i,a){let n;const{depth:r,stencil:l}=t;return(r||l)&&(n={format:t.impl.depthAttachment.format},r?(n.depthWriteEnabled=e.write,n.depthCompare=Qw[e.func],n.depthBias=e.depthBias,n.depthBiasSlopeScale=e.depthBiasSlope):(n.depthWriteEnabled=!1,n.depthCompare="always"),l&&s&&(n.stencilReadMas=i.readMask,n.stencilWriteMask=i.writeMask,n.stencilFront={compare:Qw[i.func],failOp:ig[i.fail],passOp:ig[i.zpass],depthFailOp:ig[i.zfail]},n.stencilBack={compare:Qw[a.func],failOp:ig[a.fail],passOp:ig[a.zpass],depthFailOp:ig[a.zfail]})),n}create(e,t,s,i,a,n,r,l,u,f,_,g){const y=this.device.wgpu,v=s.impl,x={vertex:{module:v.getVertexShaderModule(),entryPoint:v.vertexEntryPoint,buffers:l},primitive:{topology:e,frontFace:"ccw",cullMode:XV[u]},depthStencil:this.getDepthStencil(r,i,f,_,g),multisample:{count:i.samples},layout:a};t&&(x.primitive.stripIndexFormat=jV[t]),x.fragment={module:v.getFragmentShaderModule(),entryPoint:v.fragmentEntryPoint,targets:[]};const C=i.impl.colorAttachments;if(C.length>0){let w=0;n.redWrite&&(w|=GPUColorWrite.RED),n.greenWrite&&(w|=GPUColorWrite.GREEN),n.blueWrite&&(w|=GPUColorWrite.BLUE),n.alphaWrite&&(w|=GPUColorWrite.ALPHA);const T=this.getBlend(n);C.forEach(R=>{x.fragment.targets.push({format:R.format,writeMask:w,blend:T})})}return y.createRenderPipeline(x)}}class QV extends hB{get(e,t){const s=this.getPipelineLayout([t.impl]);return this.create(e,s)}create(e,t){const s=this.device.wgpu,i=e.impl,a={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:t};return s.createComputePipeline(a)}}class _C{incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}constructor(){this._refCount=0}}class $V extends _C{constructor(e){super(),this.object=e,this.incRefCount()}}class ZV{destroy(){this.cache.forEach(e=>{var t;(t=e.object)==null||t.destroy()}),this.cache.clear()}clear(){this.cache.clear()}get(e){const t=this.cache.get(e);return t?(t.incRefCount(),t.object):null}set(e,t){this.cache.set(e,new $V(t))}release(e){var s;const t=this.cache.get(e);t&&(t.decRefCount(),t.refCount===0&&(this.cache.delete(e),(s=t.object)==null||s.destroy()))}constructor(){this.cache=new Map}}class JV extends ZV{loseContext(e){this.clear()}}const eG=new Xn,cb=h=>eG.get(h,()=>new JV),tG=new rx;class sG{destroy(){var e;(e=this.multisampledBuffer)==null||e.destroy(),this.multisampledBuffer=null}}class WI{constructor(e){this.depthTexture=null,this.depthTextureInternal=!1,this.multisampledDepthBuffer=null,this.format=e,this.hasStencil=e==="depth24plus-stencil8"}destroy(e){var t;this.depthTextureInternal&&((t=this.depthTexture)==null||t.destroy(),this.depthTexture=null),this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,cb(e).release(this.multisampledDepthBufferKey))}}class iG{constructor(e){this.initialized=!1,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=!1,this.renderTarget=e}destroy(e){var t;this.initialized=!1,this.assignedColorTexture=null,this.colorAttachments.forEach(s=>{s.destroy()}),this.colorAttachments.length=0,(t=this.depthAttachment)==null||t.destroy(e),this.depthAttachment=null}updateKey(){let t=`${this.renderTarget.samples}:${this.depthAttachment?this.depthAttachment.format:"nodepth"}`;this.colorAttachments.forEach(s=>{t+=`:${s.format}`}),this.key=tG.get(t)}assignColorTexture(e,t){this.assignedColorTexture=t;const s=t.createView({format:e.backBufferViewFormat}),i=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?i.resolveTarget=s:i.view=s,this.setColorAttachment(0,void 0,e.backBufferViewFormat),this.updateKey()}setColorAttachment(e,t,s){this.colorAttachments[e]||(this.colorAttachments[e]=new sG),t&&(this.colorAttachments[e].multisampledBuffer=t),s&&(this.colorAttachments[e].format=s)}init(e,t){var a,n;const s=e.wgpu;this.initDepthStencil(e,s,t),t._colorBuffers&&t._colorBuffers.forEach((r,l)=>{this.setColorAttachment(l,void 0,r.impl.format)}),this.renderPassDescriptor.colorAttachments=[];const i=this.isBackbuffer?1:((a=t._colorBuffers)==null?void 0:a.length)??0;for(let r=0;r<i;++r){const l=this.initColor(e,s,t,r),u=r===0&&((n=this.colorAttachments[0])==null?void 0:n.format);(l.view||u)&&this.renderPassDescriptor.colorAttachments.push(l)}this.updateKey(),this.initialized=!0}initDepthStencil(e,t,s){const{samples:i,width:a,height:n,depth:r,depthBuffer:l}=s;if(r||l){let u;if(l)if(this.depthAttachment=new WI(l.impl.format),i>1){const f="depth24plus-stencil8";this.depthAttachment.format=f,this.depthAttachment.hasStencil=f==="depth24plus-stencil8";const _=`${l.id}:${a}:${n}:${i}:${f}`,g=cb(e);let y=g.get(_);if(!y){const v={size:[a,n,1],dimension:"2d",sampleCount:i,format:f,usage:GPUTextureUsage.RENDER_ATTACHMENT|(f!==l.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};y=t.createTexture(v),g.set(_,y)}this.depthAttachment.multisampledDepthBuffer=y,this.depthAttachment.multisampledDepthBufferKey=_,u=y.createView()}else{const f=l.impl.gpuTexture;this.depthAttachment.depthTexture=f,u=f.createView()}else{this.depthAttachment=new WI("depth24plus-stencil8");const f={size:[a,n,1],dimension:"2d",sampleCount:i,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};i>1?f.usage|=GPUTextureUsage.TEXTURE_BINDING:f.usage|=GPUTextureUsage.COPY_SRC;const _=t.createTexture(f);this.depthAttachment.depthTexture=_,this.depthAttachment.depthTextureInternal=!0,u=_.createView()}this.renderPassDescriptor.depthStencilAttachment={view:u}}}initColor(e,t,s,i){const a={},{samples:n,width:r,height:l,mipLevel:u}=s,f=s.getColorBuffer(i);let _=null;if(f&&(f.cubemap?_=f.impl.createView({dimension:"2d",baseArrayLayer:s.face,arrayLayerCount:1,mipLevelCount:1,baseMipLevel:u}):_=f.impl.createView({mipLevelCount:1,baseMipLevel:u})),n>1){const g=this.isBackbuffer?e.backBufferViewFormat:f.impl.format,y={size:[r,l,1],dimension:"2d",sampleCount:n,format:g,usage:GPUTextureUsage.RENDER_ATTACHMENT},v=t.createTexture(y);this.setColorAttachment(i,v,y.format),a.view=v.createView(),a.resolveTarget=_}else a.view=_;return a}setupForRenderPass(e,t){var a;const s=((a=this.renderPassDescriptor.colorAttachments)==null?void 0:a.length)??0;for(let n=0;n<s;++n){const r=this.renderPassDescriptor.colorAttachments[n],l=e.colorArrayOps[n],u=t.isColorBufferSrgb(n);r.clearValue=u?l.clearValueLinear:l.clearValue,r.loadOp=l.clear?"clear":"load",r.storeOp=l.store?"store":"discard"}const i=this.renderPassDescriptor.depthStencilAttachment;i&&(i.depthClearValue=e.depthStencilOps.clearDepthValue,i.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",i.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",i.depthReadOnly=!1,this.depthAttachment.hasStencil&&(i.stencilClearValue=e.depthStencilOps.clearStencilValue,i.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",i.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",i.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(e,t,s,i){}}const Gi=[];Gi[Vn]=1;Gi[zd]=2;Gi[Fn]=3;Gi[kd]=4;Gi[Ud]=1;Gi[Rd]=2;Gi[Md]=3;Gi[Dd]=4;Gi[Wp]=1;Gi[x0]=2;Gi[T0]=3;Gi[E0]=4;Gi[Yb]=8;Gi[A0]=12;Gi[im]=16;Gi[am]=1;Gi[nm]=2;Gi[rm]=3;Gi[om]=4;class ri{get isArrayType(){return this.count>0}constructor(e,t,s=0){if(this.shortName=e,this.name=s?`${e}[0]`:e,this.type=t,this.numComponents=Gi[t],this.updateType=t,s>0)switch(t){case Vn:this.updateType=K1;break;case Ud:this.updateType=lm;break;case am:this.updateType=Z1;break;case Wp:this.updateType=J1;break;case zd:this.updateType=Q1;break;case Rd:this.updateType=hm;break;case nm:this.updateType=ex;break;case x0:this.updateType=tx;break;case Fn:this.updateType=$1;break;case Md:this.updateType=cm;break;case rm:this.updateType=sx;break;case T0:this.updateType=ix;break;case kd:this.updateType=cC;break;case Dd:this.updateType=Kb;break;case om:this.updateType=uC;break;case E0:this.updateType=dC;break;case im:this.updateType=zD;break}this.count=s;let i=this.numComponents;s&&(i=ge.roundUp(i,4)),this.byteSize=i*4,s&&(this.byteSize*=s)}calculateOffset(e){let t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=ge.roundUp(e,t),this.offset=e/4}}class ey{constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let s=0;for(let i=0;i<t.length;i++){const a=t[i];a.calculateOffset(s),s=a.offset*4+a.byteSize,a.scopeId=this.scope.resolve(a.name),this.map.set(a.name,a)}this.byteSize=ge.roundUp(s,16)}get(e){return this.map.get(e)}}const qI=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,$w=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,Zw="@@@",aG=/([\w-]+)\[(.*?)\]/,nG=new Set(["highp","mediump","lowp"]),rG=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),oG={sampler2D:bh,sampler3D:Hp,samplerCube:xd,samplerCubeShadow:xd,sampler2DShadow:bh,sampler2DArray:bd,sampler2DArrayShadow:bd,isampler2D:bh,usampler2D:bh,isampler3D:Hp,usampler3D:Hp,isamplerCube:xd,usamplerCube:xd,isampler2DArray:bd,usampler2DArray:bd},lG={[bh]:"texture2D",[xd]:"textureCube",[Hp]:"texture3D",[bd]:"texture2DArray"};let hG=class{constructor(e,t){this.line=e;const s=e.trim().split(/\s+/);if(nG.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),e.includes(","),e.includes("[")){const i=s.join(" "),a=aG.exec(i);this.name=a[1],this.arraySize=Number(a[2]),isNaN(this.arraySize)&&(t.failed=!0)}else this.name=s.shift(),this.arraySize=0;this.isSampler=this.type.indexOf("sampler")!==-1,this.isSignedInt=this.type.indexOf("isampler")!==-1,this.isUnsignedInt=this.type.indexOf("usampler")!==-1}};class wa{static run(e,t,s){const i=new Map,a=wa.extract(t.vshader),n=wa.extract(t.fshader),r=new Map,l=wa.processAttributes(a.attributes,t.attributes,r,t.processingOptions),u=wa.processVaryings(a.varyings,i,!0),f=wa.processVaryings(n.varyings,i,!1),_=wa.processOuts(n.outs),g=a.uniforms.concat(n.uniforms),v=Array.from(new Set(g)).map(R=>new hG(R,s)),x=wa.processUniforms(e,v,t.processingOptions,s),C=`${l}
${u}
${x.code}`,M=a.src.replace(Zw,C),w=`${f}
${_}
${x.code}`,T=n.src.replace(Zw,w);return{vshader:M,fshader:T,attributes:r,meshUniformBufferFormat:x.meshUniformBufferFormat,meshBindGroupFormat:x.meshBindGroupFormat}}static extract(e){const t=[],s=[],i=[],a=[];let n=`${Zw}
`,r;for(;(r=qI.exec(e))!==null;){const l=r[1];switch(l){case"attribute":case"varying":case"uniform":case"out":{$w.lastIndex=r.index;const u=$w.exec(e);l==="attribute"?t.push(u[2]):l==="varying"?s.push(u[2]):l==="out"?i.push(u[2]):l==="uniform"&&a.push(u[2]),e=wa.cutOut(e,r.index,$w.lastIndex,n),qI.lastIndex=r.index+n.length,n="";break}}}return{src:e,attributes:t,varyings:s,outs:i,uniforms:a}}static processUniforms(e,t,s,i){const a=[],n=[];t.forEach(g=>{g.isSampler?a.push(g):n.push(g)});const r=[];n.forEach(g=>{if(!s.hasUniform(g.name)){const y=WM.indexOf(g.type),v=new ri(g.name,y,g.arraySize);r.push(v)}}),r.length===0&&r.push(new ri(fC,Vn));const l=r.length?new ey(e,r):null,u=[];a.forEach(g=>{if(!s.hasTexture(g.name)){let y=Om;g.isSignedInt?y=Bd:g.isUnsignedInt?y=sm:(g.precision==="highp"&&(y=j1),rG.has(g.type)&&(y=b0));const v=oG[g.type];u.push(new Zb(g.name,Vd|Gd,v,y))}});const f=new Nm(e,u);let _="";return s.uniformFormats.forEach((g,y)=>{g&&(_+=wa.getUniformShaderDeclaration(g,y,0))}),l&&(_+=wa.getUniformShaderDeclaration(l,um,0)),s.bindGroupFormats.forEach((g,y)=>{g&&(_+=wa.getTexturesShaderDeclaration(g,y))}),_+=wa.getTexturesShaderDeclaration(f,Q0),{code:_,meshUniformBufferFormat:l,meshBindGroupFormat:f}}static processVaryings(e,t,s){let i="";const a=s?"out":"in";return e.forEach((n,r)=>{const l=wa.splitToWords(n),u=l.slice(0,-1).join(" "),f=l[l.length-1];s?t.set(f,r):r=t.get(f),i+=`layout(location = ${r}) ${a} ${u} ${f};
`}),i}static processOuts(e){let t="";return e.forEach((s,i)=>{t+=`layout(location = ${i}) out ${s};
`}),t}static getTypeCount(e){const t=e.substring(e.length-1),s=parseInt(t,10);return isNaN(s)?1:s}static processAttributes(e,t,s,i){let a="";return e.forEach(n=>{const r=wa.splitToWords(n);let l=r[0],u=r[1];if(t.hasOwnProperty(u)){const f=t[u],_=Bt[f];s.set(_,u);let g;const y=i.getVertexElement(f);if(y){const v=y.dataType;if(v!==it&&v!==Y1&&!y.normalize&&!y.asInt){const x=wa.getTypeCount(l),C=`_private_${u}`;g=`vec${x} ${u} = vec${x}(${C});
`,u=C;const M=v===ml||v===_l||v===jt;x===1?l=M?"int":"uint":l=M?`ivec${x}`:`uvec${x}`}}a+=`layout(location = ${_}) in ${l} ${u};
`,g&&(a+=g)}}),a}static splitToWords(e){return e=e.replace(/\s+/g," ").trim(),e.split(" ")}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}static getUniformShaderDeclaration(e,t,s){const i=ZD[t];let a=`layout(set = ${t}, binding = ${s}, std140) uniform ub_${i} {
`;return e.uniforms.forEach(n=>{const r=WM[n.type];a+=`    ${r} ${n.shortName}${n.count?`[${n.count}]`:""};
`}),`${a}};
`}static getTexturesShaderDeclaration(e,t){let s="";return e.textureFormats.forEach(i=>{let a=lG[i.textureDimension];const n=a==="texture2DArray",r=i.sampleType===sm?"u":i.sampleType===Bd?"i":"";a=`${r}${a}`;let l="",u="";n&&(l="_texture",u=`#define ${i.name} ${r}sampler2DArray(${i.name}${l}, ${i.name}_sampler)
`),s+=`layout(set = ${t}, binding = ${i.slot}) uniform ${a} ${i.name}${l};
`,i.hasSampler&&(s+=`layout(set = ${t}, binding = ${i.slot+1}) uniform sampler ${i.name}_sampler;
`),s+=u}),s}}const XI=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,Jw=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,eR=/^[ \t]*var\s*(<[^>]+>)?\s*[\w\d_]+\s*:\s*(texture_.*|storage_texture_.*|storage.*|external_texture|array<.*>|sampler|sampler_comparison).*;\s*$/gm,cG=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:/,tR="@@@",uG=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,dG=(h,e)=>{if(e){if(h==="2d")return bd;if(h==="cube")return UD}else switch(h){case"1d":return BD;case"2d":return bh;case"3d":return Hp;case"cube":return xd}},fG=(h,e)=>{const t=e===Om?"f32":e===Bd?"i32":"u32";switch(h){case BD:return`texture_1d<${t}>`;case bh:return`texture_2d<${t}>`;case Hp:return`texture_3d<${t}>`;case xd:return`texture_cube<${t}>`;case bd:return`texture_2d_array<${t}>`;case UD:return`texture_cube_array<${t}>`}},pG={f32:Om,i32:Bd,u32:sm},jI={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},cB=h=>(h=h.replace(/\s+/g," ").trim(),h.split(/[\s:]+/)),mG=/array<([^,]+),\s*([^>]+)>/;class _G{constructor(e,t){this.ubName=null,this.arraySize=0,this.line=e;const s=cB(e);if(s.length<2){t.failed=!0;return}if(this.name=s[0],this.type=s.slice(1).join(" "),this.type.includes("array<")){const i=mG.exec(this.type);this.type=i[1].trim(),this.arraySize=Number(i[2]),isNaN(this.arraySize)&&(t.failed=!0)}}}const gG=/^\s*var\s+([\w\d_]+)\s*:\s*array<([\w\d_<>]+),\s*(\d+)>;\s*$/,yG=/^\s*var\s+([\w\d_]+)\s*:\s*texture_(\w+)<([a-zA-Z0-9_,<>]*)>;\s*$/,vG=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,SG=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,bG=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,xG=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/;class TG{constructor(e,t){this.originalLine=e,this.line=e,this.isTexture=!1,this.isSampler=!1,this.isStorageTexture=!1,this.isStorageBuffer=!1,this.isExternalTexture=!1,this.arraySize=0,this.type="",this.matchedElements=[];const s=e.match(gG);s&&(this.name=s[1],this.arraySize=parseInt(s[3],10),this.line=`var ${this.name} : ${s[2]};`,this.matchedElements.push(...s),isNaN(this.arraySize)&&(t.failed=!0));const i=this.line.match(yG);i&&(this.name=i[1],this.type=i[2],this.textureFormat=i[3],this.isTexture=!0,this.matchedElements.push(...i),this.textureDimension=dG(this.type,this.arraySize>0),this.sampleType=pG[this.textureFormat]);const a=this.line.match(vG);a&&(this.isStorageTexture=!0,this.name=a[1],this.textureType=a[2],this.format=a[3],this.access=a[4],this.matchedElements.push(...a));const n=this.line.match(SG);n&&(this.isStorageBuffer=!0,this.accessMode=n[1]||"none",this.name=n[2],this.type=n[3],this.matchedElements.push(...n));const r=this.line.match(bG);r&&(this.name=r[1],this.isExternalTexture=!0,this.matchedElements.push(...n));const l=this.line.match(xG);l&&(this.name=l[1],this.samplerType=l[2],this.isSampler=!0,this.matchedElements.push(...l)),this.matchedElements.length===0&&(t.failed=!0)}}class Ti{static run(e,t,s){const i=new Map,a=Ti.extract(t.vshader),n=Ti.extract(t.fshader),r=new Map,l=Ti.processAttributes(a.attributes,t.attributes,r,t.processingOptions),u=Ti.processVaryings(a.varyings,i,!0),f=Ti.processVaryings(n.varyings,i,!1),_=a.uniforms.concat(n.uniforms),y=Array.from(new Set(_)).map(O=>new _G(O,s)),v=Ti.processUniforms(e,y,t.processingOptions,s);a.src=Ti.renameUniformAccess(a.src,y),n.src=Ti.renameUniformAccess(n.src,y);const x=a.resources.concat(n.resources),M=Array.from(new Set(x)).map(O=>new TG(O,s)),w=Ti.processResources(e,M,t.processingOptions,s),T=Ti.generateFragmentOutputStruct(n.src,e.maxColorAttachments);a.src=Ti.copyInputs(a.src,s),n.src=Ti.copyInputs(n.src,s);const R=`${l}
${u}
${v.code}
${w.code}
`,D=a.src.replace(tR,R),I=`${f}
${T}
${v.code}
${w.code}
`,U=n.src.replace(tR,I);return{vshader:D,fshader:U,attributes:r,meshUniformBufferFormat:v.meshUniformBufferFormat,meshBindGroupFormat:w.meshBindGroupFormat}}static extract(e){const t=[],s=[],i=[],a=[];let n=`${tR}
`,r;for(;(r=XI.exec(e))!==null;){const l=r[1];Jw.lastIndex=r.index;const u=Jw.exec(e);l==="attribute"?t.push(u[2]):l==="varying"?s.push(u[2]):l==="uniform"&&i.push(u[2]),e=Ti.cutOut(e,r.index,Jw.lastIndex,n),XI.lastIndex=r.index+n.length,n=""}for(;(r=eR.exec(e))!==null;)a.push(r[0]),e=Ti.cutOut(e,r.index,eR.lastIndex,n),eR.lastIndex=r.index+n.length,n="";return{src:e,attributes:t,varyings:s,uniforms:i,resources:a}}static processUniforms(e,t,s,i){const a=[];t.forEach(l=>{if(s.hasUniform(l.name))l.ubName="ub_view";else{l.ubName="ub_mesh_ub";const u=VD.get(l.type),f=new ri(l.name,u,l.arraySize);a.push(f)}}),a.length===0&&a.push(new ri(fC,Vn));const n=new ey(e,a);let r="";return s.uniformFormats.forEach((l,u)=>{l&&(r+=Ti.getUniformShaderDeclaration(l,u,0))}),n&&(r+=Ti.getUniformShaderDeclaration(n,um,0)),{code:r,meshUniformBufferFormat:n}}static renameUniformAccess(e,t){return t.forEach(s=>{const i=`uniform.${s.name}`,a=`${s.ubName}.${s.name}`,n=new RegExp(`\\b${i}\\b`,"g");e=e.replace(n,a)}),e}static processResources(e,t,s,i){const a=[];for(let l=0;l<t.length;l++){const u=t[l];if(u.isTexture){const f=t[l+1],_=f==null?void 0:f.isSampler,g=u.sampleType,y=u.textureDimension;a.push(new Zb(u.name,Vd|Gd,y,g,_,_?f.name:null)),_&&l++}if(u.isStorageBuffer){const f=u.accessMode!=="read_write",_=new JD(u.name,Vd|Gd,f);_.format=u.type,a.push(_)}}const n=new Nm(e,a);let r="";return s.bindGroupFormats.forEach((l,u)=>{l&&(r+=Ti.getTextureShaderDeclaration(l,u,1))}),r+=Ti.getTextureShaderDeclaration(n,Q0,0),{code:r,meshBindGroupFormat:n}}static getUniformShaderDeclaration(e,t,s){const i=ZD[t],a=`struct_ub_${i}`;let n=`struct ${a} {
`;return e.uniforms.forEach(r=>{let l=kD[r.type][0];r.count>0?(jI.hasOwnProperty(l)&&(l=jI[l]),n+=`    ${r.shortName}: array<${l}, ${r.count}>,
`):n+=`    ${r.shortName}: ${l},
`}),n+=`};
`,n+=`@group(${t}) @binding(${s}) var<uniform> ub_${i} : ${a};

`,n}static getTextureShaderDeclaration(e,t,s){let i="",a=s;return e.textureFormats.forEach(n=>{const r=fG(n.textureDimension,n.sampleType);i+=`@group(${t}) @binding(${a}) var ${n.name}: ${r};
`,a++,n.hasSampler&&(i+=`@group(${t}) @binding(${a}) var ${n.samplerName}: sampler;
`,a++)}),e.storageBufferFormats.forEach(n=>{const r=n.readOnly?"read":"read_write";i+=`@group(${t}) @binding(${a}) var<storage, ${r}> ${n.name} : ${n.format};
`,a++}),i}static processVaryings(e,t,s){let i="",a="",n="";e.forEach((u,f)=>{const _=u.match(cG);if(_){const g=_[1];s?t.set(g,f):f=t.get(g),i+=`    @location(${f}) ${u},
`,s||(a+=`    var<private> ${u};
`,n+=`    ${g} = input.${g};
`)}}),s?i+=`    @builtin(position) position : vec4f,
`:(i+=`    @builtin(position) position : vec4f,
`,i+=`    @builtin(front_facing) frontFacing : bool,
`,i+=`    @builtin(sample_index) sampleIndex : u32
`);const r=s?"":`
						var<private> pcPosition: vec4f;
						var<private> pcFrontFacing: bool;
						var<private> pcSampleIndex: u32;
						${a}
						
						// function to copy inputs (varyings) to private global variables
						fn _pcCopyInputs(input: FragmentInput) {
								${n}
								pcPosition = input.position;
								pcFrontFacing = input.frontFacing;
								pcSampleIndex = input.sampleIndex;
						}
				`;return`
						struct ${s?"VertexOutput":"FragmentInput"} {
								${i}
						};
						${r}
				`}static generateFragmentOutputStruct(e,t){let s=`struct FragmentOutput {
`;for(let a=0;a<t;a++)s+=`    @location(${a}) color${a>0?a:""} : vec4f,
`;return e.search(/\.fragDepth\s*=/)!==-1&&(s+=`    @builtin(frag_depth) fragDepth : f32
`),`${s}};
`}static floatAttributeToInt(e,t){const i={f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"}[e]||e;return{f32:t?"i32":"u32",vec2f:t?"vec2i":"vec2u",vec3f:t?"vec3i":"vec3u",vec4f:t?"vec4i":"vec4u"}[i]||null}static processAttributes(e,t={},s,i){let a="",n="",r="";return e.forEach(l=>{const u=cB(l),f=u[0];let _=u[1];const g=_;if(t.hasOwnProperty(f)){const y=t[f],v=Bt[y];s.set(v,f);const x=i.getVertexElement(y);if(x){const C=x.dataType;if(C!==it&&C!==Y1&&!x.normalize&&!x.asInt){const M=C===ml||C===_l||C===jt;_=Ti.floatAttributeToInt(_,M)}}a+=`    @location(${v}) ${f}: ${_},
`,n+=`    var<private> ${l};
`,r+=`    ${f} = ${g}(input.${f});
`}}),`
						struct VertexInput {
								${a}
								@builtin(vertex_index) vertexIndex : u32,       // built-in vertex index
								@builtin(instance_index) instanceIndex : u32    // built-in instance index
						};

						${n}
						var<private> pcVertexIndex: u32;
						var<private> pcInstanceIndex: u32;

						fn _pcCopyInputs(input: VertexInput) {
								${r}
								pcVertexIndex = input.vertexIndex;
								pcInstanceIndex = input.instanceIndex;
						}
				`}static copyInputs(e,t){const s=e.match(uG);if(!s||!s[2])return e;const i=s[2],a=s.index+s[0].length-1,n=e.slice(0,a+1),r=e.slice(a+1),l=`
    _pcCopyInputs(${i});`;return n+l+r}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}}class EG{constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;const t=e.definition;t.shaderLanguage===Ja?(t.cshader?(this._computeCode=t.cshader??null,this.computeUniformBufferFormats=t.computeUniformBufferFormats,this.computeBindGroupFormat=t.computeBindGroupFormat):(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",t.processingOptions?this.processWGSL():(this._vertexCode=t.vshader??null,this._fragmentCode=t.fshader??null,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat)),e.ready=!0):t.processingOptions&&this.processGLSL()}destroy(e){this._vertexCode=null,this._fragmentCode=null}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}processGLSL(){const e=this.shader,t=wa.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=!0:e.failed=!0,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes}processWGSL(){const e=this.shader,t=Ti.run(e.device,e.definition,e);this._vertexCode=t.vshader,this._fragmentCode=t.fshader,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes}transpile(e,t,s){try{const i=this.shader.device.glslang.compileGLSL(e,t);return this.shader.device.twgsl.convertSpirV2WGSL(i)}catch(i){console.error(`Failed to transpile webgl ${t} shader [${this.shader.label}] to WebGPU while rendering undefined, error:
 [${i.stack}]`,{processed:e,original:s,shader:this.shader,error:i,stack:i.stack})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(e,t){}}const s0=[];s0[Zs]="repeat";s0[Oe]="clamp-to-edge";s0[O0]="mirror-repeat";const Vc=[];Vc[Je]={level:"nearest",mip:"nearest"};Vc[Vt]={level:"linear",mip:"nearest"};Vc[vm]={level:"nearest",mip:"nearest"};Vc[Sm]={level:"nearest",mip:"linear"};Vc[bm]={level:"linear",mip:"nearest"};Vc[lo]={level:"linear",mip:"linear"};const AG=h=>{};class CG{constructor(e){this.samplers=[],this.texture=e,this.format=ze[e.format],this.create(e.device)}create(e){const t=this.texture,s=e.wgpu,i=t.numLevels;this.desc={size:{width:t.width,height:t.height,depthOrArrayLayers:t.cubemap?6:t.array?t.arrayLength:1},format:this.format,mipLevelCount:i,sampleCount:1,dimension:t.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(qb(t.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(t.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.desc);let a;this.texture.format===Fd&&(a={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(a)}destroy(e){}propertyChanged(e){this.samplers.length=0}getView(e){return this.uploadImmediate(e,this.texture),this.view}createView(e){const t=e??{},s=this.desc,i=this.texture,a=()=>i.cubemap?"cube":i.volume?"3d":i.array?"2d-array":"2d",n={format:t.format??s.format,dimension:t.dimension??a(),aspect:t.aspect??"all",baseMipLevel:t.baseMipLevel??0,mipLevelCount:t.mipLevelCount??s.mipLevelCount,baseArrayLayer:t.baseArrayLayer??0,arrayLayerCount:t.arrayLayerCount??s.depthOrArrayLayers};return this.gpuTexture.createView(n)}getSampler(e,t){let s=this.samplers[t];if(!s){const i=this.texture,a={addressModeU:s0[i.addressU],addressModeV:s0[i.addressV],addressModeW:s0[i.addressW]};!t&&i.compareOnRead&&(t=b0),t===b0||t===Bd||t===sm?(a.compare="less",a.magFilter="linear",a.minFilter="linear"):t===j1||!e.textureFloatFilterable&&(i.format===Ri||i.format===Js)||this.texture.format===Fd||kc(this.texture.format)?(a.magFilter="nearest",a.minFilter="nearest",a.mipmapFilter="nearest"):(a.magFilter=Vc[i.magFilter].level,a.minFilter=Vc[i.minFilter].level,a.mipmapFilter=Vc[i.minFilter].mip);const n=a.minFilter==="linear"&&a.magFilter==="linear"&&a.mipmapFilter==="linear";a.maxAnisotropy=n?ge.clamp(Math.round(i._anisotropy),1,e.maxTextureAnisotropy):1,s=e.wgpu.createSampler(a),this.samplers[t]=s}return s}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=!1,t._needsMipmapsUpload=!1)}uploadData(e){const t=this.texture;if(t._levels){let s=!1,i=!1;const a=t.numLevels;for(let n=0;n<a;n++){const r=t._levels[n];if(r){if(t.cubemap)for(let l=0;l<6;l++){const u=r[l];u?this.isExternalImage(u)?(this.uploadExternalImage(e,u,n,l),s=!0):ArrayBuffer.isView(u)&&(this.uploadTypedArrayData(e,u,n,l),s=!0):i=!0}else if(!t._volume)if(t.array)if(t.arrayLength===r.length)for(let l=0;l<t._arrayLength;l++){const u=r[l];this.isExternalImage(u)?(this.uploadExternalImage(e,u,n,l),s=!0):ArrayBuffer.isView(u)&&(this.uploadTypedArrayData(e,u,n,l),s=!0)}else i=!0;else this.isExternalImage(r)?(this.uploadExternalImage(e,r,n,0),s=!0):ArrayBuffer.isView(r)&&(this.uploadTypedArrayData(e,r,n,0),s=!0)}else i=!0}s&&i&&t.mipmaps&&!qb(t.format)&&!kc(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize)}}isExternalImage(e){return e instanceof ImageBitmap||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas}uploadExternalImage(e,t,s,i){const a={source:t,origin:[0,0],flipY:!1},n={texture:this.gpuTexture,mipLevel:s,origin:[0,0,i],aspect:"all"},r={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};e.submit(),AG(t instanceof HTMLCanvasElement&&t.getContext("2d")),e.wgpu.queue.copyExternalImageToTexture(a,n,r)}uploadTypedArrayData(e,t,s,i){const a=this.texture,n=e.wgpu,r={texture:this.gpuTexture,origin:[0,0,i],mipLevel:s},l=fr.calcLevelDimension(a.width,s),u=fr.calcLevelDimension(a.height,s);fr.calcLevelGpuSize(l,u,1,a.format);const f=yr.get(a.format);let _,g;if(f.size)_={offset:0,bytesPerRow:f.size*l,rowsPerImage:u},g={width:l,height:u};else if(f.blockSize){const y=v=>Math.floor((v+3)/4);_={offset:0,bytesPerRow:f.blockSize*y(l),rowsPerImage:y(u)},g={width:Math.max(4,l),height:Math.max(4,u)}}e.submit(),n.queue.writeTexture(r,t,_,g)}read(e,t,s,i,a){const n=a.mipLevel??0,r=a.face??0,l=a.data??null,u=a.immediate??!1,f=this.texture,_=yr.get(f.format),g=s*_.size,y=ge.roundUp(g,256),v=y*i,x=f.device,C=x.createBufferImpl(wD|RD);C.allocate(x,v);const M={texture:this.gpuTexture,mipLevel:n,origin:[e,t,r]},w={buffer:C.buffer,offset:0,bytesPerRow:y},T={width:s,height:i,depthOrArrayLayers:1};return x.getCommandEncoder().copyTextureToBuffer(M,w,T),x.readBuffer(C,v,null,u).then(D=>{const I=(l==null?void 0:l.constructor)===Uint8Array?l:new Uint8Array((l==null?void 0:l.buffer)??i*g);for(let U=0;U<i;U++){const O=U*y,N=U*g,z=D.subarray(O,O+g);I.set(z,N)}return l??I})}}class wG extends mC{constructor(e){super(xF)}unlock(e){const t=e.device;super.unlock(t,e.storageInt32.buffer)}}class RG extends mC{constructor(e,t,s){super(bF|(s!=null&&s.storage?K2:0))}unlock(e){const t=e.device;super.unlock(t,e.storage)}}const Wo=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,sR=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,YI=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,iR=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,aR=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,nR=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,KI=/\{?[\w-]+\}?/,MG=/(!|\s)?defined\(([\w-]+)\)/,DG=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,PG=/[+\-]/g,rR=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"\r?(?:\n|$)/g,LG=/\{i\}/g,QI=/(pcFragColor[1-8])\b/g;class _n{static run(e,t=new Map,s={}){_n.sourceName=s.sourceName,e=this.stripComments(e),e=e.split(/\r?\n/).map(r=>r.trimEnd()).join(`
`);const i=new Map,a=new Map;if(e=this._preprocess(e,i,a,t,s.stripDefines),e===null)return null;const n=new Map;return i.forEach((r,l)=>{Number.isInteger(parseFloat(r))&&!r.includes(".")&&n.set(l,r)}),e=this.stripComments(e),e=this.stripUnusedColorAttachments(e,s),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,n),e=this.injectDefines(e,a),e}static stripUnusedColorAttachments(e,t){if(t.stripUnusedColorAttachments){const s=new Map,i=e.match(QI);if(i==null||i.forEach(n=>{const r=parseInt(n.charAt(n.length-1),10);s.set(r,(s.get(r)??0)+1)}),Array.from(s.values()).some(n=>n===1)){const n=e.split(`
`),r=[];for(let l=0;l<n.length;l++){const u=n[l].match(QI);if(u){const f=parseInt(u[0].charAt(u[0].length-1),10);if(f>0&&s.get(f)===1)continue}r.push(n[l])}e=r.join(`
`)}}return e}static stripComments(e){return e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(e,t){return e!==null&&t.forEach((s,i)=>{e=e.replace(new RegExp(`\\[${i}\\]`,"g"),`[${s}]`)}),e}static injectDefines(e,t){if(e!==null&&t.size>0){const s=e.split(`
`);t.forEach((i,a)=>{const n=new RegExp(a,"g");for(let r=0;r<s.length;r++)s[r].includes("#")||(s[r]=s[r].replace(n,i))}),e=s.join(`
`)}return e}static RemoveEmptyLines(e){return e!==null&&(e=e.split(/\r?\n/).map(t=>t.trim()===""?"":t).join(`
`),e=e.replace(/(\n\n){3,}/g,`

`)),e}static _preprocess(e,t=new Map,s,i,a){var f;const n=e,r=[];let l=!1,u;for(;(u=Wo.exec(e))!==null&&!l;){const _=u[1];switch(_){case"define":{sR.lastIndex=u.index;const g=sR.exec(e);l||(l=g===null);const y=g[1];KI.lastIndex=g.index;const x=KI.exec(y)[0];let C=y.substring(x.length).trim();C===""&&(C="true");const M=_n._keep(r);let w=a;if(M){const T=x.startsWith("{")&&x.endsWith("}");T&&(w=!0),T?s.set(x,C):t.set(x,C),w&&(e=e.substring(0,g.index-1)+e.substring(sR.lastIndex),Wo.lastIndex=g.index-1)}w||(Wo.lastIndex=g.index+g[0].length);break}case"undef":{iR.lastIndex=u.index;const g=iR.exec(e),y=g[1].trim();_n._keep(r)&&(t.delete(y),a&&(e=e.substring(0,g.index-1)+e.substring(iR.lastIndex),Wo.lastIndex=g.index-1)),a||(Wo.lastIndex=g.index+g[0].length);break}case"extension":{YI.lastIndex=u.index;const g=YI.exec(e);if(l||(l=g===null),g){const y=g[1];_n._keep(r)&&t.set(y,"true")}Wo.lastIndex=g.index+g[0].length;break}case"ifdef":case"ifndef":case"if":{aR.lastIndex=u.index;const g=aR.exec(e),y=g[2],v=_n.evaluate(y,t);l||(l=v.error);let x=v.result;_==="ifndef"&&(x=!x),r.push({anyKeep:x,keep:x,start:u.index,end:aR.lastIndex}),Wo.lastIndex=g.index+g[0].length;break}case"endif":case"else":case"elif":{nR.lastIndex=u.index;const g=nR.exec(e),y=r.pop();if(!y){console.error(`Shader preprocessing encountered "#${g[1]}" without a preceding #if #ifdef #ifndef while preprocessing ${_n.sourceName} on line:
 ${e.substring(u.index,u.index+100)}...`,{source:n}),l=!0;continue}const v=y.keep?e.substring(y.end,u.index):"";e=e.substring(0,y.start)+v+e.substring(nR.lastIndex),Wo.lastIndex=y.start+v.length;const x=g[1];if(x==="else"||x==="elif"){let C=!1;if(!y.anyKeep)if(x==="else")C=!y.keep;else{const M=_n.evaluate(g[2],t);C=M.result,l||(l=M.error)}r.push({anyKeep:y.anyKeep||C,keep:C,start:Wo.lastIndex,end:Wo.lastIndex})}break}case"include":{rR.lastIndex=u.index;const g=rR.exec(e);if(l||(l=g===null),!g){l=!0;continue}const y=g[1].trim(),v=(f=g[2])==null?void 0:f.trim();if(_n._keep(r)){let C=i==null?void 0:i.get(y);if(C!==void 0){if(C=this.stripComments(C),v){const M=t.get(v),w=parseFloat(M);if(Number.isInteger(w)){let T="";for(let R=0;R<w;R++)T+=C.replace(LG,String(R));C=T}else console.error(`Include Count identifier "${v}" not resolved while preprocessing ${_n.sourceName} on line:
 ${e.substring(u.index,u.index+100)}...`,{source:n}),l=!0}e=e.substring(0,g.index-1)+C+e.substring(rR.lastIndex),Wo.lastIndex=g.index-1}else{console.error(`Include "${y}" not resolved while preprocessing ${_n.sourceName}`,{source:n}),l=!0;continue}}break}}}return r.length>0&&(console.error(`Shader preprocessing reached the end of the file without encountering the necessary #endif to close a preceding #if, #ifdef, or #ifndef block. ${_n.sourceName}`),l=!0),l?(console.error("Failed to preprocess shader: ",{source:n}),null):e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluateAtomicExpression(e,t){let s=!1;e=e.trim();let i=!1;const a=MG.exec(e);if(a){i=a[1]==="!",e=a[2].trim();const l=t.has(e);return{result:i?!l:l,error:s}}const n=DG.exec(e);if(n){const l=t.get(n[1].trim())??n[1].trim(),u=t.get(n[3].trim())??n[3].trim(),f=n[2].trim();let _=!1;switch(f){case"==":_=l===u;break;case"!=":_=l!==u;break;case"<":_=l<u;break;case"<=":_=l<=u;break;case">":_=l>u;break;case">=":_=l>=u;break;default:s=!0}return{result:_,error:s}}return{result:t.has(e),error:s}}static evaluate(e,t){const s=PG.exec(e)===null,i=e.split("||");for(const a of i){const n=a.split("&&");let r=!0;for(const l of n){const{result:u,error:f}=_n.evaluateAtomicExpression(l.trim(),t);if(!u||f){r=!1;break}}if(r)return{result:!0,error:!s}}return{result:!1,error:!s}}}var uB=`
#ifndef outType_0
#define outType_0 vec4
#endif
layout(location = 0) out highp outType_0 pcFragColor0;
#if COLOR_ATTACHMENT_1
layout(location = 1) out highp outType_1 pcFragColor1;
#endif
#if COLOR_ATTACHMENT_2
layout(location = 2) out highp outType_2 pcFragColor2;
#endif
#if COLOR_ATTACHMENT_3
layout(location = 3) out highp outType_3 pcFragColor3;
#endif
#if COLOR_ATTACHMENT_4
layout(location = 4) out highp outType_4 pcFragColor4;
#endif
#if COLOR_ATTACHMENT_5
layout(location = 5) out highp outType_5 pcFragColor5;
#endif
#if COLOR_ATTACHMENT_6
layout(location = 6) out highp outType_6 pcFragColor6;
#endif
#if COLOR_ATTACHMENT_7
layout(location = 7) out highp outType_7 pcFragColor7;
#endif
#define gl_FragColor pcFragColor0
#define varying in
#define texture2D texture
#define texture2DBias texture
#define textureCube texture
#define texture2DProj textureProj
#define texture2DLod textureLod
#define texture2DProjLod textureProjLod
#define textureCubeLod textureLod
#define texture2DGrad textureGrad
#define texture2DProjGrad textureProjGrad
#define textureCubeGrad textureGrad
#define utexture2D texture
#define itexture2D texture
#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead
#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod
#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead
#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead
#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead
#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead
#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))
#define SHADOWMAP_PASS(name) name
#define SHADOWMAP_ACCEPT(name) sampler2DShadow name
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name
#define GL2
`,dB=`
#define attribute in
#define varying out
#define texture2D texture
#define utexture2D texture
#define itexture2D texture
#define GL2
#define VERTEXSHADER
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name
`,fB=`
#extension GL_EXT_samplerless_texture_functions : require
#ifndef outType_0
#define outType_0 vec4
#endif
#ifndef outType_1
#define outType_1 vec4
#endif
#ifndef outType_2
#define outType_2 vec4
#endif
#ifndef outType_3
#define outType_3 vec4
#endif
#ifndef outType_4
#define outType_4 vec4
#endif
#ifndef outType_5
#define outType_5 vec4
#endif
#ifndef outType_6
#define outType_6 vec4
#endif
#ifndef outType_7
#define outType_7 vec4
#endif
layout(location = 0) out highp outType_0 pcFragColor0;
layout(location = 1) out highp outType_1 pcFragColor1;
layout(location = 2) out highp outType_2 pcFragColor2;
layout(location = 3) out highp outType_3 pcFragColor3;
layout(location = 4) out highp outType_4 pcFragColor4;
layout(location = 5) out highp outType_5 pcFragColor5;
layout(location = 6) out highp outType_6 pcFragColor6;
layout(location = 7) out highp outType_7 pcFragColor7;
#define gl_FragColor pcFragColor0
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)
#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)
#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)
#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)
#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead
#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod
#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead
#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead
#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead
#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead
#define SHADOWMAP_PASS(name) name, name ## _sampler
#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT
#define GL2
#define WEBGPU
`,pB=`
#extension GL_EXT_samplerless_texture_functions : require
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT
#define GL2
#define WEBGPU
#define VERTEXSHADER
#define gl_VertexID gl_VertexIndex
#define gl_InstanceID gl_InstanceIndex
`,IG=`
`,OG=`
#define VERTEXSHADER
`,$I=`
vec2 getGrabScreenPos(vec4 clipPos) {
	vec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
vec2 getImageEffectUV(vec2 uv) {
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
`,ZI=`
fn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {
	var uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);
	uv.y = 1.0 - uv.y;
	return uv;
}
fn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {
	var modifiedUV: vec2<f32> = uv;
	modifiedUV.y = 1.0 - modifiedUV.y;
	return modifiedUV;
}
struct WrappedF32 { @size(16) element: f32 }
struct WrappedI32 { @size(16) element: i32 }
struct WrappedU32 { @size(16) element: u32 }
struct WrappedVec2F { @size(16) element: vec2f }
struct WrappedVec2I { @size(16) element: vec2i }
struct WrappedVec2U { @size(16) element: vec2u }
`;const NG={vertex_position:kt,vertex_normal:$a,vertex_tangent:po,vertex_texCoord0:Za,vertex_texCoord1:Mh,vertex_texCoord2:Rm,vertex_texCoord3:Mm,vertex_texCoord4:Dm,vertex_texCoord5:Pm,vertex_texCoord6:Lm,vertex_texCoord7:Im,vertex_color:Qi,vertex_boneIndices:gn,vertex_boneWeights:co};class da{static createDefinition(e,t){const s=(f,_,g,y)=>{const v=e.isWebGPU?f:_;let x="";if(!g){let C=y.fragmentOutputTypes??"vec4";Array.isArray(C)||(C=[C]);for(let M=0;M<e.maxColorAttachments;M++){x+=`#define COLOR_ATTACHMENT_${M}
`;const w=C[M]??"vec4";x+=`#define outType_${M} ${w}
`}}return x+v},i=t.name??"Untitled";let a,n;const r=da.getDefinesCode(e,t.vertexDefines),l=da.getDefinesCode(e,t.fragmentDefines);return t.shaderLanguage===Ja?(a=`
								${OG}
								${ZI}
								${r}
								${t.vertexCode}
						`,n=`
								${IG}
								${ZI}
								${l}
								${t.fragmentCode}
						`):(a=`${da.versionCode(e)+s(pB,dB,!0,t)+r+da.precisionCode(e)}
								${$I}
								${da.getShaderNameCode(i)}
								${t.vertexCode}`,n=`${(t.fragmentPreamble||"")+da.versionCode(e)+s(fB,uB,!1,t)+l+da.precisionCode(e)}
								${$I}
								${da.getShaderNameCode(i)}
								${t.fragmentCode||da.dummyFragmentCode()}`),{name:i,shaderLanguage:t.shaderLanguage??Sr,attributes:t.attributes,vshader:a,vincludes:t.vertexIncludes,fincludes:t.fragmentIncludes,fshader:n,useTransformFeedback:t.useTransformFeedback,meshUniformBufferFormat:t.meshUniformBufferFormat,meshBindGroupFormat:t.meshBindGroupFormat}}static getDefinesCode(e,t){let s="";return e.capsDefines.forEach((i,a)=>{s+=`#define ${a} ${i}
`}),s+=`
`,t==null||t.forEach((i,a)=>{s+=`#define ${a} ${i}
`}),s+=`
`,s}static getShaderNameCode(e){return`#define SHADER_NAME ${e}
`}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(e){return e.isWebGPU?`#version 450
`:`#version 300 es
`}static precisionCode(e,t){t&&t!=="highp"&&t!=="mediump"&&t!=="lowp"&&(t=null),t&&(t==="highp"&&e.maxPrecision!=="highp"&&(t="mediump"),t==="mediump"&&e.maxPrecision==="lowp"&&(t="lowp"));const s=t||e.precision;return`
						precision ${s} float;
						precision ${s} int;
						precision ${s} usampler2D;
						precision ${s} isampler2D;
						precision ${s} sampler2DShadow;
						precision ${s} samplerCubeShadow;
						precision ${s} sampler2DArray;
				`}static collectAttributes(e){const t={};let s=0,i=e.indexOf("attribute");for(;i>=0&&!(i>0&&e[i-1]==="/");){let a=!1;if(i>0){let n=e.lastIndexOf(`
`,i);n=n!==-1?n+1:0,e.substring(n,i).includes("#")&&(a=!0)}if(!a){const n=e.indexOf(";",i),r=e.lastIndexOf(" ",n),l=e.substring(r+1,n);if(!t[l]){const u=NG[l];u!==void 0?t[l]=u:(t[l]=`ATTR${s}`,s++)}}i=e.indexOf("attribute",i+1)}return t}}let FG=0;class ef{constructor(e,t){if(this.attributes=new Map,this.id=FG++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),!t.cshader){const s=t.shaderLanguage===Ja;t.vshader=_n.run(t.vshader,t.vincludes,{sourceName:`vertex shader for ${this.label}`,stripDefines:s}),t.shaderLanguage===Sr&&(t.attributes??(t.attributes=da.collectAttributes(t.vshader)));const i=e.isWebGL2&&(Ct.name==="osx"||Ct.name==="ios");if(t.fshader=_n.run(t.fshader,t.fincludes,{stripUnusedColorAttachments:i,stripDefines:s,sourceName:`fragment shader for ${this.label}`}),!t.vshader||!t.fshader){this.failed=!0;return}}this.impl=e.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} (${this.definition.shaderLanguage===Ja?"WGSL":"GLSL"}) ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}class BG{}class UG{}class zG{constructor(e,t,s){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=s}destroy(){this.gpuBuffers.forEach(e=>{e.destroy(this.device)}),this.gpuBuffers=null,this.stagingBuffers.forEach(e=>{e.destroy(this.device)}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(e,t){if(this.activeBuffer){const a=ge.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-a<t&&this.scheduleSubmit()}if(!this.activeBuffer){let a=this.gpuBuffers.pop();a||(a=this.createBuffer(this.device,this.bufferSize,!1));let n=this.stagingBuffers.pop();n||(n=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new BG,this.activeBuffer.stagingBuffer=n,this.activeBuffer.gpuBuffer=a,this.activeBuffer.offset=0,this.activeBuffer.size=0}const s=this.activeBuffer,i=ge.roundUp(s.size,this.bufferAlignment);e.gpuBuffer=s.gpuBuffer,e.offset=i,e.storage=s.stagingBuffer.alloc(i,t),s.size=i+t}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}}const gs=[];gs[Vn]=function(h,e,t){const s=h.storageFloat32;s[t]=e};gs[zd]=(h,e,t)=>{const s=h.storageFloat32;s[t]=e[0],s[t+1]=e[1]};gs[Fn]=(h,e,t)=>{const s=h.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2]};gs[kd]=(h,e,t)=>{const s=h.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+3]=e[3]};gs[Ud]=function(h,e,t){const s=h.storageInt32;s[t]=e};gs[Rd]=function(h,e,t){const s=h.storageInt32;s[t]=e[0],s[t+1]=e[1]};gs[Md]=function(h,e,t){const s=h.storageInt32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2]};gs[Dd]=function(h,e,t){const s=h.storageInt32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+3]=e[3]};gs[Yb]=(h,e,t)=>{const s=h.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+4]=e[2],s[t+5]=e[3],s[t+8]=e[4],s[t+9]=e[5]};gs[A0]=(h,e,t)=>{const s=h.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+4]=e[3],s[t+5]=e[4],s[t+6]=e[5],s[t+8]=e[6],s[t+9]=e[7],s[t+10]=e[8]};gs[K1]=function(h,e,t,s){const i=h.storageFloat32;for(let a=0;a<s;a++)i[t+a*4]=e[a]};gs[Q1]=(h,e,t,s)=>{const i=h.storageFloat32;for(let a=0;a<s;a++)i[t+a*4]=e[a*2],i[t+a*4+1]=e[a*2+1]};gs[$1]=(h,e,t,s)=>{const i=h.storageFloat32;for(let a=0;a<s;a++)i[t+a*4]=e[a*3],i[t+a*4+1]=e[a*3+1],i[t+a*4+2]=e[a*3+2]};gs[am]=(h,e,t,s)=>{const i=h.storageUint32;i[t]=e};gs[nm]=(h,e,t,s)=>{const i=h.storageUint32;i[t]=e[0],i[t+1]=e[1]};gs[rm]=(h,e,t,s)=>{const i=h.storageUint32;i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2]};gs[om]=(h,e,t,s)=>{const i=h.storageUint32;i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2],i[t+3]=e[3]};gs[lm]=function(h,e,t,s){const i=h.storageInt32;for(let a=0;a<s;a++)i[t+a*4]=e[a]};gs[J1]=gs[lm];gs[Z1]=function(h,e,t,s){const i=h.storageUint32;for(let a=0;a<s;a++)i[t+a*4]=e[a]};gs[hm]=(h,e,t,s)=>{const i=h.storageInt32;for(let a=0;a<s;a++)i[t+a*4]=e[a*2],i[t+a*4+1]=e[a*2+1]};gs[tx]=gs[hm];gs[ex]=(h,e,t,s)=>{const i=h.storageUint32;for(let a=0;a<s;a++)i[t+a*4]=e[a*2],i[t+a*4+1]=e[a*2+1]};gs[cm]=(h,e,t,s)=>{const i=h.storageInt32;for(let a=0;a<s;a++)i[t+a*4]=e[a*3],i[t+a*4+1]=e[a*3+1],i[t+a*4+2]=e[a*3+2]};gs[ix]=gs[cm];gs[sx]=(h,e,t,s)=>{const i=h.storageUint32;for(let a=0;a<s;a++)i[t+a*4]=e[a*3],i[t+a*4+1]=e[a*3+1],i[t+a*4+2]=e[a*3+2]};class ox{constructor(e,t,s=!0){if(this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=s,s){this.impl=e.createUniformBufferImpl(this);const i=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(i)),e._vram.ub+=this.format.byteSize}else this.allocation=new UG}destroy(){if(this.persistent){const e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}loseContext(){var e;(e=this.impl)==null||e.loseContext()}setUniform(e,t){const s=e.offset;if(t!=null){const i=gs[e.updateType];i?i(this,t,s,e.count):this.storageFloat32.set(t,s)}}set(e,t){const s=this.format.map.get(e);s&&this.setUniform(s,t)}startUpdate(e){if(!this.persistent){const t=this.allocation,s=t.gpuBuffer;this.device.dynamicBuffers.alloc(t,this.format.byteSize),this.assignStorage(t.storage),e&&(e.bindGroup=t.gpuBuffer.getBindGroup(this),e.offsets[0]=t.offset),s!==t.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}update(e){this.startUpdate(e);const t=this.format.uniforms;for(let s=0;s<t.length;s++){const i=t[s].scopeId.value;this.setUniform(t[s],i)}this.endUpdate()}}const kG={type:hl,base:0,count:4,indexed:!1};class VG{constructor(e){const t=`

						struct ub_mesh {
								color : vec4f,
								depth: f32
						}

						@group(2) @binding(0) var<uniform> ubMesh : ub_mesh;

						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f
						}

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
								var output : VertexOutput;
								output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);
								return output;
						}

						@fragment
						fn fragmentMain() -> @location(0) vec4f {
								return ubMesh.color;
						}
				`;this.shader=new ef(e,{name:"WebGPUClearRendererShader",shaderLanguage:Ja,vshader:t,fshader:t}),this.uniformBuffer=new ox(e,new ey(e,[new ri("color",kd),new ri("depth",Vn)]),!1),this.dynamicBindGroup=new eP,this.colorData=new Float32Array(4)}destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null}clear(e,t,s,i){s=s||i;const a=s.flags??i.flags;if(a!==0){const{uniformBuffer:n,dynamicBindGroup:r}=this;if(n.startUpdate(r),e.setBindGroup(um,r.bindGroup,r.offsets),e.setBindGroup(Q0,e.emptyBindGroup),a&Jp&&(t.colorBuffer||t.impl.assignedColorTexture)){const l=s.color??i.color;this.colorData.set(l),e.setBlendState(ms.NOBLEND)}else e.setBlendState(ms.NOWRITE);if(n.set("color",this.colorData),a&em&&t.depth){const l=s.depth??i.depth;n.set("depth",l),e.setDepthState($i.WRITEDEPTH)}else n.set("depth",1),e.setDepthState($i.NODEPTH);a&_0&&t.stencil,n.endUpdate(),e.setCullMode(Xs),e.setShader(this.shader),e.draw(kG)}}}class GG{constructor(e){this.device=e;const t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
								@location(0) texCoord : vec2f
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var imgSampler : sampler;
						@group(0) @binding(1) var img : texture_2d<f32>;

						@fragment
						fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {
							return textureSample(img, imgSampler, texCoord);
						}
				`;this.shader=new ef(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:Ja,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"})}destroy(){this.shader.destroy(),this.shader=null}generate(e){const t=e.desc;if(t.mipLevelCount<=1||e.texture.volume)return;const s=this.device,i=s.wgpu,a=this.shader.impl,n=i.createRenderPipeline({layout:"auto",vertex:{module:a.getVertexShaderModule(),entryPoint:a.vertexEntryPoint},fragment:{module:a.getFragmentShaderModule(),entryPoint:a.fragmentEntryPoint,targets:[{format:t.format}]},primitive:{topology:"triangle-strip"}}),r=e.texture,l=r.cubemap?6:r.array?r.arrayLength:1,u=[];for(let _=0;_<l;_++)u.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:_}));const f=s.getCommandEncoder();for(let _=1;_<t.mipLevelCount;_++)for(let g=0;g<l;g++){const y=e.createView({dimension:"2d",baseMipLevel:_,mipLevelCount:1,baseArrayLayer:g}),v=f.beginRenderPass({colorAttachments:[{view:y,loadOp:"clear",storeOp:"store"}]}),x=i.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:u[g]}]});v.setPipeline(n),v.setBindGroup(0,x),v.draw(4),v.end(),u[g]=y}s.pipeline=null}}class HG{constructor(e){this.bindGroupCache=new Map,this.device=e,this.bindGroupFormat=new Nm(this.device,[new nx(ax,Vd|Gd)])}getBindGroup(e){const t=e.format.byteSize;let s=this.bindGroupCache.get(t);return s||(s=new $0(this.device,this.bindGroupFormat,e),s.update(),this.bindGroupCache.set(t,s)),s}}class WG extends HG{constructor(e,t,s){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),e._vram.ub+=t}destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}}class qG extends zG{createBuffer(e,t,s){return new WG(e,t,s)}submit(){super.submit();const e=this.usedBuffers.length;if(e){const t=this.device,s=this.gpuBuffers,i=t.wgpu.createCommandEncoder();for(let n=e-1;n>=0;n--){const r=this.usedBuffers[n],{stagingBuffer:l,gpuBuffer:u,offset:f,size:_}=r,g=l.buffer;g.unmap(),i.copyBufferToBuffer(g,f,u.buffer,f,_),s.push(u)}const a=i.finish();t.addCommandBuffer(a,!0);for(let n=0;n<e;n++){const r=this.usedBuffers[n].stagingBuffer;this.pendingStagingBuffers.push(r)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){const e=this.pendingStagingBuffers.length;if(e){for(let t=0;t<e;t++){const s=this.pendingStagingBuffers[t];s.buffer.mapAsync(GPUMapMode.WRITE).then(()=>{this.stagingBuffers&&(s.onAvailable(),this.stagingBuffers.push(s))})}this.pendingStagingBuffers.length=0}}constructor(...e){super(...e),this.pendingStagingBuffers=[]}}class mB{loseContext(){this.pastFrameAllocations.clear()}set enabled(e){this._enableRequest=e}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[]}report(e,t){if(t){const s=this.pastFrameAllocations.get(e);if(t.length>0&&(this._frameTime=t[0]),CA.get(tF)){let i=0;for(let a=0;a<s.length;++a)s[a],i+=t[a]}}this.pastFrameAllocations.delete(e)}getSlot(e){const t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}}class XG{constructor(e,t,s){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=e,this.capacity=s,this.bytesPerSlot=t?8:4;const i=e.wgpu;this.querySet=i.createQuerySet({type:t?"timestamp":"occlusion",count:s}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}destroy(){var e,t;(e=this.querySet)==null||e.destroy(),this.querySet=null,(t=this.queryBuffer)==null||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(s=>{s.destroy()}),this.stagingBuffers=null}getStagingBuffer(){let e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){const s=this.device.getCommandEncoder();s.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);const i=this.getStagingBuffer();this.activeStagingBuffer=i,s.copyBufferToBuffer(this.queryBuffer,0,i,0,this.bytesPerSlot*e)}request(e,t){const s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then(()=>{var n;const i=new BigInt64Array(s.getMappedRange()),a=[];for(let r=0;r<e;r++)a.push(Number(i[r*2+1]-i[r*2])*1e-6);return s.unmap(),(n=this.stagingBuffers)==null||n.push(s),{renderVersion:t,timings:a}})}}class jG extends mB{constructor(e){super(),this.device=e,this.timestampQueriesSet=e.supportsTimestampQuery?new XG(e,!0,512):null}destroy(){var e;(e=this.timestampQueriesSet)==null||e.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){var e;this._enabled&&((e=this.timestampQueriesSet)==null||e.resolve(this.slotCount*2))}request(){var e;if(this._enabled){const t=this.device.renderVersion;(e=this.timestampQueriesSet)==null||e.request(this.slotCount,t).then(s=>{this.report(s.renderVersion,s.timings)}),super.request(t)}}}class YG{constructor(e){this.pipelineCache=new Map,this.device=e;const t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var img : texture_depth_multisampled_2d;

						@fragment
						fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {
								// load th depth value from sample index 0
								var depth = textureLoad(img, vec2i(fragColor.xy), 0u);
								return vec4f(depth, 0.0, 0.0, 0.0);
						}
				`;this.shader=new ef(e,{name:"WebGPUResolverDepthShader",shaderLanguage:Ja,vshader:t,fshader:t})}destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(e){let t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){const t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,s){const i=this.device,a=i.wgpu,n=this.getPipeline(s.format),r=t.depthOrArrayLayers;for(let l=0;l<r;l++){const u=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l}),f=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l}),_=e.beginRenderPass({colorAttachments:[{view:f,loadOp:"clear",storeOp:"store"}]}),g=a.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:u}]});_.setPipeline(n),_.setBindGroup(0,g),_.draw(4),_.end()}i.pipeline=null}}class KG{constructor(e){this.uniformBuffers=[],this.bindGroup=null,this.compute=e;const{device:t,shader:s}=e,{computeBindGroupFormat:i,computeUniformBufferFormats:a}=s.impl;if(this.bindGroup=new $0(t,i),a){for(const n in a)if(a.hasOwnProperty(n)){const r=new ox(t,a[n],!0);this.uniformBuffers.push(r),this.bindGroup.setUniformBuffer(n,r)}}this.pipeline=t.computePipeline.get(s,i)}destroy(){this.uniformBuffers.forEach(e=>e.destroy()),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null}updateBindGroup(){const{bindGroup:e}=this;e.updateUniformBuffers(),e.update()}dispatch(e,t,s){const i=this.compute.device;i.setBindGroup(0,this.bindGroup);const a=i.passEncoder;a.setPipeline(this.pipeline),a.dispatchWorkgroups(e,t,s)}}const oR=new Map;class _B extends _s{constructor(e,t={}){super(e,t),this.renderPipeline=new KV(this),this.computePipeline=new QV(this),this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],t=this.initOptions,t.alpha=t.alpha??!0,this.backBufferAntialias=t.antialias??!1,this.isWebGPU=!0,this._deviceType=GD,this.scope.resolve(fC).setValue(0)}destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){var s;const e=(s=this.wgpu)==null?void 0:s.limits;this.limits=e,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=e.maxTextureDimension2D,this.maxCubeMapSize=e.maxTextureDimension2D,this.maxVolumeSize=e.maxTextureDimension3D,this.maxColorAttachments=e.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=e.maxUniformBufferBindingSize/16,this.vertexUniformsCount=e.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=!0,this.supportsAreaLights=!0,this.supportsGpuParticles=!0,this.supportsCompute=!0,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0,this.samples=this.backBufferAntialias?4:1;const t=navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=t==null?void 0:t.has("readonly_and_readwrite_storage_textures"),this.initCapsDefines()}async initWebGpu(e,t){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");const s=a=>new URL(a,window.location.href).toString(),i=await Promise.all([RI(()=>import(`${s(t)}`),[]).then(a=>twgsl(t.replace(".js",".wasm"))),RI(()=>import(`${s(e)}`),[]).then(a=>a.default())]);return this.twgsl=i[0],this.glslang=i[1],this.createDevice()}async createDevice(){var f,_;const e={powerPreference:this.initOptions.powerPreference!=="default"?this.initOptions.powerPreference:void 0};this.gpuAdapter=await window.navigator.gpu.requestAdapter(e);const t=[],s=g=>{const y=this.gpuAdapter.features.has(g);return y&&t.push(g),y};this.textureFloatFilterable=s("float32-filterable"),this.textureFloatBlendable=s("float32-blendable"),this.extCompressedTextureS3TC=s("texture-compression-bc"),this.extCompressedTextureETC=s("texture-compression-etc2"),this.extCompressedTextureASTC=s("texture-compression-astc"),this.supportsTimestampQuery=s("timestamp-query"),this.supportsDepthClip=s("depth-clip-control"),this.supportsDepth32Stencil=s("depth32float-stencil8"),this.supportsIndirectFirstInstance=s("indirect-first-instance"),this.supportsShaderF16=s("shader-f16"),this.supportsStorageRGBA8=s("bgra8unorm-storage"),this.textureRG11B10Renderable=s("rg11b10ufloat-renderable"),this.supportsClipDistances=s("clip-distances");const i=(f=this.gpuAdapter)==null?void 0:f.limits,a={};if(i)for(const g in i)g==="minSubgroupSize"||g==="maxSubgroupSize"||(a[g]=i[g]);const n={requiredFeatures:t,requiredLimits:a,defaultQueue:{label:"Default Queue"}};this.wgpu=await this.gpuAdapter.requestDevice(n),(_=this.wgpu.lost)==null||_.then(this.handleDeviceLost.bind(this)),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");let r="standard",l=navigator.gpu.getPreferredCanvasFormat();const u=this.initOptions.displayFormat;if(this.backBufferFormat=l==="rgba8unorm"?u===sb?ki:Lt:u===sb?W1:D1,this.backBufferViewFormat=u===sb?`${l}-srgb`:l,u===tB&&this.textureFloatFilterable){const g=window.matchMedia("(dynamic-range: high)");g!=null&&g.matches&&(this.backBufferFormat=Js,this.backBufferViewFormat="rgba16float",l="rgba16float",this.isHdr=!0,r="extended")}return this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:l,toneMapping:{mode:r},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:u===sb?[this.backBufferViewFormat]:[]},this.gpuContext.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new VG(this),this.mipmapRenderer=new GG(this),this.resolver=new YG(this),this.postInit(),this}async handleDeviceLost(e){e.reason!=="destroyed"&&(super.loseContext(),await this.createDevice(),super.restoreContext())}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new jG(this),this.dynamicBuffers=new qG(this,100*1024,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new $0(this,new Nm(this,[])),this.emptyBindGroup.update()}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new fs({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=!0}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();const e=this.gpuContext.getCurrentTexture();(this.backBufferSize.x!==e.width||this.backBufferSize.y!==e.height)&&(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());const t=this.backBuffer,s=t.impl;s.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(t),s.assignColorTexture(this,e)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request()}createBufferImpl(e){return new mC(e)}createUniformBufferImpl(e){return new wG(e)}createVertexBufferImpl(e,t,s){return new RG(e,t,s)}createIndexBufferImpl(e,t){return new GV(e,t)}createShaderImpl(e){return new EG(e)}createTextureImpl(e){return new CG(e)}createRenderTargetImpl(e){return new iG(e)}createBindGroupFormatImpl(e){return new VV(e)}createBindGroupImpl(e){return new zV}createComputeImpl(e){return new KG(e)}setBindGroup(e,t,s){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,s??t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl)}submitVertexBuffer(e,t){const s=e.format,{interleaved:i,elements:a}=s,n=a.length,r=e.impl.buffer;if(i)return this.passEncoder.setVertexBuffer(t,r),1;for(let l=0;l<n;l++)this.passEncoder.setVertexBuffer(t+l,r,a[l].offset);return n}validateVBLocations(e,t){const s=i=>{const{elements:a}=i.format;for(let n=0;n<a.length;n++){const r=a[n].name,l=Bt[r];oR.has(l),oR.set(l,r)}};s(e),s(t),oR.clear()}draw(e,t=1,s){if(this.shader.ready&&!this.shader.failed){const i=this.passEncoder,a=this.vertexBuffers[0],n=this.vertexBuffers[1];if(a){const u=this.submitVertexBuffer(a,0);n&&this.submitVertexBuffer(n,u)}const r=this.indexBuffer,l=this.renderPipeline.get(e,a==null?void 0:a.format,n==null?void 0:n.format,r==null?void 0:r.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack);this.pipeline!==l&&(this.pipeline=l,i.setPipeline(l)),r?(i.setIndexBuffer(r.impl.buffer,r.impl.format),i.drawIndexed(e.count,t,e.base,0,0)):i.draw(e.count,t,e.base,0)}this.vertexBuffers.length=0,this.indexBuffer=null}setShader(e,t=!1){e!==this.shader&&(this.shader=e)}setBlendState(e){this.blendState.copy(e)}setDepthState(e){this.depthState.copy(e)}setStencilState(e,t){if(e||t){this.stencilEnabled=!0,this.stencilFront.copy(e??pr.DEFAULT),this.stencilBack.copy(t??pr.DEFAULT);const s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s))}else this.stencilEnabled=!1}setBlendColor(e,t,s,i){const a=this.blendColor;(e!==a.r||t!==a.g||s!==a.b||i!==a.a)&&(a.set(e,t,s,i),this.passEncoder.setBlendConstant(a))}setCullMode(e){this.cullMode=e}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach(e=>{(e._needsUpload||e._needsMipmaps)&&e.upload()})}setupTimeStampWrites(e,t){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){const s=this.gpuProfiler.getSlot(t);e=e??{},e.timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:s*2,endOfPassWriteIndex:s*2+1}}return e}startRenderPass(e){this._uploadDirtyTextures();const t=e.renderTarget||this.backBuffer;this.renderTarget=t;const s=t.impl;t!==this.backBuffer&&this.initRenderTarget(t),s.setupForRenderPass(e,t);const i=s.renderPassDescriptor;this.setupTimeStampWrites(i,e.name);const a=this.getCommandEncoder();this.passEncoder=a.beginRenderPass(i),this.passEncoder.label=`${e.name}-PassEncoder RT:${t.name}`,this.setupPassEncoderDefaults();const{width:n,height:r}=t;this.setViewport(0,0,n,r),this.setScissor(0,0,n,r),this.insideRenderPass=!0}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;const t=this.renderTarget;if(t&&t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve){const s=t.impl.depthAttachment,i=t.depthBuffer.impl.gpuTexture;s&&i&&this.resolver.resolveDepth(this.commandEncoder,s.multisampledDepthBuffer,i)}for(let s=0;s<e.colorArrayOps.length;s++)e.colorArrayOps[s].genMipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[s].impl)}startComputePass(e){this.pipeline=null;const t=this.setupTimeStampWrites(void 0,e),s=this.getCommandEncoder();this.passEncoder=s.beginComputePass(t),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0}computeDispatch(e,t="Unnamed"){this.startComputePass(t);for(let s=0;s<e.length;s++){const i=e[s];i.applyParameters(),i.impl.updateBindGroup()}for(let s=0;s<e.length;s++){const i=e[s];i.impl.dispatch(i.countX,i.countY,i.countZ)}this.endComputePass()}getCommandEncoder(){let e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e}endCommandEncoder(){const{commandEncoder:e}=this;if(e){const t=e.finish();this.addCommandBuffer(t),this.commandEncoder=null}}addCommandBuffer(e,t=!1){t?this.commandBuffers.unshift(e):this.commandBuffers.push(e)}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions)}setViewport(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.vx=e,this.vy=t,this.vw=s,this.vh=i,this.passEncoder.setViewport(e,t,s,i,0,1))}setScissor(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.sx=e,this.sy=t,this.sw=s,this.sh=i,this.passEncoder.setScissorRect(e,t,s,i))}clearStorageBuffer(e,t=0,s=e.byteSize){this.getCommandEncoder().clearBuffer(e.buffer,t,s)}readStorageBuffer(e,t=0,s=e.byteSize-t,i=null,a=!1){const n=this.createBufferImpl(wD|RD);n.allocate(this,s);const r=n.buffer;return this.getCommandEncoder().copyBufferToBuffer(e.buffer,t,r,0,s),this.readBuffer(n,s,i,a)}readBuffer(e,t,s=null,i=!1){const a=e.buffer;return new Promise((n,r)=>{const l=()=>{a==null||a.mapAsync(GPUMapMode.READ).then(()=>{s??(s=new Uint8Array(t));const u=a.getMappedRange(0,t),f=s.constructor;s.set(new f(u)),a.unmap(),e.destroy(this),n(s)})};i?(this.submit(),l()):setTimeout(()=>{l()})})}writeStorageBuffer(e,t=0,s,i=0,a){this.wgpu.queue.writeBuffer(e.buffer,t,s,i,a)}copyRenderTarget(e,t,s,i){const a={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},n=this.getCommandEncoder();if(s){const r={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},l={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};n.copyTextureToTexture(r,l,a)}if(i){const l=(e||this.renderTarget).impl.depthAttachment.depthTexture;if(e.samples>1){const u=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(n,l,u)}else{const u=t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture,f={texture:l,mipLevel:0},_={texture:u,mipLevel:0};n.copyTextureToTexture(f,_,a)}}return!0}}class gB{destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(e,t,s,i){const a=e.gl;if(this.bufferId)a.bindBuffer(s,this.bufferId),a.bufferSubData(s,0,i);else{let n;switch(t){case _r:n=a.STATIC_DRAW;break;case Ob:n=a.DYNAMIC_DRAW;break;case MD:n=a.STREAM_DRAW;break;case wA:n=a.DYNAMIC_COPY;break}this.bufferId=a.createBuffer(),a.bindBuffer(s,this.bufferId),a.bufferData(s,i,n)}}constructor(){this.bufferId=null}}class QG extends gB{destroy(e){super.destroy(e),e.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage)}constructor(...e){super(...e),this.vao=null}}class $G extends gB{constructor(e){super();const t=e.device.gl,s=e.format;s===Bb?this.glFormat=t.UNSIGNED_BYTE:s===ho?this.glFormat=t.UNSIGNED_SHORT:s===Th&&(this.glFormat=t.UNSIGNED_INT)}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage)}}class ZG{constructor(e,t,s,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new rB,t.substring(t.length-3)==="[0]")switch(s){case Vn:s=K1;break;case Ud:s=lm;break;case am:s=Z1;break;case Wp:s=J1;break;case zd:s=Q1;break;case Rd:s=hm;break;case nm:s=ex;break;case x0:s=tx;break;case Fn:s=$1;break;case Md:s=cm;break;case rm:s=sx;break;case T0:s=ix;break;case kd:s=cC;break;case Dd:s=Kb;break;case om:s=uC;break;case E0:s=dC;break}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}const JG=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class e7{destroy(e){this.map.forEach(t=>{e.gl.deleteShader(t)})}loseContext(e){this.map.clear()}constructor(){this.map=new Map}}const t7=new Xn,s7=new Xn;class i7{constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e)}destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(e,t){this.compile(e,t),this.link(e,t)}compile(e,t){const s=t.definition;this.glVertexShader=this._compileShaderSource(e,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(e,s.fshader,!1)}link(e,t){if(this.glProgram)return;const s=e.gl;if(s.isContextLost())return;const i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);const a=t.definition,n=a.attributes;if(a.useTransformFeedback){const r=[];for(const l in n)n.hasOwnProperty(l)&&r.push(`out_${l}`);s.transformFeedbackVaryings(i,r,s.INTERLEAVED_ATTRIBS)}for(const r in n)if(n.hasOwnProperty(r)){const l=n[r],u=Bt[l];s.bindAttribLocation(i,u,r)}s.linkProgram(i)}_compileShaderSource(e,t,s){const i=e.gl;if(i.isContextLost())return null;const n=(s?t7:s7).get(e,()=>new e7);let r=n.map.get(t);return r||(r=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(r,t),i.compileShader(r),n.map.set(t,r)),r}finalize(e,t){const s=e.gl;if(s.isContextLost())return!0;const i=this.glProgram,a=t.definition;if(!s.getProgramParameter(i,s.LINK_STATUS)){if(!this._isCompiled(e,t,this.glVertexShader,a.vshader,"vertex")||!this._isCompiled(e,t,this.glFragmentShader,a.fshader,"fragment"))return!1;const f=`Failed to link shader program. Error: ${s.getProgramInfoLog(i)}`;return console.error(f),!1}const r=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);t.attributes.clear();for(let f=0;f<r;f++){const _=s.getActiveAttrib(i,f),g=s.getAttribLocation(i,_.name);JG.has(_.name)||(a.attributes[_.name]===void 0?(console.error(`Vertex shader attribute "${_.name}" is not mapped to a semantic in shader definition, shader [${t.label}]`,t),t.failed=!0):t.attributes.set(g,_.name))}const l=e._samplerTypes,u=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(let f=0;f<u;f++){const _=s.getActiveUniform(i,f),g=s.getUniformLocation(i,_.name),y=new ZG(e,_.name,e.pcUniformType[_.type],g);l.has(_.type)?this.samplers.push(y):this.uniforms.push(y)}return t.ready=!0,!0}_isCompiled(e,t,s,i,a){const n=e.gl;if(!n.getShaderParameter(s,n.COMPILE_STATUS)){const r=n.getShaderInfoLog(s),[l,u]=this._processError(i,r),f=`Failed to compile ${a} shader:

${r}
${l} while rendering undefined`;return console.error(f),!1}return!0}isLinked(e){const{extParallelShaderCompile:t}=e;return t?e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR):!0}_processError(e,t){const s={};let i="";if(e){const a=e.split(`
`);let n=0,r=a.length;if(t&&t.startsWith("ERROR:")){const l=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);l&&(s.message=l[3],s.line=parseInt(l[2],10),n=Math.max(0,s.line-6),r=Math.min(a.length,s.line+5))}for(let l=n;l<r;l++){const u=l+1===s.line?"> ":"  ";i+=`${u}${l+1}:	${a[l]}
`}s.source=e}return[i,s]}}function JI(h,e){const t=h.width,s=h.height;if(t>e||s>e){const i=e/Math.max(t,s),a=Math.floor(t*i),n=Math.floor(s*i),r=document.createElement("canvas");return r.width=a,r.height=n,r.getContext("2d").drawImage(h,0,0,t,s,0,0,a,n),r}return h}class a7{constructor(e){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=e}destroy(e){if(this._glTexture){for(let t=0;t<e.textureUnits.length;t++){const s=e.textureUnits[t];for(let i=0;i<s.length;i++)s[i]===this._glTexture&&(s[i]=null)}e.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(e){this.dirtyParameterFlags|=e}initialize(e,t){const s=e.gl;switch(this._glTexture=s.createTexture(),this._glTarget=t._cubemap?s.TEXTURE_CUBE_MAP:t._volume?s.TEXTURE_3D:t.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,t._format){case Q2:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case $2:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case B0:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case wm:this._glFormat=s.RED,this._glInternalFormat=s.R8,this._glPixelType=s.UNSIGNED_BYTE;break;case j0:this._glFormat=s.RG,this._glInternalFormat=s.RG8,this._glPixelType=s.UNSIGNED_BYTE;break;case xm:this._glFormat=s.RGB,this._glInternalFormat=s.RGB565,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case U0:this._glFormat=s.RGBA,this._glInternalFormat=s.RGB5_A1,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case Tm:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA4,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case pl:this._glFormat=s.RGB,this._glInternalFormat=s.RGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case Lt:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA8,this._glPixelType=s.UNSIGNED_BYTE;break;case D1:case W1:break;case z0:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case C1:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Em:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case G0:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case Am:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case Cm:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case H0:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case W0:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case R1:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case M1:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case Z2:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case J2:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case eC:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case aC:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case nC:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case rC:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case Ub:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case zb:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case kb:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case Vb:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case Gb:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case Hb:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case Wb:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case X0:this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT;break;case H1:this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT;break;case k0:this._glFormat=s.RGB,this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT;break;case Js:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT;break;case w1:this._glFormat=s.RGB,this._glInternalFormat=s.RGB32F,this._glPixelType=s.FLOAT;break;case Ri:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA32F,this._glPixelType=s.FLOAT;break;case gr:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case il:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT;break;case Cd:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT16,this._glPixelType=s.UNSIGNED_SHORT;break;case Fd:this._glFormat=s.DEPTH_STENCIL,this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8;break;case Yc:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case V0:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case ki:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case P1:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case tC:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case L1:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case I1:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case O1:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case Jd:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case N1:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case sC:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case F1:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case B1:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case U1:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case z1:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case k1:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case iC:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case V1:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case q0:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case G1:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case kn:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT;break}this._glCreated=!1}upload(e,t){const s=e.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let i=0,a,n;const r=t.numLevels;for(t.array&&s.texStorage3D(s.TEXTURE_2D_ARRAY,r,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[i]||i===0;){if(!t._needsUpload&&i===0){i++;continue}else if(i&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(a=t._levels[i],n=1/Math.pow(2,i),i===1&&!t._compressed&&!t._integerFormat&&t._levels.length<r&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){let l;if(e._isBrowserInterface(a[0]))for(l=0;l<6;l++){if(!t._levelsUpdated[0][l])continue;let u=a[l];e._isImageBrowserInterface(u)&&(u.width>e.maxCubeMapSize||u.height>e.maxCubeMapSize)&&(u=JI(u,e.maxCubeMapSize),i===0&&(t._width=u.width,t._height=u.height)),e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,this._glFormat,this._glPixelType,u):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,this._glFormat,this._glPixelType,u)}else for(n=1/Math.pow(2,i),l=0;l<6;l++){if(!t._levelsUpdated[0][l])continue;const u=a[l];t._compressed?this._glCreated&&u?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glInternalFormat,u):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,u):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&u?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glFormat,this._glPixelType,u):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,u))}}else if(t._volume)t._compressed?s.compressedTexImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,a):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,this._glFormat,this._glPixelType,a));else if(t.array&&typeof a=="object"){if(t._arrayLength===a.length)if(t._compressed)for(let l=0;l<t._arrayLength;l++)s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,i,0,0,l,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),1,this._glInternalFormat,a[l]);else for(let l=0;l<t._arrayLength;l++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,i,0,0,l,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),1,this._glFormat,this._glPixelType,a[l])}else{if(e._isBrowserInterface(a)){e._isImageBrowserInterface(a)&&(a.width>e.maxTextureSize||a.height>e.maxTextureSize)&&(a=JI(a,e.maxTextureSize),i===0&&(t._width=a.width,t._height=a.height));const l=a.width||a.videoWidth,u=a.height||a.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===l&&t._height===u&&!e._isImageVideoInterface(a)?s.texSubImage2D(s.TEXTURE_2D,i,0,0,this._glFormat,this._glPixelType,a):(s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,this._glFormat,this._glPixelType,a),i===0&&(t._width=l,t._height=u))}else n=1/Math.pow(2,i),t._compressed?this._glCreated&&a?s.compressedTexSubImage2D(s.TEXTURE_2D,i,0,0,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),this._glInternalFormat,a):s.compressedTexImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),0,a):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&a?s.texSubImage2D(s.TEXTURE_2D,i,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glFormat,this._glPixelType,a):s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,a));i===0?t._mipmapsUploaded=!1:t._mipmapsUploaded=!0}i++}if(t._needsUpload)if(t._cubemap)for(let l=0;l<6;l++)t._levelsUpdated[0][l]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&t._levels.length===1&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=!0}read(e,t,s,i,a){const n=this.texture;return n.device.readTextureAsync(n,e,t,s,i,a)}}class n7{constructor(e,t){this.msaaFB=e,this.resolveFB=t}destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}}class r7{destroy(e){var s;const t=e.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&t.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(t.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&t.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(i=>{t.deleteRenderbuffer(i)}),this._glMsaaColorBuffers.length=0,(s=this.colorMrtFramebuffers)==null||s.forEach(i=>{i.destroy(t)}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&cb(e).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(e,t){var a,n;const s=e.gl;this._isInitialized=!0;const i=[];if(this.suppliedColorFramebuffer!==void 0)this._glFrameBuffer=this.suppliedColorFramebuffer;else{this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const r=((a=t._colorBuffers)==null?void 0:a.length)??0,l=s.COLOR_ATTACHMENT0;for(let f=0;f<r;++f){const _=t.getColorBuffer(f);_&&(_.impl._glTexture||(_._width=Math.min(_.width,e.maxRenderBufferSize),_._height=Math.min(_.height,e.maxRenderBufferSize),e.setTexture(_,0)),s.framebufferTexture2D(s.FRAMEBUFFER,l+f,_._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,_.impl._glTexture,t.mipLevel),i.push(l+f))}s.drawBuffers(i);const u=t._depthBuffer;if(u||t._depth){const f=t._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;if(u)u.impl._glTexture||(u._width=Math.min(u.width,e.maxRenderBufferSize),u._height=Math.min(u.height,e.maxRenderBufferSize),e.setTexture(u,0)),s.framebufferTexture2D(s.FRAMEBUFFER,f,u._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,t.mipLevel);else if(!(t._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer());const g=t._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F;s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),s.renderbufferStorage(s.RENDERBUFFER,g,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,f,s.RENDERBUFFER,this._glDepthBuffer),s.bindRenderbuffer(s.RENDERBUFFER,null)}}}if(t._samples>1){this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const r=((n=t._colorBuffers)==null?void 0:n.length)??0;if(this.suppliedColorFramebuffer!==void 0){const l=s.createRenderbuffer();this._glMsaaColorBuffers.push(l);const u=e.backBufferFormat===Lt?s.RGBA8:s.RGB8;s.bindRenderbuffer(s.RENDERBUFFER,l),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,u,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,l)}else for(let l=0;l<r;++l){const u=t.getColorBuffer(l);if(u){const f=s.createRenderbuffer();this._glMsaaColorBuffers.push(f),s.bindRenderbuffer(s.RENDERBUFFER,f),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,u.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+l,s.RENDERBUFFER,f)}}if(t._depth){const l=t._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F,u=t._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;let f;const _=t._depthBuffer;_&&(f=`${_.id}:${t.width}:${t.height}:${t._samples}:${l}:${u}`,this._glMsaaDepthBuffer=cb(e).get(f)),this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,l,t.width,t.height),this._glMsaaDepthBuffer.destroy=function(){s.deleteRenderbuffer(this)},_&&cb(e).set(f,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=f,s.framebufferRenderbuffer(s.FRAMEBUFFER,u,s.RENDERBUFFER,this._glMsaaDepthBuffer)}r>1&&(this._createMsaaMrtFramebuffers(e,t,r),e.setFramebuffer(this._glFrameBuffer),s.drawBuffers(i))}}_createMsaaMrtFramebuffers(e,t,s){const i=e.gl;this.colorMrtFramebuffers=[];for(let a=0;a<s;++a){const n=t.getColorBuffer(a),r=i.createFramebuffer();e.setFramebuffer(r);const l=this._glMsaaColorBuffers[a];i.bindRenderbuffer(i.RENDERBUFFER,l),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,n.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,l),i.drawBuffers([i.COLOR_ATTACHMENT0]);const u=i.createFramebuffer();e.setFramebuffer(u),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,n._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,n.impl._glTexture,0),this.colorMrtFramebuffers[a]=new n7(r,u)}}_checkFbo(e,t,s=""){const i=e.gl;switch(i.checkFramebufferStatus(i.FRAMEBUFFER)){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:break;case i.FRAMEBUFFER_UNSUPPORTED:break}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(e,t,s,i,a){e.setScissor(0,0,i.width,i.height);const n=e.gl;n.bindFramebuffer(n.READ_FRAMEBUFFER,t),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,s),n.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,a,n.NEAREST)}resolve(e,t,s,i){const a=e.gl;if(this.colorMrtFramebuffers){if(s)for(let n=0;n<this.colorMrtFramebuffers.length;n++){const r=this.colorMrtFramebuffers[n];this.internalResolve(e,r.msaaFB,r.resolveFB,t,a.COLOR_BUFFER_BIT)}i&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,a.DEPTH_BUFFER_BIT)}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(s?a.COLOR_BUFFER_BIT:0)|(i?a.DEPTH_BUFFER_BIT:0));a.bindFramebuffer(a.FRAMEBUFFER,this._glFrameBuffer)}constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=!1}}class o7{destroy(e){this.queries.forEach(t=>e.deleteQuery(t)),this.queries=null}constructor(){this.queries=[]}}class l7 extends mB{constructor(e){super(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery}destroy(){this.freeQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.frameQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.previousFrameQueries.forEach(e=>e.destroy(this.device.gl)),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){return this.freeQueries.pop()??this.device.gl.createQuery()}start(e){if(this.ext){const t=this.getSlot(e),s=this.getQuery();return this.frameQueries[t]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),t}}end(e){e!==void 0&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){const e=this.ext,t=this.device.gl,s=this.device.renderVersion,i=this.frameQueries;if(i.length>0){this.frameQueries=[];const a=new o7;a.queries=i,a.renderVersion=s,this.previousFrameQueries.push(a)}if(this.previousFrameQueries.length>0){const a=this.previousFrameQueries[0],n=a.queries,r=n[n.length-1],l=t.getQueryParameter(r,t.QUERY_RESULT_AVAILABLE),u=t.getParameter(e.GPU_DISJOINT_EXT);if(l&&!u){this.previousFrameQueries.shift();const f=this.timings;f.length=0;for(let _=0;_<n.length;_++){const g=n[_],y=t.getQueryParameter(g,t.QUERY_RESULT);f[_]=y*1e-6,this.freeQueries.push(g)}this.report(a.renderVersion,f)}u&&(this.previousFrameQueries.forEach(f=>{this.report(f.renderVersion,null),f.destroy(t)}),this.previousFrameQueries.length=0)}super.request(s)}}}const ag=[];class sP extends _s{constructor(e,t={}){super(e,t),this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=y=>{y.preventDefault(),this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored")};const s=typeof navigator<"u"&&navigator.userAgent;if(this.forceDisableMultisampling=s&&s.includes("AppleWebKit")&&(s.includes("15.4")||s.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=!1),Ct.browserName==="firefox"){const v=(typeof navigator<"u"?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),x=v?v[1]:null;if(x){const C=parseFloat(x);(Ct.name==="windows"&&(C>=120||C===115)||Ct.name==="android"&&C>=132)&&(t.antialias=!1)}}this.backBufferAntialias=t.antialias??!1,t.antialias=!1;const i=t.gl??e.getContext("webgl2",t);if(!i)throw new Error("WebGL not supported");this.gl=i,this.isWebGL2=!0,this._deviceType=lb,this.updateBackbufferFormat(null);const a=Ct.browserName==="chrome",n=Ct.browserName==="safari",r=Ct.browser&&navigator.appVersion.indexOf("Mac")!==-1;this._tempEnableSafariTextureUnitWorkaround=n,this._tempMacChromeBlitFramebufferWorkaround=r&&a&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!n&&typeof ImageBitmap<"u",this._samplerTypes=new Set([i.SAMPLER_2D,i.SAMPLER_CUBE,i.UNSIGNED_INT_SAMPLER_2D,i.INT_SAMPLER_2D,i.SAMPLER_2D_SHADOW,i.SAMPLER_CUBE_SHADOW,i.SAMPLER_3D,i.INT_SAMPLER_3D,i.UNSIGNED_INT_SAMPLER_3D,i.SAMPLER_2D_ARRAY,i.INT_SAMPLER_2D_ARRAY,i.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[i.REPEAT,i.CLAMP_TO_EDGE,i.MIRRORED_REPEAT],this.glBlendEquation=[i.FUNC_ADD,i.FUNC_SUBTRACT,i.FUNC_REVERSE_SUBTRACT,i.MIN,i.MAX],this.glBlendFunctionColor=[i.ZERO,i.ONE,i.SRC_COLOR,i.ONE_MINUS_SRC_COLOR,i.DST_COLOR,i.ONE_MINUS_DST_COLOR,i.SRC_ALPHA,i.SRC_ALPHA_SATURATE,i.ONE_MINUS_SRC_ALPHA,i.DST_ALPHA,i.ONE_MINUS_DST_ALPHA,i.CONSTANT_COLOR,i.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[i.ZERO,i.ONE,i.SRC_COLOR,i.ONE_MINUS_SRC_COLOR,i.DST_COLOR,i.ONE_MINUS_DST_COLOR,i.SRC_ALPHA,i.SRC_ALPHA_SATURATE,i.ONE_MINUS_SRC_ALPHA,i.DST_ALPHA,i.ONE_MINUS_DST_ALPHA,i.CONSTANT_ALPHA,i.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[i.NEVER,i.LESS,i.EQUAL,i.LEQUAL,i.GREATER,i.NOTEQUAL,i.GEQUAL,i.ALWAYS],this.glStencilOp=[i.KEEP,i.ZERO,i.REPLACE,i.INCR,i.INCR_WRAP,i.DECR,i.DECR_WRAP,i.INVERT],this.glClearFlag=[0,i.COLOR_BUFFER_BIT,i.DEPTH_BUFFER_BIT,i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT,i.STENCIL_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.COLOR_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.DEPTH_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT],this.glCull=[0,i.BACK,i.FRONT,i.FRONT_AND_BACK],this.glFilter=[i.NEAREST,i.LINEAR,i.NEAREST_MIPMAP_NEAREST,i.NEAREST_MIPMAP_LINEAR,i.LINEAR_MIPMAP_NEAREST,i.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[i.POINTS,i.LINES,i.LINE_LOOP,i.LINE_STRIP,i.TRIANGLES,i.TRIANGLE_STRIP,i.TRIANGLE_FAN],this.glType=[i.BYTE,i.UNSIGNED_BYTE,i.SHORT,i.UNSIGNED_SHORT,i.INT,i.UNSIGNED_INT,i.FLOAT,i.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[i.BOOL]=Wp,this.pcUniformType[i.INT]=Ud,this.pcUniformType[i.FLOAT]=Vn,this.pcUniformType[i.FLOAT_VEC2]=zd,this.pcUniformType[i.FLOAT_VEC3]=Fn,this.pcUniformType[i.FLOAT_VEC4]=kd,this.pcUniformType[i.INT_VEC2]=Rd,this.pcUniformType[i.INT_VEC3]=Md,this.pcUniformType[i.INT_VEC4]=Dd,this.pcUniformType[i.BOOL_VEC2]=x0,this.pcUniformType[i.BOOL_VEC3]=T0,this.pcUniformType[i.BOOL_VEC4]=E0,this.pcUniformType[i.FLOAT_MAT2]=Yb,this.pcUniformType[i.FLOAT_MAT3]=A0,this.pcUniformType[i.FLOAT_MAT4]=im,this.pcUniformType[i.SAMPLER_2D]=kF,this.pcUniformType[i.SAMPLER_CUBE]=VF,this.pcUniformType[i.UNSIGNED_INT]=am,this.pcUniformType[i.UNSIGNED_INT_VEC2]=nm,this.pcUniformType[i.UNSIGNED_INT_VEC3]=rm,this.pcUniformType[i.UNSIGNED_INT_VEC4]=om,this.pcUniformType[i.SAMPLER_2D_SHADOW]=GF,this.pcUniformType[i.SAMPLER_CUBE_SHADOW]=HF,this.pcUniformType[i.SAMPLER_2D_ARRAY]=qF,this.pcUniformType[i.SAMPLER_3D]=WF,this.pcUniformType[i.INT_SAMPLER_2D]=XF,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D]=jF,this.pcUniformType[i.INT_SAMPLER_CUBE]=YF,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D]=KF,this.pcUniformType[i.INT_SAMPLER_3D]=QF,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_3D]=$F,this.pcUniformType[i.INT_SAMPLER_2D_ARRAY]=ZF,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D_ARRAY]=JF,this.targetToSlot={},this.targetToSlot[i.TEXTURE_2D]=0,this.targetToSlot[i.TEXTURE_CUBE_MAP]=1,this.targetToSlot[i.TEXTURE_3D]=2;let l,u,f,_,g;this.commitFunction=[],this.commitFunction[Wp]=function(y,v){y.value!==v&&(i.uniform1i(y.locationId,v),y.value=v)},this.commitFunction[Ud]=this.commitFunction[Wp],this.commitFunction[Vn]=function(y,v){y.value!==v&&(i.uniform1f(y.locationId,v),y.value=v)},this.commitFunction[zd]=function(y,v){g=y.value,l=v[0],u=v[1],(g[0]!==l||g[1]!==u)&&(i.uniform2fv(y.locationId,v),g[0]=l,g[1]=u)},this.commitFunction[Fn]=function(y,v){g=y.value,l=v[0],u=v[1],f=v[2],(g[0]!==l||g[1]!==u||g[2]!==f)&&(i.uniform3fv(y.locationId,v),g[0]=l,g[1]=u,g[2]=f)},this.commitFunction[kd]=function(y,v){g=y.value,l=v[0],u=v[1],f=v[2],_=v[3],(g[0]!==l||g[1]!==u||g[2]!==f||g[3]!==_)&&(i.uniform4fv(y.locationId,v),g[0]=l,g[1]=u,g[2]=f,g[3]=_)},this.commitFunction[Rd]=function(y,v){g=y.value,l=v[0],u=v[1],(g[0]!==l||g[1]!==u)&&(i.uniform2iv(y.locationId,v),g[0]=l,g[1]=u)},this.commitFunction[x0]=this.commitFunction[Rd],this.commitFunction[Md]=function(y,v){g=y.value,l=v[0],u=v[1],f=v[2],(g[0]!==l||g[1]!==u||g[2]!==f)&&(i.uniform3iv(y.locationId,v),g[0]=l,g[1]=u,g[2]=f)},this.commitFunction[T0]=this.commitFunction[Md],this.commitFunction[Dd]=function(y,v){g=y.value,l=v[0],u=v[1],f=v[2],_=v[3],(g[0]!==l||g[1]!==u||g[2]!==f||g[3]!==_)&&(i.uniform4iv(y.locationId,v),g[0]=l,g[1]=u,g[2]=f,g[3]=_)},this.commitFunction[E0]=this.commitFunction[Dd],this.commitFunction[Yb]=function(y,v){i.uniformMatrix2fv(y.locationId,!1,v)},this.commitFunction[A0]=function(y,v){i.uniformMatrix3fv(y.locationId,!1,v)},this.commitFunction[im]=function(y,v){i.uniformMatrix4fv(y.locationId,!1,v)},this.commitFunction[K1]=function(y,v){i.uniform1fv(y.locationId,v)},this.commitFunction[Q1]=function(y,v){i.uniform2fv(y.locationId,v)},this.commitFunction[$1]=function(y,v){i.uniform3fv(y.locationId,v)},this.commitFunction[cC]=function(y,v){i.uniform4fv(y.locationId,v)},this.commitFunction[am]=function(y,v){y.value!==v&&(i.uniform1ui(y.locationId,v),y.value=v)},this.commitFunction[nm]=function(y,v){g=y.value,l=v[0],u=v[1],(g[0]!==l||g[1]!==u)&&(i.uniform2uiv(y.locationId,v),g[0]=l,g[1]=u)},this.commitFunction[rm]=function(y,v){g=y.value,l=v[0],u=v[1],f=v[2],(g[0]!==l||g[1]!==u||g[2]!==f)&&(i.uniform3uiv(y.locationId,v),g[0]=l,g[1]=u,g[2]=f)},this.commitFunction[om]=function(y,v){g=y.value,l=v[0],u=v[1],f=v[2],_=v[3],(g[0]!==l||g[1]!==u||g[2]!==f||g[3]!==_)&&(i.uniform4uiv(y.locationId,v),g[0]=l,g[1]=u,g[2]=f,g[3]=_)},this.commitFunction[lm]=function(y,v){i.uniform1iv(y.locationId,v)},this.commitFunction[Z1]=function(y,v){i.uniform1uiv(y.locationId,v)},this.commitFunction[J1]=this.commitFunction[lm],this.commitFunction[hm]=function(y,v){i.uniform2iv(y.locationId,v)},this.commitFunction[ex]=function(y,v){i.uniform2uiv(y.locationId,v)},this.commitFunction[tx]=this.commitFunction[hm],this.commitFunction[cm]=function(y,v){i.uniform3iv(y.locationId,v)},this.commitFunction[sx]=function(y,v){i.uniform3uiv(y.locationId,v)},this.commitFunction[ix]=this.commitFunction[cm],this.commitFunction[Kb]=function(y,v){i.uniform4iv(y.locationId,v)},this.commitFunction[uC]=function(y,v){i.uniform4uiv(y.locationId,v)},this.commitFunction[dC]=this.commitFunction[Kb],this.commitFunction[zD]=function(y,v){i.uniformMatrix4fv(y.locationId,!1,v)},this.constantTexSource=this.scope.resolve("source"),this.postInit()}postInit(){super.postInit(),this.gpuProfiler=new l7(this)}destroy(){super.destroy();const e=this.gl;this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new fs({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e}updateBackbufferFormat(e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);const s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?Lt:pl}updateBackbuffer(){const e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(e,t){return new QG}createIndexBufferImpl(e){return new $G(e)}createShaderImpl(e){return new i7(e)}createTextureImpl(e){return new a7(e)}createRenderTargetImpl(e){return new r7}getPrecision(){const e=this.gl;let t="highp";if(e.getShaderPrecisionFormat){const s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(s&&i&&a&&n){const r=s.precision>0&&a.precision>0,l=i.precision>0&&n.precision>0;r||(l?t="mediump":t="lowp")}}return t}getExtension(){for(let e=0;e<arguments.length;e++)if(this.supportedExtensions.indexOf(arguments[e])!==-1)return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){const e=this.gl;this.supportedExtensions=e.getSupportedExtensions()??[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc")}initializeCapabilities(){const e=this.gl;let t;const s=typeof navigator<"u"?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const i=e.getContextAttributes();this.supportsMsaa=(i==null?void 0:i.antialias)??!1,this.supportsStencil=(i==null?void 0:i.stencil)??!1,this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubeMapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=e.getParameter(e.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=e.getParameter(e.MAX_3D_TEXTURE_SIZE),t=this.extDebugRendererInfo,this.unmaskedRenderer=t?e.getParameter(t.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=t?e.getParameter(t.UNMASKED_VENDOR_WEBGL):"";const a=/\bMali-G52+/,n=/SM-[a-zA-Z0-9]+/;this.supportsGpuParticles=!(this.unmaskedVendor==="ARM"&&s.match(n))&&!this.unmaskedRenderer.match(a),t=this.extTextureFilterAnisotropic,this.maxAnisotropy=t?e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;const r=!this.forceDisableMultisampling;this.maxSamples=r?e.getParameter(e.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=r&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!Ct.android,this.maxTextures<=8&&(this.supportsAreaLights=!1),this.initCapsDefines()}initializeRenderState(){super.initializeRenderState();const e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=Sh,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=Gp,this.stencilZfailFront=this.stencilZfailBack=Gp,this.stencilZpassFront=this.stencilZpassBack=Gp,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new xe(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}initTextureUnits(e=16){this.textureUnits=[];for(let t=0;t<e;t++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){super.loseContext();for(const e of this.shaders)e.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext();for(const e of this.shaders)e.restoreContext()}setViewport(e,t,s,i){(this.vx!==e||this.vy!==t||this.vw!==s||this.vh!==i)&&(this.gl.viewport(e,t,s,i),this.vx=e,this.vy=t,this.vw=s,this.vh=i)}setScissor(e,t,s,i){(this.sx!==e||this.sy!==t||this.sw!==s||this.sh!==i)&&(this.gl.scissor(e,t,s,i),this.sx=e,this.sy=t,this.sw=s,this.sh=i)}setFramebuffer(e){if(this.activeFramebuffer!==e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e}}copyRenderTarget(e,t,s,i){var _,g;const a=this.gl;if(e===this.backBuffer&&(e=null),s){if(t){if(e&&(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format))return!1}else if(!e._colorBuffer)return!1}if(i&&e&&!e._depth&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return!1;const n=this.renderTarget;this.renderTarget=t,this.updateBegin();const r=e?e.impl._glFrameBuffer:(_=this.backBuffer)==null?void 0:_.impl._glFrameBuffer,l=t?t.impl._glFrameBuffer:(g=this.backBuffer)==null?void 0:g.impl._glFrameBuffer;a.bindFramebuffer(a.READ_FRAMEBUFFER,r),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,l);const u=e?e.width:t?t.width:this.width,f=e?e.height:t?t.height:this.height;return a.blitFramebuffer(0,0,u,f,0,0,u,f,(s?a.COLOR_BUFFER_BIT:0)|(i?a.DEPTH_BUFFER_BIT:0),a.NEAREST),this.renderTarget=n,a.bindFramebuffer(a.FRAMEBUFFER,n?n.impl._glFrameBuffer:null),!0}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(e){const t=e.renderTarget??this.backBuffer;this.renderTarget=t,this.updateBegin();const{width:s,height:i}=t;this.setViewport(0,0,s,i),this.setScissor(0,0,s,i);const a=e.colorOps,n=e.depthStencilOps;if(a!=null&&a.clear||n.clearDepth||n.clearStencil){let r=0;const l={};a!=null&&a.clear&&(r|=Jp,l.color=[a.clearValue.r,a.clearValue.g,a.clearValue.b,a.clearValue.a]),n.clearDepth&&(r|=em,l.depth=n.clearDepthValue),n.clearStencil&&(r|=_0,l.stencil=n.clearStencilValue),l.flags=r,this.clear(l)}this.insideRenderPass=!0}endRenderPass(e){var i;this.unbindVertexArray();const t=this.renderTarget,s=e.colorArrayOps.length;if(t){ag.length=0;const a=this.gl;for(let n=0;n<s;n++){const r=e.colorArrayOps[n];r.store||r.resolve||ag.push(a.COLOR_ATTACHMENT0+n)}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||ag.push(a.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||ag.push(a.STENCIL_ATTACHMENT)),ag.length>0&&e.fullSizeClearRect&&a.invalidateFramebuffer(a.DRAW_FRAMEBUFFER,ag),s&&((i=e.colorOps)!=null&&i.resolve)&&e.samples>1&&t.autoResolve&&t.resolve(!0,!1),t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve&&t.resolve(!1,!0);for(let n=0;n<s;n++)if(e.colorArrayOps[n].genMipmaps){const l=t._colorBuffers[n];l&&l.impl._glTexture&&l.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(l),this.gl.generateMipmap(l.impl._glTarget))}}this.insideRenderPass=!1}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let s=0;s<this.textureUnits.length;++s)for(let i=0;i<3;++i)this.textureUnits[s][i]=null;const e=this.renderTarget??this.backBuffer,t=e.impl;t.initialized||this.initRenderTarget(e),this.setFramebuffer(t._glFrameBuffer)}updateEnd(){this.unbindVertexArray();const e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();const t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)}bindTexture(e){const t=e.impl,s=t._glTarget,i=t._glTexture,a=this.textureUnit,n=this.targetToSlot[s];this.textureUnits[a][n]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[a][n]=i)}bindTextureOnUnit(e,t){const s=e.impl,i=s._glTarget,a=s._glTexture,n=this.targetToSlot[i];this.textureUnits[t][n]!==a&&(this.activeTexture(t),this.gl.bindTexture(i,a),this.textureUnits[t][n]=a)}setTextureParameters(e){const t=this.gl,s=e.impl.dirtyParameterFlags,i=e.impl._glTarget;if(s&WD){let a=e._minFilter;(!e._mipmaps||e._compressed&&e._levels.length===1)&&(a===vm||a===Sm?a=Je:(a===bm||a===lo)&&(a=Vt)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[a])}if(s&qD&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),s&XD&&t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]),s&jD&&t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]),s&YD&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),s&KD&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),s&QD&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),s&$D){const a=this.extTextureFilterAnisotropic;a&&t.texParameterf(i,a.TEXTURE_MAX_ANISOTROPY_EXT,ge.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy))}}setTexture(e,t){const s=e.impl;s._glTexture||s.initialize(this,e),s.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),s.dirtyParameterFlags&&(this.setTextureParameters(e),s.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(s.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)}createVertexArray(e){let t,s;const i=e.length>1;if(i){t="";for(let a=0;a<e.length;a++){const n=e[a];t+=n.id+n.format.renderingHash}s=this._vaoMap.get(t)}if(!s){const a=this.gl;s=a.createVertexArray(),a.bindVertexArray(s),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);for(let n=0;n<e.length;n++){const r=e[n];a.bindBuffer(a.ARRAY_BUFFER,r.impl.bufferId);const l=r.format.elements;for(let u=0;u<l.length;u++){const f=l[u],_=Bt[f.name];f.asInt?a.vertexAttribIPointer(_,f.numComponents,this.glType[f.dataType],f.stride,f.offset):a.vertexAttribPointer(_,f.numComponents,this.glType[f.dataType],f.normalize,f.stride,f.offset),a.enableVertexAttribArray(_),r.format.instancing&&a.vertexAttribDivisor(_,1)}}a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){const e=this.gl;let t;if(this.vertexBuffers.length===1){const i=this.vertexBuffers[0];i.impl.vao||(i.impl.vao=this.createVertexArray(this.vertexBuffers)),t=i.impl.vao}else t=this.createVertexArray(this.vertexBuffers);this.boundVao!==t&&(this.boundVao=t,e.bindVertexArray(t)),this.clearVertexBuffer();const s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s)}draw(e,t,s){const i=this.gl;if(this.activateShader(this),!this.shaderValid)return;let a,n,r,l,u,f,_,g;const y=this.shader;if(!y)return;const v=y.impl.samplers,x=y.impl.uniforms;s||this.setBuffers();let C=0;for(let T=0,R=v.length;T<R;T++){if(a=v[T],n=a.scopeId.value,!n){const D=a.scopeId.name;D==="uSceneDepthMap"&&(n=Xp(this,"white")),D==="uSceneColorMap"&&(n=Xp(this,"pink")),n||(n=Xp(this,"pink"))}if(n instanceof Ge)r=n,this.setTexture(r,C),a.slot!==C&&(i.uniform1i(a.locationId,C),a.slot=C),C++;else{a.array.length=0,l=n.length;for(let D=0;D<l;D++)r=n[D],this.setTexture(r,C),a.array[D]=C,C++;i.uniform1iv(a.locationId,a.array)}}for(let T=0,R=x.length;T<R;T++)u=x[T],f=u.scopeId,_=u.version,g=f.versionObject.version,(_.globalId!==g.globalId||_.revision!==g.revision)&&(_.globalId=g.globalId,_.revision=g.revision,f.value!==null&&this.commitFunction[u.dataType](u,f.value));this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const M=this.glPrimitive[e.type],w=e.count;if(e.indexed){const T=this.indexBuffer,R=T.impl.glFormat,D=e.base*T.bytesPerIndex;t>0?i.drawElementsInstanced(M,w,R,D,t):i.drawElements(M,w,R,D)}else{const T=e.base;t>0?i.drawArraysInstanced(M,T,w,t):i.drawArrays(M,T,w)}this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(e){const t=this.defaultClearOptions;e=e||t;const s=e.flags??t.flags;if(s!==0){const i=this.gl;if(s&Jp){const a=e.color??t.color,n=a[0],r=a[1],l=a[2],u=a[3],f=this.clearColor;(n!==f.r||r!==f.g||l!==f.b||u!==f.a)&&(this.gl.clearColor(n,r,l,u),this.clearColor.set(n,r,l,u)),this.setBlendState(ms.NOBLEND)}if(s&em){const a=e.depth??t.depth;a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a),this.setDepthState($i.WRITEDEPTH)}if(s&_0){const a=e.stencil??t.stencil;a!==this.clearStencil&&(this.gl.clearStencil(a),this.clearStencil=a),i.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255}i.clear(this.glClearFlag[s])}}submit(){this.gl.flush()}readPixels(e,t,s,i,a){const n=this.gl;n.readPixels(e,t,s,i,n.RGBA,n.UNSIGNED_BYTE,a)}async readPixelsAsync(e,t,s,i,a){var g;const n=this.gl,r=(y,v)=>{const x=n.fenceSync(n.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise((C,M)=>{function w(){const T=n.clientWaitSync(x,y,0);T===n.WAIT_FAILED?(n.deleteSync(x),M(new Error("webgl clientWaitSync sync failed"))):T===n.TIMEOUT_EXPIRED?setTimeout(w,v):(n.deleteSync(x),C())}w()})},l=(g=this.renderTarget.colorBuffer)==null?void 0:g.impl,u=(l==null?void 0:l._glFormat)??n.RGBA,f=(l==null?void 0:l._glPixelType)??n.UNSIGNED_BYTE,_=n.createBuffer();return n.bindBuffer(n.PIXEL_PACK_BUFFER,_),n.bufferData(n.PIXEL_PACK_BUFFER,a.byteLength,n.STREAM_READ),n.readPixels(e,t,s,i,u,f,0),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),await r(0,20),n.bindBuffer(n.PIXEL_PACK_BUFFER,_),n.getBufferSubData(n.PIXEL_PACK_BUFFER,0,a),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),n.deleteBuffer(_),a}readTextureAsync(e,t,s,i,a,n){const r=n.face??0,l=n.renderTarget??new fs({colorBuffer:e,depth:!1,face:r}),u=new ArrayBuffer(fr.calcLevelGpuSize(i,a,1,e._format)),f=n.data??new(DD(e._format))(u);return this.setRenderTarget(l),this.initRenderTarget(l),new Promise((_,g)=>{this.readPixelsAsync(t,s,i,a,f).then(y=>{n.renderTarget||l.destroy(),_(y)}).catch(g)})}setAlphaToCoverage(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;const t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}}setRaster(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD))}setStencilTest(e){if(this.stencil!==e){const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}}setStencilFunc(e,t,s){(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s||this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s)&&(this.gl.stencilFunc(this.glComparison[e],t,s),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,s),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=s}}setStencilFuncBack(e,t,s){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,s),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=s}}setStencilOperation(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s||this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=s),(this.stencilWriteMaskFront!==i||this.stencilWriteMaskBack!==i)&&(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(e,t,s,i){(this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendState(e){const t=this.blendState;if(!t.equals(e)){const s=this.gl,{blend:i,colorOp:a,alphaOp:n,colorSrcFactor:r,colorDstFactor:l,alphaSrcFactor:u,alphaDstFactor:f}=e;if(t.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),t.colorOp!==a||t.alphaOp!==n){const _=this.glBlendEquation;s.blendEquationSeparate(_[a],_[n])}(t.colorSrcFactor!==r||t.colorDstFactor!==l||t.alphaSrcFactor!==u||t.alphaDstFactor!==f)&&s.blendFuncSeparate(this.glBlendFunctionColor[r],this.glBlendFunctionColor[l],this.glBlendFunctionAlpha[u],this.glBlendFunctionAlpha[f]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e)}}setBlendColor(e,t,s,i){const a=this.blendColor;(e!==a.r||t!==a.g||s!==a.b||i!==a.a)&&(this.gl.blendColor(e,t,s,i),a.set(e,t,s,i))}setStencilState(e,t){e||t?(this.setStencilTest(!0),e===t?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(e??(e=pr.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),t??(t=pr.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask))):this.setStencilTest(!1)}setDepthState(e){const t=this.depthState;if(!t.equals(e)){const s=this.gl,i=e.write;t.write!==i&&s.depthMask(i);let{func:a,test:n}=e;!n&&i&&(n=!0,a=Sh),t.func!==a&&s.depthFunc(this.glComparison[a]),t.test!==n&&(n?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));const{depthBias:r,depthBiasSlope:l}=e;r||l?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(l,r)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e)}}setCullMode(e){if(this.cullMode!==e){if(e===Xs)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===Xs&&this.gl.enable(this.gl.CULL_FACE);const t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}}setShader(e,t=!1){e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0)}activateShader(e){const{shader:t}=this,{impl:s}=t;this.shaderValid===void 0&&(t.failed?this.shaderValid=!1:t.ready||(this.shaderAsyncCompile?s.isLinked(e)?s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1):this.shaderValid=!1:s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1))),this.shaderValid===void 0&&(this.gl.useProgram(s.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){const e=this.gl;this._vaoMap.forEach((t,s,i)=>{e.deleteVertexArray(t)}),this._vaoMap.clear()}set fullscreen(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}}class h7{unlock(e){}}class c7{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,s,i){}}class u7{destroy(e){}loseContext(){}restoreContext(e,t){}}class d7{destroy(e){}propertyChanged(e){}loseContext(){}}class f7{destroy(e){}unlock(e){}}class yB extends _s{constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=!0,this._deviceType=hb,this.samples=1,this.backBuffer=new fs({name:"Framebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.initDeviceCaps()}destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=!1,this.supportsAreaLights=!0,this.supportsGpuParticles=!1,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!1}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(e,t,s,i,a){}createVertexBufferImpl(e,t){return new f7(e,t)}createIndexBufferImpl(e){return new h7(e)}createShaderImpl(e){return new u7(e)}createTextureImpl(e){return new d7(e)}createRenderTargetImpl(e){return new c7(e)}draw(e,t=1,s){}setShader(e,t=!1){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,s,i){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}clear(e){}setViewport(e,t,s,i){}setScissor(e,t,s,i){}copyRenderTarget(e,t,s,i){return!0}}function p7(h,e={}){var i;const t=e.deviceTypes??[];t.includes(lb)||t.push(lb),t.includes(hb)||t.push(hb),Ct.browser&&navigator.xr&&(e.xrCompatible??(e.xrCompatible=!0));const s=[];for(let a=0;a<t.length;a++){const n=t[a];n===GD&&((i=window==null?void 0:window.navigator)!=null&&i.gpu)&&s.push(()=>new _B(h,e).initWebGpu(e.glslangUrl,e.twgslUrl)),n===lb&&s.push(()=>new sP(h,e)),n===hb&&s.push(()=>new yB(h,e))}return new Promise((a,n)=>{let r=0;const l=()=>{r>=s.length?n(new Error("Failed to create a graphics device")):Promise.resolve(s[r++]()).then(u=>{u?a(u):l()}).catch(u=>{console.log(u),l()})};l()})}class m7{constructor(){this.scopeId=null}}class _7{constructor(e,t,s="Unnamed"){this.shader=null,this.parameters=new Map,this.countX=1,this.device=e,this.shader=t,this.name=s,e.supportsCompute&&(this.impl=e.createComputeImpl(this))}setParameter(e,t){let s=this.parameters.get(e);s||(s=new m7,s.scopeId=this.device.scope.resolve(e),this.parameters.set(e,s)),s.value=t}getParameter(e){var t;return(t=this.parameters.get(e))==null?void 0:t.value}deleteParameter(e){this.parameters.delete(e)}applyParameters(){for(const[,e]of this.parameters)e.scopeId.setValue(e.value)}setupDispatch(e,t,s){this.countX=e,this.countY=t,this.countZ=s}}let g7=0;class Ah{constructor(e,t,s,i=_r,a,n){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=g7++,this.impl=e.createIndexBufferImpl(this,n);const r=iB[t];this.bytesPerIndex=r,this.numBytes=this.numIndices*r,a?this.setData(a):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength!==this.numBytes?!1:(this.storage=e,this.unlock(),!0)}_lockTypedArray(){const e=this.lock();return this.format===Th?new Uint32Array(e):this.format===ho?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){const s=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(let i=0;i<t;i++)s[i]=e[i];else s.set(e);this.unlock()}readData(e){const t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(let i=0;i<s;i++)e[i]=t[i]}return s}}class y7{constructor(){this.clearValue=new xe(0,0,0,1),this.clearValueLinear=new xe(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.genMipmaps=!1}}class v7{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.resolveDepth=!1,this.storeStencil=!1}}class pa{get colorOps(){return this.colorArrayOps[0]}constructor(e){this._enabled=!0,this._skipStart=!1,this._skipEnd=!1,this.executeEnabled=!0,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=e}set name(e){this._name=e}get name(){return this._name||(this._name=this.constructor.name),this._name}set scaleX(e){this._options.scaleX=e}get scaleX(){return this._options.scaleX}set scaleY(e){this._options.scaleY=e}get scaleY(){return this._options.scaleY}set options(e){this._options=e,e&&(this.scaleX=this.scaleX??1,this.scaleY=this.scaleY??1)}get options(){return this._options}init(e=null,t){this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit()}allocateAttachments(){var s,i,a,n;const e=this.renderTarget;this.depthStencilOps=new v7,e!=null&&e.depthBuffer&&(this.depthStencilOps.storeDepth=!0);const t=e?((s=e._colorBuffers)==null?void 0:s.length)??0:1;this.colorArrayOps.length=0;for(let r=0;r<t;r++){const l=new y7;this.colorArrayOps[r]=l,this.samples===1&&(l.store=!0,l.resolve=!1);const u=(a=(i=this.renderTarget)==null?void 0:i._colorBuffers)==null?void 0:a[r];if((n=this.renderTarget)!=null&&n.mipmaps&&(u!=null&&u.mipmaps)){const f=kc(u._format);l.genMipmaps=!f}}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){const e=this._options.resizeSource??this.device.backBuffer,t=Math.floor(e.width*this.scaleX),s=Math.floor(e.height*this.scaleY);this.renderTarget.resize(t,s)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(e){const t=this.colorArrayOps.length;for(let s=0;s<t;s++){const i=this.colorArrayOps[s];e&&(i.clearValue.copy(e),i.clearValueLinear.linear(e)),i.clear=!!e}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=e!==void 0}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=e!==void 0}render(){if(this.enabled){const e=this.device,t=this.renderTarget!==void 0;this.before(),this.executeEnabled&&(t&&!this._skipStart&&e.startRenderPass(this),this.execute(),t&&!this._skipEnd&&e.endRenderPass(this)),this.after(),e.renderPassIndex++}}}let S7=0;class b7{constructor(e,t,s=0){this.id=S7++,this.device=e,this.byteSize=t,this.bufferUsage=s,this.impl=e.createBufferImpl(K2|s),this.impl.allocate(e,t),this.device.buffers.push(this),this.adjustVramSizeTracking(e._vram,this.byteSize)}destroy(){const e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.adjustVramSizeTracking(e._vram,-this.byteSize),this.impl.destroy(e)}adjustVramSizeTracking(e,t){e.sb+=t}read(e=0,t=this.byteSize,s=null){return this.impl.read(this.device,e,t,s)}write(e=0,t,s=0,i){this.impl.write(this.device,e,t,s,i)}clear(e=0,t=this.byteSize){this.impl.clear(this.device,e,t)}}class x7{constructor(e,t=wA){this.device=e.device;const s=this.device.gl;this._inputBuffer=e,t===wA&&e.usage!==t&&(s.bindBuffer(s.ARRAY_BUFFER,e.impl.bufferId),s.bufferData(s.ARRAY_BUFFER,e.storage,s.DYNAMIC_COPY)),this._outputBuffer=new jn(e.device,e.format,e.numVertices,{usage:t,data:e.storage})}static createShader(e,t,s){return new ef(e,da.createDefinition(e,{name:s,vertexCode:t,useTransformFeedback:!0}))}destroy(){this._outputBuffer.destroy()}process(e,t=!0){const s=this.device,i=s.getRenderTarget();if(s.setRenderTarget(null),s.updateBegin(),s.setVertexBuffer(this._inputBuffer,0),s.setRaster(!1),s.setTransformFeedbackBuffer(this._outputBuffer),s.setShader(e),s.draw({type:Y0,base:0,count:this._inputBuffer.numVertices,indexed:!1}),s.setTransformFeedbackBuffer(null),s.setRaster(!0),s.updateEnd(),s.setRenderTarget(i),t){let a=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=a,a=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=a}}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}}function T7(h){this.array[this.index]=h}function E7(h,e){this.array[this.index]=h,this.array[this.index+1]=e}function A7(h,e,t){this.array[this.index]=h,this.array[this.index+1]=e,this.array[this.index+2]=t}function C7(h,e,t,s){this.array[this.index]=h,this.array[this.index+1]=e,this.array[this.index+2]=t,this.array[this.index+3]=s}function w7(h,e,t){this.array[h]=e[t]}function R7(h,e,t){this.array[h]=e[t],this.array[h+1]=e[t+1]}function M7(h,e,t){this.array[h]=e[t],this.array[h+1]=e[t+1],this.array[h+2]=e[t+2]}function D7(h,e,t){this.array[h]=e[t],this.array[h+1]=e[t+1],this.array[h+2]=e[t+2],this.array[h+3]=e[t+3]}function P7(h,e,t){e[t]=this.array[h]}function L7(h,e,t){e[t]=this.array[h],e[t+1]=this.array[h+1]}function I7(h,e,t){e[t]=this.array[h],e[t+1]=this.array[h+1],e[t+2]=this.array[h+2]}function O7(h,e,t){e[t]=this.array[h],e[t+1]=this.array[h+1],e[t+2]=this.array[h+2],e[t+3]=this.array[h+3]}class N7{constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new qp[t.dataType](e,t.offset):this.array=new qp[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=T7,this.getToArray=P7,this.setFromArray=w7;break;case 2:this.set=E7,this.getToArray=L7,this.setFromArray=R7;break;case 3:this.set=A7,this.getToArray=I7,this.setFromArray=M7;break;case 4:this.set=C7,this.getToArray=O7,this.setFromArray=D7;break}}get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}}class i0{constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const t=this.vertexBuffer.getFormat();for(let s=0;s<t.elements.length;s++){const i=t.elements[s];this.accessors[s]=new N7(this.buffer,i,t),this.element[i.name]=this.accessors[s]}}next(e=1){let t=0;const s=this.accessors,i=this.accessors.length;for(;t<i;){const a=s[t++];a.index+=e*a.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,s){const i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const a=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let r=0;r<s;r++)i.setFromArray(n,t,r*a),n+=i.stride}else if(t.length>s*a){const n=s*a;if(ArrayBuffer.isView(t))t=t.subarray(0,n),i.array.set(t);else for(let r=0;r<n;r++)i.array[r]=t[r]}else i.array.set(t)}}readData(e,t){const s=this.element[e];let i=0;if(s){i=this.vertexBuffer.numVertices;let a;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;let r=0;for(a=0;a<i;a++)s.getToArray(r,t,a*n),r+=s.stride}else if(ArrayBuffer.isView(t))t.set(s.array);else{t.length=0;const r=i*n;for(a=0;a<r;a++)t[a]=s.array[a]}}return i}}const dA="mouse",fA="keyboard",pA="gamepad",F7="mousex",B7="mousey",U7="padlx",z7="padly",k7="padrx",V7="padry",G7="key",H7=8,W7=9,q7=13,X7=13,j7=16,Y7=17,K7=18,Q7=19,$7=20,Z7=27,J7=32,eH=33,tH=34,sH=35,iH=36,aH=37,nH=38,rH=39,oH=40,lH=44,hH=45,cH=46,uH=48,dH=49,fH=50,pH=51,mH=52,_H=53,gH=54,yH=55,vH=56,SH=57,bH=59,xH=61,TH=65,EH=66,AH=67,CH=68,wH=69,RH=70,MH=71,DH=72,PH=73,LH=74,IH=75,OH=76,NH=77,FH=78,BH=79,UH=80,zH=81,kH=82,VH=83,GH=84,HH=85,WH=86,qH=87,XH=88,jH=89,YH=90,KH=91,QH=93,$H=96,ZH=97,JH=98,eW=99,tW=100,sW=101,iW=102,aW=103,nW=104,rW=105,oW=106,lW=107,hW=108,cW=109,uW=110,dW=111,fW=112,pW=113,mW=114,_W=115,gW=116,yW=117,vW=118,SW=119,bW=120,xW=121,TW=122,EW=123,AW=188,CW=190,wW=191,RW=219,MW=220,DW=221,PW=224,vB=-1,LW=0,IW=1,OW=2,SB=0,NW=1,FW=2,BW=3,bB=0,xB=1,TB=2,EB=3,AB=4,CB=5,wB=6,RB=7,MB=8,DB=9,PB=10,LB=11,IB=12,OB=13,NB=14,FB=15,BB=16,iP=0,aP=1,nP=2,rP=3,UB=0,zB=1,kB=2,VB=3,GB=2,HB=0,WB=1,qB=3,XB=4,jB=5;class YB{constructor(e,t){this.key=null,this.element=null,this.event=null,t&&(this.key=t.keyCode,this.element=t.target,this.event=t)}}const hE=new YB;function lR(h){return hE.key=h.keyCode,hE.element=h.target,hE.event=h,hE}function cE(h){return typeof h=="string"?h.toUpperCase().charCodeAt(0):h}const UW={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},D2=class D2 extends Qe{constructor(e,t={}){super(),this._element=null,this._keymap={},this._lastmap={},this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(e){e=cE(e);const t=UW[e.toString()];if(t)return t;let s=e.toString(16).toUpperCase();const i=s.length;for(let a=0;a<4-i;a++)s=`0${s}`;return`U+${s}`}_handleKeyDown(e){const t=e.keyCode||e.charCode;if(t===void 0)return;const s=this.toKeyIdentifier(t);this._keymap[s]=!0,this.fire("keydown",lR(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyUp(e){const t=e.keyCode||e.charCode;if(t===void 0)return;const s=this.toKeyIdentifier(t);delete this._keymap[s],this.fire("keyup",lR(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyPress(e){this.fire("keypress",lR(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleVisibilityChange(){document.visibilityState==="hidden"&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const e in this._lastmap)delete this._lastmap[e];for(const e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])}isPressed(e){const t=cE(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]}wasPressed(e){const t=cE(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(e){const t=cE(e),s=this.toKeyIdentifier(t);return!this._keymap[s]&&!!this._lastmap[s]}};D2.EVENT_KEYDOWN="keydown",D2.EVENT_KEYUP="keyup";let Jb=D2;function XM(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}class Td{constructor(e,t){this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=vB,this.wheelDelta=0,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.metaKey=!1;let s={x:0,y:0};if(t){if(t instanceof Td)throw Error("Expected MouseEvent");s=e._getTargetCoords(t)}else t={};if(s)this.x=s.x,this.y=s.y;else if(XM())this.x=0,this.y=0;else return;t.type==="wheel"&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),XM()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),(t.type==="mousedown"||t.type==="mouseup")&&(this.button=t.button),this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey??!1,this.altKey=t.altKey??!1,this.shiftKey=t.shiftKey??!1,this.metaKey=t.metaKey??!1,this.event=t}}const Hg=class Hg extends Qe{constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._target=null,this._attached=!1,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this.attach(e)}static isPointerLocked(){return XM()}attach(e){if(this._target=e,this._attached)return;this._attached=!0;const t={passive:!1},s=Ct.passiveEvents?t:!1;window.addEventListener("mouseup",this._upHandler,s),window.addEventListener("mousedown",this._downHandler,s),window.addEventListener("mousemove",this._moveHandler,s),window.addEventListener("wheel",this._wheelHandler,s)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const e={passive:!1},t=Ct.passiveEvents?e:!1;window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(e,t){if(!document.body.requestPointerLock){t&&t();return}const s=()=>{e(),document.removeEventListener("pointerlockchange",s)},i=()=>{t(),document.removeEventListener("pointerlockerror",i)};e&&document.addEventListener("pointerlockchange",s,!1),t&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(e){if(!document.exitPointerLock)return;const t=()=>{e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return!this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=!1;const t=new Td(this,e);t.event&&this.fire("mouseup",t)}_handleDown(e){this._buttons[e.button]=!0;const t=new Td(this,e);t.event&&this.fire("mousedown",t)}_handleMove(e){const t=new Td(this,e);t.event&&(this.fire("mousemove",t),this._lastX=t.x,this._lastY=t.y)}_handleWheel(e){const t=new Td(this,e);t.event&&this.fire("mousewheel",t)}_getTargetCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<s||e.clientX>=s+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-s,y:e.clientY-i}}};Hg.EVENT_MOUSEMOVE="mousemove",Hg.EVENT_MOUSEDOWN="mousedown",Hg.EVENT_MOUSEUP="mouseup",Hg.EVENT_MOUSEWHEEL="mousewheel";let Hd=Hg;class zW{constructor(e,t={}){this._element=null,this._actions={},this._axes={},this._axesValues={},this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,e&&this.attach(e)}attach(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e)}detach(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null}disableContextMenu(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()}enableContextMenu(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()}update(e){this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={};for(const t in this._axes)this._axesValues[t]=[]}appendAction(e,t){this._actions[e]=this._actions[e]||[],this._actions[e].push(t)}registerKeys(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw new Error(`Action: ${e} already registered`);if(t===void 0)throw new Error("Invalid button");t.length||(t=[t]),this.appendAction(e,{type:fA,keys:t})}registerMouse(e,t){if(this._mouse||this._enableMouse(),t===void 0)throw new Error("Invalid button");this.appendAction(e,{type:dA,button:t})}registerPadButton(e,t,s){if(s===void 0)throw new Error("Invalid button");this.appendAction(e,{type:pA,button:s,pad:t})}registerAxis(e){const t=e.name;this._axes[t]||(this._axes[t]=[]);const s=this._axes[t].push(t);e=e||{},e.pad=e.pad||SB;const i=function(a,n,r,l){switch(n){case"mousex":a._mouse.on("mousemove",u=>{a._axesValues[t][s]=u.dx/10});break;case"mousey":a._mouse.on("mousemove",u=>{a._axesValues[t][s]=u.dy/10});break;case"key":a._axes[t].push(()=>a._keyboard.isPressed(l)?r:0);break;case"padrx":a._axes[t].push(()=>a._gamepads.getAxis(e.pad,nP));break;case"padry":a._axes[t].push(()=>a._gamepads.getAxis(e.pad,rP));break;case"padlx":a._axes[t].push(()=>a._gamepads.getAxis(e.pad,iP));break;case"padly":a._axes[t].push(()=>a._gamepads.getAxis(e.pad,aP));break;default:throw new Error("Unknown axis")}};i(this,e.positive,1,e.positiveKey),(e.negativeKey||e.negative!==e.positive)&&i(this,e.negative,-1,e.negativeKey)}isPressed(e){if(!this._actions[e])return!1;const t=this._actions[e].length;for(let s=0;s<t;++s){const i=this._actions[e][s];switch(i.type){case fA:if(this._keyboard){const a=i.keys.length;for(let n=0;n<a;n++)if(this._keyboard.isPressed(i.keys[n]))return!0}break;case dA:if(this._mouse&&this._mouse.isPressed(i.button))return!0;break;case pA:if(this._gamepads&&this._gamepads.isPressed(i.pad,i.button))return!0;break}}return!1}wasPressed(e){if(!this._actions[e])return!1;const t=this._actions[e].length;for(let s=0;s<t;++s){const i=this._actions[e][s];switch(i.type){case fA:if(this._keyboard){const a=i.keys.length;for(let n=0;n<a;n++)if(this._keyboard.wasPressed(i.keys[n]))return!0}break;case dA:if(this._mouse&&this._mouse.wasPressed(i.button))return!0;break;case pA:if(this._gamepads&&this._gamepads.wasPressed(i.pad,i.button))return!0;break}}return!1}getAxis(e){let t=0;if(this._axes[e]){const s=this._axes[e].length;for(let i=0;i<s;i++)if(typeof this._axes[e][i]=="function"){const a=this._axes[e][i]();Math.abs(a)>Math.abs(t)&&(t=a)}else this._axesValues[e]&&Math.abs(this._axesValues[e][i])>Math.abs(t)&&(t=this._axesValues[e][i])}return t}_enableMouse(){if(this._mouse=new Hd,!this._element)throw new Error("Controller must be attached to an Element");this._mouse.attach(this._element)}_enableKeyboard(){if(this._keyboard=new Jb,!this._element)throw new Error("Controller must be attached to an Element");this._keyboard.attach(this._element)}}const KB=Object.freeze([]);let jM=function(){return KB};typeof navigator<"u"&&(jM=(navigator.getGamepads||navigator.webkitGetGamepads||jM).bind(navigator));const eO={buttons:{PAD_FACE_1:bB,PAD_FACE_2:xB,PAD_FACE_3:TB,PAD_FACE_4:EB,PAD_L_SHOULDER_1:AB,PAD_R_SHOULDER_1:CB,PAD_L_SHOULDER_2:wB,PAD_R_SHOULDER_2:RB,PAD_SELECT:MB,PAD_START:DB,PAD_L_STICK_BUTTON:PB,PAD_R_STICK_BUTTON:LB,PAD_UP:IB,PAD_DOWN:OB,PAD_LEFT:NB,PAD_RIGHT:FB,PAD_VENDOR:BB,XRPAD_TRIGGER:HB,XRPAD_SQUEEZE:WB,XRPAD_TOUCHPAD_BUTTON:GB,XRPAD_STICK_BUTTON:qB,XRPAD_A:XB,XRPAD_B:jB},axes:{PAD_L_STICK_X:iP,PAD_L_STICK_Y:aP,PAD_R_STICK_X:nP,PAD_R_STICK_Y:rP,XRPAD_TOUCHPAD_X:UB,XRPAD_TOUCHPAD_Y:zB,XRPAD_STICK_X:kB,XRPAD_STICK_Y:VB}},Hv={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},tO={"Product: 0268":"PS3"},mA={};function QB(h){const e=mA[h.id];if(e)return e;for(const i in tO)if(h.id.indexOf(i)!==-1){const a=tO[i];if(!h.mapping){const n=Hv[`RAW_${a}`];if(n)return n}return Hv[a]}if(h.mapping==="xr-standard")return Hv.DEFAULT_XR;const t=Hv.DEFAULT,s=h.buttons.length<t.buttons.length?Hv.DEFAULT_DUAL:t;return s.mapping=h.mapping,s}let YM=.25;function kW(h){return new Promise(e=>{setTimeout(e,h)})}class KM{constructor(e,t){this.value=0,this.pressed=!1,this.touched=!1,this.wasPressed=!1,this.wasReleased=!1,this.wasTouched=!1,typeof e=="number"?(this.value=e,this.pressed=e===1,this.touched=e>0):(this.value=e.value,this.pressed=e.pressed,this.touched=e.touched??e.value>0),t&&(typeof t=="number"?(this.wasPressed=t!==1&&this.pressed,this.wasReleased=t===1&&!this.pressed,this.wasTouched=t===0&&this.touched):(this.wasPressed=!t.pressed&&this.pressed,this.wasReleased=t.pressed&&!this.pressed,this.wasTouched=!(t.touched??t.value>0)&&this.touched))}update(e){const{value:t,pressed:s}=e,i=e.touched??t>0;this.wasPressed=!this.pressed&&s,this.wasReleased=this.pressed&&!s,this.wasTouched=!this.touched&&i,this.value=t,this.pressed=s,this.touched=i}}const hR=Object.freeze(new KM(0));class sO{constructor(e,t){this._compiledMapping={buttons:[],axes:[]},this.id=e.id,this.index=e.index,this._buttons=e.buttons.map(s=>new KM(s)),this._axes=[...e.axes],this._previousAxes=[...e.axes],this.mapping=t.mapping,this.map=t,this.hand=e.hand||"none",this.pad=e,this._compileMapping()}get connected(){return this.pad.connected}_compileMapping(){const{axes:e,buttons:t}=this._compiledMapping,s=eO.axes,i=eO.buttons;e.length=0,t.length=0,this.map.axes&&this.map.axes.forEach((l,u)=>{e[s[l]]=()=>this.pad.axes[u]||0});for(let l=0,u=e.length;l<u;l++)e[l]||(e[l]=()=>0);const n=this.map.buttons;n&&n.forEach((l,u)=>{t[i[l]]=()=>this._buttons[u]||hR});const r=this.map.synthesizedButtons;r&&Object.entries(r).forEach(l=>{const{axis:u,max:f,min:_}=l[1];t[i[l[0]]]=()=>new KM(Math.abs(ge.clamp(this._axes[u]??0,_,f)),Math.abs(ge.clamp(this._previousAxes[u]??0,_,f)))});for(let l=0,u=t.length;l<u;l++)t[l]||(t[l]=()=>hR)}update(e){this.pad=e;const t=this._previousAxes,s=this._axes;t.length=0,t.push(...s),s.length=0,s.push(...e.axes);const i=this._buttons;for(let a=0,n=i.length;a<n;a++)i[a].update(e.buttons[a]);return this}updateMap(e){e.mapping="custom",mA[this.id]=e,this.map=e,this.mapping="custom",this._compileMapping()}resetMap(){if(mA[this.id]){delete mA[this.id];const e=QB(this.pad);this.map=e,this.mapping=e.mapping,this._compileMapping()}}get axes(){return this._compiledMapping.axes.map(e=>e())}get buttons(){return this._compiledMapping.buttons.map(e=>e())}async pulse(e,t,s){const i=this.pad.vibrationActuator?[this.pad.vibrationActuator]:this.pad.hapticActuators||KB;if(i.length){const a=(s==null?void 0:s.startDelay)??0,n=(s==null?void 0:s.strongMagnitude)??e,r=(s==null?void 0:s.weakMagnitude)??e;return(await Promise.all(i.map(async u=>u?u.playEffect?u.playEffect(u.type,{duration:t,startDelay:a,strongMagnitude:n,weakMagnitude:r}):u.pulse?(await kW(a),u.pulse(e,t)):!1:!0))).some(u=>u===!0||u==="complete")}return!1}getButton(e){const t=this._compiledMapping.buttons[e];return t?t():hR}isPressed(e){return this.getButton(e).pressed}wasPressed(e){return this.getButton(e).wasPressed}wasReleased(e){return this.getButton(e).wasReleased}isTouched(e){return this.getButton(e).touched}wasTouched(e){return this.getButton(e).wasTouched}getValue(e){return this.getButton(e).value}getAxis(e){const t=this.axes[e];return t&&Math.abs(t)>YM?t:0}}const P2=class P2 extends Qe{constructor(){super(),this.gamepadsSupported=Ct.gamepads,this.current=[],this._previous=[],this._ongamepadconnectedHandler=this._ongamepadconnected.bind(this),this._ongamepaddisconnectedHandler=this._ongamepaddisconnected.bind(this),window.addEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.addEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1),this.poll()}set deadZone(e){YM=e}get deadZone(){return YM}get previous(){const e=this.current;for(let t=0,s=e.length;t<s;t++){const i=e[t]._buttons;this._previous[t]||(this._previous[t]=[]);for(let a=0,n=i.length;a<n;a++){const r=i[t];this.previous[t][a]=r?!r.wasPressed&&r.pressed||r.wasReleased:!1}}return this._previous.length=this.current.length,this._previous}_ongamepadconnected(e){const t=new sO(e.gamepad,this.getMap(e.gamepad)),s=this.current;let i=s.findIndex(a=>a.index===t.index);for(;i!==-1;)s.splice(i,1),i=s.findIndex(a=>a.index===t.index);s.push(t),this.fire("gamepadconnected",t)}_ongamepaddisconnected(e){const t=this.current,s=t.findIndex(i=>i.index===e.gamepad.index);s!==-1&&(this.fire("gamepaddisconnected",t[s]),t.splice(s,1))}update(){this.poll()}poll(e=[]){e.length>0&&(e.length=0);const t=jM();for(let s=0,i=t.length;s<i;s++)if(t[s]){const a=this.findByIndex(t[s].index);if(a)e.push(a.update(t[s]));else{const n=new sO(t[s],this.getMap(t[s]));this.current.push(n),e.push(n)}}return e}destroy(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1)}getMap(e){return QB(e)}isPressed(e,t){var s;return((s=this.current[e])==null?void 0:s.isPressed(t))||!1}wasPressed(e,t){var s;return((s=this.current[e])==null?void 0:s.wasPressed(t))||!1}wasReleased(e,t){var s;return((s=this.current[e])==null?void 0:s.wasReleased(t))||!1}getAxis(e,t){var s;return((s=this.current[e])==null?void 0:s.getAxis(t))||0}pulse(e,t,s,i){const a=this.current[e];return a?a.pulse(t,s,i):Promise.resolve(!1)}pulseAll(e,t,s){return Promise.all(this.current.map(i=>i.pulse(e,t,s)))}findById(e){return this.current.find(t=>t&&t.id===e)||null}findByIndex(e){return this.current.find(t=>t&&t.index===e)||null}};P2.EVENT_GAMEPADCONNECTED="gamepadconnected",P2.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected";let QM=P2;function ub(h){let e=0,t=0,s=h.target;for(;!(s instanceof HTMLElement)&&s;)s=s.parentNode;for(;s;)e+=s.offsetLeft-s.scrollLeft,t+=s.offsetTop-s.scrollTop,s=s.offsetParent;return{x:h.pageX-e,y:h.pageY-t}}class $M{constructor(e){const t=ub(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e}}class ib{constructor(e,t){this.touches=[],this.changedTouches=[],this.element=t.target,this.event=t,this.touches=Array.from(t.touches).map(s=>new $M(s)),this.changedTouches=Array.from(t.changedTouches).map(s=>new $M(s))}getTouchById(e,t){return t.find(s=>s.id===e)||null}}const Wg=class Wg extends Qe{constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e)}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(e){this.fire("touchstart",new ib(this,e))}_handleTouchEnd(e){this.fire("touchend",new ib(this,e))}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new ib(this,e))}_handleTouchCancel(e){this.fire("touchcancel",new ib(this,e))}};Wg.EVENT_TOUCHSTART="touchstart",Wg.EVENT_TOUCHEND="touchend",Wg.EVENT_TOUCHMOVE="touchmove",Wg.EVENT_TOUCHCANCEL="touchcancel";let ZM=Wg;const ns=class ns{get(e,t,s){return typeof t=="function"&&(s=t,t={}),this.request("GET",e,t,s)}post(e,t,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return typeof t=="function"&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){let a,n,r,l=!1;if(typeof s=="function"&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,s.async==null&&(s.async=!0),s.headers==null&&(s.headers={}),s.postdata!=null)if(s.postdata instanceof Document)r=s.postdata;else if(s.postdata instanceof FormData)r=s.postdata;else if(s.postdata instanceof Object){let f=s.headers["Content-Type"];switch(f===void 0&&(s.headers["Content-Type"]=ns.ContentType.FORM_URLENCODED,f=s.headers["Content-Type"]),f){case ns.ContentType.FORM_URLENCODED:{r="";let _=!0;for(const g in s.postdata)if(s.postdata.hasOwnProperty(g)){_?_=!1:r+="&";const y=encodeURIComponent(g),v=encodeURIComponent(s.postdata[g]);r+=`${y}=${v}`}break}default:case ns.ContentType.JSON:f==null&&(s.headers["Content-Type"]=ns.ContentType.JSON),r=JSON.stringify(s.postdata);break}}else r=s.postdata;if(s.cache===!1){const f=oo();a=new cA(t),a.query?a.query=`${a.query}&ts=${f}`:a.query=`ts=${f}`,t=a.toString()}s.query&&(a=new cA(t),n=Db(a.getQuery(),s.query),a.setQuery(n),t=a.toString());const u=new XMLHttpRequest;u.open(e,t,s.async),u.withCredentials=s.withCredentials!==void 0?s.withCredentials:!1,u.responseType=s.responseType||this._guessResponseType(t);for(const f in s.headers)s.headers.hasOwnProperty(f)&&u.setRequestHeader(f,s.headers[f]);u.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,u)},u.onerror=()=>{this._onError(e,t,s,u),l=!0};try{u.send(r)}catch(f){l||s.error(u.status,u,f)}return u}_guessResponseType(e){const t=new cA(e),s=bt.getExtension(t.path).toLowerCase();return ns.binaryExtensions.indexOf(s)>=0?ns.ResponseType.ARRAY_BUFFER:s===".json"?ns.ResponseType.JSON:s===".xml"?ns.ResponseType.DOCUMENT:ns.ResponseType.TEXT}_isBinaryContentType(e){return[ns.ContentType.BASIS,ns.ContentType.BIN,ns.ContentType.DDS,ns.ContentType.GLB,ns.ContentType.MP3,ns.ContentType.MP4,ns.ContentType.OGG,ns.ContentType.OPUS,ns.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===ns.ResponseType.ARRAY_BUFFER||e===ns.ResponseType.BLOB||e===ns.ResponseType.JSON}_onReadyStateChange(e,t,s,i){if(i.readyState===4)switch(i.status){case 0:{i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break}case 200:case 201:case 206:case 304:{this._onSuccess(e,t,s,i);break}default:{this._onError(e,t,s,i);break}}}_onSuccess(e,t,s,i){let a,n;const r=i.getResponseHeader("Content-Type");r&&(n=r.split(";")[0].trim());try{this._isBinaryContentType(n)||this._isBinaryResponseType(i.responseType)?a=i.response:n===ns.ContentType.JSON||t.split("?")[0].endsWith(".json")?a=JSON.parse(i.responseText):i.responseType===ns.ResponseType.DOCUMENT||n===ns.ContentType.XML?a=i.responseXML:a=i.responseText,s.callback(null,a)}catch(l){s.callback(l)}}_onError(e,t,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const a=ge.clamp(Math.pow(2,s.retries)*ns.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${e}: ${t} - Error ${i.status}. Retrying in ${a} ms`),setTimeout(()=>{s.retrying=!1,this.request(e,t,s,s.callback)},a)}else s.callback(i.status===0?"Network error":i.status,null)}};ns.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},ns.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},ns.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],ns.retryDelay=100;let Wn=ns;const Us=new Wn;function Zc(){return typeof AudioContext<"u"||typeof webkitAudioContext<"u"}class LA{constructor(e,t,s={}){if(this.volume=s.volume??1,this.loop=s.loop??!1,this.pitch=s.pitch??1,this.sound=t,this.paused=!1,this.suspended=!1,this.manager=e,this.source=null,Zc()){this.startTime=0,this.startOffset=0;const i=e.context;this.gain=i.createGain()}else t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(e){this.loop=e,this.source&&(this.source.loop=e)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())}pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)}unpause(){if(this.source||!this.paused){console.warn("Call pause() before unpausing.");return}this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)}setVolume(e){e=ge.clamp(e,0,1),this.volume=e,this.gain&&(this.gain.gain.value=e*this.manager.volume)}setPitch(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e)}isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){const e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}Zc()||Object.assign(LA.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(h){h=ge.clamp(h,0,1),this.volume=h,this.source&&(this.source.volume=h*this.manager.volume)},setPitch:function(h){this.pitch=h,this.source&&(this.source.playbackRate=h)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});const VW=1e4;class JM extends LA{constructor(e,t,s){super(e,t,s),this.position=new H,this.velocity=new H,Zc()?this.panner=e.context.createPanner():(this.maxDistance=VW,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=j2)}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}getVelocity(){return this.velocity}setVelocity(e){this.velocity.copy(e)}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){this.panner.maxDistance=e}getMinDistance(){return this.panner.refDistance}setMinDistance(e){this.panner.refDistance=e}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(e){this.panner.rolloffFactor=e}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){this.panner.distanceModel=e}_createSource(){const e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this))}}if(!Zc()){let h=new H;const e=function(t,s,i,a,n,r){h=h.sub2(t,s);const l=h.length();if(l<i)return 1;if(l>a)return 0;let u=0;return r===A1?u=1-n*(l-i)/(a-i):r===j2?u=i/(i+n*(l-i)):r===TD&&(u=Math.pow(l/i,-n)),ge.clamp(u,0,1)};Object.assign(JM.prototype,{setPosition:function(t){if(this.position.copy(t),this.source){const i=this.manager.listener.getPosition(),a=e(i,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),n=this.getVolume();this.source.volume=n*a}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}class GW{constructor(e){this.position=new H,this.orientation=new Me,this._manager=e}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z))}setOrientation(e){this.orientation.copy(e);const t=this.listener;if(t){const s=e.data;"forwardX"in t?(t.forwardX.value=-s[8],t.forwardY.value=-s[9],t.forwardZ.value=-s[10],t.upX.value=s[4],t.upY.value=s[5],t.upZ.value=s[6]):t.setOrientation&&t.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6])}}getOrientation(){return this.orientation}get listener(){const e=this._manager.context;return e?e.listener:null}}const uE="running",iO=["click","touchstart","mousedown"];class $B extends Qe{constructor(){super(),this._context=null,this.AudioContext=typeof AudioContext<"u"&&AudioContext||typeof webkitAudioContext<"u"&&webkitAudioContext,this.AudioContext,this._unlockHandlerFunc=this._unlockHandler.bind(this),this._userSuspended=!1,this.listener=new GW(this),this._volume=1}set volume(e){e=ge.clamp(e,0,1),this._volume=e,this.fire("volumechange",e)}get volume(){return this._volume}get suspended(){return this._userSuspended}get context(){return!this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==uE&&this._registerUnlockListeners()),this._context}suspend(){this._userSuspended||(this._userSuspended=!0,this._context&&this._context.state===uE&&this._suspend())}resume(){this._userSuspended&&(this._userSuspended=!1,this._context&&this._context.state!==uE&&this._resume())}destroy(){var e;this.fire("destroy"),this._context&&(this._removeUnlockListeners(),(e=this._context)==null||e.close(),this._context=null)}playSound(e,t={}){let s=null;return LA&&(s=new LA(this,e,t),s.play()),s}playSound3d(e,t,s={}){let i=null;return JM&&(i=new JM(this,e,s),i.setPosition(t),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}_resume(){this._context.resume().then(()=>{const e=this._context.createBufferSource();e.buffer=this._context.createBuffer(1,1,this._context.sampleRate),e.connect(this._context.destination),e.start(0),e.onended=t=>{e.disconnect(0),this.fire("resume")}},e=>{}).catch(e=>{})}_suspend(){this._context.suspend().then(()=>{this.fire("suspend")},e=>{}).catch(e=>{})}_unlockHandler(){this._removeUnlockListeners(),!this._userSuspended&&this._context.state!==uE&&this._resume()}_registerUnlockListeners(){iO.forEach(e=>{window.addEventListener(e,this._unlockHandlerFunc,!1)})}_removeUnlockListeners(){iO.forEach(e=>{window.removeEventListener(e,this._unlockHandlerFunc,!1)})}}class ZB{constructor(e){e instanceof Audio?this.audio=e:this.buffer=e}get duration(){let e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}}const On=0,Ug=1,Zo=2;function Nn(h,e){return h%e||0}const Dp=class Dp extends Qe{constructor(e,t,s){super(),this.source=null,this._manager=e,this._volume=s.volume!==void 0?ge.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0&&s.loop),this._sound=t,this._state=Zo,this._suspended=!1,this._suspendEndEvent=0,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,Zc()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._waitingContextSuspension=!1,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set currentTime(e){if(!(e<0))if(this._state===On){const t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._startOffset=e,this._currentTime=e}get currentTime(){return this._startOffset!==null?this._startOffset:this._state===Ug?this._currentTime:this._state===Zo||!this.source?0:(this._updateCurrentTime(),this._currentTime)}set duration(e){this._duration=Math.max(0,Number(e)||0);const t=this._state===On;this.stop(),t&&this.play()}get duration(){return this._sound?this._duration?Nn(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return this._state===Ug}get isPlaying(){return this._state===On}get isStopped(){return this._state===Zo}get isSuspended(){return this._suspended}set loop(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set pitch(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}get pitch(){return this._pitch}set sound(e){this._sound=e,this._state!==Zo?this.stop():this._createSource()}get sound(){return this._sound}set startTime(e){this._startTime=Math.max(0,Number(e)||0);const t=this._state===On;this.stop(),t&&this.play()}get startTime(){return this._startTime}set volume(e){e=ge.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume)}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){if(this._suspendEndEvent>0){this._suspendEndEvent--;return}this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop()}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){this._state===On&&!this._suspended&&(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}play(){return this._state!==Zo&&this.stop(),this._state=On,this._playWhenLoaded=!1,this._waitingContextSuspension?!1:this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=!0,!1):(this._playAudioImmediate(),!0)}_playAudioImmediate(){if(this._waitingContextSuspension=!1,this._state!==On)return;this.source||this._createSource();let e=Nn(this._startOffset,this.duration);e=Nn(this._startTime+e,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay()}pause(){return this._playWhenLoaded=!1,this._state!==On?!1:(this._state=Ug,this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause()),!0)}resume(){if(this._state!==Ug)return!1;let e=this.currentTime;return this._state=On,this._waitingContextSuspension||(this.source||this._createSource(),this._startOffset!==null&&(e=Nn(this._startOffset,this.duration),e=Nn(this._startTime+e,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume()),!0}stop(){if(this._playWhenLoaded=!1,this._state===Zo)return!1;const e=this._state===On;return this._state=Zo,this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop()),!0}setExternalNodes(e,t){if(!e){console.error("The firstNode must be a valid Audio Node");return}t||(t=e);const s=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=t,this._lastNode.connect(s))}clearExternalNodes(){const e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)}getExternalNodes(){return[this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;const e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=Nn(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,Nn(this._startTime+this._duration,this.source.buffer.duration)))),this.source}_updateCurrentTime(){this._currentTime=Nn((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)}_onManagerDestroy(){this.source&&this._state===On&&(this.source.stop(0),this.source=null)}};Dp.EVENT_PLAY="play",Dp.EVENT_PAUSE="pause",Dp.EVENT_RESUME="resume",Dp.EVENT_STOP="stop",Dp.EVENT_END="end";let vh=Dp;Zc()||(Object.assign(vh.prototype,{play:function(){return this._state!==Zo&&this.stop(),!this.source&&!this._createSource()?!1:(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=On,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!this.source||this._state!==On?!1:(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=Ug,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!this.source||this._state!==Ug?!1:(this._state=On,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!this.source||this._state===Zo?!1:(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=Zo,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let h=Nn(this._startOffset,this.duration);h=Nn(this._startTime+h,this._sound.duration),this._startOffset=null,this.source.currentTime=h},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>Nn(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=Nn(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(vh.prototype,"volume",{get:function(){return this._volume},set:function(h){h=ge.clamp(h,0,1),this._volume=h,this.source&&(this.source.volume=h*this._manager.volume)}}),Object.defineProperty(vh.prototype,"pitch",{get:function(){return this._pitch},set:function(h){this._pitch=Math.max(Number(h)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(vh.prototype,"sound",{get:function(){return this._sound},set:function(h){this.stop(),this._sound=h}}),Object.defineProperty(vh.prototype,"currentTime",{get:function(){return this._startOffset!==null?this._startOffset:this._state===Zo||!this.source?0:this.source.currentTime-this._startTime},set:function(h){h<0||(this._startOffset=h,this.source&&this._isReady&&(this.source.currentTime=Nn(this._startTime+Nn(h,this.duration),this._sound.duration),this._startOffset=null))}}));const HW=1e4;class wp extends vh{constructor(e,t,s={}){super(e,t,s),this._position=new H,this._velocity=new H,s.position&&(this.position=s.position),this.maxDistance=s.maxDistance!==void 0?Number(s.maxDistance):HW,this.refDistance=s.refDistance!==void 0?Number(s.refDistance):1,this.rollOffFactor=s.rollOffFactor!==void 0?Number(s.rollOffFactor):1,this.distanceModel=s.distanceModel!==void 0?s.distanceModel:A1}_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}set position(e){this._position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}get position(){return this._position}set velocity(e){this._velocity.copy(e)}get velocity(){return this._velocity}set maxDistance(e){this.panner.maxDistance=e}get maxDistance(){return this.panner.maxDistance}set refDistance(e){this.panner.refDistance=e}get refDistance(){return this.panner.refDistance}set rollOffFactor(e){this.panner.rolloffFactor=e}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(e){this.panner.distanceModel=e}get distanceModel(){return this.panner.distanceModel}}if(!Zc()){let h=new H;const e=function(t,s,i,a,n,r){h=h.sub2(t,s);const l=h.length();if(l<i)return 1;if(l>a)return 0;let u=0;return r===A1?u=1-n*(l-i)/(a-i):r===j2?u=i/(i+n*(l-i)):r===TD&&(u=Math.pow(l/i,-n)),ge.clamp(u,0,1)};Object.defineProperty(wp.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){const i=this._manager.listener.getPosition(),a=e(i,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),n=this.volume;this.source.volume=n*a*this._manager.volume}}}),Object.defineProperty(wp.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(wp.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(wp.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(wp.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}const gC=0,yC=1,xr=2,Gn=3,Wd=4,vC=5,SC=6,bC=7,xC=8,TC=9,EC=10,oP={[gC]:"SUBTRACTIVE",[yC]:"ADDITIVE",[xr]:"NORMAL",[Gn]:"NONE",[Wd]:"PREMULTIPLIED",[vC]:"MULTIPLICATIVE",[SC]:"ADDITIVEALPHA",[bC]:"MULTIPLICATIVE2X",[xC]:"SCREEN",[TC]:"MIN",[EC]:"MAX"},Fm="none",JB="linear",WW="exp",qW="exp2",eU=0,lx=2,tU={[eU]:"NONE",[lx]:"SCHLICK"},sU=0,XW=1,lP=15,Ph=0,yn=1,dm=2,hx=3,ty=4,ft=0,Ds=1,jW=Ds,Ns=2,YW=3,e3={[ft]:"DIRECTIONAL",[Ds]:"OMNI",[Ns]:"SPOT"},db=100,ao=0,hP=1,cP=2,uP=3,iU={[ao]:"PUNCTUAL",[hP]:"RECT",[cP]:"DISK",[uP]:"SPHERE"},AC=0,dP=1,aU={[AC]:"LINEAR",[dP]:"INVERSESQUARED"},Un=0,KW=0,e1=2,QW=2,cx=3,$W=3,fP=4,ZW=4,CC=5,JW=5,fm=6,wC=7,RC=8,pP=9,xh=new Map([[CC,{name:"PCF1_32F",kind:"PCF1",format:il,pcf:!0}],[Un,{name:"PCF3_32F",kind:"PCF3",format:il,pcf:!0}],[fP,{name:"PCF5_32F",kind:"PCF5",format:il,pcf:!0}],[wC,{name:"PCF1_16F",kind:"PCF1",format:Cd,pcf:!0}],[RC,{name:"PCF3_16F",kind:"PCF3",format:Cd,pcf:!0}],[pP,{name:"PCF5_16F",kind:"PCF5",format:Cd,pcf:!0}],[e1,{name:"VSM_16F",kind:"VSM",format:Js,vsm:!0}],[cx,{name:"VSM_32F",kind:"VSM",format:Ri,vsm:!0}],[fm,{name:"PCSS_32F",kind:"PCSS",format:gr,pcss:!0}]]),eq=0,MC=1,IA=0,tq=1,sq=2,iq=3,mP=0,aq=1,Jo=0,nU=1,t1=0,rU=1,nq=2,Ya=0,nl=1,a0=0,od=1,ab=2,DC=0,_P=1,oU={[DC]:"NONE",[_P]:"BOX"},t3="mul",rq="add",oq="screen",lq="overlay",hq="min",cq="max",Ch=0,Gc=1,gP={[Ch]:"NONE",[Gc]:"SRGB"},sy=0,lU=1,hU=2,cU=3,uU=4,dU=5,iy=6,PC=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],yP=0,ay=1,vP=2,fU={[yP]:"NONE",[ay]:"AO",[vP]:"GLOSSDEPENDENT"},Hc="none",s1="envAtlas",i1="envAtlasHQ",a1="cubeMap",SP="sphereMap",pU={[Hc]:"NONE",[s1]:"ENVATLAS",[i1]:"ENVATLASHQ",[a1]:"CUBEMAP",[SP]:"SPHEREMAP"},LC="ambientSH",IC="envAtlas",OC="constant",mU={[LC]:"AMBIENTSH",[IC]:"ENVALATLAS",[OC]:"CONSTANT"},NC=1,ux=2,bP=4,xP=8,TP=16,dx=32,OA=64,EP=128,FC=256,BC=512,fx=1024,px=2048,AP=4096,mx=8192,NA=16384,no=0,qd=1,UC=2,uo=1,Xd=2,Pd=4,tf=0,ny=1,_x=2,ry=3,CP=4,uq="forward",dq="debug_albedo",fq="debug_world_normal",pq="debug_opacity",mq="debug_specularity",_q="debug_gloss",gq="debug_metalness",yq="debug_ao",vq="debug_emission",Sq="debug_lighting",bq="debug_uv0",tl=0,Bi=1,Ui=2,_U={[tl]:"SIMPLE",[Bi]:"SLICED",[Ui]:"TILED"},xq=0,fb=1,nb=0,Tq=1,Eq=2,jp=0,gU=1,yU=2,s3=3,vU=4,SU=5,zC=0,FA=1,At=0,Ms=1,pb="infinite",bU="box",xU="dome",br="none",TU="bayer8",EU="bluenoise",AU="ignnoise",CU={[br]:"NONE",[TU]:"BAYER8",[EU]:"BLUENOISE",[AU]:"IGNNOISE"},wU="prerender",RU="postrender",MU="prerender:layer",DU="postrender:layer",PU="precull",LU="postcull";class gx{constructor(e,t,s){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[Qb]=e,this.bindGroupFormats[Qb]=t,this.vertexFormat=s}hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++){const s=this.uniformFormats[t];if(s!=null&&s.get(e))return!0}return!1}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++){const s=this.bindGroupFormats[t];if(s!=null&&s.getTexture(e))return!0}return!1}getVertexElement(e){var t;return(t=this.vertexFormat)==null?void 0:t.elements.find(s=>s.name===e)}generateKey(e){var s;let t=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);return e.isWebGPU&&(t+=(s=this.vertexFormat)==null?void 0:s.shaderProcessingHashString),t}}var Aq=`
uniform float alpha_ref;
void alphaTest(float a) {
	if (a < alpha_ref) discard;
}
`,Cq=`
#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
	uniform vec3 ambientSH[9];
#endif
#if LIT_AMBIENT_SOURCE == ENVALATLAS
	#include "envAtlasPS"
	#ifndef ENV_ATLAS
	#define ENV_ATLAS
	uniform sampler2D texture_envAtlas;
	#endif
#endif
void addAmbient(vec3 worldNormal) {
	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
		vec3 n = cubeMapRotate(worldNormal);
		vec3 color =
			ambientSH[0] +
			ambientSH[1] * n.x +
			ambientSH[2] * n.y +
			ambientSH[3] * n.z +
			ambientSH[4] * n.x * n.z +
			ambientSH[5] * n.z * n.y +
			ambientSH[6] * n.y * n.x +
			ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
			ambientSH[8] * (n.x * n.x - n.y * n.y);
		dDiffuseLight += processEnvironment(max(color, vec3(0.0)));
	#endif
	#if LIT_AMBIENT_SOURCE == ENVALATLAS
		vec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));
		vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
		vec4 raw = texture2D(texture_envAtlas, uv);
		vec3 linear = {ambientDecode}(raw);
		dDiffuseLight += processEnvironment(linear);
	#endif
	#if LIT_AMBIENT_SOURCE == CONSTANT
		dDiffuseLight += light_globalAmbient;
	#endif
}
`,wq=`
#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
	uniform float material_aoIntensity;
#endif
#ifdef STD_AODETAIL_TEXTURE
	#include "detailModesPS"
#endif
void getAO() {
	dAo = 1.0;
	#ifdef STD_AO_TEXTURE
		float aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};
		#ifdef STD_AODETAIL_TEXTURE
			float aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};
			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;
		#endif
		dAo *= aoBase;
	#endif
	#ifdef STD_AO_VERTEX
		dAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});
	#endif
	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
		dAo = mix(1.0, dAo, material_aoIntensity);
	#endif
}
`,Rq=`
void occludeDiffuse(float ao) {
	dDiffuseLight *= ao;
}
`,Mq=`
#if LIT_OCCLUDE_SPECULAR != NONE
	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
		uniform float material_occludeSpecularIntensity;
	#endif
#endif
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	#if LIT_OCCLUDE_SPECULAR == AO
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			float specOcc = mix(1.0, ao, material_occludeSpecularIntensity);
		#else
			float specOcc = ao;
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT
		float specPow = exp2(gloss * 11.0);
		float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR != NONE
		dSpecularLight *= specOcc;
		dReflection *= specOcc;
		#ifdef LIT_SHEEN
			sSpecularLight *= specOcc;
			sReflection *= specOcc;
		#endif
	#endif
}
`,Dq=`
uniform vec3 view_position;
uniform vec3 light_globalAmbient;
float square(float x) {
	return x*x;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 saturate(vec3 x) {
	return clamp(x, vec3(0.0), vec3(1.0));
}
`,Pq=`
#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,Lq=`
#define NINESLICED
#define NINESLICETILED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,Iq=`
float bayer2(vec2 p) {
	return mod(2.0 * p.y + p.x + 1.0, 4.0);
}
float bayer4(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
float bayer8(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	vec2 p4 = floor(0.25 * mod(p, 8.0));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`,Oq=`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
#ifdef GAUSS
uniform float weight[SAMPLES];
#endif
void main(void) {
	vec3 moments = vec3(0.0);
	vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);
	for (int i=0; i<SAMPLES; i++) {
		vec4 c = texture2D(source, uv + pixelOffset * float(i));
		#ifdef GAUSS
		moments += c.xyz * weight[i];
		#else
		moments += c.xyz;
		#endif
	}
	#ifndef GAUSS
	moments /= float(SAMPLES);
	#endif
	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);
}
`,Nq=`
#ifdef STD_CLEARCOAT_CONSTANT
uniform float material_clearCoat;
#endif
void getClearCoat() {
	ccSpecularity = 1.0;
	#ifdef STD_CLEARCOAT_CONSTANT
	ccSpecularity *= material_clearCoat;
	#endif
	#ifdef STD_CLEARCOAT_TEXTURE
	ccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOAT_VERTEX
	ccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});
	#endif
}
`,Fq=`
#ifdef STD_CLEARCOATGLOSS_CONSTANT
uniform float material_clearCoatGloss;
#endif
void getClearCoatGlossiness() {
	ccGlossiness = 1.0;
	#ifdef STD_CLEARCOATGLOSS_CONSTANT
	ccGlossiness *= material_clearCoatGloss;
	#endif
	#ifdef STD_CLEARCOATGLOSS_TEXTURE
	ccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOATGLOSS_VERTEX
	ccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_CLEARCOATGLOSS_INVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`,Bq=`
#ifdef STD_CLEARCOATNORMAL_TEXTURE
uniform float material_clearCoatBumpiness;
#endif
void getClearCoatNormal() {
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	vec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`,Uq=`
vec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)
{
	vec3 vAbs = abs(dir);
	float ma;
	vec2 uv;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;
		ma = 0.5 / vAbs.z;
		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);
		tileOffset.x = 2.0;
		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;
	} else if(vAbs.y >= vAbs.x) {
		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;
		ma = 0.5 / vAbs.y;
		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);
		tileOffset.x = 1.0;
		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;
	} else {
		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;
		ma = 0.5 / vAbs.x;
		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);
		tileOffset.x = 0.0;
		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;
	}
	return uv * ma + 0.5;
}
vec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {
	float faceIndex;
	vec2 tileOffset;
	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);
	float atlasFaceSize = omniAtlasViewport.z;
	float tileSize = shadowTextureResolution * atlasFaceSize;
	float offset = shadowEdgePixels / tileSize;
	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);
	uv *= atlasFaceSize;
	uv += tileOffset * atlasFaceSize;
	uv += omniAtlasViewport.xy;
	return uv;
}
`,zq=`
vec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {
	vec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);
	bool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;
	return isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));
}
vec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {
	vec4 projPos = transform * vec4(worldPosition, 1.0);
	return _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);
}
vec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);
}
`,kq=`
vec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {
	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);
	projPos.xyz /= projPos.w;
	return projPos.xyz;
}
vec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {
	vec3 wPos = vPositionW + normal * shadowParams.y;
	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
vec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
	float distScale = length(lightDir);
	vec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	vec3 dir = wPos - lightPos;
	return dir;
}
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
float getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	return textureShadow(shadowMap, vec3(uv, shadowZ));
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
float getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 shadowCoord = vec3(uv, shadowZ);
	return getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
float getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 shadowCoord = vec3(uv, shadowZ);
	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
float getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
float getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
float getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
`,Vq=`
#include "lightBufferDefinesPS"
#include "clusteredLightUtilsPS"
#ifdef CLUSTER_COOKIES
	#include "clusteredLightCookiesPS"
#endif
#ifdef CLUSTER_SHADOWS
	#include "clusteredLightShadowsPS"
#endif
uniform highp sampler2D clusterWorldTexture;
uniform highp sampler2D lightsTexture;
#ifdef CLUSTER_SHADOWS
	uniform sampler2DShadow shadowAtlasTexture;
#endif
#ifdef CLUSTER_COOKIES
	uniform sampler2D cookieAtlasTexture;
#endif
uniform int clusterMaxCells;
uniform float clusterSkip;
uniform vec3 clusterCellsCountByBoundsSize;
uniform vec3 clusterTextureSize;
uniform vec3 clusterBoundsMin;
uniform vec3 clusterBoundsDelta;
uniform vec3 clusterCellsDot;
uniform vec3 clusterCellsMax;
uniform vec2 shadowAtlasParams;
struct ClusterLightData {
	uint flags;
	vec3 halfWidth;
	bool isSpot;
	vec3 halfHeight;
	int lightIndex;
	vec3 position;
	uint shape;
	vec3 direction;
	bool falloffModeLinear;
	vec3 color;
	float shadowIntensity;
	vec3 omniAtlasViewport;
	float range;
	vec4 cookieChannelMask;
	float biasesData;
	float shadowBias;
	float shadowNormalBias;
	float anglesData;
	float innerConeAngleCos;
	float outerConeAngleCos;
	float cookieIntensity;
	bool isDynamic;
	bool isLightmapped;
};
mat4 lightProjectionMatrix;
vec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {
	return texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);
}
void decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {
	clusterLightData.lightIndex = int(lightIndex);
	vec4 halfData = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_COLOR_ANGLES_BIAS);
	clusterLightData.anglesData = halfData.z;
	clusterLightData.biasesData = halfData.w;
	vec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));
	vec2 colorB_ = unpackHalf2x16(floatBitsToUint(halfData.y));
	clusterLightData.color = vec3(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};
	vec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_POSITION_RANGE);
	clusterLightData.position = lightPosRange.xyz;
	clusterLightData.range = lightPosRange.w;
	vec4 lightDir_Flags = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_DIRECTION_FLAGS);
	clusterLightData.direction = lightDir_Flags.xyz;
	clusterLightData.flags = floatBitsToUint(lightDir_Flags.w);
	clusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;
	clusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;
	clusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;
	clusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;
	clusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;
	clusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;
	clusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;
}
void decodeClusterLightSpot(inout ClusterLightData clusterLightData) {
	vec2 angles = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));
	clusterLightData.innerConeAngleCos = angles.x;
	clusterLightData.outerConeAngleCos = angles.y;
}
void decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {
	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_0).xyz;
}
void decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {
	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_AREA_DATA_WIDTH).xyz;
	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_AREA_DATA_HEIGHT).xyz;
}
void decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {
	
	vec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_0);
	vec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_1);
	vec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_2);
	vec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_3);
	lightProjectionMatrix = mat4(m0, m1, m2, m3);
}
void decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {
	
	vec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));
	clusterLightData.shadowBias = biases.x;
	clusterLightData.shadowNormalBias = biases.y;
}
void decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {
	uint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;
	clusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));
	clusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);
}
void evaluateLight(
	ClusterLightData light, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir,
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	vec3 cookieAttenuation = vec3(1.0);
	float diffuseAttenuation = 1.0;
	float falloffAttenuation = 1.0;
	vec3 lightDirW;
	vec3 lightDirNormW;
	evalOmniLight(light.position, lightDirW, lightDirNormW);
	#ifdef CLUSTER_AREALIGHTS
	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
		decodeClusterLightAreaData(light);
		if (light.shape == {LIGHTSHAPE_RECT}) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (light.shape == {LIGHTSHAPE_DISK}) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, lightDirW);
	} else
	#endif
	{
		if (light.falloffModeLinear)
			falloffAttenuation = getFalloffLinear(light.range, lightDirW);
		else
			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			if (light.shape == {LIGHTSHAPE_RECT}) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else if (light.shape == {LIGHTSHAPE_DISK}) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); 
		}
		if (light.isSpot) {
			decodeClusterLightSpot(light);
			falloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);
		}
		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {
				if (light.isSpot) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				float shadowTextureResolution = shadowAtlasParams.x;
				float shadowEdgePixels = shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (light.cookieIntensity > 0.0) {
					decodeClusterLightCookieData(light);
					if (light.isSpot) {
						cookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (light.shadowIntensity > 0.0) {
					decodeClusterLightShadowData(light);
					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (light.isSpot) {
						vec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							float shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					} else {
						vec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			{
				vec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);
				#endif
				dDiffuseLight += areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				float areaLightSpecular;
				if (light.shape == {LIGHTSHAPE_RECT}) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (light.shape == {LIGHTSHAPE_DISK}) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					float areaLightSpecularCC;
					if (light.shape == {LIGHTSHAPE_RECT}) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (light.shape == {LIGHTSHAPE_DISK}) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				vec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
					punctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);
				#endif
				#endif
				dDiffuseLight += punctualDiffuse;
			}
	 
			#ifdef LIT_SPECULAR
				vec3 halfDir = normalize(-lightDirNormW + viewDir);
				
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight += 
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * 
						getFresnel(
							dot(viewDir, halfDir), 
							gloss, 
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; 
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dLightDirNormW = lightDirNormW;
}
void evaluateClusterLight(
	float lightIndex, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	ClusterLightData clusterLightData;
	decodeClusterLightCore(clusterLightData, lightIndex);
	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
		bool acceptLightMask = clusterLightData.isDynamic;
	#else
		bool acceptLightMask = clusterLightData.isLightmapped;
	#endif
	if (acceptLightMask)
		evaluateLight(
			clusterLightData, 
			worldNormal, 
			viewDir, 
			reflectionDir, 
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir, 
#endif
			gloss, 
			specularity, 
			geometricNormal, 
			tbn, 
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
}
void addClusteredLights(
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	if (clusterSkip > 0.5)
		return;
	vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);
	if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {
		float cellIndex = dot(clusterCellsDot, cellCoords);
		float clusterV = floor(cellIndex * clusterTextureSize.y);
		float clusterU = cellIndex - (clusterV * clusterTextureSize.x);
		for (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {
			float lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;
			if (lightIndex <= 0.0)
					return;
			evaluateClusterLight(
				lightIndex * 255.0, 
				worldNormal, 
				viewDir, 
				reflectionDir,
#if defined(LIT_CLEARCOAT)
				clearcoatReflectionDir,
#endif
				gloss, 
				specularity, 
				geometricNormal, 
				tbn, 
#if defined(LIT_IRIDESCENCE)
				iridescenceFresnel,
#endif
				clearcoat_worldNormal,
				clearcoat_gloss,
				sheen_gloss,
				iridescence_intensity
			); 
		}
	}
}
`,Gq=`
vec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {
	vec3 ret = vec3(0);
#ifdef LIT_OLD_AMBIENT
	ret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;
#else
	ret += albedo * dDiffuseLight;
#endif
#ifdef LIT_SPECULAR
	ret += dSpecularLight;
#endif
#ifdef LIT_REFLECTIONS
	ret += dReflection.rgb * dReflection.a;
#endif
#ifdef LIT_SHEEN
	float sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
	ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
#endif
#ifdef LIT_CLEARCOAT
	float clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;
	ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;
#endif
	return ret;
}
`,Hq=`
	varying vec2 uv0;
	uniform sampler2D blitTexture;
	void main(void) {
		gl_FragColor = texture2D(blitTexture, uv0);
	}
`,Wq=`
	varying vec2 uv0;
	uniform samplerCube blitTexture;
	uniform mat4 invViewProj;
	void main(void) {
		vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);
		vec4 worldPos = invViewProj * projPos;
		gl_FragColor = textureCube(blitTexture, worldPos.xyz);
	}
`,qq=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
		#ifndef WEBGPU
			uv0.y = 1.0 - uv0.y;
		#endif
	}
`,Xq=`
vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {
	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);
}
`,jq=`
#if LIT_CUBEMAP_PROJECTION == BOX
	uniform vec3 envBoxMin;
	uniform vec3 envBoxMax;
#endif
vec3 cubeMapProject(vec3 nrdir) {
	#if LIT_CUBEMAP_PROJECTION == NONE
		return cubeMapRotate(nrdir);
	#endif
	#if LIT_CUBEMAP_PROJECTION == BOX
		nrdir = cubeMapRotate(nrdir);
		vec3 rbmax = (envBoxMax - vPositionW) / nrdir;
		vec3 rbmin = (envBoxMin - vPositionW) / nrdir;
		vec3 rbminmax;
		rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;
		rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;
		rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;
		float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
		vec3 posonbox = vPositionW + nrdir * fa;
		vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;
		return normalize(posonbox - envBoxPos);
	#endif
}
`,Yq=`
#ifdef CUBEMAP_ROTATION
uniform mat3 cubeMapRotationMatrix;
#endif
vec3 cubeMapRotate(vec3 refDir) {
#ifdef CUBEMAP_ROTATION
	return refDir * cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`,Kq=`
#ifdef DEBUG_ALBEDO_PASS
gl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
gl_FragColor = vec4(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
gl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
gl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
gl_FragColor = vec4(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
gl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
gl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
gl_FragColor = vec4(vec3(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
gl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`,Qq=`
#ifdef DEBUG_LIGHTING_PASS
litArgs_albedo = vec3(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
litArgs_albedo = vec3(vUv0, 0);
#else
litArgs_albedo = vec3(0);
#endif
#endif
`,$q=`
#ifndef _DECODE_INCLUDED_
#define _DECODE_INCLUDED_
vec3 decodeLinear(vec4 raw) {
	return raw.rgb;
}
float decodeGamma(float raw) {
	return pow(raw, 2.2);
}
vec3 decodeGamma(vec3 raw) {
	return pow(raw, vec3(2.2));
}
vec3 decodeGamma(vec4 raw) {
	return pow(raw.xyz, vec3(2.2));
}
vec3 decodeRGBM(vec4 raw) {
	vec3 color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
vec3 decodeRGBP(vec4 raw) {
	vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
vec3 decodeRGBE(vec4 raw) {
	if (raw.a == 0.0) {
		return vec3(0.0, 0.0, 0.0);
	} else {
		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);
	}
}
vec4 passThrough(vec4 raw) {
	return raw;
}
vec3 unpackNormalXYZ(vec4 nmap) {
	return nmap.xyz * 2.0 - 1.0;
}
vec3 unpackNormalXY(vec4 nmap) {
	vec3 normal;
	normal.xy = nmap.wy * 2.0 - 1.0;
	normal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));
	return normal;
}
#endif
`,Zq=`
#ifndef _DETAILMODES_INCLUDED_
#define _DETAILMODES_INCLUDED_
vec3 detailMode_mul(vec3 c1, vec3 c2) {
	return c1 * c2;
}
vec3 detailMode_add(vec3 c1, vec3 c2) {
	return c1 + c2;
}
vec3 detailMode_screen(vec3 c1, vec3 c2) {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
vec3 detailMode_overlay(vec3 c1, vec3 c2) {
	return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));
}
vec3 detailMode_min(vec3 c1, vec3 c2) {
	return min(c1, c2);
}
vec3 detailMode_max(vec3 c1, vec3 c2) {
	return max(c1, c2);
}
#endif
`,Jq=`
uniform vec3 material_diffuse;
#ifdef STD_DIFFUSEDETAIL_TEXTURE
	#include "detailModesPS"
#endif
void getAlbedo() {
	dAlbedo = material_diffuse.rgb;
	#ifdef STD_DIFFUSE_TEXTURE
		vec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};
		#ifdef STD_DIFFUSEDETAIL_TEXTURE
			vec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};
			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);
		#endif
		dAlbedo *= albedoTexture;
	#endif
	#ifdef STD_DIFFUSE_VERTEX
		dAlbedo *= gammaCorrectInput(saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));
	#endif
}
`,eX=`
uniform vec3 material_emissive;
uniform float material_emissiveIntensity;
void getEmission() {
	dEmission = material_emissive * material_emissiveIntensity;
	#ifdef STD_EMISSIVE_TEXTURE
	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_EMISSIVE_VERTEX
	dEmission *= gammaCorrectInput(saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));
	#endif
}
`,tX=`
vec4 encodeLinear(vec3 source) {
	return vec4(source, 1.0);
}
vec4 encodeGamma(vec3 source) {
	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);
}
vec4 encodeRGBM(vec3 source) {
	vec4 result;
	result.rgb = pow(source.rgb, vec3(0.5));
	result.rgb *= 1.0 / 8.0;
	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );
	result.a = ceil(result.a * 255.0) / 255.0;
	result.rgb /= result.a;
	return result;
}
vec4 encodeRGBP(vec3 source) {
	vec3 gamma = pow(source, vec3(0.5));
	float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	float v = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4(gamma / (-v * 7.0 + 8.0), v);	
}
vec4 encodeRGBE(vec3 source) {
	float maxVal = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4(0, 0, 0, 0);
	} else {
		float e = ceil(log2(maxVal));
		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`,sX=`
	gl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	gl_FragColor.rgb += litArgs_emission;
	gl_FragColor.rgb = addFog(gl_FragColor.rgb);
	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);
	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);
`,iX=`
#ifndef _ENVATLAS_INCLUDED_
#define _ENVATLAS_INCLUDED_
const float atlasSize = 512.0;
const float seamSize = 1.0 / atlasSize;
vec2 mapUv(vec2 uv, vec4 rect) {
	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
vec2 mapRoughnessUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));
}
vec2 mapShinyUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));
}
#endif
`,aX=`
#ifdef LIT_SKYBOX_INTENSITY
	uniform float skyboxIntensity;
#endif
vec3 processEnvironment(vec3 color) {
	#ifdef LIT_SKYBOX_INTENSITY
		return color * skyboxIntensity;
	#else
		return color;
	#endif
}
`,nX=`
float getFalloffWindow(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float invRadius = 1.0 / lightRadius;
	return square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );
}
float getFalloffInvSquared(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float falloff = 1.0 / (sqrDist + 1.0);
	float invRadius = 1.0 / lightRadius;
	falloff *= 16.0;
	falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );
	return falloff;
}
`,rX=`
float getFalloffLinear(float lightRadius, vec3 lightDir) {
	float d = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`,oX=`
#ifndef FLOAT_AS_UINT
#define FLOAT_AS_UINT
vec4 float2uint(float value) {
	uint intBits = floatBitsToUint(value);
	return vec4(
		float((intBits >> 24u) & 0xFFu) / 255.0,
		float((intBits >> 16u) & 0xFFu) / 255.0,
		float((intBits >> 8u) & 0xFFu) / 255.0,
		float(intBits & 0xFFu) / 255.0
	);
}
float uint2float(vec4 value) {
	uint intBits = 
		(uint(value.r * 255.0) << 24u) |
		(uint(value.g * 255.0) << 16u) |
		(uint(value.b * 255.0) << 8u) |
		uint(value.a * 255.0);
	return uintBitsToFloat(intBits);
}
vec4 float2vec4(float value) {
	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)
		return vec4(value, 1.0, 1.0, 1.0);
	#else
		return float2uint(value);
	#endif
}
#endif
`,lX=`
float dBlendModeFogFactor = 1.0;
#if (FOG != NONE)
	uniform vec3 fog_color;
	#if (FOG == LINEAR)
		uniform float fog_start;
		uniform float fog_end;
	#else
		uniform float fog_density;
	#endif
#endif
float getFogFactor() {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = 0.0;
	#if (FOG == LINEAR)
		fogFactor = (fog_end - depth) / (fog_end - fog_start);
	#elif (FOG == EXP)
		fogFactor = exp(-depth * fog_density);
	#elif (FOG == EXP2)
		fogFactor = exp(-depth * depth * fog_density * fog_density);
	#endif
	return clamp(fogFactor, 0.0, 1.0);
}
vec3 addFog(vec3 color) {
	#if (FOG != NONE)
		return mix(fog_color * dBlendModeFogFactor, color, getFogFactor());
	#endif
	return color;
}
`,hX=`
vec3 getFresnel(
		float cosTheta, 
		float gloss, 
		vec3 specularity
#if defined(LIT_IRIDESCENCE)
		, vec3 iridescenceFresnel, 
		float iridescenceIntensity
#endif
	) {
	float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);
	float glossSq = gloss * gloss;
	vec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;
#if defined(LIT_IRIDESCENCE)
	return mix(ret, iridescenceFresnel, iridescenceIntensity);
#else
	return ret;
#endif	
}
float getFresnelCC(float cosTheta) {
	float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}
`,cX=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,uX=`
attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy*0.5+0.5;
}
`,dX=`
#include "decodePS"
#if (GAMMA == SRGB)
	float gammaCorrectInput(float color) {
		return decodeGamma(color);
	}
	vec3 gammaCorrectInput(vec3 color) {
		return decodeGamma(color);
	}
	vec4 gammaCorrectInput(vec4 color) {
		return vec4(decodeGamma(color.xyz), color.w);
	}
	vec3 gammaCorrectOutput(vec3 color) {
		return pow(color + 0.0000001, vec3(1.0 / 2.2));
	}
#else
	float gammaCorrectInput(float color) {
		return color;
	}
	vec3 gammaCorrectInput(vec3 color) {
		return color;
	}
	vec4 gammaCorrectInput(vec4 color) {
		return color;
	}
	vec3 gammaCorrectOutput(vec3 color) {
		return color;
	}
#endif
`,fX=`
#ifdef STD_GLOSS_CONSTANT
uniform float material_gloss;
#endif
void getGlossiness() {
	dGlossiness = 1.0;
	#ifdef STD_GLOSS_CONSTANT
	dGlossiness *= material_gloss;
	#endif
	#ifdef STD_GLOSS_TEXTURE
	dGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_GLOSS_VERTEX
	dGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_GLOSS_INVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness += 0.0000001;
}
`,pX=`
uniform mat4 matrix_model;
uniform mat4 matrix_view;
uniform mat4 matrix_projection;
bool initCenter(vec3 modelCenter, out SplatCenter center) {
	mat4 modelView = matrix_view * matrix_model;
	vec4 centerView = modelView * vec4(modelCenter, 1.0);
	if (centerView.z > 0.0) {
		return false;
	}
	vec4 centerProj = matrix_projection * centerView;
#if WEBGPU
	centerProj.z = clamp(centerProj.z, 0, abs(centerProj.w));
#else
	centerProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));
#endif
	center.view = centerView.xyz / centerView.w;
	center.proj = centerProj;
	center.projMat00 = matrix_projection[0][0];
	center.modelView = modelView;
	return true;
}
`,mX=`
uniform mediump sampler2D splatColor;
vec4 readColor(in SplatSource source) {
	return texelFetch(splatColor, source.uv, 0);
}
`,_X=`
struct SplatSource {
	uint order;
	uint id;
	ivec2 uv;
	vec2 cornerUV;
};
struct SplatCenter {
	vec3 view;
	vec4 proj;
	mat4 modelView;
	float projMat00;
};
struct SplatCorner {
	vec2 offset;
	vec2 uv;
	#if GSPLAT_AA
		float aaFactor;
	#endif
};
mat3 quatToMat3(vec4 R) {
	vec4 R2 = R + R;
	float X = R2.x * R.w;
	vec4 Y  = R2.y * R;
	vec4 Z  = R2.z * R;
	float W = R2.w * R.w;
	return mat3(
		1.0 - Z.z - W,
			  Y.z + X,
			  Y.w - Z.x,
			  Y.z - X,
		1.0 - Y.y - W,
			  Z.w + Y.x,
			  Y.w + Z.x,
			  Z.w - Y.x,
		1.0 - Y.y - Z.z
	);
}
#if SH_BANDS > 0
	#if SH_BANDS == 1
		#define SH_COEFFS 3
	#elif SH_BANDS == 2
		#define SH_COEFFS 8
	#elif SH_BANDS == 3
		#define SH_COEFFS 15
	#endif
#endif
#if GSPLAT_COMPRESSED_DATA == true
	#include "gsplatCompressedDataVS"
	#include "gsplatCompressedSHVS"
#elif GSPLAT_SOGS_DATA == true
	#include "gsplatSogsDataVS"
	#include "gsplatSogsColorVS"
	#include "gsplatSogsSHVS"
#else
	#include "gsplatDataVS"
	#include "gsplatColorVS"
	#include "gsplatSHVS"
#endif
#include "gsplatSourceVS"
#include "gsplatCenterVS"
#include "gsplatCornerVS"
#include "gsplatOutputVS"
void clipCorner(inout SplatCorner corner, float alpha) {
	float clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);
	corner.offset *= clip;
	corner.uv *= clip;
}
#if SH_BANDS > 0
#define SH_C1 0.4886025119029199f
#if SH_BANDS > 1
	#define SH_C2_0 1.0925484305920792f
	#define SH_C2_1 -1.0925484305920792f
	#define SH_C2_2 0.31539156525252005f
	#define SH_C2_3 -1.0925484305920792f
	#define SH_C2_4 0.5462742152960396f
#endif
#if SH_BANDS > 2
	#define SH_C3_0 -0.5900435899266435f
	#define SH_C3_1 2.890611442640554f
	#define SH_C3_2 -0.4570457994644658f
	#define SH_C3_3 0.3731763325901154f
	#define SH_C3_4 -0.4570457994644658f
	#define SH_C3_5 1.445305721320277f
	#define SH_C3_6 -0.5900435899266435f
#endif
vec3 evalSH(in SplatSource source, in vec3 dir) {
	vec3 sh[SH_COEFFS];
	float scale;
	readSHData(source, sh, scale);
	float x = dir.x;
	float y = dir.y;
	float z = dir.z;
	vec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);
#if SH_BANDS > 1
	float xx = x * x;
	float yy = y * y;
	float zz = z * z;
	float xy = x * y;
	float yz = y * z;
	float xz = x * z;
	result +=
		sh[3] * (SH_C2_0 * xy) *  +
		sh[4] * (SH_C2_1 * yz) +
		sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +
		sh[6] * (SH_C2_3 * xz) +
		sh[7] * (SH_C2_4 * (xx - yy));
#endif
#if SH_BANDS > 2
	result +=
		sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +
		sh[9]  * (SH_C3_1 * xy * z) +
		sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +
		sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +
		sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +
		sh[13] * (SH_C3_5 * z * (xx - yy)) +
		sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));
#endif
	return result * scale;
}
#endif
`,gX=`
uniform highp usampler2D packedTexture;
uniform highp sampler2D chunkTexture;
vec4 chunkDataA;
vec4 chunkDataB;
vec4 chunkDataC;
vec4 chunkDataD;
vec4 chunkDataE;
uvec4 packedData;
vec3 unpack111011(uint bits) {
	return vec3(
		float(bits >> 21u) / 2047.0,
		float((bits >> 11u) & 0x3ffu) / 1023.0,
		float(bits & 0x7ffu) / 2047.0
	);
}
vec4 unpack8888(uint bits) {
	return vec4(
		float(bits >> 24u) / 255.0,
		float((bits >> 16u) & 0xffu) / 255.0,
		float((bits >> 8u) & 0xffu) / 255.0,
		float(bits & 0xffu) / 255.0
	);
}
const float norm = 1.0 / (sqrt(2.0) * 0.5);
vec4 unpackRotation(uint bits) {
	float a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;
	float b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;
	float c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;
	float m = sqrt(1.0 - (a * a + b * b + c * c));
	uint mode = bits >> 30u;
	if (mode == 0u) return vec4(m, a, b, c);
	if (mode == 1u) return vec4(a, m, b, c);
	if (mode == 2u) return vec4(a, b, m, c);
	return vec4(a, b, c, m);
}
vec3 readCenter(SplatSource source) {
	uint w = uint(textureSize(chunkTexture, 0).x) / 5u;
	uint chunkId = source.id / 256u;
	ivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);
	chunkDataA = texelFetch(chunkTexture, chunkUV, 0);
	chunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);
	chunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);
	chunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);
	chunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);
	packedData = texelFetch(packedTexture, source.uv, 0);
	return mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));
}
vec4 readColor(in SplatSource source) {
	vec4 r = unpack8888(packedData.w);
	return vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);
}
vec4 getRotation() {
	return unpackRotation(packedData.y);
}
vec3 getScale() {
	return exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));
}
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	mat3 rot = quatToMat3(getRotation());
	vec3 scale = getScale();
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,yX=`
#if SH_BANDS > 0
uniform highp usampler2D shTexture0;
uniform highp usampler2D shTexture1;
uniform highp usampler2D shTexture2;
vec4 unpack8888s(in uint bits) {
	return vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;
}
void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {
	uvec4 shData0 = texelFetch(shTexture0, source.uv, 0);
	uvec4 shData1 = texelFetch(shTexture1, source.uv, 0);
	uvec4 shData2 = texelFetch(shTexture2, source.uv, 0);
	vec4 r0 = unpack8888s(shData0.x);
	vec4 r1 = unpack8888s(shData0.y);
	vec4 r2 = unpack8888s(shData0.z);
	vec4 r3 = unpack8888s(shData0.w);
	vec4 g0 = unpack8888s(shData1.x);
	vec4 g1 = unpack8888s(shData1.y);
	vec4 g2 = unpack8888s(shData1.z);
	vec4 g3 = unpack8888s(shData1.w);
	vec4 b0 = unpack8888s(shData2.x);
	vec4 b1 = unpack8888s(shData2.y);
	vec4 b2 = unpack8888s(shData2.z);
	vec4 b3 = unpack8888s(shData2.w);
	sh[0] =  vec3(r0.x, g0.x, b0.x);
	sh[1] =  vec3(r0.y, g0.y, b0.y);
	sh[2] =  vec3(r0.z, g0.z, b0.z);
	sh[3] =  vec3(r0.w, g0.w, b0.w);
	sh[4] =  vec3(r1.x, g1.x, b1.x);
	sh[5] =  vec3(r1.y, g1.y, b1.y);
	sh[6] =  vec3(r1.z, g1.z, b1.z);
	sh[7] =  vec3(r1.w, g1.w, b1.w);
	sh[8] =  vec3(r2.x, g2.x, b2.x);
	sh[9] =  vec3(r2.y, g2.y, b2.y);
	sh[10] = vec3(r2.z, g2.z, b2.z);
	sh[11] = vec3(r2.w, g2.w, b2.w);
	sh[12] = vec3(r3.x, g3.x, b3.x);
	sh[13] = vec3(r3.y, g3.y, b3.y);
	sh[14] = vec3(r3.z, g3.z, b3.z);
	scale = 1.0;
}
#endif
`,vX=`
uniform mediump sampler2D sh0;
uniform vec4 sh0_mins;
uniform vec4 sh0_maxs;
float SH_C0 = 0.28209479177387814;
vec4 readColor(in SplatSource source) {
	vec4 clr = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));
	return vec4(vec3(0.5) + clr.xyz * SH_C0, 1.0 / (1.0 + exp(-clr.w)));
}
`,SX=`
uniform highp sampler2D means_u;
uniform highp sampler2D means_l;
uniform highp sampler2D quats;
uniform highp sampler2D scales;
uniform vec3 means_mins;
uniform vec3 means_maxs;
uniform vec3 quats_mins;
uniform vec3 quats_maxs;
uniform vec3 scales_mins;
uniform vec3 scales_maxs;
vec3 readCenter(SplatSource source) {
	vec3 u = texelFetch(means_u, source.uv, 0).xyz;
	vec3 l = texelFetch(means_l, source.uv, 0).xyz;
	vec3 n = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;
	vec3 v = mix(means_mins, means_maxs, n);
	return sign(v) * (exp(abs(v)) - 1.0);
}
const float norm = 2.0 / sqrt(2.0);
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	vec4 qdata = texelFetch(quats, source.uv, 0);
	vec3 abc = (qdata.xyz - 0.5) * norm;
	float d = sqrt(max(0.0, 1.0 - dot(abc, abc)));
	uint mode = uint(qdata.w * 255.0 + 0.5) - 252u;
	vec4 quat = (mode == 0u) ? vec4(d, abc) :
				((mode == 1u) ? vec4(abc.x, d, abc.yz) :
				((mode == 2u) ? vec4(abc.xy, d, abc.z) : vec4(abc, d)));
	mat3 rot = quatToMat3(quat);
	vec3 scale = exp(mix(scales_mins, scales_maxs, texelFetch(scales, source.uv, 0).xyz));
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,bX=`
uniform highp sampler2D sh_labels;
uniform highp sampler2D sh_centroids;
uniform float shN_mins;
uniform float shN_maxs;
void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {
	ivec2 t = ivec2(texelFetch(sh_labels, source.uv, 0).xy * 255.0);
	int n = t.x + t.y * 256;
	int u = (n % 64) * 15;
	int v = n / 64;
	for (int i = 0; i < 15; i++) {
		sh[i] = mix(vec3(shN_mins), vec3(shN_maxs), texelFetch(sh_centroids, ivec2(u + i, v), 0).xyz);
	}
	scale = 1.0;
}
`,xX=`
uniform vec2 viewport;
uniform vec4 camera_params;
bool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {
	vec3 covA, covB;
	readCovariance(source, covA, covB);
	mat3 Vrk = mat3(
		covA.x, covA.y, covA.z, 
		covA.y, covB.x, covB.y,
		covA.z, covB.y, covB.z
	);
	float focal = viewport.x * center.projMat00;
	vec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;
	float J1 = focal / v.z;
	vec2 J2 = -J1 / v.z * v.xy;
	mat3 J = mat3(
		J1, 0.0, J2.x, 
		0.0, J1, J2.y, 
		0.0, 0.0, 0.0
	);
	mat3 W = transpose(mat3(center.modelView));
	mat3 T = W * J;
	mat3 cov = transpose(T) * Vrk * T;
	#if GSPLAT_AA
		float detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];
		float detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];
		corner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));
	#endif
	float diagonal1 = cov[0][0] + 0.3;
	float offDiagonal = cov[0][1];
	float diagonal2 = cov[1][1] + 0.3;
	float mid = 0.5 * (diagonal1 + diagonal2);
	float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
	float lambda1 = mid + radius;
	float lambda2 = max(mid - radius, 0.1);
	float l1 = 2.0 * min(sqrt(2.0 * lambda1), 1024.0);
	float l2 = 2.0 * min(sqrt(2.0 * lambda2), 1024.0);
	if (l1 < 2.0 && l2 < 2.0) {
		return false;
	}
	vec2 c = center.proj.ww / viewport;
	if (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {
		return false;
	}
	vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
	vec2 v1 = l1 * diagonalVector;
	vec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);
	corner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;
	corner.uv = source.cornerUV;
	return true;
}
`,TX=`
uniform highp usampler2D transformA;
uniform highp sampler2D transformB;
uint tAw;
vec3 readCenter(SplatSource source) {
	uvec4 tA = texelFetch(transformA, source.uv, 0);
	tAw = tA.w;
	return uintBitsToFloat(tA.xyz);
}
vec4 unpackRotation(vec3 packed) {
	return vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));
}
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	vec4 tB = texelFetch(transformB, source.uv, 0);
	mat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)).wxyz);
	vec3 scale = tB.xyz;
	
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`,EX=`
#include "tonemappingPS"
#include "decodePS"
#include "gammaPS"
vec3 prepareOutputFromGamma(vec3 gammaColor) {
	#if TONEMAP == NONE
		#if GAMMA == NONE
			return decodeGamma(gammaColor);
		#else
			return gammaColor;
		#endif
	#else
		return gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));
	#endif
}
`,AX=`
#ifndef DITHER_NONE
	#include "bayerPS"
	#include "opacityDitherPS"
	varying float id;
#endif
#ifdef PICK_PASS
	#include "pickPS"
#endif
#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
	uniform float alphaClip;
#endif
#ifdef PREPASS_PASS
	varying float vLinearDepth;
	#include "floatAsUintPS"
#endif
varying mediump vec2 gaussianUV;
varying mediump vec4 gaussianColor;
void main(void) {
	mediump float A = dot(gaussianUV, gaussianUV);
	if (A > 1.0) {
		discard;
	}
	mediump float alpha = exp(-A * 4.0) * gaussianColor.a;
	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
		if (alpha < alphaClip) {
			discard;
		}
	#endif
	#ifdef PICK_PASS
		gl_FragColor = getPickOutput();
	#elif SHADOW_PASS
		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
	#elif PREPASS_PASS
		gl_FragColor = float2vec4(vLinearDepth);
	#else
		if (alpha < 1.0 / 255.0) {
			discard;
		}
		#ifndef DITHER_NONE
			opacityDither(alpha, id * 0.013);
		#endif
		gl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);
	#endif
}
`,CX=`
#if SH_BANDS > 0
vec3 unpack111011s(uint bits) {
	return vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;
}
void fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {
	scale = uintBitsToFloat(t.x);
	a = unpack111011s(t.y);
	b = unpack111011s(t.z);
	c = unpack111011s(t.w);
}
void fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {
	a = unpack111011s(t.x);
	b = unpack111011s(t.y);
	c = unpack111011s(t.z);
	d = unpack111011s(t.w);
}
void fetch(in uint t, out vec3 a) {
	a = unpack111011s(t);
}
#if SH_BANDS == 1
	uniform highp usampler2D splatSH_1to3;
	void readSHData(in SplatSource source, out vec3 sh[3], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
	}
#elif SH_BANDS == 2
	uniform highp usampler2D splatSH_1to3;
	uniform highp usampler2D splatSH_4to7;
	uniform highp usampler2D splatSH_8to11;
	void readSHData(in SplatSource source, out vec3 sh[8], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);
		fetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);
	}
#else
	uniform highp usampler2D splatSH_1to3;
	uniform highp usampler2D splatSH_4to7;
	uniform highp usampler2D splatSH_8to11;
	uniform highp usampler2D splatSH_12to15;
	void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);
		fetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);
		fetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);
	}
#endif
#endif
`,wX=`
attribute vec3 vertex_position;
attribute uint vertex_id_attrib;
uniform uint numSplats;
uniform highp usampler2D splatOrder;
bool initSource(out SplatSource source) {
	uint w = uint(textureSize(splatOrder, 0).x);
	source.order = vertex_id_attrib + uint(vertex_position.z);
	if (source.order >= numSplats) {
		return false;
	}
	ivec2 orderUV = ivec2(source.order % w, source.order / w);
	source.id = texelFetch(splatOrder, orderUV, 0).r;
	source.uv = ivec2(source.id % w, source.id / w);
	source.cornerUV = vertex_position.xy;
	return true;
}
`,RX=`
#include "gsplatCommonVS"
varying mediump vec2 gaussianUV;
varying mediump vec4 gaussianColor;
#ifndef DITHER_NONE
	varying float id;
#endif
mediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);
#ifdef PREPASS_PASS
	varying float vLinearDepth;
#endif
void main(void) {
	SplatSource source;
	if (!initSource(source)) {
		gl_Position = discardVec;
		return;
	}
	vec3 modelCenter = readCenter(source);
	SplatCenter center;
	if (!initCenter(modelCenter, center)) {
		gl_Position = discardVec;
		return;
	}
	SplatCorner corner;
	if (!initCorner(source, center, corner)) {
		gl_Position = discardVec;
		return;
	}
	vec4 clr = readColor(source);
	#if GSPLAT_AA
		clr.a *= corner.aaFactor;
	#endif
	#if SH_BANDS > 0
		vec3 dir = normalize(center.view * mat3(center.modelView));
		clr.xyz += evalSH(source, dir);
	#endif
	clipCorner(corner, clr.w);
	gl_Position = center.proj + vec4(corner.offset, 0, 0);
	gaussianUV = corner.uv;
	gaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);
	#ifndef DITHER_NONE
		id = float(source.id);
	#endif
	#ifdef PREPASS_PASS
		vLinearDepth = -center.view.z;
	#endif
}
`,MX=`
		#include "gammaPS"
		varying vec4 color;
		void main(void) {
			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);
		}
`,DX=`
	attribute vec4 vertex_position;
	attribute vec4 vertex_color;
	uniform mat4 matrix_model;
	uniform mat4 matrix_viewProjection;
	varying vec4 color;
	void main(void) {
		color = vertex_color;
		gl_Position = matrix_viewProjection * matrix_model * vertex_position;
	}
`,PX=`
uniform float material_iridescenceRefractionIndex;
#ifndef PI
#define PI 3.14159265
#endif
float iridescence_iorToFresnel(float transmittedIor, float incidentIor) {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
vec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {
	return pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));
}
vec3 iridescence_fresnelToIor(vec3 f0) {
	vec3 sqrtF0 = sqrt(f0);
	return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);
}
vec3 iridescence_sensitivity(float opd, vec3 shift) {
	float phase = 2.0 * PI * opd * 1.0e-9;
	const vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);
	vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);
	xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz /= vec3(1.0685e-07);
	const mat3 XYZ_TO_REC709 = mat3(
		3.2404542, -0.9692660,  0.0556434,
	   -1.5371385,  1.8760108, -0.2040259,
	   -0.4985314,  0.0415560,  1.0572252
	);
	return XYZ_TO_REC709 * xyz;
}
float iridescence_fresnel(float cosTheta, float f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
} 
vec3 iridescence_fresnel(float cosTheta, vec3 f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2; 
	return f0 + (vec3(1.0) - f0) * x5;
}
vec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {
	float iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	float sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	float cosTheta2Sq = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3(1.0);
	}
	float cosTheta2 = sqrt(cosTheta2Sq);
	float r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);
	float r12 = iridescence_fresnel(cosTheta, r0);
	float r21 = r12;
	float t121 = 1.0 - r12;
	float phi12 = iridescenceIor < outsideIor ? PI : 0.0;
	float phi21 = PI - phi12;
	vec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));
	vec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);
	vec3 r23 = iridescence_fresnel(cosTheta2, r1);
	vec3 phi23 = vec3(0.0);
	if (baseIor[0] < iridescenceIor) phi23[0] = PI;
	if (baseIor[1] < iridescenceIor) phi23[1] = PI;
	if (baseIor[2] < iridescenceIor) phi23[2] = PI;
	float opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	vec3 phi = vec3(phi21) + phi23; 
	vec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);
	vec3 r123 = sqrt(r123Sq);
	vec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);
	vec3 c0 = r12 + rs;
	vec3 i = c0;
	vec3 cm = rs - t121;
	for (int m = 1; m <= 2; m++) {
		cm *= r123;
		vec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);
		i += cm * sm;
	}
	return max(i, vec3(0.0));
}
vec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`,LX=`
#ifdef STD_IRIDESCENCE_CONSTANT
uniform float material_iridescence;
#endif
void getIridescence() {
	float iridescence = 1.0;
	#ifdef STD_IRIDESCENCE_CONSTANT
	iridescence *= material_iridescence;
	#endif
	#ifdef STD_IRIDESCENCE_TEXTURE
	iridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};
	#endif
	dIridescence = iridescence; 
}
`,IX=`
uniform float material_iridescenceThicknessMax;
#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
uniform float material_iridescenceThicknessMin;
#endif
void getIridescenceThickness() {
	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
		float blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};
		float iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);
	#else
		float iridescenceThickness = material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`,OX=`
#ifdef STD_IOR_CONSTANT
uniform float material_refractionIndex;
#endif
void getIor() {
#ifdef STD_IOR_CONSTANT
	dIor = material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`,NX=`
#if defined(LIGHT{i})
	uniform vec3 light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL
		uniform vec3 light{i}_direction;
	#else
		#define LIT_CODE_LIGHTS_POINT
		uniform vec3 light{i}_position;
		uniform float light{i}_radius;
		#if LIGHT{i}TYPE == SPOT
			#define LIT_CODE_LIGHTS_SPOT
			uniform vec3 light{i}_direction;
			uniform float light{i}_innerConeAngle;
			uniform float light{i}_outerConeAngle;
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#define LIT_CODE_FALLOFF_SQUARED
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform vec3 light{i}_position;
		#endif
		uniform vec3 light{i}_halfWidth;
		uniform vec3 light{i}_halfHeight;
	#else
		#if LIGHT{i}FALLOFF == LINEAR
			#define LIT_CODE_FALLOFF_LINEAR
		#endif
		#if LIGHT{i}FALLOFF == INVERSESQUARED
			#define LIT_CODE_FALLOFF_SQUARED
		#endif
	#endif
	#if defined(LIGHT{i}CASTSHADOW)
		uniform mat4 light{i}_shadowMatrix;
		uniform float light{i}_shadowIntensity;
		uniform vec4 light{i}_shadowParams;
		#if LIGHT{i}SHADOWTYPE == PCSS_32F
			uniform float light{i}_shadowSearchArea;
			uniform vec4 light{i}_cameraParams;
			#if LIGHT{i}TYPE == DIRECTIONAL
				uniform vec4 light{i}_softShadowParams;
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform mat4 light{i}_shadowMatrixPalette[4];
			uniform vec4 light{i}_shadowCascadeDistances;
			uniform int light{i}_shadowCascadeCount;
			uniform float light{i}_shadowCascadeBlend;
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if defined(LIGHT{i}SHADOW_PCF)
				uniform samplerCubeShadow light{i}_shadowMap;
			#else
				uniform samplerCube light{i}_shadowMap;
			#endif
		#else
			#if defined(LIGHT{i}SHADOW_PCF)
				uniform sampler2DShadow light{i}_shadowMap;
			#else
				uniform sampler2D light{i}_shadowMap;
			#endif
		#endif
	#endif
	#if defined(LIGHT{i}COOKIE)
		#define LIT_CODE_COOKIE
		#if LIGHT{i}TYPE == OMNI
			uniform samplerCube light{i}_cookie;
			uniform float light{i}_cookieIntensity;
			#if !defined(LIGHT{i}CASTSHADOW)
				uniform mat4 light{i}_shadowMatrix;
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			uniform sampler2D light{i}_cookie;
			uniform float light{i}_cookieIntensity;
			#if !defined(LIGHT{i}CASTSHADOW)
				uniform mat4 light{i}_shadowMatrix;
			#endif
			#if defined(LIGHT{i}COOKIE_TRANSFORM)
				uniform vec4 light{i}_cookieMatrix;
				uniform vec2 light{i}_cookieOffset;
			#endif
		#endif
	#endif
#endif
`,FX=`
float getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`,BX=`
void evalOmniLight(vec3 lightPosW, out vec3 lightDirW, out vec3 lightDirNormW) {
	lightDirW = vPositionW - lightPosW;
	lightDirNormW = normalize(lightDirW);
}
`,UX=`
#if defined(LIGHT{i})
	evaluateLight{i}(
		#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel
		#endif
	);
#endif
`,zX=`
#if defined(LIGHT{i})
void evaluateLight{i}(
	#if defined(LIT_IRIDESCENCE)
		vec3 iridescenceFresnel
	#endif
) {
	vec3 lightColor = light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)
		if (all(equal(lightColor, vec3(0.0)))) {
			return;
		}
	#endif
	#if LIGHT{i}TYPE == DIRECTIONAL
		dLightDirNormW = light{i}_direction;
		dAtten = 1.0;
	#else
		
		vec3 lightDirW;
		evalOmniLight(light{i}_position, lightDirW, dLightDirNormW);
		#if defined(LIGHT{i}COOKIE)
			#if LIGHT{i}TYPE == SPOT
				#ifdef LIGHT{i}COOKIE_FALLOFF
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						vec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						vec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#else
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						vec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						vec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#endif
			#endif
			#if LIGHT{i}TYPE == OMNI
				vec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
			#endif
			lightColor *= cookieAttenuation;
		#endif
		#if LIGHT{i}SHAPE == PUNCTUAL
			#if LIGHT{i}FALLOFF == LINEAR
				dAtten = getFalloffLinear(light{i}_radius, lightDirW);
			#else
				dAtten = getFalloffInvSquared(light{i}_radius, lightDirW);
			#endif
		#else
			dAtten = getFalloffWindow(light{i}_radius, lightDirW);
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)
				dAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);
			#endif
		#endif
	#endif
	if (dAtten < 0.00001) {
		return;
	}
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}SHAPE == RECT
			calcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == DISK
			calcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == SPHERE
			calcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}TYPE == DIRECTIONAL
			float attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);
		#else
			#if LIGHT{i}SHAPE == RECT
				float attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == DISK
				float attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == SPHERE
				float attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#endif
		#endif
	#else
		dAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);
	#endif
	#ifdef LIGHT{i}CASTSHADOW
		#if LIGHT{i}TYPE == DIRECTIONAL
			float shadow = getShadow{i}(vec3(0.0));
		#else
			float shadow = getShadow{i}(lightDirW);
		#endif
		shadow = mix(1.0, shadow, light{i}_shadowIntensity);
		dAtten *= shadow;
		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL
			dShadowCatcher *= shadow;
		#endif			
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#ifdef LIT_SPECULAR
			dDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);
		#else
			dDiffuseLight += (attenDiffuse * dAtten) * lightColor;
		#endif						
	#else
		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)
			dDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);
		#else
			dDiffuseLight += dAtten * lightColor;
		#endif
	#endif
	#ifdef LIGHT{i}AFFECT_SPECULARITY
		#if LIGHT{i}SHAPE != PUNCTUAL
			#ifdef LIT_CLEARCOAT
				#if LIGHT{i}SHAPE == RECT
					ccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == DISK
					ccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == SPHERE
					ccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#endif
			#endif
			#ifdef LIT_SPECULAR
				#if LIGHT{i}SHAPE == RECT
					dSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == DISK
					dSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == SPHERE
					dSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#endif
			#endif
		#else
			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE
				#define LIGHT{i}FRESNEL
			#endif
			#ifdef LIT_SPECULAR
				vec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);
			#endif
			#ifdef LIT_CLEARCOAT
				vec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					lightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));
				#endif
				ccSpecularLight += lightspecularCC;
			#endif
			#ifdef LIT_SHEEN
				sSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;
			#endif
			#ifdef LIT_SPECULAR
				vec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					#if defined(LIT_IRIDESCENCE)
						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);
					#else
						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);
					#endif
				#else
					lightSpecular *= litArgs_specularity;
				#endif
				
				dSpecularLight += lightSpecular;
			#endif
		#endif
	#endif
}
#endif
`,kX=`
#ifdef LIGHT{i}CASTSHADOW
	vec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
		vec3 surfacePosition = worldPosition;
		#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT
			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
				float distScale = length(lightDir);
				surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				lightDir = surfacePosition - lightPos;
				return lightDir;
			#endif
		#else
			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					surfacePosition = surfacePosition + normal * shadowParams.y;
				#endif
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
						float distScale = 1.0;
					#else
						float distScale = abs(dot(vPositionW - lightPos, lightDirNorm));
					#endif
					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				#endif
			#endif
			vec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);
			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
					positionInShadowSpace.xyz /= positionInShadowSpace.w;
				#else
					positionInShadowSpace.xy /= positionInShadowSpace.w;
					positionInShadowSpace.z = length(lightDir) * shadowParams.w;
				#endif
			#endif
			surfacePosition = positionInShadowSpace.xyz;
		#endif
		return surfacePosition;
	}
	float getShadow{i}(vec3 lightDirW) {
		#ifdef LIGHT{i}_SHADOW_CASCADES
			int cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);
			#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND
				cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);
			#endif
			mat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];
		#else
			mat4 shadowMatrix = light{i}_shadowMatrix;
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);
		#else
			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			shadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
				#else
					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);
				#endif
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
				#else
					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);
				#endif
				return getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
				#else
					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);
				#endif
				return getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);
			#endif
		#endif
	}
#endif
`,VX=`
#ifdef LIT_CLUSTERED_LIGHTS
	#define LIT_CODE_FALLOFF_LINEAR
	#define LIT_CODE_FALLOFF_SQUARED
	#define LIT_CODE_LIGHTS_POINT
	#define LIT_CODE_LIGHTS_SPOT
#endif
#ifdef AREA_LIGHTS
	uniform highp sampler2D areaLightsLutTex1;
	uniform highp sampler2D areaLightsLutTex2;
#endif
#ifdef LIT_LIGHTING
	#include "lightDiffuseLambertPS"
	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)
		#include "ltcPS"
	#endif
#endif
#ifdef SHADOW_DIRECTIONAL
	#include "shadowCascadesPS"
#endif
#if defined(SHADOW_KIND_PCF1)
	#include "shadowPCF1PS"
#endif
#if defined(SHADOW_KIND_PCF3)
	#include "shadowPCF3PS"
#endif
#if defined(SHADOW_KIND_PCF5)
	#include "shadowPCF5PS"
#endif
#if defined(SHADOW_KIND_PCSS)
	#include "linearizeDepthPS"
	#include "shadowPCSSPS"
	#include "shadowSoftPS"
#endif
#if defined(SHADOW_KIND_VSM)
	#include "shadowEVSMPS"
#endif
#ifdef LIT_CODE_FALLOFF_LINEAR
	#include "falloffLinearPS"
#endif
#ifdef LIT_CODE_FALLOFF_SQUARED
	#include "falloffInvSquaredPS"
#endif
#ifdef LIT_CODE_LIGHTS_POINT
	#include "lightDirPointPS"
#endif
#ifdef LIT_CODE_LIGHTS_SPOT
	#include "spotPS"
#endif
#ifdef LIT_CODE_COOKIE
	#include "cookiePS"
#endif
#ifdef LIT_CLUSTERED_LIGHTS
	#include "clusteredLightPS"
#endif
#ifdef LIGHT_COUNT > 0
	#include "lightFunctionShadowPS, LIGHT_COUNT"
	#include "lightFunctionLightPS, LIGHT_COUNT"
#endif
`,GX=`
void addLightMap(
	vec3 lightmap, 
	vec3 dir, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
	float gloss, 
	vec3 specularity, 
	vec3 vertexNormal, 
	mat3 tbn
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel, 
	float iridescenceIntensity
#endif
) {
	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)
		if (dot(dir, dir) < 0.0001) {
				dDiffuseLight += lightmap;
		} else {
			float vlight = saturate(dot(dir, -vertexNormal));
			float flight = saturate(dot(dir, -worldNormal));
			float nlight = (flight / max(vlight, 0.01)) * 0.5;
			dDiffuseLight += lightmap * nlight * 2.0;
			vec3 halfDir = normalize(-dir + viewDir);
			vec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
			#ifdef LIT_SPECULAR_FRESNEL
				specularLight *= 
					getFresnel(dot(viewDir, halfDir), 
					gloss, 
					specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					iridescenceIntensity
				#endif
					);
			#endif
			dSpecularLight += specularLight;
		}
	#else
		dDiffuseLight += lightmap;
	#endif
}
`,HX=`
#ifdef STD_LIGHTMAP_DIR
	vec3 dLightmapDir;
	uniform sampler2D texture_dirLightMap;
#endif
void getLightMap() {
	dLightmap = vec3(1.0);
	#ifdef STD_LIGHT_TEXTURE
		dLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};
		#ifdef STD_LIGHTMAP_DIR
			vec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;
			float dirDot = dot(dir, dir);
			dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);
		#endif
	#endif
	#ifdef STD_LIGHT_VERTEX
		dLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});
	#endif
}
`,WX=`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {
	float PI = 3.141592653589793;
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	float anisotropy = material_anisotropy * roughness;
 
	float at = max((roughness + anisotropy), roughness / 4.0);
	float ab = max((roughness - anisotropy), roughness / 4.0);
	float NoH = dot(worldNormal, h);
	float ToH = dot(tbn[0], h);
	float BoH = dot(tbn[1], h);
	float a2 = at * ab;
	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);
	float v2 = dot(v, v);
	float w2 = a2 / v2;
	float D = a2 * w2 * w2 * (1.0 / PI);
	float ToV = dot(tbn[0], viewDir);
	float BoV = dot(tbn[1], viewDir);
	float ToL = dot(tbn[0], -lightDirNorm);
	float BoL = dot(tbn[1], -lightDirNorm);
	float NoV = dot(worldNormal, viewDir);
	float NoL = dot(worldNormal, -lightDirNorm);
	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));
	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));
	float G = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`,qX=`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {
	float nh = max( dot( h, worldNormal ), 0.0 );
	float specPow = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, h);
}
`,XX=`
float sheenD(vec3 normal, vec3 h, float roughness) {
	const float PI = 3.141592653589793;
	float invR = 1.0 / (roughness * roughness);
	float cos2h = max(dot(normal, h), 0.0);
	cos2h *= cos2h;
	float sin2h = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
float sheenV(vec3 normal, vec3 viewDir, vec3 light) {
	float NoV = max(dot(normal, viewDir), 0.000001);
	float NoL = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
float getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {
	float D = sheenD(worldNormal, h, sheenGloss);
	float V = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}
`,jX=`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
float linearizeDepth(float z, vec4 cameraParams) {
	if (cameraParams.w == 0.0)
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	else
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
}
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
float linearizeDepth(float z) {
	return linearizeDepth(z, camera_params);
}
#endif
`,YX=`
void evaluateBackend() {
	#ifdef LIT_SSAO
		litArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;
	#endif
	#ifdef LIT_NEEDS_NORMAL
		#ifdef LIT_SPECULAR
			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);
		#endif
		#ifdef LIT_CLEARCOAT
			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));
		#endif
	#endif
	#ifdef LIT_SPECULAR_OR_REFLECTION
		#ifdef LIT_METALNESS
			float f0 = 1.0 / litArgs_ior;
			f0 = (f0 - 1.0) / (f0 + 1.0);
			f0 *= f0;
			litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);
			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);
		#endif
		#ifdef LIT_IRIDESCENCE
			vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);
		#endif
	#endif
	#ifdef LIT_ADD_AMBIENT
		addAmbient(litArgs_worldNormal);
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);
		#endif
		#ifdef LIT_SEPARATE_AMBIENT
			vec3 dAmbientLight = dDiffuseLight;
			dDiffuseLight = vec3(0);
		#endif
	#endif
	#ifndef LIT_OLD_AMBIENT
		dDiffuseLight *= material_ambient;
	#endif
	#ifdef LIT_AO
		#ifndef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
	#endif
	#ifdef LIT_LIGHTMAP
		addLightMap(
			litArgs_lightmap, 
			litArgs_lightmapDir, 
			litArgs_worldNormal, 
			dViewDirW, 
			dReflDirW, 
			litArgs_gloss, 
			litArgs_specularity, 
			dVertexNormalW,
			dTBN
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			litArgs_iridescence_intensity
		#endif
		);
	#endif
	#ifdef LIT_LIGHTING || LIT_REFLECTIONS
		#ifdef LIT_REFLECTIONS
			#ifdef LIT_CLEARCOAT
				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);
			
				#ifdef LIT_SPECULAR_FRESNEL
					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));
					ccReflection.rgb *= ccFresnel;
				#else
					ccFresnel = 0.0;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				ccReflection.rgb *= litArgs_specularityFactor;
			#endif
			#ifdef LIT_SHEEN
				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);
			#endif
			addReflection(dReflDirW, litArgs_gloss);
			#ifdef LIT_FRESNEL_MODEL
				dReflection.rgb *= getFresnel(
					dot(dViewDirW, litArgs_worldNormal), 
					litArgs_gloss, 
					litArgs_specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					litArgs_iridescence_intensity
				#endif
					);
			#else
				dReflection.rgb *= litArgs_specularity;
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				dReflection.rgb *= litArgs_specularityFactor;
			#endif
		#endif
		#ifdef AREA_LIGHTS
			dSpecularLight *= litArgs_specularity;
			#ifdef LIT_SPECULAR
				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);
			#endif
		#endif
		
		#include "lightEvaluationPS, LIGHT_COUNT"
		#ifdef LIT_CLUSTERED_LIGHTS
			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,
				#if defined(LIT_CLEARCOAT)
						ccReflDirW,
				#endif
						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, 
				#if defined(LIT_IRIDESCENCE)
						iridescenceFresnel,
				#endif
						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity
			);
		#endif
		#ifdef AREA_LIGHTS
			#ifdef LIT_CLEARCOAT
				litArgs_clearcoat_specularity = 1.0;
			#endif
			#ifdef LIT_SPECULAR
				litArgs_specularity = vec3(1);
			#endif
		#endif
		#ifdef LIT_REFRACTION
			addRefraction(
				litArgs_worldNormal, 
				dViewDirW, 
				litArgs_thickness, 
				litArgs_gloss, 
				litArgs_specularity, 
				litArgs_albedo, 
				litArgs_transmission,
				litArgs_ior,
				litArgs_dispersion
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel, 
					litArgs_iridescence_intensity
				#endif
			);
		#endif
	#endif
	#ifdef LIT_AO
		#ifdef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
		#if LIT_OCCLUDE_SPECULAR != NONE
			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);
		#endif
	#endif
	#ifdef LIT_SPECULARITY_FACTOR
		dSpecularLight *= litArgs_specularityFactor;
	#endif
	#if !defined(LIT_OPACITY_FADES_SPECULAR)
		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED
			float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));
			#ifdef LIT_CLEARCOAT
				specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));
			#endif
			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);
		#endif
		litArgs_opacity *= material_alphaFade;
	#endif
	#include "endPS"
	#include "outputAlphaPS"
	#ifdef LIT_MSDF
		gl_FragColor = applyMsdf(gl_FragColor);
	#endif
	#include "outputPS"
	#include "debugOutputPS"
	#ifdef LIT_SHADOW_CATCHER
		gl_FragColor.rgb = vec3(dShadowCatcher);
	#endif
}
`,KX=`
vec3 sReflection;
vec3 dVertexNormalW;
vec3 dTangentW;
vec3 dBinormalW;
vec3 dViewDirW;
vec3 dReflDirW;
vec3 ccReflDirW;
vec3 dLightDirNormW;
float dAtten;
mat3 dTBN;
vec4 dReflection;
vec3 dDiffuseLight;
vec3 dSpecularLight;
float ccFresnel;
vec3 ccReflection;
vec3 ccSpecularLight;
float ccSpecularityNoFres;
vec3 sSpecularLight;
#ifdef LIT_DISPERSION
	uniform float material_dispersion;
#endif
#ifndef LIT_OPACITY_FADES_SPECULAR
	uniform float material_alphaFade;
#endif
#ifdef LIT_SSAO
	uniform sampler2D ssaoTexture;
	uniform vec2 ssaoTextureSizeInv;
#endif
#ifdef LIT_SHADOW_CATCHER
	float dShadowCatcher = 1.0;
#endif
#if LIGHT_COUNT > 0
	#include "lightDeclarationPS, LIGHT_COUNT"
#endif
#ifdef LIT_SPECULAR
	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) 
		#define LIT_OLD_AMBIENT
	#endif
#endif
`,QX=`
void main(void) {
	dReflection = vec4(0);
	#ifdef LIT_CLEARCOAT
		ccSpecularLight = vec3(0);
		ccReflection = vec3(0);
	#endif
	#if LIT_NONE_SLICE_MODE == SLICED
		#include "startNineSlicedPS"
	#elif LIT_NONE_SLICE_MODE == TILED
		#include "startNineSlicedTiledPS"
	#endif
	#ifdef LIT_NEEDS_NORMAL
		dVertexNormalW = normalize(vNormalW);
		#ifdef LIT_TANGENTS
			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
				dTangentW = vTangentW;
				dBinormalW = vBinormalW;
			#endif
		#endif
		getViewDir();
		#ifdef LIT_TBN
			getTBN(dTangentW, dBinormalW, dVertexNormalW);
			#ifdef LIT_TWO_SIDED_LIGHTING
				handleTwoSidedLighting();
			#endif
		#endif
	#endif
	evaluateFrontend();
	#include "debugProcessFrontendPS"
	evaluateBackend();
}
`,$X=`
#ifdef LIT_NEEDS_NORMAL
	#include "cubeMapRotatePS"
	#include "cubeMapProjectPS"
	#include "envProcPS"
#endif
#ifdef LIT_SPECULAR_OR_REFLECTION
	#ifdef LIT_METALNESS
		#include "metalnessModulatePS"
	#endif
	#if LIT_FRESNEL_MODEL == SCHLICK
		#include "fresnelSchlickPS"
	#endif
	#ifdef LIT_IRIDESCENCE
		#include "iridescenceDiffractionPS"
	#endif
#endif
#ifdef LIT_AO
	#include "aoDiffuseOccPS"
	#include "aoSpecOccPS"
#endif
#if LIT_REFLECTION_SOURCE == ENVATLASHQ
	#include "envAtlasPS"
	#include "reflectionEnvHQPS"
#elif LIT_REFLECTION_SOURCE == ENVATLAS
	#include "envAtlasPS"
	#include "reflectionEnvPS"
#elif LIT_REFLECTION_SOURCE == CUBEMAP
	#include "reflectionCubePS"
#elif LIT_REFLECTION_SOURCE == SPHEREMAP
	#include "reflectionSpherePS"
#endif
#ifdef LIT_REFLECTIONS
	#ifdef LIT_CLEARCOAT
		#include "reflectionCCPS"
	#endif
	#ifdef LIT_SHEEN
		#include "reflectionSheenPS"
	#endif
#endif
#ifdef LIT_REFRACTION
	#if defined(LIT_DYNAMIC_REFRACTION)
		#include "refractionDynamicPS"
	#elif defined(LIT_REFLECTIONS)
		#include "refractionCubePS"
	#endif
#endif
#ifdef LIT_SHEEN
	#include "lightSheenPS"
#endif
#ifdef LIT_GGX_SPECULAR
	uniform float material_anisotropy;
#endif
uniform vec3 material_ambient;
#ifdef LIT_SPECULAR
	#ifdef LIT_LIGHTING
		#ifdef LIT_GGX_SPECULAR
			#include "lightSpecularAnisoGGXPS"
		#else
			#include "lightSpecularBlinnPS"
		#endif
	#endif
#endif
#include "combinePS"
#ifdef LIT_LIGHTMAP
	#include "lightmapAddPS"
#endif
#ifdef LIT_ADD_AMBIENT
	#include "ambientPS"
#endif
#ifdef LIT_MSDF
	#include "msdfPS"
#endif
#ifdef LIT_NEEDS_NORMAL
	#include "viewDirPS"
	#ifdef LIT_SPECULAR
		#ifdef LIT_GGX_SPECULAR
			#include "reflDirAnisoPS"
		#else
			#include "reflDirPS"
		#endif
	#endif
#endif
#include "lightingPS"
`,ZX=`
#include "basePS"
#include "sphericalPS"
#include "decodePS"
#include "gammaPS"
#include "tonemappingPS"
#include "fogPS"
#if LIT_NONE_SLICE_MODE == SLICED
	#include "baseNineSlicedPS"
#elif LIT_NONE_SLICE_MODE == TILED
	#include "baseNineSlicedTiledPS"
#endif
#ifdef LIT_TBN
	#include "TBNPS"
	#ifdef LIT_TWO_SIDED_LIGHTING
		#include "twoSidedLightingPS"
	#endif
#endif
`,JX=`
#ifdef VERTEX_COLOR
	attribute vec4 vertex_color;
#endif
#ifdef NINESLICED
	varying vec2 vMask;
	varying vec2 vTiledUv;
	uniform mediump vec4 innerOffset;
	uniform mediump vec2 outerScale;
	uniform mediump vec4 atlasRect;
#endif
vec3 dPositionW;
mat4 dModelMatrix;
#include "transformCoreVS"
#ifdef UV0
	attribute vec2 vertex_texCoord0;
	#include "uv0VS"
#endif
#ifdef UV1
	attribute vec2 vertex_texCoord1;
	#include "uv1VS"
#endif
#ifdef LINEAR_DEPTH
	#ifndef VIEWMATRIX
	#define VIEWMATRIX
		uniform mat4 matrix_view;
	#endif
#endif
#include "transformVS"
#ifdef NORMALS
	#include "normalCoreVS"
	#include "normalVS"
#endif
#ifdef TANGENTS
	attribute vec4 vertex_tangent;
	#include "tangentBinormalVS"
#endif
#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"
#ifdef MSDF
	#include "msdfVS"
#endif
void main(void) {
	gl_Position = getPosition();
	vPositionW = getWorldPosition();
	#ifdef NORMALS
		vNormalW = getNormal();
	#endif
	#ifdef TANGENTS
		vTangentW = getTangent();
		vBinormalW = getBinormal();
	#elif defined(GGX_SPECULAR)
		vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));
	#endif
	#ifdef UV0
		vec2 uv0 = getUv0();
		#ifdef UV0_UNMODIFIED
			vUv0 = uv0;
		#endif
	#endif
	#ifdef UV1
		vec2 uv1 = getUv1();
		#ifdef UV1_UNMODIFIED
			vUv1 = uv1;
		#endif
	#endif
	#include "uvTransformVS, UV_TRANSFORMS_COUNT"
	#ifdef VERTEX_COLOR
		vVertexColor = vertex_color;
	#endif
	#ifdef LINEAR_DEPTH
		vLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;
	#endif
	#ifdef MSDF
		unpackMsdfParams();
	#endif
}
`,ej=`
#ifdef PICK_PASS
	#include "pickPS"
#endif
#ifdef PREPASS_PASS
	#include "floatAsUintPS"
#endif
void main(void) {
	evaluateFrontend();
	#ifdef PICK_PASS
		gl_FragColor = getPickOutput();
	#endif
	#ifdef DEPTH_PASS
		gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
	#endif
	#ifdef PREPASS_PASS
		gl_FragColor = float2vec4(vLinearDepth);
	#endif
}
`,tj=`
vec3 litArgs_albedo;
float litArgs_opacity;
vec3 litArgs_emission;
vec3 litArgs_worldNormal;
float litArgs_ao;
vec3 litArgs_lightmap;
vec3 litArgs_lightmapDir;
float litArgs_metalness;
vec3 litArgs_specularity;
float litArgs_specularityFactor;
float litArgs_gloss;
float litArgs_sheen_gloss;
vec3 litArgs_sheen_specularity;
float litArgs_transmission;
float litArgs_thickness;
float litArgs_ior;
float litArgs_dispersion;
float litArgs_iridescence_intensity;
float litArgs_iridescence_thickness;
vec3 litArgs_clearcoat_worldNormal;
float litArgs_clearcoat_specularity;
float litArgs_clearcoat_gloss;
`,sj=`
	#if LIT_NONE_SLICE_MODE == TILED
		const float textureBias = -1000.0;
	#else
		uniform float textureBias;
	#endif
	#include "litShaderArgsPS"
`,ij=`
#if LIGHT_TYPE != DIRECTIONAL
	uniform vec3 view_position;
	uniform float light_radius;
#endif
#if SHADOW_TYPE == PCSS_32F
	#include "linearizeDepthPS"
#endif
void main(void) {
	evaluateFrontend();
	#ifdef PERSPECTIVE_DEPTH
		float depth = gl_FragCoord.z;
		#if SHADOW_TYPE == PCSS_32F
			#if LIGHT_TYPE != DIRECTIONAL
				depth = linearizeDepth(depth, camera_params);
			#endif
		#endif
	#else
		float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);
		#define MODIFIED_DEPTH
	#endif
	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F
		#if SHADOW_TYPE == VSM_32F
			float exponent = 15.0;
		#else
			float exponent = 5.54;
		#endif
		depth = 2.0 * depth - 1.0;
		depth =  exp(exponent * depth);
		gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);
	#else
		#if SHADOW_TYPE == PCSS_32F
			gl_FragColor.r = depth;
		#else
			#ifdef MODIFIED_DEPTH
				gl_FragDepth = depth;
			#endif
			gl_FragColor = vec4(1.0);
		#endif
	#endif
}
`,aj=`
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	vec3 coord0;
	vec3 coord1;
	vec3 coord2;
	vec3 coord3;
};
float LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {
	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;
	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;
	
	vec3 lightNormal = cross( v1, v2 );
	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 =  factor * cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords.coord0 - P );
	coords[ 1 ] = mat * ( rectCoords.coord1 - P );
	coords[ 2 ] = mat * ( rectCoords.coord2 - P );
	coords[ 3 ] = mat * ( rectCoords.coord3 - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
Coords dLTCCoords;
Coords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	Coords coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
float dSphereRadius;
Coords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);
	vec3 w = normalize(cross(f, halfHeight));
	vec3 h = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
vec2 dLTCUV;
#ifdef LIT_CLEARCOAT
vec2 ccLTCUV;
#endif
vec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)
{
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
vec3 dLTCSpecFres;
#ifdef LIT_CLEARCOAT
vec3 ccLTCSpecFres;
#endif
vec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)
{
	vec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);
	return specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;
}
void calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)
{
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); 
#ifdef LIT_CLEARCOAT
	ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));
#endif
}
void calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
void calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
void calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
vec3 SolveCubic(vec4 Coefficient)
{
	float pi = 3.14159;
	Coefficient.xyz /= Coefficient.w;
	Coefficient.yz /= 3.0;
	float A = Coefficient.w;
	float B = Coefficient.z;
	float C = Coefficient.y;
	float D = Coefficient.x;
	vec3 Delta = vec3(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);
	vec3 RootsA, RootsD;
	vec2 xlc, xsc;
	{
		float A_a = 1.0;
		float C_a = Delta.x;
		float D_a = -2.0 * B * Delta.x + Delta.y;
		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;
		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);
		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);
		float xl;
		if ((x_1a + x_3a) > 2.0 * B)
			xl = x_1a;
		else
			xl = x_3a;
		xlc = vec2(xl - B, A);
	}
	{
		float A_d = D;
		float C_d = Delta.z;
		float D_d = -D * Delta.y + 2.0 * C * Delta.z;
		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;
		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);
		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);
		float xs;
		if (x_1d + x_3d < 2.0 * C)
			xs = x_1d;
		else
			xs = x_3d;
		xsc = vec2(-D, xs + C);
	}
	float E =  xlc.y * xsc.y;
	float F = -xlc.x * xsc.y - xlc.y * xsc.x;
	float G =  xlc.x * xsc.x;
	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);
	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z)
		Root.xyz = Root.yxz;
	else if (Root.z < Root.x && Root.z < Root.y)
		Root.xyz = Root.xzy;
	return Root;
}
float LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)
{
	vec3 T1, T2;
	T1 = normalize(V - N * dot(V, N));
	T2 = cross(N, T1);
	mat3 R = transposeMat3( mat3( T1, T2, N ) );
	vec3 L_[ 3 ];
	L_[ 0 ] = R * ( points.coord0 - P );
	L_[ 1 ] = R * ( points.coord1 - P );
	L_[ 2 ] = R * ( points.coord2 - P );
	vec3 Lo_i = vec3(0);
	vec3 C  = 0.5 * (L_[0] + L_[2]);
	vec3 V1 = 0.5 * (L_[1] - L_[2]);
	vec3 V2 = 0.5 * (L_[1] - L_[0]);
	C  = Minv * C;
	V1 = Minv * V1;
	V2 = Minv * V2;
	float a, b;
	float d11 = dot(V1, V1);
	float d22 = dot(V2, V2);
	float d12 = dot(V1, V2);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001)
	{
		float tr = d11 + d22;
		float det = -d12 * d12 + d11 * d22;
		det = sqrt(det);
		float u = 0.5 * sqrt(tr - 2.0 * det);
		float v = 0.5 * sqrt(tr + 2.0 * det);
		float e_max = (u + v) * (u + v);
		float e_min = (u - v) * (u - v);
		vec3 V1_, V2_;
		if (d11 > d22)
		{
			V1_ = d12 * V1 + (e_max - d11) * V2;
			V2_ = d12 * V1 + (e_min - d11) * V2;
		}
		else
		{
			V1_ = d12*V2 + (e_max - d22)*V1;
			V2_ = d12*V2 + (e_min - d22)*V1;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	}
	else
	{
		a = 1.0 / dot(V1, V1);
		b = 1.0 / dot(V2, V2);
		V1 *= sqrt(a);
		V2 *= sqrt(b);
	}
	vec3 V3 = normalize(cross(V1, V2));
	if (dot(C, V3) < 0.0)
		V3 *= -1.0;
	float L  = dot(V3, C);
	float x0 = dot(V1, C) / L;
	float y0 = dot(V2, C) / L;
	float E1 = inversesqrt(a);
	float E2 = inversesqrt(b);
	a *= L * L;
	b *= L * L;
	float c0 = a * b;
	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;
	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);
	float c3 = 1.0;
	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));
	float e1 = roots.x;
	float e2 = roots.y;
	float e3 = roots.z;
	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);
	mat3 rotate = mat3(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	float L1 = sqrt(-e2 / e3);
	float L2 = sqrt(-e2 / e1);
	float formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));
	
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv*LUT_SCALE + LUT_BIAS;
	float scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;
	return formFactor*scale;
}
float FixNan(float value) {
	#ifdef WEBGPU
		return value != value ? 0.0 : value;
	#else
		return isnan(value) ? 0.0 : value;
	#endif
}
float getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));
}
float getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	float falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);
}
mat3 getLTCLightInvMat(vec2 uv)
{
	vec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);
	return mat3(
		vec3( t1.x, 0, t1.y ),
		vec3(	0, 1,	0 ),
		vec3( t1.z, 0, t1.w )
	);
}
float calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
float calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
float getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`,nj=`
#ifdef STD_METALNESS_CONSTANT
uniform float material_metalness;
#endif
void getMetalness() {
	float metalness = 1.0;
	#ifdef STD_METALNESS_CONSTANT
	metalness *= material_metalness;
	#endif
	#ifdef STD_METALNESS_TEXTURE
	metalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_METALNESS_VERTEX
	metalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});
	#endif
	dMetalness = metalness;
}
`,rj=`
uniform sampler2D texture_msdfMap;
float median(float r, float g, float b) {
	return max(min(r, g), min(max(r, g), b));
}
float map (float min, float max, float v) {
	return (v - min) / (max - min);
}
uniform float font_sdfIntensity;
uniform float font_pxrange;
uniform float font_textureWidth;
#ifndef LIT_MSDF_TEXT_ATTRIBUTE
	uniform vec4 outline_color;
	uniform float outline_thickness;
	uniform vec4 shadow_color;
	uniform vec2 shadow_offset;
#else
	varying vec4 outline_color;
	varying float outline_thickness;
	varying vec4 shadow_color;
	varying vec2 shadow_offset;
#endif
vec4 applyMsdf(vec4 color) {
	color.rgb = gammaCorrectInput(color.rgb);
	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;
	vec2 uvShdw = vUv0 - shadow_offset;
	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;
	float sigDist = median(tsample.r, tsample.g, tsample.b);
	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);
	float smoothingMax = 0.2;
	vec2 w = fwidth(vUv0);
	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);
	float mapMin = 0.05;
	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);
	float sigDistInner = map(mapMin, mapMax, sigDist);
	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);
	float center = 0.5;
	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);
	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);
	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);
	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);
	tcolor = mix(tcolor, color, inside);
	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;
	tcolor = mix(scolor, tcolor, outline);
	tcolor.rgb = gammaCorrectOutput(tcolor.rgb);
	
	return tcolor;
}
`,oj=`
vec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {
	vec3 dielectricF0 = f0 * specularity;
	return mix(dielectricF0, albedo, metalness);
}
vec3 getAlbedoModulate(in vec3 albedo, in float metalness) {
	return albedo * (1.0 - metalness);
}
`,lj=`
	color.xyz += morphFactor[{i}] * texture2DLod(morphBlendTex{i}, uv0, 0.0).xyz;
`,hj=`
	uniform highp sampler2D morphBlendTex{i};
`,cj=`
	varying vec2 uv0;
	#include "morphDeclarationPS, MORPH_TEXTURE_COUNT"
	#if MORPH_TEXTURE_COUNT > 0
		uniform highp float morphFactor[{MORPH_TEXTURE_COUNT}];
	#endif
	#ifdef MORPH_INT
		uniform vec3 aabbSize;
		uniform vec3 aabbMin;
	#endif
	void main (void) {
		highp vec4 color = vec4(0, 0, 0, 1);
		#include "morphEvaluationPS, MORPH_TEXTURE_COUNT"
		#ifdef MORPH_INT
			color.xyz = (color.xyz - aabbMin) / aabbSize * 65535.0;
			gl_FragColor = uvec4(color);
		#else
			gl_FragColor = color;
		#endif
	}
`,uj=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
	}
`,dj=`
attribute vec3 vertex_outlineParameters;
attribute vec3 vertex_shadowParameters;
varying vec4 outline_color;
varying float outline_thickness;
varying vec4 shadow_color;
varying vec2 shadow_offset;
void unpackMsdfParams() {
	vec3 little = mod(vertex_outlineParameters, 256.);
	vec3 big = (vertex_outlineParameters - little) / 256.;
	outline_color.rb = little.xy / 255.;
	outline_color.ga = big.xy / 255.;
	outline_thickness = little.z / 255. * 0.2;
	little = mod(vertex_shadowParameters, 256.);
	big = (vertex_shadowParameters - little) / 256.;
	shadow_color.rb = little.xy / 255.;
	shadow_color.ga = big.xy / 255.;
	shadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;
}
`,fj=`
mat3 dNormalMatrix;
vec3 getNormal() {
	dNormalMatrix = getNormalMatrix(dModelMatrix);
	vec3 localNormal = getLocalNormal(vertex_normal);
	return normalize(dNormalMatrix * localNormal);
}
`,pj=`
attribute vec3 vertex_normal;
#ifdef MORPHING_NORMAL
	#ifdef MORPHING_INT
		uniform highp usampler2D morphNormalTex;
	#else
		uniform highp sampler2D morphNormalTex;
	#endif
#endif
vec3 getLocalNormal(vec3 vertexNormal) {
	vec3 localNormal = vertex_normal;
	#ifdef MORPHING_NORMAL
		ivec2 morphUV = getTextureMorphCoords();
		#ifdef MORPHING_INT
			vec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;
		#else
			vec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;
		#endif
		localNormal += morphNormal;
	#endif
	return localNormal;
}
#ifdef SKIN
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#elif defined(INSTANCING)
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#else
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return matrix_normal;
	}
#endif
`,mj=`
#ifdef STD_NORMAL_TEXTURE
uniform float material_bumpiness;
#endif
#ifdef STD_NORMALDETAIL_TEXTURE
uniform float material_normalDetailMapBumpiness;
vec3 blendNormals(vec3 n1, vec3 n2) {
	n1 += vec3(0, 0, 1);
	n2 *= vec3(-1, -1, 1);
	return n1 * dot(n1, n2) / n1.z - n2;
}
#endif
void getNormal() {
#ifdef STD_NORMAL_TEXTURE
	vec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);
	#ifdef STD_NORMALDETAIL_TEXTURE
		vec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));
		normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);
		normalMap = blendNormals(normalMap, normalDetailMap);
	#endif
	dNormalW = normalize(dTBN * normalMap);
#else
	dNormalW = dVertexNormalW;
#endif
}
`,_j=`
uniform float material_opacity;
void getOpacity() {
	dAlpha = material_opacity;
	#ifdef STD_OPACITY_TEXTURE
	dAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_OPACITY_VERTEX
	dAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);
	#endif
}
`,gj=`
#if STD_OPACITY_DITHER == BAYER8
	#include "bayerPS"
#endif
uniform vec4 blueNoiseJitter;
#if STD_OPACITY_DITHER == BLUENOISE
	uniform sampler2D blueNoiseTex32;
#endif
void opacityDither(float alpha, float id) {
	#if STD_OPACITY_DITHER == BAYER8
		float noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;
	#else
		#if STD_OPACITY_DITHER == BLUENOISE
			vec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);
			float noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;
		#endif
		#if STD_OPACITY_DITHER == IGNNOISE
			vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);
			float noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));
		#endif
	#endif
	noise = pow(noise, 2.2);
	if (alpha < noise)
		discard;
}
`,yj=`
`,vj=`
#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)
	gl_FragColor.a = litArgs_opacity;
#elif LIT_BLEND_TYPE == PREMULTIPLIED
	gl_FragColor.rgb *= litArgs_opacity;
	gl_FragColor.a = litArgs_opacity;
#else
	gl_FragColor.a = 1.0;
#endif
`,Sj=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,bj=`
uniform vec3 material_sheen;
void getSheen() {
	vec3 sheenColor = material_sheen;
	#ifdef STD_SHEEN_TEXTURE
	sheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEEN_VERTEX
	sheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});
	#endif
	sSpecularity = sheenColor;
}
`,xj=`
uniform float material_sheenGloss;
void getSheenGlossiness() {
	float sheenGlossiness = material_sheenGloss;
	#ifdef STD_SHEENGLOSS_TEXTURE
	sheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEENGLOSS_VERTEX
	sheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_SHEENGLOSS_INVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sGlossiness = sheenGlossiness + 0.0000001;
}
`,Tj=`
uniform float material_heightMapFactor;
void getParallax() {
	float parallaxScale = material_heightMapFactor;
	float height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};
	height = height * parallaxScale - parallaxScale*0.5;
	vec3 viewDirT = dViewDirW * dTBN;
	viewDirT.z += 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`,Ej=`
varying vec4 texCoordsAlphaLife;
uniform sampler2D colorMap;
uniform sampler2D colorParam;
uniform float graphSampleSize;
uniform float graphNumSamples;
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
uniform float softening;
uniform float colorMult;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
void main(void) {
	vec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));
	vec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));
	ramp.rgb *= colorMult;
	ramp.a += texCoordsAlphaLife.z;
	vec3 rgb = tex.rgb * ramp.rgb;
	float a  = tex.a * ramp.a;
`,Aj=`
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {
	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );
}
vec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex,tc);
	vec4 b = texture2D(tex,tc + graphSampleSize);
	float c = fract(tc.x*graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a, b, c);
}
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY) {
	#ifdef SCREEN_SPACE
		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;
	#else
		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY) {
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
vec2 safeNormalize(vec2 v) {
	float l = length(v);
	return (l > 1e-06) ? v / l : v;
}
void main(void) {
	vec3 meshLocalPos = particle_vertexData.xyz;
	float id = floor(particle_vertexData.w);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	float uv = id / numParticlesPot;
	readInput(uv);
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);
	float particleLifetime = lifetime;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);
	vec2 quadXY = meshLocalPos.xy;
	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	vec3 paramDiv;
	vec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);
	float scale = params.y;
	float scaleDiv = paramDiv.x;
	float alphaDiv = paramDiv.z;
	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);
#ifndef USE_MESH
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#else
	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#endif
	vec3 particlePos = inPos;
	vec3 particlePosMoved = vec3(0.0);
	mat2 rotMatrix;
`,Cj=`
	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);
`,wj=`
	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));
`,Rj=`
	float animationIndex;
	if (animTexIndexParams.y == 1.0) {
		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);
	} else {
		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);
	}
	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;
	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;
	atlasX = fract(atlasX);
	texCoordsAlphaLife.xy *= animTexTilesParams.xy;
	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);
`,Mj=`
void readInput(float uv) {
	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`,Dj=`
#define PI2 6.283185307179586
uniform vec3 inBoundsSize;
uniform vec3 inBoundsCenter;
uniform float maxVel;
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
float decodeFloatRGBA( vec4 rgba ) {
	return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );
}
void readInput(float uv) {
	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));
	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));
	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));
	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3(0.5)) * maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	inLife = decodeFloatRGBA(tex3);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;
}
`,Pj=`
void writeOutput() {
	if (gl_FragCoord.y<1.0) {
		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);
	} else {
		gl_FragColor = vec4(outVel, outLife);
	}
}
`,Lj=`
uniform vec3 outBoundsMul;
uniform vec3 outBoundsAdd;
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
vec4 encodeFloatRGBA( float v ) {
	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;
	enc = fract(enc);
	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);
	return enc;
}
void writeOutput() {
	outPos = outPos * outBoundsMul + outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / maxVel) + vec3(0.5);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (gl_FragCoord.y < 1.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (gl_FragCoord.y < 2.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (gl_FragCoord.y < 3.0) {
		gl_FragColor = vec4(outVel, visMode*0.5+0.5);
	} else {
		gl_FragColor = encodeFloatRGBA(outLife);
	}
}
`,Ij=`
uniform mat3 spawnBounds;
uniform vec3 spawnPosInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	vec3 pos = inBounds - vec3(0.5);
	vec3 posAbs = abs(pos);
	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));
	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;
	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);
	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);
	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);
#ifndef LOCAL_SPACE
	return emitterPos + spawnBounds * pos;
#else
	return spawnBounds * pos;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity -= vec3(0, 0, initialVelocity);
}
`,Oj=`
	writeOutput();
}
`,Nj=`
varying vec2 vUv0;
uniform highp sampler2D particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform highp sampler2D internalTex3;
uniform mat3 emitterMatrix;
uniform mat3 emitterMatrixInv;
uniform vec3 emitterScale;
uniform vec3 emitterPos;
uniform vec3 frameRandom;
uniform vec3 localVelocityDivMult;
uniform vec3 velocityDivMult;
uniform float delta;
uniform float rate;
uniform float rateDiv;
uniform float lifetime;
uniform float numParticles;
uniform float rotSpeedDivMult;
uniform float radialSpeedDivMult;
uniform float seed;
uniform float startAngle;
uniform float startAngle2;
uniform float initialVelocity;
uniform float graphSampleSize;
uniform float graphNumSamples;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
float visMode;
vec3 outPos;
vec3 outVel;
float outAngle;
bool outShow;
float outLife;
`,Fj=`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = -1.0;
	}
`,Bj=`
	visMode = outLife < 0.0? -1.0: visMode;
`,Uj=`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = 1.0;
	}
	visMode = outLife < 0.0? 1.0: visMode;
`,zj=`
uniform float spawnBoundsSphere;
uniform float spawnBoundsSphereInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	float rnd4 = fract(rndFactor * 1000.0);
	vec3 norm = normalize(inBounds.xyz - vec3(0.5));
	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;
#ifndef LOCAL_SPACE
	return emitterPos + norm * r * spawnBoundsSphere;
#else
	return norm * r * spawnBoundsSphere;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;
}
`,kj=`
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
vec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex, tc);
	vec4 b = texture2D(tex, tc + graphSampleSize);
	float c = fract(tc.x * graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a.xyz, b.xyz, c);
}
#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)
vec4 hash41(float p) {
	vec4 p4 = fract(vec4(p) * HASHSCALE4);
	p4 += dot(p4, p4.wzxy+19.19);
	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
void main(void) {
	if (gl_FragCoord.x > numParticles) discard;
	readInput(vUv0.x);
	visMode = inShow? 1.0 : -1.0;
	vec4 rndFactor = hash41(gl_FragCoord.x + seed);
	float particleRate = rate + rateDiv * rndFactor.x;
	outLife = inLife + delta;
	float nlife = clamp(outLife / lifetime, 0.0, 1.0);
	vec3 localVelocityDiv;
	vec3 velocityDiv;
	vec3 paramDiv;
	vec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);
	vec3 velocity =	  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);
	vec3 params =		tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);
	float rotSpeed = params.x;
	float rotSpeedDiv = paramDiv.y;
	vec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);
	float radialSpeed = radialParams.x;
	float radialSpeedDiv = radialParams.y;
	bool respawn = inLife <= 0.0 || outLife >= lifetime;
	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;
	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;
#ifndef LOCAL_SPACE
	vec3 radialVel = inPos - emitterPos;
#else
	vec3 radialVel = inPos;
#endif
	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);
	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;
	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;
	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;
	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(localVelocity, rndFactor.xyz);
#ifndef LOCAL_SPACE
	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;
#else
	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;
#endif
	outPos = inPos + outVel * delta;
	outAngle = inAngle + rotSpeed * delta;
`,Vj=`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = billboard(particlePos, quadXY);
`,Gj=`
	dBlendModeFogFactor = 0.0;
	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;
`,Hj=`
	rgb = mix(vec3(1.0), rgb, vec3(a));
	if (rgb.r + rgb.g + rgb.b > 2.99) discard;
`,Wj=`
	if (a < 0.01) discard;
`,qj=`
attribute vec4 particle_vertexData;
attribute vec4 particle_vertexData2;
attribute vec4 particle_vertexData3;
attribute float particle_vertexData4;
#ifndef USE_MESH
attribute vec2 particle_vertexData5;
#else
attribute vec4 particle_vertexData5;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
uniform float numParticles;
uniform float lifetime;
uniform float stretch;
uniform float seed;
uniform vec3 wrapBounds;
uniform vec3 emitterScale;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
#ifdef PARTICLE_GPU
	uniform highp sampler2D internalTex0;
	uniform highp sampler2D internalTex1;
	uniform highp sampler2D internalTex2;
#endif
uniform vec3 emitterPos;
varying vec4 texCoordsAlphaLife;
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)
{
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
void main(void)
{
	vec3 particlePos = particle_vertexData.xyz;
	vec3 inPos = particlePos;
	vec3 vertPos = particle_vertexData3.xyz;
	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);
	float id = floor(particle_vertexData4);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);
	vec2 quadXY = vertPos.xy;
#ifdef USE_MESH
	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);
#else
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);
#endif
	mat2 rotMatrix;
	float inAngle = particle_vertexData2.x;
	vec3 particlePosMoved = vec3(0.0);
	vec3 meshLocalPos = particle_vertexData3.xyz;
`,Xj=`
	localPos *= particle_vertexData2.y * emitterScale;
	localPos += particlePos;
	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);
`,jj=`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = customFace(particlePos, quadXY);
`,Yj=`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	gl_FragColor = vec4(rgb, a);
}
`,Kj=`
	localPos *= scale * emitterScale;
	localPos += particlePos;
	#ifdef SCREEN_SPACE
	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);
	#else
	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);
	#endif
`,Qj=`
	vec3 negNormal = normal*0.5+0.5;
	vec3 posNormal = -normal*0.5+0.5;
	negNormal *= negNormal;
	posNormal *= posNormal;
`,$j=`
attribute vec4 particle_vertexData;
#ifdef USE_MESH
attribute vec2 particle_uv;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform float numParticles;
uniform float numParticlesPot;
uniform float graphSampleSize;
uniform float graphNumSamples;
uniform float stretch;
uniform vec3 wrapBounds;
uniform vec3 emitterScale;
uniform vec3 emitterPos;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
uniform float rate;
uniform float rateDiv;
uniform float lifetime;
uniform float deltaRandomnessStatic;
uniform float scaleDivMult;
uniform float alphaDivMult;
uniform float seed;
uniform float delta;
uniform sampler2D particleTexOUT;
uniform sampler2D particleTexIN;
#ifdef PARTICLE_GPU
	uniform highp sampler2D internalTex0;
	uniform highp sampler2D internalTex1;
	uniform highp sampler2D internalTex2;
#endif
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
varying vec4 texCoordsAlphaLife;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
`,Zj=`
	vec3 negNormal = max(normal, vec3(0.0));
	vec3 posNormal = max(-normal, vec3(0.0));
`,Jj=`
	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +
						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +
						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];
	rgb *= light;
`,eY=`
	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;
`,tY=`
	vec3 localPos = meshLocalPos;
	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);
	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);
	billboard(particlePos, quadXY);
`,sY=`
	Normal = normalize(localPos + matrix_viewInverse[2].xyz);
`,iY=`
	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);
	vec3 normal = ParticleMat * normalMap;
`,aY=`
	inAngle = atan(velocityV.x, velocityV.y);
`,nY=`
	#include "particleUpdaterInitPS"
	#ifdef PACK8
		#include "particleInputRgba8PS"
		#include "particleOutputRgba8PS"
	#else
		#include "particleInputFloatPS"
		#include "particleOutputFloatPS"
	#endif
	#ifdef EMITTERSHAPE_BOX
		#include "particleUpdaterAABBPS"
	#else
		#include "particleUpdaterSpherePS"
	#endif
	#include "particleUpdaterStartPS"
	#ifdef RESPAWN
		#include "particleUpdaterRespawnPS"
	#endif
	#ifdef NO_RESPAWN
		#include "particleUpdaterNoRespawnPS"
	#endif
	#ifdef ON_STOP
		#include "particleUpdaterOnStopPS"
	#endif
	#include "particleUpdaterEndPS"
`,rY=`
	#if NORMAL != NONE
		#if NORMAL == VERTEX
			varying vec3 Normal;
		#endif
		#if NORMAL == MAP
			varying mat3 ParticleMat;
		#endif
		uniform vec3 lightCube[6];
	#endif
	#ifdef SOFT
		varying float vDepth;
		#include "screenDepthPS"
	#endif
	#include "gammaPS"
	#include "tonemappingPS"
	#include "fogPS"
	#if NORMAL == MAP
		uniform sampler2D normalMap;
	#endif
	#include "particlePS"
	#ifdef SOFT
		#include "particle_softPS"
	#endif
	#if NORMAL == VERTEX
		vec3 normal = Normal;
	#endif
	#if NORMAL == MAP
		#include "particle_normalMapPS"
	#endif
	#if NORMAL != NONE
		#ifdef HALF_LAMBERT
			#include "particle_halflambertPS"
		#else
			#include "particle_lambertPS"
		#endif
		#include "particle_lightingPS"
	#endif
	#if BLEND == NORMAL
		#include "particle_blendNormalPS"
	#elif BLEND == ADDITIVE
		#include "particle_blendAddPS"
	#elif BLEND == MULTIPLICATIVE
		#include "particle_blendMultiplyPS"
	#endif
	#include "particle_endPS"
`,oY=`
	#ifdef ANIMTEX
		uniform vec2 animTexTilesParams;
		uniform vec4 animTexParams;
		uniform vec2 animTexIndexParams;
	#endif
	#if NORMAL == MAP
		varying mat3 ParticleMat;
	#endif
	#if NORMAL == VERTEX
		varying vec3 Normal;
	#endif
	#ifdef SOFT
		varying float vDepth;
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_initVS"
		#ifdef PACK8
			#include "particleInputRgba8PS"
		#else
			#include  "particleInputFloatPS"
		#endif
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particleVS"
	#else
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particle_cpuVS"
	#endif
	#ifdef LOCAL_SPACE
		#include "particle_localShiftVS"
	#endif
	#ifdef ANIMTEX
		#ifdef ANIMTEX_LOOP
			#include "particleAnimFrameLoopVS"
		#else
			#include "particleAnimFrameClampVS"
		#endif
		#include "particleAnimTexVS"
	#endif
	#ifdef PARTICLE_GPU
		#ifdef WRAP
			#include "particle_wrapVS"
		#endif
	#endif
	#ifdef ALIGN_TO_MOTION
		#include "particle_pointAlongVS"
	#endif
	#ifdef USE_MESH
		#include "particle_meshVS"
	#else
		#ifdef CUSTOM_FACE
			#include "particle_customFaceVS"
		#else
			#include "particle_billboardVS"
		#endif
	#endif
	#if NORMAL == VERTEX
		#include "particle_normalVS"
	#endif
	#if NORMAL == MAP
		#include "particle_TBNVS"
	#endif
	#ifdef STRETCH
		#include "particle_stretchVS"
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_endVS"
	#else
		#include "particle_cpu_endVS"
	#endif
	#ifdef SOFT
		#include "particle_softVS"
	#endif
	}
`,lY=`
	float depth = getLinearScreenDepth();
	float particleDepth = vDepth;
	float depthDiff = saturate(abs(particleDepth - depth) * softening);
	a *= depthDiff;
`,hY=`
	vDepth = getLinearDepth(localPos);
`,cY=`
	vec3 moveDir = inVel * stretch;
	vec3 posPrev = particlePos - moveDir;
	posPrev += particlePosMoved;
	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);
	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`,uY=`
	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);
	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;
`,dY=`
	vec3 origParticlePos = particlePos;
	particlePos -= matrix_model[3].xyz;
	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;
	particlePos += matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`,fY=`
uniform uint meshInstanceId;
vec4 getPickOutput() {
	const vec4 inv = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);
	const uvec4 shifts = uvec4(16, 8, 0, 24);
	uvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);
	return vec4(col) * inv;
}
`,pY=`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`,mY=`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	float roughness = sqrt(1.0 - min(gloss, 1.0));
	float anisotropy = material_anisotropy * roughness;
	vec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];
	vec3 anisotropicTangent = cross(anisotropicDirection, viewDir);
	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);
	vec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));
	dReflDirW = reflect(-viewDir, bentNormal);
}
`,_Y=`
#ifdef LIT_CLEARCOAT
void addReflectionCC(vec3 reflDir, float gloss) {
	ccReflection += calcReflection(reflDir, gloss);
}
#endif
`,gY=`
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 lookupVec = cubeMapProject(reflDir);
	lookupVec.x *= -1.0;
	return {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,yY=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float flevel = level - ilevel;
	vec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));
	vec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));
	vec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,vY=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
uniform float material_reflectivity;
float shinyMipLevel(vec2 uv) {
	vec2 dx = dFdx(uv);
	vec2 dy = dFdy(uv);
	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);
	vec2 dx2 = dFdx(uv2);
	vec2 dy2 = dFdy(uv2);
	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);
}
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float level2 = shinyMipLevel(uv * atlasSize);
	float ilevel2 = floor(level2);
	vec2 uv0, uv1;
	float weight;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = uv1 = mapRoughnessUv(uv, ilevel);
		weight = 0.0;
	}
	vec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));
	vec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));
	vec3 linear0 = mix(linearA, linearB, weight);
	vec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,SY=`
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform sampler2D texture_sphereMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;
	float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );
	vec2 sphereMapUv = reflDirV.xy / m + 0.5;
	return {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,bY=`
void addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {
	float NoV = dot(worldNormal, viewDir);
	float alphaG = gloss * gloss;
	float a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;
	float b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;
	float DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );
	sReflection += calcReflection(worldNormal, 0.0) * saturate(DG);
}
`,xY=`
vec3 refract2(vec3 viewVec, vec3 normal, float IOR) {
	float vn = dot(viewVec, normal);
	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);
	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex,
	float dispersion
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif 
) {
	vec4 tmpRefl = dReflection;
	vec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4(0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`,TY=`
uniform float material_invAttenuationDistance;
uniform vec3 material_attenuation;
vec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {
	vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);
	vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;
	vec2 uv = getGrabScreenPos(projectionPoint);
	float iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
	float refractionLod = log2(uScreenSize.x) * iorToRoughness;
	vec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;
	return refraction;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex,
	float dispersion
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif
) {
	vec3 modelScale;
	modelScale.x = length(vec3(matrix_model[0].xyz));
	modelScale.y = length(vec3(matrix_model[1].xyz));
	modelScale.z = length(vec3(matrix_model[2].xyz));
	vec3 scale = thickness * modelScale;
	vec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;
	vec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);
	#ifdef LIT_DISPERSION
		float halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;
		float refractionIndexR = refractionIndex - halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;
		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;
		float refractionIndexB = refractionIndex + halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;
		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;
	#endif
	vec3 transmittance;
	if (material_invAttenuationDistance != 0.0)
	{
		vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = refraction;
	}
	vec3 fresnel = vec3(1.0) - 
		getFresnel(
			dot(viewDir, worldNormal), 
			gloss, 
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`,EY=`
varying vec2 vUv0;
#ifdef CUBEMAP_SOURCE
	uniform samplerCube sourceCube;
#else
	uniform sampler2D sourceTex;
#endif
#ifdef USE_SAMPLES_TEX
	uniform sampler2D samplesTex;
	uniform vec2 samplesTexInverseSize;
#endif
uniform vec3 params;
float targetFace() { return params.x; }
float targetTotalPixels() { return params.y; }
float sourceTotalPixels() { return params.z; }
float PI = 3.141592653589793;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
#include "decodePS"
#include "encodePS"
vec3 modifySeams(vec3 dir, float scale) {
	vec3 adir = abs(dir);
	float M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3(
		adir.x == M ? 1.0 : scale,
		adir.y == M ? 1.0 : scale,
		adir.z == M ? 1.0 : scale
	);
}
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec3 fromSpherical(vec2 uv) {
	return vec3(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
vec3 getDirectionEquirect() {
	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));
}
float signNotZero(float k){
	return(k >= 0.0) ? 1.0 : -1.0;
}
vec2 signNotZero(vec2 v) {
	return vec2(signNotZero(v.x), signNotZero(v.y));
}
vec3 octDecode(vec2 o) {
	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);
	}
	return normalize(v);
}
vec3 getDirectionOctahedral() {
	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);
}
vec2 octEncode(in vec3 v) {
	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	vec2 result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	vec4 sampleCubemap(vec3 dir) {
		return textureCube(sourceCube, modifySeams(dir, 1.0));
	}
	vec4 sampleCubemap(vec2 sph) {
		return sampleCubemap(fromSpherical(sph));
	}
	vec4 sampleCubemap(vec3 dir, float mipLevel) {
		return textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);
	}
	vec4 sampleCubemap(vec2 sph, float mipLevel) {
		return sampleCubemap(fromSpherical(sph), mipLevel);
	}
#else
	vec4 sampleEquirect(vec2 sph) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleEquirect(vec3 dir) {
		return sampleEquirect(toSpherical(dir));
	}
	vec4 sampleEquirect(vec2 sph, float mipLevel) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleEquirect(vec3 dir, float mipLevel) {
		return sampleEquirect(toSpherical(dir), mipLevel);
	}
	vec4 sampleOctahedral(vec3 dir) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleOctahedral(vec2 sph) {
		return sampleOctahedral(fromSpherical(sph));
	}
	vec4 sampleOctahedral(vec3 dir, float mipLevel) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleOctahedral(vec2 sph, float mipLevel) {
		return sampleOctahedral(fromSpherical(sph), mipLevel);
	}
#endif
vec3 getDirectionCubemap() {
	vec2 st = vUv0 * 2.0 - 1.0;
	float face = targetFace();
	vec3 vec;
	if (face == 0.0) {
		vec = vec3(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3(st.x, -st.y, 1);
	} else {
		vec = vec3(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0));
}
mat3 matrixFromVector(vec3 n) {
	float a = 1.0 / (1.0 + n.z);
	float b = -n.x * n.y * a;
	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3(b1, b2, n);
}
mat3 matrixFromVectorSlow(vec3 n) {
	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);
	vec3 x = normalize(cross(up, n));
	vec3 y = cross(n, x);
	return mat3(x, y, n);
}
vec4 reproject() {
	if ({NUM_SAMPLES} <= 1) {
		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));
	} else {
		vec3 t = {TARGET_FUNC}();
		vec3 tu = dFdx(t);
		vec3 tv = dFdy(t);
		vec3 result = vec3(0.0);
		for (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {
			for (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {
				result += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +
															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +
															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));
			}
		}
		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));
	}
}
vec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	void unpackSample(int i, out vec3 L, out float mipLevel) {
		float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;
		float v = (floor(u) + 0.5) * samplesTexInverseSize.y;
		vec4 raw;
		raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);
		L.xyz = raw.xyz * 2.0 - 1.0;
		mipLevel = raw.w * 8.0;
	}
	vec4 prefilterSamples() {
		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < {NUM_SAMPLES}; ++i) {
			unpackSample(i, L, mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return {ENCODE_FUNC}(result / totalWeight);
	}
	vec4 prefilterSamplesUnweighted() {
		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < {NUM_SAMPLES}; ++i) {
			unpackSample(i, L, mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));
		}
		return {ENCODE_FUNC}(result / float({NUM_SAMPLES}));
	}
#endif
void main(void) {
	gl_FragColor = {PROCESS_FUNC}();
}
`,AY=`
attribute vec2 vertex_position;
uniform vec4 uvMod;
varying vec2 vUv0;
void main(void) {
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);
}
`,CY=`
vec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {
	vec2 samplePos = uv * texSize;
	vec2 texPos1 = floor(samplePos - 0.5) + 0.5;
	vec2 f = samplePos - texPos1;
	vec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));
	vec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);
	vec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));
	vec2 w3 = f * f * (-0.5 + 0.5 * f);
	vec2 w12 = w1 + w2;
	vec2 offset12 = w2 / (w1 + w2);
	vec2 texPos0 = (texPos1 - 1.0) / texSize;
	vec2 texPos3 = (texPos1 + 2.0) / texSize;
	vec2 texPos12 = (texPos1 + offset12) / texSize;
	vec4 result = vec4(0.0);
	result += texture2DLod(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result += texture2DLod(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result += texture2DLod(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`,wY=`
uniform highp sampler2D uSceneDepthMap;
#ifndef SCREENSIZE
#define SCREENSIZE
uniform vec4 uScreenSize;
#endif
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
#ifndef LINEARIZE_DEPTH
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
#define LINEARIZE_DEPTH
float linearizeDepth(float z) {
	if (camera_params.w == 0.0)
		return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));
	else
		return camera_params.z + z * (camera_params.y - camera_params.z);
}
#endif
float delinearizeDepth(float linearDepth) {
	if (camera_params.w == 0.0) {
		return (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));
	} else {
		return (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);
	}
}
float getLinearScreenDepth(vec2 uv) {
	#ifdef SCENE_DEPTHMAP_LINEAR
		#ifdef SCENE_DEPTHMAP_FLOAT
			return texture2D(uSceneDepthMap, uv).r;
		#else
			ivec2 textureSize = textureSize(uSceneDepthMap, 0);
			ivec2 texel = ivec2(uv * vec2(textureSize));
			vec4 data = texelFetch(uSceneDepthMap, texel, 0);
			uint intBits = 
				(uint(data.r * 255.0) << 24u) |
				(uint(data.g * 255.0) << 16u) |
				(uint(data.b * 255.0) << 8u) |
				uint(data.a * 255.0);
			return uintBitsToFloat(intBits);
		#endif
	#else
		return linearizeDepth(texture2D(uSceneDepthMap, uv).r);
	#endif
}
#ifndef VERTEXSHADER
float getLinearScreenDepth() {
	vec2 uv = gl_FragCoord.xy * uScreenSize.zw;
	return getLinearScreenDepth(uv);
}
#endif
float getLinearDepth(vec3 pos) {
	return -(matrix_view * vec4(pos, 1.0)).z;
}
`,RY=`
int getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {
	float depth = 1.0 / gl_FragCoord.w;
	vec4 comparisons = step(shadowCascadeDistances, vec4(depth));
	int cascadeIndex = int(dot(comparisons, vec4(1.0)));
	return min(cascadeIndex, shadowCascadeCount - 1);
}
int ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {
 
	if (cascadeIndex < shadowCascadeCount - 1) {
		float currentRangeEnd = shadowCascadeDistances[cascadeIndex];
		float transitionStart = blendFactor * currentRangeEnd;
		float depth = 1.0 / gl_FragCoord.w;
		if (depth > transitionStart) {
			float transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);
			float dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);
			if (dither < transitionFactor) {
				cascadeIndex += 1;
			}
		}
	}
	return cascadeIndex;
}
vec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {				  
	float depth = 1.0 / gl_FragCoord.w;
	if (depth > shadowCascadeDistances.w) {
		shadowCoord.z = -9999999.0;
	}
	return shadowCoord;
}
`,MY=`
float linstep(float a, float b, float v) {
	return saturate((v - a) / (b - a));
}
float reduceLightBleeding(float pMax, float amount) {
	 return linstep(amount, 1.0, pMax);
}
float chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {
	float variance = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	float d = mean - moments.x;
	float pMax = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return (mean <= moments.x ? 1.0 : pMax);
}
float calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {
	Z = 2.0 * Z - 1.0;
	float warpedDepth = exp(exponent * Z);
	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);
	float VSMBias = vsmBias;
	float depthScale = VSMBias * exponent * warpedDepth;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);
}
float VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {
	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
float VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE
		vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;
	#else
		float pixelSize = 1.0 / resolution;
		texCoords -= vec2(pixelSize);
		vec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;
		vec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;
		vec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;
		vec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;
		vec2 fr = fract(texCoords * resolution);
		vec3 h0 = mix(s00, s10, fr.x);
		vec3 h1 = mix(s01, s11, fr.x);
		vec3 moments = mix(h0, h1, fr.y);
	#endif
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {
	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
`,DY=`
float getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
float getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#ifndef WEBGPU
float getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	return texture(shadowMap, vec4(lightDir, shadowZ));
}
#endif
`,PY=`
float _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float sum = 0.0;
	float uw0 = (3.0 - 2.0 * s);
	float uw1 = (1.0 + 2.0 * s);
	float u0 = (2.0 - s) / uw0 - 1.0;
	float u1 = s / uw1 + 1.0;
	float vw0 = (3.0 - 2.0 * t);
	float vw1 = (1.0 + 2.0 * t);
	float v0 = (2.0 - t) / vw0 - 1.0;
	float v1 = t / vw1 + 1.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum *= 1.0f / 16.0;
	return sum;
}
float getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
#ifndef WEBGPU
float getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {
	
	float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
	float z = 1.0 / float(textureSize(shadowMap, 0));
	vec3 tc = normalize(dir);
	mediump vec4 shadows;
	shadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));
	shadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));
	shadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));
	shadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));
	return dot(shadows, vec4(0.25));
}
float getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	return getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);
}
#endif
`,LY=`
float _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float uw0 = (4.0 - 3.0 * s);
	float uw1 = 7.0;
	float uw2 = (1.0 + 3.0 * s);
	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;
	float u1 = (3.0 + s) / uw1;
	float u2 = s / uw2 + 2.0;
	float vw0 = (4.0 - 3.0 * t);
	float vw1 = 7.0;
	float vw2 = (1.0 + 3.0 * t);
	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;
	float v1 = (3.0 + t) / vw1;
	float v2 = t / vw2 + 2.0;
	float sum = 0.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	u2 = u2 * shadowMapSizeInv + base_uv.x;
	v2 = v2 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));
	sum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));
	sum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));
	sum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));
	sum *= 1.0f / 144.0;
	sum = saturate(sum);
	return sum;
}
float getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
`,IY=`
#define PCSS_SAMPLE_COUNT 16
uniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];
uniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];
vec2 vogelDisk(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float sine = sin(theta);
	float cosine = cos(theta);
	return vec2(r * cosine, r * sine);
}
vec3 vogelSphere(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float weight = float(sampleIndex) / count;
	return vec3(cos(theta) * r, weight, sin(theta) * r);
}
float noise(vec2 screenPos) {
	const float PHI = 1.61803398874989484820459;
	return fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);
}
float viewSpaceDepth(float depth, mat4 invProjection) {
	float z = depth * 2.0 - 1.0;
	vec4 clipSpace = vec4(0.0, 0.0, z, 1.0);
	vec4 viewSpace = invProjection * clipSpace;
	return viewSpace.z;
}
float PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec2 offset = sampleCoords[i] * searchSize;
		vec2 sampleUV = shadowCoords + offset;
		float blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker / blockers;
	return -1.0;
}
float PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {
	float receiverDepth = linearizeDepth(shadowCoords.z, cameraParams);
	vec2 samplePoints[PCSS_SAMPLE_COUNT];
	const float PI = 3.141592653589793;
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float pcssPresample = pcssDiskSamples[i];
		samplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);
	}
	float averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float depthDifference = (receiverDepth - averageBlocker) / 3.0;
		vec2 filterRadius = depthDifference * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)
		{
			vec2 sampleUV = samplePoints[i] * filterRadius;
			sampleUV = shadowCoords.xy + sampleUV;
			float depth = texture2DLod(shadowMap, sampleUV, 0.0).r;
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	} 
}
#ifndef WEBGPU
float PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;
		sampleDir = normalize(sampleDir);
		float blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker / blockers;
	return -1.0;
}
float PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {
	
	vec3 samplePoints[PCSS_SAMPLE_COUNT];
	const float PI = 3.141592653589793;
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float r = pcssSphereSamples[i];
		samplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);
	}
	float receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 lightDirNorm = normalize(lightDir);
	
	float averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i++)
		{
			vec3 offset = samplePoints[i] * filterRadius;
			vec3 sampleDir = lightDirNorm + offset;
			sampleDir = normalize(sampleDir);
			float depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	}
}
float getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);
}
#endif
float getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);
}
`,OY=`
highp float fractSinRand( const in vec2 uv ) {
	const float PI = 3.141592653589793;
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);
	return fract(sin(sn) * c);
}
struct VogelDiskData {
	float invNumSamples;
	float initialAngle;
	float currentPointId;
};
void prepareDiskConstants(out VogelDiskData data, int sampleCount, int numRings, float randomSeed) {
	const float pi2 = 6.28318530718;
	data.invNumSamples = 1.0 / float(sampleCount);
	data.initialAngle = randomSeed * pi2;
	data.currentPointId = 0.0;
}
#define GOLDEN_ANGLE 2.399963
vec2 generateDiskSample(inout VogelDiskData data) {
	float r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);
	float theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;
	vec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);
	data.currentPointId += 1.0;
	return offset;
}
void PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,
	vec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {
	VogelDiskData diskData;
	prepareDiskConstants(diskData, shadowBlockerSamples, 11, randomSeed);
	float searchWidth = penumbraSize * invShadowMapSize;
	float blockerSum = 0.0;
	numBlockers = 0;
	for( int i = 0; i < shadowBlockerSamples; ++i ) {
		vec2 diskUV = generateDiskSample(diskData);
		vec2 sampleUV = shadowCoords + diskUV * searchWidth;
		float shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;
		if ( shadowMapDepth < z ) {
			blockerSum += shadowMapDepth;
			numBlockers++;
		}
	}
	avgBlockerDepth = blockerSum / float(numBlockers);
}
float PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {
	VogelDiskData diskData;
	prepareDiskConstants(diskData, shadowSamples, 11, randomSeed);
	float sum = 0.0;
	for (int i = 0; i < shadowSamples; i++) {
		vec2 offsetUV = generateDiskSample(diskData) * filterRadius;
		float depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;
		sum += step(receiverDepth, depth);
	}
	return sum / float(shadowSamples);
}
float getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {
	float dist = dreceiver - dblocker;
	float penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);
	return penumbra * penumbraSize;
}
float PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {
	float receiverDepth = shadowCoords.z;
	float randomSeed = fractSinRand(gl_FragCoord.xy);
	int shadowSamples = int(softShadowParams.x);
	int shadowBlockerSamples = int(softShadowParams.y);
	float penumbraSize = softShadowParams.z;
	float penumbraFalloff = softShadowParams.w;
	int shadowMapSize = textureSize(shadowMap, 0).x;
	float invShadowMapSize = 1.0 / float(shadowMapSize);
	invShadowMapSize *= float(shadowMapSize) / 2048.0;
	float penumbra;
	if (shadowBlockerSamples > 0) {
		float avgBlockerDepth = 0.0;
		int numBlockers = 0;
		PCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);
		if (numBlockers < 1)
			return 1.0f;
		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);
	} else {
		penumbra = penumbraSize;
	}
	float filterRadius = penumbra * invShadowMapSize;
	return PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);
}
float getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {
	return PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);
}
`,NY=`
attribute float vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
mat4 getBoneMatrix(const in float indexFloat) {
	int width = textureSize(texture_poseMap, 0).x;
	int index = int(indexFloat + 0.5) * 3;
	int iy = index / width;
	int ix = index % width;
	vec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);
	vec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);
	vec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,FY=`
attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
void getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {
	int v = index / width;
	int u = index % width;
	v1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);
	v2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);
	v3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);
}
mat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {
	int width = textureSize(texture_poseMap, 0).x;
	ivec4 indices = ivec4(indicesFloat + 0.5) * 3;
	vec4 a1, a2, a3;
	getBoneMatrix(width, indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(width, indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(width, indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(width, indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,BY=`
	#define LIT_SKYBOX_INTENSITY
	#include "envProcPS"
	#include "gammaPS"
	#include "tonemappingPS"
	varying vec3 vViewDir;
	uniform float skyboxHighlightMultiplier;
	#ifdef SKY_CUBEMAP
		uniform samplerCube texture_cubeMap;
		#ifdef SKYMESH
			varying vec3 vWorldPos;
			uniform mat3 cubeMapRotationMatrix;
			uniform vec3 projectedSkydomeCenter;
		#endif
	#else
		#include "sphericalPS"
		#include "envAtlasPS"
		uniform sampler2D texture_envAtlas;
		uniform float mipLevel;
	#endif
	void main(void) {
		#ifdef SKY_CUBEMAP
			#ifdef SKYMESH
				vec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);
				vec3 dir = envDir * cubeMapRotationMatrix;
			#else
				vec3 dir = vViewDir;
			#endif
			dir.x *= -1.0;
			vec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));
		#else
			vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);
			vec2 uv = toSphericalUv(normalize(dir));
			vec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));
		#endif
		if (any(greaterThanEqual(linear, vec3(64.0)))) {
			linear *= skyboxHighlightMultiplier;
		}
		gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
	}
`,UY=`
attribute vec4 aPosition;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform mat4 matrix_projectionSkybox;
uniform mat3 cubeMapRotationMatrix;
varying vec3 vViewDir;
#ifdef SKYMESH
	uniform mat4 matrix_model;
	varying vec3 vWorldPos;
#endif
void main(void) {
	mat4 view = matrix_view;
	#ifdef SKYMESH
		vec4 worldPos = matrix_model * aPosition;
		vWorldPos = worldPos.xyz;
		gl_Position = matrix_projectionSkybox * (view * worldPos);
	#else
		view[3][0] = view[3][1] = view[3][2] = 0.0;
		gl_Position = matrix_projectionSkybox * (view * aPosition);
		vViewDir = aPosition.xyz * cubeMapRotationMatrix;
	#endif
	gl_Position.z = gl_Position.w - 1.0e-7;
}
`,zY=`
#ifdef STD_SPECULAR_CONSTANT
uniform vec3 material_specular;
#endif
void getSpecularity() {
	vec3 specularColor = vec3(1,1,1);
	#ifdef STD_SPECULAR_CONSTANT
	specularColor *= material_specular;
	#endif
	#ifdef STD_SPECULAR_TEXTURE
	specularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULAR_VERTEX
	specularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});
	#endif
	dSpecularity = specularColor;
}
`,kY=`
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec2 toSphericalUv(vec3 dir) {
	const float PI = 3.141592653589793;
	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;
	return vec2(uv.x, 1.0 - uv.y);
}
`,VY=`
#ifdef STD_SPECULARITYFACTOR_CONSTANT
uniform float material_specularityFactor;
#endif
void getSpecularityFactor() {
	float specularityFactor = 1.0;
	#ifdef STD_SPECULARITYFACTOR_CONSTANT
	specularityFactor *= material_specularityFactor;
	#endif
	#ifdef STD_SPECULARITYFACTOR_TEXTURE
	specularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULARITYFACTOR_VERTEX
	specularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});
	#endif
	dSpecularityFactor = specularityFactor;
}
`,GY=`
float getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {
	float cosAngle = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}
`,HY=`
	nineSlicedUv = vUv0;
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
`,WY=`
	vec2 tileMask = step(vMask, vec2(0.99999));
	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);
	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);
	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
	
`,qY=`
	float dAlpha = 1.0;
	#if defined(LIT_ALPHA_TEST)
		#include "alphaTestPS"
	#endif
	#if STD_OPACITY_DITHER != NONE
		#include "opacityDitherPS"
	#endif
	#ifdef FORWARD_PASS
		vec3 dAlbedo;
		vec3 dNormalW;
		vec3 dSpecularity = vec3(0.0);
		float dGlossiness = 0.0;
		#ifdef LIT_REFRACTION
			float dTransmission;
			float dThickness;
		#endif
		#ifdef LIT_SCENE_COLOR
			uniform sampler2D uSceneColorMap;
		#endif
		#ifdef LIT_SCREEN_SIZE
			uniform vec4 uScreenSize;
		#endif
		#ifdef LIT_TRANSFORMS
			uniform mat4 matrix_viewProjection;
			uniform mat4 matrix_model;
		#endif
		#ifdef STD_HEIGHT_MAP
			vec2 dUvOffset;
			#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
				uniform sampler2D texture_heightMap;
			#endif
		#endif
		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
			uniform sampler2D texture_diffuseMap;
		#endif
		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE
			uniform sampler2D texture_diffuseDetailMap;
		#endif
		#ifdef STD_NORMAL_TEXTURE_ALLOCATE
			uniform sampler2D texture_normalMap;
		#endif
		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE
			uniform sampler2D texture_normalDetailMap;
		#endif
		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE
			uniform sampler2D texture_thicknessMap;
		#endif
		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE
			uniform sampler2D texture_refractionMap;
		#endif
		#ifdef LIT_IRIDESCENCE
			float dIridescence;
			float dIridescenceThickness;
			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE
				uniform sampler2D texture_iridescenceThicknessMap;
			#endif
			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE
				uniform sampler2D texture_iridescenceMap;
			#endif
		#endif
		#ifdef LIT_CLEARCOAT
			float ccSpecularity;
			float ccGlossiness;
			vec3 ccNormalW;
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				vec3 sSpecularity;
				float sGlossiness;
				#ifdef STD_SHEEN_TEXTURE_ALLOCATE
					uniform sampler2D texture_sheenMap;
				#endif
				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE
					uniform sampler2D texture_sheenGlossMap;
				#endif
			#endif
			#ifdef LIT_METALNESS
				float dMetalness;
				float dIor;
				#ifdef STD_METALNESS_TEXTURE_ALLOCATE
					uniform sampler2D texture_metalnessMap;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				float dSpecularityFactor;
				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE
					uniform sampler2D texture_specularityFactorMap;
				#endif
			#endif
			#ifdef STD_SPECULAR_COLOR
				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE
					uniform sampler2D texture_specularMap;
				#endif
			#endif
			#ifdef STD_GLOSS_TEXTURE_ALLOCATE
				uniform sampler2D texture_glossMap;
			#endif
		#endif
		#ifdef STD_AO
			float dAo;
			#ifdef STD_AO_TEXTURE_ALLOCATE
				uniform sampler2D texture_aoMap;
			#endif
			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE
				uniform sampler2D texture_aoDetailMap;
			#endif
		#endif
		vec3 dEmission;
		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE
			uniform sampler2D texture_emissiveMap;
		#endif
		#ifdef LIT_CLEARCOAT
			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatMap;
			#endif
			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatGlossMap;
			#endif
			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatNormalMap;
			#endif
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			vec3 dLightmap;
			#ifdef STD_LIGHT_TEXTURE_ALLOCATE
				uniform sampler2D texture_lightMap;
			#endif
		#endif
	#endif
	#include "litShaderCorePS"
`,XY=`
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#ifdef STD_OPACITY_TEXTURE_ALLOCATE
			uniform sampler2D texture_opacityMap;
		#endif
		#include "opacityPS"
	#endif
	#ifdef FORWARD_PASS
		#ifdef STD_HEIGHT_MAP
			#include "parallaxPS"
		#endif
		#include  "diffusePS"
		#ifdef LIT_NEEDS_NORMAL
			#include "normalMapPS"
		#endif
		#ifdef LIT_REFRACTION
			#include "transmissionPS"
			#include "thicknessPS"
		#endif
		#ifdef LIT_IRIDESCENCE
			#include "iridescencePS"
			#include "iridescenceThicknessPS"
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				#include "sheenPS"
				#include "sheenGlossPS"
			#endif
			#ifdef LIT_METALNESS
				#include "metalnessPS"
				#include "iorPS"
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				#include "specularityFactorPS"
			#endif
			#ifdef STD_SPECULAR_COLOR
				#include "specularPS"
			#else
				void getSpecularity() { 
					dSpecularity = vec3(1);
				}
			#endif
			#include "glossPS"
		#endif
		#ifdef STD_AO
			#include "aoPS"
		#endif
		#include "emissivePS"
		#ifdef LIT_CLEARCOAT
			#include "clearCoatPS"
			#include "clearCoatGlossPS"
			#include "clearCoatNormalPS"
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			#include "lightmapPS"
		#endif
	#endif
	void evaluateFrontend() {
		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
			getOpacity();
			#if defined(LIT_ALPHA_TEST)
				alphaTest(dAlpha);
			#endif
			#if STD_OPACITY_DITHER != NONE
				opacityDither(dAlpha, 0.0);
			#endif
			litArgs_opacity = dAlpha;
		#endif
		#ifdef FORWARD_PASS
			#ifdef STD_HEIGHT_MAP
				getParallax();
			#endif
			getAlbedo();
			litArgs_albedo = dAlbedo;
			#ifdef LIT_NEEDS_NORMAL
				getNormal();
				litArgs_worldNormal = dNormalW;
			#endif
			#ifdef LIT_REFRACTION
				getRefraction();
				litArgs_transmission = dTransmission;
				getThickness();
				litArgs_thickness = dThickness;
				#ifdef LIT_DISPERSION
					litArgs_dispersion = material_dispersion;
				#endif
			#endif
			#ifdef LIT_IRIDESCENCE
				getIridescence();
				getIridescenceThickness();
				litArgs_iridescence_intensity = dIridescence;
				litArgs_iridescence_thickness = dIridescenceThickness;
			#endif
			#ifdef LIT_SPECULAR_OR_REFLECTION
				#ifdef LIT_SHEEN
					getSheen();
					litArgs_sheen_specularity = sSpecularity;
					getSheenGlossiness();
					litArgs_sheen_gloss = sGlossiness;
				#endif
				#ifdef LIT_METALNESS
					getMetalness();
					litArgs_metalness = dMetalness;
					getIor();
					litArgs_ior = dIor;
				#endif
				#ifdef LIT_SPECULARITY_FACTOR
					getSpecularityFactor();
					litArgs_specularityFactor = dSpecularityFactor;
				#endif
				getGlossiness();
				getSpecularity();
				litArgs_specularity = dSpecularity;
				litArgs_gloss = dGlossiness;
			#endif
			#ifdef STD_AO
				getAO();
				litArgs_ao = dAo;
			#endif
			getEmission();
			litArgs_emission = dEmission;
			#ifdef LIT_CLEARCOAT
				getClearCoat();
				getClearCoatGlossiness();
				getClearCoatNormal();
				litArgs_clearcoat_specularity = ccSpecularity;
				litArgs_clearcoat_gloss = ccGlossiness;
				litArgs_clearcoat_worldNormal = ccNormalW;
			#endif
			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
				getLightMap();
				litArgs_lightmap = dLightmap;
				#ifdef STD_LIGHTMAP_DIR
					litArgs_lightmapDir = dLightmapDir;
				#endif
			#endif
		#endif
	}
`,jY=`
vec3 getTangent() {
	return normalize(dNormalMatrix * vertex_tangent.xyz);
}
vec3 getBinormal() {
	return cross(vNormalW, vTangentW) * vertex_tangent.w;
}
`,YY=`
#ifdef LIT_TANGENTS
	#define TBN_TANGENTS
#else
	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
		#define TBN_DERIVATIVES
	#endif
#endif
#if defined(TBN_DERIVATIVES)
	uniform float tbnBasis;
#endif
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	#ifdef TBN_TANGENTS
		dTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));
	#elif defined(TBN_DERIVATIVES)
		vec2 uv = {lightingUv};
		vec3 dp1 = dFdx( vPositionW );
		vec3 dp2 = dFdy( vPositionW );
		vec2 duv1 = dFdx( uv );
		vec2 duv2 = dFdy( uv );
		vec3 dp2perp = cross( dp2, normal );
		vec3 dp1perp = cross( normal, dp1 );
		vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;
		vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;
		float denom = max( dot(T,T), dot(B,B) );
		float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );
		dTBN = mat3(T * invmax, -B * invmax, normal );
	#else
		vec3 B = cross(normal, vObjectSpaceUpW);
		vec3 T = cross(normal, B);
		if (dot(B,B)==0.0)
		{
			float major=max(max(normal.x, normal.y), normal.z);
			if (normal.x == major)
			{
				B = cross(normal, vec3(0,1,0));
				T = cross(normal, B);
			}
			else if (normal.y == major)
			{
				B = cross(normal, vec3(0,0,1));
				T = cross(normal, B);
			}
			else if (normal.z == major)
			{
				B = cross(normal, vec3(1,0,0));
				T = cross(normal, B);
			}
		}
		dTBN = mat3(normalize(T), normalize(B), normalize(normal));
	#endif
}
`,KY=`
#ifdef STD_THICKNESS_CONSTANT
uniform float material_thickness;
#endif
void getThickness() {
	dThickness = 1.0;
	#ifdef STD_THICKNESS_CONSTANT
	dThickness *= material_thickness;
	#endif
	#ifdef STD_THICKNESS_TEXTURE
	dThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_THICKNESS_VERTEX
	dThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});
	#endif
}
`,QY=`
#if (TONEMAP == NONE)
	#include "tonemappingNonePS"
#elif TONEMAP == FILMIC
	#include "tonemappingFilmicPS"
#elif TONEMAP == LINEAR
	#include "tonemappingLinearPS"
#elif TONEMAP == HEJL
	#include "tonemappingHejlPS"
#elif TONEMAP == ACES
	#include "tonemappingAcesPS"
#elif TONEMAP == ACES2
	#include "tonemappingAces2PS"
#elif TONEMAP == NEUTRAL
	#include "tonemappingNeutralPS"
#endif
`,$Y=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	float tA = 2.51;
	float tB = 0.03;
	float tC = 2.43;
	float tD = 0.59;
	float tE = 0.14;
	vec3 x = color * exposure;
	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);
}
`,ZY=`
uniform float exposure;
const mat3 ACESInputMat = mat3(
	0.59719, 0.35458, 0.04823,
	0.07600, 0.90834, 0.01566,
	0.02840, 0.13383, 0.83777
);
const mat3 ACESOutputMat = mat3(
	 1.60475, -0.53108, -0.07367,
	-0.10208,  1.10813, -0.00605,
	-0.00327, -0.07276,  1.07602
);
vec3 RRTAndODTFit(vec3 v) {
	vec3 a = v * (v + 0.0245786) - 0.000090537;
	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;
	return a / b;
}
vec3 toneMap(vec3 color) {
	color *= exposure / 0.6;
	color = color * ACESInputMat;
	color = RRTAndODTFit(color);
	color = color * ACESOutputMat;
	color = clamp(color, 0.0, 1.0);
	return color;
}
`,JY=`
const float A =  0.15;
const float B =  0.50;
const float C =  0.10;
const float D =  0.20;
const float E =  0.02;
const float F =  0.30;
const float W =  11.2;
uniform float exposure;
vec3 uncharted2Tonemap(vec3 x) {
	 return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
}
vec3 toneMap(vec3 color) {
	color = uncharted2Tonemap(color * exposure);
	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));
	color = color * whiteScale;
	return color;
}
`,eK=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;
	const float Scl = 1.25;
	vec3 h = max( vec3(0.0), color - vec3(0.004) );
	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);
}
`,tK=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	return color * exposure;
}
`,sK=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	float startCompression = 0.8 - 0.04;
	float desaturation = 0.15;
	float x = min(color.r, min(color.g, color.b));
	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;
	color -= offset;
	float peak = max(color.r, max(color.g, color.b));
	if (peak < startCompression) return color;
	float d = 1. - startCompression;
	float newPeak = 1. - d * d / (peak + d - startCompression);
	color *= newPeak / peak;
	float g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);
	return mix(color, newPeak * vec3(1, 1, 1), g);
}
`,iK=`
vec3 toneMap(vec3 color) {
	return color;
}
`,aK=`
#ifdef PIXELSNAP
uniform vec4 uScreenSize;
#endif
#ifdef SCREENSPACE
uniform float projectionFlipY;
#endif
vec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {
	vec3 localPos = getLocalPosition(vertexPosition);
	#ifdef NINESLICED
		localPos.xz *= outerScale;
		vec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));
		vec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));
		localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
		vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;
		localPos.xz *= -0.5;
		localPos = localPos.xzy;
	#endif
	vec4 posW = modelMatrix * vec4(localPos, 1.0);
	#ifdef SCREENSPACE
		posW.zw = vec2(0.0, 1.0);
	#endif
	return posW;
}
vec4 getPosition() {
	dModelMatrix = getModelMatrix();
	vec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);
	dPositionW = posW.xyz;
	vec4 screenPos;
	#ifdef UV1LAYOUT
		screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);
		#ifdef WEBGPU
			screenPos.y *= -1.0;
		#endif
	#else
		#ifdef SCREENSPACE
			screenPos = posW;
			screenPos.y *= projectionFlipY;
		#else
			screenPos = matrix_viewProjection * posW;
		#endif
		#ifdef PIXELSNAP
			screenPos.xy = (screenPos.xy * 0.5) + 0.5;
			screenPos.xy *= uScreenSize.xy;
			screenPos.xy = floor(screenPos.xy);
			screenPos.xy *= uScreenSize.zw;
			screenPos.xy = (screenPos.xy * 2.0) - 1.0;
		#endif
	#endif
	return screenPos;
}
vec3 getWorldPosition() {
	return dPositionW;
}
`,nK=`
attribute vec4 vertex_position;
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
#ifdef MORPHING
	uniform vec2 morph_tex_params;
	attribute uint morph_vertex_id;
	ivec2 getTextureMorphCoords() {
		ivec2 textureSize = ivec2(morph_tex_params);
		int morphGridV = int(morph_vertex_id) / textureSize.x;
		int morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);
		#ifdef WEBGPU
			morphGridV = textureSize.y - morphGridV - 1;
		#endif
		return ivec2(morphGridU, morphGridV);
	}
	#ifdef MORPHING_POSITION
		#ifdef MORPHING_INT
			uniform vec3 aabbSize;
			uniform vec3 aabbMin;
			uniform usampler2D morphPositionTex;
		#else
			uniform highp sampler2D morphPositionTex;
		#endif
	#endif
#endif
#ifdef defined(BATCH)
	#include "skinBatchVS"
	mat4 getModelMatrix() {
		return getBoneMatrix(vertex_boneIndices);
	}
#elif defined(SKIN)
	#include "skinVS"
	mat4 getModelMatrix() {
		return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
	}
#elif defined(INSTANCING)
	#include "transformInstancingVS"
#else
	mat4 getModelMatrix() {
		return matrix_model;
	}
#endif
vec3 getLocalPosition(vec3 vertexPosition) {
	vec3 localPos = vertexPosition;
	#ifdef MORPHING_POSITION
		ivec2 morphUV = getTextureMorphCoords();
		#ifdef MORPHING_INT
			vec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;
		#else
			vec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;
		#endif
		localPos += morphPos;
	#endif
	return localPos;
}
`,rK=`
attribute vec4 instance_line1;
attribute vec4 instance_line2;
attribute vec4 instance_line3;
attribute vec4 instance_line4;
mat4 getModelMatrix() {
	return matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);
}
`,oK=`
#ifdef STD_REFRACTION_CONSTANT
uniform float material_refraction;
#endif
void getRefraction() {
	float refraction = 1.0;
	#ifdef STD_REFRACTION_CONSTANT
	refraction = material_refraction;
	#endif
	#ifdef STD_REFRACTION_TEXTURE
	refraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_REFRACTION_VERTEX
	refraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});
	#endif
	dTransmission = refraction;
}
`,lK=`
uniform float twoSidedLightingNegScaleFactor;
void handleTwoSidedLighting() {
	dTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;
}
`,hK=`
#ifdef NINESLICED
	vec2 getUv0() {
		vec2 uv = vertex_position.xz;
		vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
		vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
		uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
		uv = uv * -0.5 + 0.5;
		uv = uv * atlasRect.zw + atlasRect.xy;
		vMask = vertex_texCoord0.xy;
		return uv;
	}
#else
	vec2 getUv0() {
		return vertex_texCoord0;
	}
#endif
`,cK=`
vec2 getUv1() {
	return vertex_texCoord1;
}
`,uK=`
vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(
	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),
	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)
);
`,dK=`
	uniform vec3 {TRANSFORM_NAME_{i}}0;
	uniform vec3 {TRANSFORM_NAME_{i}}1;
`,fK=`
void getViewDir() {
	dViewDirW = normalize(view_position - vPositionW);
}
`;const dt={alphaTestPS:Aq,ambientPS:Cq,aoPS:wq,aoDiffuseOccPS:Rq,aoSpecOccPS:Mq,basePS:Dq,baseNineSlicedPS:Pq,baseNineSlicedTiledPS:Lq,bayerPS:Iq,blurVSMPS:Oq,clearCoatPS:Nq,clearCoatGlossPS:Fq,clearCoatNormalPS:Bq,clusteredLightCookiesPS:zq,clusteredLightShadowsPS:kq,clusteredLightUtilsPS:Uq,clusteredLightPS:Vq,combinePS:Gq,cookieBlit2DPS:Hq,cookieBlitCubePS:Wq,cookieBlitVS:qq,cookiePS:Xq,cubeMapProjectPS:jq,cubeMapRotatePS:Yq,debugOutputPS:Kq,debugProcessFrontendPS:Qq,detailModesPS:Zq,diffusePS:Jq,decodePS:$q,emissivePS:eX,encodePS:tX,endPS:sX,envAtlasPS:iX,envProcPS:aX,falloffInvSquaredPS:nX,falloffLinearPS:rX,floatAsUintPS:oX,fogPS:lX,fresnelSchlickPS:hX,fullscreenQuadPS:cX,fullscreenQuadVS:uX,gammaPS:dX,gles3PS:uB,gles3VS:dB,glossPS:fX,gsplatCenterVS:pX,gsplatCornerVS:xX,gsplatColorVS:mX,gsplatCommonVS:_X,gsplatCompressedDataVS:gX,gsplatCompressedSHVS:yX,gsplatSogsColorVS:vX,gsplatSogsDataVS:SX,gsplatSogsSHVS:bX,gsplatDataVS:TX,gsplatOutputVS:EX,gsplatPS:AX,gsplatSHVS:CX,gsplatSourceVS:wX,gsplatVS:RX,immediateLinePS:MX,immediateLineVS:DX,iridescenceDiffractionPS:PX,iridescencePS:LX,iridescenceThicknessPS:IX,iorPS:OX,lightBufferDefinesPS:"",lightDeclarationPS:NX,lightDiffuseLambertPS:FX,lightDirPointPS:BX,lightEvaluationPS:UX,lightFunctionLightPS:zX,lightFunctionShadowPS:kX,lightingPS:VX,lightmapAddPS:GX,lightmapPS:HX,lightSpecularAnisoGGXPS:WX,lightSpecularBlinnPS:qX,lightSheenPS:XX,linearizeDepthPS:jX,litForwardBackendPS:YX,litForwardDeclarationPS:KX,litForwardMainPS:QX,litForwardPostCodePS:$X,litForwardPreCodePS:ZX,litMainVS:JX,litOtherMainPS:ej,litShaderArgsPS:tj,litShaderCorePS:sj,litShadowMainPS:ij,ltcPS:aj,metalnessPS:nj,metalnessModulatePS:oj,morphEvaluationPS:lj,morphDeclarationPS:hj,morphPS:cj,morphVS:uj,msdfPS:rj,msdfVS:dj,normalVS:fj,normalCoreVS:pj,normalMapPS:mj,opacityPS:_j,opacityDitherPS:gj,outputPS:yj,outputAlphaPS:vj,outputTex2DPS:Sj,sheenPS:bj,sheenGlossPS:xj,parallaxPS:Tj,particlePS:Ej,particleVS:Aj,particleAnimFrameClampVS:Cj,particleAnimFrameLoopVS:wj,particleAnimTexVS:Rj,particleInputFloatPS:Mj,particleInputRgba8PS:Dj,particleOutputFloatPS:Pj,particleOutputRgba8PS:Lj,particleUpdaterAABBPS:Ij,particleUpdaterEndPS:Oj,particleUpdaterInitPS:Nj,particleUpdaterNoRespawnPS:Fj,particleUpdaterOnStopPS:Bj,particleUpdaterRespawnPS:Uj,particleUpdaterSpherePS:zj,particleUpdaterStartPS:kj,particle_billboardVS:Vj,particle_blendAddPS:Gj,particle_blendMultiplyPS:Hj,particle_blendNormalPS:Wj,particle_cpuVS:qj,particle_cpu_endVS:Xj,particle_customFaceVS:jj,particle_endPS:Yj,particle_endVS:Kj,particle_halflambertPS:Qj,particle_initVS:$j,particle_lambertPS:Zj,particle_lightingPS:Jj,particle_localShiftVS:eY,particle_meshVS:tY,particle_normalVS:sY,particle_normalMapPS:iY,particle_pointAlongVS:aY,particle_simulationPS:nY,particle_shaderPS:rY,particle_shaderVS:oY,particle_softPS:lY,particle_softVS:hY,particle_stretchVS:cY,particle_TBNVS:uY,particle_wrapVS:dY,pickPS:fY,reflDirPS:pY,reflDirAnisoPS:mY,reflectionCCPS:_Y,reflectionCubePS:gY,reflectionEnvHQPS:yY,reflectionEnvPS:vY,reflectionSpherePS:SY,reflectionSheenPS:bY,refractionCubePS:xY,refractionDynamicPS:TY,reprojectPS:EY,reprojectVS:AY,sampleCatmullRomPS:CY,screenDepthPS:wY,shadowCascadesPS:RY,shadowEVSMPS:MY,shadowPCF1PS:DY,shadowPCF3PS:PY,shadowPCF5PS:LY,shadowPCSSPS:IY,shadowSoftPS:OY,skinBatchVS:NY,skinVS:FY,skyboxPS:BY,skyboxVS:UY,specularPS:zY,sphericalPS:kY,specularityFactorPS:VY,spotPS:GY,startNineSlicedPS:HY,startNineSlicedTiledPS:WY,stdDeclarationPS:qY,stdFrontEndPS:XY,tangentBinormalVS:jY,TBNPS:YY,thicknessPS:KY,tonemappingPS:QY,tonemappingAcesPS:$Y,tonemappingAces2PS:ZY,tonemappingFilmicPS:JY,tonemappingHejlPS:eK,tonemappingLinearPS:tK,tonemappingNeutralPS:sK,tonemappingNonePS:iK,transformVS:aK,transformCoreVS:nK,transformInstancingVS:rK,transmissionPS:oK,twoSidedLightingPS:lK,uv0VS:hK,uv1VS:cK,uvTransformVS:uK,uvTransformUniformsPS:dK,viewDirPS:fK,webgpuPS:fB,webgpuVS:pB},IU=new Xn;function Bm(h){return IU.get(h)}function pK(h,e){IU.get(h,()=>e)}class Kc{static definesHash(e){const t=Array.from(e).sort((s,i)=>s[0]>i[0]?1:-1);return sl(JSON.stringify(t))}}const mK=new Xn;class _K{constructor(e,t,s={}){this.defines=new Map,this.name=e,this.index=t,Object.assign(this,s),this.buildShaderDefines()}buildShaderDefines(){let e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":this.index===_x?e="DEPTH":this.index===ry&&(e="PICK"),this.defines.set(`${e}_PASS`,""),this.defines.set(`${this.name.toUpperCase()}_PASS`,"")}}class cl{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;const e=(t,s,i)=>{this.allocate(t,i)};e("forward",tf,{isForward:!0}),e("prepass"),e("depth"),e("pick"),e("shadow")}static get(e){return mK.get(e,()=>new cl)}allocate(e,t){let s=this.passesNamed.get(e);return s===void 0&&(s=new _K(e,this.nextIndex,t),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}}function gK(h,e,t,s=!1,i={}){return typeof s=="boolean"?i.useTransformFeedback=s:typeof s=="object"&&(i={...i,...s}),new ef(h,da.createDefinition(h,{...i,name:`${e}_${t}`,vertexCode:dt[e],fragmentCode:dt[t]}))}function Da(h,e,t,s,i,a=!1,n={}){typeof a=="boolean"?n.useTransformFeedback=a:typeof a=="object"&&(n={...n,...a});const r=Bm(h);let l=r.getCachedShader(s);return l||(l=new ef(h,da.createDefinition(h,{...n,name:s,vertexCode:e,fragmentCode:t,attributes:i})),r.setCachedShader(s,l)),l}class yK extends Kc{constructor(e,t){super(),this.key=e,this.shaderDefinition=t}generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}}function vK(h,e){const t=h.definition,i=`${t.name??"shader"}-id-${h.id}`,a=new yK(i,t),n="shader",r=Bm(h.device);r.register(n,a);const l=r.getProgram(n,{},e);return r.unregister(n),l}const kC=(h,e)=>{const t=new Map(h.defines);return e.cameraShaderParams.defines.forEach((i,a)=>t.set(a,i)),cl.get(e.device).getByIndex(e.pass).defines.forEach((i,a)=>t.set(a,i)),t},SK={type:hl,base:0,count:4,indexed:!1},Wv=new Ie,qv=new Ie,cR=new eP;class C0{constructor(e){const t=e.device;if(this.shader=e,t.supportsUniformBuffers){const s=new gx;this.shader=vK(e,s);const i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new ox(t,i,!1));const a=this.shader.meshBindGroupFormat;this.bindGroup=new $0(t,a)}}destroy(){var e,t;(e=this.uniformBuffer)==null||e.destroy(),this.uniformBuffer=null,(t=this.bindGroup)==null||t.destroy(),this.bindGroup=null}render(e,t){const s=this.shader.device;e&&(Wv.set(s.vx,s.vy,s.vw,s.vh),qv.set(s.sx,s.sy,s.sw,s.sh),t=t??e,s.setViewport(e.x,e.y,e.z,e.w),s.setScissor(t.x,t.y,t.z,t.w)),s.setVertexBuffer(s.quadVertexBuffer,0);const i=this.shader;if(s.setShader(i),s.supportsUniformBuffers){s.setBindGroup(Qb,s.emptyBindGroup);const a=this.bindGroup;a.update(),s.setBindGroup(Q0,a);const n=this.uniformBuffer;n?(n.update(cR),s.setBindGroup(um,cR.bindGroup,cR.offsets)):s.setBindGroup(um,s.emptyBindGroup)}s.draw(SK),e&&(s.setViewport(Wv.x,Wv.y,Wv.z,Wv.w),s.setScissor(qv.x,qv.y,qv.z,qv.w))}}class bK extends pa{constructor(e,t,s,i){super(e),this.quad=t,this.rect=s,this.scissorRect=i}execute(){const{device:e}=this;e.setCullMode(Xs),e.setDepthState($i.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}}const xK=new Ie;function qn(h,e,t,s,i){const a=new C0(t);s||(s=xK,s.x=0,s.y=0,s.z=e?e.width:h.width,s.w=e?e.height:h.height);const n=new bK(h,a,s,i);n.init(e),n.colorOps.clear=!1,n.depthStencilOps.clearDepth=!1,h.isWebGPU&&e===null&&h.samples>1&&(n.colorOps.store=!0),n.render(),a.destroy()}class i3{constructor(e,t,s){this._aabb=new wt,this.meshInstance=null,this.origMeshInstances=e,this.dynamic=t,this.batchGroupId=s}destroy(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy(),this.meshInstance=null)}addToLayers(e,t){for(let s=0;s<t.length;s++){const i=e.layers.getLayerById(t[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(e,t){for(let s=0;s<t.length;s++){const i=e.layers.getLayerById(t[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}get model(){}}const qg=class qg{constructor(e,t,s,i,a=[Ph]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=e,this.name=t,this.dynamic=s,this.maxAabbSize=i,this.layers=a}};qg.MODEL="model",qg.ELEMENT="element",qg.SPRITE="sprite",qg.RENDER="render";let zi=qg;const aO=new Me;class oy{constructor(e){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){const s=t*3;let i=Math.ceil(Math.sqrt(s));i=ge.roundUp(i,3);const a=Math.ceil(s/i);this.boneTexture=new Ge(e,{width:i,height:a,format:Ri,mipmaps:!1,minFilter:Je,magFilter:Je,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:FD}),this.boneTexture.unlock()}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;const s=this.skin,i=[];for(let a=0;a<s.boneNames.length;a++){const n=s.boneNames[a];let r=e.findByName(n);r||(r=t),i.push(r)}this.bones=i}initSkin(e){this.skin=e,this.bones=[];const t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let s=0;s<t;s++)this.matrices[s]=new Me}uploadBones(e){this.boneTexture.upload()}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,aO.copy(e.getWorldTransform()).invert();for(let s=this.bones.length-1;s>=0;s--)this.matrices[s].mulAffine2(aO,this.bones[s].getWorldTransform()),this.matrices[s].mulAffine2(this.matrices[s],this.skin.inverseBindPose[s])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);const s=this.matrixPalette,i=this.bones.length;for(let a=0;a<i;a++){const n=this.matrices[a].data,r=a*12;s[r]=n[0],s[r+1]=n[4],s[r+2]=n[8],s[r+3]=n[12],s[r+4]=n[1],s[r+5]=n[5],s[r+6]=n[9],s[r+7]=n[13],s[r+8]=n[2],s[r+9]=n[6],s[r+10]=n[10],s[r+11]=n[14]}this.uploadBones(this.skin.device)}}class a3 extends oy{constructor(e,t,s){super();const i=t.length;this.init(e,i),this.device=e,this.rootNode=s,this.bones=t}updateMatrices(e,t){}updateMatrixPalette(e,t){const s=this.matrixPalette,i=this.bones.length;for(let a=0;a<i;a++){const n=this.bones[a].getWorldTransform().data,r=a*12;s[r]=n[0],s[r+1]=n[4],s[r+2]=n[8],s[r+3]=n[12],s[r+4]=n[1],s[r+5]=n[5],s[r+6]=n[9],s[r+7]=n[13],s[r+8]=n[2],s[r+9]=n[6],s[r+10]=n[10],s[r+11]=n[14]}this.uploadBones(this.device)}}let TK=0;const Xg=class Xg{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=_r,this.indicesUsage=_r,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}};Xg.DEFAULT_COMPONENTS_POSITION=3,Xg.DEFAULT_COMPONENTS_NORMAL=3,Xg.DEFAULT_COMPONENTS_UV=2,Xg.DEFAULT_COMPONENTS_COLORS=4;let ld=Xg;class EK{constructor(e,t,s,i,a){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i,this.asInt=a}}class Ft extends _C{constructor(e,t){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new wt,this._geometryData=null,this._morph=null,this._storageIndex=!1,this._storageVertex=!1,this.id=TK++,this.device=e,this._storageIndex=(t==null?void 0:t.storageIndex)||!1,this._storageVertex=(t==null?void 0:t.storageVertex)||!1}static fromGeometry(e,t,s={}){const i=new Ft(e,s),{positions:a,normals:n,tangents:r,colors:l,uvs:u,uvs1:f,blendIndices:_,blendWeights:g,indices:y}=t;return a&&i.setPositions(a),n&&i.setNormals(n),r&&i.setVertexStream(po,r,4),l&&i.setColors32(l),u&&i.setUvs(0,u),f&&i.setUvs(1,f),_&&i.setVertexStream(gn,_,4,_.length/4,io),g&&i.setVertexStream(co,g,4),y&&i.setIndices(y),i.update(),i}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++}get aabb(){return this._aabb}destroy(){const e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){this.boneAabb=[],this.boneUsed=[];let t,s,i,a,n;const r=[],l=[],u=this.boneUsed,f=this.skin.boneNames.length;let _,g,y;for(let R=0;R<f;R++)r[R]=new H(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l[R]=new H(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const v=new i0(this.vertexBuffer),x=v.element[kt],C=v.element[co],M=v.element[gn],w=this.vertexBuffer.numVertices;for(let R=0;R<w;R++){for(let D=0;D<4;D++)if(C.array[C.index+D]>0){const U=M.array[M.index+D];if(u[U]=!0,t=x.array[x.index],s=x.array[x.index+1],i=x.array[x.index+2],a=l[U],n=r[U],n.x>t&&(n.x=t),n.y>s&&(n.y=s),n.z>i&&(n.z=i),a.x<t&&(a.x=t),a.y<s&&(a.y=s),a.z<i&&(a.z=i),e){let O=_=t,N=g=s,z=y=i;for(let X=0;X<e.length;X++){const Y=e[X],F=Y.deltaPositions[R*3],q=Y.deltaPositions[R*3+1],G=Y.deltaPositions[R*3+2];F<0?O+=F:_+=F,q<0?N+=q:g+=q,G<0?z+=G:y+=G}n.x>O&&(n.x=O),n.y>N&&(n.y=N),n.z>z&&(n.z=z),a.x<_&&(a.x=_),a.y<g&&(a.y=g),a.z<y&&(a.z=y)}}v.next()}const T=this.vertexBuffer.getFormat().elements.find(R=>R.name===kt);if(T&&T.normalize){const R=(()=>{switch(T.dataType){case ml:return D=>Math.max(D/127,-1);case io:return D=>D/255;case _l:return D=>Math.max(D/32767,-1);case Dh:return D=>D/65535;default:return D=>D}})();for(let D=0;D<f;D++)if(u[D]){const I=r[D],U=l[D];I.set(R(I.x),R(I.y),R(I.z)),U.set(R(U.x),R(U.y),R(U.z))}}for(let R=0;R<f;R++){const D=new wt;D.setMinMax(r[R],l[R]),this.boneAabb.push(D)}}_initGeometryData(){this._geometryData||(this._geometryData=new ld,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=e?_r:Ob,this._geometryData.indicesUsage=t?_r:Ob}setVertexStream(e,t,s,i,a=it,n=!1,r=!1){this._initGeometryData();const l=i||t.length/s;this._geometryData._changeVertexCount(l,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new EK(t,s,a,n,r)}getVertexStream(e,t){let s=0,i=!1;if(this._geometryData){const a=this._geometryData.vertexStreamDictionary[e];a&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(a.data):(t.length=0,t.push(a.data)))}return i||this.vertexBuffer&&(s=new i0(this.vertexBuffer).readData(e,t)),s}setPositions(e,t=ld.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(kt,e,t,s,it,!1)}setNormals(e,t=ld.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream($a,e,t,s,it,!1)}setUvs(e,t,s=ld.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(VM+e,t,s,i,it,!1)}setColors(e,t=ld.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(Qi,e,t,s,it,!1)}setColors32(e,t){this.setVertexStream(Qi,e,ld.DEFAULT_COMPONENTS_COLORS,t,io,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream(kt,e)}getNormals(e){return this.getVertexStream($a,e)}getUvs(e,t){return this.getVertexStream(VM+e,t)}getColors(e){return this.getVertexStream(Qi,e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(s);else{e.length=0;for(let i=0,a=s.length;i<a;i++)e.push(s[i])}}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t}update(e=al,t=!0){if(this._geometryData){if(t){const a=this._geometryData.vertexStreamDictionary[kt];a&&a.componentCount===3&&(this._aabb.compute(a.data,this._geometryData.vertexCount),this._aabbVer++)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){const t=[];for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.push({semantic:s,components:i.componentCount,type:i.dataType,normalize:i.dataTypeNormalize,asInt:i.asInt})}return new en(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){const s=this._geometryData.maxVertices,i=this._buildVertexFormat(s);this.vertexBuffer=new jn(this.device,i,s,{usage:this._geometryData.verticesUsage,storage:this._storageVertex})}const e=new i0(this.vertexBuffer),t=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];e.writeData(s,i.data,t),delete this._geometryData.vertexStreamDictionary[s]}e.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices,s=t>65535||t===0?Th:ho,i=this._storageIndex?{storage:!0}:void 0;this.indexBuffer[0]=new Ah(this.device,s,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,i)}const e=this._geometryData.indices;e&&(this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null)}prepareRenderState(e){e===od?this.generateWireframe():e===ab&&(this.primitive[ab]={type:Y0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[ab]&&this.prepareRenderState(ab),this.primitive[od]&&this.prepareRenderState(od)}generateWireframe(){this._destroyIndexBuffer(od);const e=this.vertexBuffer.numVertices,t=[];let s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const n=[[0,1],[1,2],[2,0]],r=this.primitive[a0].base,l=this.primitive[a0].count,u=this.indexBuffer[a0],f=new $b[u.format](u.storage),_=new Set;for(let g=r;g<r+l;g+=3)for(let y=0;y<3;y++){const v=f[g+n[y][0]],x=f[g+n[y][1]],C=v>x?x*e+v:v*e+x;_.has(C)||(_.add(C),t.push(v,x))}s=u.format}else{for(let n=0;n<e;n+=3)t.push(n,n+1,n+1,n+2,n+2,n);s=t.length>65535?Th:ho}const i=new Ah(this.vertexBuffer.device,s,t.length);new $b[i.format](i.storage).set(t),i.unlock(),this.primitive[od]={type:X1,base:0,count:t.length,indexed:!0},this.indexBuffer[od]=i}}const OU=new Xn;function ly(h){return OU.get(h)}function AK(h,e){OU.get(h,()=>e)}class CK{destroy(){this.cache.forEach((e,t)=>{t.destroy()}),this.cache.clear()}incRef(e){const t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){let t=this.cache.get(e);t&&(t--,t===0?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}constructor(){this.cache=new Map}}const LL=class LL{static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}};LL.cache=new CK;let yh=LL,wK=0;const RK=new wt,dE=new wt,uR=new T1,dR=new Set,ng=new Uint32Array(4);class MK{constructor(e){this.vertexBuffer=null,this._destroyVertexBuffer=!1,this.count=e}destroy(){var e;this._destroyVertexBuffer&&((e=this.vertexBuffer)==null||e.destroy()),this.vertexBuffer=null}}class DK{getBindGroup(e){if(!this.bindGroup){const s=this.shader.meshBindGroupFormat;this.bindGroup=new $0(e,s)}return this.bindGroup}getUniformBuffer(e){if(!this.uniformBuffer){const s=this.shader.meshUniformBufferFormat;this.uniformBuffer=new ox(e,s,!1)}return this.uniformBuffer}destroy(){var e,t;(e=this.bindGroup)==null||e.destroy(),this.bindGroup=null,(t=this.uniformBuffer)==null||t.destroy(),this.uniformBuffer=null}constructor(){this.bindGroup=null,this.uniformBuffer=null}}const Pp=class Pp{constructor(e,t,s=null){if(this.castShadow=!1,this.cull=!0,this.drawOrder=0,this._drawBucket=127,this.visible=!0,this.visibleThisFrame=!1,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=wK++,this.isVisibleFunc=null,this.instancingData=null,this.parameters={},this.pick=!0,this.stencilFront=null,this.stencilBack=null,this.transparent=!1,this._aabb=new wt,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=!0,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=lP,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=!0,this._renderStyle=a0,this._screenSpace=!1,this._shaderCache=new Map,this._shaderDefs=uo<<16,this._calculateSortDistance=null,this.node=s,this._mesh=e,e.incRefCount(),this.material=t,e.vertexBuffer){const i=e.vertexBuffer.format;this._shaderDefs|=i.hasUv0?bP:0,this._shaderDefs|=i.hasUv1?xP:0,this._shaderDefs|=i.hasColor?TP:0,this._shaderDefs|=i.hasTangents?BC:0}this.updateKey()}set drawBucket(e){this._drawBucket=Math.floor(e)&255,this.updateKey()}get drawBucket(){return this._drawBucket}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e){if(e=RK,this.skinInstance){if(!this.mesh.boneAabb){const a=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(a)}const s=this.mesh.boneUsed;let i=!0;for(let a=0;a<this.mesh.boneAabb.length;a++)s[a]&&(dE.setFromTransformedAabb(this.mesh.boneAabb[a],this.skinInstance.matrices[a]),i?(i=!1,e.center.copy(dE.center),e.halfExtents.copy(dE.halfExtents)):e.add(dE));t=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const s=this.mesh.morph.aabb;e._expand(s.getMin(),s.getMax())}t=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach(e=>{e.destroy()}),this._shaderCache.clear()}getShaderInstance(e,t,s,i,a,n,r){var _;const l=this._shaderDefs;ng[0]=e,ng[1]=t,ng[2]=l,ng[3]=i.hash;const u=tP(ng);let f=this._shaderCache.get(u);if(!f){const g=this._material;if(f=new DK,f.shader=g.variants.get(u),f.hashes=new Uint32Array(ng),!f.shader){const y=g.getShaderVariant({device:this.mesh.device,scene:s,objDefs:l,cameraShaderParams:i,pass:e,sortedLights:r,viewUniformFormat:a,viewBindGroupFormat:n,vertexFormat:(_=this.mesh.vertexBuffer)==null?void 0:_.format});g.variants.set(u,y),f.shader=y}this._shaderCache.set(u,f)}return f}set material(e){this.clearShaders();const t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey())}get material(){return this._material}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders())}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?this._shaderDefs&-2:this._shaderDefs|NC))}get receiveShadow(){return this._receiveShadow}set batching(e){this._updateShaderDefs(e?this._shaderDefs|NA:this._shaderDefs&-16385)}get batching(){return(this._shaderDefs&NA)!==0}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?this._shaderDefs|ux:this._shaderDefs&-3),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){var s;(s=this._morphInstance)==null||s.destroy(),this._morphInstance=e;let t=this._shaderDefs;t=e&&e.morph.morphPositions?t|fx:t&-1025,t=e&&e.morph.morphNormals?t|px:t&-2049,t=e&&e.morph.intRenderFormat?t|mx:t&-8193,this._updateShaderDefs(t)}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?this._shaderDefs|FC:this._shaderDefs&-257))}get screenSpace(){return this._screenSpace}set key(e){this._sortKeyForward=e}get key(){return this._sortKeyForward}set mask(e){const t=this._shaderDefs&65535;this._updateShaderDefs(t|e<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var t,s,i;const e=this.mesh;e&&(this.mesh=null,e.refCount<1&&e.destroy()),this.setRealtimeLightmap(Pp.lightmapParamNames[0],null),this.setRealtimeLightmap(Pp.lightmapParamNames[1],null),(t=this._skinInstance)==null||t.destroy(),this._skinInstance=null,(s=this.morphInstance)==null||s.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,(i=this.instancingData)==null||i.destroy()}static _prepareRenderStyleForArray(e,t){if(e){for(let s=0;s<e.length;s++){e[s]._renderStyle=t;const i=e[s].mesh;dR.has(i)||(dR.add(i),i.prepareRenderState(t))}dR.clear()}}_isVisible(e){return this.visible?this.isVisibleFunc?this.isVisibleFunc(e):(uR.center=this.aabb.center,uR.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(uR)>0):!1}updateKey(){const{material:e}=this;this._sortKeyForward=this._drawBucket<<25|(e.alphaToCoverage||e.alphaTest?16777216:0)|e.id&16777215}setInstancing(e,t=!1){e?(this.instancingData=new MK(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=!0,this.cull=t):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(e?this._shaderDefs|dx:this._shaderDefs&-33)}ensureMaterial(e){this.material||(this.material=ly(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s=4294967295){const i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s}}setRealtimeLightmap(e,t){const s=this.getParameter(e);s!==t&&(s&&yh.decRef(s.data),t?(yh.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;for(const i in s){const a=s[i];a.passFlags&t&&(a.scopeId||(a.scopeId=e.scope.resolve(i)),a.scopeId.setValue(a.data))}}setLightmapped(e){e?this.mask=(this.mask|Xd)&-6:(this.setRealtimeLightmap(Pp.lightmapParamNames[0],null),this.setRealtimeLightmap(Pp.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=(this.mask|uo)&-7)}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}};Pp.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];let ps=Pp;const PK=[0,1,3,2,3,1],LK=[0,1,3,0,3,2],nO=new ol;function rO(h,e){if(h&&!e||!h&&e)return!1;if(h=h.data,e=e.data,h===e)return!0;if(h instanceof Float32Array&&e instanceof Float32Array){if(h.length!==e.length)return!1;for(let t=0;t<h.length;t++)if(h[t]!==e[t])return!1;return!0}return!1}function IK(h,e){for(const t in h)if(h.hasOwnProperty(t)&&!rO(h[t],e[t]))return!1;for(const t in e)if(e.hasOwnProperty(t)&&!rO(e[t],h[t]))return!1;return!0}function fR(h){return h.node.worldTransform.scaleSign}class NU{constructor(e,t,s){this.device=e,this.rootNode=t,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(e,t,s,i,a){if(i===void 0&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;const n=new zi(i,e,t,s,a);return this._batchGroups[i]=n,n}removeGroup(e){if(!this._batchGroups[e])return;const t=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===e?this.destroyBatch(this._batchList[s]):t.push(this._batchList[s]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e]}markGroupDirty(e){this._dirtyGroups.indexOf(e)<0&&this._dirtyGroups.push(e)}getGroupByName(e){const t=this._batchGroups;for(const s in t)if(t.hasOwnProperty(s)&&t[s].name===e)return t[s];return null}getBatches(e){const t=[],s=this._batchList.length;for(let i=0;i<s;i++){const a=this._batchList[i];a.batchGroupId===e&&t.push(a)}return t}_removeModelsFromBatchGroup(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(let s=0;s<e._children.length;s++)this._removeModelsFromBatchGroup(e._children[s],t)}}insert(e,t,s){const i=this._batchGroups[t];i&&i._obj[e].indexOf(s)<0&&(i._obj[e].push(s),this.markGroupDirty(t))}remove(e,t,s){const i=this._batchGroups[t];if(i){const a=i._obj[e].indexOf(s);a>=0&&(i._obj[e].splice(a,1),this.markGroupDirty(t))}}_extractRender(e,t,s,i){return e.render&&(t=i[e.render.batchGroupId]=t.concat(e.render.meshInstances),e.render.removeFromLayers()),t}_extractModel(e,t,s,i){return e.model&&e.model.model&&(t=i[e.model.batchGroupId]=t.concat(e.model.meshInstances),e.model.removeModelFromLayers()),t}_extractElement(e,t,s){if(!e.element)return;let i=!1;e.element._text&&e.element._text._model.meshInstances.length>0?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),i=!0):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),(!e.element._image._renderable.unmaskMeshInstance.stencilFront||!e.element._image._renderable.unmaskMeshInstance.stencilBack)&&(e.element._dirtifyMask(),e.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(e,t){for(let s=0;s<t.length;s++){const i=t[s],a=this._batchGroups[i];if(!a)continue;let n=e[i];n||(n=e[i]=[]);for(let r=0;r<a._obj.model.length;r++)n=this._extractModel(a._obj.model[r],n,a,e);for(let r=0;r<a._obj.render.length;r++)n=this._extractRender(a._obj.render[r],n,a,e);for(let r=0;r<a._obj.element.length;r++)this._extractElement(a._obj.element[r],n,a);for(let r=0;r<a._obj.sprite.length;r++){const l=a._obj.sprite[r];l.sprite&&l.sprite._meshInstance&&(a.dynamic||l.sprite.sprite._renderMode===tl)&&(n.push(l.sprite._meshInstance),l.sprite.removeModelFromLayers(),a._sprite=!0,l.sprite._batchGroup=a)}}}generate(e){const t={};e||(e=Object.keys(this._batchGroups));const s=[];for(let l=0;l<this._batchList.length;l++){if(e.indexOf(this._batchList[l].batchGroupId)<0){s.push(this._batchList[l]);continue}this.destroyBatch(this._batchList[l])}if(this._batchList=s,this._collectAndRemoveMeshInstances(t,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else{const l=[];for(let u=0;u<this._dirtyGroups.length;u++)e.indexOf(this._dirtyGroups[u])<0&&l.push(this._dirtyGroups[u]);this._dirtyGroups=l}let i,a,n,r;for(const l in t)if(t.hasOwnProperty(l)&&(i=t[l],n=this._batchGroups[l],!!n)){a=this.prepare(i,n.dynamic,n.maxAabbSize,n._ui||n._sprite);for(let u=0;u<a.length;u++)r=this.create(a[u],n.dynamic,parseInt(l,10)),r&&r.addToLayers(this.scene,n.layers)}}prepare(e,t,s=Number.POSITIVE_INFINITY,i){if(e.length===0)return[];const a=s*.5,n=1024,r=4294967295,l=new wt,u=new wt;let f=null,_;const g=[];let y=0;i&&e.sort((M,w)=>M.drawOrder-w.drawOrder);let v=e,x;const C=i?function(M){f?f.add(M.aabb):f=M.aabb.clone(),x.push(M)}:function(M){x.push(M)};for(;v.length>0;){g[y]=[v[0]],x=[];const M=v[0].material,w=v[0].layer,T=v[0]._shaderDefs,R=v[0].parameters,D=v[0].stencilFront;let I=v[0].mesh.vertexBuffer.getNumVertices();const U=v[0].drawOrder;l.copy(v[0].aabb);const O=fR(v[0]),N=v[0].mesh.vertexBuffer.format.batchingHash,z=v[0].mesh.primitive[0].indexed;f=null;for(let X=1;X<v.length;X++){const Y=v[X];if(t&&g[y].length>=n){x=x.concat(v.slice(X));break}if(M!==Y.material||w!==Y.layer||N!==Y.mesh.vertexBuffer.format.batchingHash||z!==Y.mesh.primitive[0].indexed||T!==Y._shaderDefs||I+Y.mesh.vertexBuffer.getNumVertices()>r){C(Y);continue}if(u.copy(l),u.add(Y.aabb),u.halfExtents.x>a||u.halfExtents.y>a||u.halfExtents.z>a){C(Y);continue}if(D&&(!(_=Y.stencilFront)||D.func!==_.func||D.zpass!==_.zpass)){C(Y);continue}if(O!==fR(Y)){C(Y);continue}if(!IK(R,Y.parameters)){C(Y);continue}if(i&&f&&f.intersects(Y.aabb)&&Y.drawOrder!==U){C(Y);continue}l.add(Y.aabb),I+=Y.mesh.vertexBuffer.getNumVertices(),g[y].push(Y)}y++,v=x}return g}collectBatchedMeshData(e,t){let s=null,i=0,a=0,n=null;for(let r=0;r<e.length;r++)if(e[r].visible){const l=e[r].mesh,u=l.vertexBuffer.numVertices;if(i+=u,l.primitive[0].indexed)a+=l.primitive[0].count;else{const f=l.primitive[0].type;(f===wd||f===hl)&&l.primitive[0].count===4&&(a+=6)}if(!s){n=e[r].material,s={};const f=l.vertexBuffer.format.elements;for(let _=0;_<f.length;_++){const g=f[_].name;s[g]={numComponents:f[_].numComponents,dataType:f[_].dataType,normalize:f[_].normalize,count:0}}t&&(s[gn]={numComponents:1,dataType:it,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:a,material:n}}create(e,t,s){this._init||(this.vertexFormats={},this._init=!0);let i=null,a,n,r,l=null;const u=this.collectBatchedMeshData(e,t);if(u.streams){const f=u.streams;let _=u.material;const g=u.batchNumVerts,y=u.batchNumIndices;l=new i3(e,t,s),this._batchList.push(l);let v,x,C,M=0,w=0,T;const R=g<=65535?Uint16Array:Uint32Array,D=new R(y);for(a in f)i=f[a],i.typeArrayType=qp[i.dataType],i.elementByteSize=t0[i.dataType],i.buffer=new i.typeArrayType(g*i.numComponents);for(let O=0;O<e.length;O++)if(e[O].visible){n=e[O].mesh,r=n.vertexBuffer.numVertices,t||(T=e[O].node.getWorldTransform());for(a in f)if(a!==gn){i=f[a];const N=new i.typeArrayType(i.buffer.buffer,i.elementByteSize*i.count),z=n.getVertexStream(a,N)*i.numComponents;if(i.count+=z,!t&&i.numComponents>=3){if(a===kt){const X=T.data,Y=X[0],F=X[1],q=X[2],G=X[4],W=X[5],k=X[6],K=X[8],ee=X[9],V=X[10],Q=X[12],se=X[13],J=X[14];let ie,oe,he;for(let te=0;te<z;te+=i.numComponents)ie=N[te],oe=N[te+1],he=N[te+2],N[te]=ie*Y+oe*G+he*K+Q,N[te+1]=ie*F+oe*W+he*ee+se,N[te+2]=ie*q+oe*k+he*V+J}else if(a===$a||a===po){nO.invertMat4(T).transpose();const[X,Y,F,q,G,W,k,K,ee]=nO.data;let V,Q,se;for(let J=0;J<z;J+=i.numComponents)V=N[J],Q=N[J+1],se=N[J+2],N[J]=V*X+Q*q+se*k,N[J+1]=V*Y+Q*G+se*K,N[J+2]=V*F+Q*W+se*ee}}}if(t){i=f[gn];for(let N=0;N<r;N++)i.buffer[i.count++]=O}if(n.primitive[0].indexed){v=n.primitive[0].base,x=n.primitive[0].count;const N=n.indexBuffer[0].getFormat();C=new $b[N](n.indexBuffer[0].storage)}else{const N=n.primitive[0].type;if(N===wd||N===hl)if(n.primitive[0].count===4)v=0,x=6,C=N===wd?PK:LK;else{x=0;continue}}for(let N=0;N<x;N++)D[N+w]=C[v+N]+M;w+=x,M+=r}n=new Ft(this.device);for(a in f)i=f[a],n.setVertexStream(a,i.buffer,i.numComponents,void 0,i.dataType,i.normalize);D.length>0&&n.setIndices(D),n.update(al,!1),t&&(_=_.clone(),_.update());const I=new ps(n,_,this.rootNode);I.castShadow=l.origMeshInstances[0].castShadow,I.parameters=l.origMeshInstances[0].parameters,I.layer=l.origMeshInstances[0].layer,I._shaderDefs=l.origMeshInstances[0]._shaderDefs,I.batching=!0,I.cull=l.origMeshInstances[0].cull;const U=this._batchGroups[s];if(U&&U._ui&&(I.cull=!1),t){const O=[];for(let N=0;N<l.origMeshInstances.length;N++)O.push(l.origMeshInstances[N].node);I.skinInstance=new a3(this.device,O,this.rootNode)}I._updateAabb=!1,I.drawOrder=l.origMeshInstances[0].drawOrder,I.stencilFront=l.origMeshInstances[0].stencilFront,I.stencilBack=l.origMeshInstances[0].stencilBack,I.flipFacesFactor=fR(l.origMeshInstances[0]),I.castShadow=l.origMeshInstances[0].castShadow,l.meshInstance=I,l.updateBoundingBox()}return l}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox()}clone(e,t){const s=new i3(t,e.dynamic,e.batchGroupId);this._batchList.push(s);const i=[];for(let a=0;a<t.length;a++)i.push(t[a].node);return s.meshInstance=new ps(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=t[0].parameters,s.meshInstance.cull=t[0].cull,s.meshInstance.layer=t[0].layer,e.dynamic&&(s.meshInstance.skinInstance=new a3(this.device,i,this.rootNode)),s.meshInstance.castShadow=e.meshInstance.castShadow,s}destroyBatch(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers)}}const oO="uSceneColorMap";class wP extends pa{destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(e,t,s){if((e==null?void 0:e.colorBuffer.format)!==s)return!0;const a=(t==null?void 0:t.width)||this.device.width,n=(t==null?void 0:t.height)||this.device.height;return!e||a!==e.width||n!==e.height}allocateRenderTarget(e,t,s,i){const a=new Ge(s,{name:oO,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!0,minFilter:lo,magFilter:Vt,addressU:Oe,addressV:Oe});return e?(e.destroyFrameBuffers(),e._colorBuffer=a,e._colorBuffers=[a]):e=new fs({name:"ColorGrabRT",colorBuffer:a,depth:!1,stencil:!1,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}frameUpdate(){const e=this.device,t=this.source,s=(t==null?void 0:t.colorBuffer.format)??this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,t==null?void 0:t.colorBuffer,s)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,t,e,s));const i=this.colorRenderTarget.colorBuffer;e.scope.resolve(oO).setValue(i)}execute(){const e=this.device,t=this.source,s=this.colorRenderTarget.colorBuffer;e.isWebGPU?(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(s),e.gl.generateMipmap(s.impl._glTarget))}constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null}}const lO="uSceneDepthMap";class OK extends pa{constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t}destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(e,t){const s=(t==null?void 0:t.width)||this.device.width,i=(t==null?void 0:t.height)||this.device.height;return!e||s!==e.width||i!==e.height}allocateRenderTarget(e,t,s,i,a){const n=new Ge(s,{name:lO,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe});return e?(e.destroyFrameBuffers(),a?e._depthBuffer=n:(e._colorBuffer=n,e._colorBuffers=[n])):e=new fs({name:"DepthGrabRT",colorBuffer:a?null:n,depthBuffer:a?n:null,depth:!a,stencil:s.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}before(){var l,u;const e=this.camera,t=this.device,s=(e==null?void 0:e.renderTarget)??t.backBuffer;let i=!0,a=s.stencil?Fd:il;t.isWebGPU&&s.samples>1&&(a=gr,i=!1);const n=((l=e.renderTarget)==null?void 0:l.depthBuffer)??((u=e.renderTarget)==null?void 0:u.colorBuffer);this.shouldReallocate(this.depthRenderTarget,n)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,e.renderTarget,t,a,i));const r=i?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;t.scope.resolve(lO).setValue(r)}execute(){const e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){const t=e.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;e.renderTarget=s,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,s.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT)}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,!1,!0)}}class RP{get hash(){if(this._hash===void 0){const e=`${this.gammaCorrection}_${this.toneMapping}_${this.srgbRenderTarget}_${this.fog}_${this.ssaoEnabled}_${this.sceneDepthMapLinear}`;this._hash=sl(e)}return this._hash}get defines(){const e=this._defines;return this._definesDirty&&(this._definesDirty=!1,e.clear(),this._sceneDepthMapLinear&&e.set("SCENE_DEPTHMAP_LINEAR",!0),e.set("FOG",this._fog.toUpperCase()),e.set("TONEMAP",PC[this._toneMapping]),e.set("GAMMA",gP[this.shaderOutputGamma])),e}markDirty(){this._hash=void 0,this._definesDirty=!0}set fog(e){this._fog!==e&&(this._fog=e,this.markDirty())}get fog(){return this._fog}set ssaoEnabled(e){this._ssaoEnabled!==e&&(this._ssaoEnabled=e,this.markDirty())}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(e){this._gammaCorrectionAssigned=!0,this._gammaCorrection!==e&&(this._gammaCorrection=e,this.markDirty())}get gammaCorrection(){return this._gammaCorrection}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this.markDirty())}get toneMapping(){return this._toneMapping}set srgbRenderTarget(e){this._srgbRenderTarget!==e&&(this._srgbRenderTarget=e,this.markDirty())}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(e){this._sceneDepthMapLinear!==e&&(this._sceneDepthMapLinear=e,this.markDirty())}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return this._gammaCorrection===Gc&&!this._srgbRenderTarget?Gc:Ch}constructor(){this._gammaCorrection=Gc,this._toneMapping=sy,this._srgbRenderTarget=!1,this._ssaoEnabled=!1,this._fog=Fm,this._sceneDepthMapLinear=!1,this._defines=new Map,this._definesDirty=!0}}const rg=new H,Xv=new H,hO=new H,cO=new Me,NK=[new H,new H,new H,new H,new H,new H,new H,new H];class hy{constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new RP,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=zC,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new xe(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[Ph,yn,dm,ty,hx],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=Ya,this._rect=new Ie(0,0,1,1),this._renderTarget=null,this._scissorRect=new Ie(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=1/1e3,this._sensitivity=1e3,this._projMat=new Me,this._projMatDirty=!0,this._projMatSkybox=new Me,this._viewMat=new Me,this._viewMatDirty=!0,this._viewProjMat=new Me,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new Me,this._viewProjCurrent=null,this._viewProjPrevious=new Me,this._jitters=[0,0,0,0],this.frustum=new fF,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}destroy(){var e,t;(e=this.renderPassColorGrab)==null||e.destroy(),this.renderPassColorGrab=null,(t=this.renderPassDepthGrab)==null||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(e,t,s,i){this._shaderMatricesVersion!==i&&(this._shaderMatricesVersion=i,this._viewProjPrevious.copy(this._viewProjCurrent??e),this._viewProjCurrent??(this._viewProjCurrent=new Me),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=s)}get fullSizeClearRect(){const e=this._scissorRectClear?this.scissorRect:this._rect;return e.x===0&&e.y===0&&e.z===1&&e.w===1}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(e){this._aperture=e}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return new hy().copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(e,t){var s;t?this.renderPassColorGrab||(this.renderPassColorGrab=new wP(e)):((s=this.renderPassColorGrab)==null||s.destroy(),this.renderPassColorGrab=null)}_enableRenderPassDepthGrab(e,t,s){var i;s?this.renderPassDepthGrab||(this.renderPassDepthGrab=new OK(e,this)):((i=this.renderPassDepthGrab)==null||i.destroy(),this.renderPassDepthGrab=null)}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,s,i=new H){this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);const a=this._viewProjMat.data,n=e.x*a[3]+e.y*a[7]+e.z*a[11]+1*a[15];return i.x=(i.x/n+1)*.5*t,i.y=(1-i.y/n)*.5*s,i}screenToWorld(e,t,s,i,a,n=new H){const r=this.farClip-this.nearClip;if(rg.set(e/i,(a-t)/a,s/r),rg.mulScalar(2),rg.sub(H.ONE),this._projection===Ya){Me._getPerspectiveHalfSize(Xv,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),Xv.x*=rg.x,Xv.y*=rg.y;const l=this._node.getWorldTransform();Xv.z=-this.nearClip,l.transformPoint(Xv,hO);const u=this._node.getPosition();n.sub2(hO,u),n.normalize(),n.mulScalar(s),n.add(u)}else this._updateViewProjMat(),cO.copy(this._viewProjMat).invert(),cO.transformPoint(rg,n);return n}_evaluateProjectionMatrix(){if(this._projMatDirty){if(this._projection===Ya)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{const e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){const e=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(Math.pow(2,e)*1.2)}getScreenSize(e){if(this._projection===Ya){const t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;const s=Math.asin(e.radius/t),i=Math.tan(s),a=Math.tan(this.fov/2*ge.DEG_TO_RAD);return Math.min(i/a,1)}return ge.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e=this.nearClip,t=this.farClip){const s=this.fov*Math.PI/180;let i,a;this.projection===Ya?this.horizontalFov?(i=e*Math.tan(s/2),a=i/this.aspectRatio):(a=e*Math.tan(s/2),i=a*this.aspectRatio):(a=this._orthoHeight,i=a*this.aspectRatio);const n=NK;return n[0].x=i,n[0].y=-a,n[0].z=-e,n[1].x=i,n[1].y=a,n[1].z=-e,n[2].x=-i,n[2].y=a,n[2].z=-e,n[3].x=-i,n[3].y=-a,n[3].z=-e,this._projection===Ya&&(this.horizontalFov?(i=t*Math.tan(s/2),a=i/this.aspectRatio):(a=t*Math.tan(s/2),i=a*this.aspectRatio)),n[4].x=i,n[4].y=-a,n[4].z=-t,n[5].x=i,n[5].y=a,n[5].z=-t,n[6].x=-i,n[6].y=a,n[6].z=-t,n[7].x=-i,n[7].y=-a,n[7].z=-t,n}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=!0}}const uO=new Me,pR=new H,dO=new Ne,mR=new Ne,fO=new H,pO=new H,FK=new Me,BK=new Ne,ar=new H,jv=new Me,nr=new Ne,og=new Ne,mO=new Me,_R=new H,fE=new H;function _O(h,e){return h instanceof Function?h:t=>{let s=t[h];return s instanceof Function&&(s=s()),s===e}}function FU(h,e){if(e(h))return h;const t=h._children,s=t.length;for(let i=0;i<s;++i){const a=FU(t[i],e);if(a)return a}return null}class Jt extends Qe{constructor(e="Untitled"){super(),this.tags=new Ib(this),this.localPosition=new H,this.localRotation=new Ne,this.localScale=new H(1,1,1),this.localEulerAngles=new H,this.position=new H,this.rotation=new Ne,this.eulerAngles=new H,this._scale=null,this.localTransform=new Me,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new Me,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new ol,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=e}get right(){return this._right||(this._right=new H),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new H),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new H),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}set enabled(e){var t;this._enabled!==e&&(this._enabled=e,(e&&((t=this._parent)!=null&&t.enabled)||!e)&&this._notifyHierarchyStateChanged(this,e))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return"";let t=this.name;for(;e&&e._parent;)t=`${e.name}/${t}`,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);const s=e._children;for(let i=0,a=s.length;i<a;i++)s[i]._enabled&&this._notifyHierarchyStateChanged(s[i],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;const t=this.tags._list;e.tags.clear();for(let s=0;s<t.length;s++)e.tags.add(t[s]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){const e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();const e=this._children;for(;e.length;){const t=e.pop();t._parent=null,t.destroy()}this.fire("destroy",this),this.off()}find(e,t){const s=[],i=_O(e,t);return this.forEach(a=>{i(a)&&s.push(a)}),s}findOne(e,t){const s=_O(e,t);return FU(this,s)}findByTag(...e){const t=[],s=(i,a)=>{a&&i.tags.has(...e)&&t.push(i);for(let n=0;n<i._children.length;n++)s(i._children[n],!0)};return s(this,!1),t}findByName(e){return this.findOne("name",e)}findByPath(e){const t=Array.isArray(e)?e:e.split("/");let s=this;for(let i=0,a=t.length;i<a;++i)if(s=s.children.find(n=>n.name===t[i]),!s)return null;return s}forEach(e,t){e.call(t,this);const s=this._children,i=s.length;for(let a=0;a<i;++a)s[a].forEach(e,t)}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new H),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return!this._dirtyLocal&&!this._dirtyWorld?this.worldTransform:(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform)}get worldScaleSign(){return this._worldScaleSign===0&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){var e;(e=this._parent)==null||e.removeChild(this)}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,s){e instanceof H?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,s,i){e instanceof Ne?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,s){e instanceof H?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(e,t,s){e instanceof H?ar.copy(e):ar.set(e,t,s),this._parent===null?this.localPosition.copy(ar):(jv.copy(this._parent.getWorldTransform()).invert(),jv.transformPoint(ar,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,s,i){if(e instanceof Ne?nr.copy(e):nr.set(e,t,s,i),this._parent===null)this.localRotation.copy(nr);else{const a=this._parent.getRotation();og.copy(a).invert(),this.localRotation.copy(og).mul(nr)}this._dirtyLocal||this._dirtifyLocal()}setPositionAndRotation(e,t){if(this._parent===null)this.localPosition.copy(e),this.localRotation.copy(t);else{const s=this._parent.getWorldTransform();jv.copy(s).invert(),jv.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(jv).mul(t)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),this._parent!==null){const i=this._parent.getRotation();og.copy(i).invert(),this.localRotation.mul2(og,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){const t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(FK.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(BK.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e.remove()}_fireOnHierarchy(e,t,s){this.fire(e,s);for(let i=0;i<this._children.length;i++)this._children[i]._fireOnHierarchy(t,t,s)}_onInsertChild(e){e._parent=this;const t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){const t=this._children.indexOf(e);t!==-1&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e;const t=this._parent;let s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(e=i.worldTransform.getScale(),fO.mul2(e,this.localScale),s=fO))}mR.setFromMat4(t.worldTransform),dO.mul2(mR,this.localRotation);let a=t.worldTransform;t.scaleCompensation&&(pO.mul2(e,t.getLocalScale()),uO.setTRS(t.worldTransform.getTranslation(pR),mR,pO),a=uO),a.transformPoint(this.localPosition,pR),this.worldTransform.setTRS(pR,dO,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled||this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const e=this._children;for(let t=0,s=e.length;t<s;t++)e[t].syncHierarchy()}lookAt(e,t,s,i=0,a=1,n=0){if(e instanceof H)_R.copy(e),t instanceof H?fE.copy(t):fE.copy(H.UP);else{if(s===void 0)return;_R.set(e,t,s),fE.set(i,a,n)}mO.setLookAt(this.getPosition(),_R,fE),nr.setFromMat4(mO),this.setRotation(nr)}translate(e,t,s){e instanceof H?ar.copy(e):ar.set(e,t,s),ar.add(this.getPosition()),this.setPosition(ar)}translateLocal(e,t,s){e instanceof H?ar.copy(e):ar.set(e,t,s),this.localRotation.transformVector(ar,ar),this.localPosition.add(ar),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,s){if(nr.setFromEulerAngles(e,t,s),this._parent===null)this.localRotation.mul2(nr,this.localRotation);else{const i=this.getRotation(),a=this._parent.getRotation();og.copy(a).invert(),nr.mul2(og,nr),this.localRotation.mul2(nr,i)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,s){nr.setFromEulerAngles(e,t,s),this.localRotation.mul(nr),this._dirtyLocal||this._dirtifyLocal()}}const gO=new Me,yO=new Me,vO=new Me,pd=class pd{static create(e,t,s){const i=new hy;switch(i.node=new Jt(e),i.aspectRatio=1,i.aspectRatioMode=FA,i._scissorRectClear=!0,t){case Ds:i.node.setRotation(pd.pointLightRotations[s]),i.fov=90,i.projection=Ya;break;case Ns:i.projection=Ya;break;case ft:i.projection=nl;break}return i}static evalSpotCookieMatrix(e){let t=pd._spotCookieCamera;t||(t=pd.create("SpotCookieCamera",Ns),pd._spotCookieCamera=t),t.fov=e._outerConeAngle*2;const s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),gO.setTRS(s.getPosition(),s.getRotation(),H.ONE).invert(),yO.mul2(t.projectionMatrix,gO);const i=e.cookieMatrix,a=e.atlasViewport;return vO.setViewport(a.x,a.y,a.z,a.w),i.mul2(vO,yO),i}};pd.pointLightRotations=[new Ne().setFromEulerAngles(0,90,180),new Ne().setFromEulerAngles(0,-90,180),new Ne().setFromEulerAngles(90,0,0),new Ne().setFromEulerAngles(-90,0,0),new Ne().setFromEulerAngles(0,180,180),new Ne().setFromEulerAngles(0,0,180)],pd._spotCookieCamera=null;let w0=pd;var UK=`

#if LIT_AMBIENT_SOURCE == AMBIENTSH
#endif

#if LIT_AMBIENT_SOURCE == ENVALATLAS
		#include "envAtlasPS"

		#ifndef ENV_ATLAS
				#define ENV_ATLAS
				var texture_envAtlas: texture_2d<f32>;
				var texture_envAtlasSampler: sampler;
		#endif
#endif

fn addAmbient(worldNormal: vec3f) {
		#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH

				let n: vec3f = cubeMapRotate(worldNormal);
				let color: vec3f =
						uniform.ambientSH[0] +
						uniform.ambientSH[1] * n.x +
						uniform.ambientSH[2] * n.y +
						uniform.ambientSH[3] * n.z +
						uniform.ambientSH[4] * n.x * n.z +
						uniform.ambientSH[5] * n.z * n.y +
						uniform.ambientSH[6] * n.y * n.x +
						uniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
						uniform.ambientSH[8] * (n.x * n.x - n.y * n.y);

				dDiffuseLight += processEnvironment(max(color, vec3f(0.0)));

		#endif

		#if LIT_AMBIENT_SOURCE == ENVALATLAS

				let dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));
				let uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);

				let raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);
				let linear: vec3f = {ambientDecode}(raw);
				dDiffuseLight += processEnvironment(linear);

		#endif

		#if LIT_AMBIENT_SOURCE == CONSTANT

				dDiffuseLight += uniform.light_globalAmbient;

		#endif
}
`,zK=`
uniform view_position: vec3f;

uniform light_globalAmbient: vec3f;

fn square(x: f32) -> f32 {
		return x*x;
}

fn saturate(x: f32) -> f32 {
		return clamp(x, 0.0, 1.0);
}

fn saturate3(x: vec3f) -> vec3f {
		return clamp(x, vec3f(0.0), vec3f(1.0));
}
`,kK=`
fn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {
		var ret: vec3f = vec3f(0.0);

		#ifdef LIT_OLD_AMBIENT
				ret += (dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient;
		#else
				ret += albedo * dDiffuseLight;
		#endif // LIT_OLD_AMBIENT
		#ifdef LIT_SPECULAR
				ret += dSpecularLight;
		#endif // LIT_SPECULAR
		#ifdef LIT_REFLECTIONS
				ret += dReflection.rgb * dReflection.a;
		#endif // LIT_REFLECTIONS

		#ifdef LIT_SHEEN
				let sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
				ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
		#endif // LIT_SHEEN
		#ifdef LIT_CLEARCOAT
				let clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;
				ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;
		#endif // LIT_CLEARCOAT

		return ret;
}
`,VK=`
		varying uv0: vec2f;

		var blitTexture: texture_2d<f32>;
		var blitTextureSampler : sampler;

		@fragment
		fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				output.color = textureSample(blitTexture, blitTextureSampler, input.uv0);
				return output;
		}
`,GK=`
		varying uv0: vec2f;
		uniform invViewProj: mat4x4<f32>;
		var blitTexture: texture_cube<f32>;
		var blitTextureSampler : sampler;

		@fragment
		fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				var projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);
				var worldPos = uniform.invViewProj * projPos;
				output.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);
				return output;
		}
`,HK=`
		attribute vertex_position: vec2f;
		varying uv0: vec2f;

		@vertex
		fn vertexMain(input: VertexInput) -> VertexOutput {
				var output: VertexOutput;
				output.position = vec4f(input.vertex_position, 0.5, 1.0);
				output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);
				output.uv0.y = 1.0 - output.uv0.y;
				return output;
		}
`,WK=`
#ifdef DEBUG_ALBEDO_PASS
output.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);
#endif

#ifdef DEBUG_UV0_PASS
output.color = vec4f(litArgs_albedo , 1.0);
#endif

#ifdef DEBUG_WORLD_NORMAL_PASS
output.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif

#ifdef DEBUG_OPACITY_PASS
output.color = vec4f(vec3f(litArgs_opacity) , 1.0);
#endif

#ifdef DEBUG_SPECULARITY_PASS
output.color = vec4f(litArgs_specularity, 1.0);
#endif

#ifdef DEBUG_GLOSS_PASS
output.color = vec4f(vec3f(litArgs_gloss) , 1.0);
#endif

#ifdef DEBUG_METALNESS_PASS
output.color = vec4f(vec3f(litArgs_metalness) , 1.0);
#endif

#ifdef DEBUG_AO_PASS
output.color = vec4f(vec3f(litArgs_ao) , 1.0);
#endif

#ifdef DEBUG_EMISSION_PASS
output.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`,qK=`
#ifdef DEBUG_LIGHTING_PASS
		litArgs_albedo = vec3f(0.5);
#endif

#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
		litArgs_albedo = vec3f(vUv0, 0.0);
#else
		litArgs_albedo = vec3f(0.0);
#endif
#endif
`,XK=`

#ifndef _DECODE_INCLUDED_
#define _DECODE_INCLUDED_

fn decodeLinear(raw: vec4f) -> vec3f {
		return raw.rgb;
}

fn decodeGammaFloat(raw: f32) -> f32 {
		return pow(raw, 2.2);
}

fn decodeGamma3(raw: vec3f) -> vec3f {
		return pow(raw, vec3f(2.2));
}

fn decodeGamma(raw: vec4f) -> vec3f {
		return pow(raw.xyz, vec3f(2.2));
}

fn decodeRGBM(raw: vec4f) -> vec3f {
		let color = (8.0 * raw.a) * raw.rgb;
		return color * color;
}

fn decodeRGBP(raw: vec4f) -> vec3f {
		let color = raw.rgb * (-raw.a * 7.0 + 8.0);
		return color * color;
}

fn decodeRGBE(raw: vec4f) -> vec3f {
		return select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);
}

fn passThrough(raw: vec4f) -> vec4f {
		return raw;
}

fn unpackNormalXYZ(nmap: vec4f) -> vec3f {
		return nmap.xyz * 2.0 - 1.0;
}

fn unpackNormalXY(nmap: vec4f) -> vec3f {
		var xy = nmap.wy * 2.0 - 1.0;
		return vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));
}

#endif
`,jK=`
fn encodeLinear(source: vec3f) -> vec4f {
		return vec4f(source, 1.0);
}

fn encodeGamma(source: vec3f) -> vec4f {
		return vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);
}

fn encodeRGBM(source: vec3f) -> vec4f {
		var color: vec3f = pow(source, vec3f(0.5));
		color *= 1.0 / 8.0;

		var a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));
		a = ceil(a * 255.0) / 255.0;

		color /= a;
		return vec4f(color, a);
}

fn encodeRGBP(source: vec3f) -> vec4f {
		// convert incoming linear to gamma(ish)
		var gamma: vec3f = pow(source, vec3f(0.5));

		// calculate the maximum component clamped to 1..8
		var maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));

		// calculate storage factor
		var v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);

		// round the value for storage in 8bit channel
		v = ceil(v * 255.0) / 255.0;

		return vec4f(gamma / (-v * 7.0 + 8.0), v);
}

fn encodeRGBE(source: vec3f) -> vec4f {
		var maxVal: f32 = max(source.x, max(source.y, source.z));
		if (maxVal < 1e-32) {
				return vec4f(0.0, 0.0, 0.0, 0.0);
		} else {
				var e: f32 = ceil(log2(maxVal));
				return vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);
		}
}
`,YK=`
		var finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);

		finalRgb = finalRgb + litArgs_emission;
		finalRgb = addFog(finalRgb);
		finalRgb = toneMap(finalRgb);
		finalRgb = gammaCorrectOutput(finalRgb);
		output.color = vec4f(finalRgb, output.color.a);
`,KK=`
// the envAtlas is fixed at 512 pixels. every equirect is generated with 1 pixel boundary.
const atlasSize : f32 = 512.0;
const seamSize : f32 = 1.0 / atlasSize;

// map a normalized equirect UV to the given rectangle (taking 1 pixel seam into account).
fn mapUv(uv : vec2f, rect : vec4f) -> vec2f {
		return vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
								 mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}

// map a normalized equirect UV and roughness level to the correct atlas rect.
fn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {
		let t : f32 = 1.0 / exp2(level);
		return mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));
}

// map shiny level UV
fn mapShinyUv(uv : vec2f, level : f32) -> vec2f {
		let t : f32 = 1.0 / exp2(level);
		return mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));
}
`,QK=`
#ifdef LIT_SKYBOX_INTENSITY
		uniform skyboxIntensity : f32;
#endif

fn processEnvironment(color : vec3f) -> vec3f {
		#ifdef LIT_SKYBOX_INTENSITY
				return color * uniform.skyboxIntensity;
		#else
				return color;
		#endif
}
`,$K=`

var<private> dBlendModeFogFactor : f32 = 1.0;

#if (FOG != NONE)
		uniform fog_color : vec3f;
		
		#if (FOG == LINEAR)
				uniform fog_start : f32;
				uniform fog_end : f32;
		#else
				uniform fog_density : f32;
		#endif
#endif

fn getFogFactor() -> f32 {

		let depth = pcPosition.z / pcPosition.w;

		var fogFactor : f32 = 0.0;

		#if (FOG == LINEAR)
				fogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);
		#elif (FOG == EXP)
				fogFactor = exp(-depth * uniform.fog_density);
		#elif (FOG == EXP2)
				fogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);
		#endif

		return clamp(fogFactor, 0.0, 1.0);
}

fn addFog(color : vec3f) -> vec3f {
		#if (FOG != NONE)
				return mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());
		#else
				return color;
		#endif
}
`,ZK=`

#include "decodePS"

#if (GAMMA == SRGB)

		fn gammaCorrectInput(color: f32) -> f32 {
				return decodeGammaFloat(color);
		}

		fn gammaCorrectInputVec3(color: vec3f) -> vec3f {
				return decodeGamma3(color);
		}

		fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
				return vec4f(decodeGamma3(color.xyz), color.w);
		}

		fn gammaCorrectOutput(color: vec3f) -> vec3f {
				return pow(color + 0.0000001, vec3f(1.0 / 2.2));
		}

#else // NONE

		fn gammaCorrectInput(color: f32) -> f32 {
				return color;
		}

		fn gammaCorrectInputVec3(color: vec3f) -> vec3f {
				return color;
		}

		fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
				return color;
		}

		fn gammaCorrectOutput(color: vec3f) -> vec3f {
				return color;
		}

#endif
`,JK=`
		#include "gammaPS"
		varying color: vec4f;
		@fragment
		fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				output.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);
				return output;
		}
`,eQ=`
		attribute vertex_position: vec4f;
		attribute vertex_color: vec4f;
		uniform matrix_model: mat4x4f;
		uniform matrix_viewProjection: mat4x4f;
		varying color: vec4f;
		@vertex
		fn vertexMain(input : VertexInput) -> VertexOutput {
				var output : VertexOutput;
				output.color = input.vertex_color;
				output.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;
				return output;
		}
`,tQ=`

#ifdef LIT_CLUSTERED_LIGHTS
		// all this functionality that needs to be included for clustered lighting
		#define LIT_CODE_FALLOFF_LINEAR
		#define LIT_CODE_FALLOFF_SQUARED
		#define LIT_CODE_LIGHTS_POINT
		#define LIT_CODE_LIGHTS_SPOT
#endif

#ifdef AREA_LIGHTS
		var areaLightsLutTex1: texture_2d<f32>;
		var areaLightsLutTex1Sampler: sampler;
		var areaLightsLutTex2: texture_2d<f32>;
		var areaLightsLutTex2Sampler: sampler;
#endif

#ifdef LIT_LIGHTING
		#include "lightDiffuseLambertPS"

		// area lights
		#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)
				#include "ltcPS"
		#endif
#endif

#ifdef SHADOW_DIRECTIONAL
		#include "shadowCascadesPS"
#endif

#if defined(SHADOW_KIND_PCF1)
		#include "shadowPCF1PS"
#endif

#if defined(SHADOW_KIND_PCF3)
		#include "shadowPCF3PS"
#endif

#if defined(SHADOW_KIND_PCF5)
		#include "shadowPCF5PS"
#endif

#if defined(SHADOW_KIND_PCSS)
		#include "linearizeDepthPS"
		#include "shadowPCSSPS"
		#include "shadowSoftPS"
#endif

#if defined(SHADOW_KIND_VSM)
		#include "shadowEVSMPS"
#endif

#ifdef LIT_CODE_FALLOFF_LINEAR
		#include "falloffLinearPS"
#endif

#ifdef LIT_CODE_FALLOFF_SQUARED
		#include "falloffInvSquaredPS"
#endif

#ifdef LIT_CODE_LIGHTS_POINT
		#include "lightDirPointPS"
#endif

#ifdef LIT_CODE_LIGHTS_SPOT
		#include "spotPS"
#endif

#ifdef LIT_CODE_COOKIE
		#include "cookiePS"
#endif

// clustered lighting
#ifdef LIT_CLUSTERED_LIGHTS
		#include "clusteredLightPS"
#endif

#ifdef LIGHT_COUNT > 0
		// LOOP - generate shadow evaluation functions for all non-clustered lights
		#include "lightFunctionShadowPS, LIGHT_COUNT"

		// LOOP - generate light evaluation functions for all non-clustered lights
		#include "lightFunctionLightPS, LIGHT_COUNT"
#endif
`,sQ=`
fn evaluateBackend() -> FragmentOutput {

		var output: FragmentOutput;

		// apply SSAO during lighting
		#ifdef LIT_SSAO
				litArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * ssaoTextureSizeInv, 0.0).r;
		#endif

		// transform tangent space normals to world space
		#ifdef LIT_NEEDS_NORMAL
				#ifdef LIT_SPECULAR
						getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);
				#endif

				#ifdef LIT_CLEARCOAT
						ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));
				#endif
		#endif

		#ifdef LIT_SPECULAR_OR_REFLECTION
				#ifdef LIT_METALNESS
						var f0: f32 = 1.0 / litArgs_ior;
						f0 = (f0 - 1.0) / (f0 + 1.0);
						f0 = f0 * f0;
						litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);
						litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);
				#endif

				#ifdef LIT_IRIDESCENCE
						var iridescenceFresnel: vec3f = getIridescence(saturate3(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);
				#endif
		#endif

		// ambient
		#ifdef LIT_ADD_AMBIENT
				addAmbient(litArgs_worldNormal);

				#ifdef LIT_SPECULAR
						dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);
				#endif

				// move ambient color out of diffuse (used by Lightmapper, to multiply ambient color by accumulated AO)
				#ifdef LIT_SEPARATE_AMBIENT
						var dAmbientLight: vec3f = dDiffuseLight;
						dDiffuseLight = vec3(0.0);
				#endif
		#endif

		#ifndef LIT_OLD_AMBIENT
				dDiffuseLight = dDiffuseLight * uniform.material_ambient;
		#endif

		#ifdef LIT_AO
				#ifndef LIT_OCCLUDE_DIRECT
						occludeDiffuse(litArgs_ao);
				#endif
		#endif

		#ifdef LIT_LIGHTMAP
				addLightMap(
						litArgs_lightmap, 
						litArgs_lightmapDir, 
						litArgs_worldNormal, 
						dViewDirW, 
						dReflDirW, 
						litArgs_gloss, 
						litArgs_specularity, 
						dVertexNormalW,
						dTBN
				#if defined(LIT_IRIDESCENCE)
						, iridescenceFresnel,
						litArgs_iridescence_intensity
				#endif
				);
		#endif

		#ifdef LIT_LIGHTING || LIT_REFLECTIONS

				#ifdef LIT_REFLECTIONS

						#ifdef LIT_CLEARCOAT
								addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);
						
								#ifdef LIT_SPECULAR_FRESNEL
										ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));
										ccReflection.rgb = ccReflection.rgb * ccFresnel;
								#else
										ccFresnel = 0.0;
								#endif
						#endif

						#ifdef LIT_SPECULARITY_FACTOR
								ccReflection.rgb = ccReflection.rgb * litArgs_specularityFactor;
						#endif

						#ifdef LIT_SHEEN
								addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);
						#endif

						// Fresnel has to be applied to reflections
						addReflection(dReflDirW, litArgs_gloss);

						#ifdef LIT_FRESNEL_MODEL

								dReflection.rgb = dReflection.rgb * getFresnel(
										dot(dViewDirW, litArgs_worldNormal), 
										litArgs_gloss, 
										litArgs_specularity
								#if defined(LIT_IRIDESCENCE)
										, iridescenceFresnel,
										litArgs_iridescence_intensity
								#endif
										);

						#else

								dReflection.rgb = dReflection.rgb * litArgs_specularity;

						#endif

						#ifdef LIT_SPECULARITY_FACTOR
								dReflection.rgb = dReflection.rgb * litArgs_specularityFactor;
						#endif

				#endif

				#ifdef AREA_LIGHTS
						// specular has to be accumulated differently if we want area lights to look correct
						dSpecularLight = dSpecularLight * litArgs_specularity;

						#ifdef LIT_SPECULAR
								// evaluate material based area lights data, shared by all area lights
								calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);
						#endif
				#endif
				
				// LOOP - evaluate all non-clustered lights
				#include "lightEvaluationPS, LIGHT_COUNT"

				// clustered lighting
				#ifdef LIT_CLUSTERED_LIGHTS
						addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,
								#if defined(LIT_CLEARCOAT)
												ccReflDirW,
								#endif
												litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, 
								#if defined(LIT_IRIDESCENCE)
												iridescenceFresnel,
								#endif
												litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity
						);
				#endif

				#ifdef AREA_LIGHTS

						#ifdef LIT_CLEARCOAT
								// specular has to be accumulated differently if we want area lights to look correct
								litArgs_clearcoat_specularity = 1.0;
						#endif

						#ifdef LIT_SPECULAR
								litArgs_specularity = vec3(1.0);
						#endif

				#endif

				#ifdef LIT_REFRACTION
						addRefraction(
								litArgs_worldNormal, 
								dViewDirW, 
								litArgs_thickness, 
								litArgs_gloss, 
								litArgs_specularity, 
								litArgs_albedo, 
								litArgs_transmission,
								litArgs_ior,
								litArgs_dispersion
								#if defined(LIT_IRIDESCENCE)
										, iridescenceFresnel, 
										litArgs_iridescence_intensity
								#endif
						);
				#endif
		#endif

		// apply ambient occlusion
		#ifdef LIT_AO
				#ifdef LIT_OCCLUDE_DIRECT
						occludeDiffuse(litArgs_ao);
				#endif

				#if LIT_OCCLUDE_SPECULAR != NONE
						occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);
				#endif
		#endif

		#ifdef LIT_SPECULARITY_FACTOR
				dSpecularLight = dSpecularLight * litArgs_specularityFactor;
		#endif

		#if !defined(LIT_OPACITY_FADES_SPECULAR)

				#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED

						var specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));
						#ifdef LIT_CLEARCOAT
								specLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));
						#endif
						litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);

				#endif

				litArgs_opacity = litArgs_opacity * material_alphaFade;

		#endif

		#include "endPS"
		#include "outputAlphaPS"

		#ifdef LIT_MSDF
				output.color = applyMsdf(gl_FragColor);
		#endif

		#include "outputPS"
		#include "debugOutputPS"

		#ifdef LIT_SHADOW_CATCHER
				// output when the shadow catcher is enabled - accumulated shadows
				output.color = vec4f(dShadowCatcher, output.color.a);
		#endif

		return output;
}
`,iQ=`

// globals
var<private> sReflection: vec3f;
var<private> dVertexNormalW: vec3f;
var<private> dTangentW: vec3f;
var<private> dBinormalW: vec3f;
var<private> dViewDirW: vec3f;
var<private> dReflDirW: vec3f;
var<private> ccReflDirW: vec3f;

// Per-light temporaries
var<private> dLightDirNormW: vec3f;
var<private> dAtten: f32;

// Outputs
var<private> dTBN: mat3x3f;
var<private> dReflection: vec4f;
var<private> dDiffuseLight: vec3f;
var<private> dSpecularLight: vec3f;
var<private> ccFresnel: f32;
var<private> ccReflection: vec3f;
var<private> ccSpecularLight: vec3f;
var<private> ccSpecularityNoFres: f32;
var<private> sSpecularLight: vec3f;

// FRAGMENT SHADER INPUTS: UNIFORMS

#ifdef LIT_DISPERSION
		uniform material_dispersion: f32;
#endif

#ifndef LIT_OPACITY_FADES_SPECULAR
		uniform material_alphaFade: f32;
#endif

#ifdef LIT_SSAO
		var ssaoTexture : texture_2d<f32>;
		var ssaoTextureSampler : sampler;
		uniform ssaoTextureSizeInv: vec2f;
#endif

// lighting and shadowing declarations

#ifdef LIT_SHADOW_CATCHER
		// a variable to accumulate shadows for shadow catcher materials
		var<private> dShadowCatcher: f32 = 1.0;
#endif

// LOOP - uniform declarations for all non-clustered lights
#if LIGHT_COUNT > 0
		#include "lightDeclarationPS, LIGHT_COUNT"
#endif

#ifdef LIT_SPECULAR
		#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) 
				#define LIT_OLD_AMBIENT
		#endif
#endif
`,aQ=`

@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {

		dReflection = vec4f(0.0);

		#ifdef LIT_CLEARCOAT
				ccSpecularLight = vec3f(0.0);
				ccReflection = vec3f(0.0);
		#endif

		#if LIT_NONE_SLICE_MODE == SLICED
				#include "startNineSlicedPS"
		#elif LIT_NONE_SLICE_MODE == TILED
				#include "startNineSlicedTiledPS"
		#endif

		#ifdef LIT_NEEDS_NORMAL
				dVertexNormalW = normalize(vNormalW);

				#ifdef LIT_TANGENTS
						#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
								dTangentW = vTangentW;
								dBinormalW = vBinormalW;
						#endif
				#endif

				getViewDir();

				#ifdef LIT_TBN
						getTBN(dTangentW, dBinormalW, dVertexNormalW);

						#ifdef LIT_TWO_SIDED_LIGHTING
								handleTwoSidedLighting();
						#endif
				#endif
		#endif

		// invoke frontend functions
		evaluateFrontend();

		#include "debugProcessFrontendPS"

		var output: FragmentOutput = evaluateBackend();

		return output;
}
`,nQ=`

#ifdef LIT_NEEDS_NORMAL
		#include "cubeMapRotatePS"
		#include "cubeMapProjectPS"
		#include "envProcPS"
#endif

// ----- specular or reflections -----
#ifdef LIT_SPECULAR_OR_REFLECTION
		#ifdef LIT_METALNESS
				#include "metalnessModulatePS"
		#endif

		#if LIT_FRESNEL_MODEL == SCHLICK
				#include "fresnelSchlickPS"
		#endif

		#ifdef LIT_IRIDESCENCE
				#include "iridescenceDiffractionPS"
		#endif
#endif

// ----- ambient occlusion -----
#ifdef LIT_AO
		#include "aoDiffuseOccPS"
		#include "aoSpecOccPS"
#endif

#if LIT_REFLECTION_SOURCE == ENVATLASHQ
		#include "envAtlasPS"
		#include "reflectionEnvHQPS"
#elif LIT_REFLECTION_SOURCE == ENVATLAS
		#include "envAtlasPS"
		#include "reflectionEnvPS"
#elif LIT_REFLECTION_SOURCE == CUBEMAP
		#include "reflectionCubePS"
#elif LIT_REFLECTION_SOURCE == SPHEREMAP
		#include "reflectionSpherePS"
#endif

#ifdef LIT_REFLECTIONS
		#ifdef LIT_CLEARCOAT
				#include "reflectionCCPS"
		#endif

		#ifdef LIT_SHEEN
				#include "reflectionSheenPS"
		#endif
#endif

#ifdef LIT_REFRACTION
		#if defined(LIT_DYNAMIC_REFRACTION)
				#include "refractionDynamicPS"
		#elif defined(LIT_REFLECTIONS)
				#include "refractionCubePS"
		#endif
#endif

#ifdef LIT_SHEEN
		#include "lightSheenPS"
#endif

#ifdef LIT_GGX_SPECULAR
		uniform material_anisotropy: f32;
#endif

uniform material_ambient: vec3f;

#ifdef LIT_SPECULAR
		#ifdef LIT_LIGHTING
				#ifdef LIT_GGX_SPECULAR
						#include "lightSpecularAnisoGGXPS"
				#else
						#include "lightSpecularBlinnPS"
				#endif
		#endif
#endif

#include "combinePS"

#ifdef LIT_LIGHTMAP
		#include "lightmapAddPS"
#endif

#ifdef LIT_ADD_AMBIENT
		#include "ambientPS"
#endif

#ifdef LIT_MSDF
		#include "msdfPS"
#endif

#ifdef LIT_NEEDS_NORMAL
		#include "viewDirPS"
		#ifdef LIT_SPECULAR
				#ifdef LIT_GGX_SPECULAR
						#include "reflDirAnisoPS"
				#else
						#include "reflDirPS"
				#endif
		#endif
#endif

// lighting functionality
#include "lightingPS"

`,rQ=`

#include "basePS"
#include "sphericalPS"
#include "decodePS"
#include "gammaPS"
#include "tonemappingPS"
#include "fogPS"

// 9-slice support code
#if LIT_NONE_SLICE_MODE == SLICED
		#include "baseNineSlicedPS"
#elif LIT_NONE_SLICE_MODE == TILED
		#include "baseNineSlicedTiledPS"
#endif

// TBN
#ifdef LIT_TBN
		#include "TBNPS"

		#ifdef LIT_TWO_SIDED_LIGHTING
				#include "twoSidedLightingPS"
		#endif
#endif

`,oQ=`
#ifdef VERTEX_COLOR
		attribute vertex_color: vec4f;
#endif

#ifdef NINESLICED

		varying vMask: vec2f;
		varying vTiledUv: vec2f;

		uniform innerOffset: vec4f;
		uniform outerScale: vec2f;
		uniform atlasRect: vec4f;

#endif

var<private> dPositionW: vec3f;
var<private> dModelMatrix: mat4x4f;

#include "transformCoreVS"

#ifdef UV0
		attribute vertex_texCoord0: vec2f;
		#include "uv0VS"
#endif

#ifdef UV1
		attribute vertex_texCoord1: vec2f;
		#include "uv1VS"
#endif


#ifdef LINEAR_DEPTH
		#ifndef VIEWMATRIX
		#define VIEWMATRIX
				uniform matrix_view: mat4x4f;
		#endif
#endif

#include "transformVS"

#ifdef NORMALS
		#include "normalCoreVS"
		#include "normalVS"
#endif

#ifdef TANGENTS
		attribute vertex_tangent: vec4f;
		#include "tangentBinormalVS"
#endif

// expand uniforms for uv transforms
#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"

#ifdef MSDF
		#include "msdfVS"
#endif

@vertex
fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		output.position = getPosition();
		output.vPositionW = getWorldPosition();

		#ifdef NORMALS
				output.vNormalW = getNormal();
		#endif

		#ifdef TANGENTS
				output.vTangentW = getTangent();
				output.vBinormalW = getBinormal();
		#elif defined(GGX_SPECULAR)
				output.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));
		#endif

		#ifdef UV0
				var uv0: vec2f = getUv0();
				#ifdef UV0_UNMODIFIED
						output.vUv0 = uv0;
				#endif
		#endif

		#ifdef UV1
				var uv1: vec2f = getUv1();
				#ifdef UV1_UNMODIFIED
						output.vUv1 = uv1;
				#endif
		#endif

		// expand code for uv transforms
		#include "uvTransformVS, UV_TRANSFORMS_COUNT"

		#ifdef VERTEX_COLOR
				output.vVertexColor = vertex_color;
		#endif

		#ifdef LINEAR_DEPTH
				// linear depth from the worldPosition, see getLinearDepth
				output.vLinearDepth = -(matrix_view * vec4f(vPositionW, 1.0)).z;
		#endif

		#ifdef MSDF
				unpackMsdfParams();
		#endif

		return output;
}
`,lQ=`

// Surface albedo absorbance
var<private> litArgs_albedo: vec3f;

// Transparency
var<private> litArgs_opacity: f32;

// Emission color
var<private> litArgs_emission: vec3f;

// Normal direction in world space
var<private> litArgs_worldNormal: vec3f;

// Ambient occlusion amount, range [0..1]
var<private> litArgs_ao: f32;

// Light map color
var<private> litArgs_lightmap: vec3f;

// Light map direction
var<private> litArgs_lightmapDir: vec3f;

// Surface metalness factor, range [0..1]
var<private> litArgs_metalness: f32;

// The f0 specularity factor
var<private> litArgs_specularity: vec3f;

// Specularity intensity factor, range [0..1]
var<private> litArgs_specularityFactor: f32;

// The microfacet glossiness factor, range [0..1]
var<private> litArgs_gloss: f32;

// Glossiness of the sheen layer, range [0..1]
var<private> litArgs_sheen_gloss: f32;

// The color of the f0 specularity factor for the sheen layer
var<private> litArgs_sheen_specularity: vec3f;

// Transmission factor (refraction), range [0..1]
var<private> litArgs_transmission: f32;

// Uniform thickness of medium, used by transmission, range [0..inf]
var<private> litArgs_thickness: f32;

// Index of refraction
var<private> litArgs_ior: f32;

// Dispersion, range [0..1] typically, but can be higher
var<private> litArgs_dispersion: f32;

// Iridescence effect intensity, range [0..1]
var<private> litArgs_iridescence_intensity: f32;

// Thickness of the iridescent microfilm layer, value is in nanometers, range [0..1000]
var<private> litArgs_iridescence_thickness: f32;

// The normal used for the clearcoat layer
var<private> litArgs_clearcoat_worldNormal: vec3f;

// Intensity of the clearcoat layer, range [0..1]
var<private> litArgs_clearcoat_specularity: f32;

// Glossiness of clearcoat layer, range [0..1]
var<private> litArgs_clearcoat_gloss: f32;

`,hQ=`

		// global texture bias for standard textures
		#if LIT_NONE_SLICE_MODE == TILED
				var<private> textureBias: f32 = -1000.0;
		#else
				uniform textureBias: f32;
		#endif

		#include "litShaderArgsPS"
`,cQ=`
		color += uniform.morphFactor[{i}].element * textureSampleLevel(morphBlendTex{i}, morphBlendTex{i}Sampler, input.uv0, 0).xyz;
`,uQ=`
		var morphBlendTex{i}: texture_2d<f32>;
		var morphBlendTex{i}Sampler : sampler;
`,dQ=`

		varying uv0: vec2f;

		// LOOP - source morph target textures
		#include "morphDeclarationPS, MORPH_TEXTURE_COUNT"

		#if MORPH_TEXTURE_COUNT > 0
				uniform morphFactor: array<f32, {MORPH_TEXTURE_COUNT}>;
		#endif

		@fragment
		fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;

				var color = vec3f(0, 0, 0);

				// LOOP - source morph target textures
				#include "morphEvaluationPS, MORPH_TEXTURE_COUNT"

				output.color = vec4f(color, 1.0);
				return output;
		}
`,fQ=`
		attribute vertex_position: vec2f;
		varying uv0: vec2f;

		@vertex
		fn vertexMain(input: VertexInput) -> VertexOutput {
				var output: VertexOutput;
				output.position = vec4f(input.vertex_position, 0.5, 1.0);
				output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);
				return output;
		}
`,pQ=`
attribute vertex_normal: vec3f;
#ifdef MORPHING_NORMAL
	#ifdef MORPHING_INT
		uniform morphNormalTex: texture_2d<u32>;
		uniform morphNormalTexSampler: sampler;
	#else
		uniform morphNormalTex: texture_2d<f32>;
		uniform morphNormalTexSampler: sampler;
	#endif
#endif
fn getLocalNormal(vertexNormal: vec3f) -> vec3f {
	var localNormal: vec3f = vertexNormal;
	#ifdef MORPHING_NORMAL
		let morphUV: vec2i = getTextureMorphCoords();
		#ifdef MORPHING_INT
			let morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);
			let morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;
			localNormal = localNormal + morphNormalF;
		#else
			let morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;
			localNormal = localNormal + morphNormal;
		#endif
	#endif
	return localNormal;
}
#ifdef SKIN
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#elif defined(INSTANCING)
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#else
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return uniform.matrix_normal;
	}
#endif
`,mQ=`
`,_Q=`

#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)

		output.color = vec4f(output.color.rgb, litArgs_opacity);

#elif LIT_BLEND_TYPE == PREMULTIPLIED

		output.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);

#else

		output.color = vec4f(output.color.rgb, 1.0);

#endif
`,gQ=`

varying vUv0: vec2f;

#ifdef CUBEMAP_SOURCE
		var sourceCube: texture_cube<f32>;
		var sourceCubeSampler : sampler;
#else
		var sourceTex: texture_2d<f32>;
		var sourceTexSampler : sampler;
#endif

#ifdef USE_SAMPLES_TEX
		// samples
		var samplesTex: texture_2d<f32>;
		var samplesTexSampler : sampler;
		uniform samplesTexInverseSize: vec2f;
#endif

// params:
// x - target cubemap face 0..6
// y - target image total pixels
// z - source cubemap size
uniform params: vec3f;

fn targetFace() -> f32 { return uniform.params.x; }
fn targetTotalPixels() -> f32 { return uniform.params.y; }
fn sourceTotalPixels() -> f32 { return uniform.params.z; }

const PI: f32 = 3.141592653589793;

fn saturate(x: f32) -> f32 {
		return clamp(x, 0.0, 1.0);
}

#include "decodePS"
#include "encodePS"

//-- supported projections

fn modifySeams(dir: vec3f, scale: f32) -> vec3f {
		let adir = abs(dir);
		let M = max(max(adir.x, adir.y), adir.z);
		return dir / M * vec3f(
				select(scale, 1.0, adir.x == M),
				select(scale, 1.0, adir.y == M),
				select(scale, 1.0, adir.z == M)
		);
}

fn toSpherical(dir: vec3f) -> vec2f {
		let nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));
		return vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));
}

fn fromSpherical(uv: vec2f) -> vec3f {
		return vec3f(cos(uv.y) * sin(uv.x),
								sin(uv.y),
								cos(uv.y) * cos(uv.x));
}

fn getDirectionEquirect(uv: vec2f) -> vec3f {
		return fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));
}

// octahedral code, based on https://jcgt.org/published/0003/02/01/
// "Survey of Efficient Representations for Independent Unit Vectors" by Cigolle, Donow, Evangelakos, Mara, McGuire, Meyer

fn signNotZero(k: f32) -> f32 {
		return select(-1.0, 1.0, k >= 0.0);
}

fn signNotZeroVec2(v: vec2f) -> vec2f {
		return vec2f(signNotZero(v.x), signNotZero(v.y));
}

// Returns a unit vector. Argument o is an octahedral vector packed via octEncode, on the [-1, +1] square
fn octDecode(o: vec2f) -> vec3f {
		var v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
		if (v.y < 0.0) {
				var temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);
				v = vec3f(temp.x, v.y, temp.y);
		}
		return normalize(v);
}

fn getDirectionOctahedral(uv: vec2f) -> vec3f {
		return octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);
}

// Assumes that v is a unit vector. The result is an octahedral vector on the [-1, +1] square
fn octEncode(v: vec3f) -> vec2f {
		let l1norm = abs(v.x) + abs(v.y) + abs(v.z);
		var result = v.xz * (1.0 / l1norm);
		if (v.y < 0.0) {
				result = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);
		}
		return result;
}

/////////////////////////////////////////////////////////////////////

#ifdef CUBEMAP_SOURCE
		fn sampleCubemapDir(dir: vec3f) -> vec4f {
				return textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));
		}

		fn sampleCubemapSph(sph: vec2f) -> vec4f {
				return sampleCubemapDir(fromSpherical(sph));
		}

		fn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
				return textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);
		}

		fn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
				return sampleCubemapDirLod(fromSpherical(sph), mipLevel);
		}
#else

		fn sampleEquirectSph(sph: vec2f) -> vec4f {
				let uv = sph / vec2f(PI * 2.0, PI) + 0.5;
				return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));
		}

		fn sampleEquirectDir(dir: vec3f) -> vec4f {
				return sampleEquirectSph(toSpherical(dir));
		}

		fn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
				let uv = sph / vec2f(PI * 2.0, PI) + 0.5;
				return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);
		}

		fn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
				return sampleEquirectSphLod(toSpherical(dir), mipLevel);
		}

		fn sampleOctahedralDir(dir: vec3f) -> vec4f {
				let uv = octEncode(dir) * 0.5 + 0.5;
				return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));
		}

		fn sampleOctahedralSph(sph: vec2f) -> vec4f {
				return sampleOctahedralDir(fromSpherical(sph));
		}

		fn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
				let uv = octEncode(dir) * 0.5 + 0.5;
				return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);
		}

		fn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
				return sampleOctahedralDirLod(fromSpherical(sph), mipLevel);
		}

#endif

fn getDirectionCubemap(uv: vec2f) -> vec3f {
		let st = uv * 2.0 - 1.0;
		let face = targetFace();

		var vec: vec3f;
		if (face == 0.0) {
				vec = vec3f(1, -st.y, -st.x);
		} else if (face == 1.0) {
				vec = vec3f(-1, -st.y, st.x);
		} else if (face == 2.0) {
				vec = vec3f(st.x, 1, st.y);
		} else if (face == 3.0) {
				vec = vec3f(st.x, -1, -st.y);
		} else if (face == 4.0) {
				vec = vec3f(st.x, -st.y, 1);
		} else {
				vec = vec3f(-st.x, -st.y, -1);
		}

		return normalize(modifySeams(vec, 1.0));
}

fn matrixFromVector(n: vec3f) -> mat3x3f {
		let a = 1.0 / (1.0 + n.z);
		let b = -n.x * n.y * a;
		let b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);
		let b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);
		return mat3x3f(b1, b2, n);
}

fn matrixFromVectorSlow(n: vec3f) -> mat3x3f {
		let up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);
		let x = normalize(cross(up, n));
		let y = cross(n, x);
		return mat3x3f(x, y, n);
}

fn reproject(uv: vec2f) -> vec4f {
		if ({NUM_SAMPLES} <= 1) {
				// single sample
				return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));
		} else {
				// multi sample
				let t = {TARGET_FUNC}(uv);
				let tu = dpdx(t);
				let tv = dpdy(t);

				var result = vec3f(0.0);
				for (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {
						for (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {
								result += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +
																														tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +
																														tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));
						}
				}
				return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));
		}
}

const unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);

#ifdef USE_SAMPLES_TEX
		fn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {
				var u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;
				var v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;

				var raw: vec4f;
				raw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
				raw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
				raw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
				raw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);

				*L = raw.xyz * 2.0 - 1.0;
				*mipLevel = raw.w * 8.0;
		}

		// convolve an environment given pre-generated samples
		fn prefilterSamples(uv: vec2f) -> vec4f {
				// construct vector space given target direction
				let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));

				var L: vec3f;
				var mipLevel: f32;

				var result = vec3f(0.0);
				var totalWeight = 0.0;
				for (var i = 0; i < {NUM_SAMPLES}; i += 1) {
						unpackSample(i, &L, &mipLevel);
						result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;
						totalWeight += L.z;
				}

				return {ENCODE_FUNC}(result / totalWeight);
		}

		// unweighted version of prefilterSamples
		fn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {
				// construct vector space given target direction
				let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));

				var L: vec3f;
				var mipLevel: f32;

				var result = vec3f(0.0);
				for (var i = 0; i < {NUM_SAMPLES}; i += 1) {
						unpackSample(i, &L, &mipLevel);
						result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));
				}

				return {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));
		}
#endif

@fragment
fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		output.color = {PROCESS_FUNC}(input.vUv0);
		return output;
}
`,yQ=`
attribute vertex_position: vec2f;
uniform uvMod: vec4f;
varying vUv0: vec2f;

@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	output.position = vec4f(input.vertex_position, 0.5, 1.0);
	output.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);
	return output;
}
`,vQ=`

attribute vertex_boneWeights: vec4f;
attribute vertex_boneIndices: vec4f;

var texture_poseMap: texture_2d<f32>;

struct BoneMatrix {
		v1: vec4f,
		v2: vec4f,
		v3: vec4f,
}

fn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {

		let v = index / width;
		let u = index % width;

		var result: BoneMatrix;
		result.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);
		result.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);
		result.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);
		return result;
}

fn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {

		let width = i32(textureDimensions(texture_poseMap).x);
		var indices = vec4i(indicesFloat + 0.5) * 3;

		let boneA = getBoneMatrix(width, indices.x);
		let boneB = getBoneMatrix(width, indices.y);
		let boneC = getBoneMatrix(width, indices.z);
		let boneD = getBoneMatrix(width, indices.w);

		// ... rest of getSkinMatrix remains the same ...
		let v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;
		let v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;
		let v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;

		let one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));

		// transpose to 4x4 matrix
		return mat4x4f(
				v1.x, v2.x, v3.x, 0,
				v1.y, v2.y, v3.y, 0,
				v1.z, v2.z, v3.z, 0,
				v1.w, v2.w, v3.w, one
		);
}
`,SQ=`
		#define LIT_SKYBOX_INTENSITY

		#include "envProcPS"
		#include "gammaPS"
		#include "tonemappingPS"

		// Varying and uniform declarations
		varying vViewDir : vec3f;
		uniform skyboxHighlightMultiplier : f32;

		#ifdef SKY_CUBEMAP

				var texture_cubeMap : texture_cube<f32>;
				var texture_cubeMap_sampler : sampler;

				#ifdef SKYMESH
						varying vWorldPos : vec3f;
						uniform cubeMapRotationMatrix : mat3x3f;
						uniform projectedSkydomeCenter : vec3f;
				#endif

		#else // env-atlas

				#include "sphericalPS"
				#include "envAtlasPS"

				var texture_envAtlas : texture_2d<f32>;
				var texture_envAtlas_sampler : sampler;

				uniform mipLevel : f32;

		#endif

		@fragment
		fn fragmentMain(input : FragmentInput) -> FragmentOutput {

				var linear : vec3f;
				var dir : vec3f;

				#ifdef SKY_CUBEMAP

						#ifdef SKYMESH
								// get vector from world space pos to tripod origin
								var envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);
								dir = envDir * uniform.cubeMapRotationMatrix;
						#else
								dir = input.vViewDir;
						#endif

						dir.x *= -1.0;
						linear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));

				#else // env-atlas

						dir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);
						let uv : vec2f = toSphericalUv(normalize(dir));
						linear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));

				#endif

				// our HDR encodes values up to 64, so allow extra brightness for the clipped values
				if (any(linear >= vec3f(64.0))) {
						linear *= uniform.skyboxHighlightMultiplier;
				}
				
				var output: FragmentOutput;
				output.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
				return output;
		}
`,bQ=`
		// Attribute
		attribute aPosition : vec4f;

		#ifndef VIEWMATRIX
		#define VIEWMATRIX
		uniform matrix_view : mat4x4f;
		#endif

		uniform matrix_projectionSkybox : mat4x4f;
		uniform cubeMapRotationMatrix : mat3x3f;

		varying vViewDir : vec3f;

		#ifdef SKYMESH
				uniform matrix_model : mat4x4f;
				varying vWorldPos : vec3f;
		#endif

		@vertex
		fn vertexMain(input : VertexInput) -> VertexOutput {

				var output : VertexOutput;
				var view : mat4x4f = uniform.matrix_view;

				#ifdef SKYMESH

						var worldPos : vec4f = uniform.matrix_model * input.aPosition;
						output.vWorldPos = worldPos.xyz;
						output.position = uniform.matrix_projectionSkybox * (view * worldPos);

				#else

						view[3][0] = 0.0;
						view[3][1] = 0.0;
						view[3][2] = 0.0;
						output.position = uniform.matrix_projectionSkybox * (view * input.aPosition);
						output.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;

				#endif

				// Force skybox to far Z, regardless of the clip planes on the camera
				// Subtract a tiny fudge factor to ensure floating point errors don't
				// still push pixels beyond far Z. See:
				// https://community.khronos.org/t/skybox-problem/61857

				output.position.z = output.position.w - 1.0e-7;

				return output;
		}
`,xQ=`

fn toSpherical(dir: vec3f) -> vec2f {
		let angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));
		return vec2f(angle_xz, asin(dir.y));
}

fn toSphericalUv(dir : vec3f) -> vec2f {
		const PI : f32 = 3.141592653589793;
		let uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);
		return vec2f(uv.x, 1.0 - uv.y);
}
`,TQ=`
#if (TONEMAP == NONE)
		#include "tonemappingNonePS"
#elif TONEMAP == FILMIC
		#include "tonemappingFilmicPS"
#elif TONEMAP == LINEAR
		#include "tonemappingLinearPS"
#elif TONEMAP == HEJL
		#include "tonemappingHejlPS"
#elif TONEMAP == ACES
		#include "tonemappingAcesPS"
#elif TONEMAP == ACES2
		#include "tonemappingAces2PS"
#elif TONEMAP == NEUTRAL
		#include "tonemappingNeutralPS"
#endif
`,EQ=`
uniform exposure: f32;

fn toneMap(color: vec3f) -> vec3f {
		let tA: f32 = 2.51;
		let tB: f32 = 0.03;
		let tC: f32 = 2.43;
		let tD: f32 = 0.59;
		let tE: f32 = 0.14;
		let x: vec3f = color * uniform.exposure;
		return (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);
}
`,AQ=`
uniform exposure: f32;

// ACES approximation by Stephen Hill

// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT
const ACESInputMat: mat3x3f = mat3x3f(
		vec3f(0.59719, 0.35458, 0.04823),
		vec3f(0.07600, 0.90834, 0.01566),
		vec3f(0.02840, 0.13383, 0.83777)
);

// ODT_SAT => XYZ => D60_2_D65 => sRGB
const ACESOutputMat: mat3x3f = mat3x3f(
		vec3f( 1.60475, -0.53108, -0.07367),
		vec3f(-0.10208,  1.10813, -0.00605),
		vec3f(-0.00327, -0.07276,  1.07602)
);

fn RRTAndODTFit(v: vec3f) -> vec3f {
		let a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);
		let b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);
		return a / b;
}

fn toneMap(color: vec3f) -> vec3f {
		var c: vec3f = color * (uniform.exposure / 0.6);
		c = ACESInputMat * c;

		// Apply RRT and ODT
		c = RRTAndODTFit(c);
		c = ACESOutputMat * c;

		// Clamp to [0, 1]
		return clamp(c, vec3f(0.0), vec3f(1.0));
}
`,CQ=`
const A: f32 = 0.15;
const B: f32 = 0.50;
const C: f32 = 0.10;
const D: f32 = 0.20;
const E: f32 = 0.02;
const F: f32 = 0.30;
const W: f32 = 11.2;

uniform exposure: f32;

fn uncharted2Tonemap(x: vec3f) -> vec3f {
		return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);
}

fn toneMap(color: vec3f) -> vec3f {
		var c: vec3f = uncharted2Tonemap(color * uniform.exposure);
		let whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));
		c *= whiteScale;
		return c;
}
`,wQ=`
uniform exposure: f32;

fn toneMap(color: vec3f) -> vec3f {
		let A: f32 = 0.22;
		let B: f32 = 0.3;
		let C: f32 = 0.1;
		let D: f32 = 0.2;
		let E: f32 = 0.01;
		let F: f32 = 0.3;
		let Scl: f32 = 1.25;

		let adjusted_color = color * uniform.exposure;
		let h = max(vec3f(0.0), adjusted_color - vec3f(0.004));

		return (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /
					 (h * (A * h + vec3f(B)) + vec3f(D * F)) -
					 Scl * vec3f(E / F);
}
`,RQ=`
uniform exposure: f32;

fn toneMap(color: vec3f) -> vec3f {
		return color * uniform.exposure;
}
`,MQ=`
uniform exposure: f32;

fn toneMap(col: vec3f) -> vec3f {
		var color = col * uniform.exposure;

		let startCompression = 0.8 - 0.04;
		let desaturation = 0.15;

		let x = min(color.r, min(color.g, color.b));
		let offset = select(0.04, x - 6.25 * x * x, x < 0.08);
		color -= vec3f(offset);

		let peak = max(color.r, max(color.g, color.b));
		if (peak < startCompression) {
				return color;
		}

		let d = 1.0 - startCompression;
		let newPeak = 1.0 - d * d / (peak + d - startCompression);
		color *= newPeak / peak;

		let g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);
		return mix(color, vec3f(newPeak), vec3f(g));
}
`,DQ=`
fn toneMap(color: vec3f) -> vec3f {
		return color;
}
`,PQ=`
#ifdef PIXELSNAP
		uniform uScreenSize: vec4f;
#endif

#ifdef SCREENSPACE
		uniform projectionFlipY: f32;
#endif

fn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {

		var localPos: vec3f = getLocalPosition(vertexPosition);

		#ifdef NINESLICED
				// outer and inner vertices are at the same position, scale both
				localPos.xz *= uniform.outerScale;

				// offset inner vertices inside
				// (original vertices must be in [-1;1] range)
				let positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));
				let negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));
				localPos.xz += (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;

				vTiledUv = (localPos.xz - outerScale + uniform.innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner

				localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5
				localPos = localPos.xzy;
		#endif

		var posW: vec4f = modelMatrix * vec4f(localPos, 1.0);

		#ifdef SCREENSPACE
				posW.zw = vec2f(0.0, 1.0);
		#endif

		return posW;
}

fn getPosition() -> vec4f {

		dModelMatrix = getModelMatrix();

		let posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);
		dPositionW = posW.xyz;

		var screenPos: vec4f;
		#ifdef UV1LAYOUT
				screenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);
				screenPos.y *= -1.0;
		#else
				#ifdef SCREENSPACE
						screenPos = posW;
						screenPos.y *= uniforms.projectionFlipY;
				#else
						screenPos = uniform.matrix_viewProjection * posW;
				#endif

				#ifdef PIXELSNAP
						// snap vertex to a pixel boundary
						screenPos.xy = (screenPos.xy * 0.5) + 0.5;
						screenPos.xy *= uniforms.uScreenSize.xy;
						screenPos.xy = floor(screenPos.xy);
						screenPos.xy *= uniforms.uScreenSize.zw;
						screenPos.xy = (screenPos.xy * 2.0) - 1.0;
				#endif
		#endif

		return screenPos;
}

fn getWorldPosition() -> vec3f {
		return dPositionW;
}
`,LQ=`

		attribute vertex_position: vec4f;

		uniform matrix_viewProjection: mat4x4f;
		uniform matrix_model: mat4x4f;
		uniform matrix_normal: mat3x3f;

		#ifdef MORPHING

				uniform morph_tex_params: vec2f;
				attribute morph_vertex_id: u32;

				fn getTextureMorphCoords() -> vec2i {

						// turn morph_vertex_id into int grid coordinates
						var textureSize: vec2i = vec2i(uniform.morph_tex_params);
						var morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;
						var morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);
						morphGridV = textureSize.y - morphGridV - 1;
						return vec2i(morphGridU, morphGridV);
				}

				#ifdef MORPHING_POSITION
						#ifdef MORPHING_INT
								uniform aabbSize: vec3f;
								uniform aabbMin: vec3f;
								var morphPositionTex: texture_2d<u32>;
						#else
								var morphPositionTex: texture_2d<f32>;
						#endif
				#endif
		#endif

		#ifdef defined(BATCH)
				#include "skinBatchVS"

				fn getModelMatrix() -> mat4x4f {
						return getBoneMatrix(vertex_boneIndices);
				}

		#elif defined(SKIN)
				#include "skinVS"
				fn getModelMatrix() -> mat4x4f {
						return uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
				}

		#elif defined(INSTANCING)

				#include "transformInstancingVS"

		#else

				fn getModelMatrix() -> mat4x4f {
						return uniform.matrix_model;
				}

		#endif

		fn getLocalPosition(vertexPosition: vec3f) -> vec3f {

				var localPos: vec3f = vertexPosition;

				#ifdef MORPHING_POSITION

						var morphUV: vec2i = getTextureMorphCoords();

						#ifdef MORPHING_INT
								// Use textureLoad instead of texelFetch. Coordinates must be integer type (vec2i).
								// WGSL requires explicit type conversion for vectors.
								// Division by float literal ensures floating point division.
								var morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;
						#else
								// Use textureLoad instead of texelFetch. Coordinates must be integer type (vec2i).
								var morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;
						#endif

						localPos += morphPos;

				#endif

				return localPos;
		}
`,IQ=`
#ifdef NINESLICED
		fn getUv0() -> vec2f {
				var uv = vertex_position.xz;

				// offset inner vertices inside
				let positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));
				let negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));

				uv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;

				uv = uv * -0.5 + vec2f(0.5, 0.5);
				uv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;

				vMask = vertex_texCoord0.xy;

				return uv;
		}
#else
		fn getUv0() -> vec2f {
				return vertex_texCoord0;
		}
#endif
`,OQ=`
fn getUv1() -> vec2f {
		return vertex_texCoord1;
}
`,NQ=`
vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(
		dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),
		dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)
);
`,FQ=`
		uniform {TRANSFORM_NAME_{i}}0: vec3f;
		uniform {TRANSFORM_NAME_{i}}1: vec3f;
`;const ul={ambientPS:UK,basePS:zK,combinePS:kK,cookieBlit2DPS:VK,cookieBlitCubePS:GK,cookieBlitVS:HK,debugOutputPS:WK,debugProcessFrontendPS:qK,decodePS:XK,encodePS:jK,endPS:YK,envAtlasPS:KK,envProcPS:QK,fogPS:$K,gammaPS:ZK,immediateLinePS:JK,immediateLineVS:eQ,lightBufferDefinesPS:"",lightingPS:tQ,litForwardBackendPS:sQ,litForwardDeclarationPS:iQ,litForwardMainPS:aQ,litForwardPostCodePS:nQ,litForwardPreCodePS:rQ,litMainVS:oQ,litShaderArgsPS:lQ,litShaderCorePS:hQ,morphEvaluationPS:cQ,morphDeclarationPS:uQ,morphPS:dQ,morphVS:fQ,normalCoreVS:pQ,outputPS:mQ,outputAlphaPS:_Q,reprojectPS:gQ,reprojectVS:yQ,skinVS:vQ,skyboxPS:SQ,skyboxVS:bQ,sphericalPS:xQ,tonemappingPS:TQ,tonemappingAcesPS:EQ,tonemappingAces2PS:AQ,tonemappingFilmicPS:CQ,tonemappingHejlPS:wQ,tonemappingLinearPS:RQ,tonemappingNeutralPS:MQ,tonemappingNonePS:DQ,transformVS:PQ,transformCoreVS:LQ,uv0VS:IQ,uv1VS:OQ,uvTransformVS:NQ,uvTransformUniformsPS:FQ},Kr=new H,np=new Float32Array(6),BQ=new H(-.5,0,0),UQ=new H(0,0,.5),$s={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},zQ={"{LIGHTSHAPE_PUNCTUAL}":`${ao}u`,"{LIGHTSHAPE_RECT}":`${hP}u`,"{LIGHTSHAPE_DISK}":`${cP}u`,"{LIGHTSHAPE_SPHERE}":`${uP}u`,"{LIGHT_COLOR_DIVIDER}":`${db}.0`},SO=(h,e)=>Object.keys(h).map(t=>`#define ${e}${t} ${h[t]}`).join(`
`);dt.lightBufferDefinesPS=ul.lightBufferDefinesPS=`

		${SO($s,"CLUSTER_TEXTURE_")}
		${SO(zQ,"")}
`;class kQ{constructor(e){this.areaLightsEnabled=!1,this.device=e,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;const t=$s.COUNT;this.lightsFloat=new Float32Array(4*t*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,t,this.maxLights,Ri,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new H,this.boundsDelta=new H}destroy(){var e;(e=this.lightsTexture)==null||e.destroy(),this.lightsTexture=null}createTexture(e,t,s,i,a){return new Ge(e,{name:a,width:t,height:s,mipmaps:!1,format:i,addressU:Oe,addressV:Oe,type:vr,magFilter:Je,minFilter:Je,anisotropy:1})}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock()}updateUniforms(){this._lightsTextureId.setValue(this.lightsTexture)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){const t=e._node.getWorldTransform();return t.transformVector(BQ,Kr),np[0]=Kr.x,np[1]=Kr.y,np[2]=Kr.z,t.transformVector(UQ,Kr),np[3]=Kr.x,np[4]=Kr.y,np[5]=Kr.z,np}addLightData(e,t){const s=e._type===Ns,i=e.atlasViewportAllocated,a=this.cookiesEnabled&&!!e._cookie&&i,n=this.areaLightsEnabled&&e.shape!==ao,r=this.shadowsEnabled&&e.castShadows&&i,l=e._node.getPosition();let u=null,f=null;s?r?u=e.getRenderData(null,0).shadowMatrix:a&&(u=w0.evalSpotCookieMatrix(e)):(r||a)&&(f=e.atlasViewport);const _=this.lightsFloat,g=this.lightsUint,y=t*this.lightsTexture.width*4;_[y+4*$s.POSITION_RANGE+0]=l.x,_[y+4*$s.POSITION_RANGE+1]=l.y,_[y+4*$s.POSITION_RANGE+2]=l.z,_[y+4*$s.POSITION_RANGE+3]=e.attenuationEnd;const v=e.clusteredData;if(g[y+4*$s.COLOR_ANGLES_BIAS+0]=v[0],g[y+4*$s.COLOR_ANGLES_BIAS+1]=v[1],g[y+4*$s.COLOR_ANGLES_BIAS+2]=v[2],e.castShadows){const x=e.getRenderData(null,0),C=e._getUniformBiasValues(x),M=Xc.float2Half(C.bias),w=Xc.float2Half(C.normalBias);g[y+4*$s.COLOR_ANGLES_BIAS+3]=M|w<<16}if(s&&(this.getSpotDirection(Kr,e),_[y+4*$s.DIRECTION_FLAGS+0]=Kr.x,_[y+4*$s.DIRECTION_FLAGS+1]=Kr.y,_[y+4*$s.DIRECTION_FLAGS+2]=Kr.z),g[y+4*$s.DIRECTION_FLAGS+3]=e.getClusteredFlags(r,a),u){const x=u.data;for(let C=0;C<16;C++)_[y+4*$s.PROJ_MAT_0+C]=x[C]}if(f&&(_[y+4*$s.ATLAS_VIEWPORT+0]=f.x,_[y+4*$s.ATLAS_VIEWPORT+1]=f.y,_[y+4*$s.ATLAS_VIEWPORT+2]=f.z/3),n){const x=this.getLightAreaSizes(e);_[y+4*$s.AREA_DATA_WIDTH+0]=x[0],_[y+4*$s.AREA_DATA_WIDTH+1]=x[1],_[y+4*$s.AREA_DATA_WIDTH+2]=x[2],_[y+4*$s.AREA_DATA_HEIGHT+0]=x[3],_[y+4*$s.AREA_DATA_HEIGHT+1]=x[4],_[y+4*$s.AREA_DATA_HEIGHT+2]=x[5]}}}const pE=new H,mE=new H,_E=new H,gR=new wt;class bO{constructor(){this.light=null,this.min=new H,this.max=new H}}class BA{constructor(e){this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new H,this.boundsMax=new H,this.boundsDelta=new H,this._cells=new H(1,1,1),this._cellsLimit=new H,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new bO),this.lightsBuffer=new kQ(e),this.registerUniforms(e)}set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){pE.copy(e).floor(),this._cells.equals(pE)||(this._cells.copy(pE),this._cellsLimit.copy(pE).sub(H.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,a=this.maxCellLightCount*i;let n=Math.ceil(Math.sqrt(a));n=ge.roundUp(n,this.maxCellLightCount);const r=Math.ceil(a/n);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*s*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(a),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=n,this._clusterTextureSizeData[1]=1/n,this._clusterTextureSizeData[2]=1/r,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,n,r,wm,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);const e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData)}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(H.ZERO),s.min(this._cellsLimit)}collectLights(e){const t=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;e.forEach(a=>{const n=!!(a.mask&(uo|Xd)),r=a.type===Ns&&a._outerConeAngle===0;if(a.enabled&&a.type!==ft&&a.visibleThisFrame&&a.intensity>0&&n&&!r&&i<t){let l;i<s.length?l=s[i]:(l=new bO,s.push(l)),l.light=a,a.getBoundingBox(gR),l.min.copy(gR.getMin()),l.max.copy(gR.getMax()),i++}}),s.length=i}evaluateBounds(){const e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(let i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max)}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=e?e.areaLightsEnabled:!1;const t=this._cells.x,s=this._cells.z,i=this.counts,a=this._maxCellLightCount,n=this.clusters,r=this.maxCellLightCount,l=this._usedLights;for(let u=1;u<l.length;u++){const f=l[u],_=f.light;this.lightsBuffer.addLightData(_,u),this.evalLightCellMinMax(f,mE,_E);const g=mE.x,y=_E.x,v=mE.y,x=_E.y,C=mE.z,M=_E.z;for(let w=g;w<=y;w++)for(let T=C;T<=M;T++)for(let R=v;R<=x;R++){const D=w+t*(T+R*s),I=i[D];I<a&&(n[r*D+I]=u,i[D]=I+1)}}}update(e,t=null){this.updateParams(t),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}}const VQ="muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==";let Bc=null;const BU=()=>{if(!Bc){const h=atob(VQ);Bc=Uint8Array.from(h,e=>e.charCodeAt(0))}},GQ=()=>(BU(),Bc);class UU{constructor(e=0){this.seed=0,this.seed=e*4,BU()}_next(){this.seed=(this.seed+4)%Bc.length}value(){return this._next(),Bc[this.seed]/255}vec4(e=new Ie){return this._next(),e.set(Bc[this.seed],Bc[this.seed+1],Bc[this.seed+2],Bc[this.seed+3]).mulScalar(1/255)}}const HQ=[new H(-1,0,0),new H(1,0,0),new H(0,-1,0),new H(0,1,0),new H(0,0,-1),new H(0,0,1)];class WQ{update(e,t){const s=this.colors,{r:i,g:a,b:n}=e;for(let r=0;r<6;r++)s[r*3]=i,s[r*3+1]=a,s[r*3+2]=n;for(let r=0;r<t.length;r++){const l=t[r];if(l._type===ft)for(let u=0;u<6;u++){const f=Math.max(HQ[u].dot(l._direction),0)*l._intensity,_=l._color;s[u*3]+=_.r*f,s[u*3+1]+=_.g*f,s[u*3+2]+=_.b*f}}}constructor(){this.colors=new Float32Array(6*3)}}const qQ=(h,e,t,s)=>{const i=new Ge(h,{name:`${e}${t}`,width:t,height:t,format:Lt,addressU:Zs,addressV:Zs,type:vr,magFilter:Je,minFilter:Je,anisotropy:1,mipmaps:!1});return i.lock().set(s),i.unlock(),i},XQ=new Xn,jQ=h=>XQ.get(h,()=>{const e=GQ(),t=Math.sqrt(e.length/4);return qQ(h,"BlueNoise",t,e)});class pm{constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static create(e,t){let s=null;return t._type===Ds?s=this.createCubemap(e,t._shadowResolution,t._shadowType):s=this.create2dMap(e,t._shadowResolution,t._shadowType),s}static createAtlas(e,t,s){const i=this.create2dMap(e,t,s),a=i.renderTargets,n=a[0];for(let r=0;r<5;r++)a.push(n);return i}static create2dMap(e,t,s){var f;const i=xh.get(s);let a=i.format;a===gr&&!e.textureFloatRenderable&&e.textureHalfFloatRenderable&&(a=X0);const n=(f=yr.get(a))==null?void 0:f.name;let r=Vt;s===cx&&(r=e.extTextureFloatLinear?Vt:Je),s===fm&&(r=Je);const l=new Ge(e,{format:a,width:t,height:t,mipmaps:!1,minFilter:r,magFilter:r,addressU:Oe,addressV:Oe,name:`ShadowMap2D_${n}`});let u=null;return i!=null&&i.pcf?(l.compareOnRead=!0,l.compareFunc=Nb,u=new fs({depthBuffer:l})):u=new fs({colorBuffer:l,depth:!0}),e.isWebGPU&&(u.flipY=!0),new pm(l,[u])}static createCubemap(e,t,s){var f;const i=xh.get(s),a=(f=yr.get(i.format))==null?void 0:f.name,n=s===fm,r=n?Je:Vt,l=new Ge(e,{format:i==null?void 0:i.format,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:r,magFilter:r,addressU:Oe,addressV:Oe,name:`ShadowMapCube_${a}`});n||(l.compareOnRead=!0,l.compareFunc=Nb);const u=[];for(let _=0;_<6;_++)n?u.push(new fs({colorBuffer:l,face:_,depth:!0})):u.push(new fs({depthBuffer:l,face:_}));return new pm(l,u)}}const YQ=[],KQ=[],uc=new Ie,yR=new Ie;class vR{constructor(e){this.size=Math.floor(e.w*1024),this.used=!1,this.lightId=-1,this.rect=e}}class QQ{constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new Ge(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:ki,cubemap:!1,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe}),this.cookieRenderTarget=new fs({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new Ee(0,0),new Ee(0,1),new Ee(1,0),new Ee(1,1),new Ee(2,0),new Ee(2,1)],this.scissorVec=new Ie,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){var e;(e=this.shadowAtlas)==null||e.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){var e,t;(e=this.cookieAtlas)==null||e.destroy(),this.cookieAtlas=null,(t=this.cookieRenderTarget)==null||t.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(e,t=Un){var a;const s=(a=this.shadowAtlas)==null?void 0:a.texture.format,i=xh.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e||s!==i){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=pm.createAtlas(this.device,e,t),this.shadowAtlas.cached=!0;const n=4/this.shadowAtlasResolution;this.scissorVec.set(n,n,-2*n,-2*n)}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(t),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){let s=t.atlasSplit;if(!s){const a=Math.ceil(Math.sqrt(e));s=KQ,s[0]=a,s.length=1}if(!((a,n)=>a.length===n.length&&a.every((r,l)=>r===n[l]))(s,this.atlasSplit)){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const a=this.atlasSplit[0];if(a>1){const n=1/a;for(let r=0;r<a;r++)for(let l=0;l<a;l++){const u=new Ie(r*n,l*n,n,n),f=this.atlasSplit[1+r*a+l];if(f>1)for(let _=0;_<f;_++)for(let g=0;g<f;g++){const y=n/f,v=new Ie(u.x+_*y,u.y+g*y,y,y);this.slots.push(new vR(v))}else this.slots.push(new vR(u))}}else this.slots.push(new vR(new Ie(0,0,1,1)));this.slots.sort((n,r)=>r.size-n.size)}}collectLights(e,t){const s=t.cookiesEnabled,i=t.shadowsEnabled;let a=!1,n=!1;const r=YQ;return r.length=0,(s||i)&&(u=>{for(let f=0;f<u.length;f++){const _=u[f];if(_.visibleThisFrame){const g=i&&_.castShadows,y=s&&!!_.cookie;a||(a=g),n||(n=y),(g||y)&&r.push(_)}}})(e),r.sort((u,f)=>f.maxScreenSize-u.maxScreenSize),a&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),n&&this.allocateCookieAtlas(this.cookieAtlasResolution),(a||n)&&this.subdivide(r.length,t),r}setupSlot(e,t){e.atlasViewport.copy(t);const s=e.numShadowFaces;for(let i=0;i<s;i++)if(e.castShadows||e._cookie){if(uc.copy(t),yR.copy(t),e._type===Ns&&uc.add(this.scissorVec),e._type===Ds){const a=uc.z/3,n=this.cubeSlotsOffsets[i];uc.x+=a*n.x,uc.y+=a*n.y,uc.z=a,uc.w=a,yR.copy(uc)}if(e.castShadows){const a=e.getRenderData(null,i);a.shadowViewport.copy(uc),a.shadowScissor.copy(yR)}}}assignSlot(e,t,s){e.atlasViewportAllocated=!0;const i=this.slots[t];i.lightId=e.id,i.used=!0,s&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;const s=this.collectLights(e,t);if(s.length>0){const i=this.slots;for(let r=0;r<i.length;r++)i[r].used=!1;const a=Math.min(s.length,i.length);for(let r=0;r<a;r++){const l=s[r];l.castShadows&&(l._shadowMap=this.shadowAtlas);const u=i[l.atlasSlotIndex];if(l.atlasVersion===this.version&&l.id===(u==null?void 0:u.lightId)){const f=i[l.atlasSlotIndex];f.size===i[r].size&&!f.used&&this.assignSlot(l,l.atlasSlotIndex,!1)}}let n=0;for(let r=0;r<a;r++){for(;n<i.length&&i[n].used;)n++;const l=s[r];l.atlasViewportAllocated||this.assignSlot(l,n,!0);const u=i[l.atlasSlotIndex];this.setupSlot(l,u.rect)}}this.updateUniforms()}}const Hn=[];Hn[gC]={src:wi,dst:wi,op:gF};Hn[Gn]={src:wi,dst:Y2,op:Qa};Hn[xr]={src:N0,dst:F0,op:Qa,alphaSrc:wi};Hn[Wd]={src:wi,dst:F0,op:Qa};Hn[yC]={src:wi,dst:wi,op:Qa};Hn[SC]={src:N0,dst:wi,op:Qa};Hn[bC]={src:ED,dst:mF,op:Qa};Hn[xC]={src:_F,dst:wi,op:Qa};Hn[vC]={src:ED,dst:Y2,op:Qa};Hn[TC]={src:wi,dst:wi,op:yF};Hn[EC]={src:wi,dst:wi,op:vF};let $Q=0;class Jc{constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=$Q++,this.variants=new Map,this.defines=new Map,this._definesDirty=!1,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new ms,this._depthState=new $i,this.cull=jc,this.stencilFront=null,this.stencilBack=null,this._chunks={},this._dirtyShader=!0,this._shaderVersion=0,this._scene=null,this.dirty=!0}set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}set depthBias(e){this._depthState.depthBias=e}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){const e=this.transparent,t=this.meshInstances;for(let s=0;s<t.length;s++)t[s].transparent=e}set blendState(e){this._blendState.copy(e),this._updateTransparency()}get blendState(){return this._blendState}set blendType(e){const t=Hn[e];this._blendState.setColorBlend(t.op,t.src,t.dst),this._blendState.setAlphaBlend(t.alphaOp??t.op,t.alphaSrc??t.src,t.alphaDst??t.dst);const s=e!==Gn;this._blendState.blend!==s&&(this._blendState.blend=s,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return Gn;const{colorOp:e,colorSrcFactor:t,colorDstFactor:s,alphaOp:i,alphaSrcFactor:a,alphaDstFactor:n}=this._blendState;for(let r=0;r<Hn.length;r++){const l=Hn[r];if(l.src===t&&l.dst===s&&l.op===e&&l.src===a&&l.dst===n&&l.op===i)return r}return xr}set depthState(e){this._depthState.copy(e)}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e}get depthWrite(){return this._depthState.write}copy(e){var s;this.name=e.name,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=(s=e.stencilFront)==null?void 0:s.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this.clearParameters();for(const i in e.parameters)e.parameters.hasOwnProperty(i)&&this._setParameterSimple(i,e.parameters[i].data);this.defines.clear(),e.defines.forEach((i,a)=>this.defines.set(a,i));const t=e._chunks;for(const i in t)t.hasOwnProperty(i)&&(this._chunks[i]=t[i]);return this}clone(){return new this.constructor().copy(this)}_updateMeshInstanceKeys(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){this._dirtyShader&&this.clearVariants()}getShaderVariant(e){}update(){this._definesDirty&&(this._definesDirty=!1,this.clearVariants()),this.dirty=!0}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();const e=this.meshInstances,t=e.length;for(let s=0;s<t;s++)e[s].clearShaders()}getParameter(e){return this.parameters[e]}_setParameterSimple(e,t){const s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t}}setParameter(e,t){if(t===void 0&&typeof e=="object"){const s=e;if(s.length){for(let i=0;i<s.length;i++)this.setParameter(s[i]);return}e=s.name,t=s.value}this._setParameterSimple(e,t)}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;t===void 0&&(t=s);for(const i in t){const a=s[i];a&&(a.scopeId||(a.scopeId=e.scope.resolve(i)),a.scopeId.setValue(a.data))}}setDefine(e,t){let s=!1;const{defines:i}=this;t!==void 0&&t!==!1?(s=!i.has(e)||i.get(e)!==t,i.set(e,t)):(s=i.has(e),i.delete(e)),this._definesDirty||(this._definesDirty=s)}getDefine(e){return this.defines.has(e)}destroy(){this.variants.clear();for(let e=0;e<this.meshInstances.length;e++){const t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){const s=ly(t.mesh.device);this!==s&&(t.material=s)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){const t=this.meshInstances,s=t.indexOf(e);s!==-1&&t.splice(s,1)}}class ZQ{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach(e=>{e.forEach(t=>{t.destroy()})}),this.cache.clear()}getKey(e){const t=e._type===Ds,s=e._shadowType,i=e._shadowResolution;return`${t}-${s}-${i}`}get(e,t){const s=this.getKey(t),i=this.cache.get(s);if(i&&i.length)return i.pop();const a=pm.create(e,t);return a.cached=!0,a}add(e,t){const s=this.getKey(e),i=this.cache.get(s);i?i.push(t):this.cache.set(s,[t])}}class JQ extends pa{constructor(e,t,s,i,a){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.light=s,this.face=i,this.applyVsm=a,this.shadowCamera=t.prepareFace(s,null,i),t.setupRenderPass(this,this.shadowCamera,!0)}execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}}class e${constructor(e,t){this.shadowLights=[],this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s=null){const i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,i||e._shadowMap||(e._shadowMap=pm.create(this.device,e));const a=e._type,n=a===Ns?1:6;for(let r=0;r<n;r++){const l=e.getRenderData(null,r),u=l.shadowCamera;u.nearClip=e.attenuationEnd/1e3,u.farClip=e.attenuationEnd;const f=u._node,_=e._node;if(f.setPosition(_.getPosition()),a===Ns)u.fov=e._outerConeAngle*2,f.setRotation(_.getRotation()),f.rotateLocal(-90,0,0);else if(a===Ds)if(i){const v=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;u.fov=Math.atan(1+v)*ge.RAD_TO_DEG*2}else u.fov=90;this.renderer.updateCameraFrustum(u),this.shadowRenderer.cullShadowCasters(t,e,l.visibleCasters,u,s)}}prepareLights(e,t){let s;for(let i=0;i<t.length;i++){const a=t[i];if(this.shadowRenderer.needsShadowRendering(a)&&a.atlasViewportAllocated){e.push(a);for(let n=0;n<a.numShadowFaces;n++)s=this.shadowRenderer.prepareFace(a,null,n)}}return s}buildNonClusteredRenderPasses(e,t){for(let s=0;s<t.length;s++){const i=t[s];if(this.shadowRenderer.needsShadowRendering(i)){const a=i._type===Ns,n=i.numShadowFaces;for(let r=0;r<n;r++){const l=new JQ(this.device,this.shadowRenderer,i,r,a);e.addRenderPass(l)}}}}}class t$ extends pa{constructor(e,t,s,i,a){super(e),this.shadowRenderer=t,this.light=s,this.camera=i,this.allCascadesRendering=a}execute(){const{light:e,camera:t,shadowRenderer:s,allCascadesRendering:i}=this,a=e.numShadowFaces,n=e.shadowUpdateOverrides;for(let r=0;r<a;r++)(n==null?void 0:n[r])!==no&&s.renderFace(e,t,r,!i),(n==null?void 0:n[r])===qd&&(n[r]=no)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}}const gE=new wt,dc=new H,xO=new Me,Is=[new H,new H,new H,new H,new H,new H,new H,new H],SR={min:0,max:0};function s$(h,e,t){Is[0].x=Is[1].x=Is[2].x=Is[3].x=e.x,Is[1].y=Is[3].y=Is[7].y=Is[5].y=e.y,Is[2].z=Is[3].z=Is[6].z=Is[7].z=e.z,Is[4].x=Is[5].x=Is[6].x=Is[7].x=t.x,Is[0].y=Is[2].y=Is[4].y=Is[6].y=t.y,Is[0].z=Is[1].z=Is[4].z=Is[5].z=t.z;let s=9999999999,i=-9999999999;for(let a=0;a<8;++a){h.transformPoint(Is[a],Is[a]);const n=Is[a].z;n<s&&(s=n),n>i&&(i=n)}return SR.min=s,SR.max=i,SR}class i${constructor(e,t){this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s,i=null){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=pm.create(this.device,e));const a=s._nearClip;this.generateSplitDistances(e,a,Math.min(s._farClip,e.shadowDistance));const n=e.shadowUpdateOverrides;for(let r=0;r<e.numCascades&&(n==null?void 0:n[r])!==no;r++){const l=e.getRenderData(s,r),u=l.shadowCamera;u.renderTarget=e._shadowMap.renderTargets[0],l.shadowViewport.copy(e.cascades[r]),l.shadowScissor.copy(e.cascades[r]);const f=u._node,_=e._node;f.setPosition(_.getPosition()),f.setRotation(_.getRotation()),f.rotateLocal(-90,0,0);const g=r===0?a:e._shadowCascadeDistances[r-1],y=e._shadowCascadeDistances[r],v=s.getFrustumCorners(g,y);dc.set(0,0,0);const x=s.node.getWorldTransform();for(let q=0;q<8;q++)x.transformPoint(v[q],v[q]),dc.add(v[q]);dc.mulScalar(1/8);let C=0;for(let q=0;q<8;q++){const G=v[q].sub(dc).length();G>C&&(C=G)}const M=f.right,w=f.up,T=f.forward,R=.25*e._shadowResolution/C,D=Math.ceil(dc.dot(w)*R)/R,I=Math.ceil(dc.dot(M)*R)/R,U=w.mulScalar(D),O=M.mulScalar(I),N=dc.dot(T),z=T.mulScalar(N);dc.add2(U,O).add(z),f.setPosition(dc),f.translateLocal(0,0,1e6),u.nearClip=.01,u.farClip=2e6,u.orthoHeight=C,this.renderer.updateCameraFrustum(u),this.shadowRenderer.cullShadowCasters(t,e,l.visibleCasters,u,i);let X=!0;const Y=l.visibleCasters;for(let q=0;q<Y.length;q++){const G=Y[q];X?(X=!1,gE.copy(G.aabb)):gE.add(G.aabb)}xO.copy(f.getWorldTransform()).invert();const F=s$(xO,gE.getMin(),gE.getMax());f.translateLocal(0,0,F.max+.1),u.farClip=F.max-F.min+.2,l.projectionCompensation=C}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(let i=1;i<e.numCascades;i++){const a=i/e.numCascades,n=t+(s-t)*a,r=t*(s/t)**a,l=ge.lerp(n,r,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=l}}getLightRenderPass(e,t){let s=null;if(this.shadowRenderer.needsShadowRendering(e)){const i=e.numShadowFaces,a=e.shadowUpdateOverrides;let n=!0,r;for(let l=0;l<i;l++)(a==null?void 0:a[l])===no&&(n=!1),r=this.shadowRenderer.prepareFace(e,t,l);s=new t$(this.device,this.shadowRenderer,e,t,n),this.shadowRenderer.setupRenderPass(s,r,n)}return s}}const bR=new Set,TO=new Me,EO=new Me,rp=new Float32Array(2),Yv=new Ie(1,1,0,0),AO=new Me;function a$(h,e){return Math.exp(-(h*h)/(2*e*e))}function n$(h){const e=(h-1)/6,t=(h-1)*.5,s=new Array(h);let i=0;for(let a=0;a<h;++a)s[a]=a$(a-t,e),i+=s[a];for(let a=0;a<h;++a)s[a]/=i;return s}class zU{constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;const s=this.device.scope;this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[dt.blurVSMPS,`#define GAUSS
${dt.blurVSMPS}`],this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new ms,this.blendStateNoWrite=new ms,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(e,t,s){const i=w0.create("ShadowCamera",t,s),a=xh.get(e),n=(a==null?void 0:a.vsm)??!1,r=(a==null?void 0:a.pcf)??!1;return n?i.clearColor=new xe(0,0,0,0):i.clearColor=new xe(1,1,1,1),i.clearDepthBuffer=!0,i.clearStencilBuffer=!1,i.clearColorBuffer=!r,i}_cullShadowCastersInternal(e,t,s){const i=e.length;for(let a=0;a<i;a++){const n=e[a];n.castShadow&&(!n.cull||n._isVisible(s))&&(n.visibleThisFrame=!0,t.push(n))}}cullShadowCasters(e,t,s,i,a){if(s.length=0,a)this._cullShadowCastersInternal(a,s,i);else{const n=e.layerList,r=n.length;for(let l=0;l<r;l++){const u=n[l];u._lightsSet.has(t)&&(bR.has(u)||(bR.add(u),this._cullShadowCastersInternal(u.shadowCasters,s,i)))}bR.clear()}s.sort(this.sortCompareShader)}sortCompareShader(e,t){const s=e._sortKeyShadow,i=t._sortKeyShadow;return s===i?t.mesh.id-e.mesh.id:i-s}setupRenderState(e,t){const i=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&t._type!==Ds;e.setBlendState(i?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null)}dispatchUniforms(e,t,s,i){const a=t._node;e._type!==ft&&(this.renderer.dispatchViewPos(a.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),TO.setTRS(a.getPosition(),a.getRotation(),H.ONE).invert(),EO.mul2(t.projectionMatrix,TO);const n=s.shadowViewport;t.rect=n,t.scissorRect=s.shadowScissor,AO.setViewport(n.x,n.y,n.z,n.w),s.shadowMatrix.mul2(AO,EO),e._type===ft&&e._shadowMatrixPalette.set(s.shadowMatrix.data,i*16)}getShadowPass(e){var a;const t=e._type,s=e._shadowType;let i=(a=this.shadowPassCache[t])==null?void 0:a[s];if(!i){const n=`ShadowPass_${t}_${s}`;i=cl.get(this.device).allocate(n,{isShadow:!0,lightType:t,shadowType:s}),this.shadowPassCache[t]||(this.shadowPassCache[t]=[]),this.shadowPassCache[t][s]=i}return i.index}submitCasters(e,t,s){const i=this.device,a=this.renderer,n=a.scene,r=1<<CP,l=this.getShadowPass(t),u=s.shaderParams,f=s.renderTarget.flipY?-1:1,_=e.length;for(let g=0;g<_;g++){const y=e[g],v=y.mesh;y.ensureMaterial(i);const x=y.material;a.setBaseConstants(i,x),a.setSkinning(i,y),x.dirty&&(x.updateUniforms(i,n),x.dirty=!1),a.setupCullMode(!0,f,y),x.setParameters(i),y.setParameters(i,r);const C=y.getShaderInstance(l,0,n,u,this.viewUniformFormat,this.viewBindGroupFormat),M=C.shader;if(M.failed)continue;y._sortKeyShadow=M.id,i.setShader(M),a.setVertexBuffers(i,v),a.setMorphing(i,y.morphInstance),this.renderer.setupMeshUniformBuffers(C,y);const w=y.renderStyle;i.setIndexBuffer(v.indexBuffer[w]),a.drawInstance(i,y,v,w),a._shadowDrawCalls++}}needsShadowRendering(e){const t=e.enabled&&e.castShadows&&e.shadowUpdateMode!==no&&e.visibleThisFrame;return e.shadowUpdateMode===qd&&(e.shadowUpdateMode=no),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,s){return e.getRenderData(e._type===ft?t:null,s)}setupRenderPass(e,t,s){const i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=s,i.depthBuffer?e.depthStencilOps.storeDepth=!0:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=s,e.depthStencilOps.storeDepth=!1),e.requiresCubemaps=!1}prepareFace(e,t,s){const i=e._type,n=this.getLightRenderData(e,t,s).shadowCamera,r=i===ft?0:s;return n.renderTarget=e._shadowMap.renderTargets[r],n}renderFace(e,t,s,i,a=!0){const n=this.device,r=this.getLightRenderData(e,t,s),l=r.shadowCamera;this.dispatchUniforms(e,l,r,s);const u=l.renderTarget,f=this.renderer;f.setCameraUniforms(l,u),n.supportsUniformBuffers&&f.setupViewUniformBuffers(r.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),a?(f.setupViewport(l,u),i&&f.clear(l)):f.clearView(l,u,!0,!1),this.setupRenderState(n,e),this.submitCasters(r.visibleCasters,e,l)}render(e,t,s=!0){if(this.needsShadowRendering(e)){const i=e.numShadowFaces;for(let a=0;a<i;a++)this.prepareFace(e,t,a),this.renderFace(e,t,a,!0,s);this.renderVsm(e,t)}}renderVsm(e,t){e._isVsm&&e._vsmBlurSize>1&&(!this.renderer.scene.clusteredLightingEnabled||e._type===ft)&&this.applyVsmBlur(e,t)}getVsmBlurShader(e,t){const s=this.blurVsmShader;let i=s[e][t];if(!i){this.blurVsmWeights[t]=n$(t);const a=dt.fullscreenQuadVS;let n=`#define SAMPLES ${t}
`;n+=this.blurVsmShaderCode[e];const r=`blurVsm${e}${t}`;i=Da(this.device,a,n,r),s[e][t]=i}return i}applyVsmBlur(e,t){const s=this.device;s.setBlendState(ms.NOBLEND);const n=e.getRenderData(e._type===ft?t:null,0).shadowCamera.renderTarget,r=this.renderer.shadowMapCache.get(s,e),l=r.renderTargets[0],u=e.vsmBlurMode,f=e._vsmBlurSize,_=this.getVsmBlurShader(u,f);Yv.z=e._shadowResolution-2,Yv.w=Yv.z,this.sourceId.setValue(n.colorBuffer),rp[0]=1/e._shadowResolution,rp[1]=0,this.pixelOffsetId.setValue(rp),u===MC&&this.weightId.setValue(this.blurVsmWeights[f]),qn(s,l,_,null,Yv),this.sourceId.setValue(l.colorBuffer),rp[1]=rp[0],rp[0]=0,this.pixelOffsetId.setValue(rp),qn(s,n,_,null,Yv),this.renderer.shadowMapCache.add(e,r)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new ey(this.device,[new ri("matrix_viewProjection",im)]),this.viewBindGroupFormat=new Nm(this.device,[new nx(ax,Vd|Gd)]))}frameUpdate(){this.initViewBindGroupFormat()}}const yE=[];class r${constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e}destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(e=>{e.destroy()}),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){const e=new BA(this.device);e.name="ClusterEmpty",e.update([]),this._empty=e}return this._empty}assign(e){const t=this.empty;yE.push(...this._allocated),this._allocated.length=0,this._clusters.clear();const s=e.length;for(let i=0;i<s;i++){const n=e[i].renderActions;if(n){const r=n.length;for(let l=0;l<r;l++){const u=n[l];u.lightClusters=null;const f=u.layer;if(f.hasClusteredLights&&f.meshInstances.length){const _=f.getLightIdHash(),g=this._clusters.get(_);let y=g==null?void 0:g.lightClusters;y||(y=yE.pop()??new BA(this.device),this._allocated.push(y),this._clusters.set(_,u)),u.lightClusters=y}u.lightClusters||(u.lightClusters=t)}}}yE.forEach(i=>i.destroy()),yE.length=0}update(e,t){this.assign(e),this._clusters.forEach(s=>{const i=s.layer;s.lightClusters.update(i.clusteredLightsSet,t)})}}const $u=new Ie,xR=[];class MP extends pa{constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._cubeSlotsOffsets=t,this.requiresCubemaps=!1,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj")}destroy(){var e,t;(e=this._quadRenderer2D)==null||e.destroy(),this._quadRenderer2D=null,(t=this._quadRendererCube)==null||t.destroy(),this._quadRendererCube=null}static create(e,t){const s=new MP(e.device,t);return s.init(e),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}update(e){const t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0}filter(e,t){for(let s=0;s<e.length;s++){const i=e[s];i._type!==ft&&i.atlasViewportAllocated&&i.atlasSlotUpdated&&i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i)}}initInvViewProjMatrices(){if(!xR.length)for(let e=0;e<6;e++){const t=w0.create(null,Ds,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();xR[e]=new Me().mul2(s,i).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){const e=this.device.isWebGPU,t=e?ul:dt,s=Da(this.device,t.cookieBlitVS,t.cookieBlit2DPS,"cookieRenderer2d",{vertex_position:kt},{shaderLanguage:e?Ja:Sr});this._quadRenderer2D=new C0(s)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){const e=this.device.isWebGPU,t=e?ul:dt,s=Da(this.device,t.cookieBlitVS,t.cookieBlitCubePS,"cookieRendererCube",{vertex_position:kt},{shaderLanguage:e?Ja:Sr});this._quadRendererCube=new C0(s)}return this._quadRendererCube}execute(){const e=this.device;e.setBlendState(ms.NOBLEND),e.setCullMode(Xs),e.setDepthState($i.NODEPTH),e.setStencilState();const t=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights;for(let a=0;a<i.length;a++){const n=i[a],r=n.numShadowFaces,l=r>1?this.quadRendererCube:this.quadRenderer2D;r>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(n.cookie);for(let u=0;u<r;u++){if($u.copy(n.atlasViewport),r>1){const f=$u.z/3,_=s[u];$u.x+=f*_.x,$u.y+=f*_.y,$u.z=f,$u.w=f,this.invViewProjId.setValue(xR[u].data)}$u.mulScalar(t),l.render($u)}}i.length=0}}class o$ extends pa{constructor(e,t,s){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.shadowRendererLocal=s}update(e){const t=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){const e=this.shadowRendererLocal.shadowLights,t=e.length;for(let s=0;s<t;s++){const i=e[s];for(let a=0;a<i.numShadowFaces;a++)this.shadowRenderer.renderFace(i,null,a,!0)}e.length=0}}class l$ extends pa{constructor(e,t,s,i,a){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=MP.create(a.cookieRenderTarget,a.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new o$(e,s,i),this.beforePasses.push(this.shadowRenderPass)}update(e,t,s,i,a){this.frameGraph=e,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(a)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){const{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.lighting)}}let TR=0;const Zu=new Me,Ju=new Me,lg=new Me,CO=new ol,ER=new T1,wO=new Me().setScale(1,-1,1),AR=new Set,CR=new Set,wR=new eP,RO=new Me().set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),MO=[new Ee(.5,.333333),new Ee(.25,.666667),new Ee(.75,.111111),new Ee(.125,.444444),new Ee(.625,.777778),new Ee(.375,.222222),new Ee(.875,.555556),new Ee(.0625,.888889),new Ee(.5625,.037037),new Ee(.3125,.37037),new Ee(.8125,.703704),new Ee(.1875,.148148),new Ee(.6875,.481481),new Ee(.4375,.814815),new Ee(.9375,.259259),new Ee(.03125,.592593)],h$=new Me,c$=new Me,u$=new Me,d$=new Me,f$=new Me,p$=new Me,hg=new Set,RR=[],MR=[];class m${constructor(e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new UU(123),this.device=e,this.scene=null,this.worldClustersAllocator=new r$(e),this.lightTextureAtlas=new QQ(e),this.shadowMapCache=new ZQ,this.shadowRenderer=new zU(this,this.lightTextureAtlas),this._shadowRendererLocal=new e$(this,this.shadowRenderer),this._shadowRendererDirectional=new i$(this,this.shadowRenderer),this._renderPassUpdateClustered=new l$(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;const t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new Ie,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new WQ,this.constantLightCube=t.resolve("lightCube[0]")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}setupViewport(e,t){const s=this.device,i=t?t.width:s.width,a=t?t.height:s.height,n=e.rect;let r=Math.floor(n.x*i),l=Math.floor(n.y*a),u=Math.floor(n.z*i),f=Math.floor(n.w*a);if(s.setViewport(r,l,u,f),e._scissorRectClear){const _=e.scissorRect;r=Math.floor(_.x*i),l=Math.floor(_.y*a),u=Math.floor(_.z*i),f=Math.floor(_.w*a)}s.setScissor(r,l,u,f)}setCameraUniforms(e,t){var r,l;const s=t==null?void 0:t.flipY;let i=1;if(e.xr&&e.xr.session){const u=((l=(r=e._node)==null?void 0:r.parent)==null?void 0:l.getWorldTransform())||null,f=e.xr.views;i=f.list.length;for(let _=0;_<i;_++){const g=f.list[_];g.updateTransforms(u),e.frustum.setFromMat4(g.projViewOffMat)}}else{let u=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(u,nb);let f=e.getProjectionMatrixSkybox();s&&(u=h$.mul2(wO,u),f=c$.mul2(wO,f)),this.device.isWebGPU&&(u=u$.mul2(RO,u),f=d$.mul2(RO,f));const{jitter:_}=e;let g=0,y=0;if(_>0){const x=t?t.width:this.device.width,C=t?t.height:this.device.height,M=MO[this.device.renderVersion%MO.length];g=_*(M.x*2-1)/x,y=_*(M.y*2-1)/C,u=f$.copy(u),u.data[8]=g,u.data[9]=y,f=p$.copy(f),f.data[8]=g,f.data[9]=y,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec))}const v=_>0?this.blueNoiseJitterVec:Ie.ZERO;if(this.blueNoiseJitterData[0]=v.x,this.blueNoiseJitterData[1]=v.y,this.blueNoiseJitterData[2]=v.z,this.blueNoiseJitterData[3]=v.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(u.data),this.projSkyboxId.setValue(f.data),e.calculateTransform)e.calculateTransform(Ju,nb);else{const x=e._node.getPosition(),C=e._node.getRotation();Ju.setTRS(x,C,H.ONE)}this.viewInvId.setValue(Ju.data),lg.copy(Ju).invert(),this.viewId.setValue(lg.data),CO.setFromMat4(lg),this.viewId3.setValue(CO.data),Zu.mul2(u,lg),this.viewProjId.setValue(Zu.data),e._storeShaderMatrices(Zu,g,y,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(Zu)}this.tbnBasis.setValue(s?-1:1);const a=e._nearClip,n=e._farClip;return this.nearClipId.setValue(a),this.farClipId.setValue(n),this.cameraParams[0]=1/n,this.cameraParams[1]=n,this.cameraParams[2]=a,this.cameraParams[3]=e.projection===nl?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i}clear(e,t,s,i){const a=(t??e._clearColorBuffer?Jp:0)|(s??e._clearDepthBuffer?em:0)|(i??e._clearStencilBuffer?_0:0);a&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:a})}setCamera(e,t,s,i=null){this.setCameraUniforms(e,t),this.clearView(e,t,s,!1)}clearView(e,t,s,i){const a=this.device;if(a.setRenderTarget(t),a.updateBegin(),i&&(a.setColorWrite(!0,!0,!0,!0),a.setDepthWrite(!0)),this.setupViewport(e,t),s){const n=e._clearOptions;a.clear(n||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?Jp:0)|(e._clearDepthBuffer?em:0)|(e._clearStencilBuffer?_0:0),stencil:e._clearStencil})}}setupCullMode(e,t,s){const i=s.material;let a=Xs;if(e){let n=1;(i.cull===e0||i.cull===jc)&&(n=t*s.flipFacesFactor*s.node.worldScaleSign),n<0?a=i.cull===e0?jc:e0:a=i.cull}this.device.setCullMode(a),a===Xs&&i.cull===Xs&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){const s=e.xr.views.list[0];Zu.mul2(s.projMat,s.viewOffMat),e.frustum.setFromMat4(Zu);return}const t=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(t,nb),e.calculateTransform)e.calculateTransform(Ju,nb);else{const s=e._node.getPosition(),i=e._node.getRotation();Ju.setTRS(s,i,H.ONE),this.viewInvId.setValue(Ju.data)}lg.copy(Ju).invert(),Zu.mul2(t,lg),e.frustum.setFromMat4(Zu)}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)}updateCpuSkinMatrices(e){TR++;const t=e.length;if(t!==0)for(let s=0;s<t;s++){const i=e[s].skinInstance;i&&(i.updateMatrices(e[s].node,TR),i._dirty=!0)}}updateGpuSkinMatrices(e){for(const t of e){const s=t.skinInstance;s&&s._dirty&&(s.updateMatrixPalette(t.node,TR),s._dirty=!1)}}updateMorphing(e){for(const t of e){const s=t.morphInstance;s&&s._dirty&&s.update()}}updateGSplats(e){var t;for(const s of e)(t=s.gsplatInstance)==null||t.update()}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e)}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){t&&(t.prepareRendering(e),e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams))}setSkinning(e,t){const s=t.skinInstance;if(s){this._skinDrawCalls++;const i=s.boneTexture;this.boneTextureId.setValue(i)}}dispatchViewPos(e){const t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){const t=[new ri("matrix_viewProjection",im),new ri("cubeMapRotationMatrix",A0),new ri("view_position",Fn),new ri("skyboxIntensity",Vn),new ri("exposure",Vn),new ri("textureBias",Vn)];e&&t.push(new ri("clusterCellsCountByBoundsSize",Fn),new ri("clusterTextureSize",Fn),new ri("clusterBoundsMin",Fn),new ri("clusterBoundsDelta",Fn),new ri("clusterCellsDot",Fn),new ri("clusterCellsMax",Fn),new ri("shadowAtlasParams",zd),new ri("clusterMaxCells",Ud),new ri("clusterSkip",Vn)),this.viewUniformFormat=new ey(this.device,t);const s=[new nx(ax,Vd|Gd)];this.viewBindGroupFormat=new Nm(this.device,s)}}setupViewUniformBuffers(e,t,s,i){const a=this.device;for(;e.length<i;){const r=new ox(a,t,!1),l=new $0(a,s,r);e.push(l)}const n=e[0];n.defaultUniformBuffer.update(),n.update(),a.setBindGroup(Qb,n)}setupMeshUniformBuffers(e,t){const s=this.device;if(s.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);const i=e.getBindGroup(s);i.update(),s.setBindGroup(Q0,i),e.getUniformBuffer(s).update(wR),s.setBindGroup(um,wR.bindGroup,wR.offsets)}}drawInstance(e,t,s,i,a){const n=t.node.worldTransform;this.modelMatrixId.setValue(n.data),a&&this.normalMatrixId.setValue(t.node.normalMatrix.data);const r=t.instancingData;r?r.count>0?(this._instancedDrawCalls++,e.setVertexBuffer(r.vertexBuffer),e.draw(s.primitive[i],r.count)):(e.clearVertexBuffer(),e.clearIndexBuffer()):e.draw(s.primitive[i])}drawInstance2(e,t,s,i){const a=t.instancingData;a?a.count>0?(this._instancedDrawCalls++,e.draw(s.primitive[i],a.count,!0)):(e.clearVertexBuffer(),e.clearIndexBuffer()):e.draw(s.primitive[i],void 0,!0)}cull(e,t,s){const i=s.opaque;i.length=0;const a=s.transparent;a.length=0;const n=e.frustumCulling,r=t.length;for(let l=0;l<r;l++){const u=t[l];u.visible&&(!n||!u.cull||u._isVisible(e))&&(u.visibleThisFrame=!0,(u.transparent?a:i).push(u),(u.skinInstance||u.morphInstance||u.gsplatInstance)&&(this.processingMeshInstances.add(u),u.gsplatInstance&&u.gsplatInstance.cameras.push(e)))}}collectLights(e){this.lights.length=0,this.localLights.length=0;const t=this.scene._stats,s=e.layerList.length;for(let i=0;i<s;i++){const a=e.layerList[i];if(!CR.has(a)){CR.add(a);const n=a._lights;for(let r=0;r<n.length;r++){const l=n[r];AR.has(l)||(AR.add(l),this.lights.push(l),l._type!==ft&&this.localLights.push(l))}}}t.lights=this.lights.length,AR.clear(),CR.clear()}cullLights(e,t){const s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let a=0;a<t.length;a++){const n=t[a];if(n.enabled)if(n._type!==ft)if(n.getBoundingSphere(ER),e.frustum.containsSphere(ER)){n.visibleThisFrame=!0,n.usePhysicalUnits=i;const r=e.getScreenSize(ER);n.maxScreenSize=Math.max(n.maxScreenSize,r)}else s||n.castShadows&&!n.shadowMap&&(n.visibleThisFrame=!0);else n.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(e){const t=this.scene.clusteredLightingEnabled;for(let i=0;i<this.localLights.length;i++){const a=this.localLights[i];a._type!==ft&&(t?a.atlasSlotUpdated&&a.shadowUpdateMode===no&&(a.shadowUpdateMode=qd):a.shadowUpdateMode===no&&a.castShadows&&(a.getRenderData(null,0).shadowCamera.renderTarget||(a.shadowUpdateMode=qd)),a.visibleThisFrame&&a.castShadows&&a.shadowUpdateMode!==no&&this._shadowRendererLocal.cull(a,e))}this.cameraDirShadowLights.clear();const s=e.cameras;for(let i=0;i<s.length;i++){const a=s[i];if(a.enabled){const n=a.camera;let r;const l=n.layers;for(let u=0;u<l.length;u++){const f=e.getLayerById(l[u]);if(f){const _=f.splitLights[ft];for(let g=0;g<_.length;g++){const y=_[g];y.castShadows&&!hg.has(y)&&(hg.add(y),r=r??[],r.push(y),this._shadowRendererDirectional.cull(y,e,n))}}}r&&this.cameraDirShadowLights.set(n,r),hg.clear()}}}cullComposition(e){const{scene:t}=this;this.processingMeshInstances.clear();const s=e.cameras.length;this._camerasRendered+=s;for(let i=0;i<s;i++){const a=e.cameras[i];t==null||t.fire(PU,a);const n=a.renderTarget;a.frameUpdate(n),this.updateCameraFrustum(a.camera);const r=a.layers;for(let l=0;l<r.length;l++){const u=e.getLayerById(r[l]);if(u&&u.enabled){this.cullLights(a.camera,u._lights);const f=u.getCulledInstances(a.camera);this.cull(a.camera,u.meshInstances,f)}}t==null||t.fire(LU,a)}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e)}updateShaders(e,t){const s=e.length;for(let i=0;i<s;i++){const a=e[i].material;if(a&&!hg.has(a)&&(hg.add(a),a.getShaderVariant!==Jc.prototype.getShaderVariant)){if(t&&(!a.useLighting||a.emitter&&!a.emitter.lighting))continue;a.clearVariants()}}hg.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(jQ(this.device))}beginFrame(e){const t=this.scene,s=t.updateShaders||this.device._shadersDirty,i=e.layerList,a=i.length;for(let l=0;l<a;l++){const f=i[l].meshInstances,_=f.length;for(let g=0;g<_;g++){const y=f[g];y.visibleThisFrame=!1,s&&RR.push(y),y.skinInstance&&MR.push(y)}}if(s){const l=!t.updateShaders||!this.device._shadersDirty;this.updateShaders(RR,l),t.updateShaders=!1,this.device._shadersDirty=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(MR),RR.length=0,MR.length=0;const n=this.lights,r=n.length;for(let l=0;l<r;l++)n[l].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(e){const t=e.layerList.length,i=this.scene._shaderVersion;for(let a=0;a<t;a++){const n=e.layerList[a];n._shaderVersion=i}e._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}}class kU{constructor(){this.camera=null,this.layer=null,this.transparent=!1,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}setupClears(e,t){this.clearColor=(e==null?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(e==null?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(e==null?void 0:e.clearStencilBuffer)||t.clearStencilBuffer}}class mb extends pa{constructor(e,t,s,i){super(e),this.renderActions=[],this.noDepthClear=!1,this.layerComposition=t,this.scene=s,this.renderer=i}get rendersAnything(){return this.renderActions.length>0}addRenderAction(e){this.renderActions.push(e)}addLayer(e,t,s,i=!0){const a=new kU;if(a.renderTarget=this.renderTarget,a.camera=e,a.layer=t,a.transparent=s,i){const n=this.renderActions.length===0;a.setupClears(n?e:void 0,t)}this.addRenderAction(a)}addLayers(e,t,s,i,a,n=!0){const{layerList:r,subLayerList:l}=e;let u=i,f=s;for(;f<r.length;){const _=r[f],g=l[f];if(t.camera.layersSet.has(_.id)&&(this.addLayer(t,_,g,u),u=!1),f++,_.id===a&&g===n)break}return f}updateDirectionalShadows(){const{renderer:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const n=t[s].camera.camera,r=this.renderer.cameraDirShadowLights.get(n);if(r)for(let l=0;l<r.length;l++){const u=r[l];if(e.dirLightShadows.get(u)!==n){e.dirLightShadows.set(u,n);const f=e._shadowRendererDirectional.getLightRenderPass(u,n);f&&this.beforePasses.push(f)}}}}updateClears(){const e=this.renderActions[0];if(e){const s=e.camera.camera,i=s.fullSizeClearRect;this.setClearColor(i&&e.clearColor?s.clearColor:void 0),this.setClearDepth(i&&e.clearDepth&&!this.noDepthClear?s.clearDepth:void 0),this.setClearStencil(i&&e.clearStencil?s.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){const{renderActions:e}=this;for(let t=0;t<e.length;t++){const s=e[t];s.firstCameraUse&&this.scene.fire(wU,s.camera)}}execute(){const{layerComposition:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const i=t[s],a=i.layer;e.isEnabled(a,i.transparent)&&this.renderRenderAction(i,s===0)}}after(){for(let e=0;e<this.renderActions.length;e++){const t=this.renderActions[e];t.lastCameraUse&&this.scene.fire(RU,t.camera)}this.beforePasses.length=0}renderRenderAction(e,t){var u;const{renderer:s,scene:i}=this,a=s.device,{layer:n,transparent:r,camera:l}=e;if(l){const f=l.gammaCorrection,_=l.toneMapping;this.gammaCorrection!==void 0&&(l.gammaCorrection=this.gammaCorrection),this.toneMapping!==void 0&&(l.toneMapping=this.toneMapping),i.fire(MU,l,n,r);const g={lightClusters:e.lightClusters},y=((u=l.camera.shaderPassInfo)==null?void 0:u.index)??tf;(!t||!l.camera.fullSizeClearRect)&&(g.clearColor=e.clearColor,g.clearDepth=e.clearDepth,g.clearStencil=e.clearStencil);const v=e.renderTarget??a.backBuffer;s.renderForwardLayer(l.camera,v,n,r,y,e.viewBindGroups,g),a.setBlendState(ms.NOBLEND),a.setStencilState(null,null),a.setAlphaToCoverage(!1),i.fire(DU,l,n,r),this.gammaCorrection!==void 0&&(l.gammaCorrection=f),this.toneMapping!==void 0&&(l.toneMapping=_)}}}class _$ extends pa{constructor(e,t,s){super(e),this.renderer=t,this.renderAction=s,this.requiresCubemaps=!1}execute(){this.renderAction.camera.onPostprocessing()}}const g$=[[],[],[]],ed=new xe,op={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};function y$(h){const e=[];for(let t=0;t<h;++t){const s=Math.sqrt(t+.5)/Math.sqrt(h);e.push(s)}return e}function v$(h){const e=[];for(let t=0;t<h;t++){const s=t/h,i=Math.sqrt(s*s);e.push(i)}return e}class DP extends m${constructor(e){super(e);const t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;const s=t.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.lightSoftShadowParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.shadowCascadeBlendId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=y$(16),this.pcssSphereSamples=v$(16)}destroy(){super.destroy()}dispatchGlobalLights(e){const t=this.ambientColor;if(ed.linear(e.ambientLight),t[0]=ed.r,t[1]=ed.g,t[2]=ed.b,e.physicalUnits)for(let s=0;s<3;s++)t[s]*=e.ambientLuminance;this.ambientId.setValue(t),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data)}_resolveLight(e,t){const s=`light${t}`;this.lightColorId[t]=e.resolve(`${s}_color`),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(`${s}_direction`),this.lightShadowMapId[t]=e.resolve(`${s}_shadowMap`),this.lightShadowMatrixId[t]=e.resolve(`${s}_shadowMatrix`),this.lightShadowParamsId[t]=e.resolve(`${s}_shadowParams`),this.lightShadowIntensity[t]=e.resolve(`${s}_shadowIntensity`),this.lightShadowSearchAreaId[t]=e.resolve(`${s}_shadowSearchArea`),this.lightRadiusId[t]=e.resolve(`${s}_radius`),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(`${s}_position`),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(`${s}_halfWidth`),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(`${s}_halfHeight`),this.lightInAngleId[t]=e.resolve(`${s}_innerConeAngle`),this.lightOutAngleId[t]=e.resolve(`${s}_outerConeAngle`),this.lightCookieId[t]=e.resolve(`${s}_cookie`),this.lightCookieIntId[t]=e.resolve(`${s}_cookieIntensity`),this.lightCookieMatrixId[t]=e.resolve(`${s}_cookieMatrix`),this.lightCookieOffsetId[t]=e.resolve(`${s}_cookieOffset`),this.lightCameraParamsId[t]=e.resolve(`${s}_cameraParams`),this.lightSoftShadowParamsId[t]=e.resolve(`${s}_softShadowParams`),this.shadowMatrixPaletteId[t]=e.resolve(`${s}_shadowMatrixPalette[0]`),this.shadowCascadeDistancesId[t]=e.resolve(`${s}_shadowCascadeDistances`),this.shadowCascadeCountId[t]=e.resolve(`${s}_shadowCascadeCount`),this.shadowCascadeBlendId[t]=e.resolve(`${s}_shadowCascadeBlend`)}setLTCDirectionalLight(e,t,s,i,a){this.lightPos[t][0]=i.x-s.x*a,this.lightPos[t][1]=i.y-s.y*a,this.lightPos[t][2]=i.z-s.z*a,this.lightPosId[t].setValue(this.lightPos[t]);const n=e.transformVector(new H(-.5,0,0));this.lightWidth[t][0]=n.x*a,this.lightWidth[t][1]=n.y*a,this.lightWidth[t][2]=n.z*a,this.lightWidthId[t].setValue(this.lightWidth[t]);const r=e.transformVector(new H(0,0,.5));this.lightHeight[t][0]=r.x*a,this.lightHeight[t][1]=r.y*a,this.lightHeight[t][2]=r.z*a,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,s){let i=0;const a=this.device.scope;for(let n=0;n<e.length;n++){if(!(e[n].mask&t))continue;const r=e[n],l=r._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(a,i),this.lightColorId[i].setValue(r._colorLinear),l.getY(r._direction).mulScalar(-1),r._direction.normalize(),this.lightDir[i][0]=r._direction.x,this.lightDir[i][1]=r._direction.y,this.lightDir[i][2]=r._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),r.shape!==ao&&this.setLTCDirectionalLight(l,i,r._direction,s._node.getPosition(),s.farClip),r.castShadows){const u=r.getRenderData(s,0),f=r._getUniformBiasValues(u);this.lightShadowMapId[i].setValue(u.shadowBuffer),this.lightShadowMatrixId[i].setValue(u.shadowMatrix.data),this.shadowMatrixPaletteId[i].setValue(r._shadowMatrixPalette),this.shadowCascadeDistancesId[i].setValue(r._shadowCascadeDistances),this.shadowCascadeCountId[i].setValue(r.numCascades),this.shadowCascadeBlendId[i].setValue(1-r.cascadeBlend),this.lightShadowIntensity[i].setValue(r.shadowIntensity),this.lightSoftShadowParamsId[i].setValue(r._softShadowParams),u.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[i].setValue(r.penumbraSize/u.shadowCamera.renderTarget.width*u.projectionCompensation);const g=r._shadowCameraParams;g.length=4,g[0]=0,g[1]=u.shadowCamera._farClip,g[2]=u.shadowCamera._nearClip,g[3]=1,this.lightCameraParamsId[i].setValue(g);const y=r._shadowRenderParams;y.length=4,y[0]=r._shadowResolution,y[1]=f.normalBias,y[2]=f.bias,y[3]=0,this.lightShadowParamsId[i].setValue(y)}i++}return i}setLTCPositionalLight(e,t){const s=e.transformVector(new H(-.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);const i=e.transformVector(new H(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,s){const i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),t.shape!==ao&&this.setLTCPositionalLight(i,s),t.castShadows){const a=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(a.shadowBuffer);const n=t._getUniformBiasValues(a),r=t._shadowRenderParams;r.length=4,r[0]=t._shadowResolution,r[1]=n.normalBias,r[2]=n.bias,r[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(r),this.lightShadowIntensity[s].setValue(t.shadowIntensity);const l=t.penumbraSize/a.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[s].setValue(l);const u=t._shadowCameraParams;u.length=4,u[0]=0,u[1]=a.shadowCamera._farClip,u[2]=a.shadowCamera._nearClip,u[3]=0,this.lightCameraParamsId[s].setValue(u)}t._cookie&&(this.lightCookieId[s].setValue(t._cookie),this.lightShadowMatrixId[s].setValue(i.data),this.lightCookieIntId[s].setValue(t.cookieIntensity))}dispatchSpotLight(e,t,s){const i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightInAngleId[s].setValue(t._innerConeAngleCos),this.lightOutAngleId[s].setValue(t._outerConeAngleCos),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),t.shape!==ao&&this.setLTCPositionalLight(i,s),i.getY(t._direction).mulScalar(-1),t._direction.normalize(),this.lightDir[s][0]=t._direction.x,this.lightDir[s][1]=t._direction.y,this.lightDir[s][2]=t._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),t.castShadows){const a=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(a.shadowBuffer),this.lightShadowMatrixId[s].setValue(a.shadowMatrix.data);const n=t._getUniformBiasValues(a),r=t._shadowRenderParams;r.length=4,r[0]=t._shadowResolution,r[1]=n.normalBias,r[2]=n.bias,r[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(r),this.lightShadowIntensity[s].setValue(t.shadowIntensity);const l=t.penumbraSize/a.shadowCamera.renderTarget.width,u=a.shadowCamera._fov*Math.PI/180,f=1/Math.tan(u/2);this.lightShadowSearchAreaId[s].setValue(l*f);const _=t._shadowCameraParams;_.length=4,_[0]=0,_[1]=a.shadowCamera._farClip,_[2]=a.shadowCamera._nearClip,_[3]=0,this.lightCameraParamsId[s].setValue(_)}if(t._cookie){if(!t.castShadows){const a=w0.evalSpotCookieMatrix(t);this.lightShadowMatrixId[s].setValue(a.data)}this.lightCookieId[s].setValue(t._cookie),this.lightCookieIntId[s].setValue(t.cookieIntensity),t._cookieTransform&&(t._cookieTransformUniform[0]=t._cookieTransform.x,t._cookieTransformUniform[1]=t._cookieTransform.y,t._cookieTransformUniform[2]=t._cookieTransform.z,t._cookieTransformUniform[3]=t._cookieTransform.w,this.lightCookieMatrixId[s].setValue(t._cookieTransformUniform),t._cookieOffsetUniform[0]=t._cookieOffset.x,t._cookieOffsetUniform[1]=t._cookieOffset.y,this.lightCookieOffsetId[s].setValue(t._cookieOffsetUniform))}}dispatchLocalLights(e,t,s){let i=s;const a=this.device.scope,n=e[Ds],r=n.length;for(let f=0;f<r;f++){const _=n[f];_.mask&t&&(this.dispatchOmniLight(a,_,i),i++)}const l=e[Ns],u=l.length;for(let f=0;f<u;f++){const _=l[f];_.mask&t&&(this.dispatchSpotLight(a,_,i),i++)}}renderForwardPrepareMaterials(e,t,s,i,a,n){const r=e.fogParams??this.scene.fog,l=e.shaderParams;l.fog=r.type,l.srgbRenderTarget=(t==null?void 0:t.isColorBufferSrgb(0))??!1;const u=(w,T,R,D)=>{op.drawCalls.push(w),op.shaderInstances.push(T),op.isNewMaterial.push(R),op.lightMaskChanged.push(D)};op.clear();const f=this.device,_=this.scene,g=_.clusteredLightingEnabled,y=(a==null?void 0:a.getLightHash(g))??0;let v=null,x,C;const M=s.length;for(let w=0;w<M;w++){const T=s[w];T.ensureMaterial(f);const R=T.material,D=T._shaderDefs,I=T.mask;R&&R===v&&D!==x&&(v=null),R!==v&&(this._materialSwitches++,R._scene=_,R.dirty&&(R.updateUniforms(f,_),R.dirty=!1));const U=T.getShaderInstance(n,y,_,l,this.viewUniformFormat,this.viewBindGroupFormat,i);u(T,U,R!==v,!v||I!==C),v=R,x=D,C=I}return op}renderForwardInternal(e,t,s,i,a,n){const r=this.device,l=this.scene,u=1<<i,f=n?-1:1,_=l.clusteredLightingEnabled,g=t.drawCalls.length;for(let y=0;y<g;y++){const v=t.drawCalls[y],x=t.isNewMaterial[y],C=t.lightMaskChanged[y],M=t.shaderInstances[y],w=v.material,T=v.mask;if(M.shader.failed)continue;if(x){if(r.setShader(M.shader,!1),w.setParameters(r),C){const N=this.dispatchDirectLights(s[ft],T,e);_||this.dispatchLocalLights(s,T,N)}this.alphaTestId.setValue(w.alphaTest),r.setBlendState(w.blendState),r.setDepthState(w.depthState),r.setAlphaToCoverage(w.alphaToCoverage)}this.setupCullMode(e._cullFaces,f,v);const R=v.stencilFront??w.stencilFront,D=v.stencilBack??w.stencilBack;r.setStencilState(R,D),v.setParameters(r,u),r.scope.resolve("meshInstanceId").setValue(v.id);const I=v.mesh;this.setVertexBuffers(r,I),this.setMorphing(r,v.morphInstance),this.setSkinning(r,v),this.setupMeshUniformBuffers(M,v);const U=v.renderStyle;if(r.setIndexBuffer(I.indexBuffer[U]),a==null||a(v,y),e.xr&&e.xr.session&&e.xr.views.list.length){const O=e.xr.views;for(let N=0;N<O.list.length;N++){const z=O.list[N];r.setViewport(z.viewport.x,z.viewport.y,z.viewport.z,z.viewport.w),this.projId.setValue(z.projMat.data),this.projSkyboxId.setValue(z.projMat.data),this.viewId.setValue(z.viewOffMat.data),this.viewInvId.setValue(z.viewInvOffMat.data),this.viewId3.setValue(z.viewMat3.data),this.viewProjId.setValue(z.projViewOffMat.data),this.viewPosId.setValue(z.positionData),this.viewIndexId.setValue(N),N===0?this.drawInstance(r,v,I,U,!0):this.drawInstance2(r,v,I,U),this._forwardDrawCalls++}}else this.drawInstance(r,v,I,U,!0),this._forwardDrawCalls++;y<g-1&&!t.isNewMaterial[y+1]&&w.setParameters(r,v.parameters)}}renderForward(e,t,s,i,a,n,r,l){const u=this.renderForwardPrepareMaterials(e,t,s,i,r,a);this.renderForwardInternal(e,u,i,a,n,l),op.clear()}renderForwardLayer(e,t,s,i,a,n,r={}){const{scene:l,device:u}=this,f=l.clusteredLightingEnabled;this.setupViewport(e,t);let _,g;if(s){s.sortVisible(e,i);const R=s.getCulledInstances(e);_=i?R.transparent:R.opaque,l.immediate.onPreRenderLayer(s,_,i),s.requiresLightCube&&(this.lightCube.update(l.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),g=s.splitLights}else _=r.meshInstances,g=r.splitLights??g$;f&&((r.lightClusters??this.worldClustersAllocator.empty).activate(),s&&!this.clustersDebugRendered&&l.lighting.debugLayer===s.id&&(this.clustersDebugRendered=!0)),l._activeCamera=e;const y=e.fogParams??this.scene.fog;this.setFogConstants(y);const v=this.setCameraUniforms(e,t);u.supportsUniformBuffers&&this.setupViewUniformBuffers(n,this.viewUniformFormat,this.viewBindGroupFormat,v);const x=r.clearColor??!1,C=r.clearDepth??!1,M=r.clearStencil??!1;(x||C||M)&&this.clear(e,x,C,M);const w=!!(e._flipFaces^(t==null?void 0:t.flipY)),T=this._forwardDrawCalls;this.renderForward(e,t,_,g,a,null,s,w),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-T)}setFogConstants(e){if(e.type!==Fm){ed.linear(e.color);const t=this.fogColor;t[0]=ed.r,t[1]=ed.g,t[2]=ed.b,this.fogColorId.setValue(t),e.type===JB?(this.fogStartId.setValue(e.start),this.fogEndId.setValue(e.end)):this.fogDensityId.setValue(e.density)}}setSceneConstants(){const e=this.scene;this.dispatchGlobalLights(e);const t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(e,t){const s=this.scene;if(e.reset(),s.clusteredLightingEnabled){const{shadowsEnabled:l,cookiesEnabled:u}=s.lighting;this._renderPassUpdateClustered.update(e,l,u,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);let i=0,a=!0,n=null;const r=t._renderActions;for(let l=i;l<r.length;l++){const u=r[l],{layer:f,camera:_}=u;if(u.useCameraPasses)_.camera.renderPasses.forEach(g=>{e.addRenderPass(g)});else{const g=f.id===yn,y=g&&(_.renderSceneColorMap||_.renderSceneDepthMap);a&&(a=!1,i=l,n=u.renderTarget);const v=r[l+1],C=(v?!v.useCameraPasses&&v.layer.id===yn:!1)&&(_.renderSceneColorMap||_.renderSceneDepthMap),M=v?v.firstCameraUse&&this.cameraDirShadowLights.has(v.camera.camera):!1;if(!v||v.renderTarget!==n||M||C||y){if(g&&i===l||this.addMainRenderPass(e,t,n,i,l),g){if(_.renderSceneColorMap){const T=_.camera.renderPassColorGrab;T.source=_.renderTarget,e.addRenderPass(T)}_.renderSceneDepthMap&&e.addRenderPass(_.camera.renderPassDepthGrab)}if(u.triggerPostprocess&&(_!=null&&_.onPostprocessing)){const T=new _$(this.device,this,u);e.addRenderPass(T)}a=!0}}}}addMainRenderPass(e,t,s,i,a){const n=new mb(this.device,t,this.scene,this);n.init(s);const r=t._renderActions;for(let l=i;l<=a;l++)n.addRenderAction(r[l]);e.addRenderPass(n)}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances)}}let DR=0;const Kv=[],vE=new Set;function S$(h,e){return h.drawOrder-e.drawOrder}function b$(h,e){const t=h._sortKeyForward,s=e._sortKeyForward;return t===s?e.mesh.id-h.mesh.id:s-t}function x$(h,e){return e._sortKeyDynamic-h._sortKeyDynamic}function T$(h,e){return h._sortKeyDynamic-e._sortKeyDynamic}const E$=[null,S$,b$,x$,T$];class A${constructor(){this.opaque=[],this.transparent=[]}}let Fi=class{constructor(e={}){this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,e.id!==void 0?(this.id=e.id,DR=Math.max(this.id+1,DR)):this.id=DR++,this.name=e.name,this._enabled=e.enabled??!0,this._refCounter=this._enabled?1:0,this.opaqueSortMode=e.opaqueSortMode??yU,this.transparentSortMode=e.transparentSortMode??s3,e.renderTarget&&(this.renderTarget=e.renderTarget),this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}set enabled(e){e!==this._enabled&&(this._dirtyComposition=!0,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){this._refCounter===0&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(this._refCounter===1)this._enabled=!1,this.onDisable&&this.onDisable();else if(this._refCounter===0)return;this._refCounter--}addMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let a=0;a<e.length;a++){const n=e[a];i.has(n)||(s.push(n),i.add(n),vE.add(n.material))}if(t||this.addShadowCasters(e),vE.size>0){const a=this._shaderVersion;vE.forEach(n=>{a>=0&&n._shaderVersion!==a&&(n.getShaderVariant!==Jc.prototype.getShaderVariant&&n.clearVariants(),n._shaderVersion=a)}),vE.clear()}}removeMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let a=0;a<e.length;a++){const n=e[a];if(i.has(n)){i.delete(n);const r=s.indexOf(n);r>=0&&s.splice(r,1)}}t||this.removeShadowCasters(e)}addShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const a=e[i];a.castShadow&&!s.has(a)&&(s.add(a),t.push(a))}}removeShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const a=e[i];if(s.has(a)){s.delete(a);const n=t.indexOf(a);n>=0&&t.splice(n,1)}}}clearMeshInstances(e=!1){this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}hasLight(e){return this._lightsSet.has(e)}addLight(e){const t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),t.type!==ft&&this._clusteredLightsSet.add(t)}removeLight(e){const t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),t.type!==ft&&this._clusteredLightsSet.delete(t)}clearLights(){this._lightsSet.forEach(e=>e.removeLayer(this)),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;const e=this._splitLights;for(let s=0;s<e.length;s++)e[s].length=0;const t=this._lights;for(let s=0;s<t.length;s++){const i=t[s];i.enabled&&e[i._type].push(i)}for(let s=0;s<e.length;s++)e[s].sort((i,a)=>i.key-a.key)}return this._splitLights}evaluateLightHash(e,t,s){let i=0;const a=this._lights;for(let n=0;n<a.length;n++){const r=a[n].type!==ft;(e&&r||t&&!r)&&Kv.push(s?a[n].id:a[n].key)}return Kv.length>0&&(Kv.sort(),i=tP(Kv),Kv.length=0),i}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!e,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=!0)}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);const t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(e,t,s){const i=e.length,{x:a,y:n,z:r}=t,{x:l,y:u,z:f}=s;for(let _=0;_<i;_++){const g=e[_];let y;if(g.calculateSortDistance)y=g.calculateSortDistance(g,t,s);else{const x=g.aabb.center;y=(x.x-a)*l+(x.y-n)*u+(x.z-r)*f}const v=g._drawBucket*1e9;g._sortKeyDynamic=v+y}}getCulledInstances(e){let t=this._visibleInstances.get(e);return t||(t=new A$,this._visibleInstances.set(e,t)),t}sortVisible(e,t){const s=t?this.transparentSortMode:this.opaqueSortMode;if(s===jp)return;const i=this.getCulledInstances(e),a=t?i.transparent:i.opaque,n=e.node;if(s===SU){const r=n.getPosition(),l=n.forward;this.customCalculateSortValues&&this.customCalculateSortValues(a,a.length,r,l),this.customSortCallback&&a.sort(this.customSortCallback)}else{if(s===s3||s===vU){const r=n.getPosition(),l=n.forward;this._calculateSortDistances(a,r,l)}a.sort(E$[s])}}};const C$=(h,e)=>h.priority-e.priority,n1=h=>h.sort(C$);class UA extends Qe{constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this._renderActions=[],this._dirty=!1,this.name=e,this._opaqueOrder={},this._transparentOrder={}}destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach(e=>e.destroy()),this._renderActions.length=0}markDirty(){this._dirty=!0}_update(){const e=this.layerList.length;if(!this._dirty){for(let t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=!0;break}}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(let s=0;s<e;s++){const i=this.layerList[s];i._dirtyComposition=!1;for(let a=0;a<i.cameras.length;a++){const n=i.cameras[a];this.cameras.indexOf(n)<0&&this.cameras.push(n)}}this.cameras.length>1&&n1(this.cameras);let t=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){const i=this.cameras[s];if(i.camera.renderPasses.length>0){this.addDummyRenderAction(t,i),t++;continue}let a=!0;const n=t;let r=null,l=!1;for(let u=0;u<e;u++){const f=this.layerList[u];if(f.enabled&&this.subLayerEnabled[u]&&f.cameras.length>0&&i.layers.indexOf(f.id)>=0){!l&&f.id===i.disablePostEffectsLayer&&(l=!0,r&&(r.triggerPostprocess=!0));const g=this.subLayerList[u];r=this.addRenderAction(t,f,g,i,a,l),t++,a=!1}}n<t&&(r.lastCameraUse=!0),!l&&r&&(r.triggerPostprocess=!0),i.renderTarget&&i.postEffectsEnabled&&this.propagateRenderTarget(n-1,i)}this._logRenderActions()}}getNextRenderAction(e){const t=new kU;return this._renderActions.push(t),t}addDummyRenderAction(e,t){const s=this.getNextRenderAction(e);s.camera=t,s.useCameraPasses=!0}addRenderAction(e,t,s,i,a,n){let r=t.id!==yn?i.renderTarget:null,l=!1;const u=this._renderActions;for(let y=e-1;y>=0;y--)if(u[y].camera===i&&u[y].renderTarget===r){l=!0;break}n&&i.postEffectsEnabled&&(r=null);const f=this.getNextRenderAction(e);f.triggerPostprocess=!1,f.layer=t,f.transparent=s,f.camera=i,f.renderTarget=r,f.firstCameraUse=a,f.lastCameraUse=!1;const _=a||!l,g=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return(_||g)&&f.setupClears(_?i:void 0,t),f}propagateRenderTarget(e,t){for(let s=e;s>=0;s--){const i=this._renderActions[s],a=i.layer;if(i.renderTarget&&a.id!==yn)break;if(a.id===yn)continue;if(i.useCameraPasses)break;const n=i==null?void 0:i.camera.camera;if(n&&(!t.camera.rect.equals(n.rect)||!t.camera.scissorRect.equals(n.scissorRect)))break;i.renderTarget=t.renderTarget}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)!==void 0}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this.fire("remove",e);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertOpaque(e,t){if(this._isSublayerAdded(e,!1))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeOpaque(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertTransparent(e,t){if(this._isSublayerAdded(e,!0))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeTransparent(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}getOpaqueIndex(e){return this.layerOpaqueIndexMap.get(e)??-1}getTransparentIndex(e){return this.layerTransparentIndexMap.get(e)??-1}isEnabled(e,t){if(e.enabled){const s=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);if(s>=0)return this.subLayerEnabled[s]}return!1}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let e=0;e<this.layerList.length;e++){const t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e)}}getLayerById(e){return this.layerIdMap.get(e)??null}getLayerByName(e){return this.layerNameMap.get(e)??null}_updateOpaqueOrder(e,t){for(let s=e;s<=t;s++)this.subLayerList[s]===!1&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(e,t){for(let s=e;s<=t;s++)this.subLayerList[s]===!0&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(e,t,s){let i=-1,a=-1;for(let n=0,r=e.length;n<r;n++){const l=e[n];s.hasOwnProperty(l)&&(i=Math.max(i,s[l]))}for(let n=0,r=t.length;n<r;n++){const l=t[n];s.hasOwnProperty(l)&&(a=Math.max(a,s[l]))}return i===-1&&a!==-1?1:a===-1&&i!==-1?-1:a-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}}const SE=new H,fc={bias:0,normalBias:0},Qv=new xe,PR={r:0,g:1,b:2,a:3},n3={directional:ft,omni:Ds,point:Ds,spot:Ns},w$=[[new Ie(0,0,1,1)],[new Ie(0,0,.5,.5),new Ie(0,.5,.5,.5)],[new Ie(0,0,.5,.5),new Ie(0,.5,.5,.5),new Ie(.5,0,.5,.5)],[new Ie(0,0,.5,.5),new Ie(0,.5,.5,.5),new Ie(.5,0,.5,.5),new Ie(.5,.5,.5,.5)]],R$={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7};let M$=0;class D${constructor(e,t,s){this.light=s,this.camera=e,this.shadowCamera=zU.createShadowCamera(s._shadowType,s._type,t),this.shadowMatrix=new Me,this.shadowViewport=new Ie(0,0,1,1),this.shadowScissor=new Ie(0,0,1,1),this.projectionCompensation=0,this.face=t,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}get shadowBuffer(){const e=this.shadowCamera.renderTarget;return e?this.light._isPcf?e.depthBuffer:e.colorBuffer:null}}class R0{constructor(e,t){this.layers=new Set,this.shadowDepthState=$i.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this.device=e,this.clusteredLighting=t,this.id=M$++,this._type=ft,this._color=new xe(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=uo,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=AC,this._shadowType=Un,this._vsmBlurSize=11,this.vsmBlurMode=MC,this.vsmBias=.01*.25,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=ao,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new H(0,0,0),this._direction=new H(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=UC,this.shadowUpdateOverrides=null,this._isVsm=!1,this._isPcf=!0,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}releaseRenderData(){if(this._renderData){for(let e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0}}addLayer(e){this.layers.add(e)}removeLayer(e){this.layers.delete(e)}set shadowSamples(e){this._softShadowParams[0]=e}get shadowSamples(){return this._softShadowParams[0]}set shadowBlockerSamples(e){this._softShadowParams[1]=e}get shadowBlockerSamples(){return this._softShadowParams[1]}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(e){(!this.cascades||this.numCascades!==e)&&(this.cascades=w$[e-1],this._shadowMatrixPalette=new Float32Array(4*16),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set cascadeBlend(e){this._cascadeBlend!==e&&(this._cascadeBlend=e,this.updateKey())}get cascadeBlend(){return this._cascadeBlend}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey(),this.updateClusteredFlags())}get mask(){return this._mask}get numShadowFaces(){const e=this._type;return e===ft?this.numCascades:e===Ds?6:1}set type(e){if(this._type===e)return;this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();const t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t}get type(){return this._type}set shape(e){if(this._shape===e)return;this._shape=e,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();const t=this._shadowType;this._shadowType=null,this.shadowType=t}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateLinearColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){if(this._shadowType===e)return;let t=xh.get(e);t||(e=Un);const s=this.device;e===fm&&!s.textureFloatRenderable&&!s.textureHalfFloatRenderable&&(e=Un),this._type===Ds&&e!==CC&&e!==Un&&e!==wC&&e!==RC&&e!==fm&&(e=Un),e===cx&&(!s.textureFloatRenderable||!s.textureFloatFilterable)&&(e=e1),e===e1&&!s.textureHalfFloatRenderable&&(e=Un),t=xh.get(e),this._isVsm=(t==null?void 0:t.vsm)??!1,this._isPcf=(t==null?void 0:t.pcf)??!1,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&this._mask!==Pd&&this._mask!==0}set shadowIntensity(e){this._shadowIntensity!==e&&(this._shadowIntensity=e,this.updateKey())}get shadowIntensity(){return this._shadowIntensity}get bakeShadows(){return this._castShadows&&this._mask===Pd}set shadowResolution(e){this._shadowResolution!==e&&(this._type===Ds?e=Math.min(e,this.device.maxCubeMapSize):e=Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2===0&&e++,this._vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){if(this._normalOffsetBias!==e){const t=!this._normalOffsetBias&&e||this._normalOffsetBias&&!e;this._normalOffsetBias=e,t&&this.updateKey()}}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey(),this.updateClusteredFlags())}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this.updateClusterData(!1,!0),this._usePhysicalUnits&&this._updateLinearColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateLinearColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e,this._softShadowParams[2]=e}get penumbraSize(){return this._penumbraSize}set penumbraFalloff(e){this._softShadowParams[3]=e}get penumbraFalloff(){return this._softShadowParams[3]}_updateOuterAngle(e){const t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t),this.updateClusterData(!1,!0)}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateLinearColor())}get intensity(){return this._intensity}set affectSpecularity(e){this._type===ft&&(this._affectSpecularity=e,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateLinearColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new Me),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new Ie(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3){const t=e.charAt(e.length-1),s=3-e.length;for(let i=0;i<s;i++)e+=t}this._cookieChannel=e,this.updateKey(),this.updateClusteredFlags()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new Ee,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){if(this._cookieOffset===e)return;!!(this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new Ie(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=this._type===ft&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),this.shadowUpdateMode===no&&(this.shadowUpdateMode=qd),this.shadowUpdateOverrides)for(let e=0;e<this.shadowUpdateOverrides.length;e++)this.shadowUpdateOverrides[e]===no&&(this.shadowUpdateOverrides[e]=qd)}getRenderData(e,t){for(let i=0;i<this._renderData.length;i++){const a=this._renderData[i];if(a.camera===e&&a.face===t)return a}const s=new D$(e,t,this);return this._renderData.push(s),s}clone(){const e=new R0(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.cascadeBlend=this._cascadeBlend,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e.shadowSamples=this.shadowSamples,e.shadowBlockerSamples=this.shadowBlockerSamples,e.penumbraSize=this.penumbraSize,e.penumbraFalloff=this.penumbraFalloff,e}static getLightUnitConversion(e,t=Math.PI/4,s=0){switch(e){case Ns:{const i=Math.cos(t),a=Math.cos(s);return 2*Math.PI*(1-a+(a-i)/2)}case Ds:return 4*Math.PI;case ft:return 1}}_getUniformBiasValues(e){const t=e.shadowCamera._farClip;switch(this._type){case Ds:fc.bias=this.shadowBias,fc.normalBias=this._normalOffsetBias;break;case Ns:this._isVsm?fc.bias=-1e-5*20:fc.bias=this.shadowBias*20,fc.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case ft:this._isVsm?fc.bias=-1e-5*20:fc.bias=this.shadowBias/t*100,fc.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias;break}return fc}getColor(){return this._color}getBoundingSphere(e){if(this._type===Ns){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,a=this._node;SE.copy(a.up),s>45?(e.radius=t*this._outerConeAngleSin,SE.mulScalar(-t*i)):(e.radius=t/(2*i),SE.mulScalar(-e.radius)),e.center.add2(a.getPosition(),SE)}else this._type===Ds&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)}getBoundingBox(e){if(this._type===Ns){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._node,a=Math.abs(Math.sin(s*ge.DEG_TO_RAD)*t);e.center.set(0,-t*.5,0),e.halfExtents.set(a,t*.5,a),e.setFromTransformedAabb(e,i.getWorldTransform(),!0)}else this._type===Ds&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){if(this._type===Ds&&!this.clusteredLighting)this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0;else{const e=this.shadowBias*-1e3;this.shadowDepthState.depthBias=e,this.shadowDepthState.depthBiasSlope=e}}_updateLinearColor(){let e=this._intensity;this._usePhysicalUnits&&(e=this._luminance/R0.getLightUnitConversion(this._type,this._outerConeAngle*ge.DEG_TO_RAD,this._innerConeAngle*ge.DEG_TO_RAD));const t=this._color,s=this._colorLinear;e>=1?Qv.linear(t).mulScalar(e):Qv.copy(t).mulScalar(e).linear(),s[0]=Qv.r,s[1]=Qv.g,s[2]=Qv.b,this.updateClusterData(!0)}setColor(){arguments.length===1?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):arguments.length===3&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor()}layersDirty(){this.layers.forEach(e=>{e.hasLight(this)&&e.markLightsDirty()})}updateKey(){let e=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(this._normalOffsetBias!==0?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|PR[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|(this.numCascades>0?1:0)<<9|(this._cascadeBlend>0?1:0)<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6|(this._castShadows?1:0)<<3;this._cookieChannel.length===3&&(e|=PR[this._cookieChannel.charAt(1)]<<16,e|=PR[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e}updateClusteredFlags(){const e=!!(this.mask&uo),t=!!(this.mask&Xd);this.clusteredFlags=(this.type===Ns?1:0)<<30|(this._shape&3)<<28|(this._falloffMode&1)<<27|(R$[this._cookieChannel]??0)<<23|(e?1:0)<<22|(t?1:0)<<21}getClusteredFlags(e,t){return this.clusteredFlags|((e?Math.floor(this.shadowIntensity*255):0)&255)<<0|((t?Math.floor(this.cookieIntensity*255):0)&255)<<8}updateClusterData(e,t){const{clusteredData16:s}=this,i=Xc.float2Half;e&&(s[0]=i(ge.clamp(this._colorLinear[0]/db,0,65504)),s[1]=i(ge.clamp(this._colorLinear[1]/db,0,65504)),s[2]=i(ge.clamp(this._colorLinear[2]/db,0,65504))),t&&(s[4]=i(this._innerConeAngleCos),s[5]=i(this._outerConeAngleCos))}}class PP{constructor(e,t,s){this._areaLightsEnabled=!1,this._cells=new H(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=Un,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=s}applySettings(e){this.shadowsEnabled=e.lightingShadowsEnabled??this.shadowsEnabled,this.cookiesEnabled=e.lightingCookiesEnabled??this.cookiesEnabled,this.areaLightsEnabled=e.lightingAreaLightsEnabled??this.areaLightsEnabled,this.shadowAtlasResolution=e.lightingShadowAtlasResolution??this.shadowAtlasResolution,this.cookieAtlasResolution=e.lightingCookieAtlasResolution??this.cookieAtlasResolution,this.maxLightsPerCell=e.lightingMaxLightsPerCell??this.maxLightsPerCell,this.shadowType=e.lightingShadowType??this.shadowType,e.lightingCells&&(this.cells=new H(e.lightingCells))}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=ge.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=ge.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=ge.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const P$=new ms(!0,Qa,wi,wi);class jd{constructor(e){this.shaderCache=[],this.morph=e,e.incRefCount(),this.device=e.device,this._weights=[],this._weightMap=new Map;for(let a=0;a<e._targets.length;a++){const n=e._targets[a];n.name&&this._weightMap.set(n.name,a),this.setWeight(a,n.defaultWeight)}this._activeTargets=[],this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const t=(a,n)=>(this[n]=e._createTexture(a,e._renderTextureFormat),new fs({colorBuffer:this[n],depth:!1}));e.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight]);const s=e.aabb.halfExtents;this._aabbSize=new Float32Array([s.x*4,s.y*4,s.z*4]);const i=e.aabb.getMin();this._aabbMin=new Float32Array([i.x*2,i.y*2,i.z*2]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin");for(let a=0;a<this.maxSubmitCount;a++)this[`morphBlendTex${a}`]=this.device.scope.resolve(`morphBlendTex${a}`);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}destroy(){this.shader=null;const e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new jd(this.morph)}_getWeightIndex(e){return typeof e=="string"?this._weightMap.get(e):e}getWeight(e){const t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){const s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=!0}_getShader(e){let t=this.shaderCache[e];if(!t){const s=this.device.isWebGPU,i=s?ul:dt,a=new Map;a.set("MORPH_TEXTURE_COUNT",e),a.set("{MORPH_TEXTURE_COUNT}",e),this.morph.intRenderFormat&&a.set("MORPH_INT","");const n=new Map;n.set("morphDeclarationPS",i.morphDeclarationPS),n.set("morphEvaluationPS",i.morphEvaluationPS);const r=this.morph.intRenderFormat?"uvec4":"vec4";t=Da(this.device,i.morphVS,i.morphPS,`textureMorph${e}`,{vertex_position:kt},{shaderLanguage:s?Ja:Sr,fragmentIncludes:n,fragmentDefines:a,fragmentOutputTypes:[r]}),this.shaderCache[e]=t}return t}_updateTextureRenderTarget(e,t,s){const i=this.device,a=(u,f)=>{this.morphFactor.setValue(this._shaderMorphWeights),i.setBlendState(f?P$:ms.NOBLEND);const _=this._getShader(u);qn(i,e,_)};this.setAabbUniforms(s);let n=0,r=!1;const l=this._activeTargets.length;for(let u=0;u<l;u++){const f=this._activeTargets[u],_=f.target[t];_&&(this[`morphBlendTex${n}`].setValue(_),this._shaderMorphWeights[n]=f.weight,n++,n>=this.maxSubmitCount&&(a(n,r),n=0,r=!0))}(n>0||l===0&&!this.zeroTextures)&&a(n,r)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions",!0),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals",!1),this.zeroTextures=this._activeTargets.length===0)}setAabbUniforms(e=!0){this.aabbSizeId.setValue(e?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(e?this._aabbMin:this._aabbNrmMin)}prepareRendering(e){this.setAabbUniforms()}update(){this._dirty=!1;const e=this.morph._targets;let t=0;const s=1e-5;for(let i=0;i<e.length;i++){const a=Math.abs(this.getWeight(i));if(a>s){this._activeTargets.length<=t&&(this._activeTargets[t]={});const n=this._activeTargets[t++];n.absWeight=a,n.weight=this.getWeight(i),n.target=e[i]}}this._activeTargets.length=t,this.morph.intRenderFormat&&this._activeTargets.length>this.maxSubmitCount&&(this._activeTargets.sort((i,a)=>i.absWeight<a.absWeight?1:a.absWeight<i.absWeight?-1:0),this._activeTargets.length=this.maxSubmitCount),this._updateTextureMorph()}}class Lh{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){const e=[];for(let t=0;t<this.meshInstances.length;t++){const s=this.meshInstances[t];e.indexOf(s.material)===-1&&e.push(s.material)}return e}clone(){const e=[],t=[],s=function(u){const f=u.clone();e.push(u),t.push(f);for(let _=0;_<u._children.length;_++)f.addChild(s(u._children[_]));return f},i=s(this.graph),a=[],n=[],r=[];for(let u=0;u<this.skinInstances.length;u++){const f=this.skinInstances[u].skin,_=new oy(f),g=[];for(let y=0;y<f.boneNames.length;y++){const v=f.boneNames[y],x=i.findByName(v);g.push(x)}_.bones=g,n.push(_)}for(let u=0;u<this.morphInstances.length;u++){const f=this.morphInstances[u].morph,_=new jd(f);r.push(_)}for(let u=0;u<this.meshInstances.length;u++){const f=this.meshInstances[u],_=e.indexOf(f.node),g=new ps(f.mesh,f.material,t[_]);if(f.skinInstance){const y=this.skinInstances.indexOf(f.skinInstance);g.skinInstance=n[y]}if(f.morphInstance){const y=this.morphInstances.indexOf(f.morphInstance);g.morphInstance=r[y]}a.push(g)}const l=new Lh;return l.graph=i,l.meshInstances=a,l.skinInstances=n,l.morphInstances=r,l.getGraph().syncHierarchy(),l}destroy(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){ps._prepareRenderStyleForArray(this.meshInstances,od)}}class VC extends _C{constructor(e,t,{preferHighPrecision:s=!1}={}){super(),this.device=t;const i=t;this.preferHighPrecision=s,this._targets=e.slice();const a=i.textureHalfFloatRenderable?Js:void 0,n=i.textureFloatRenderable?Ri:void 0;this._renderTextureFormat=this.preferHighPrecision?n??a:a??n,this._renderTextureFormat=this._renderTextureFormat??q0,this.intRenderFormat=kc(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?Ri:Js,this._init(),this._updateMorphFlags()}get aabb(){if(!this._aabb){const e=new H,t=new H;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax())}this._aabb=new wt,this._aabb.setMinMax(e,t)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_findSparseSet(e,t,s){let i=1;const a=e[0].length;for(let n=0;n<a;n+=3){let r=!1;for(let l=0;l<e.length;l++){const u=e[l];if(u[n]!==0||u[n+1]!==0||u[n+2]!==0){r=!0;break}}r?(t.push(i),s.push(n/3),i++):t.push(0)}return i}_initTextureBased(){const e=[],t=[];for(let y=0;y<this._targets.length;y++){const v=this._targets[y];v.options.deltaPositions&&(e.push(v.options.deltaPositions),t.push({target:v,name:"texturePositions"})),v.options.deltaNormals&&(e.push(v.options.deltaNormals),t.push({target:v,name:"textureNormals"}))}const s=[],i=[],a=this._findSparseSet(e,s,i),n=this.device.maxTextureSize;let r=Math.ceil(Math.sqrt(a));r=Math.min(r,n);const l=Math.ceil(a/r);if(l>n)return!1;this.morphTextureWidth=r,this.morphTextureHeight=l;let u=!1;const f=Xc.float2Half;this._textureFormat===Js&&(u=!0);const _=[];for(let y=0;y<e.length;y++)_.push(this._createTexture("MorphTarget",this._textureFormat));for(let y=0;y<e.length;y++){const v=e[y],x=_[y],C=x.lock();if(u)for(let w=0;w<i.length;w++){const T=i[w]*3,R=w*4+4;C[R]=f(v[T]),C[R+1]=f(v[T+1]),C[R+2]=f(v[T+2])}else for(let w=0;w<i.length;w++){const T=i[w]*3,R=w*4+4;C[R]=v[T],C[R+1]=v[T+1],C[R+2]=v[T+2]}x.unlock(),t[y].target._setTexture(t[y].name,x)}const g=[{semantic:tm,components:1,type:Ai,asInt:!0}];return this.vertexBufferIds=new jn(this.device,new en(this.device,g,s.length),s.length,{data:new Uint32Array(s)}),!0}destroy(){var e;(e=this.vertexBufferIds)==null||e.destroy(),this.vertexBufferIds=null;for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let e=0;e<this._targets.length;e++){const t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_createTexture(e,t){return new Ge(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe,name:e})}}class yx{constructor(e){this.used=!1,this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions}destroy(){var e,t;(e=this.texturePositions)==null||e.destroy(),this.texturePositions=null,(t=this.textureNormals)==null||t.destroy(),this.textureNormals=null}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new wt,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}get morphPositions(){return!!this.texturePositions}get morphNormals(){return!!this.textureNormals}clone(){return new yx(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}_setTexture(e,t){this[e]=t}}let pc,DO=1;const He=4,LR=new Me,IR=new Me,ah=new H,Hs=new H,qo=new H,cg=new H,rr=new H,bi=new H,ug=new H,dg=new H,$v=new H,PO=new H,Ha=new H,bE=new H,lp=new H;function zg(h){return h-Math.floor(h)}function L$(h){return Math.max(Math.min(h,1),0)}function OR(h,e){return h-e*Math.floor(h/e)}function I$(h){let e=zg(h),t=zg(255*h),s=zg(65025*h),i=zg(160581375*h);return e-=t/255,t-=s/255,s-=i/255,i-=i/255,[e,t,s,i]}function xE(h){let e=zg(h),t=zg(255*h);return e-=t/255,t-=t/255,[e,t]}class O${constructor(e){this._emitter=e}calcSpawnPosition(e,t,s,i,a){const n=this._emitter,r=Math.random(),l=Math.random(),u=Math.random(),f=Math.random();if(n.useCpu&&(e[a*He+0+n.numParticlesPot*2*He]=r,e[a*He+1+n.numParticlesPot*2*He]=l,e[a*He+2+n.numParticlesPot*2*He]=u),Hs.x=r-.5,Hs.y=l-.5,Hs.z=u-.5,n.emitterShape===Jo){const y=Math.max(Math.abs(Hs.x),Math.max(Math.abs(Hs.y),Math.abs(Hs.z))),v=y+(.5-y)*s[0],x=y+(.5-y)*s[1],C=y+(.5-y)*s[2];Hs.x=v*(y===Math.abs(Hs.x)?Math.sign(Hs.x):2*Hs.x),Hs.y=x*(y===Math.abs(Hs.y)?Math.sign(Hs.y):2*Hs.y),Hs.z=C*(y===Math.abs(Hs.z)?Math.sign(Hs.z):2*Hs.z),n.localSpace?ah.copy(t.transformPoint(Hs)):ah.copy(i).add(t.transformPoint(Hs))}else{Hs.normalize();const y=n.emitterRadius===0?0:n.emitterRadiusInner/n.emitterRadius,v=f*(1-y)+y;n.localSpace?ah.copy(Hs.mulScalar(v*n.emitterRadius)):ah.copy(i).add(Hs.mulScalar(v*n.emitterRadius))}let g=-ge.lerp(n.rate,n.rate2,r)*a;if(n.pack8){const y=(ah.x-n.worldBounds.center.x)/n.worldBoundsSize.x+.5,v=(ah.y-n.worldBounds.center.y)/n.worldBoundsSize.y+.5,x=(ah.z-n.worldBounds.center.z)/n.worldBoundsSize.z+.5;let C=ge.lerp(n.startAngle*ge.DEG_TO_RAD,n.startAngle2*ge.DEG_TO_RAD,r);C=C%(Math.PI*2)/(Math.PI*2);const M=xE(y);e[a*He]=M[0],e[a*He+1]=M[1];const w=xE(v);e[a*He+2]=w[0],e[a*He+3]=w[1];const T=xE(x);e[a*He+0+n.numParticlesPot*He]=T[0],e[a*He+1+n.numParticlesPot*He]=T[1];const R=xE(C);e[a*He+2+n.numParticlesPot*He]=R[0],e[a*He+3+n.numParticlesPot*He]=R[1];const D=1;e[a*He+3+n.numParticlesPot*He*2]=D;const I=Math.max(n.lifetime,(n.numParticles-1)*Math.max(n.rate,n.rate2)),U=n.lifetime+1;g=(g+I)/(I+U);const O=I$(g);e[a*He+0+n.numParticlesPot*He*3]=O[0],e[a*He+1+n.numParticlesPot*He*3]=O[1],e[a*He+2+n.numParticlesPot*He*3]=O[2],e[a*He+3+n.numParticlesPot*He*3]=O[3]}else e[a*He]=ah.x,e[a*He+1]=ah.y,e[a*He+2]=ah.z,e[a*He+3]=ge.lerp(n.startAngle*ge.DEG_TO_RAD,n.startAngle2*ge.DEG_TO_RAD,r),e[a*He+3+n.numParticlesPot*He]=g}update(e,t,s,i,a,n,r,l){let u,f,_;const g=this._emitter;if(g.meshInstance.node){const N=g.meshInstance.node.worldTransform;for(let z=0;z<12;z++)LR.data[z]=N.data[z];IR.copy(LR),IR.invert(),pc=g.meshInstance.node.localScale,DO=Math.max(Math.max(pc.x,pc.y),pc.z)}n=g.meshInstance.node===null||g.localSpace?H.ZERO:g.meshInstance.node.getPosition();const y=g.camera?g.camera._node.getPosition():H.ZERO,v=g.useMesh?17:15;let x,C,M,w,T,R,D,I,U;const O=g.precision-1;for(let N=0;N<g.numParticles;N++){const z=Math.floor(g.vbCPU[N*g.numParticleVerts*(g.useMesh?6:4)+3]),X=s[z*He+0+g.numParticlesPot*2*He];qo.x=X,qo.y=s[z*He+1+g.numParticlesPot*2*He],qo.z=s[z*He+2+g.numParticlesPot*2*He];const Y=g.rate+(g.rate2-g.rate)*X,F=g.lifetime;let q=s[z*He+3+g.numParticlesPot*He]+r;const G=L$(q/F);let W=0,k=0;const K=0;(q-r<=0||q>=F)&&this.calcSpawnPosition(s,i,a,n,z);let V=q>0&&q<F;V&&(_=G*O,x=Math.floor(_),C=Math.ceil(_),_%=1,u=g.qRotSpeed[x],f=g.qRotSpeed[C],M=u+(f-u)*_,u=g.qRotSpeed2[x],f=g.qRotSpeed2[C],w=u+(f-u)*_,u=g.qScale[x],f=g.qScale[C],W=u+(f-u)*_,u=g.qScale2[x],f=g.qScale2[C],T=u+(f-u)*_,u=g.qAlpha[x],f=g.qAlpha[C],R=u+(f-u)*_,u=g.qAlpha2[x],f=g.qAlpha2[C],D=u+(f-u)*_,u=g.qRadialSpeed[x],f=g.qRadialSpeed[C],I=u+(f-u)*_,u=g.qRadialSpeed2[x],f=g.qRadialSpeed2[C],U=u+(f-u)*_,I+=(U-I)*(X*100%1),cg.x=s[z*He],cg.y=s[z*He+1],cg.z=s[z*He+2],g.localSpace?$v.copy(cg):$v.copy(cg).sub(n),$v.normalize().mulScalar(I),x*=3,C*=3,u=g.qLocalVelocity[x],f=g.qLocalVelocity[C],bi.x=u+(f-u)*_,u=g.qLocalVelocity[x+1],f=g.qLocalVelocity[C+1],bi.y=u+(f-u)*_,u=g.qLocalVelocity[x+2],f=g.qLocalVelocity[C+2],bi.z=u+(f-u)*_,u=g.qLocalVelocity2[x],f=g.qLocalVelocity2[C],dg.x=u+(f-u)*_,u=g.qLocalVelocity2[x+1],f=g.qLocalVelocity2[C+1],dg.y=u+(f-u)*_,u=g.qLocalVelocity2[x+2],f=g.qLocalVelocity2[C+2],dg.z=u+(f-u)*_,u=g.qVelocity[x],f=g.qVelocity[C],rr.x=u+(f-u)*_,u=g.qVelocity[x+1],f=g.qVelocity[C+1],rr.y=u+(f-u)*_,u=g.qVelocity[x+2],f=g.qVelocity[C+2],rr.z=u+(f-u)*_,u=g.qVelocity2[x],f=g.qVelocity2[C],ug.x=u+(f-u)*_,u=g.qVelocity2[x+1],f=g.qVelocity2[C+1],ug.y=u+(f-u)*_,u=g.qVelocity2[x+2],f=g.qVelocity2[C+2],ug.z=u+(f-u)*_,bi.x+=(dg.x-bi.x)*qo.x,bi.y+=(dg.y-bi.y)*qo.y,bi.z+=(dg.z-bi.z)*qo.z,g.initialVelocity>0&&(g.emitterShape===nU?(Hs.copy(qo).mulScalar(2).sub(H.ONE).normalize(),bi.add(Hs.mulScalar(g.initialVelocity))):bi.add(H.FORWARD.mulScalar(g.initialVelocity))),rr.x+=(ug.x-rr.x)*qo.x,rr.y+=(ug.y-rr.y)*qo.y,rr.z+=(ug.z-rr.z)*qo.z,M+=(w-M)*qo.y,W=(W+(T-W)*(X*1e4%1))*DO,k=(D-R)*(X*1e3%1),g.meshInstance.node&&(g.localSpace?(bi.x/=pc.x,bi.y/=pc.y,bi.z/=pc.z):LR.transformPoint(bi,bi)),g.localSpace?(IR.transformPoint(rr,rr),bi.add(rr).add($v)):(bi.add(rr.mul(pc)),bi.add($v.mul(pc))),bE.copy(bi),PO.copy(cg).add(bi.mulScalar(r)),Ha.copy(PO),s[z*He]=Ha.x,s[z*He+1]=Ha.y,s[z*He+2]=Ha.z,s[z*He+3]+=M*r,g.wrap&&g.wrapBounds&&(g.localSpace||Ha.sub(n),Ha.x=OR(Ha.x,g.wrapBounds.x)-g.wrapBounds.x*.5,Ha.y=OR(Ha.y,g.wrapBounds.y)-g.wrapBounds.y*.5,Ha.z=OR(Ha.z,g.wrapBounds.z)-g.wrapBounds.z*.5,g.localSpace||Ha.add(n)),g.sort>0&&(g.sort===1?(lp.copy(Ha).sub(y),g.particleDistance[z]=-(lp.x*lp.x+lp.y*lp.y+lp.z*lp.z)):g.sort===2?g.particleDistance[z]=q:g.sort===3&&(g.particleDistance[z]=-q))),l?q<0&&(s[z*He+3+g.numParticlesPot*2*He]=-1):(q>=F&&(q-=Math.max(F,(g.numParticles-1)*Y),s[z*He+3+g.numParticlesPot*2*He]=g.loop?1:-1),q<0&&g.loop&&(s[z*He+3+g.numParticlesPot*2*He]=1)),s[z*He+3+g.numParticlesPot*2*He]<0&&(V=!1),s[z*He+3+g.numParticlesPot*He]=q;for(let Q=0;Q<g.numParticleVerts;Q++){const se=(N*g.numParticleVerts+Q)*(g.useMesh?6:4);let J=g.vbCPU[se],ie=g.vbCPU[se+1],oe=g.vbCPU[se+2];V||(J=ie=oe=0);const he=N*g.numParticleVerts*v+Q*v;e[he]=Ha.x,e[he+1]=Ha.y,e[he+2]=Ha.z,e[he+3]=G,e[he+4]=g.alignToMotion?K:s[z*He+3],e[he+5]=W,e[he+6]=k,e[he+7]=bE.x,e[he+8]=J,e[he+9]=ie,e[he+10]=oe,e[he+11]=bE.y,e[he+12]=z,e[he+13]=bE.z,e[he+14]=g.vbCPU[se+3],g.useMesh&&(e[he+15]=g.vbCPU[se+4],e[he+16]=g.vbCPU[se+5])}}if(g.sort>IA&&g.camera){const N=g.useMesh?6:4,z=g.particleDistance;for(let X=0;X<g.numParticles;X++)t[X][0]=X,t[X][1]=z[Math.floor(g.vbCPU[X*g.numParticleVerts*N+3])];g.vbOld.set(g.vbCPU),t.sort((X,Y)=>X[1]-Y[1]);for(let X=0;X<g.numParticles;X++){const Y=t[X][0]*g.numParticleVerts*N,F=X*g.numParticleVerts*N;for(let q=0;q<g.numParticleVerts*N;q++)g.vbCPU[F+q]=g.vbOld[Y+q]}}}}const LO=new ol,IO=new ol,OO=new ol;class N${constructor(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(e,t,s,i,a){const n=this._emitter;e.setBlendState(ms.NOBLEND),e.setDepthState($i.NODEPTH),e.setCullMode(Xs),this.randomize(),this.constantGraphSampleSize.setValue(1/n.precision),this.constantGraphNumSamples.setValue(n.precision),this.constantNumParticles.setValue(n.numParticles),this.constantNumParticlesPot.setValue(n.numParticlesPot),this.constantInternalTex0.setValue(n.internalTex0),this.constantInternalTex1.setValue(n.internalTex1),this.constantInternalTex2.setValue(n.internalTex2),this.constantInternalTex3.setValue(n.internalTex3);const r=n.meshInstance.node,l=r===null?H.ONE:r.localScale;if(n.pack8){this.worldBoundsMulUniform[0]=n.worldBoundsMul.x,this.worldBoundsMulUniform[1]=n.worldBoundsMul.y,this.worldBoundsMulUniform[2]=n.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=n.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=n.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=n.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let y=n.maxVel*Math.max(Math.max(l.x,l.y),l.z);y=Math.max(y,1),this.constantMaxVel.setValue(y)}const u=r===null||n.localSpace?H.ZERO:r.getPosition(),f=r===null?Me.IDENTITY:r.getWorldTransform();n.emitterShape===Jo?(LO.setFromMat4(t),this.constantSpawnBounds.setValue(LO.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(n.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(n.emitterRadius===0?0:n.emitterRadiusInner/n.emitterRadius)),this.constantInitialVelocity.setValue(n.initialVelocity),IO.setFromMat4(f),OO.invertMat4(f),this.emitterPosUniform[0]=u.x,this.emitterPosUniform[1]=u.y,this.emitterPosUniform[2]=u.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(n.rate),this.constantRateDiv.setValue(n.rate2-n.rate),this.constantStartAngle.setValue(n.startAngle*ge.DEG_TO_RAD),this.constantStartAngle2.setValue(n.startAngle2*ge.DEG_TO_RAD),this.constantSeed.setValue(n.seed),this.constantLifetime.setValue(n.lifetime),this.emitterScaleUniform[0]=l.x,this.emitterScaleUniform[1]=l.y,this.emitterScaleUniform[2]=l.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(IO.data),this.constantEmitterMatrixInv.setValue(OO.data),this.constantLocalVelocityDivMult.setValue(n.localVelocityUMax),this.constantVelocityDivMult.setValue(n.velocityUMax),this.constantRotSpeedDivMult.setValue(n.rotSpeedUMax[0]);let _=n.swapTex?n.particleTexOUT:n.particleTexIN;_=n.beenReset?n.particleTexStart:_;const g=n.swapTex?n.particleTexIN:n.particleTexOUT;this.constantParticleTexIN.setValue(_),qn(e,n.swapTex?n.rtParticleTexIN:n.rtParticleTexOUT,a?n.shaderParticleUpdateOnStop:n.loop?n.shaderParticleUpdateRespawn:n.shaderParticleUpdateNoRespawn),n.material.setParameter("particleTexOUT",_),n.material.setParameter("particleTexIN",g),n.beenReset=!1,n.swapTex=!n.swapTex,n.prevWorldBoundsSize.copy(n.worldBoundsSize),n.prevWorldBoundsCenter.copy(n.worldBounds.center),n.pack8&&this._setInputBounds()}}const NO=["NONE","VERTEX","MAP"];class F$ extends Kc{generateKey(e){let s=`particle_${Kc.definesHash(e.defines)}_`;for(const i in e)e.hasOwnProperty(i)&&(s+=e[i]);return s}createVertexDefines(e){const t=new Map(e.defines);return e.mesh&&t.set("USE_MESH",""),e.localSpace&&t.set("LOCAL_SPACE",""),e.screenSpace&&t.set("SCREEN_SPACE",""),e.animTex&&t.set("ANIMTEX",""),e.soft>0&&t.set("SOFT",""),e.stretch>0&&t.set("STRETCH",""),e.customFace&&t.set("CUSTOM_FACE",""),e.pack8&&t.set("PACK8",""),e.localSpace&&t.set("LOCAL_SPACE",""),e.animTexLoop&&t.set("ANIMTEX_LOOP",""),e.wrap&&t.set("WRAP",""),e.alignToMotion&&t.set("ALIGN_TO_MOTION",""),t.set("NORMAL",NO[e.normal]),t}createFragmentDefines(e){const t=new Map(e.defines);return e.soft>0&&t.set("SOFT",""),e.halflambert&&t.set("HALF_LAMBERT",""),t.set("NORMAL",NO[e.normal]),t.set("BLEND",oP[e.blend]),t}createShaderDefinition(e,t){const s=this.createVertexDefines(t),i=this.createFragmentDefines(t),a=`PARTICLE_${t.useCpu?"CPU":"GPU"}
`;s.set(a,""),i.set(a,"");const n=new Map(Object.entries({...dt,...t.chunks}));return da.createDefinition(e,{name:"ParticleShader",vertexCode:dt.particle_shaderVS,fragmentCode:dt.particle_shaderPS,fragmentDefines:i,fragmentIncludes:n,vertexIncludes:n,vertexDefines:s})}}const B$=new F$;class U$ extends Jc{constructor(e){super(),this.emitter=null,this.emitter=e}getShaderVariant(e){const{device:t,scene:s,cameraShaderParams:i}=e,{emitter:a}=this,n={defines:kC(this,e),pass:tf,useCpu:this.emitter.useCpu,normal:a.lighting?a.normalMap!==null?2:1:0,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:(i==null?void 0:i.shaderOutputGamma)??Ch,toneMap:(i==null?void 0:i.toneMapping)??sy,fog:s&&!this.emitter.noFog?s.fog.type:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:a.inTools?!1:this.emitter.screenSpace,blend:this.emitter.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!==t1},r=new gx(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),l=Bm(t);return l.register("particle",B$),l.getProgram("particle",n,r,this.userId)}}const FO=[[-1,-1],[1,-1],[1,1],[-1,1]];function Qr(h,e,t,s,i=Ri,a,n){let r=Je;n&&(i===Lt||i===ki)&&(r=Vt);const l=new Ge(h,{width:e,height:t,format:i,cubemap:!1,mipmaps:!1,minFilter:r,magFilter:r,addressU:Oe,addressV:Oe,name:"ParticleSystemTexture"}),u=l.lock();if(i===Lt||i===ki){const f=new Uint8Array(s.length);for(let _=0;_<s.length;_++)f[_]=s[_]*a*255;s=f}return u.set(s),l.unlock(),l}function BO(h){return Math.max(Math.min(h,1),0)}const UO=new so([0,0,1,0]),zO=new so([0,1,1,1]),kO=new Ad([0,0,1,0],[0,0,1,0],[0,0,1,0]),z$=new Ad([0,1,1,1],[0,1,1,1],[0,1,1,1]);let mc=2;const TE=4,_c=new Float32Array(3),hp=new Me,VO=new H,EE=new H,AE=new H;let r3,_A;function We(h,e){_A[h]!==void 0&&_A[h]!==null?r3[h]=_A[h]:r3[h]=e}function VU(h,e,t){return(h*255<<16|e*255<<8|t*255)/(1<<24)}function GO(h,e){const t=h.length/3,s=new Array(t*4);for(let i=0;i<t;i++)s[i*4]=h[i*3],s[i*4+1]=h[i*3+1],s[i*4+2]=h[i*3+2],s[i*4+3]=VU(e[i*3],e[i*3+1],e[i*3+2]);return s}function k$(h,e){const t=new Array(e.length*4);for(let s=0;s<e.length;s++)t[s*4]=h[s*3],t[s*4+1]=h[s*3+1],t[s*4+2]=h[s*3+2],t[s*4+3]=e[s];return t}function V$(h,e,t,s,i){const a=new Array(h.length*4);for(let n=0;n<h.length;n++)a[n*4]=h[n],a[n*4+1]=e[n],a[n*4+2]=0,a[n*4+3]=VU(t[n],s[n],i[n]);return a}function G$(h,e){const t=new Array(h.length*4);for(let s=0;s<h.length;s++)t[s*4]=h[s],t[s*4+1]=e[s],t[s*4+2]=0,t[s*4+3]=0;return t}function H$(h){const e=Math.max(h.rate,h.rate2)*h.numParticles+h.lifetime;return Date.now()+e*1e3}function W$(h,e){const t=new Float32Array(h.length);for(let s=0;s<h.length;s++)t[s]=h[s]-e[s];return t}function xp(h,e){const t=e.length,s=h.length/t;for(let i=0;i<s;i++)for(let a=0;a<t;a++){const n=Math.abs(h[i*t+a]);e[a]=Math.max(e[a],n)}}function q$(h,e){const t=e.length,s=h.length/t;for(let i=0;i<s;i++)for(let a=0;a<t;a++)h[i*t+a]/=e[a]===0?1:e[a],h[i*t+a]*=.5,h[i*t+a]+=.5}function cp(h,e,t){const s=W$(e,h);return xp(s,t),q$(s,t),s}const X$=new Xn;class GU{constructor(e,t){this.material=null,this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.graphicsDevice=e;const s=e,i=32;this.precision=i,this._addTimeTime=0,r3=this,_A=t,We("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),We("rate",1),We("rate2",this.rate),We("lifetime",50),We("emitterExtents",new H(0,0,0)),We("emitterExtentsInner",new H(0,0,0)),We("emitterRadius",0),We("emitterRadiusInner",0),We("emitterShape",Jo),We("initialVelocity",1),We("wrap",!1),We("localSpace",!1),We("screenSpace",!1),We("wrapBounds",null),We("colorMap",this.defaultParamTexture),We("normalMap",null),We("loop",!0),We("preWarm",!1),We("sort",IA),We("mode",mP),We("scene",null),We("lighting",!1),We("halfLambert",!1),We("intensity",1),We("stretch",0),We("alignToMotion",!1),We("depthSoftening",0),We("mesh",null),We("particleNormal",new H(0,1,0)),We("orientation",t1),We("depthWrite",!1),We("noFog",!1),We("blendType",xr),We("node",null),We("startAngle",0),We("startAngle2",this.startAngle),We("animTilesX",1),We("animTilesY",1),We("animStartFrame",0),We("animNumFrames",1),We("animNumAnimations",1),We("animIndex",0),We("randomizeAnimIndex",!1),We("animSpeed",1),We("animLoop",!0),this._gpuUpdater=new N$(this,s),this._cpuUpdater=new O$(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),We("colorGraph",z$),We("colorGraph2",this.colorGraph),We("scaleGraph",zO),We("scaleGraph2",this.scaleGraph),We("alphaGraph",zO),We("alphaGraph2",this.alphaGraph),We("localVelocityGraph",kO),We("localVelocityGraph2",this.localVelocityGraph),We("velocityGraph",kO),We("velocityGraph2",this.velocityGraph),We("rotationSpeedGraph",UO),We("rotationSpeedGraph2",this.rotationSpeedGraph),We("radialSpeedGraph",UO),We("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!e.supportsGpuParticles,this.pack8=!0,this.localBounds=new wt,this.worldBoundsNoTrail=new wt,this.worldBoundsTrail=[new wt,new wt],this.worldBounds=new wt,this.worldBoundsSize=new H,this.prevWorldBoundsSize=new H,this.prevWorldBoundsCenter=new H,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new H,this.worldBoundsAdd=new H,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}get defaultParamTexture(){return X$.get(this.graphicsDevice,()=>{const s=new Float32Array(1024);for(let a=0;a<16;a++)for(let n=0;n<16;n++){const r=n+1-8.5,l=a+1-8.5,u=BO(1-BO(Math.sqrt(r*r+l*l)/16)-.5),f=a*16+n;s[f*4]=1,s[f*4+1]=1,s[f*4+2]=1,s[f*4+3]=u}const i=Qr(this.graphicsDevice,16,16,s,ki,1,!0);return i.minFilter=Vt,i.magFilter=Vt,i})}onChangeCamera(){this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let s=!1;this.emitterShape===Jo?s=!this.emitterExtents.equals(this.prevEmitterExtents):s=this.emitterRadius!==this.prevEmitterRadius,s&&this.calculateLocalBounds()}const e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?Me.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let e=Number.MAX_VALUE,t=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,a=-Number.MAX_VALUE,n=-Number.MAX_VALUE,r=0,l=0;const u=this.lifetime/this.precision,f=[this.qVelocity,this.qVelocity2],_=[this.qLocalVelocity,this.qLocalVelocity2],g=[0,0],y=[0,0],v=[0,0],x=[0,0],C=[0,0];let M,w,T;for(let D=0;D<this.precision+1;D++){const I=Math.min(D,this.precision-1);for(let U=0;U<2;U++)M=_[U][I*3+0]*u+g[U],w=_[U][I*3+1]*u+y[U],T=_[U][I*3+2]*u+v[U],e=Math.min(M,e),t=Math.min(w,t),s=Math.min(T,s),i=Math.max(M,i),a=Math.max(w,a),n=Math.max(T,n),g[U]=M,y[U]=w,v[U]=T;for(let U=0;U<2;U++)C[U]+=u*Math.sqrt(f[U][I*3+0]*f[U][I*3+0]+f[U][I*3+1]*f[U][I*3+1]+f[U][I*3+2]*f[U][I*3+2]);x[0]+=this.qRadialSpeed[I]*u,x[1]+=this.qRadialSpeed2[I]*u,r=Math.max(r,Math.max(Math.abs(x[0]),Math.abs(x[1]))),l=Math.max(l,this.qScale[I])}this.emitterShape===Jo?(M=this.emitterExtents.x*.5,w=this.emitterExtents.y*.5,T=this.emitterExtents.z*.5):(M=this.emitterRadius,w=this.emitterRadius,T=this.emitterRadius);const R=Math.max(C[0],C[1]);EE.x=e-l-M-r-R,EE.y=t-l-w-r-R,EE.z=s-l-T-r-R,AE.x=i+l+M+r+R,AE.y=a+l+w+r+R,AE.z=n+l+T+r+R,this.localBounds.setMinMax(EE,AE)}rebuild(){const e=this.graphicsDevice;this.colorMap===null&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=this.emitterShape===Jo?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>IA||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles,this._destroyResources(),this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,mc=this.useCpu||this.pack8?4:2,this.useMesh=!!this.mesh,this.numParticlesPot=ge.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?Me.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let _=0;_<this.numParticles;_++)this.vbToSort[_]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*mc*TE);const t=this.node===null||this.localSpace?H.ZERO:this.node.getPosition();this.emitterShape===Jo&&(this.node===null||this.localSpace?hp.setTRS(H.ZERO,Ne.IDENTITY,this.spawnBounds):hp.setTRS(H.ZERO,this.node.getRotation(),VO.copy(this.spawnBounds).mul(this.node.localScale)),_c[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,_c[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,_c[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let _=0;_<this.numParticles;_++)this._cpuUpdater.calcSpawnPosition(this.particleTex,hp,_c,t,_),this.useCpu&&(this.particleTex[_*TE+3+this.numParticlesPot*2*TE]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*mc*TE);for(let _=0;_<this.particleTexStart.length;_++)this.particleTexStart[_]=this.particleTex[_];this.useCpu||(this.pack8?(this.particleTexIN=Qr(e,this.numParticlesPot,mc,this.particleTex,Lt,1,!1),this.particleTexOUT=Qr(e,this.numParticlesPot,mc,this.particleTex,Lt,1,!1),this.particleTexStart=Qr(e,this.numParticlesPot,mc,this.particleTexStart,Lt,1,!1)):(this.particleTexIN=Qr(e,this.numParticlesPot,mc,this.particleTex),this.particleTexOUT=Qr(e,this.numParticlesPot,mc,this.particleTex),this.particleTexStart=Qr(e,this.numParticlesPot,mc,this.particleTexStart)),this.rtParticleTexIN=new fs({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new fs({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=new Map;this.localSpace&&s.set("LOCAL_SPACE",""),this.pack8&&s.set("PACK8",""),this.emitterShape===Jo&&s.set("EMITTERSHAPE_BOX","");const i=new Map(Object.entries(dt)),a=`#define RESPAWN
 ${dt.particle_simulationPS}`,n=`#define NO_RESPAWN
 ${dt.particle_simulationPS}`,r=`#define ON_STOP
 ${dt.particle_simulationPS}`,l=`Shape:${this.emitterShape}-Pack:${this.pack8}-Local:${this.localSpace}`;this.shaderParticleUpdateRespawn=Da(e,dt.fullscreenQuadVS,a,`ParticleUpdateRespawn-${l}`,void 0,!1,{fragmentDefines:s,fragmentIncludes:i}),this.shaderParticleUpdateNoRespawn=Da(e,dt.fullscreenQuadVS,n,`ParticleUpdateNoRespawn-${l}`,void 0,!1,{fragmentDefines:s,fragmentIncludes:i}),this.shaderParticleUpdateOnStop=Da(e,dt.fullscreenQuadVS,r,`ParticleUpdateStop-${l}`,void 0,!1,{fragmentDefines:s,fragmentIncludes:i}),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const u=new Ft(e);u.vertexBuffer=this.vertexBuffer,u.indexBuffer[0]=this.indexBuffer,u.primitive[0].type=al,u.primitive[0].base=0,u.primitive[0].count=this.numParticles*this.numParticleIndices,u.primitive[0].indexed=!0,this.material=this._createMaterial(),this.resetMaterial();const f=this.meshInstance?this.meshInstance.visible:!0;this.meshInstance=new ps(u,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=f,this._setMaterialTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){const e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(let s=0;s<e;s++)this.qRotSpeed[s]*=ge.DEG_TO_RAD,this.qRotSpeed2[s]*=ge.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=cp(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=cp(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=cp(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=cp(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=cp(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=cp(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=cp(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const s=[0,0,0];xp(this.qVelocity,s);const i=[0,0,0];xp(this.qVelocity2,i);const a=[0,0,0];xp(this.qLocalVelocity,a);const n=[0,0,0];xp(this.qLocalVelocity2,n);const r=[0];xp(this.qRadialSpeed,r);const l=[0];xp(this.qRadialSpeed2,l);let u=Math.max(s[0],i[0]);u=Math.max(u,s[1]),u=Math.max(u,i[1]),u=Math.max(u,s[2]),u=Math.max(u,i[2]);let f=Math.max(a[0],n[0]);f=Math.max(f,a[1]),f=Math.max(f,n[1]),f=Math.max(f,a[2]),f=Math.max(f,n[2]);const _=Math.max(r[0],l[0]);this.maxVel=u+f+_}this.useCpu||(this.internalTex0=Qr(t,e,1,GO(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Qr(t,e,1,GO(this.qVelocity,this.qVelocityDiv)),this.internalTex2=Qr(t,e,1,V$(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=Qr(t,e,1,G$(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=Qr(t,e,1,k$(this.qColor,this.qAlpha),ki,1,!0)}_setMaterialTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}_createMaterial(){const e=new U$(this);return e.name=`EmitterMaterial:${this.node.name}`,e.cull=Xs,e.alphaWrite=!1,e.blendType=this.blendType,e.depthWrite=this.depthWrite,e}resetMaterial(){const e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this._setMaterialTextures(),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=Xs),this._compParticleFaceParams()}_compParticleFaceParams(){let e,t;if(this.orientation===t1)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{let s;this.orientation===rU?s=this.particleNormal.normalize():s=(this.node===null?Me.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();const i=new H(1,0,0);Math.abs(i.dot(s))===1&&i.set(0,0,1);const a=new H().cross(s,i).normalize();i.cross(a,s).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([a.x,a.y,a.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)}_allocate(e){const t=e*this.numParticleVerts,s=e*this.numParticleIndices;if(this.vertexBuffer===void 0||this.vertexBuffer.getNumVertices()!==t){const i=[];this.useCpu?i.push({semantic:MA,components:4,type:it},{semantic:DA,components:4,type:it},{semantic:LD,components:4,type:it},{semantic:ID,components:1,type:it},{semantic:OD,components:this.useMesh?4:2,type:it}):(i.push({semantic:MA,components:4,type:it}),this.useMesh&&i.push({semantic:DA,components:2,type:it}));const a=new en(this.graphicsDevice,i);this.vertexBuffer=new jn(this.graphicsDevice,a,t,{usage:Ob}),this.indexBuffer=new Ah(this.graphicsDevice,Th,s);const n=new Float32Array(this.vertexBuffer.lock());let r,l,u;if(this.useMesh){r=new Float32Array(this.mesh.vertexBuffer.lock()),l=r.length/this.mesh.vertexBuffer.numVertices;for(let g=0;g<this.mesh.vertexBuffer.format.elements.length;g++)if(this.mesh.vertexBuffer.format.elements[g].name===Za){u=this.mesh.vertexBuffer.format.elements[g].offset/4;break}}for(let g=0;g<t;g++){const y=Math.floor(g/this.numParticleVerts);if(this.useMesh){const v=g%this.numParticleVerts;n[g*6]=r[v*l],n[g*6+1]=r[v*l+1],n[g*6+2]=r[v*l+2],n[g*6+3]=y,n[g*6+4]=r[v*l+u+0],n[g*6+5]=1-r[v*l+u+1]}else{const v=g%4;n[g*4]=FO[v][0],n[g*4+1]=FO[v][1],n[g*4+2]=0,n[g*4+3]=y}}this.useCpu&&(this.vbCPU=new Float32Array(n),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let f=0;const _=new Uint32Array(this.indexBuffer.lock());if(this.useMesh){const g=this.mesh.indexBuffer[0];r=new $b[g.format](g.lock())}for(let g=0;g<e;g++)if(this.useMesh)for(let y=0;y<this.numParticleIndices;y++)_[g*this.numParticleIndices+y]=r[y]+g*this.numParticleVerts;else{const y=g*4;_[f++]=y,_[f++]=y+1,_[f++]=y+2,_[f++]=y,_[f++]=y+2,_[f++]=y+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._setMaterialTextures();this.resetWorldBounds(),this.resetTime();const e=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)}prewarm(e){const t=e/this.lifetime,s=Math.min(Math.floor(t*this.precision),this.precision),i=e/s;for(let a=0;a<s;a++)this.addTime(i,!1)}resetTime(){this.endTime=H$(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(e,t){const s=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){const n=this.animTilesParams;n[0]=1/this.animTilesX,n[1]=1/this.animTilesY;const r=this.animParams;r[0]=this.animStartFrame,r[1]=this.animNumFrames*this.animSpeed,r[2]=this.animNumFrames-1,r[3]=this.animNumAnimations-1;const l=this.animIndexParams;l[0]=this.animIndex,l[1]=this.randomizeAnimIndex}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),this.emitterShape===Jo&&(_c[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,_c[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,_c[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0,this.meshInstance.node===null?hp.setTRS(H.ZERO,Ne.IDENTITY,this.emitterExtents):hp.setTRS(H.ZERO,this.meshInstance.node.getRotation(),VO.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));let i;const a=this.meshInstance.node===null?H.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=a.x,this.emitterScaleUniform[1]=a.y,this.emitterScaleUniform[2]=a.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),!this.useCpu)this._gpuUpdater.update(s,hp,_c,e,t);else{const n=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(n,this.vbToSort,this.particleTex,hp,_c,i,e,t)}this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){var e,t,s,i,a,n,r,l,u,f,_,g;(e=this.particleTexIN)==null||e.destroy(),this.particleTexIN=null,(t=this.particleTexOUT)==null||t.destroy(),this.particleTexOUT=null,this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),(s=this.rtParticleTexIN)==null||s.destroy(),this.rtParticleTexIN=null,(i=this.rtParticleTexOUT)==null||i.destroy(),this.rtParticleTexOUT=null,(a=this.internalTex0)==null||a.destroy(),this.internalTex0=null,(n=this.internalTex1)==null||n.destroy(),this.internalTex1=null,(r=this.internalTex2)==null||r.destroy(),this.internalTex2=null,(l=this.internalTex3)==null||l.destroy(),this.internalTex3=null,(u=this.colorParam)==null||u.destroy(),this.colorParam=null,(f=this.vertexBuffer)==null||f.destroy(),this.vertexBuffer=void 0,(_=this.indexBuffer)==null||_.destroy(),this.indexBuffer=void 0,(g=this.material)==null||g.destroy(),this.material=null}destroy(){this.camera=null,this._destroyResources()}}class j$ extends Kc{generateKey(e){const t=e.shaderDesc,s=t.vertexGLSL?sl(t.vertexGLSL):0,i=t.fragmentGLSL?sl(t.fragmentGLSL):0,a=t.vertexWGSL?sl(t.vertexWGSL):0,n=t.fragmentWGSL?sl(t.fragmentWGSL):0,r=Kc.definesHash(e.defines);let l=`${t.uniqueName}_${r}_${s}_${i}_${a}_${n}`;return e.skin&&(l+="_skin"),e.useInstancing&&(l+="_inst"),e.useMorphPosition&&(l+="_morphp"),e.useMorphNormal&&(l+="_morphn"),e.useMorphTextureBasedInt&&(l+="_morphi"),l}createAttributesDefinition(e,t){const s=t.shaderDesc.attributes,i=s?{...s}:void 0;t.skin&&(i.vertex_boneWeights=co,i.vertex_boneIndices=gn),(t.useMorphPosition||t.useMorphNormal)&&(i.morph_vertex_id=tm),e.attributes=i}createVertexDefinition(e,t,s,i){const a=t.shaderDesc,n=new Map(s);n.set("transformInstancingVS","");const r=new Map(t.defines);t.skin&&r.set("SKIN",!0),t.useInstancing&&r.set("INSTANCING",!0),(t.useMorphPosition||t.useMorphNormal)&&(r.set("MORPHING",!0),t.useMorphTextureBasedInt&&r.set("MORPHING_INT",!0),t.useMorphPosition&&r.set("MORPHING_POSITION",!0),t.useMorphNormal&&r.set("MORPHING_NORMAL",!0)),e.vertexCode=i?a.vertexWGSL:a.vertexGLSL,e.vertexIncludes=n,e.vertexDefines=r}createFragmentDefinition(e,t,s,i){const a=t.shaderDesc,n=new Map(s),r=new Map(t.defines);e.fragmentCode=i?a.fragmentWGSL:a.fragmentGLSL,e.fragmentIncludes=n,e.fragmentDefines=r}createShaderDefinition(e,t){const s=t.shaderDesc,i=e.isWebGPU&&s.vertexWGSL&&s.fragmentWGSL,a={name:`ShaderMaterial-${s.uniqueName}`,shaderLanguage:i?Ja:Sr,fragmentOutputTypes:s.fragmentOutputTypes,meshUniformBufferFormat:s.meshUniformBufferFormat,meshBindGroupFormat:s.meshBindGroupFormat},n=i?ul:dt,r=new Map(Object.entries({...n,...t.chunks}));return this.createAttributesDefinition(a,t),this.createVertexDefinition(a,t,r,i),this.createFragmentDefinition(a,t,r,i),da.createDefinition(e,a)}}const Y$=new j$;class Yd extends Jc{constructor(e){super(),this.shaderDesc=e}set shaderDesc(e){if(this._shaderDesc=void 0,e&&(this._shaderDesc={uniqueName:e.uniqueName,attributes:e.attributes,fragmentOutputTypes:e.fragmentOutputTypes,vertexGLSL:e.vertexGLSL,fragmentGLSL:e.fragmentGLSL,vertexWGSL:e.vertexWGSL,fragmentWGSL:e.fragmentWGSL},e.vertexCode||e.fragmentCode||e.shaderLanguage)){const t=e.shaderLanguage??Sr;t===Sr?(this._shaderDesc.vertexGLSL=e.vertexCode,this._shaderDesc.fragmentGLSL=e.fragmentCode):t===Ja&&(this._shaderDesc.vertexWGSL=e.vertexCode,this._shaderDesc.fragmentWGSL=e.fragmentCode)}this.clearVariants()}get shaderDesc(){return this._shaderDesc}copy(e){return super.copy(e),this.shaderDesc=e.shaderDesc,this}getShaderVariant(e){const{objDefs:t}=e,s={defines:kC(this,e),skin:(t&ux)!==0,useInstancing:(t&dx)!==0,useMorphPosition:(t&fx)!==0,useMorphNormal:(t&px)!==0,useMorphTextureBasedInt:(t&mx)!==0,pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc,chunks:this.chunks??{}},i=new gx(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),a=Bm(e.device);return a.register("shader-material",Y$),a.getProgram("shader-material",s,i,this.userId)}}const K$={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},Q$={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class mr{static decodeFunc(e){return K$[e]??"decodeGamma"}static encodeFunc(e){return Q$[e]??"encodeGamma"}static getScreenDepthChunk(e,t){return`
						${t.sceneDepthMapLinear?"#define SCENE_DEPTHMAP_LINEAR":""}
						${e.textureFloatRenderable?"#define SCENE_DEPTHMAP_FLOAT":""}
						${dt.screenDepthPS}
				`}}const LP=(h,e)=>{const t=e.length/3,s=h.length/3,i=new H,a=new H,n=new H,r=new H,l=new H,u=new H,f=[];for(let _=0;_<h.length;_++)f[_]=0;for(let _=0;_<t;_++){const g=e[_*3],y=e[_*3+1],v=e[_*3+2];i.set(h[g*3],h[g*3+1],h[g*3+2]),a.set(h[y*3],h[y*3+1],h[y*3+2]),n.set(h[v*3],h[v*3+1],h[v*3+2]),r.sub2(a,i),l.sub2(n,i),u.cross(r,l).normalize(),f[g*3]+=u.x,f[g*3+1]+=u.y,f[g*3+2]+=u.z,f[y*3]+=u.x,f[y*3+1]+=u.y,f[y*3+2]+=u.z,f[v*3]+=u.x,f[v*3+1]+=u.y,f[v*3+2]+=u.z}for(let _=0;_<s;_++){const g=f[_*3],y=f[_*3+1],v=f[_*3+2],x=1/Math.sqrt(g*g+y*y+v*v);f[_*3]*=x,f[_*3+1]*=x,f[_*3+2]*=x}return f},eu=(h,e,t,s)=>{const i=s.length/3,a=h.length/3,n=new H,r=new H,l=new H,u=new Ee,f=new Ee,_=new Ee,g=new H,y=new H,v=new Float32Array(a*3),x=new Float32Array(a*3),C=[];for(let D=0;D<i;D++){const I=s[D*3],U=s[D*3+1],O=s[D*3+2];n.set(h[I*3],h[I*3+1],h[I*3+2]),r.set(h[U*3],h[U*3+1],h[U*3+2]),l.set(h[O*3],h[O*3+1],h[O*3+2]),u.set(t[I*2],t[I*2+1]),f.set(t[U*2],t[U*2+1]),_.set(t[O*2],t[O*2+1]);const N=r.x-n.x,z=l.x-n.x,X=r.y-n.y,Y=l.y-n.y,F=r.z-n.z,q=l.z-n.z,G=f.x-u.x,W=_.x-u.x,k=f.y-u.y,K=_.y-u.y,ee=G*K-W*k;if(ee===0)g.set(0,1,0),y.set(1,0,0);else{const V=1/ee;g.set((K*N-k*z)*V,(K*X-k*Y)*V,(K*F-k*q)*V),y.set((G*z-W*N)*V,(G*Y-W*X)*V,(G*q-W*F)*V)}v[I*3+0]+=g.x,v[I*3+1]+=g.y,v[I*3+2]+=g.z,v[U*3+0]+=g.x,v[U*3+1]+=g.y,v[U*3+2]+=g.z,v[O*3+0]+=g.x,v[O*3+1]+=g.y,v[O*3+2]+=g.z,x[I*3+0]+=y.x,x[I*3+1]+=y.y,x[I*3+2]+=y.z,x[U*3+0]+=y.x,x[U*3+1]+=y.y,x[U*3+2]+=y.z,x[O*3+0]+=y.x,x[O*3+1]+=y.y,x[O*3+2]+=y.z}const M=new H,w=new H,T=new H,R=new H;for(let D=0;D<a;D++){T.set(e[D*3],e[D*3+1],e[D*3+2]),M.set(v[D*3],v[D*3+1],v[D*3+2]),w.set(x[D*3],x[D*3+1],x[D*3+2]);const I=T.dot(M);R.copy(T).mulScalar(I),R.sub2(M,R).normalize(),C[D*4]=R.x,C[D*4+1]=R.y,C[D*4+2]=R.z,R.cross(T,M),C[D*4+3]=R.dot(w)<0?-1:1}return C};class dl{calculateNormals(){this.normals=LP(this.positions,this.indices)}calculateTangents(){this.tangents=eu(this.positions,this.normals,this.uvs,this.indices)}}const o3=4/64,HO=1-o3*2;class Kd extends dl{constructor(e={}){super();const t=e.halfExtents??new H(.5,.5,.5),s=e.widthSegments??1,i=e.lengthSegments??1,a=e.heightSegments??1,n=e.yOffset??0,r=-t.y+n,l=t.y+n,u=[new H(-t.x,r,t.z),new H(t.x,r,t.z),new H(t.x,l,t.z),new H(-t.x,l,t.z),new H(t.x,r,-t.z),new H(-t.x,r,-t.z),new H(-t.x,l,-t.z),new H(t.x,l,-t.z)],f=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],_=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],g={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},y=[],v=[],x=[],C=[];let M=0;const w=(T,R,D)=>{const I=new H,U=new H,O=new H,N=new H;for(let z=0;z<=R;z++)for(let X=0;X<=D;X++){I.lerp(u[f[T][0]],u[f[T][1]],z/R),U.lerp(u[f[T][0]],u[f[T][2]],X/D),O.sub2(U,u[f[T][0]]),N.add2(I,O);let Y=z/R,F=X/D;y.push(N.x,N.y,N.z),v.push(_[T][0],_[T][1],_[T][2]),x.push(Y,1-F),Y=Y*HO+o3,F=F*HO+o3,Y/=3,F/=3,Y+=T%3/3,F+=Math.floor(T/3)/3,z<R&&X<D&&(C.push(M+D+1,M+1,M),C.push(M+D+1,M+D+2,M+1)),M++}};w(g.FRONT,s,a),w(g.BACK,s,a),w(g.TOP,s,i),w(g.BOTTOM,s,i),w(g.RIGHT,i,a),w(g.LEFT,i,a),this.positions=y,this.normals=v,this.uvs=x,this.uvs1=x,this.indices=C,e.calculateTangents&&(this.tangents=eu(y,v,x,C))}}class cy extends dl{constructor(e={}){super();const t=e.radius??.5,s=e.latitudeBands??16,i=e.longitudeBands??16,a=[],n=[],r=[],l=[];for(let u=0;u<=s;u++){const f=u*Math.PI/s,_=Math.sin(f),g=Math.cos(f);for(let y=0;y<=i;y++){const v=y*2*Math.PI/i-Math.PI/2,x=Math.sin(v),M=Math.cos(v)*_,w=g,T=x*_,R=1-y/i,D=1-u/s;a.push(M*t,w*t,T*t),n.push(M,w,T),r.push(R,1-D)}}for(let u=0;u<s;++u)for(let f=0;f<i;++f){const _=u*(i+1)+f,g=_+i+1;l.push(_+1,g,_),l.push(_+1,g+1,g)}this.positions=a,this.normals=n,this.uvs=r,this.uvs1=r,this.indices=l,e.calculateTangents&&(this.tangents=eu(a,n,r,l))}}class HU extends cy{constructor(e={}){const s=e.latitudeBands??16,i=e.longitudeBands??16;super({radius:.5,latitudeBands:s,longitudeBands:i});const a=.1,n=.95,r=n*n,l=this.positions;for(let u=0;u<l.length;u+=3){const f=l[u]/.5;let _=l[u+1]/.5;const g=l[u+2]/.5;_<0&&(_*=.3,f*f+g*g<r&&(_=-.1)),_+=a,_*=.5,l[u+1]=_}}}class _b{static create(e,t){switch(t){case bU:return _b.box(e);case xU:return _b.dome(e)}return _b.infinite(e)}static infinite(e){return Ft.fromGeometry(e,new Kd(e))}static box(e){return Ft.fromGeometry(e,new Kd({yOffset:.5}))}static dome(e){const t=new HU({latitudeBands:50,longitudeBands:50});return t.normals=void 0,t.uvs=void 0,Ft.fromGeometry(e,t)}}class $${constructor(e,t,s,i,a){this.meshInstance=null;const n=new Yd({uniqueName:"SkyMaterial",vertexGLSL:dt.skyboxVS,fragmentGLSL:dt.skyboxPS,vertexWGSL:ul.skyboxVS,fragmentWGSL:ul.skyboxPS,attributes:{aPosition:kt}});n.setDefine("{SKYBOX_DECODE_FNC}",mr.decodeFunc(i.encoding)),a!==pb&&n.setDefine("SKYMESH",""),i.cubemap&&n.setDefine("SKY_CUBEMAP",""),n.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),i.cubemap?n.setParameter("texture_cubeMap",i):(n.setParameter("texture_envAtlas",i),n.setParameter("mipLevel",t.skyboxMip)),n.cull=e0,n.depthWrite=!1;const r=t.layers.getLayerById(dm);if(r){const l=_b.create(e,a),u=new ps(l,n,s);this.meshInstance=u,u.cull=!1,u.pick=!1,r.addMeshInstances([u]),this.skyLayer=r}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}}class WU{constructor(e){this._type=pb,this._center=new H(0,1,0),this.skyMesh=null,this.node=new Jt("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new H(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}applySettings(e){this.type=e.skyType??pb,this.node.setLocalPosition(new H(e.skyMeshPosition??[0,0,0])),this.node.setLocalEulerAngles(new H(e.skyMeshRotation??[0,0,0])),this.node.setLocalScale(new H(e.skyMeshScale??[1,1,1])),e.skyCenter&&(this._center=new H(e.skyCenter))}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(e){this._center.copy(e)}get center(){return this._center}updateSkyMesh(){const e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new $$(this.device,this.scene,this.node,e,this.type),this.scene.fire("set:skybox",e))}resetSkyMesh(){var e;(e=this.skyMesh)==null||e.destroy(),this.skyMesh=null}update(){if(this.type!==pb){const{center:e,centerArray:t}=this,s=new H;this.node.getWorldTransform().transformPoint(e,s),t[0]=s.x,t[1]=s.y,t[2]=s.z,this.projectedSkydomeCenterId.setValue(t)}}}const zA=new Jt;zA.worldTransform=Me.IDENTITY;zA._dirtyWorld=zA._dirtyNormal=!1;class Z${constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Ft(e),this.meshInstance=null}addLines(e,t){const s=this.positions,i=e.length;for(let n=0;n<i;n++){const r=e[n];s.push(r.x,r.y,r.z)}const a=this.colors;if(t.length)for(let n=0;n<i;n++){const r=t[n];a.push(r.r,r.g,r.b,r.a)}else for(let n=0;n<i;n++)a.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){const s=this.positions;for(let a=0;a<e.length;a+=3)s.push(e[a],e[a+1],e[a+2]);const i=this.colors;if(t.length)for(let a=0;a<t.length;a+=4)i.push(t[a],t[a+1],t[a+2],t[a+3]);else{const a=e.length/3;for(let n=0;n<a;n++)i.push(t.r,t.g,t.b,t.a)}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(X1,!1),this.meshInstance||(this.meshInstance=new ps(this.mesh,this.material,zA)),e.push(this.meshInstance))}clear(){this.positions.length=0,this.colors.length=0}}class J${constructor(e){this.device=e,this.map=new Map}getBatch(e,t){let s=this.map.get(e);return s||(s=new Z$(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach(s=>{s.onPreRender(e,t)})}clear(){this.map.forEach(e=>e.clear())}}const $r=[],fg=new H,eZ={uniqueName:"ImmediateLine",vertexGLSL:dt.immediateLineVS,fragmentGLSL:dt.immediateLinePS,vertexWGSL:ul.immediateLineVS,fragmentWGSL:ul.immediateLinePS,attributes:{vertex_position:kt,vertex_color:Qi}};class tZ{constructor(e){this.shaderDescs=new Map,this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(e){const t=new Yd(eZ);return t.blendType=xr,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){let s=this.batchesMap.get(e);s||(s=new J$(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);const i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}getShaderDesc(e,t){return this.shaderDescs.has(e)||this.shaderDescs.set(e,{uniqueName:`DebugShader:${e}`,vertexGLSL:`
				attribute vec2 vertex_position;
				uniform mat4 matrix_model;
				varying vec2 uv0;
				void main(void) {
					gl_Position = matrix_model * vec4(vertex_position, 0, 1);
					uv0 = vertex_position.xy + 0.5;
				}
			`,fragmentGLSL:t,attributes:{vertex_position:kt}}),this.shaderDescs.get(e)}getTextureShaderDesc(e){const t=mr.decodeFunc(e);return this.getShaderDesc(`textureShader-${e}`,`
			#include "gammaPS"
			varying vec2 uv0;
			uniform sampler2D colorMap;
			void main (void) {
				vec3 linearColor = ${t}(texture2D(colorMap, uv0));
				gl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);
			}
		`)}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable",`
			varying vec2 uv0;
			uniform highp sampler2D colorMap;
			void main (void) {
				ivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));
				gl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);
			}
		`)}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader",`
			${dt.screenDepthPS}
			#include "gammaPS"
			varying vec2 uv0;
			void main() {
				float depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;
				gl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);
			}
		`)}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Ft(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(hl)),this.quadMesh}drawMesh(e,t,s,i,a){if(!i){const r=this.getGraphNode(t);i=new ps(s,e,r)}let n=this.layerMeshInstances.get(a);n||(n=[],this.layerMeshInstances.set(a,n)),n.push(i)}drawWireAlignedBox(e,t,s,i,a,n){if(n){const l=(u,f,_)=>{fg.set(u,f,_),n.transformPoint(fg,fg),$r.push(fg.x,fg.y,fg.z)};l(e.x,e.y,e.z),l(e.x,t.y,e.z),l(e.x,t.y,e.z),l(t.x,t.y,e.z),l(t.x,t.y,e.z),l(t.x,e.y,e.z),l(t.x,e.y,e.z),l(e.x,e.y,e.z),l(e.x,e.y,t.z),l(e.x,t.y,t.z),l(e.x,t.y,t.z),l(t.x,t.y,t.z),l(t.x,t.y,t.z),l(t.x,e.y,t.z),l(t.x,e.y,t.z),l(e.x,e.y,t.z),l(e.x,e.y,e.z),l(e.x,e.y,t.z),l(e.x,t.y,e.z),l(e.x,t.y,t.z),l(t.x,t.y,e.z),l(t.x,t.y,t.z),l(t.x,e.y,e.z),l(t.x,e.y,t.z)}else $r.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(a,i).addLinesArrays($r,s),$r.length=0}drawWireSphere(e,t,s,i,a,n){const r=2*Math.PI/i;let l=0;for(let f=0;f<i;f++){const _=Math.sin(l),g=Math.cos(l);l+=r;const y=Math.sin(l),v=Math.cos(l);$r.push(e.x+t*_,e.y,e.z+t*g),$r.push(e.x+t*y,e.y,e.z+t*v),$r.push(e.x+t*_,e.y+t*g,e.z),$r.push(e.x+t*y,e.y+t*v,e.z),$r.push(e.x,e.y+t*_,e.z+t*g),$r.push(e.x,e.y+t*y,e.z+t*v)}this.getBatch(n,a).addLinesArrays($r,s),$r.length=0}getGraphNode(e){const t=new Jt("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach((i,a)=>{a===e&&i.onPreRender(t,s)}),!this.updatedLayers.has(e)){this.updatedLayers.add(e);const i=this.layerMeshInstances.get(e);if(i){for(let a=0;a<i.length;a++)t.push(i[a]);i.length=0}}}onPostRender(){this.allBatches.forEach(e=>e.clear()),this.allBatches.clear(),this.updatedLayers.clear()}}const WO=2.399963229728653,vx={circlePoint(h){const e=Math.sqrt(Math.random()),t=Math.random()*2*Math.PI;h.x=e*Math.cos(t),h.y=e*Math.sin(t)},circlePointDeterministic(h,e,t){const s=e*WO,i=Math.sqrt(e)/Math.sqrt(t);h.x=i*Math.cos(s),h.y=i*Math.sin(s)},spherePointDeterministic(h,e,t,s=0,i=1){s=1-2*s,i=1-2*i;const a=ge.lerp(s,i,e/t),n=Math.sqrt(1-a*a),r=WO*e;h.x=Math.cos(r)*n,h.y=a,h.z=Math.sin(r)*n},radicalInverse(h){let e=(h<<16|h>>>16)>>>0;return e=((e&1431655765)<<1|(e&2863311530)>>>1)>>>0,e=((e&858993459)<<2|(e&3435973836)>>>2)>>>0,e=((e&252645135)<<4|(e&4042322160)>>>4)>>>0,e=((e&16711935)<<8|(e&4278255360)>>>8)>>>0,e*23283064365386963e-26}},qO=h=>{switch(h){case PA:return"Cubemap";case zF:return"Octahedral";default:return"Equirect"}},CE=(h,e,t)=>{if(h<=0)e[t+0]=0,e[t+1]=0,e[t+2]=0,e[t+3]=0;else if(h>=1)e[t+0]=255,e[t+1]=0,e[t+2]=0,e[t+3]=0;else{let s=1*h%1,i=255*h%1,a=65025*h%1;const n=16581375*h%1;s-=i/255,i-=a/255,a-=n/255,e[t+0]=Math.min(255,Math.floor(s*256)),e[t+1]=Math.min(255,Math.floor(i*256)),e[t+2]=Math.min(255,Math.floor(a*256)),e[t+3]=Math.min(255,Math.floor(n*256))}},sZ=h=>{const e=h.length,t=Math.min(e,512),s=Math.ceil(e/t),i=new Uint8Array(t*s*4);let a=0;for(let n=0;n<e;n+=4)CE(h[n+0]*.5+.5,i,a+0),CE(h[n+1]*.5+.5,i,a+4),CE(h[n+2]*.5+.5,i,a+8),CE(h[n+3]/8,i,a+12),a+=16;return{width:t,height:s,data:i}},iZ=(h,e,t,s)=>{const i=t*2*Math.PI,a=Math.pow(1-e,1/(s+1)),n=Math.sqrt(1-a*a);h.set(Math.cos(i)*n,Math.sin(i)*n,a).normalize()},aZ=(h,e,t)=>{const s=t*2*Math.PI,i=Math.sqrt(1-e),a=Math.sqrt(e);h.set(Math.cos(s)*a,Math.sin(s)*a,i).normalize()},nZ=(h,e,t,s)=>{const i=t*2*Math.PI,a=Math.sqrt((1-e)/(1+(s*s-1)*e)),n=Math.sqrt(1-a*a);h.set(Math.cos(i)*n,Math.sin(i)*n,a).normalize()},rZ=(h,e)=>{const t=h*e,s=e/(1-h*h+t*t);return s*s*(1/Math.PI)},oZ=(h,e)=>{const t=new H,s=[];for(let i=0;i<h;++i)iZ(t,i/h,vx.radicalInverse(i),e),s.push(t.x,t.y,t.z,0);return s},lZ=(h,e)=>{const t=e/h,s=new H,i=[];for(let a=0;a<h;++a){aZ(s,a/h,vx.radicalInverse(a));const n=s.z/Math.PI,r=.5*Math.log2(t/n);i.push(s.x,s.y,s.z,r)}return i},hZ={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},cZ=(h,e)=>{const t=hZ[h];return t&&t[e]||h},uZ=(h,e,t)=>{const s=t/h,i=1-Math.log2(e)/11,a=i*i,n=new H,r=new H,l=new H(0,0,1),u=[],f=cZ(h,e);for(let _=0;_<f;++_){nZ(n,_/f,vx.radicalInverse(_),a);const g=n.z;if(r.set(n.x,n.y,n.z).mulScalar(2*g).sub(l),r.z>0){const y=rZ(Math.min(1,g),a)/4+.001,v=.5*Math.log2(s/y);u.push(r.x,r.y,r.z,v)}}for(;u.length<h*4;)u.push(0,0,0,0);return u},dZ=(h,e,t)=>{const s=sZ(t);return new Ge(h,{name:e,width:s.width,height:s.height,mipmaps:!1,minFilter:Je,magFilter:Je,levels:[s.data]})};class qU{constructor(e=!0){this.map=new Map,this.destroyContent=e}destroy(){this.destroyContent&&this.map.forEach((e,t)=>{e.destroy()})}get(e,t){if(!this.map.has(e)){const s=t();return this.map.set(e,s),s}return this.map.get(e)}}const fZ=new qU(!1),pZ=new Xn,IP=(h,e,t)=>pZ.get(h,()=>new qU).get(e,()=>dZ(h,e,fZ.get(e,t))),mZ=(h,e,t)=>{const s=`lambert-samples-${e}-${t}`;return IP(h,s,()=>lZ(e,t))},_Z=(h,e,t)=>{const s=`phong-samples-${e}-${t}`;return IP(h,s,()=>oZ(e,t))},gZ=(h,e,t,s)=>{const i=`ggx-samples-${e}-${t}-${s}`;return IP(h,i,()=>uZ(e,t,s))};function oh(h,e,t={}){var O,N;const s=t.seamPixels??0,i=(((O=t.rect)==null?void 0:O.z)??e.width)-s*2,a=(((N=t.rect)==null?void 0:N.w)??e.height)-s*2;if(i<1||a<1)return!1;const n={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},r=t.hasOwnProperty("specularPower")?t.specularPower:1,l=t.hasOwnProperty("face")?t.face:null,u=t.hasOwnProperty("distribution")?t.distribution:r===1?"none":"phong",f=n[u]||"reproject",_=f.startsWith("prefilterSamples"),g=mr.decodeFunc(h.encoding),y=mr.encodeFunc(e.encoding),v=`sample${qO(h.projection)}`,x=`getDirection${qO(e.projection)}`,C=t.hasOwnProperty("numSamples")?t.numSamples:1024,M=`${f}_${g}_${y}_${v}_${x}_${C}`,w=h.device;let T=Bm(w).getCachedShader(M);if(!T){const z=`
						${_?"#define USE_SAMPLES_TEX":""}
						${h.cubemap?"#define CUBEMAP_SOURCE":""}
						#define {PROCESS_FUNC} ${f}
						#define {DECODE_FUNC} ${g}
						#define {ENCODE_FUNC} ${y}
						#define {SOURCE_FUNC} ${v}
						#define {TARGET_FUNC} ${x}
						#define {NUM_SAMPLES} ${C}
						#define {NUM_SAMPLES_SQRT} ${Math.round(Math.sqrt(C)).toFixed(1)}
				`,X=w.isWebGPU,Y=X?ul:dt,F=new Map;F.set("decodePS",Y.decodePS),F.set("encodePS",Y.encodePS);const q=Y.reprojectVS,G=Y.reprojectPS;T=Da(w,q,`
								${z}
								${G}
						`,M,{vertex_position:kt},{fragmentIncludes:F,shaderLanguage:X?Ja:Sr})}w.setBlendState(ms.NOBLEND),w.scope.resolve(h.cubemap?"sourceCube":"sourceTex").setValue(h);const D=w.scope.resolve("params"),I=w.scope.resolve("uvMod");s>0?I.setValue([(i+s*2)/i,(a+s*2)/a,-s/i,-s/a]):I.setValue([1,1,0,0]);const U=[0,e.width*e.height*(e.cubemap?6:1),h.width*h.height*(h.cubemap?6:1)];if(_){const z=h.width*h.height*(h.cubemap?6:1),X=u==="ggx"?gZ(w,C,r,z):u==="lambert"?mZ(w,C,z):_Z(w,C,r);w.scope.resolve("samplesTex").setValue(X),w.scope.resolve("samplesTexInverseSize").setValue([1/X.width,1/X.height])}for(let z=0;z<(e.cubemap?6:1);z++)if(l===null||z===l){const X=new fs({colorBuffer:e,face:z,depth:!1,flipY:w.isWebGPU});U[0]=z,D.setValue(U),qn(w,X,T,t==null?void 0:t.rect),X.destroy()}return!0}const NR=(h,e=0)=>1+Math.floor(Math.log2(Math.max(h,e))),yZ=h=>h.textureHalfFloatRenderable,vZ=h=>h.textureFloatRenderable,SZ=h=>yZ(h)?Js:vZ(h)?Ri:Lt,bZ=h=>Lt,xZ=(h,e,t,s)=>new Ge(h,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:t,type:v0,addressU:Oe,addressV:Oe,mipmaps:!1});class n0{static generateSkyboxCubemap(e,t){const s=e.device,i=xZ(s,t||(e.cubemap?e.width:e.width/4),Lt);return oh(e,i,{numSamples:1024}),i}static generateLightingSource(e,t){const s=e.device,i=SZ(s),a=(t==null?void 0:t.target)||new Ge(s,{name:"lighting-source",cubemap:!0,width:(t==null?void 0:t.size)||128,height:(t==null?void 0:t.size)||128,format:i,type:i===Lt?v0:vr,addressU:Oe,addressV:Oe,mipmaps:!0});return oh(e,a,{numSamples:e.mipmaps?1:1024}),a}static generateAtlas(e,t){const s=e.device,i=bZ(),a=(t==null?void 0:t.target)||new Ge(s,{name:"envAtlas",width:(t==null?void 0:t.size)||512,height:(t==null?void 0:t.size)||512,format:i,type:v0,projection:HM,addressU:Oe,addressV:Oe,mipmaps:!1}),n=a.width/512,r=new Ie(0,0,512*n,256*n),l=NR(256)-NR(4);for(let u=0;u<l;++u)oh(e,a,{numSamples:1,rect:r,seamPixels:n}),r.x+=r.w,r.y+=r.w,r.z=Math.max(1,Math.floor(r.z*.5)),r.w=Math.max(1,Math.floor(r.w*.5));r.set(0,256*n,256*n,128*n);for(let u=1;u<7;++u)oh(e,a,{numSamples:(t==null?void 0:t.numReflectionSamples)||1024,distribution:(t==null?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>u*2),rect:r,seamPixels:n}),r.y+=r.w,r.z=Math.max(1,Math.floor(r.z*.5)),r.w=Math.max(1,Math.floor(r.w*.5));return r.set(128*n,384*n,64*n,32*n),oh(e,a,{numSamples:(t==null?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:r,seamPixels:n}),a}static generatePrefilteredAtlas(e,t){const s=e[0].device,i=e[0].format,a=e[0].type,n=(t==null?void 0:t.target)||new Ge(s,{name:"envPrefilteredAtlas",width:(t==null?void 0:t.size)||512,height:(t==null?void 0:t.size)||512,format:i,type:a,projection:HM,addressU:Oe,addressV:Oe,mipmaps:!1}),r=n.width/512,l=new Ie(0,0,512*r,256*r),u=NR(512);for(let f=0;f<u;++f)oh(e[0],n,{numSamples:1,rect:l,seamPixels:r}),l.x+=l.w,l.y+=l.w,l.z=Math.max(1,Math.floor(l.z*.5)),l.w=Math.max(1,Math.floor(l.w*.5));l.set(0,256*r,256*r,128*r);for(let f=1;f<e.length;++f)oh(e[f],n,{numSamples:1,rect:l,seamPixels:r}),l.y+=l.w,l.z=Math.max(1,Math.floor(l.z*.5)),l.w=Math.max(1,Math.floor(l.w*.5));return l.set(128*r,384*r,64*r,32*r),t!=null&&t.legacyAmbient?oh(e[5],n,{numSamples:1,rect:l,seamPixels:r}):oh(e[0],n,{numSamples:(t==null?void 0:t.numSamples)||2048,distribution:"lambert",rect:l,seamPixels:r}),n}}class XU{constructor(){this.type=Fm,this.color=new xe(0,0,0),this.density=0,this.start=1,this.end=1e3}}const ch=class ch extends Qe{constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new xe(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=fb,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new XU,this.forcePassThroughSpecular=!1,this.device=e,this._gravity=new H(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new Ne,this._skyboxRotationMat3=new ol,this._skyboxRotationMat4=new Me,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new PP(this.device.supportsAreaLights,this.device.maxTextureSize,()=>{this.updateShaders=!0}),this._sky=new WU(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new tZ(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(hx)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=ge.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=ge.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){if(!(this.device.isWebGPU&&!e)){if(!this._clusteredLightingEnabled&&e){console.error("Turning on disabled clustered lighting is not currently supported");return}this._clusteredLightingEnabled=e}}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=Oe,e.addressV=Oe,e.minFilter=Vt,e.magFilter=Vt,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set layers(e){const t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get fog(){return this._fogParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];const t=this._prefilteredCubemaps;(t.length!==e.length||t.some((i,a)=>i!==e[a]))&&(e.length===6&&e.every(a=>!!a)?(this._internalEnvAtlas=n0.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh())}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh())}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){const t=e.equals(Ne.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(H.ZERO,e,H.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),!this._skyboxRotationShaderInclude&&!t&&(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(e,t,s=xe.WHITE,i=!0,a=this.defaultDrawLayer){this.immediate.getBatch(a,i).addLines([e,t],[s,s])}drawLines(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(e,t)}drawLineArrays(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(e,t)}applySettings(e){const t=e.physics,s=e.render;this._gravity.set(t.gravity[0],t.gravity[1],t.gravity[2]),this.ambientLight.set(s.global_ambient[0],s.global_ambient[1],s.global_ambient[2]),this.ambientLuminance=s.ambientLuminance,this.fog.type=s.fog,this.fog.color.set(s.fog_color[0],s.fog_color[1],s.fog_color[2]),this.fog.start=s.fog_start,this.fog.end=s.fog_end,this.fog.density=s.fog_density,this.lightmapSizeMultiplier=s.lightmapSizeMultiplier,this.lightmapMaxResolution=s.lightmapMaxResolution,this.lightmapMode=s.lightmapMode,this.exposure=s.exposure,this._skyboxIntensity=s.skyboxIntensity??1,this._skyboxLuminance=s.skyboxLuminance??2e4,this._skyboxMip=s.skyboxMip??0,s.skyboxRotation&&(this.skyboxRotation=new Ne().setFromEulerAngles(s.skyboxRotation[0],s.skyboxRotation[1],s.skyboxRotation[2])),this.sky.applySettings(s),this.clusteredLightingEnabled=s.clusteredLightingEnabled??!1,this.lighting.applySettings(s),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(i=>{s.hasOwnProperty(i)&&(this[i]=s[i])}),this._resetSkyMesh()}_getSkyboxTex(){const e=this._prefilteredCubemaps;return this._skyboxMip?e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap:this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||Lt}};ch.EVENT_SETLAYERS="set:layers",ch.EVENT_SETSKYBOX="set:skybox",ch.EVENT_PRERENDER="prerender",ch.EVENT_POSTRENDER="postrender",ch.EVENT_PRERENDER_LAYER="prerender:layer",ch.EVENT_POSTRENDER_LAYER="postrender:layer",ch.EVENT_PRECULL="precull",ch.EVENT_POSTCULL="postcull";let vn=ch;class OP{constructor(e,t,s){this.device=e,this.inverseBindPose=t,this.boneNames=s}}const TZ=[0,0,1,0,0,1,0,0,1,0,0,1],EZ=[0,1,3,2,3,1];let jU=class extends Qe{constructor(e,t){super(),this._device=e,this._pixelsPerUnit=t&&t.pixelsPerUnit!==void 0?t.pixelsPerUnit:1,this._renderMode=t&&t.renderMode!==void 0?t.renderMode:tl,this._atlas=t&&t.atlas!==void 0?t.atlas:null,this._frameKeys=t&&t.frameKeys!==void 0?t.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}set frameKeys(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}get frameKeys(){return this._frameKeys}set atlas(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}get atlas(){return this._atlas}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&this.renderMode===tl&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(e){if(this._renderMode===e)return;const t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(t===tl||e===tl)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){const e=this._meshes.length;for(let i=0;i<e;i++){const a=this._meshes[i];a&&a.destroy()}const t=this._frameKeys.length;this._meshes=new Array(t);const s=this.renderMode===Bi||this._renderMode===Ui?this._create9SliceMesh:this._createSimpleMesh;for(let i=0;i<t;i++){const a=this._atlas.frames[this._frameKeys[i]];this._meshes[i]=a?s.call(this,a):null}this.fire("set:meshes")}_createSimpleMesh(e){const t=e.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,a=t.z/this._pixelsPerUnit,n=t.w/this._pixelsPerUnit,r=e.pivot.x,l=e.pivot.y,u=[-r*a,-l*n,0,(1-r)*a,-l*n,0,(1-r)*a,(1-l)*n,0,-r*a,(1-l)*n,0],f=t.x/s,_=1-t.y/i,g=(t.x+t.z)/s,y=1-(t.y+t.w)/i,v=[f,_,g,_,g,y,f,y],x=new dl;return x.positions=u,x.normals=TZ,x.uvs=v,x.indices=EZ,Ft.fromGeometry(this._device,x)}_create9SliceMesh(){const e=Ee.ONE,t=3,s=3,i=[],a=[],n=[],r=[];let l=0;for(let f=0;f<=t;f++){const _=f===0||f===t?0:1;for(let g=0;g<=s;g++){const y=-e.x+2*e.x*(f<=1?0:3)/t,v=0,x=-(-e.y+2*e.y*(g<=1?0:3)/s),C=g===0||g===s?0:1;i.push(-y,v,x),a.push(0,1,0),n.push(_,C),f<t&&g<s&&(r.push(l+s+1,l+1,l),r.push(l+s+1,l+s+2,l+1)),l++}}const u=new dl;return u.positions=i,u.normals=a,u.uvs=n,u.indices=r,Ft.fromGeometry(this._device,u)}_onSetFrames(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(e,t){const s=this._frameKeys.indexOf(e);s<0||(t?this.renderMode===tl&&(this._meshes[s]=this._createSimpleMesh(t)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(e){const t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(const e of this._meshes)e&&e.destroy();this._meshes.length=0}};class YU extends Qe{constructor(){super(),this._texture=null,this._frames=null}set texture(e){this._texture=e,this.fire("set:texture",e)}get texture(){return this._texture}set frames(e){this._frames=e,this.fire("set:frames",e)}get frames(){return this._frames}setFrame(e,t){let s=this._frames[e];s?(s.rect.copy(t.rect),s.pivot.copy(t.pivot),s.border.copy(t.border)):(s={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=s),this.fire("set:frame",e.toString(),s)}removeFrame(e){const t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t))}destroy(){this._texture&&this._texture.destroy()}}class l3{constructor(e,t,s,i){this.time=e,this.position=t,this.rotation=s,this.scale=i}}let h3=class{constructor(){this._name="",this._keys=[]}},c3=class{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(e){return this._nodeDict[e]}addNode(e){this._nodes.push(e),this._nodeDict[e._name]=e}get nodes(){return this._nodes}};class AZ{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new Ne,this._pos=new H,this._scale=new H,this._targetNode=null}getTarget(){return this._targetNode}setTarget(e){this._targetNode=e}}class gA{constructor(e){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const t=s=>{const i=new AZ;i._name=s.name,this._interpolatedKeys.push(i),this._interpolatedKeyDict[s.name]=i,this._currKeyIndices[s.name]=0;for(let a=0;a<s._children.length;a++)t(s._children[a])};t(e)}set animation(e){this._animation=e,this.currentTime=0}get animation(){return this._animation}set currentTime(e){this._time=e;const t=this._interpolatedKeys.length;for(let s=0;s<t;s++){const a=this._interpolatedKeys[s]._name;this._currKeyIndices[a]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(e){if(this._animation!==null){const t=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=e,this._time>s){this._time=this.looping?0:s;for(let a=0;a<t.length;a++){const r=t[a]._name;this._currKeyIndices[r]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let a=0;a<t.length;a++){const n=t[a],r=n._name;this._currKeyIndices[r]=n._keys.length-2}}const i=e>=0?1:-1;for(let a=0;a<t.length;a++){const n=t[a],r=n._name,l=n._keys,u=this._interpolatedKeyDict[r];if(u===void 0)continue;let f=!1;if(l.length!==1)for(let _=this._currKeyIndices[r];_<l.length-1&&_>=0;_+=i){const g=l[_],y=l[_+1];if(g.time<=this._time&&y.time>=this._time){const v=(this._time-g.time)/(y.time-g.time);u._pos.lerp(g.position,y.position,v),u._quat.slerp(g.rotation,y.rotation,v),u._scale.lerp(g.scale,y.scale,v),u._written=!0,this._currKeyIndices[r]=_,f=!0;break}}(l.length===1||!f&&this._time===0&&this.looping)&&(u._pos.copy(l[0].position),u._quat.copy(l[0].rotation),u._scale.copy(l[0].scale),u._written=!0)}}}blend(e,t,s){const i=this._interpolatedKeys.length;for(let a=0;a<i;a++){const n=e._interpolatedKeys[a],r=t._interpolatedKeys[a],l=this._interpolatedKeys[a];n._written&&r._written?(l._quat.slerp(n._quat,t._interpolatedKeys[a]._quat,s),l._pos.lerp(n._pos,t._interpolatedKeys[a]._pos,s),l._scale.lerp(n._scale,r._scale,s),l._written=!0):n._written?(l._quat.copy(n._quat),l._pos.copy(n._pos),l._scale.copy(n._scale),l._written=!0):r._written&&(l._quat.copy(r._quat),l._pos.copy(r._pos),l._scale.copy(r._scale),l._written=!0)}}setGraph(e){if(this.graph=e,e)for(let t=0;t<this._interpolatedKeys.length;t++){const s=this._interpolatedKeys[t],i=e.findByName(s._name);this._interpolatedKeys[t].setTarget(i)}else for(let t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)}updateGraph(){if(this.graph)for(let e=0;e<this._interpolatedKeys.length;e++){const t=this._interpolatedKeys[e];if(t._written){const s=t.getTarget();s.localPosition.copy(t._pos),s.localRotation.copy(t._quat),s.localScale.copy(t._scale),s._dirtyLocal||s._dirtifyLocal(),t._written=!1}}}}const CZ=new Ie,IL=class IL{constructor(e){this.device=e,this.needsDepthBuffer=!1}render(e,t,s){}drawQuad(e,t,s){let i;if(s){const a=e?e.width:this.device.width,n=e?e.height:this.device.height;i=CZ.set(s.x*a,s.y*n,s.z*a,s.w*n)}this.device.setBlendState(ms.NOBLEND),qn(this.device,e,t,i)}};IL.quadVertexShader=`
				attribute vec2 aPosition;
				varying vec2 vUv0;
				void main(void)
				{
						gl_Position = vec4(aPosition, 0.0, 1.0);
						vUv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
				}
		`;let u3=IL;const L2=class L2 extends pa{set shader(e){var t;(t=this.quadRender)==null||t.destroy(),this.quadRender=null,this._shader=e,e&&(this.quadRender=new C0(e))}get shader(){return this._shader}createQuadShader(e,t,s={}){return Da(this.device,L2.quadVertexShader,t,e,{aPosition:kt},s)}execute(){const e=this.device;e.setBlendState(this.blendState),e.setCullMode(this.cullMode),e.setDepthState(this.depthState),e.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render()}constructor(...e){super(...e),this._shader=null,this.quadRender=null,this.cullMode=Xs,this.blendState=ms.NOBLEND,this.depthState=$i.NODEPTH,this.stencilFront=null,this.stencilBack=null}};L2.quadVertexShader=`
				attribute vec2 aPosition;
				varying vec2 uv0;
				void main(void)
				{
						gl_Position = vec4(aPosition, 0.0, 1.0);
						uv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
				}
		`;let fl=L2;class Sx{constructor(){this.hasTangents=!1,this.chunks={},this.pass=0,this.alphaTest=!1,this.blendType=Gn,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.batch=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBasedInt=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.customFragmentShader=null,this.pixelSnap=!1,this.ambientSH=!1,this.ssao=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=br,this.opacityShadowDither=br,this.cubeMapProjection=0,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.dispersion=!1,this.fog=Fm,this.gamma=Ch,this.toneMap=-1,this.reflectionSource=Hc,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=!1,this.shadowCatcher=!1}}class wZ{constructor(){this.litOptions=new Sx}}class to{static update(e,t,s,i,a,n,r){to.updateSharedOptions(e,t,s,a,n),to.updateMaterialOptions(e,t),to.updateEnvOptions(e,t,s,i),to.updateLightingOptions(e,t,a,r)}static updateSharedOptions(e,t,s,i,a){e.chunks=t.chunks,e.pass=a,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&(i&FC)!==0,e.skin=i&&(i&ux)!==0,e.useInstancing=i&&(i&dx)!==0,e.useMorphPosition=i&&(i&fx)!==0,e.useMorphNormal=i&&(i&px)!==0,e.useMorphTextureBasedInt=i&&(i&mx)!==0,e.hasTangents=i&&(i&BC)!==0,e.nineSlicedMode=t.nineSlicedMode||tl,t.useLighting&&s.clusteredLightingEnabled?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,e.clusteredLightingShadowType=s.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(e,t){e.separateAmbient=!1,e.customFragmentShader=null,e.pixelSnap=t.pixelSnap,e.ambientSH=t.ambientSH,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=t.occludeSpecularIntensity!==1,e.useMsdf=!1,e.msdfTextAttribute=!1,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.cubeMapProjection=DC,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.dispersion=t.dispersion>0,e.vertexColors=!1,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap}static updateEnvOptions(e,t,s,i){e.fog=t.useFog?i.fog:Fm,e.gamma=i.shaderOutputGamma,e.toneMap=t.useTonemap?i.toneMapping:iy,t.useSkybox&&s.envAtlas&&s.skybox?(e.reflectionSource=i1,e.reflectionEncoding=s.envAtlas.encoding,e.reflectionCubemapEncoding=s.skybox.encoding):t.useSkybox&&s.envAtlas?(e.reflectionSource=s1,e.reflectionEncoding=s.envAtlas.encoding):t.useSkybox&&s.skybox?(e.reflectionSource=a1,e.reflectionEncoding=s.skybox.encoding):(e.reflectionSource=Hc,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource=LC,e.ambientEncoding=null):e.reflectionSource!==Hc&&s.envAtlas?(e.ambientSource=IC,e.ambientEncoding=s.envAtlas.encoding):(e.ambientSource=OC,e.ambientEncoding=null);const a=e.reflectionSource!==Hc;e.skyboxIntensity=a,e.useCubeMapRotation=a&&s._skyboxRotationShaderInclude}static updateLightingOptions(e,t,s,i){if(e.lightMapWithoutAmbient=!1,t.useLighting){const a=[],n=s?s>>16:uo;e.lightMaskDynamic=!!(n&uo),e.lightMapWithoutAmbient=!1,i&&(to.collectLights(ft,i[ft],a,n),to.collectLights(Ds,i[Ds],a,n),to.collectLights(Ns,i[Ns],a,n)),e.lights=a}else e.lights=[];(e.lights.length===0||(s&NC)!==0)&&(e.noShadow=!0)}static collectLights(e,t,s,i){for(let a=0;a<t.length;a++){const n=t[a];n.enabled&&n.mask&i&&s.push(n)}}}const FR={vertex_normal:$a,vertex_tangent:po,vertex_texCoord0:Za,vertex_texCoord1:Mh,vertex_color:Qi,vertex_boneWeights:co,vertex_boneIndices:gn},RZ=new Map([["vec4","vec4f"],["vec3","vec3f"],["vec2","vec2f"],["float","f32"]]);class KU{constructor(e,t,s){if(this.varyingsCode="",this.device=e,this.options=t,this.shaderLanguage=s,this.attributes={vertex_position:kt},t.userAttributes)for(const[a,n]of Object.entries(t.userAttributes))this.attributes[n]=a;const i=s===Sr?dt:ul;if(t.chunks){const a=t.chunks;this.chunks=Object.create(i);for(const n in i)if(a.hasOwnProperty(n)){const r=a[n];for(const l in FR)FR.hasOwnProperty(l)&&r.indexOf(l)>=0&&(this.attributes[l]=FR[l]);this.chunks[n]=r}}else this.chunks=i;this.shaderPassInfo=cl.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=t.reflectionSource!==Hc,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.vshader=null,this.vDefines=new Map,this.fDefines=new Map,this.fshader=null}fDefineSet(e,t,s=""){e&&this.fDefines.set(t,s)}generateVertexShader(e,t,s){const{options:i,vDefines:a,attributes:n}=this,r=new Map;r.set("vPositionW","vec3"),(i.nineSlicedMode===Bi||i.nineSlicedMode===Ui)&&a.set("NINESLICED",!0),this.options.linearDepth&&(a.set("LINEAR_DEPTH",!0),r.set("vLinearDepth","float")),this.needsNormal&&a.set("NORMALS",!0),this.options.useInstancing&&this.chunks.transformInstancingVS===dt.transformInstancingVS&&(n.instance_line1=lC,n.instance_line2=K0,n.instance_line3=hC,n.instance_line4=tm),this.needsNormal&&(n.vertex_normal=$a,r.set("vNormalW","vec3"),i.hasTangents&&(i.useHeights||i.useNormals||i.useClearCoatNormals||i.enableGGXSpecular)?(a.set("TANGENTS",!0),n.vertex_tangent=po,r.set("vTangentW","vec3"),r.set("vBinormalW","vec3")):i.enableGGXSpecular&&(a.set("GGX_SPECULAR",!0),r.set("vObjectSpaceUpW","vec3")));const l=2;for(let _=0;_<l;_++)e[_]&&(a.set(`UV${_}`,!0),n[`vertex_texCoord${_}`]=`TEXCOORD${_}`),t[_]&&(a.set(`UV${_}_UNMODIFIED`,!0),r.set(`vUv${_}`,"vec2"));let u=0;const f=new Set;s.forEach(_=>{const{id:g,uv:y,name:v}=_,x=g+y*100;if(!f.has(x)){f.add(x),r.set(`vUV${y}_${g}`,"vec2");const C=`texture_${v}MapTransform`;a.set(`{TRANSFORM_NAME_${u}}`,C),a.set(`{TRANSFORM_UV_${u}}`,y),a.set(`{TRANSFORM_ID_${u}}`,g),u++}}),a.set("UV_TRANSFORMS_COUNT",u),i.vertexColors&&(n.vertex_color=Qi,a.set("VERTEX_COLOR",!0),r.set("vVertexColor","vec4")),i.useMsdf&&i.msdfTextAttribute&&(n.vertex_outlineParameters=g0,n.vertex_shadowParameters=y0,a.set("MSDF",!0)),(i.useMorphPosition||i.useMorphNormal)&&(a.set("MORPHING",!0),i.useMorphTextureBasedInt&&a.set("MORPHING_INT",!0),i.useMorphPosition&&a.set("MORPHING_POSITION",!0),i.useMorphNormal&&a.set("MORPHING_NORMAL",!0),n.morph_vertex_id=tm),i.skin&&(n.vertex_boneIndices=gn,i.batch?a.set("BATCH",!0):(n.vertex_boneWeights=co,a.set("SKIN",!0))),i.useInstancing&&a.set("INSTANCING",!0),i.screenSpace&&a.set("SCREENSPACE",!0),i.pixelSnap&&a.set("PIXELSNAP",!0),r.forEach((_,g)=>{this.varyingsCode+=`#define VARYING_${g.toUpperCase()}
`,this.varyingsCode+=this.shaderLanguage===Ja?`varying ${g}: ${RZ.get(_)};
`:`varying ${_} ${g};
`}),this.vshader=`
						${this.varyingsCode}
						#include "litMainVS"
				`}_setupLightingDefines(e,t){const s=this.fDefines,i=this.options;if(this.fDefines.set("LIGHT_COUNT",i.lights.length),e&&s.set("AREA_LIGHTS",!0),t&&this.lighting&&(s.set("LIT_CLUSTERED_LIGHTS",!0),i.clusteredLightingCookiesEnabled&&s.set("CLUSTER_COOKIES",!0),i.clusteredLightingAreaLightsEnabled&&s.set("CLUSTER_AREALIGHTS",!0),i.lightMaskDynamic&&s.set("CLUSTER_MESH_DYNAMIC_LIGHTS",!0),i.clusteredLightingShadowsEnabled&&!i.noShadow)){const a=xh.get(i.clusteredLightingShadowType);s.set("CLUSTER_SHADOWS",!0),s.set(`SHADOW_KIND_${a.kind}`,!0),s.set(`CLUSTER_SHADOW_TYPE_${a.kind}`,!0)}for(let a=0;a<i.lights.length;a++){const n=i.lights[a],r=n._type;if(t&&r!==ft)continue;const l=e&&n._shape?n._shape:ao,u=n._shadowType,f=n.castShadows&&!i.noShadow,_=xh.get(u);s.set(`LIGHT${a}`,!0),s.set(`LIGHT${a}TYPE`,`${e3[r]}`),s.set(`LIGHT${a}SHADOWTYPE`,`${_.name}`),s.set(`LIGHT${a}SHAPE`,`${iU[l]}`),s.set(`LIGHT${a}FALLOFF`,`${aU[n._falloffMode]}`),n.affectSpecularity&&s.set(`LIGHT${a}AFFECT_SPECULARITY`,!0),n._cookie&&(r===Ns&&!n._cookie._cubemap||r===Ds&&n._cookie._cubemap)&&(s.set(`LIGHT${a}COOKIE`,!0),s.set(`{LIGHT${a}COOKIE_CHANNEL}`,n._cookieChannel),r===Ns&&(n._cookieTransform&&s.set(`LIGHT${a}COOKIE_TRANSFORM`,!0),n._cookieFalloff&&s.set(`LIGHT${a}COOKIE_FALLOFF`,!0))),f&&(s.set(`LIGHT${a}CASTSHADOW`,!0),_.pcf&&s.set(`LIGHT${a}SHADOW_PCF`,!0),n._normalOffsetBias&&!n._isVsm&&s.set(`LIGHT${a}_SHADOW_SAMPLE_NORMAL_OFFSET`,!0),r===ft&&(s.set(`LIGHT${a}_SHADOW_SAMPLE_ORTHO`,!0),n.cascadeBlend>0&&s.set(`LIGHT${a}_SHADOW_CASCADE_BLEND`,!0),n.numCascades>1&&s.set(`LIGHT${a}_SHADOW_CASCADES`,!0)),(_.pcf||_.pcss||this.device.isWebGPU)&&s.set(`LIGHT${a}_SHADOW_SAMPLE_SOURCE_ZBUFFER`,!0),r===Ds&&s.set(`LIGHT${a}_SHADOW_SAMPLE_POINT`,!0)),f&&(s.set(`SHADOW_KIND_${_.kind}`,!0),r===ft&&s.set("SHADOW_DIRECTIONAL",!0))}}prepareForwardPass(e){const{options:t}=this,i=t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled||t.lights.some(r=>r._shape&&r._shape!==ao),a=!t.lightMapEnabled||t.lightMapWithoutAmbient,n=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);t.useSpecular&&(this.fDefineSet(!0,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(t.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(t.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(t.useSheen,"LIT_SHEEN"),this.fDefineSet(t.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&t.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(t.useMetalness,"LIT_METALNESS"),this.fDefineSet(t.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(t.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(t.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(t.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(t.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(t.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(t.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(t.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(t.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(t.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(t.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(n,"LIT_TBN"),this.fDefineSet(a,"LIT_ADD_AMBIENT"),this.fDefineSet(t.hasTangents,"LIT_TANGENTS"),this.fDefineSet(t.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(t.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(t.useRefraction,"LIT_REFRACTION"),this.fDefineSet(t.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(t.dispersion,"LIT_DISPERSION"),this.fDefineSet(t.useHeights,"LIT_HEIGHTS"),this.fDefineSet(t.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(t.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(t.useMsdf,"LIT_MSDF"),this.fDefineSet(t.ssao,"LIT_SSAO"),this.fDefineSet(t.useAo,"LIT_AO"),this.fDefineSet(t.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(t.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(t.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(t.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(!0,"LIT_FRESNEL_MODEL",tU[t.fresnelModel]),this.fDefineSet(!0,"LIT_NONE_SLICE_MODE",_U[t.nineSlicedMode]),this.fDefineSet(!0,"LIT_BLEND_TYPE",oP[t.blendType]),this.fDefineSet(!0,"LIT_CUBEMAP_PROJECTION",oU[t.cubeMapProjection]),this.fDefineSet(!0,"LIT_OCCLUDE_SPECULAR",fU[t.occludeSpecular]),this.fDefineSet(!0,"LIT_REFLECTION_SOURCE",pU[t.reflectionSource]),this.fDefineSet(!0,"LIT_AMBIENT_SOURCE",mU[t.ambientSource]),this.fDefineSet(!0,"{lightingUv}",e??""),this.fDefineSet(!0,"{reflectionDecode}",mr.decodeFunc(t.reflectionEncoding)),this.fDefineSet(!0,"{reflectionCubemapDecode}",mr.decodeFunc(t.reflectionCubemapEncoding)),this.fDefineSet(!0,"{ambientDecode}",mr.decodeFunc(t.ambientEncoding)),this._setupLightingDefines(i,t.clusteredLightingEnabled)}prepareShadowPass(){const{options:e}=this,t=this.shaderPassInfo.lightType,s=this.shaderPassInfo.shadowType,i=xh.get(s),a=t===ft||!i.vsm&&t===Ns;this.fDefineSet(a,"PERSPECTIVE_DEPTH"),this.fDefineSet(!0,"LIGHT_TYPE",`${e3[t]}`),this.fDefineSet(!0,"SHADOW_TYPE",`${i.name}`),this.fDefineSet(e.alphaTest,"LIT_ALPHA_TEST")}generateFragmentShader(e,t,s){const i=this.options;i.pass===ry||i.pass===_x||i.pass===ny?this.fshader=`

								${this.varyingsCode}
								${e}
								${t}
								#include "litOtherMainPS"
						`:this.shadowPass?(this.prepareShadowPass(),this.fshader=`
								${this.varyingsCode}
								${e}
								${t}
								#include "litShadowMainPS"
						`):i.customFragmentShader?this.fshader=`
								${i.customFragmentShader}
						`:(this.prepareForwardPass(s),this.fshader=`
								${this.varyingsCode}
								${e}
								#include "litForwardDeclarationPS"
								#include "litForwardPreCodePS"
								${t}
								#include "litForwardPostCodePS"
								#include "litForwardBackendPS"
								#include "litForwardMainPS"
						`)}}const kA={generateKey(h){return`lit${Object.keys(h).sort().map(e=>e==="chunks"?kA.generateChunksKey(h):e==="lights"?kA.generateLightsKey(h):e+h[e]).join(`
`)}`},generateLightsKey(h){return`lights:${h.lights.map(e=>!h.clusteredLightingEnabled||e._type===ft?`${e.key},`:"").join("")}`},generateChunksKey(h){return`chunks:
${Object.keys(h.chunks??{}).sort().map(e=>e+h.chunks[e]).join("")}`}},MZ=[0,1,2,3,4,5,6,7];class DZ extends Kc{generateKey(e){const t=Kc.definesHash(e.defines),s=sl(e.shaderChunkGLSL??""),i=sl(e.shaderChunkWGSL??""),a=kA.generateKey(e.litOptions),n=`${MZ.map((r,l)=>e.usedUvs[l]?"1":"0").join("")}`;return`lit_${t}_${n}_${s}_${i}_${a}`}createShaderDefinition(e,t){const s=e.isWebGPU&&t.shaderChunkWGSL,i=s?Ja:Sr,a=new KU(e,t.litOptions,i),n={name:"LitShader",shaderLanguage:i,tag:a.shaderPassInfo.isForward?ND:void 0},r=t.usedUvs||[!0],l=[];a.generateVertexShader(r,r,l),a.generateFragmentShader("",s?t.shaderChunkWGSL:t.shaderChunkGLSL,"vUv0");const u=new Map(Object.entries({...Object.getPrototypeOf(a.chunks),...a.chunks,...t.litOptions.chunks})),f=a.vDefines;t.defines.forEach((g,y)=>f.set(y,g));const _=a.fDefines;return t.defines.forEach((g,y)=>_.set(y,g)),n.attributes=a.attributes,n.vertexCode=a.vshader,n.vertexIncludes=u,n.vertexDefines=f,n.fragmentCode=a.fshader,n.fragmentIncludes=u,n.fragmentDefines=_,da.createDefinition(e,n)}}const PZ=new DZ,pg=new wZ;class LZ extends Jc{getShaderVariant(e){pg.usedUvs=this.usedUvs.slice(),pg.shaderChunkGLSL=this.shaderChunkGLSL,pg.shaderChunkWGSL=this.shaderChunkWGSL,pg.defines=kC(this,e),to.update(pg.litOptions,this,e.scene,e.cameraShaderParams,e.objDefs,e.pass,e.sortedLights);const t=new gx(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),s=Bm(e.device);return s.register("lit",PZ),s.getProgram("lit",pg,t,this.userId)}constructor(...e){super(...e),this.usedUvs=[!0],this.shaderChunkGLSL=null,this.shaderChunkWGSL=null,this.useLighting=!0,this.useFog=!0,this.useTonemap=!0,this.useSkybox=!0,this.ambientSH=null,this.pixelSnap=!1,this.nineSlicedMode=null,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=ay,this.occludeSpecularIntensity=1,this.opacityFadesSpecular=!0,this.opacityDither=br,this.opacityShadowDither=br,this.shadowCatcher=!1,this.ggxSpecular=!1,this.fresnelModel=lx,this.dynamicRefraction=!1,this.hasAo=!1,this.hasSpecular=!1,this.hasSpecularityFactor=!1,this.hasLighting=!1,this.hasHeights=!1,this.hasNormals=!1,this.hasSheen=!1,this.hasRefraction=!1,this.hasIrridescence=!1,this.hasMetalness=!1,this.hasClearCoat=!1,this.hasClearCoatNormals=!1}}class mm{get pass(){return this.litOptions.pass}constructor(){this.defines=new Map,this.forceUv1=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.normalDetailPackedNormal=!1,this.clearCoatPackedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.useAO=!1,this.litOptions=new Sx}}const r0=[],BR=h=>Object.keys(h).filter(e=>e!=="litOptions").sort();class IZ extends Kc{generateKey(e){let t;return e===this.optionsContextMin?(this.propsMin||(this.propsMin=BR(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=BR(e)),t=this.props):t=BR(e),`standard:
${Kc.definesHash(e.defines)}
${t.map(a=>a+e[a]).join(`
`)}${kA.generateKey(e.litOptions)}`}_getUvSourceExpression(e,t,s){const i=s[e],a=s[t],n=s.litOptions.pass===tf;let r;return n&&s.litOptions.nineSlicedMode===Bi||n&&s.litOptions.nineSlicedMode===Ui?r="nineSlicedUv":(i===0?r=`vUv${a}`:r=`vUV${a}_${i}`,s.heightMap&&e!=="heightMapTransform"&&(r+=" + dUvOffset")),r}_validateMapChunk(e,t,s){}_addMapDefines(e,t,s,i,a,n,r=null){const l=`${t}Map`,u=t.toUpperCase(),f=`${l}Uv`,_=`${l}Identifier`,g=`${l}Transform`,y=`${l}Channel`,v=`${t}VertexColorChannel`,x=`${t}Tint`,C=`${t}VertexColor`,M=`${t}Mode`,w=`${t}Invert`,T=i[x],R=i[C],D=i[l],I=i[_],U=i[M],O=a[s];if(D){e.set(`STD_${u}_TEXTURE`,"");const N=this._getUvSourceExpression(g,f,i);e.set(`{STD_${u}_TEXTURE_UV}`,N),e.set(`{STD_${u}_TEXTURE_CHANNEL}`,i[y]);const z=`{STD_${u}_TEXTURE_NAME}`;if(O.includes(z)){let X=`texture_${l}`;const Y=n[I];Y?X=Y:(n[I]=X,e.set(`STD_${u}_TEXTURE_ALLOCATE`,"")),e.set(z,X)}if(r){const X=i[y]==="aaa"?"passThrough":mr.decodeFunc(r);e.set(`{STD_${u}_TEXTURE_DECODE}`,X)}}R&&(e.set(`STD_${u}_VERTEX`,""),e.set(`{STD_${u}_VERTEX_CHANNEL}`,i[v])),U&&e.set(`{STD_${u}_DETAILMODE}`,U),T&&e.set(`STD_${u}_CONSTANT`,""),i[w]&&e.set(`STD_${u}_INVERT`,"")}_correctChannel(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){let i=t;const a=i.charAt(i.length-1),n=s[e]-i.length;for(let r=0;r<n;r++)i+=a;return i}return t}}createVertexShader(e,t){const s=[],i=[],a=[];for(const r in r0){const l=`${r}Map`;if(t[`${r}VertexColor`]){const u=`${r}VertexColorChannel`;t[u]=this._correctChannel(r,t[u],r0)}if(t[l]){const u=`${l}Channel`,f=`${l}Transform`,_=`${l}Uv`;t[_]=Math.min(t[_],1),t[u]=this._correctChannel(r,t[u],r0);const g=t[_];s[g]=!0,i[g]=i[g]||t[l]&&!t[f],t[f]&&a.push({name:r,id:t[f],uv:t[_]})}}t.forceUv1&&(s[1]=!0,i[1]=i[1]!==void 0?i[1]:!0),e.generateVertexShader(s,i,a)}prepareFragmentDefines(e,t,s){const i=(a,n,r="")=>{a&&t.set(n,r)};i(e.lightMap,"STD_LIGHTMAP",""),i(e.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),i(e.dirLightMap&&e.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),i(e.heightMap,"STD_HEIGHT_MAP",""),i(e.useSpecularColor,"STD_SPECULAR_COLOR",""),i(e.aoMap||e.aoVertexColor||e.useAO,"STD_AO",""),i(!0,"STD_OPACITY_DITHER",CU[s.isForward?e.litOptions.opacityDither:e.litOptions.opacityShadowDither])}createShaderDefinition(e,t){const s=cl.get(e).getByIndex(t.litOptions.pass),i=s.isForward,a=new KU(e,t.litOptions,Sr);this.createVertexShader(a,t);const n={};t.litOptions.fresnelModel=t.litOptions.fresnelModel===0?lx:t.litOptions.fresnelModel;const r=a.fDefines;this.prepareFragmentDefines(t,r,s);let l="";if(i){if(t.heightMap&&this._addMapDefines(r,"height","parallaxPS",t,a.chunks,n),(t.litOptions.blendType!==Gn||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==br)&&this._addMapDefines(r,"opacity","opacityPS",t,a.chunks,n),a.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&!t.litOptions.hasTangents){const g=t.normalMap?"normalMap":"clearCoatNormalMap";l=this._getUvSourceExpression(`${g}Transform`,`${g}Uv`,t)}this._addMapDefines(r,"normalDetail","normalMapPS",t,a.chunks,n,t.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(r,"normal","normalMapPS",t,a.chunks,n,t.packedNormal?"xy":"xyz")}t.diffuseDetail&&this._addMapDefines(r,"diffuseDetail","diffusePS",t,a.chunks,n,t.diffuseDetailEncoding),this._addMapDefines(r,"diffuse","diffusePS",t,a.chunks,n,t.diffuseEncoding),t.litOptions.useRefraction&&(this._addMapDefines(r,"refraction","transmissionPS",t,a.chunks,n),this._addMapDefines(r,"thickness","thicknessPS",t,a.chunks,n)),t.litOptions.useIridescence&&(this._addMapDefines(r,"iridescence","iridescencePS",t,a.chunks,n),this._addMapDefines(r,"iridescenceThickness","iridescenceThicknessPS",t,a.chunks,n)),(a.lighting&&t.litOptions.useSpecular||a.reflections)&&(t.litOptions.useSheen&&(this._addMapDefines(r,"sheen","sheenPS",t,a.chunks,n,t.sheenEncoding),this._addMapDefines(r,"sheenGloss","sheenGlossPS",t,a.chunks,n)),t.litOptions.useMetalness&&(this._addMapDefines(r,"metalness","metalnessPS",t,a.chunks,n),this._addMapDefines(r,"ior","iorPS",t,a.chunks,n)),t.litOptions.useSpecularityFactor&&this._addMapDefines(r,"specularityFactor","specularityFactorPS",t,a.chunks,n),t.useSpecularColor&&this._addMapDefines(r,"specular","specularPS",t,a.chunks,n,t.specularEncoding),this._addMapDefines(r,"gloss","glossPS",t,a.chunks,n)),t.aoDetail&&this._addMapDefines(r,"aoDetail","aoPS",t,a.chunks,n),(t.aoMap||t.aoVertexColor||t.useAO)&&this._addMapDefines(r,"ao","aoPS",t,a.chunks,n),this._addMapDefines(r,"emissive","emissivePS",t,a.chunks,n,t.emissiveEncoding),t.litOptions.useClearCoat&&(this._addMapDefines(r,"clearCoat","clearCoatPS",t,a.chunks,n),this._addMapDefines(r,"clearCoatGloss","clearCoatGlossPS",t,a.chunks,n),this._addMapDefines(r,"clearCoatNormal","clearCoatNormalPS",t,a.chunks,n,t.clearCoatPackedNormal?"xy":"xyz")),(t.lightMap||t.lightVertexColor)&&this._addMapDefines(r,"light","lightmapPS",t,a.chunks,n,t.lightMapEncoding)}else{const g=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||g)&&this._addMapDefines(r,"opacity","opacityPS",t,a.chunks,n)}a.generateFragmentShader(a.chunks.stdDeclarationPS,a.chunks.stdFrontEndPS,l);const u=new Map(Object.entries({...Object.getPrototypeOf(a.chunks),...a.chunks,...t.litOptions.chunks})),f=a.vDefines;t.defines.forEach((g,y)=>f.set(y,g)),t.defines.forEach((g,y)=>r.set(y,g));const _=da.createDefinition(e,{name:"StandardShader",attributes:a.attributes,vertexCode:a.vshader,fragmentCode:a.fshader,vertexIncludes:u,fragmentIncludes:u,fragmentDefines:r,vertexDefines:f});return a.shaderPassInfo.isForward&&(_.tag=ND),_}constructor(...e){super(...e),this.optionsContext=new mm,this.optionsContextMin=new mm}}const UR=new IZ,XO=(h,e)=>{if(h.length!==e.length)return!1;for(let t=0;t<h.length;++t)if(h[t]!==e[t])return!1;return!0},OZ=h=>h.r!==1||h.g!==1||h.b!==1,NZ=h=>h.r!==0||h.g!==0||h.b!==0;class FZ{constructor(){this._mapXForms=null}updateMinRef(e,t,s,i,a,n){this._updateSharedOptions(e,t,s,i,a),this._updateMinOptions(e,s,a),this._updateUVOptions(e,s,i,!0)}updateRef(e,t,s,i,a,n,r){this._updateSharedOptions(e,t,i,a,n),this._updateEnvOptions(e,i,t,s),this._updateMaterialOptions(e,i,t),e.litOptions.hasTangents=a&&(a&BC)!==0,this._updateLightOptions(e,t,i,a,r),this._updateUVOptions(e,i,a,!1,s)}_updateSharedOptions(e,t,s,i,a){e.forceUv1=s.forceUv1,s.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),e.litOptions.chunks=s.chunks||{},e.litOptions.pass=a,e.litOptions.alphaTest=s.alphaTest>0,e.litOptions.blendType=s.blendType,e.litOptions.screenSpace=i&&(i&FC)!==0,e.litOptions.skin=i&&(i&ux)!==0,e.litOptions.batch=i&&(i&NA)!==0,e.litOptions.useInstancing=i&&(i&dx)!==0,e.litOptions.useMorphPosition=i&&(i&fx)!==0,e.litOptions.useMorphNormal=i&&(i&px)!==0,e.litOptions.useMorphTextureBasedInt=i&&(i&mx)!==0,e.litOptions.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.litOptions.clusteredLightingEnabled=!0,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=!1,e.litOptions.clusteredLightingCookiesEnabled=!1,e.litOptions.clusteredLightingShadowsEnabled=!1,e.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,s,i,a){let n=!1,r=!1,l=!1;s&&(n=(s&bP)!==0,r=(s&xP)!==0,l=(s&TP)!==0),e.litOptions.vertexColors=!1,this._mapXForms=[];const u={};for(const f in r0)this._updateTexOptions(e,t,f,n,r,l,i,u);this._mapXForms=null,e.litOptions.ssao=a==null?void 0:a.ssaoEnabled,e.useAO=e.litOptions.ssao,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor||e.litOptions.ssao,e.litOptions.diffuseMapEnabled=e.diffuseMap}_updateTexOptions(e,t,s,i,a,n,r,l){const u=s==="opacity";if(!r||u){const f=`${s}Map`,_=`${s}VertexColor`,g=`${s}VertexColorChannel`,y=`${f}Channel`,v=`${f}Transform`,x=`${f}Uv`,C=`${f}Identifier`;if(s!=="light"&&(e[f]=!1,e[C]=void 0,e[y]="",e[v]=0,e[x]=0),e[_]=!1,e[g]="",u&&t.blendType===Gn&&t.alphaTest===0&&!t.alphaToCoverage&&t.opacityDither===br)return;if(s!=="height"&&t[_]&&n&&(e[_]=t[_],e[g]=t[g],e.litOptions.vertexColors=!0),t[f]){let M=!0;if(t[x]===0&&!i&&(M=!1),t[x]===1&&!a&&(M=!1),M){const w=t[f].id;let T=l[w];T===void 0&&(l[w]=s,T=s),e[f]=!!t[f],e[C]=T,e[v]=this._getMapTransformID(t.getUniform(v),t[x]),e[y]=t[y],e[x]=t[x]}}}}_updateMinOptions(e,t,s){const i=s===ny;e.litOptions.opacityShadowDither=i?t.opacityDither:t.opacityShadowDither,e.litOptions.linearDepth=i,e.litOptions.lights=[]}_updateMaterialOptions(e,t,s){var f,_,g,y,v,x;const i=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||NZ(t.specular)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),a=!t.useMetalness||t.useMetalnessSpecularColor,n=i&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&OZ(t.specular),r=i&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),l=C=>C?C.format===Em||C.type===S0:!1,u=(C,M)=>Math.abs(C-M)<1e-4;e.specularTint=n,e.specularityFactorTint=r,e.metalnessTint=t.useMetalness&&t.metalness<1,e.glossTint=!0,e.diffuseEncoding=(f=t.diffuseMap)==null?void 0:f.encoding,e.diffuseDetailEncoding=(_=t.diffuseDetailMap)==null?void 0:_.encoding,e.emissiveEncoding=(g=t.emissiveMap)==null?void 0:g.encoding,e.lightMapEncoding=(y=t.lightMap)==null?void 0:y.encoding,e.packedNormal=l(t.normalMap),e.refractionTint=u(t.refraction,1),e.refractionIndexTint=u(t.refractionIndex,1/1.5),e.thicknessTint=t.useDynamicRefraction&&t.thickness!==1,e.specularEncoding=(v=t.specularMap)==null?void 0:v.encoding,e.sheenEncoding=(x=t.sheenMap)==null?void 0:x.encoding,e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoDetailMap,e.diffuseDetail=!!t.diffuseDetailMap,e.normalDetail=!!t.normalMap,e.normalDetailPackedNormal=l(t.normalDetailMap),e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatTint=u(t.clearCoat,1),e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatGlossTint=t.clearCoatGloss!==1,e.clearCoatPackedNormal=l(t.clearCoatNormalMap),e.iorTint=u(t.refractionIndex,1/1.5),s.forcePassThroughSpecular&&(e.specularEncoding="linear",e.sheenEncoding="linear"),e.iridescenceTint=t.iridescence!==1,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=a,e.litOptions.separateAmbient=!1,e.litOptions.customFragmentShader=t.customFragmentShader,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=t.occludeSpecularIntensity!==1,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.useSpecular=i,e.litOptions.useSpecularityFactor=(r||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||e.litOptions.reflectionSource!==Hc),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&t.iridescence!==0,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction,e.litOptions.dispersion=t.dispersion>0,e.litOptions.shadowCatcher=t.shadowCatcher}_updateEnvOptions(e,t,s,i){e.litOptions.fog=t.useFog?i.fog:Fm,e.litOptions.gamma=i.shaderOutputGamma,e.litOptions.toneMap=t.useTonemap?i.toneMapping:iy;let a=!1;if(t.envAtlas&&t.cubeMap?(e.litOptions.reflectionSource=i1,e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(e.litOptions.reflectionSource=s1,e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource=a1,e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource=SP,e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox?(e.litOptions.reflectionSource=i1,e.litOptions.reflectionEncoding=s.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=s.skybox.encoding,a=!0):t.useSkybox&&s.envAtlas?(e.litOptions.reflectionSource=s1,e.litOptions.reflectionEncoding=s.envAtlas.encoding,a=!0):t.useSkybox&&s.skybox?(e.litOptions.reflectionSource=a1,e.litOptions.reflectionEncoding=s.skybox.encoding,a=!0):(e.litOptions.reflectionSource=Hc,e.litOptions.reflectionEncoding=null),t.ambientSH)e.litOptions.ambientSource=LC,e.litOptions.ambientEncoding=null;else{const n=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);n&&!t.sphereMap?(e.litOptions.ambientSource=IC,e.litOptions.ambientEncoding=n.encoding):(e.litOptions.ambientSource=OC,e.litOptions.ambientEncoding=null)}e.litOptions.skyboxIntensity=a,e.litOptions.useCubeMapRotation=a&&s._skyboxRotationShaderInclude}_updateLightOptions(e,t,s,i,a){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.litOptions.noShadow=(i&NC)!==0,(i&OA)!==0&&(e.lightMapEncoding=t.lightmapPixelFormat===Lt?"rgbm":"linear",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!s.lightMap,(i&EP)!==0&&(e.dirLightMap=!0),(i&AP)!==0&&(e.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){const n=[],r=i?i>>16:uo;e.litOptions.lightMaskDynamic=!!(r&uo),a&&(to.collectLights(ft,a[ft],n,r),to.collectLights(Ds,a[Ds],n,r),to.collectLights(Ns,a[Ns],n,r)),e.litOptions.lights=n}else e.litOptions.lights=[];e.litOptions.lights.length===0&&(e.litOptions.noShadow=!0)}_getMapTransformID(e,t){if(!e)return 0;let s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(let i=0;i<s.length;i++)if(XO(s[i][0].value,e[0].value)&&XO(s[i][1].value,e[1].value))return i+1;return s.push(e)}}function ni(h,e=!0,t=!0){const s={};return s[`${h}Map`]="texture",s[`${h}MapTiling`]="vec2",s[`${h}MapOffset`]="vec2",s[`${h}MapRotation`]="number",s[`${h}MapUv`]="number",e&&(s[`${h}MapChannel`]="string",t&&(s[`${h}VertexColor`]="boolean",s[`${h}VertexColorChannel`]="string")),s}const M0={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",...ni("ao"),...ni("aoDetail",!0,!1),aoDetailMode:"string",diffuse:"rgb",...ni("diffuse"),...ni("diffuseDetail",!0,!1),diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",...ni("specular"),occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean",...ni("specularityFactor"),useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",...ni("metalness"),useMetalnessSpecularColor:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean",...ni("gloss"),clearCoat:"number",...ni("clearCoat"),clearCoatGloss:"number",clearCoatGlossInvert:"boolean",...ni("clearCoatGloss"),clearCoatBumpiness:"number",...ni("clearCoatNormal",!1),useSheen:"boolean",sheen:"rgb",...ni("sheen"),sheenGloss:"number",sheenGlossInvert:"boolean",...ni("sheenGloss"),fresnelModel:"number",emissive:"rgb",...ni("emissive"),emissiveIntensity:"number",...ni("normal",!1),bumpiness:"number",...ni("normalDetail",!1),normalDetailMapBumpiness:"number",...ni("height",!0,!1),heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",...ni("opacity"),opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean",...ni("refraction"),refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean",...ni("thickness"),attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean",...ni("iridescence"),iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number",...ni("iridescenceThickness"),...ni("light"),depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"},GC=[];for(const h in M0)M0[h]==="texture"&&GC.push(h);const NP=[];for(const h in M0)M0[h]==="cubemap"&&NP.push(h);const BZ={aoMapVertexColor:"boolean",diffuseMapTint:"boolean",diffuseMapVertexColor:"boolean",emissiveMapTint:"boolean",emissiveMapVertexColor:"boolean",glossMapVertexColor:"boolean",metalnessMapVertexColor:"boolean",opacityMapVertexColor:"boolean",specularAntialias:"boolean",specularMapTint:"boolean",specularMapVertexColor:"boolean",ambientTint:"boolean",emissiveTint:"boolean",diffuseTint:"boolean",sheenTint:"boolean",conserveEnergy:"boolean",useGamma:"boolean",useGammaTonemap:"boolean",sheenGlossTint:"boolean"},yA={},QU={};let Zv=new Set;const wE=new xe,I2=class I2 extends Jc{constructor(){super(),this.userAttributes=new Map,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new FZ,this.reset()}reset(){Object.keys(yA).forEach(e=>{this[`_${e}`]=yA[e].value()}),this._uniformCache={}}copy(e){return super.copy(e),Object.keys(yA).forEach(t=>{this[t]=e[t]}),this.userAttributes=new Map(e.userAttributes),this}setAttribute(e,t){this.userAttributes.set(t,e)}_setParameter(e,t){Zv.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach(t=>{this._setParameter(t.name,t.value)})}_processParameters(e){const t=this[e];t.forEach(s=>{Zv.has(s)||delete this.parameters[s]}),this[e]=Zv,Zv=t,Zv.clear()}_updateMap(e){const t=`${e}Map`,s=this[t];if(s){this._setParameter(`texture_${t}`,s);const i=`${t}Transform`,a=this.getUniform(i);a&&this._setParameters(a)}}_allocUniform(e,t){let s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return QU[e](this,t,s)}updateUniforms(e,t){const s=i=>this.getUniform(i,e,t);this._setParameter("material_ambient",s("ambient")),this._setParameter("material_diffuse",s("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),(!this.specularityFactorMap||this.specularityFactorTint)&&this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",s("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",s("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",this.attenuationDistance===0?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),this.opacityFadesSpecular===!1&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===_P&&this._setParameter(s("cubeMapProjectionBox"));for(const i in r0)this._updateMap(i);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),super.updateUniforms(e,t)}updateEnvUniforms(e,t){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e){const{device:t,scene:s,pass:i,objDefs:a,sortedLights:n,cameraShaderParams:r}=e;this.updateEnvUniforms(t,s);const l=cl.get(t).getByIndex(i),u=i===_x||i===ry||i===ny||l.isShadow;let f=u?UR.optionsContextMin:UR.optionsContext;f.defines=kC(this,e),u?this.shaderOptBuilder.updateMinRef(f,s,this,a,i,n):this.shaderOptBuilder.updateRef(f,s,r,this,a,i,n),this.useFog||f.defines.set("FOG","NONE"),f.defines.set("TONEMAP",PC[f.litOptions.toneMap]),this.onUpdateShader&&(f=this.onUpdateShader(f));const _=new gx(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),g=Bm(t);g.register("standard",UR);const y=g.getProgram("standard",f,_,this.userId);return this._dirtyShader=!1,y}destroy(){for(const e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}};I2.TEXTURE_PARAMETERS=GC,I2.CUBEMAP_PARAMETERS=NP;let Vi=I2;const HC=(h,e)=>{QU[h]=e},FP=(h,e,t,s)=>{Object.defineProperty(Vi.prototype,h,{get:s||function(){return this[`_${h}`]},set:t}),yA[h]={value:e}},UZ=h=>{const e=`_${h.name}`,t=h.dirtyShaderFunc||(()=>!0),s=function(i){const a=this[e];a!==i&&(this._dirtyShader=this._dirtyShader||t(a,i),this[e]=i)};FP(h.name,()=>h.defaultValue,s,h.getterFunc)},zZ=h=>{const e=`_${h.name}`,t=h.dirtyShaderFunc||(()=>!0),s=function(i){const a=this[e];a.equals(i)||(this._dirtyShader=this._dirtyShader||t(a,i),this[e]=a.copy(i))};FP(h.name,()=>h.defaultValue.clone(),s,h.getterFunc)},eo=h=>h.defaultValue&&h.defaultValue.clone?zZ(h):UZ(h);function Qs(h,e="rgb",t=!0,s=0){r0[h]=e.length||-1,eo({name:`${h}Map`,defaultValue:null,dirtyShaderFunc:(l,u)=>!!l!=!!u||l&&(l.type!==u.type||l.format!==u.format)}),eo({name:`${h}MapTiling`,defaultValue:new Ee(1,1)}),eo({name:`${h}MapOffset`,defaultValue:new Ee(0,0)}),eo({name:`${h}MapRotation`,defaultValue:0}),eo({name:`${h}MapUv`,defaultValue:s}),e&&(eo({name:`${h}MapChannel`,defaultValue:e}),t&&(eo({name:`${h}VertexColor`,defaultValue:!1}),eo({name:`${h}VertexColorChannel`,defaultValue:e})));const i=`${h}MapTiling`,a=`${h}MapOffset`,n=`${h}MapRotation`,r=`${h}MapTransform`;HC(r,(l,u,f)=>{const _=l[i],g=l[a],y=l[n];if(_.x===1&&_.y===1&&g.x===0&&g.y===0&&y===0)return null;const v=l._allocUniform(r,()=>[{name:`texture_${r}0`,value:new Float32Array(3)},{name:`texture_${r}1`,value:new Float32Array(3)}]),x=Math.cos(y*ge.DEG_TO_RAD),C=Math.sin(y*ge.DEG_TO_RAD),M=v[0].value;M[0]=x*_.x,M[1]=-C*_.y,M[2]=g.x;const w=v[1].value;return w[0]=C*_.x,w[1]=x*_.y,w[2]=1-_.y-g.y,v})}function mg(h,e){eo({name:h,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${h}`]}}),HC(h,(t,s,i)=>{const a=t._allocUniform(h,()=>new Float32Array(3)),n=t[h];return wE.linear(n),a[0]=wE.r,a[1]=wE.g,a[2]=wE.b,a})}function ws(h,e,t){eo({name:h,defaultValue:e,dirtyShaderFunc:(s,i)=>(s===0||s===1)!=(i===0||i===1)}),HC(h,t)}function Jv(h,e){eo({name:h,defaultValue:null,dirtyShaderFunc:(t,s)=>!!t==!!s}),HC(h,e)}function as(h,e){eo({name:h,defaultValue:e})}function kZ(){mg("ambient",new xe(1,1,1)),mg("diffuse",new xe(1,1,1)),mg("specular",new xe(0,0,0)),mg("emissive",new xe(0,0,0)),mg("sheen",new xe(1,1,1)),mg("attenuation",new xe(1,1,1)),ws("emissiveIntensity",1),ws("specularityFactor",1),ws("sheenGloss",0),ws("gloss",.25),ws("aoIntensity",1),ws("heightMapFactor",1,(s,i,a)=>s.heightMapFactor*.025),ws("opacity",1),ws("alphaFade",1),ws("alphaTest",0),ws("bumpiness",1),ws("normalDetailMapBumpiness",1),ws("reflectivity",1),ws("occludeSpecularIntensity",1),ws("refraction",0),ws("refractionIndex",1/1.5),ws("dispersion",0),ws("thickness",0),ws("attenuationDistance",0),ws("metalness",1),ws("anisotropy",0),ws("clearCoat",0),ws("clearCoatGloss",1),ws("clearCoatBumpiness",1),ws("aoUvSet",0,null),ws("iridescence",0),ws("iridescenceRefractionIndex",1/1.5),ws("iridescenceThicknessMin",0),ws("iridescenceThicknessMax",0),Jv("ambientSH"),Jv("cubeMapProjectionBox",(s,i,a)=>{const n=s._allocUniform("cubeMapProjectionBox",()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]),r=s.cubeMapProjectionBox.getMin(),l=n[0].value;l[0]=r.x,l[1]=r.y,l[2]=r.z;const u=s.cubeMapProjectionBox.getMax(),f=n[1].value;return f[0]=u.x,f[1]=u.y,f[2]=u.z,n}),as("specularTint",!1),as("specularityFactorTint",!1),as("useMetalness",!1),as("useMetalnessSpecularColor",!1),as("useSheen",!1),as("enableGGXSpecular",!1),as("occludeDirect",!1),as("opacityFadesSpecular",!0),as("occludeSpecular",ay),as("fresnelModel",lx),as("useDynamicRefraction",!1),as("cubeMapProjection",DC),as("customFragmentShader",null),as("useFog",!0),as("useLighting",!0),as("useTonemap",!0),as("useSkybox",!0),as("forceUv1",!1),as("pixelSnap",!1),as("twoSidedLighting",!1),as("nineSlicedMode",void 0),as("msdfTextAttribute",!1),as("useIridescence",!1),as("glossInvert",!1),as("sheenGlossInvert",!1),as("clearCoatGlossInvert",!1),as("opacityDither",br),as("opacityShadowDither",br),as("shadowCatcher",!1),Qs("diffuse"),Qs("specular"),Qs("emissive"),Qs("thickness","g"),Qs("specularityFactor","g"),Qs("normal",""),Qs("metalness","g"),Qs("gloss","g"),Qs("opacity","a"),Qs("refraction","g"),Qs("height","g",!1),Qs("ao","g"),Qs("light","rgb",!0,1),Qs("msdf",""),Qs("diffuseDetail","rgb",!1),Qs("normalDetail",""),Qs("aoDetail","g",!1),Qs("clearCoat","g"),Qs("clearCoatGloss","g"),Qs("clearCoatNormal",""),Qs("sheen","rgb"),Qs("sheenGloss","g"),Qs("iridescence","g"),Qs("iridescenceThickness","g"),as("diffuseDetailMode",t3),as("aoDetailMode",t3),Jv("cubeMap"),Jv("sphereMap"),Jv("envAtlas");const h=function(){return this._prefilteredCubemaps},e=function(s){const i=this._prefilteredCubemaps;s=s||[];let a=!1,n=!0;for(let r=0;r<6;++r){const l=s[r]||null;i[r]!==l&&(i[r]=l,a=!0),n=n&&!!i[r]}a&&(n?this.envAtlas=n0.generatePrefilteredAtlas(i,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)},t=[null,null,null,null,null,null];FP("prefilteredCubemaps",()=>t.slice(),e,h)}kZ();const $o=4/64,nh=1-$o*2;class BP extends dl{constructor(e,t,s,i,a,n){super();const r=new H,l=new H,u=new H,f=new H,_=new H,g=new H,y=[],v=[],x=[],C=[],M=[];let w;if(s>0)for(let T=0;T<=i;T++)for(let R=0;R<=a;R++){const D=R/a*2*Math.PI-Math.PI,I=Math.sin(D),U=Math.cos(D);_.set(I*e,-s/2,U*e),f.set(I*t,s/2,U*t),r.lerp(_,f,T/i),l.sub2(f,_).normalize(),g.set(U,0,-I),u.cross(g,l).normalize(),y.push(r.x,r.y,r.z),v.push(u.x,u.y,u.z);let O=R/a,N=T/i;x.push(O,1-N);const z=N;if(N=O,O=z,O=O*nh+$o,N=N*nh+$o,O/=3,C.push(O,1-N),T<i&&R<a){const X=T*(a+1)+R,Y=T*(a+1)+(R+1),F=(T+1)*(a+1)+R,q=(T+1)*(a+1)+(R+1);M.push(X,Y,F),M.push(Y,q,F)}}if(n){const T=Math.floor(a/2),R=a,D=s/2;for(let I=0;I<=T;I++){const U=I*Math.PI*.5/T,O=Math.sin(U),N=Math.cos(U);for(let z=0;z<=R;z++){const X=z*2*Math.PI/R-Math.PI/2,Y=Math.sin(X),q=Math.cos(X)*O,G=N,W=Y*O;let k=1-z/R,K=1-I/T;y.push(q*t,G*t+D,W*t),v.push(q,G,W),x.push(k,1-K),k=k*nh+$o,K=K*nh+$o,k/=3,K/=3,k+=1/3,C.push(k,1-K)}}w=(i+1)*(a+1);for(let I=0;I<T;++I)for(let U=0;U<R;++U){const O=I*(R+1)+U,N=O+R+1;M.push(w+O+1,w+N,w+O),M.push(w+O+1,w+N+1,w+N)}for(let I=0;I<=T;I++){const U=Math.PI*.5+I*Math.PI*.5/T,O=Math.sin(U),N=Math.cos(U);for(let z=0;z<=R;z++){const X=z*2*Math.PI/R-Math.PI/2,Y=Math.sin(X),q=Math.cos(X)*O,G=N,W=Y*O;let k=1-z/R,K=1-I/T;y.push(q*t,G*t-D,W*t),v.push(q,G,W),x.push(k,1-K),k=k*nh+$o,K=K*nh+$o,k/=3,K/=3,k+=2/3,C.push(k,1-K)}}w=(i+1)*(a+1)+(R+1)*(T+1);for(let I=0;I<T;++I)for(let U=0;U<R;++U){const O=I*(R+1)+U,N=O+R+1;M.push(w+O+1,w+N,w+O),M.push(w+O+1,w+N+1,w+N)}}else{if(w=(i+1)*(a+1),e>0)for(let T=0;T<a;T++){const R=T/a*2*Math.PI,D=Math.sin(R),I=-s/2,U=Math.cos(R);let O=1-(D+1)/2,N=(U+1)/2;y.push(D*e,I,U*e),v.push(0,-1,0),x.push(O,1-N),O=O*nh+$o,N=N*nh+$o,O/=3,N/=3,O+=1/3,C.push(O,1-N),T>1&&M.push(w,w+T,w+T-1)}if(w+=a,t>0)for(let T=0;T<a;T++){const R=T/a*2*Math.PI,D=Math.sin(R),I=s/2,U=Math.cos(R);let O=1-(D+1)/2,N=(U+1)/2;y.push(D*t,I,U*t),v.push(0,1,0),x.push(O,1-N),O=O*nh+$o,N=N*nh+$o,O/=3,N/=3,O+=2/3,C.push(O,1-N),T>1&&M.push(w,w+T-1,w+T)}}this.positions=y,this.normals=v,this.uvs=x,this.uvs1=C,this.indices=M}}class UP extends BP{constructor(e={}){const t=e.radius??.3,s=e.height??1,i=e.heightSegments??1,a=e.sides??20;super(t,t,s-2*t,i,a,!0),e.calculateTangents&&(this.tangents=eu(this.positions,this.normals,this.uvs,this.indices))}}class bx extends BP{constructor(e={}){const t=e.baseRadius??.5,s=e.peakRadius??0,i=e.height??1,a=e.heightSegments??5,n=e.capSegments??18;super(t,s,i,a,n,!1),e.calculateTangents&&(this.tangents=eu(this.positions,this.normals,this.uvs,this.indices))}}class uy extends BP{constructor(e={}){const t=e.radius??.5,s=e.height??1,i=e.heightSegments??5,a=e.capSegments??20;super(t,t,s,i,a,!1),e.calculateTangents&&(this.tangents=eu(this.positions,this.normals,this.uvs,this.indices))}}class xx extends dl{constructor(e={}){super();const t=e.halfExtents??new Ee(.5,.5),s=e.widthSegments??5,i=e.lengthSegments??5,a=[],n=[],r=[],l=[];let u=0;for(let f=0;f<=s;f++)for(let _=0;_<=i;_++){const g=-t.x+2*t.x*f/s,y=0,v=-(-t.y+2*t.y*_/i),x=f/s,C=_/i;a.push(g,y,v),n.push(0,1,0),r.push(x,1-C),f<s&&_<i&&(l.push(u+i+1,u+1,u),l.push(u+i+1,u+i+2,u+1)),u++}this.positions=a,this.normals=n,this.uvs=r,this.uvs1=r,this.indices=l,e.calculateTangents&&(this.tangents=eu(a,n,r,l))}}class D0 extends dl{constructor(e={}){super();const t=e.tubeRadius??.2,s=e.ringRadius??.3,i=(e.sectorAngle??360)*ge.DEG_TO_RAD,a=e.segments??30,n=e.sides??20,r=[],l=[],u=[],f=[];for(let _=0;_<=n;_++)for(let g=0;g<=a;g++){const y=Math.cos(i*g/a)*(s+t*Math.cos(2*Math.PI*_/n)),v=Math.sin(2*Math.PI*_/n)*t,x=Math.sin(i*g/a)*(s+t*Math.cos(2*Math.PI*_/n)),C=Math.cos(i*g/a)*Math.cos(2*Math.PI*_/n),M=Math.sin(2*Math.PI*_/n),w=Math.sin(i*g/a)*Math.cos(2*Math.PI*_/n),T=_/n,R=1-g/a;if(r.push(y,v,x),l.push(C,M,w),u.push(T,1-R),_<n&&g<a){const D=_*(a+1)+g,I=(_+1)*(a+1)+g,U=_*(a+1)+(g+1),O=(_+1)*(a+1)+(g+1);f.push(D,I,U),f.push(I,O,U)}}this.positions=r,this.normals=l,this.uvs=u,this.uvs1=u,this.indices=f,e.calculateTangents&&(this.tangents=eu(r,l,u,f))}}class $U{constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new mm,this._defaultStdMatOptionMin=new mm;const s=new RP;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},s,t,null,[],tf,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,CP,null),e.on("destroy:shader",i=>{this.removeFromCache(i)})}destroy(){this.clearCache()}register(e,t){this._generators.has(e)||this._generators.set(e,t)}unregister(e){this._generators.has(e)&&this._generators.delete(e)}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,s,i){var n,r;let a=this.definitionsCache.get(s);if(!a){let l;(n=i.litOptions)!=null&&n.lights&&(l=i.litOptions.lights,i.litOptions.lights=l.map(f=>{const _=f.clone?f.clone():f;return _.key=f.key,_})),this.storeNewProgram(t,i),(r=i.litOptions)!=null&&r.lights&&(i.litOptions.lights=l),this._precached;const u=this._device;a=e.createShaderDefinition(u,i),a.name=a.name??(i.pass?`${t}-pass:${i.pass}`:t),this.definitionsCache.set(s,a)}return a}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t)}getProgram(e,t,s,i){const a=this._generators.get(e);if(!a)return null;const n=a.generateKey(t),r=sl(n),l=s.generateKey(this._device),u=sl(l),f=`${r}#${u}`;let _=this.getCachedShader(f);if(!_){const g=this.generateShaderDefinition(a,e,r,t);let y="",v;t.pass!==void 0&&(v=cl.get(this._device).getByIndex(t.pass),y=`-${v.name}`),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:v,definition:g});const x={name:`${g.name}${y}-proc`,attributes:g.attributes,vshader:g.vshader,vincludes:g.vincludes,fincludes:g.fincludes,fshader:g.fshader,processingOptions:s,shaderLanguage:g.shaderLanguage,meshUniformBufferFormat:g.meshUniformBufferFormat,meshBindGroupFormat:g.meshBindGroupFormat};_=new ef(this._device,x),this.setCachedShader(f,_)}return _}storeNewProgram(e,t){let s={};if(e==="standard"){const i=this._getDefaultStdMatOptions(t.pass);for(const a in t)(t.hasOwnProperty(a)&&i[a]!==t[a]||a==="pass")&&(s[a]=t[a]);for(const a in t.litOptions)s[a]=t.litOptions[a]}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}))}dumpPrograms(){let e=`let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;
`;e+="let shaders = [",this._programsCollection[0]&&(e+=`
	${this._programsCollection[0]}`);for(let s=1;s<this._programsCollection.length;++s)e+=`,
	${this._programsCollection[s]}`;e+=`
];
`,e+=`pc.getProgramLibrary(device).precompile(shaders);
`,e+=`if (pc.version != "${bD}" || pc.revision != "${sF}")
`,e+='	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const t=document.createElement("a");t.setAttribute("href",`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach(e=>{e.destroy()}),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(e){this._isClearingCache||this.processedCache.forEach((t,s)=>{e===t&&this.processedCache.delete(s)})}_getDefaultStdMatOptions(e){const t=cl.get(this._device).getByIndex(e);return e===_x||e===ry||e===ny||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){const t=new Array(e.length);for(let s=0;s<e.length;s++){if(e[s].name==="standard"){const i=e[s].options,a=this._getDefaultStdMatOptions(i.pass);for(const n in a)a.hasOwnProperty(n)&&i[n]===void 0&&(i[n]=a[n])}t[s]=this.getProgram(e[s].name,e[s].options)}}this._precached=!0}}var VZ=`
	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);
	if (bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);
			dAtten = saturate(dAtten);
			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);
			gl_FragColor.a = dirLm.w + dAtten;
			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);
		} else {
			gl_FragColor = dirLm;
		}
	} else {
		gl_FragColor.rgb = dirLm.xyz;
		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);
	}
`,GZ=`
#ifdef LIGHTMAP_RGBM
	gl_FragColor.rgb = dDiffuseLight;
	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));
	gl_FragColor.rgb /= 8.0;
	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );
	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;
	gl_FragColor.rgb /= gl_FragColor.a;
#else
	gl_FragColor = vec4(dDiffuseLight, 1.0);
#endif
`,HZ=`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
bool isUsed(vec4 pixel) {
	#if HDR
		return any(greaterThan(pixel.rgb, vec3(0.0)));
	#else
		return pixel.a > 0.0;
	#endif
}
void main(void) {
	vec4 c = texture2DLod(source, vUv0, 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);
	gl_FragColor = c;
}
`,WZ=`
float normpdf3(in vec3 v, in float sigma) {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
vec3 decodeRGBM(vec4 rgbm) {
	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 encodeRGBM(vec3 color) {
	vec4 encoded;
	encoded.rgb = pow(color.rgb, vec3(0.5));
	encoded.rgb *= 1.0 / 8.0;
	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded.rgb /= encoded.a;
	return encoded;
}
vec3 decode(vec4 pixel) {
	#if HDR
		return pixel.rgb;
	#else
		return decodeRGBM(pixel);
	#endif
}
bool isUsed(vec4 pixel) {
	#if HDR
		return any(greaterThan(pixel.rgb, vec3(0.0)));
	#else
		return pixel.a > 0.0;
	#endif
}
#define MSIZE 15
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
uniform vec2 sigmas;
uniform float bZnorm;
uniform float kernel[MSIZE];
void main(void) {
	
	vec4 pixel = texture2DLod(source, vUv0, 0.0);
	if (!isUsed(pixel)) {
		gl_FragColor = pixel;
		return ;
	}
	float sigma = sigmas.x;
	float bSigma = sigmas.y;
	vec3 pixelHdr = decode(pixel);
	vec3 accumulatedHdr = vec3(0.0);
	float accumulatedFactor = 0.000001;
	const int kSize = (MSIZE-1)/2;
	for (int i = -kSize; i <= kSize; ++i) {
		for (int j = -kSize; j <= kSize; ++j) {
			
			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;
			vec4 pix = texture2DLod(source, coord, 0.0);
			if (isUsed(pix)) {
				vec3 hdr = decode(pix);
				float factor = kernel[kSize + j] * kernel[kSize + i];
				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;
				accumulatedHdr += factor * hdr;
				accumulatedFactor += factor;
			}
		}
	}
	vec3 finalHDR = accumulatedHdr / accumulatedFactor;
	#if HDR
		gl_FragColor = vec4(finalHDR, 1.0);
	#else
		gl_FragColor = encodeRGBM(finalHDR);
	#endif
}
`;const o0={bakeDirLmEndPS:VZ,bakeLmEndPS:GZ,dilatePS:HZ,bilateralDeNoisePS:WZ},_g=new Me,jO=new Ne,zR=new wt,YO=new wt,qZ=new xe(1,1,0,.4),kR=.28209479177387814;class XZ{constructor(e,t,s,i,a){const n=e.getProp("x"),r=e.getProp("y"),l=e.getProp("z"),u=e.getProp("rot_1"),f=e.getProp("rot_2"),_=e.getProp("rot_3"),g=e.getProp("rot_0"),y=e.getProp("scale_0"),v=e.getProp("scale_1"),x=e.getProp("scale_2"),C=e.getProp("f_dc_0"),M=e.getProp("f_dc_1"),w=e.getProp("f_dc_2"),T=e.getProp("opacity"),R=D=>{if(D>0)return 1/(1+Math.exp(-D));const I=Math.exp(D);return I/(1+I)};this.read=D=>{t&&(t.x=n[D],t.y=r[D],t.z=l[D]),s&&s.set(u[D],f[D],_[D],g[D]),i&&i.set(Math.exp(y[D]),Math.exp(v[D]),Math.exp(x[D])),a&&a.set(.5+C[D]*kR,.5+M[D]*kR,.5+w[D]*kR,R(T[D]))}}}const KO=(h,e,t)=>{jO.set(t.x,t.y,t.z,t.w).normalize(),h.setTRS(e,jO,H.ONE)};class Qd{constructor(e){this.elements=e,this.numSplats=this.getElement("vertex").count}static calcSplatAabb(e,t,s,i){KO(_g,t,s),zR.center.set(0,0,0),zR.halfExtents.set(i.x*2,i.y*2,i.z*2),e.setFromTransformedAabb(zR,_g)}getProp(e,t="vertex"){var s,i;return(i=(s=this.getElement(t))==null?void 0:s.properties.find(a=>a.name===e))==null?void 0:i.storage}getElement(e){return this.elements.find(t=>t.name===e)}addProp(e,t){this.getElement("vertex").properties.push({type:"float",name:e,storage:t,byteSize:4})}createIter(e,t,s,i){return new XZ(this,e,t,s,i)}calcAabb(e,t){let s,i,a,n,r,l,u=!0;const f=this.getProp("x"),_=this.getProp("y"),g=this.getProp("z"),y=this.getProp("scale_0"),v=this.getProp("scale_1"),x=this.getProp("scale_2");for(let C=0;C<this.numSplats;++C){if(t&&!t(C))continue;const M=f[C],w=_[C],T=g[C],R=Math.max(y[C],v[C],x[C]);if(!isFinite(M)||!isFinite(w)||!isFinite(T)||!isFinite(R))continue;const D=2*Math.exp(R);u?(u=!1,s=M-D,i=w-D,a=T-D,n=M+D,r=w+D,l=T+D):(s=Math.min(s,M-D),i=Math.min(i,w-D),a=Math.min(a,T-D),n=Math.max(n,M+D),r=Math.max(r,w+D),l=Math.max(l,T+D))}return u||(e.center.set((s+n)*.5,(i+r)*.5,(a+l)*.5),e.halfExtents.set((n-s)*.5,(r-i)*.5,(l-a)*.5)),!u}calcAabbExact(e,t){const s=new H,i=new Ne,a=new H,n=this.createIter(s,i,a);let r=!0;for(let l=0;l<this.numSplats;++l)t&&!t(l)||(n.read(l),r?(r=!1,Qd.calcSplatAabb(e,s,i,a)):(Qd.calcSplatAabb(YO,s,i,a),e.add(YO)));return!r}getCenters(e){const t=this.getProp("x"),s=this.getProp("y"),i=this.getProp("z");for(let a=0;a<this.numSplats;++a)e[a*3+0]=t[a],e[a*3+1]=s[a],e[a*3+2]=i[a]}calcFocalPoint(e,t){const s=this.getProp("x"),i=this.getProp("y"),a=this.getProp("z"),n=this.getProp("scale_0"),r=this.getProp("scale_1"),l=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;let u=0;for(let f=0;f<this.numSplats;++f){if(t&&!t(f))continue;const _=s[f],g=i[f],y=a[f];if(!isFinite(_)||!isFinite(g)||!isFinite(y))continue;const v=1/(1+Math.exp(Math.max(n[f],r[f],l[f])));e.x+=_*v,e.y+=g*v,e.z+=y*v,u+=v}e.mulScalar(1/u)}renderWireframeBounds(e,t){const s=new H,i=new Ne,a=new H,n=new H,r=new H,l=this.createIter(s,i,a);for(let u=0;u<this.numSplats;++u)l.read(u),KO(_g,s,i),_g.mul2(t,_g),n.set(a.x*-2,a.y*-2,a.z*-2),r.set(a.x*2,a.y*2,a.z*2),e.immediate.drawWireAlignedBox(n,r,qZ,!0,e.defaultDrawLayer,_g)}get isCompressed(){return!1}get shBands(){return{9:1,24:2,45:3}[(()=>{for(let s=0;s<45;++s)if(!this.getProp(`f_rest_${s}`))return s;return 45})()]??0}calcMortonOrder(){const e=T=>{let R=T[0],D=T[0];for(let I=1;I<T.length;I++)T[I]<R&&(R=T[I]),T[I]>D&&(D=T[I]);return{min:R,max:D}},t=(T,R,D)=>{const I=U=>(U&=1023,U=(U^U<<16)&4278190335,U=(U^U<<8)&50393103,U=(U^U<<4)&51130563,U=(U^U<<2)&153391689,U);return(I(D)<<2)+(I(R)<<1)+I(T)},s=this.getProp("x"),i=this.getProp("y"),a=this.getProp("z"),{min:n,max:r}=e(s),{min:l,max:u}=e(i),{min:f,max:_}=e(a),g=n===r?0:1024/(r-n),y=l===u?0:1024/(u-l),v=f===_?0:1024/(_-f),x=new Map;for(let T=0;T<this.numSplats;T++){const R=Math.min(1023,Math.floor((s[T]-n)*g)),D=Math.min(1023,Math.floor((i[T]-l)*y)),I=Math.min(1023,Math.floor((a[T]-f)*v)),U=t(R,D,I),O=x.get(U);O?O.push(T):x.set(U,[T])}const C=Array.from(x.keys()).sort((T,R)=>T-R),M=new Uint32Array(this.numSplats);let w=0;for(let T=0;T<C.length;++T){const R=x.get(C[T]);for(let D=0;D<R.length;++D)M[w++]=R[D]}return M}reorder(e){const t=new Map,s=n=>{if(t.has(n)){const r=t.get(n);return t.delete(n),r}return new ArrayBuffer(n)},i=n=>{t.set(n.byteLength,n)},a=n=>{const r=new n.constructor(s(n.byteLength));for(let l=0;l<e.length;l++)r[l]=n[e[l]];return i(n.buffer),r};this.elements.forEach(n=>{n.properties.forEach(r=>{r.storage&&(r.storage=a(r.storage))})})}reorderData(){this.reorder(this.calcMortonOrder())}}const zP=(h={})=>{const e=h.dither??br,t=e!==br,s=new Yd({uniqueName:"SplatMaterial",vertexGLSL:h.vertex??dt.gsplatVS,fragmentGLSL:h.fragment??dt.gsplatPS,attributes:{vertex_position:kt,vertex_id_attrib:K0}});return s.setDefine(`DITHER_${e.toUpperCase()}`,""),s.cull=Xs,s.blendType=t?Gn:Wd,s.depthWrite=t,s.update(),s},jZ=(h,e)=>{const t=[];for(let s=0;s<e;++s)t.push(h.getProp(`f_rest_${s}`));return t};class ZU{constructor(e,t){const s=t.numSplats;this.device=e,this.numSplats=s,this.numSplatsVisible=s,this.centers=new Float32Array(t.numSplats*3),t.getCenters(this.centers),this.aabb=new wt,t.calcAabb(this.aabb);const i=this.evalTextureSize(s);this.colorTexture=this.createTexture("splatColor",Js,i),this.transformATexture=this.createTexture("transformA",kn,i),this.transformBTexture=this.createTexture("transformB",Js,i),this.updateColorData(t),this.updateTransformData(t),this.shBands=t.shBands,this.shBands>0&&(this.sh1to3Texture=this.createTexture("splatSH_1to3",kn,i),this.shBands>1&&(this.sh4to7Texture=this.createTexture("splatSH_4to7",kn,i),this.shBands>2?(this.sh8to11Texture=this.createTexture("splatSH_8to11",kn,i),this.sh12to15Texture=this.createTexture("splatSH_12to15",kn,i)):this.sh8to11Texture=this.createTexture("splatSH_8to11",Jd,i)),this.updateSHData(t))}destroy(){var e,t,s,i,a,n,r;(e=this.colorTexture)==null||e.destroy(),(t=this.transformATexture)==null||t.destroy(),(s=this.transformBTexture)==null||s.destroy(),(i=this.sh1to3Texture)==null||i.destroy(),(a=this.sh4to7Texture)==null||a.destroy(),(n=this.sh8to11Texture)==null||n.destroy(),(r=this.sh12to15Texture)==null||r.destroy()}createMaterial(e){const t=zP(e);return t.setParameter("splatColor",this.colorTexture),t.setParameter("transformA",this.transformATexture),t.setParameter("transformB",this.transformBTexture),t.setParameter("numSplats",this.numSplatsVisible),t.setDefine("SH_BANDS",this.shBands),this.sh1to3Texture&&t.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&t.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&t.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&t.setParameter("splatSH_12to15",this.sh12to15Texture),t}evalTextureSize(e){const t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new Ee(t,s)}createTexture(e,t,s){return new Ge(this.device,{name:e,width:s.x,height:s.y,format:t,cubemap:!1,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe})}updateColorData(e){const t=this.colorTexture;if(!t)return;const s=Xc.float2Half,i=t.lock(),a=e.getProp("f_dc_0"),n=e.getProp("f_dc_1"),r=e.getProp("f_dc_2"),l=e.getProp("opacity"),u=.28209479177387814;for(let f=0;f<this.numSplats;++f){const _=a[f]*u+.5,g=n[f]*u+.5,y=r[f]*u+.5,v=1/(1+Math.exp(-l[f]));i[f*4+0]=s(_),i[f*4+1]=s(g),i[f*4+2]=s(y),i[f*4+3]=s(v)}t.unlock()}updateTransformData(e){const t=Xc.float2Half;if(!this.transformATexture)return;const s=this.transformATexture.lock(),i=new Float32Array(s.buffer),a=this.transformBTexture.lock(),n=new H,r=new Ne,l=new H,u=e.createIter(n,r,l);for(let f=0;f<this.numSplats;f++)u.read(f),r.normalize(),r.w<0&&r.mulScalar(-1),i[f*4+0]=n.x,i[f*4+1]=n.y,i[f*4+2]=n.z,s[f*4+3]=t(r.x)|t(r.y)<<16,a[f*4+0]=t(l.x),a[f*4+1]=t(l.y),a[f*4+2]=t(l.z),a[f*4+3]=t(r.z);this.transformATexture.unlock(),this.transformBTexture.unlock()}updateSHData(e){var y,v,x,C,M,w;const t=this.sh1to3Texture.lock(),s=(y=this.sh4to7Texture)==null?void 0:y.lock(),i=(v=this.sh8to11Texture)==null?void 0:v.lock(),a=(x=this.sh12to15Texture)==null?void 0:x.lock(),n={1:3,2:8,3:15}[this.shBands],r=jZ(e,n*3),l=2047,u=1023,f=new Float32Array(1),_=new Uint32Array(f.buffer),g=new Array(n*3).fill(0);for(let T=0;T<e.numSplats;++T){for(let D=0;D<n;++D)g[D*3]=r[D][T],g[D*3+1]=r[D+n][T],g[D*3+2]=r[D+n*2][T];let R=g[0];for(let D=1;D<n*3;++D)R=Math.max(R,Math.abs(g[D]));if(R!==0){for(let D=0;D<n;++D)g[D*3+0]=Math.max(0,Math.min(l,Math.floor((g[D*3+0]/R*.5+.5)*l+.5))),g[D*3+1]=Math.max(0,Math.min(u,Math.floor((g[D*3+1]/R*.5+.5)*u+.5))),g[D*3+2]=Math.max(0,Math.min(l,Math.floor((g[D*3+2]/R*.5+.5)*l+.5)));f[0]=R,t[T*4+0]=_[0],t[T*4+1]=g[0]<<21|g[1]<<11|g[2],t[T*4+2]=g[3]<<21|g[4]<<11|g[5],t[T*4+3]=g[6]<<21|g[7]<<11|g[8],this.shBands>1&&(s[T*4+0]=g[9]<<21|g[10]<<11|g[11],s[T*4+1]=g[12]<<21|g[13]<<11|g[14],s[T*4+2]=g[15]<<21|g[16]<<11|g[17],s[T*4+3]=g[18]<<21|g[19]<<11|g[20],this.shBands>2?(i[T*4+0]=g[21]<<21|g[22]<<11|g[23],i[T*4+1]=g[24]<<21|g[25]<<11|g[26],i[T*4+2]=g[27]<<21|g[28]<<11|g[29],i[T*4+3]=g[30]<<21|g[31]<<11|g[32],a[T*4+0]=g[33]<<21|g[34]<<11|g[35],a[T*4+1]=g[36]<<21|g[37]<<11|g[38],a[T*4+2]=g[39]<<21|g[40]<<11|g[41],a[T*4+3]=g[42]<<21|g[43]<<11|g[44]):i[T]=g[21]<<21|g[22]<<11|g[23])}}this.sh1to3Texture.unlock(),(C=this.sh4to7Texture)==null||C.unlock(),(M=this.sh8to11Texture)==null||M.unlock(),(w=this.sh12to15Texture)==null||w.unlock()}}function YZ(){let h,e,t,s,i,a,n=!1;const r={x:0,y:0,z:0},l={x:0,y:0,z:0},u={x:0,y:0,z:0},f={x:0,y:0,z:0};let _,g;const y=32,v=new Array(y).fill(0),x=new Array(y).fill(0),C=new Array(y).fill(0),M=(T,R,D)=>{for(;T<=R;){const I=R+T>>1,U=D(I);if(U>0)T=I+1;else if(U<0)R=I-1;else return I}return~T},w=()=>{if(!h||!e||e.length===0||!i||!a)return;const T=i.x,R=i.y,D=i.z,I=a.x,U=a.y,O=a.z,N=.001;if(!n&&Math.abs(T-r.x)<N&&Math.abs(R-r.y)<N&&Math.abs(D-r.z)<N&&Math.abs(I-l.x)<N&&Math.abs(U-l.y)<N&&Math.abs(O-l.z)<N)return;n=!1,r.x=T,r.y=R,r.z=D,l.x=I,l.y=U,l.z=O;let z,X;for(let V=0;V<8;++V){const Q=V&1?u.x:f.x,se=V&2?u.y:f.y,J=V&4?u.z:f.z,ie=Q*I+se*U+J*O;V===0?z=X=ie:(z=Math.min(z,ie),X=Math.max(X,ie))}const Y=e.length/3,q=2**Math.max(10,Math.min(20,Math.round(Math.log2(Y/4))))+1;(_==null?void 0:_.length)!==Y&&(_=new Uint32Array(Y)),!g||g.length!==q?g=new Uint32Array(q):g.fill(0);const G=X-z;if(G<1e-6)for(let V=0;V<Y;++V)_[V]=0,g[0]++;else{const V=t.length/4;v.fill(0);for(let ie=0;ie<V;++ie){const oe=t[ie*4+0],he=t[ie*4+1],te=t[ie*4+2],le=t[ie*4+3],Se=oe*I+he*U+te*O-z,Ae=Math.max(0,Math.floor((Se-le)*y/G)),De=Math.min(y,Math.ceil((Se+le)*y/G));for(let Fe=Ae;Fe<De;++Fe)v[Fe]++}const Q=v.reduce((ie,oe)=>ie+oe,0);for(let ie=0;ie<y;++ie)C[ie]=v[ie]/Q*q>>>0;for(let ie=0;ie<y;++ie)x[ie]=ie===0?0:x[ie-1]+C[ie-1];const se=G/y;let J=0;for(let ie=0;ie<Y;++ie){const oe=e[J++],he=e[J++],te=e[J++],le=(oe*I+he*U+te*O-z)/se,Se=le>>>0,Ae=x[Se]+C[Se]*(le-Se)>>>0;_[ie]=Ae,g[Ae]++}}for(let V=1;V<q;V++)g[V]+=g[V-1];for(let V=0;V<Y;V++){const Q=_[V],se=--g[Q];h[se]=V}const W=T*I+R*U+D*O,k=V=>{let Q=h[V]*3;return e[Q++]*I+e[Q++]*U+e[Q]*O-W},K=()=>{const V=M(0,Y-1,Q=>-k(Q));return Math.min(Y,Math.abs(V))},ee=k(Y-1)>=0?K():Y;if(s)for(let V=0;V<Y;++V)h[V]=s[h[V]];self.postMessage({order:h.buffer,count:ee},[h.buffer]),h=null};self.onmessage=T=>{if(T.data.order&&(h=new Uint32Array(T.data.order)),T.data.centers)if(e=new Float32Array(T.data.centers),n=!0,T.data.chunks){const R=new Float32Array(T.data.chunks);t=new Float32Array(T.data.chunks,0,R.length*4/6),u.x=R[0],u.y=R[1],u.z=R[2],f.x=R[3],f.y=R[4],f.z=R[5];for(let D=0;D<R.length/6;++D){const I=R[D*6+0],U=R[D*6+1],O=R[D*6+2],N=R[D*6+3],z=R[D*6+4],X=R[D*6+5];t[D*4+0]=(I+N)*.5,t[D*4+1]=(U+z)*.5,t[D*4+2]=(O+X)*.5,t[D*4+3]=Math.sqrt((N-I)**2+(z-U)**2+(X-O)**2)*.5,I<u.x&&(u.x=I),U<u.y&&(u.y=U),O<u.z&&(u.z=O),N>f.x&&(f.x=N),z>f.y&&(f.y=z),X>f.z&&(f.z=X)}}else{const R=e.length/3,D=Math.ceil(R/256);t=new Float32Array(D*4),u.x=u.y=u.z=1/0,f.x=f.y=f.z=-1/0;let I,U,O,N,z,X;for(let Y=0;Y<D;++Y){I=U=O=1/0,N=z=X=-1/0;const F=Y*256,q=Math.min(R,(Y+1)*256);for(let G=F;G<q;++G){const W=e[G*3+0],k=e[G*3+1],K=e[G*3+2],ee=Number.isFinite(W),V=Number.isFinite(k),Q=Number.isFinite(K);ee||(e[G*3+0]=0),V||(e[G*3+1]=0),Q||(e[G*3+2]=0),!(!ee||!V||!Q)&&(W<I?I=W:W>N&&(N=W),k<U?U=k:k>z&&(z=k),K<O?O=K:K>X&&(X=K),W<u.x?u.x=W:W>f.x&&(f.x=W),k<u.y?u.y=k:k>f.y&&(f.y=k),K<u.z?u.z=K:K>f.z&&(f.z=K))}t[Y*4+0]=(I+N)*.5,t[Y*4+1]=(U+z)*.5,t[Y*4+2]=(O+X)*.5,t[Y*4+3]=Math.sqrt((N-I)**2+(z-U)**2+(X-O)**2)*.5}}T.data.hasOwnProperty("mapping")&&(s=T.data.mapping?new Uint32Array(T.data.mapping):null,n=!0),T.data.cameraPosition&&(i=T.data.cameraPosition),T.data.cameraDirection&&(a=T.data.cameraDirection),w()}}class KZ extends Qe{constructor(){super(),this.worker=new Worker(URL.createObjectURL(new Blob([`(${YZ.toString()})()`],{type:"application/javascript"}))),this.worker.onmessage=e=>{const t=e.data.order,s=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:s},[s]),this.orderTexture._levels[0]=new Uint32Array(t),this.orderTexture.upload(),this.fire("updated",e.data.count)}}destroy(){this.worker.terminate(),this.worker=null}init(e,t,s){this.orderTexture=e,this.centers=t.slice();const i=this.orderTexture.lock({mode:FD}).slice();this.orderTexture.unlock();for(let r=0;r<i.length;++r)i[r]=r;const a={order:i.buffer,centers:t.buffer,chunks:s==null?void 0:s.buffer},n=[i.buffer,t.buffer].concat(s?[s.buffer]:[]);this.worker.postMessage(a,n)}setMapping(e){if(e){const t=new Float32Array(e.length*3);for(let s=0;s<e.length;++s){const i=e[s]*3,a=s*3;t[a+0]=this.centers[i+0],t[a+1]=this.centers[i+1],t[a+2]=this.centers[i+2]}this.worker.postMessage({centers:t.buffer,mapping:e.buffer},[t.buffer,e.buffer])}else{const t=this.centers.slice();this.worker.postMessage({centers:t.buffer,mapping:null},[t.buffer])}}setCamera(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}})}}const QZ=new Me,gg=new H,yg=new H,RE=[0,0];class WC{constructor(e,t){var x;this.options={},this.sorter=null,this.lastCameraPosition=new H,this.lastCameraDirection=new H,this.cameras=[],this.splat=e,t=Object.assign(this.options,t);const s=e.device;this.orderTexture=this.splat.createTexture("splatOrder",Jd,this.splat.evalTextureSize(this.splat.numSplats)),this.createMaterial(t);const i=128,n=Math.ceil(e.numSplats/i)*i/i,r=new Uint32Array(n);for(let C=0;C<n;++C)r[C]=C*i;const l=new en(s,[{semantic:K0,components:1,type:Ai,asInt:!0}]),u=new jn(s,l,n,{usage:_r,data:r.buffer}),f=new Float32Array(12*i),_=new Uint32Array(6*i);for(let C=0;C<i;++C){f.set([-1,-1,C,1,-1,C,1,1,C,-1,1,C],C*12);const M=C*4;_.set([0+M,1+M,2+M,0+M,2+M,3+M],C*6)}const g=new Ft(s);g.setPositions(f,3),g.setIndices(_),g.update(),this.mesh=g,this.mesh.aabb.copy(e.aabb),this.meshInstance=new ps(this.mesh,this.material),this.meshInstance.setInstancing(u,!0),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;const y=e.centers.slice(),v=(x=e.chunks)==null?void 0:x.slice();(!t.dither||t.dither===br)&&(this.sorter=new KZ,this.sorter.init(this.orderTexture,y,v),this.sorter.on("updated",C=>{this.meshInstance.instancingCount=Math.ceil(C/i),this.material.setParameter("numSplats",C)}))}destroy(){var e,t,s;(e=this.material)==null||e.destroy(),(t=this.meshInstance)==null||t.destroy(),(s=this.sorter)==null||s.destroy()}clone(){return new WC(this.splat,this.options)}createMaterial(e){this.material=this.splat.createMaterial(e),this.material.setParameter("splatOrder",this.orderTexture),this.material.setParameter("alphaClip",.3),this.meshInstance&&(this.meshInstance.material=this.material)}updateViewport(e){var r;const t=e==null?void 0:e.camera,s=t==null?void 0:t.renderTarget,{width:i,height:a}=s??this.splat.device;RE[0]=i,RE[1]=a;const n=(r=t==null?void 0:t.camera)==null?void 0:r.xr;n!=null&&n.active&&n.views.list.length===2&&(RE[0]*=.5),this.material.setParameter("viewport",RE)}sort(e){if(this.sorter){const t=e.getWorldTransform();t.getTranslation(gg),t.getZ(yg);const s=this.meshInstance.node.getWorldTransform(),i=QZ.invert(s);i.transformPoint(gg,gg),i.transformVector(yg,yg),(!gg.equalsApprox(this.lastCameraPosition)||!yg.equalsApprox(this.lastCameraDirection))&&(this.lastCameraPosition.copy(gg),this.lastCameraDirection.copy(yg),this.sorter.setCamera(gg,yg))}this.updateViewport(e)}update(){if(this.cameras.length>0){const e=this.cameras[0];this.sort(e._node),this.cameras.length=0}}}const l0=.28209479177387814,$Z=`
	attribute vec2 vertex_position;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.0, 1.0);
	}
`,ZZ=`
	uniform usampler2D orderTexture;
	uniform sampler2D sourceTexture;
	uniform highp uint numSplats;
	void main(void) {
		uint w = uint(textureSize(sourceTexture, 0).x);
		uint idx = uint(gl_FragCoord.x) + uint(gl_FragCoord.y) * w;
		if (idx >= numSplats) discard;
		uint sidx = texelFetch(orderTexture, ivec2(gl_FragCoord.xy), 0).x;
		uvec2 suv = uvec2(sidx % w, sidx / w);
		gl_FragColor = texelFetch(sourceTexture, ivec2(suv), 0);
	}
`,gc=h=>h.read(0,0,h.width,h.height,{mipLevel:0,face:0,immediate:!0}),JZ=(h,e)=>{for(const t in e)h.resolve(t).setValue(e[t])};class eJ{constructor(e,t,s,i,a,n){const r=(D,I,U)=>D*(1-U)+I*U,{meta:l}=e,{means:u,scales:f,sh0:_,shN:g}=l,y=t&&e.means_l._levels[0],v=t&&e.means_u._levels[0],x=s&&e.quats._levels[0],C=i&&e.scales._levels[0],M=a&&e.sh0._levels[0],w=n&&e.sh_labels._levels[0],T=n&&e.sh_centroids._levels[0],R=2/Math.sqrt(2);this.read=D=>{if(t){const I=r(u.mins[0],u.maxs[0],((v[D*4+0]<<8)+y[D*4+0])/65535),U=r(u.mins[1],u.maxs[1],((v[D*4+1]<<8)+y[D*4+1])/65535),O=r(u.mins[2],u.maxs[2],((v[D*4+2]<<8)+y[D*4+2])/65535);t.x=Math.sign(I)*(Math.exp(Math.abs(I))-1),t.y=Math.sign(U)*(Math.exp(Math.abs(U))-1),t.z=Math.sign(O)*(Math.exp(Math.abs(O))-1)}if(s){const I=(x[D*4+0]/255-.5)*R,U=(x[D*4+1]/255-.5)*R,O=(x[D*4+2]/255-.5)*R,N=Math.sqrt(Math.max(0,1-(I*I+U*U+O*O)));switch(x[D*4+3]-252){case 0:s.set(I,U,O,N);break;case 1:s.set(N,U,O,I);break;case 2:s.set(U,N,O,I);break;case 3:s.set(U,O,N,I);break}}if(i){const I=r(f.mins[0],f.maxs[0],C[D*4+0]/255),U=r(f.mins[1],f.maxs[1],C[D*4+1]/255),O=r(f.mins[2],f.maxs[2],C[D*4+2]/255);i.set(I,U,O)}if(a){const I=r(_.mins[0],_.maxs[0],M[D*4+0]/255),U=r(_.mins[1],_.maxs[1],M[D*4+1]/255),O=r(_.mins[2],_.maxs[2],M[D*4+2]/255),N=r(_.mins[3],_.maxs[3],M[D*4+3]/255);a.set(.5+I*l0,.5+U*l0,.5+O*l0,1/(1+Math.exp(-N)))}if(n){const I=w[D*4+0]+(w[D*4+1]<<8),U=I%64*15,O=Math.floor(I/64);for(let N=0;N<3;++N)for(let z=0;z<15;++z)n[N*15+z]=r(g.mins,g.maxs,T[(U+z)*4+N+O*e.sh_centroids.width*4]/255)}}}}class JU{createIter(e,t,s,i,a){return new eJ(this,e,t,s,i,a)}calcAabb(e){const{mins:t,maxs:s}=this.meta.means,i=a=>Math.sign(a)*(Math.exp(Math.abs(a))-1);e.center.set((i(t[0])+i(s[0]))*.5,(i(t[1])+i(s[1]))*.5,(i(t[2])+i(s[2]))*.5),e.halfExtents.set((i(s[0])-i(t[0]))*.5,(i(s[1])-i(t[1]))*.5,(i(s[2])-i(t[2]))*.5)}getCenters(e){var C;const{meta:t,means_l:s,means_u:i,numSplats:a}=this,{means:n}=t,r=new Uint32Array(i._levels[0].buffer),l=new Uint32Array(s._levels[0].buffer),u=(C=this.orderTexture)==null?void 0:C._levels[0],f=n.mins[0]/65535,_=n.mins[1]/65535,g=n.mins[2]/65535,y=n.maxs[0]/65535,v=n.maxs[1]/65535,x=n.maxs[2]/65535;for(let M=0;M<a;M++){const w=u?u[M]:M,T=r[w],R=l[w],D=T<<8&65280|R&255,I=T&65280|R>>>8&255,U=T>>>8&65280|R>>>16&255,O=f*(65535-D)+y*D,N=_*(65535-I)+v*I,z=g*(65535-U)+x*U,X=O<0?-O:O,Y=N<0?-N:N,F=z<0?-z:z;e[M*3]=(O<0?-1:1)*(Math.exp(X)-1),e[M*3+1]=(N<0?-1:1)*(Math.exp(Y)-1),e[M*3+2]=(z<0?-1:1)*(Math.exp(F)-1)}}calcFocalPoint(e,t){e.set(0,0,0)}get isSogs(){return!0}get shBands(){var t;return{192:1,512:2,960:3}[(t=this.sh_centroids)==null?void 0:t.width]??0}async decompress(){const e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this,{means_l:s,means_u:i,quats:a,scales:n,sh0:r,sh_labels:l,sh_centroids:u}=this;if(s._levels[0]=await gc(s),i._levels[0]=await gc(i),a._levels[0]=await gc(a),n._levels[0]=await gc(n),r._levels[0]=await gc(r),l._levels[0]=await gc(l),u._levels[0]=await gc(u),t>0){const M=[];for(let w=0;w<45;++w)M.push(`f_rest_${w}`);e.splice(e.indexOf("f_dc_0")+1,0,...M)}const f={};e.forEach(M=>{f[M]=new Float32Array(this.numSplats)});const _=new H,g=new Ne,y=new H,v=new Ie,x=t>0?new Float32Array(45):null,C=this.createIter(_,g,y,v,x);for(let M=0;M<this.numSplats;++M)if(C.read(M),f.x[M]=_.x,f.y[M]=_.y,f.z[M]=_.z,f.rot_1[M]=g.x,f.rot_2[M]=g.y,f.rot_3[M]=g.z,f.rot_0[M]=g.w,f.scale_0[M]=y.x,f.scale_1[M]=y.y,f.scale_2[M]=y.z,f.f_dc_0[M]=(v.x-.5)/l0,f.f_dc_1[M]=(v.y-.5)/l0,f.f_dc_2[M]=(v.z-.5)/l0,f.opacity[M]=v.w<=0?-40:v.w>=1?40:-Math.log(1/v.w-1),x)for(let w=0;w<45;++w)f[`f_rest_${w}`][M]=x[w];return new Qd([{name:"vertex",count:this.numSplats,properties:e.map(M=>({name:M,type:"float",byteSize:4,storage:f[M]}))}])}reorderGpuMemory(){const{orderTexture:e,numSplats:t}=this,{device:s,height:i,width:a}=e,{scope:n}=s,r=Da(s,$Z,ZZ,"reorderShader",{vertex_position:kt});let l=new Ge(s,{width:a,height:i,format:Lt,mipmaps:!1});const u=["means_l","means_u","quats","scales","sh0","sh_labels"];s.setBlendState(ms.NOBLEND),s.setCullMode(Xs),s.setDepthState($i.NODEPTH),u.forEach(f=>{const _=this[f];if(!_)return;const g=new fs({colorBuffer:l,depth:!1,mipLevel:0});JZ(n,{orderTexture:e,sourceTexture:_,numSplats:t}),qn(s,g,r),this[f]=l,l.name=_.name,l._levels=_._levels,_._levels=[],l=_,g.destroy()}),l.destroy(),r.destroy()}calcMortonOrder(){const e=(l,u,f)=>{const _=g=>(g&=1023,g=(g^g<<16)&4278190335,g=(g^g<<8)&50393103,g=(g^g<<4)&51130563,g=(g^g<<2)&153391689,g);return(_(f)<<2)+(_(u)<<1)+_(l)},{means_l:t,means_u:s}=this,i=t._levels[0],a=s._levels[0],n=new BigUint64Array(this.numSplats);for(let l=0;l<this.numSplats;++l){const u=a[l*4+0]<<2|i[l*4+0]>>>6,f=a[l*4+1]<<2|i[l*4+1]>>>6,_=a[l*4+2]<<2|i[l*4+2]>>>6;n[l]=BigInt(e(u,f,_))<<BigInt(32)|BigInt(l)}n.sort();const r=new Uint32Array(t.width*t.height);for(let l=0;l<this.numSplats;++l)r[l]=Number(n[l]&BigInt(4294967295));return r}async reorderData(){const{device:e,height:t,width:s}=this.means_l;this.means_l._levels[0]=await gc(this.means_l),this.means_u._levels[0]=await gc(this.means_u),this.orderTexture=new Ge(e,{name:"orderTexture",width:s,height:t,format:Jd,mipmaps:!1,levels:[this.calcMortonOrder()]}),e.on("devicerestored",()=>{this.reorderGpuMemory()}),this.reorderGpuMemory()}}const tJ="NONE",kP="FILL_WINDOW",d3="KEEP_ASPECT",VA="AUTO",ez="FIXED";let tz;function rl(){return tz}function f3(h){tz=h}let QO=!1;const VP={app:null,createLoadingScreen(h){if(QO)return;QO=!0;const e=rl();h(e)}};class sJ{addRenderPass(e){e.frameUpdate();const t=e.beforePasses;for(let i=0;i<t.length;i++){const a=t[i];a.enabled&&this.addRenderPass(a)}e.enabled&&this.renderPasses.push(e);const s=e.afterPasses;for(let i=0;i<s.length;i++){const a=s[i];a.enabled&&this.addRenderPass(a)}}reset(){this.renderPasses.length=0}compile(){const e=this.renderTargetMap,t=this.renderPasses;for(let a=0;a<t.length;a++){const n=t[a],r=n.renderTarget;if(r!==void 0){const l=e.get(r);if(l){const u=n.colorArrayOps.length;for(let f=0;f<u;f++)n.colorArrayOps[f].clear||(l.colorArrayOps[f].store=!0);n.depthStencilOps.clearDepth||(l.depthStencilOps.storeDepth=!0),n.depthStencilOps.clearStencil||(l.depthStencilOps.storeStencil=!0)}e.set(r,n)}}for(let a=0;a<t.length-1;a++){const n=t[a],r=n.renderTarget,l=t[a+1],u=l.renderTarget;r!==u||r===void 0||l.depthStencilOps.clearDepth||l.depthStencilOps.clearStencil||l.colorArrayOps.some(f=>f.clear)||n.afterPasses.length>0||l.beforePasses.length>0||(n._skipEnd=!0,l._skipStart=!0)}let s=null,i=null;for(let a=0;a<t.length;a++){const n=t[a],r=n.renderTarget,l=r==null?void 0:r.colorBuffer;if(l!=null&&l.cubemap){if(s===l){const u=i.colorArrayOps.length;for(let f=0;f<u;f++)i.colorArrayOps[f].mipmaps=!1}s=r.colorBuffer,i=n}else n.requiresCubemaps&&(s=null,i=null)}e.clear()}render(e){this.compile();const t=this.renderPasses;for(let s=0;s<t.length;s++)t[s].render()}constructor(){this.renderPasses=[],this.renderTargetMap=new Map}}class iJ{constructor(e,t){this.texture0=e,this.texture1=t}destroy(){var e,t;(e=this.texture0)==null||e.destroy(),(t=this.texture1)==null||t.destroy()}}const $O=new Xn;class Up{static createTexture(e,t,s,i=""){return new Ge(e,{name:`AreaLightLUT${i}`,width:s,height:s,format:t,addressU:Oe,addressV:Oe,type:vr,magFilter:Vt,minFilter:Je,anisotropy:1,mipmaps:!1})}static applyTextures(e,t,s){$O.remove(e),$O.get(e,()=>new iJ(t,t===s?null:s)),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(e){const t=Up.createTexture(e,Js,2,"placeholder");t.lock().fill(0),t.unlock(),Up.applyTextures(e,t,t)}static set(e,t,s){function i(g,y,v){const x=Up.createTexture(g,v,64);return x.lock().set(y),x.unlock(),x}function a(g){const y=g.length,v=new Uint16Array(y),x=Xc.float2Half;for(let C=0;C<y;C++)v[C]=x(g[C]);return v}const n=t,r=s,l=a(n),u=a(r),f=i(e,l,Js),_=i(e,u,Js);Up.applyTextures(e,f,_)}}const GA="en-US",HA={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},GP={};function sf(h,e){for(let t=0,s=h.length;t<s;t++)GP[h[t]]=e}function Pc(h){const e=h.indexOf("-");return e!==-1?h.substring(0,e):h}function aJ(h,e){const t=h.indexOf("-");return t!==-1?e+h.substring(t):e}function sz(h,e){if(e[h])return h;let t=HA[h];if(t&&e[t])return t;const s=Pc(h);return t=HA[s],e[t]?t:e[s]?s:GA}sf(["ja","ko","th","vi","zh","id"],h=>0);sf(["fa","hi"],h=>h>=0&&h<=1?0:1);sf(["fr","pt"],h=>h>=0&&h<2?0:1);sf(["da"],h=>h===1||!Number.isInteger(h)&&h>=0&&h<=1?0:1);sf(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],h=>h===1?0:1);sf(["ru","uk"],h=>{if(Number.isInteger(h)){const e=h%10,t=h%100;if(e===1&&t!==11)return 0;if(e>=2&&e<=4&&(t<12||t>14))return 1;if(e===0||e>=5&&e<=9||t>=11&&t<=14)return 2}return 3});sf(["pl"],h=>{if(Number.isInteger(h)){if(h===1)return 0;const e=h%10,t=h%100;if(e>=2&&e<=4&&(t<12||t>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||t>=12&&t<=14)return 2}return 3});sf(["ar"],h=>{if(h===0)return 0;if(h===1)return 1;if(h===2)return 2;if(Number.isInteger(h)){const e=h%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5});const nJ=GP[Pc(GA)];function VR(h){return GP[h]||nJ}const _m=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i"),rJ="animation",oJ="audio",lJ="image",hJ="json",cJ="model",uJ="material",dJ="text",fJ="texture",pJ="textureatlas",mJ="cubemap",_J="shader",gJ="css",yJ="html",vJ="script",SJ="container";class bJ{constructor(e="",t="",s=null,i=null,a=null,n=null){this.url=e,this.filename=t,this.hash=s,this.size=i,this.opt=a,this.contents=n}equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}}let xJ=-1;const TJ={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},ZO=["pvr","dxt","etc2","etc1","basis"],uh=class uh extends Qe{constructor(e,t,s,i={},a={}){super(),this._file=null,this._i18n={},this._preload=!1,this._resources=[],this.id=xJ--,this.loaded=!1,this.loading=!1,this.options={},this.registry=null,this.tags=new Ib(this),this.urlObject=null,this._name=e||"",this.type=t,this._data=i||{},this.options=a||{},s&&(this.file=s)}set name(e){if(this._name===e)return;const t=this._name;this._name=e,this.fire("name",this,this._name,t)}get name(){return this._name}set file(e){var i,a;if(e&&e.variants&&["texture","textureatlas","bundle"].indexOf(this.type)!==-1){const n=((a=(i=this.registry)==null?void 0:i._loader)==null?void 0:a._app)||rl(),r=n==null?void 0:n.graphicsDevice;if(r)for(let l=0,u=ZO.length;l<u;l++){const f=ZO[l];if(e.variants[f]&&r[TJ[f]]){e=e.variants[f];break}if(n.enableBundles){const _=n.bundles.listBundlesForAsset(this);if(_&&_.find(g=>{var y;return(y=g==null?void 0:g.file)==null?void 0:y.variants[f]}))break}}}const t=this._file,s=e?new bJ(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!s!=!!t||s&&!s.equals(t))&&(this._file=s,this.fire("change",this,"file",s,t),this.reload())}get file(){return this._file}set data(e){const t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){const t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){const t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,(!this.hasOwnProperty("_loadFaces")||e!==this._loadFaces)&&(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!_m.test(t)&&(t=this.registry.prefix+t),this.type!=="script"&&e.hash){const s=t.indexOf("?")!==-1?"&":"?";t+=`${s}t=${e.hash}`}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;const t=bt.getDirectory(this.file.url);return bt.join(t,e)}getLocalizedAssetId(e){return e=sz(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){const t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",s=>{e.call(t,s)})}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&this._resources.length===0)return;this.fire("unload",this),this.registry.fire(`unload:${this.id}`,this);const e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t){const s=e[t];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(e,t,s,i=0){var a;(a=s==null?void 0:s.file)!=null&&a.contents?setTimeout(()=>{t(null,s.file.contents)}):Us.get(e,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},t)}};uh.EVENT_LOAD="load",uh.EVENT_UNLOAD="unload",uh.EVENT_REMOVE="remove",uh.EVENT_ERROR="error",uh.EVENT_CHANGE="change",uh.EVENT_PROGRESS="progress",uh.EVENT_ADDLOCALIZED="add:localized",uh.EVENT_REMOVELOCALIZED="remove:localized";let Ye=uh;class EJ{constructor(e=null){this._index={},this._key=e}addItem(e){const t=e.tags._list;for(const s of t)this.add(s,e)}removeItem(e){const t=e.tags._list;for(const s of t)this.remove(s,e)}add(e,t){this._index[e]&&this._index[e].list.indexOf(t)!==-1||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(!this._index[e]||this._key&&!this._index[e].keys[t[this._key]])return;const s=this._index[e].list.indexOf(t);s!==-1&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],this._index[e].list.length===0&&delete this._index[e])}find(e){const t={},s=[];let i,a,n,r,l;const u=(f,_)=>this._index[f].list.length-this._index[_].list.length;for(let f=0;f<e.length;f++){if(a=e[f],a instanceof Array){if(a.length===0)continue;if(a.length===1)a=a[0];else{l=!1;for(let _=0;_<a.length;_++)if(!this._index[a[_]]){l=!0;break}if(l)continue;n=a.slice(0).sort(u),r=n.slice(1),r.length===1&&(r=r[0]);for(let _=0;_<this._index[n[0]].list.length;_++)i=this._index[n[0]].list[_],(this._key?!t[i[this._key]]:s.indexOf(i)===-1)&&i.tags.has(r)&&(this._key&&(t[i[this._key]]=!0),s.push(i));continue}}if(a&&typeof a=="string"&&this._index[a])for(let _=0;_<this._index[a].list.length;_++)i=this._index[a].list[_],this._key?t[i[this._key]]||(t[i[this._key]]=!0,s.push(i)):s.indexOf(i)===-1&&s.push(i)}return s}}const jg=class jg extends Qe{constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new EJ("id"),this.prefix=null,this.bundles=null,this._loader=e}list(e={}){const t=Array.from(this._assets);return e.preload!==void 0?t.filter(s=>s.preload===e.preload):t}add(e){var t,s;this._assets.has(e)||(this._assets.add(e),this._idToAsset.set(e.id,e),(t=e.file)!=null&&t.url&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire(`add:${e.id}`,e),(s=e.file)!=null&&s.url&&this.fire(`add:url:${e.file.url}`,e),e.preload&&this.load(e))}remove(e){var t,s;if(!this._assets.has(e))return!1;if(this._assets.delete(e),this._idToAsset.delete(e.id),(t=e.file)!=null&&t.url&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){const i=this._nameToAsset.get(e.name);i.delete(e),i.size===0&&this._nameToAsset.delete(e.name)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire(`remove:${e.id}`,e),(s=e.file)!=null&&s.url&&this.fire(`remove:url:${e.file.url}`,e),!0}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if((e.loading||e.loaded)&&!(t!=null&&t.force))return;const s=e.file,i=()=>{this.fire("load",e),this.fire(`load:${e.id}`,e),s&&s.url&&this.fire(`load:url:${s.url}`,e),e.fire("load",e)},a=r=>{if(r instanceof Array?e.resources=r:e.resource=r,this._loader.patch(e,this),e.type==="bundle"){const l=e.data.assets;for(let u=0;u<l.length;u++){const f=this._idToAsset.get(l[u]);f&&!f.loaded&&this.load(f,{force:!0})}e.resource.loaded?i():(this.fire("load:start",e),this.fire(`load:start:${e.id}`,e),s&&s.url&&this.fire(`load:start:url:${s.url}`,e),e.fire("load:start",e),e.resource.on("load",i))}else i()},n=(r,l,u)=>{if(e.loaded=!0,e.loading=!1,r)this.fire("error",r,e),this.fire(`error:${e.id}`,r,e),e.fire("error",r,e);else{if(e.type==="script"){const f=this._loader.getHandler("script");f._cache[e.id]&&f._cache[e.id].parentNode===document.head&&document.head.removeChild(f._cache[e.id]),f._cache[e.id]=u}a(l)}};if(s||e.type==="cubemap"){this.fire("load:start",e),this.fire(`load:${e.id}:start`,e),e.loading=!0;const r=e.getFileUrl();if(e.type==="bundle"){const l=e.data.assets;for(let u=0;u<l.length;u++){const f=this._idToAsset.get(l[u]);f&&(f.loaded||f.resource||f.loading||(f.loading=!0))}}this._loader.load(r,e.type,n,e,t)}else{const r=this._loader.open(e.type,e.data);e.loaded=!0,a(r)}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s)}loadFromUrlAndFilename(e,t,s,i){const a=bt.getBasename(t||e),n={filename:t||a,url:e};let r=this.getByUrl(e);if(!r)r=new Ye(a,s,n),this.add(r);else if(r.loaded){i(r.loadFromUrlError||null,r);return}const l=u=>{u.once("load",f=>{s==="material"?this._loadTextures(f,(_,g)=>{i(_,f)}):i(null,f)}),u.once("error",f=>{f&&(this.loadFromUrlError=f),i(f,u)}),this.load(u)};r.resource?i(null,r):s==="model"?this._loadModel(r,l):l(r)}_loadModel(e,t){const s=e.getFileUrl(),i=bt.getExtension(s);if(i===".json"||i===".glb"){const a=bt.getDirectory(s),n=bt.getBasename(s),r=bt.join(a,n.replace(i,".mapping.json"));this._loader.load(r,"json",(l,u)=>{l?(e.data={mapping:[]},t(e)):this._loadMaterials(e,u,(f,_)=>{e.data=u,t(e)})})}else t(e)}_loadMaterials(e,t,s){const i=[];let a=0;const n=(r,l)=>{this._loadTextures(l,(u,f)=>{i.push(l),i.length===a&&s(null,i)})};for(let r=0;r<t.mapping.length;r++){const l=t.mapping[r].path;if(l){a++;const u=e.getAbsoluteUrl(l);this.loadFromUrl(u,"material",n)}}a===0&&s(null,i)}_loadTextures(e,t){const s=[];let i=0;const a=e.data;if(a.mappingFormat!=="path"){t(null,s);return}const n=(l,u)=>{l&&console.error(l),s.push(u),s.length===i&&t(null,s)},r=GC;for(let l=0;l<r.length;l++){const u=a[r[l]];if(u&&typeof u=="string"){i++;const f=e.getAbsoluteUrl(u);this.loadFromUrl(f,"texture",n)}}i===0&&t(null,s)}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}_onNameChange(e,t,s){if(this._nameToAsset.has(s)){const i=this._nameToAsset.get(s);i.delete(e),i.size===0&&this._nameToAsset.delete(s)}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e)}findByTag(...e){return this._tags.find(e)}filter(e){return Array.from(this._assets).filter(t=>e(t))}find(e,t){const s=this._nameToAsset.get(e);if(!s)return null;for(const i of s)if(!t||i.type===t)return i;return null}findAll(e,t){const s=this._nameToAsset.get(e);if(!s)return[];const i=Array.from(s);return t?i.filter(a=>a.type===t):i}};jg.EVENT_LOAD="load",jg.EVENT_ADD="add",jg.EVENT_REMOVE="remove",jg.EVENT_ERROR="error";let r1=jg;class iz{constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}_onAssetAdd(e){if(e.type==="bundle"){this._idToBundle.set(e.id,e),this._assets.on(`load:start:${e.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${e.id}`,this._onBundleLoad,this),this._assets.on(`error:${e.id}`,this._onBundleError,this);const t=e.data.assets;for(let s=0;s<t.length;s++)this._indexAssetInBundle(t[s],e)}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e)}_unbindAssetEvents(e){this._assets.off(`load:start:${e}`,this._onBundleLoadStart,this),this._assets.off(`load:${e}`,this._onBundleLoad,this),this._assets.off(`error:${e}`,this._onBundleError,this)}_indexAssetInBundle(e,t){let s=this._assetToBundles.get(e);s||(s=new Set,this._assetToBundles.set(e,s)),s.add(t);const i=this._assets.get(e);i&&this._indexAssetFileUrls(i)}_indexAssetFileUrls(e){const t=this._getAssetFileUrls(e);if(t)for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[s],i)}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;t=t.split("?")[0];const s=[t];if(e.type==="font"){const i=e.data.info.maps.length;for(let a=1;a<i;a++)s.push(t.replace(".png",`${a}.png`))}return s}_onAssetRemove(e){if(e.type==="bundle"){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);const t=e.data.assets;for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(t[s]);if(i&&(i.delete(e),i.size===0)){this._assetToBundles.delete(t[s]);for(const[a,n]of this._urlsToBundles)n===i&&this._urlsToBundles.delete(a)}}this._onBundleError(`Bundle ${e.id} was removed`)}else{if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);const s=this._getAssetFileUrls(e);if(!s)return;for(let i=0;i<s.length;i++)this._urlsToBundles.delete(s[i])}}_onBundleLoadStart(e){e.resource.on("add",(t,s)=>{const i=this._fileRequests.get(t);if(i){for(let a=0;a<i.length;a++)i[a](null,s);this._fileRequests.delete(t)}})}_onBundleLoad(e){if(!e.resource){this._onBundleError(`Bundle ${e.id} failed to load`);return}if(this._fileRequests)for(const[t,s]of this._fileRequests){const i=this._urlsToBundles.get(t);if(!i||!i.has(e))continue;const a=decodeURIComponent(t);let n,r;if(e.resource.has(a))r=e.resource.get(a);else if(e.resource.loaded)n=`Bundle ${e.id} does not contain URL ${t}`;else continue;for(let l=0;l<s.length;l++)s[l](n,n||r);this._fileRequests.delete(t)}}_onBundleError(e){for(const[t,s]of this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(t)){for(let a=0;a<s.length;a++)s[a](e);this._fileRequests.delete(t)}}_findLoadedOrLoadingBundleForUrl(e){const t=this._urlsToBundles.get(e);if(!t)return null;let s=null;for(const i of t){if(i.loaded&&i.resource)return i;i.loading&&(s=i)}return s}listBundlesForAsset(e){const t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){const s=this._findLoadedOrLoadingBundleForUrl(e);if(!s){t(`URL ${e} not found in any bundles`);return}if(s.loaded){const a=decodeURIComponent(e);if(s.resource.has(a)){t(null,s.resource.get(a));return}else if(s.resource.loaded){t(`Bundle ${s.id} does not contain URL ${e}`);return}}let i=this._fileRequests.get(e);i||(i=[],this._fileRequests.set(e,i)),i.push(t)}destroy(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(const e of this._idToBundle.keys())this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}}class az extends Qe{constructor(){super(),this.list=[]}add(e){const t=e.id;if(this[t])throw new Error(`ComponentSystem name '${t}' already registered or not allowed`);this[t]=e,this.list.push(e)}remove(e){const t=e.id;if(!this[t])throw new Error(`No ComponentSystem named '${t}' registered`);delete this[t];const s=this.list.indexOf(this[t]);s!==-1&&this.list.splice(s,1)}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy()}}const O2=class O2 extends Qe{addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t))}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear()}set loaded(e){!e||this._loaded||(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}constructor(...e){super(...e),this._index=new Map,this._loaded=!1}};O2.EVENT_ADD="add",O2.EVENT_LOAD="load";let WA=O2;class AJ extends Qe{constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then(s=>{this.pump(s.done,s.value)}).catch(s=>{this.fire("error",s)})}pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;const s=new Uint8Array(this.data.length+t.length);for(s.set(this.data),s.set(t,this.data.length),this.data=s;this.readFile(););return this.reader.read().then(i=>{this.pump(i.done,i.value)}).catch(i=>{this.fire("error",i)})}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;const e=new DataView(this.data.buffer,this.bytesRead,this.headerSize);this.decoder??(this.decoder=new TextDecoder("windows-1252"));const t=this.decoder.decode(e);if(this.fileName=t.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(t.substring(124,136),8),this.fileType=t.substring(156,157),this.ustarFormat=t.substring(257,263),this.ustarFormat.indexOf("ustar")!==-1){const s=t.substring(345,500).replace(/\0/g,"");s.length>0&&(this.fileName=s.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(this.fileType===""||this.fileType==="0"){const t=new DataView(this.data.buffer,this.bytesRead,this.fileSize),s={name:this.prefix+this.fileName,size:this.fileSize,data:t};this.fire("file",s)}this.bytesRead+=this.fileSize,this.headerRead=!1;const e=this.bytesRead%this.paddingSize;return e!==0&&(this.bytesRead+=this.paddingSize-e),!0}return!1}}class Ps{constructor(e,t){this.handlerType="",this._maxRetries=0,this._app=e,this.handlerType=t}set maxRetries(e){this._maxRetries=e}get maxRetries(){return this._maxRetries}load(e,t,s){}open(e,t,s){return t}patch(e,t){}}class nz extends Ps{constructor(e){super(e,"bundle"),this._assets=e.assets}_fetchRetries(e,t,s=0){return new Promise((i,a)=>{const n=()=>{fetch(e,t).then(i).catch(r=>{s++,s<this.maxRetries?n():a(r)})};n()})}load(e,t){typeof e=="string"&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors",credentials:"include"},this.maxRetries).then(s=>{const i=new WA;t(null,i);const a=new AJ(s,this._assets.prefix);a.on("file",n=>{i.addFile(n.name,n.data)}),a.on("done",()=>{i.loaded=!0}),a.on("error",n=>{t(n)})}).catch(s=>{t(s)})}open(e,t){return t}}class Yp{constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}static makeKey(e,t){return`${e}-${t}`}load(e,t,s,i,a){var l;const n=this._handlers[t];if(!n){const u=`No resource handler for asset type: '${t}' when loading [${e}]`;s(u);return}if(!e){this._loadNull(n,s,i);return}const r=Yp.makeKey(e,t);if(this._cache[r]!==void 0)s(null,this._cache[r]);else if(this._requests[r])this._requests[r].push(s);else{this._requests[r]=[s];const u=this,f=function(g,y){if(g){u._onFailure(r,g);return}if(y.load instanceof DataView){if(n.openBinary){if(!u._requests[r])return;try{const v=n.openBinary(y.load);u._onSuccess(r,v)}catch(v){u._onFailure(r,v)}return}y.load=URL.createObjectURL(new Blob([y.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=y.load)}n.load(y,(v,x,C)=>{if(u._requests[r]){if(v){u._onFailure(r,v);return}try{u._onSuccess(r,n.open(y.original,x,i),C)}catch(M){u._onFailure(r,M)}}},i)},_=e.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(_)&&!(a&&a.bundlesIgnore)){if(!this._app.bundles.urlIsLoadedOrLoading(_)){const g=this._app.bundles.listBundlesForAsset(i);let y;a&&a.bundlesFilter&&(y=a.bundlesFilter(g)),y||(g==null||g.sort((v,x)=>v.file.size-x.file.size),y=g==null?void 0:g[0]),y&&((l=this._app.assets)==null||l.load(y))}this._app.bundles.loadUrl(_,(g,y)=>{f(g,{load:y,original:_})})}else f(null,{load:e,original:i&&i.file.filename||e})}}_loadNull(e,t,s){const i=function(a,n,r){if(a)t(a);else try{t(null,e.open(null,n,s),r)}catch(l){t(l)}};e.load(null,i,s)}_onSuccess(e,t,s){t!==null?this._cache[e]=t:delete this._cache[e];for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e]}}open(e,t){const s=this._handlers[e];return s?s.open(null,t):(console.warn(`No resource handler found for: ${e}`),t)}patch(e,t){const s=this._handlers[e.type];if(!s){console.warn(`No resource handler found for: ${e.type}`);return}s.patch&&s.patch(e,t)}clearCache(e,t){const s=Yp.makeKey(e,t);delete this._cache[s]}getFromCache(e,t){const s=Yp.makeKey(e,t);if(this._cache[s])return this._cache[s]}enableRetry(e=5){e=Math.max(0,e)||0;for(const t in this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(const e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class CJ{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(e.header.version!==1)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(e.data){if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array')}else throw new Error('pc.I18n#addData: Missing "data" field');for(let t=0,s=e.data.length;t<s;t++){const i=e.data[t];if(!i.info)throw new Error(`pc.I18n#addData: missing "data[${t}].info" field`);if(!i.info.locale)throw new Error(`pc.I18n#addData: missing "data[${t}].info.locale" field`);if(typeof i.info.locale!="string")throw new Error(`pc.I18n#addData: "data[${t}].info.locale" must be a string`);if(!i.messages)throw new Error(`pc.I18n#addData: missing "data[${t}].messages" field`)}}parse(e){return e.data}}class rz extends Qe{constructor(e){super(),this.locale=GA,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new CJ}set assets(e){const t={};for(let i=0,a=e.length;i<a;i++){const n=e[i]instanceof Ye?e[i].id:e[i];t[n]=!0}let s=this._assets.length;for(;s--;){const i=this._assets[s];if(!t[i]){this._app.assets.off(`add:${i}`,this._onAssetAdd,this);const a=this._app.assets.get(i);a&&this._onAssetRemove(a),this._assets.splice(s,1)}}for(const i in t){const a=parseInt(i,10);if(this._assets.indexOf(a)!==-1)continue;this._assets.push(a);const n=this._app.assets.get(a);n?this._onAssetAdd(n):this._app.assets.once(`add:${a}`,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=Pc(e);if(t==="in"&&(t="id",e=aJ(e,t),this._locale===e))return;const s=this._locale;this._locale=e,this._lang=t,this._pluralFn=VR(this._lang),this.fire("set:locale",e,s)}get locale(){return this._locale}static findAvailableLocale(e,t){return sz(e,t)}findAvailableLocale(e){if(this._translations[e])return e;const t=Pc(e);return this._findFallbackLocale(e,t)}getText(e,t){let s=e,i;t||(t=this._locale,i=this._lang);let a=this._translations[t];return a||(i||(i=Pc(t)),t=this._findFallbackLocale(t,i),a=this._translations[t]),a&&a.hasOwnProperty(e)&&(s=a[e],Array.isArray(s)&&(s=s[0]),s==null&&(s=e)),s}getPluralText(e,t,s){let i=e,a,n;s?(a=Pc(s),n=VR(a)):(s=this._locale,a=this._lang,n=this._pluralFn);let r=this._translations[s];if(r||(s=this._findFallbackLocale(s,a),a=Pc(s),n=VR(a),r=this._translations[s]),r&&r[e]&&n){const l=n(t);i=r[e][l],i==null&&(i=e)}return i}addData(e){let t;try{t=this._parser.parse(e)}catch(s){console.error(s);return}for(let s=0,i=t.length;s<i;s++){const a=t[s],n=a.info.locale,r=a.messages;if(!this._translations[n]){this._translations[n]={};const l=Pc(n);this._availableLangs[l]||(this._availableLangs[l]=n)}Object.assign(this._translations[n],r),this.fire("data:add",n,r)}}removeData(e){let t;try{t=this._parser.parse(e)}catch(s){console.error(s);return}for(let s=0,i=t.length;s<i;s++){const a=t[s],n=a.info.locale,r=this._translations[n];if(!r)continue;const l=a.messages;for(const u in l)delete r[u];Object.keys(r).length===0&&(delete this._translations[n],delete this._availableLangs[Pc(n)]),this.fire("data:remove",n,l)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){let s=HA[e];return s&&this._translations[s]||(s=HA[t],s&&this._translations[s])||(s=this._availableLangs[t],s&&this._translations[s])?s:GA}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once(`add:${e.id}`,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}}class oz extends Qe{constructor(e){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=e}destroy(){this.app=null,this.off()}addSchema(e,t){t&&this._scriptSchemas.set(e,t)}getSchema(e){return this._scriptSchemas.get(e)}add(e){const t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout(()=>{if(e.prototype.swap){const s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire(`swap:${t}`,e)}else console.warn(`script registry already has '${t}' script, define 'swap' method for new script type to enable code hot swapping`)}),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire(`add:${t}`,e),setTimeout(()=>{if(!this._scripts.hasOwnProperty(t)||!this.app||!this.app.systems||!this.app.systems.script)return;const s=this.app.systems.script._components;let i;const a=[],n=[];for(s.loopIndex=0;s.loopIndex<s.length;s.loopIndex++){const r=s.items[s.loopIndex];if(r._scriptsIndex[t]&&r._scriptsIndex[t].awaiting){r._scriptsData&&r._scriptsData[t]&&(i=r._scriptsData[t].attributes);const l=r.create(t,{preloading:!0,ind:r._scriptsIndex[t].ind,attributes:i});l&&a.push(l);for(const u of r.scripts)r.initializeAttributes(u)}}for(let r=0;r<a.length;r++)a[r].enabled&&(a[r]._initialized=!0,n.push(a[r]),a[r].initialize&&a[r].initialize());for(let r=0;r<n.length;r++)!n[r].enabled||n[r]._postInitialized||(n[r]._postInitialized=!0,n[r].postInitialize&&n[r].postInitialize())}),!0)}remove(e){let t=e,s=e;if(typeof s!="string"?s=t.__name:t=this.get(s),this.get(s)!==t)return!1;delete this._scripts[s];const i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire(`remove:${s}`,t),!0}get(e){return this._scripts[e]||null}has(e){if(typeof e=="string")return this._scripts.hasOwnProperty(e);if(!e)return!1;const t=e.__name;return this._scripts[t]===e}list(){return this._list}}const wJ=(h,e)=>h.constructor.order-e.constructor.order,RJ=h=>h.sort(wJ),eS=[],lz=[],MJ=()=>lz.pop()??[],JO=h=>{h.length=0,lz.push(h)},N2=class N2 extends Jt{constructor(e,t=rl()){super(e),this.c={},this._destroying=!1,this._guid=null,this._template=!1,this._app=t}addComponent(e,t){const s=this._app.systems[e];return!s||this.c[e]?null:s.addComponent(this,t)}removeComponent(e){const t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){const t=this.findOne(s=>{var i;return(i=s.c)==null?void 0:i[e]});return t&&t.c[e]}findComponents(e){return this.find(t=>{var s;return(s=t.c)==null?void 0:s[e]}).map(t=>t.c[e])}findScript(e){const t=this.findOne(s=>{var i,a;return(a=(i=s.c)==null?void 0:i.script)==null?void 0:a.has(e)});return t==null?void 0:t.c.script.get(e)}findScripts(e){return this.find(s=>{var i,a;return(a=(i=s.c)==null?void 0:i.script)==null?void 0:a.has(e)}).map(s=>s.c.script.get(e))}getGuid(){return this._guid||this.setGuid(iF.create()),this._guid}setGuid(e){const t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){let s=!1;e===this&&eS.length===0&&(s=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&eS.push(e);const i=e._children;for(let a=0,n=i.length;a<n;a++)i[a]._enabled&&this._notifyHierarchyStateChanged(i[a],t);if(e._beingEnabled=!1,s){for(let a=0;a<eS.length;a++)eS[a]._onHierarchyStatePostChanged();eS.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);const t=this._getSortedComponents();for(let s=0;s<t.length;s++){const i=t[s];i.enabled&&(e?i.onEnable():i.onDisable())}JO(t)}_onHierarchyStatePostChanged(){const e=this._getSortedComponents();for(let t=0;t<e.length;t++)e[t].onPostStateChange();JO(e)}findByGuid(e){if(this._guid===e)return this;const t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){this._destroying=!0;for(const e in this.c)this.c[e].enabled=!1;for(const e in this.c)this.c[e].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,hz(this,this,t,e),t}_getSortedComponents(){const e=this.c,t=MJ();let s=0;for(const i in e)if(e.hasOwnProperty(i)){const a=e[i];s|=a.constructor.order!==0,t.push(a)}return s&&t.length>1&&RJ(t),t}_cloneRecursively(e){const t=new this.constructor(void 0,this._app);super._cloneInternal(t);for(const s in this.c)this.c[s].system.cloneComponent(this,t);for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof N2){const a=i._cloneRecursively(e);t.addChild(a),e[i.getGuid()]=a}}return t}};N2.EVENT_DESTROY="destroy";let Kt=N2;function hz(h,e,t,s){if(e instanceof Kt){const i=e.c;for(const r in i){const l=i[r],u=l.system.getPropertiesOfType("entity");for(let f=0,_=u.length;f<_;f++){const y=u[f].name,v=l[y];if(!!h.findByGuid(v)){const C=s[v].getGuid();C&&(t.c[r][y]=C)}}}i.script&&t.script.resolveDuplicatedEntityReferenceProperties(i.script,s),i.render&&t.render.resolveDuplicatedEntityReferenceProperties(i.render,s),i.button&&t.button.resolveDuplicatedEntityReferenceProperties(i.button,s),i.scrollview&&t.scrollview.resolveDuplicatedEntityReferenceProperties(i.scrollview,s),i.scrollbar&&t.scrollbar.resolveDuplicatedEntityReferenceProperties(i.scrollbar,s),i.anim&&t.anim.resolveDuplicatedEntityReferenceProperties(i.anim,s);const a=e.children.filter(r=>r instanceof Kt),n=t.children.filter(r=>r instanceof Kt);for(let r=0,l=a.length;r<l;r++)hz(h,a[r],n[r],s)}}class p3{constructor(e,t){this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=e,this.url=t}get loaded(){return!!this.data}get loading(){return this._loading}}class cz{constructor(e){this._list=[],this._index={},this._urlIndex={},this._app=e}destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;const s=new p3(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){const t=this._index[e];let s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(let i=0;i<this._list.length;i++)s=this._list[i],this._index[s.name]=i,this._urlIndex[s.url]=i}}_loadSceneData(e,t,s){const i=this._app;let a=e;if(typeof e=="string"&&(e=this.findByUrl(a)||this.find(a)||new p3("Untitled",a)),a=e.url,!a){s("Cannot find scene to load");return}if(e.loaded){s(null,e);return}i.assets&&i.assets.prefix&&!_m.test(a)&&(a=bt.join(i.assets.prefix,a)),e._onLoadedCallbacks.push(s),e._loading||i.loader.getHandler("hierarchy").load(a,(r,l)=>{e.data=l,e._loading=!1;for(let u=0;u<e._onLoadedCallbacks.length;u++)e._onLoadedCallbacks[u](r,e);t||(e.data=null),e._onLoadedCallbacks.length=0}),e._loading=!0}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){typeof e=="string"&&(e=this.findByUrl(e)),e&&(e.data=null)}_loadSceneHierarchy(e,t,s){this._loadSceneData(e,!1,(i,a)=>{if(i){s&&s(i);return}t&&t(a);const n=this._app,r=()=>{const l=n.loader.getHandler("hierarchy");n.systems.script.preloading=!0;const u=l.open(a.url,a.data);n.systems.script.preloading=!1,n.loader.clearCache(a.url,"hierarchy"),n.root.addChild(u),n.systems.fire("initialize",u),n.systems.fire("postInitialize",u),n.systems.fire("postPostInitialize",u),s&&s(null,u)};n._preloadScripts(a.data,r)})}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t)}loadSceneSettings(e,t){this._loadSceneData(e,!1,(s,i)=>{s?t&&t(s):(this._app.applySceneSettings(i.data.settings),t&&t(null))})}changeScene(e,t){const s=this._app,i=a=>{const{children:n}=s.root;for(;n.length;)n[0].destroy();s.applySceneSettings(a.data.settings)};this._loadSceneHierarchy(e,i,t)}loadScene(e,t){const s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!_m.test(e)&&(e=bt.join(s.assets.prefix,e)),i.load(e,(a,n)=>{if(a)t&&t(a);else{const r=()=>{s.systems.script.preloading=!0;const l=i.open(e,n),u=this.findByUrl(e);u&&!u.loaded&&(u.data=n),s.systems.script.preloading=!1,s.loader.clearCache(e,"scene"),s.loader.patch({resource:l,type:"scene"},s.assets),s.root.addChild(l.root),s.systems.rigidbody&&typeof Ammo<"u"&&s.systems.rigidbody.gravity.set(l._gravity.x,l._gravity.y,l._gravity.z),t&&t(null,l)};s._preloadScripts(n,r)}})}}class DJ{constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return rl().scene._stats}get lightmapper(){var e;return(e=rl().lightmapper)==null?void 0:e.stats}get batcher(){const e=rl()._batcher;return e?e._stats:null}}let HP=null;const Lp=class Lp extends Qe{constructor(e){super(),this._batcher=null,this._destroyRequested=!1,this._inFrameUpdate=!1,this._librariesLoaded=!1,this._fillMode=d3,this._resolutionMode=ez,this._allowResize=!0,this._skyboxAsset=null,this._entityIndex={},this._inTools=!1,this._scriptPrefix="",this._time=0,this.enableBundles=typeof TextDecoder<"u",this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new sJ,this.scriptsOrder=[],this.autoRender=!0,this.renderNextFrame=!1,this.lightmapper=null,this.loader=new Yp(this),this.scenes=new cz(this),this.scripts=new oz(this),this.systems=new az,this.i18n=new rz(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,Lp._applications[e.id]=this,f3(this),HP=this,this.root=new Kt,this.root._enabledInHierarchy=!0}init(e){const{assetPrefix:t,batchManager:s,componentSystems:i,elementInput:a,gamepads:n,graphicsDevice:r,keyboard:l,lightmapper:u,mouse:f,resourceHandlers:_,scriptsOrder:g,scriptPrefix:y,soundManager:v,touch:x,xr:C}=e;this.graphicsDevice=r,this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new DJ(r),this._soundManager=v,this.scene=new vn(r),this._registerSceneImmediate(this.scene),this.assets=new r1(this.loader),t&&(this.assets.prefix=t),this.bundles=new iz(this.assets),this.scriptsOrder=g||[],this.defaultLayerWorld=new Fi({name:"World",id:Ph}),this.defaultLayerDepth=new Fi({name:"Depth",id:yn,enabled:!1,opaqueSortMode:jp}),this.defaultLayerSkybox=new Fi({name:"Skybox",id:dm,opaqueSortMode:jp}),this.defaultLayerUi=new Fi({name:"UI",id:ty,transparentSortMode:gU}),this.defaultLayerImmediate=new Fi({name:"Immediate",id:hx,opaqueSortMode:jp});const M=new UA("default");M.pushOpaque(this.defaultLayerWorld),M.pushOpaque(this.defaultLayerDepth),M.pushOpaque(this.defaultLayerSkybox),M.pushTransparent(this.defaultLayerWorld),M.pushOpaque(this.defaultLayerImmediate),M.pushTransparent(this.defaultLayerImmediate),M.pushTransparent(this.defaultLayerUi),this.scene.layers=M,Up.createPlaceholder(r),this.renderer=new DP(r),this.renderer.scene=this.scene,u&&(this.lightmapper=new u(r,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),s&&(this._batcher=new s(r,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=l||null,this.mouse=f||null,this.touch=x||null,this.gamepads=n||null,a&&(this.elementInput=a,this.elementInput.app=this),this.xr=C?new C(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=y||"",this.enableBundles&&this.loader.addHandler("bundle",new nz(this)),_.forEach(w=>{const T=new w(this);this.loader.addHandler(T.handlerType,T)}),i.forEach(w=>{this.systems.add(new w(this))}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),typeof document<"u"&&(document.hidden!==void 0?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):document.mozHidden!==void 0?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):document.msHidden!==void 0?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):document.webkitHidden!==void 0&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=PJ(this)}static getApplication(e){return e?Lp._applications[e]:rl()}_initDefaultMaterial(){const e=new Vi;e.name="Default Material",AK(this.graphicsDevice,e)}_initProgramLibrary(){const e=new $U(this.graphicsDevice,new Vi);pK(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){Us.get(e,(s,i)=>{if(s){t(s);return}const a=i.application_properties,n=i.scenes,r=i.assets;this._parseApplicationProperties(a,l=>{this._parseScenes(n),this._parseAssets(r),t(l||null)})})}preload(e){this.fire("preload:start");const t=this.assets.list({preload:!0});if(t.length===0){this.fire("preload:end"),e();return}let s=0;const i=()=>{s++,this.fire("preload:progress",s/t.length),s===t.length&&(this.fire("preload:end"),e())};t.forEach(a=>{a.loaded?i():(a.once("load",i),a.once("error",i),this.assets.load(a))})}_preloadScripts(e,t){t()}_parseApplicationProperties(e,t){if(typeof e.maxAssetRetries=="number"&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){const s=new UA("application"),i={};for(const a in e.layers){const n=e.layers[a];n.id=parseInt(a,10),n.enabled=n.id!==yn,i[a]=new Fi(n)}for(let a=0,n=e.layerOrder.length;a<n;a++){const r=e.layerOrder[a],l=i[r.layer];l&&(r.transparent?s.pushTransparent(l):s.pushOpaque(l),s.subLayerEnabled[a]=r.enabled)}this.scene.layers=s}if(e.batchGroups){const s=this.batcher;if(s)for(let i=0,a=e.batchGroups.length;i<a;i++){const n=e.batchGroups[i];s.addGroup(n.name,n.dynamic,n.maxAabbSize,n.id,n.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){const s=e.length;let i=s;const a=/^https?:\/\//;if(s){const n=(r,l)=>{i--,r?t(r):i===0&&(this.onLibrariesLoaded(),t(null))};for(let r=0;r<s;++r){let l=e[r];!a.test(l.toLowerCase())&&this._scriptPrefix&&(l=bt.join(this._scriptPrefix,l)),this.loader.load(l,"script",n)}}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){const t=[],s={},i={};for(let a=0;a<this.scriptsOrder.length;a++){const n=this.scriptsOrder[a];e[n]&&(s[n]=!0,t.push(e[n]))}if(this.enableBundles)for(const a in e)e[a].type==="bundle"&&(i[a]=!0,t.push(e[a]));for(const a in e)s[a]||i[a]||t.push(e[a]);for(let a=0;a<t.length;a++){const n=t[a],r=new Ye(n.name,n.type,n.file,n.data);if(r.id=parseInt(n.id,10),r.preload=n.preload?n.preload:!1,r.loaded=n.type==="script"&&n.data&&n.data.loadingType>0,r.tags.add(n.tags),n.i18n)for(const l in n.i18n)r.addLocalizedAssetId(l,n.i18n[l]);this.assets.add(r)}}start(){this.frame=0,this.fire("start",{timestamp:oo(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}frameStart(){this.graphicsDevice.frameStart()}frameEnd(){this.graphicsDevice.frameEnd()}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(e,t,s){const i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;const t=this.graphicsDevice._primsPerFrame;e.triangles=t[al]/3+Math.max(t[hl]-2,0)+Math.max(t[wd]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let s=0;s<t.length;s++)s<al&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,e=this.stats.drawCalls,e.forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,e=this.stats.particles,e.updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s)}setCanvasResolution(e,t,s){this._resolutionMode=e,e===VA&&t===void 0&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(!this._allowResize||this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===d3){const a=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height,n=s/i;a>n?(e=s,t=e/a):(t=i,e=t*a)}else this._fillMode===kP&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=`${e}px`,this.graphicsDevice.canvas.style.height=`${t}px`,this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){var e;if(!(!this._allowResize||(e=this.xr)!=null&&e.active)&&this._resolutionMode===VA){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){let t;if(this.systems.rigidbody&&typeof Ammo<"u"){const[s,i,a]=e.physics.gravity;this.systems.rigidbody.gravity.set(s,i,a)}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox),t?this.setSkybox(t):this.assets.once(`add:${e.render.skybox}`,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(e,t){e&&t&&Up.set(this.graphicsDevice,e,t)}setSkybox(e){if(e!==this._skyboxAsset){const t=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off(`load:${this._skyboxAsset.id}`,s,this),this.assets.off(`remove:${this._skyboxAsset.id}`,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on(`load:${this._skyboxAsset.id}`,s,this),this.assets.once(`remove:${this._skyboxAsset.id}`,t,this),this._skyboxAsset.on("change",s,this),this.scene.skyboxMip===0&&!this._skyboxAsset.loadFaces&&(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){var e;(e=this.lightmapper)==null||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;(e=this.batcher)==null||e.generate()}_processTimestamp(e){return e}drawLine(e,t,s,i,a){this.scene.drawLine(e,t,s,i,a)}drawLines(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(e,t,s,i)}drawLineArrays(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,t,s,i)}drawWireSphere(e,t,s=xe.WHITE,i=20,a=!0,n=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,t,s,i,a,n)}drawWireAlignedBox(e,t,s=xe.WHITE,i=!0,a=this.scene.defaultDrawLayer,n){this.scene.immediate.drawWireAlignedBox(e,t,s,i,a,n)}drawMeshInstance(e,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,s,e,null,i)}drawQuad(e,t,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(e,t,s,i,a,n,r=this.scene.defaultDrawLayer,l=!0){if(l===!1&&!this.graphicsDevice.isWebGPU)return;const u=new Me;u.setTRS(new H(e,t,0),Ne.IDENTITY,new H(s,-i,0)),n||(n=new Yd,n.cull=Xs,n.setParameter("colorMap",a),n.shaderDesc=l?this.scene.immediate.getTextureShaderDesc(a.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),n.update()),this.drawQuad(u,n,r)}drawDepthTexture(e,t,s,i,a=this.scene.defaultDrawLayer){const n=new Yd;n.cull=Xs,n.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),n.update(),this.drawTexture(e,t,s,i,null,n,a)}destroy(){var i,a,n,r;if(this._inFrameUpdate){this._destroyRequested=!0;return}const e=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),typeof document<"u"&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const t=this.assets.list();for(let l=0;l<t.length;l++)t[l].unload(),t[l].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;const s=this.loader.getHandler("script");s==null||s.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,(i=this.lightmapper)==null||i.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,(a=this.xr)==null||a.end(),(n=this.xr)==null||n.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),(r=this._soundManager)==null||r.destroy(),this._soundManager=null,VP.app=null,Lp._applications[e]=null,rl()===this&&f3(null),Lp.cancelTick(this)}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}};Lp._applications={};let fo=Lp;const GR={},PJ=function(h){const e=h;return function(t,s){var l,u,f,_;if(!e.graphicsDevice)return;e.frameRequestId&&((u=(l=e.xr)==null?void 0:l.session)==null||u.cancelAnimationFrame(e.frameRequestId),cancelAnimationFrame(e.frameRequestId),e.frameRequestId=null),e._inFrameUpdate=!0,f3(e),HP=e;const i=e._processTimestamp(t)||oo(),a=i-(e._time||i);let n=a/1e3;if(n=ge.clamp(n,0,e.maxDeltaTime),n*=e.timeScale,e._time=i,(f=e.xr)!=null&&f.session?e.frameRequestId=e.xr.session.requestAnimationFrame(e.tick):e.frameRequestId=Ct.browser||Ct.worker?requestAnimationFrame(e.tick):null,e.graphicsDevice.contextLost)return;e._fillFrameStatsBasic(i,n,a),e.fire("frameupdate",a);let r=!0;s?(r=(_=e.xr)==null?void 0:_.update(s),e.graphicsDevice.defaultFramebuffer=s.session.renderState.baseLayer.framebuffer):e.graphicsDevice.defaultFramebuffer=null,r&&(e.update(n),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.updateCanvasSize(),e.frameStart(),e.render(),e.frameEnd(),e.renderNextFrame=!1),GR.timestamp=oo(),GR.target=e,e.fire("frameend",GR)),e._inFrameUpdate=!1,e._destroyRequested&&e.destroy()}};class uz{constructor(){this.componentSystems=[],this.resourceHandlers=[]}}const tS=new T1;class dz{constructor(e,t,s){this.scene=e,this.light=t,this.store(),t.numCascades=1,this.scene.clusteredLightingEnabled&&!s.shadowsEnabled&&(t.castShadows=!1),t.type!==ft&&(t._node.getWorldTransform(),t.getBoundingSphere(tS),this.lightBounds=new wt,this.lightBounds.center.copy(tS.center),this.lightBounds.halfExtents.set(tS.radius,tS.radius,tS.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows}restore(){const e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades,e._castShadows=this.castShadows}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(e){const t=this.light;t.enabled=!1,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null)}}const ME=new Ee;class LJ extends dz{constructor(e,t){super(e.scene,t,e.lightingParams)}get numVirtualLights(){return this.light.type===ft?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){const s=this.light;if(s._node.setLocalRotation(this.rotation),e>0){const n=s.bakeArea;vx.circlePointDeterministic(ME,e,t),ME.mulScalar(n*.5),s._node.rotateLocal(ME.x,0,ME.y)}s._node.getWorldTransform();const i=2.2,a=Math.pow(this.intensity,i);s.intensity=Math.pow(a/t,1/i)}}const e4=new H;class t4 extends dz{constructor(e){const t=e.scene,s=new Kt("AmbientLight");s.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:Un,color:xe.WHITE,intensity:1,bakeDir:!1}),super(t,s.light.light,e.lightingParams)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){vx.spherePointDeterministic(e4,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(e4.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=2.2,i=2*Math.PI*this.scene.ambientBakeSpherePart,a=Math.pow(i,s);this.light.intensity=Math.pow(a/t,1/s)}}class DE{constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}const s4=15;class IJ{constructor(e){this.device=e,this.shaderDilate=Da(e,dt.fullscreenQuadVS,o0.dilatePS,"lmDilate"),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=[],this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(e){this.constantTexSource.setValue(e)}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(e,t,s){const i=s?0:1;if(!this.shaderDenoise[i]){const a=`lmBilateralDeNoise-${s?"hdr":"rgbm"}`,n=s?`#define HDR
`:"";this.shaderDenoise[i]=Da(this.device,dt.fullscreenQuadVS,n+o0.bilateralDeNoisePS,a),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")}this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t)}getDenoise(e){const t=e?0:1;return this.shaderDenoise[t]}getDilate(e,t){const s=t?0:1;if(!this.shaderDilate[s]){const i=`lmDilate-${t?"hdr":"rgbm"}`,a=t?`#define HDR
`:"";this.shaderDilate[s]=Da(e,dt.fullscreenQuadVS,a+o0.dilatePS,i)}return this.shaderDilate[s]}evaluateDenoiseUniforms(e,t){function s(r,l){return .39894*Math.exp(-.5*r*r/(l*l))/l}this.kernel=this.kernel||new Float32Array(s4);const i=this.kernel,a=Math.floor((s4-1)/2);for(let r=0;r<=a;++r){const l=s(r,e);i[a+r]=l,i[a-r]=l}this.constantKernel.setValue(this.kernel);const n=1/s(0,t);this.bZnorm.setValue(n)}}class OJ extends pa{constructor(e,t,s,i,a,n){super(e),this.viewBindGroups=[],this.renderer=t,this.camera=s,this.worldClusters=i,this.receivers=a,this.lightArray=n}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}execute(){this.device;const{renderer:e,camera:t,receivers:s,renderTarget:i,worldClusters:a,lightArray:n}=this;e.renderForwardLayer(t,i,null,void 0,tf,this.viewBindGroups,{meshInstances:s,splitLights:n,lightClusters:a})}}const NJ=2048,FJ=0,BJ=1,PE=new H;class fz{constructor(e,t,s,i,a){this.device=e,this.root=t,this.scene=s,this.renderer=i,this.assets=a,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new xe,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){var e;yh.decRef(this.blackTex),this.blackTex=null,yh.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,(e=this.camera)==null||e.destroy(),this.camera=null}initBake(e){if(this.bakeHDR=this.scene.lightmapPixelFormat!==Lt,!this._initCalled){this._initCalled=!0,this.lightmapFilters=new IJ(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new Ge(this.device,{width:4,height:4,format:Lt,type:Eh,name:"lightmapBlack"}),yh.incRef(this.blackTex);const t=new hy;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=nl,t.aspectRatio=1,t.node=new Jt,this.camera=t,this.camera.shaderParams.gammaCorrection=Ch,this.camera.shaderParams.toneMapping=sy}if(this.scene.clusteredLightingEnabled){const t=new PP(e.supportsAreaLights,e.maxTextureSize,()=>{});this.lightingParams=t;const s=this.scene.lighting;t.shadowsEnabled=s.shadowsEnabled,t.shadowAtlasResolution=s.shadowAtlasResolution,t.cookiesEnabled=s.cookiesEnabled,t.cookieAtlasResolution=s.cookieAtlasResolution,t.areaLightsEnabled=s.areaLightsEnabled,t.cells=new H(3,3,3),t.maxLightsPerCell=4,this.worldClusters=new BA(e),this.worldClusters.name="ClusterLightmapper"}}finishBake(e){this.materials=[];function t(s){yh.decRef(s.colorBuffer),s.destroy()}this.renderTargets.forEach(s=>{t(s)}),this.renderTargets.clear(),e.forEach(s=>{s.renderTargets.forEach(i=>{t(i)}),s.renderTargets.length=0}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(e,t,s,i){const a=new Vi;if(a.name=`lmMaterial-pass:${s}-ambient:${i}`,a.chunks.APIVersion=aB,a.setDefine("UV1LAYOUT",""),s===FJ){let n=o0.bakeLmEndPS;i?n=`
										dDiffuseLight = ((dDiffuseLight - 0.5) * max(${t.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;
										dDiffuseLight += vec3(${t.ambientBakeOcclusionBrightness.toFixed(1)});
										dDiffuseLight = saturate(dDiffuseLight);
										dDiffuseLight *= dAmbientLight;
										${n}
								`:a.ambient=new xe(0,0,0),a.chunks.basePS=dt.basePS+(this.bakeHDR?"":`
#define LIGHTMAP_RGBM
`),a.chunks.endPS=n,a.lightMap=this.blackTex}else a.chunks.basePS=`
								#define STD_LIGHTMAP_DIR
								${dt.basePS}
								uniform float bakeDir;
						`,a.chunks.endPS=o0.bakeDirLmEndPS;return a.chunks.outputAlphaPS=`
`,a.cull=Xs,a.forceUv1=!0,a.update(),a}createMaterials(e,t,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(e,t,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,t,0,!0),this.ambientAOMaterial.onUpdateShader=function(i){return i.litOptions.lightMapWithoutAmbient=!0,i.litOptions.separateAmbient=!0,i})}createTexture(e,t){return new Ge(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:this.bakeHDR?vr:Eh,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe,name:t})}collectModels(e,t,s){var a,n,r;if(!e.enabled)return;let i;if((a=e.model)!=null&&a.model&&((n=e.model)!=null&&n.enabled)&&(s&&s.push(new DE(e)),e.model.lightmapped&&t&&(i=e.model.model.meshInstances)),(r=e.render)!=null&&r.enabled&&(s&&s.push(new DE(e)),e.render.lightmapped&&t&&(i=e.render.meshInstances)),i){let l=!0;for(let u=0;u<i.length;u++)if(!i[u].mesh.vertexBuffer.format.hasUv1){l=!1;break}if(l){const u=[];for(let f=0;f<i.length;f++){const _=i[f].mesh;this._tempSet.has(_)?t.push(new DE(e,[i[f]])):u.push(i[f]),this._tempSet.add(_)}this._tempSet.clear(),u.length>0&&t.push(new DE(e,u))}}for(let l=0;l<e._children.length;l++)this.collectModels(e._children[l],t,s)}prepareShadowCasters(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const a=e[s].meshInstances;for(let n=0;n<a.length;n++)a[n].visibleThisFrame=!0,t.push(a[n])}}return t}updateTransforms(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;for(let i=0;i<s.length;i++)s[i].node.getWorldTransform()}}calculateLightmapSize(e){let t;const s=this.scene.lightmapSizeMultiplier||16,i=PE;let a,n;e.model?(n=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data,t.area&&(a=t.area)):e.model._area&&(t=e.model,t._area&&(a=t._area))):e.render&&(n=e.render.lightmapSizeMultiplier,e.render.type!=="asset"&&e.render._area&&(t=e.render,t._area&&(a=t._area)));const r={x:1,y:1,z:1,uv:1};a&&(r.x=a.x,r.y=a.y,r.z=a.z,r.uv=a.uv);const l=n||1;r.x*=l,r.y*=l,r.z*=l;const u=e.render||e.model,f=this.computeNodeBounds(u.meshInstances);i.copy(f.halfExtents);let _=r.x*i.y*i.z+r.y*i.x*i.z+r.z*i.x*i.y;return _/=r.uv,_=Math.sqrt(_),Math.min(ge.nextPowerOfTwo(_*s),this.scene.lightmapMaxResolution||NJ)}setLightmapping(e,t,s,i){for(let a=0;a<e.length;a++){const n=e[a],r=n.meshInstances;for(let l=0;l<r.length;l++){const u=r[l];if(u.setLightmapped(t),t){i&&(u._shaderDefs|=i),u.mask=Xd;for(let f=0;f<s;f++){const _=n.renderTargets[f].colorBuffer;_.minFilter=Vt,_.magFilter=Vt,u.setRealtimeLightmap(ps.lightmapParamNames[f],_)}}}}}bake(e,t=fb){const s=this.device,i=oo();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const a=s._shaderStats.linked,n=s._renderTargetCreationTime,r=s._shaderStats.compileTime,l=[],u=[];if(e){for(let _=0;_<e.length;_++)this.collectModels(e[_],l,null);this.collectModels(this.root,null,u)}else this.collectModels(this.root,l,u);if(l.length>0){this.renderer.shadowRenderer.frameUpdate();const _=t===fb?2:1;this.setLightmapping(l,!1,_),this.initBake(s),this.bakeInternal(_,l,u);let g=OA;t===fb&&(g|=EP),this.scene.ambientBake&&(g|=AP),this.setLightmapping(l,!0,_,g),this.finishBake(l)}const f=oo();this.stats.totalRenderTime=f-i,this.stats.shadersLinked=s._shaderStats.linked-a,this.stats.compileTime=s._shaderStats.compileTime-r,this.stats.fboTime=s._renderTargetCreationTime-n,this.stats.lightmapCount=l.length}allocateTextures(e,t){for(let s=0;s<e.length;s++){const i=e[s],a=this.calculateLightmapSize(i.node);for(let n=0;n<t;n++){const r=this.createTexture(a,`lightmapper_lightmap_${s}`);yh.incRef(r),i.renderTargets[n]=new fs({colorBuffer:r,depth:!1})}if(!this.renderTargets.has(a)){const n=this.createTexture(a,`lightmapper_temp_lightmap_${a}`);yh.incRef(n),this.renderTargets.set(a,new fs({colorBuffer:n,depth:!1}))}}}prepareLightsToBake(e,t){if(this.scene.ambientBake){const i=new t4(this);t.push(i)}const s=this.renderer.lights;for(let i=0;i<s.length;i++){const a=s[i],n=new LJ(this,a);e.push(n),a.enabled&&(a.mask&Pd)!==0&&(a.mask=Pd|Xd|uo,a.shadowUpdateMode=a.type===ft?UC:qd,t.push(n))}t.sort()}restoreLights(e){for(let t=0;t<e.length;t++)e[t].restore()}setupScene(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.ambientLight.copy(this.ambientLight)}computeNodeBounds(e){const t=new wt;if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb)}return t}computeNodesBounds(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(s)}}computeBounds(e){const t=new wt;for(let s=0;s<e.length;s++){t.copy(e[0].aabb);for(let i=1;i<e.length;i++)t.add(e[i].aabb)}return t}backupMaterials(e){for(let t=0;t<e.length;t++)this.materials[t]=e[t].material}restoreMaterials(e){for(let t=0;t<e.length;t++)e[t].material=this.materials[t]}lightCameraPrepare(e,t){const s=t.light;let i;return s.type===Ns&&(i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=Ya,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=s._outerConeAngle*2,this.renderer.updateCameraFrustum(i)),i}lightCameraPrepareAndCull(e,t,s,i){const a=e.light;let n=!0;if(a.type===ft){PE.copy(i.center),PE.y+=i.halfExtents.y,this.camera.node.setPosition(PE),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=i.halfExtents.y*2;const r=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=r}else e.lightBounds.intersects(t.bounds)||(n=!1);if(a.type===Ns){let r=!1;const l=t.meshInstances;for(let u=0;u<l.length;u++)if(l[u]._isVisible(s)){r=!0;break}r||(n=!1)}return n}setupLightArray(e,t){e[ft].length=0,e[Ds].length=0,e[Ns].length=0,e[t.type][0]=t,t.visibleThisFrame=!0}renderShadowMap(e,t,s,i){const a=i.light,n=this.scene.clusteredLightingEnabled,r=a.castShadows&&(!n||this.scene.lighting.shadowsEnabled);if(!t&&r)if(!a.shadowMap&&!n&&(a.shadowMap=this.shadowMapCache.get(this.device,a)),a.type===ft){this.renderer._shadowRendererDirectional.cull(a,e,this.camera,s);const l=this.renderer._shadowRendererDirectional.getLightRenderPass(a,this.camera);l==null||l.render()}else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(a,e,s),this.renderer.shadowRenderer.render(a,this.camera,!1)}return!0}postprocessTextures(e,t,s){const a=this.lightmapFilters.getDilate(e,this.bakeHDR);let n;const r=this.scene.lightmapFilterEnabled;r&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),n=this.lightmapFilters.getDenoise(this.bakeHDR)),e.setBlendState(ms.NOBLEND),e.setDepthState($i.NODEPTH),e.setStencilState(null,null);for(let l=0;l<t.length;l++){const u=t[l];for(let f=0;f<s;f++){const _=u.renderTargets[f],g=_.colorBuffer,y=this.renderTargets.get(g.width),v=y.colorBuffer;this.lightmapFilters.prepare(g.width,g.height);for(let x=0;x<1;x++)this.lightmapFilters.setSourceTexture(g),qn(e,y,r&&f===0&&x===0?n:a),this.lightmapFilters.setSourceTexture(v),qn(e,_,a)}}}bakeInternal(e,t,s){const i=this.scene,a=i.layers,n=this.device,r=i.clusteredLightingEnabled;this.createMaterials(n,i,e),this.setupScene(),a._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(a);const l=[],u=[];this.prepareLightsToBake(l,u),this.updateTransforms(s);const f=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(f),this.renderer.gpuUpdate(f);const _=this.computeBounds(f);let g,y,v,x;for(g=0;g<t.length;g++)for(v=t[g].meshInstances,y=0;y<v.length;y++)x=v[y],x.setLightmapped(!1),x.mask=Pd,x.setRealtimeLightmap(ps.lightmapParamNames[0],this.blackTex),x.setRealtimeLightmap(ps.lightmapParamNames[1],this.blackTex);for(y=0;y<u.length;y++)u[y].light.enabled=!1;const C=[[],[],[]];let M,w,T=!1;for(g=0;g<u.length;g++){const R=u[g],D=R instanceof t4,I=R.light.type===ft;let U=R.numVirtualLights;e>1&&U>1&&R.light.bakeDir&&(U=1);for(let O=0;O<U;O++){U>1&&R.prepareVirtualLight(O,U),R.startBake();let N=!1;const z=this.lightCameraPrepare(n,R);for(w=0;w<t.length;w++){const X=t[w];if(v=X.meshInstances,!this.lightCameraPrepareAndCull(R,X,z,_))continue;this.setupLightArray(C,R.light);const F=I?[]:[R.light];for(r&&this.renderer.lightTextureAtlas.update(F,this.lightingParams),N=this.renderShadowMap(a,N,f,R),r&&this.worldClusters.update(F,this.lightingParams),this.backupMaterials(v),M=0;M<e&&!(M>0&&O>0||D&&M>0);M++){const q=X.renderTargets[M],G=X.renderTargets[M].colorBuffer.width,W=this.renderTargets.get(G),k=W.colorBuffer;M===0?T=i.updateShaders:T&&(i.updateShaders=!0);let K=this.passMaterials[M];for(D&&O+1===U&&M===0&&(K=this.ambientAOMaterial),y=0;y<v.length;y++)v[y].material=K;if(this.renderer.updateShaders(v),M===BJ&&this.constantBakeDir.setValue(R.light.bakeDir?1:0),n.isWebGPU){const ee=new OJ(n,this.renderer,this.camera,r?this.worldClusters:null,v,C);ee.init(W),ee.render(),ee.destroy()}else this.renderer.setCamera(this.camera,W,!0),r&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,W,v,C,tf),n.updateEnd();for(X.renderTargets[M]=W,this.renderTargets.set(G,q),y=0;y<v.length;y++)x=v[y],x.setRealtimeLightmap(ps.lightmapParamNames[M],k),x._shaderDefs|=OA}this.restoreMaterials(v)}R.endBake(this.shadowMapCache)}}for(this.postprocessTextures(n,t,e),w=0;w<s.length;w++)s[w].restore();this.restoreLights(l),this.restoreScene(),r||this.shadowMapCache.clear()}}const F2=class F2 extends Qe{constructor(e,t){super(),this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(s,i,a){this.fire(`set_${s}`,s,i,a)}),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(e,t){t.forEach(s=>{const i=typeof s=="object"?s.name:s;Object.defineProperty(e,i,{get:function(){return this.data[i]},set:function(a){const n=this.data,r=n[i];n[i]=a,this.fire("set",i,r,a)},configurable:!0})}),e._accessorsBuilt=!0}buildAccessors(e){F2._buildAccessors(this,e)}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){}get enabled(){return!0}};F2.order=0;let xt=F2;class ei extends Qe{constructor(e){super(),this.app=e,this.store={},this.schema=[]}addComponent(e,t={}){const s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){const t=this.id,s=this.store[e.getGuid()],i=e.c[t];i.fire("beforeremove"),this.fire("beforeremove",e,i),delete this.store[e.getGuid()],e[t]=void 0,delete e.c[t],this.fire("remove",e,s.data)}cloneComponent(e,t){const s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t={},s){for(let i=0,a=s.length;i<a;i++){const n=s[i];let r,l;typeof n=="object"?(r=n.name,l=n.type):(r=n,l=void 0);let u=t[r];u!==void 0?(l!==void 0&&(u=UJ(u,l)),e[r]=u):e[r]=e.data[r]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){const t=[];return(this.schema||[]).forEach(i=>{i&&typeof i=="object"&&i.type===e&&t.push(i)}),t}destroy(){this.off()}}function UJ(h,e){if(!h)return h;switch(e){case"rgb":return h instanceof xe?h.clone():new xe(h[0],h[1],h[2]);case"rgba":return h instanceof xe?h.clone():new xe(h[0],h[1],h[2],h[3]);case"vec2":return h instanceof Ee?h.clone():new Ee(h[0],h[1]);case"vec3":return h instanceof H?h.clone():new H(h[0],h[1],h[2]);case"vec4":return h instanceof Ie?h.clone():new Ie(h[0],h[1],h[2],h[3]);case"boolean":case"number":case"string":return h;case"entity":return h;default:throw new Error(`Could not convert unhandled type: ${e}`)}}const WP=0,qA=1,XA=2;class zJ{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(e,t){if(e<this._left||e>=this._right){const s=t.length;if(!s)this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0;else if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const i=this._findKey(e,t);this._left=t[i],this._right=t[i+1],this._len=this._right-this._left;const a=1/this._len;this._recip=isFinite(a)?a:0,this._p0=i,this._p1=i+1}}this._t=this._recip===0?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){let s=0;for(;e>=t[s+1];)s++;return s}eval(e,t,s){const i=s._data,a=s._components,n=this._p0*a;if(t===WP)for(let r=0;r<a;++r)e[r]=i[n+r];else{const r=this._t,l=this._p1*a;switch(t){case qA:for(let u=0;u<a;++u)e[u]=ge.lerp(i[n+u],i[l+u],r);break;case XA:{const u=this._hermite;if(!u.valid){const v=r*r,x=r+r,C=1-r,M=C*C;u.valid=!0,u.p0=(1+x)*M,u.m0=r*M,u.p1=v*(3-x),u.m1=v*(r-1)}const f=(this._p0*3+1)*a,_=(this._p0*3+2)*a,g=(this._p1*3+1)*a,y=(this._p1*3+0)*a;for(let v=0;v<a;++v)e[v]=u.p0*i[f+v]+u.m0*i[_+v]*this._len+u.p1*i[g+v]+u.m1*i[y+v]*this._len;break}}}}}class m3{constructor(e){this._name=`${e.name}Snapshot`,this._time=-1,this._cache=[],this._results=[];for(let i=0;i<e._inputs.length;++i)this._cache[i]=new zJ;const t=e._curves,s=e._outputs;for(let i=0;i<t.length;++i){const a=t[i],n=s[a._output],r=[];for(let l=0;l<n._components;++l)r[l]=0;this._results[i]=r}}}const Rb=class Rb{constructor(e,t,s,i,a,n){this._name=e.name,this._track=e,this._snapshot=new m3(e),this._playing=i,this._time=t,this._speed=s,this._loop=a,this._blendWeight=1,this._blendOrder=0,this._eventHandler=n,this.alignCursorToCurrentTime()}set name(e){this._name=e}get name(){return this._name}set track(e){this._track=e,this._snapshot=new m3(e)}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(e){const t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return this.nextEvent?this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e:!1}nextEventBehindTime(e){return this.nextEvent?e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e:!1}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(e){const t=Rb.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,{track:this.track,...this.nextEvent}),this.moveEventCursor()}fireNextEventInFrame(e,t){return this.nextEventAheadOfTime(e)&&this.nextEventBehindTime(t)?(this.fireNextEvent(),!0):!1}activeEventsForFrame(e,t){const s=Rb.eventFrame;this.clipFrameTime(t);const i=this.eventCursor;for(;this.fireNextEventInFrame(e,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){let t=this._time;const s=this._track.duration,i=this._speed,a=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(a?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(a?t=s+(t%s||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}};Rb.eventFrame={start:0,end:0,residual:0};let o1=Rb;const qP="NONE",pz="PREV_STATE",mz="NEXT_STATE",_z="PREV_STATE_NEXT_STATE",gz="NEXT_STATE_PREV_STATE",yz="GREATER_THAN",vz="LESS_THAN",Sz="GREATER_THAN_EQUAL_TO",bz="LESS_THAN_EQUAL_TO",xz="EQUAL_TO",Tz="NOT_EQUAL_TO",_3="INTEGER",g3="FLOAT",y3="BOOLEAN",gb="TRIGGER",Ez="1D",Az="2D_DIRECTIONAL",Cz="2D_CARTESIAN",wz="DIRECT",kg="START",jA="END",hd="ANY",l1=[kg,jA,hd],XP="OVERWRITE",Rz="ADDITIVE";class Ka{static dot(e,t){const s=e.length;let i=0;for(let a=0;a<s;++a)i+=e[a]*t[a];return i}static normalize(e){let t=Ka.dot(e,e);if(t>0){t=1/Math.sqrt(t);const s=e.length;for(let i=0;i<s;++i)e[i]*=t}}static set(e,t,s){const i=e.length;if(s==="quaternion"){let a=Ka.dot(t,t);a>0&&(a=1/Math.sqrt(a));for(let n=0;n<i;++n)e[n]=t[n]*a}else for(let a=0;a<i;++a)e[a]=t[a]}static blendVec(e,t,s,i){const a=i?1:1-s,n=e.length;for(let r=0;r<n;++r)e[r]=e[r]*a+t[r]*s}static blendQuat(e,t,s,i){const a=e.length,n=i?1:1-s;Ka.dot(e,t)<0&&(s=-s);for(let r=0;r<a;++r)e[r]=e[r]*n+t[r]*s;i||Ka.normalize(e)}static blend(e,t,s,i,a){i==="quaternion"?Ka.blendQuat(e,t,s,a):Ka.blendVec(e,t,s,a)}static stableSort(e,t){const s=e.length;for(let i=0;i<s-1;++i)for(let a=i+1;a<s;++a)if(t(e[a],e[i])){const n=e[i];e[i]=e[a],e[a]=n}}}const Ws=class Ws{constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===Ws.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&this.totalWeight===0||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:ge.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===XP&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(this.counter===0&&(Ka.set(this.value,Ws.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||Ka.blend(this.value,this.baseValue,1,this.valueType)),!(!this.mask[e]||this.getWeight(e)===0)){if(this._layerBlendType(e)===Rz&&!this._normalizeWeights)if(this.valueType===Ws.TYPE_QUAT){const s=Ws.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=Ws.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),a=Ws.q3.set(t[0],t[1],t[2],t[3]),n=i.invert().mul(a);n.slerp(Ne.IDENTITY,n,this.getWeight(e)),s.mul(n),Ws.quatArr[0]=s.x,Ws.quatArr[1]=s.y,Ws.quatArr[2]=s.z,Ws.quatArr[3]=s.w,Ka.set(this.value,Ws.quatArr,this.valueType)}else Ws.vecArr[0]=t[0]-this.baseValue[0],Ws.vecArr[1]=t[1]-this.baseValue[1],Ws.vecArr[2]=t[2]-this.baseValue[2],Ka.blend(this.value,Ws.vecArr,this.getWeight(e),this.valueType,!0);else Ka.blend(this.value,t,this.getWeight(e),this.valueType);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}};Ws.TYPE_QUAT="quaternion",Ws.TYPE_VEC3="vector3",Ws.q1=new Ne,Ws.q2=new Ne,Ws.q3=new Ne,Ws.quatArr=[0,0,0,1],Ws.vecArr=[0,0,0],Ws.IDENTITY_QUAT_ARR=[0,0,0,1];let yb=Ws;class jP{constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(e){const t=this._targets,s=this._binder,i=e.track.curves,a=e.snapshot,n=[],r=[];for(let l=0;l<i.length;++l){const f=i[l].paths;for(let _=0;_<f.length;++_){const g=f[_],y=s.resolve(g);let v=t[y&&y.targetPath||null];if(!v&&y){v={target:y,value:[],curves:0,blendCounter:0};for(let x=0;x<v.target.components;++x)v.value.push(0);if(t[y.targetPath]=v,s.animComponent){if(!s.animComponent.targets[y.targetPath]){let x;y.targetPath.substring(y.targetPath.length-13)==="localRotation"?x=yb.TYPE_QUAT:x=yb.TYPE_VEC3,s.animComponent.targets[y.targetPath]=new yb(s.animComponent,x)}s.animComponent.targets[y.targetPath].layerCounter++,s.animComponent.targets[y.targetPath].setMask(s.layerIndex,1)}}v&&(v.curves++,n.push(a._results[l]),r.push(v))}}this._clips.push(e),this._inputs.push(n),this._outputs.push(r)}removeClip(e){const t=this._targets,s=this._binder,i=this._clips,n=i[e].track.curves;for(let r=0;r<n.length;++r){const u=n[r].paths;for(let f=0;f<u.length;++f){const _=u[f],g=this._binder.resolve(_);g&&(g.curves--,g.curves===0&&(s.unresolve(_),delete t[g.targetPath],s.animComponent&&s.animComponent.targets[g.targetPath].layerCounter--))}}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(e,t){this._clips.forEach(s=>{s.name.includes(e)&&(s.track=t)}),this.rebind()}findClip(e){const t=this._clips;for(let s=0;s<t.length;++s){const i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};const e=[...this.clips];this.removeClips(),e.forEach(t=>{this.addClip(t)})}assignMask(e){return this._binder.assignMask(e)}update(e,t=!0){const s=this._clips,i=s.map((r,l)=>l);Ka.stableSort(i,(r,l)=>s[r].blendOrder<s[l].blendOrder);for(let r=0;r<i.length;++r){const l=i[r],u=s[l],f=this._inputs[l],_=this._outputs[l],g=u.blendWeight;if(g>0&&u._update(e),!t)break;let y,v,x;if(g>=1)for(let C=0;C<f.length;++C)y=f[C],v=_[C],x=v.value,Ka.set(x,y,v.target.type),v.blendCounter++;else if(g>0)for(let C=0;C<f.length;++C)y=f[C],v=_[C],x=v.value,v.blendCounter===0?Ka.set(x,y,v.target.type):Ka.blend(x,y,g,v.target.type),v.blendCounter++}const a=this._targets,n=this._binder;for(const r in a)if(a.hasOwnProperty(r)){const l=a[r];if(n.animComponent&&l.target.isTransform){const u=n.animComponent.targets[r];u.counter===u.layerCounter&&(u.counter=0),u.path||(u.path=r,u.baseValue=l.target.get(),u.setter=l.target.set),u.updateValue(n.layerIndex,l.value),u.counter++}else l.target.set(l.value);l.blendCounter=0}this._binder.update(e)}}class YP{constructor(e){this._events=[...e],this._events.sort((t,s)=>t.time-s.time)}get events(){return this._events}}const B2=class B2{constructor(e,t,s,i,a,n=new YP([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=a,this._animEvents=n}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;const s=this._inputs,i=this._outputs,a=this._curves,n=t._cache,r=t._results;for(let l=0;l<s.length;++l)n[l].update(e,s[l]._data);for(let l=0;l<a.length;++l){const u=a[l],f=i[u._output],_=r[l];n[u._input].eval(_,u._interpolation,f)}}};B2.EMPTY=Object.freeze(new B2("empty",Number.MAX_VALUE,[],[],[]));let wh=B2;class zp{static joinPath(e,t){t=t||".";const s=function(i){return i.replace(/\\/g,"\\\\").replace(new RegExp(`\\${t}`,"g"),`\\${t}`)};return e.map(s).join(t)}static splitPath(e,t){t=t||".";const s=[];let i="",a=0;for(;a<e.length;){let n=e[a++];n==="\\"&&a<e.length?(n=e[a++],n==="\\"||n===t?i+=n:i+=`\\${n}`):n===t?(s.push(i),i=""):i+=n}return i.length>0&&s.push(i),s}static encode(e,t,s){return`${Array.isArray(e)?e.join("/"):e}/${t}/${Array.isArray(s)?s.join("/"):s}`}resolve(e){return null}unresolve(e){}update(e){}}class YA{constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform=this._targetPath.substring(this._targetPath.length-13)==="localRotation"||this._targetPath.substring(this._targetPath.length-13)==="localPosition"||this._targetPath.substring(this._targetPath.length-10)==="localScale"}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class zc{constructor(e){if(this._isPathInMask=(a,n)=>{const r=this._mask[a];if(r){if(r.children||n&&r.value!==!1)return!0}else return!1;return!1},this.graph=e,!e)return;this._mask=null;const t={},s=function(a){t[a.name]=a;for(let n=0;n<a.children.length;++n)s(a.children[n])};s(e),this.nodes=t,this.targetCache={};const i=function(a){let n=a;for(;n&&!(n instanceof Kt);)n=n.parent;let r;return n&&(n.render?r=n.render.meshInstances:n.model&&(r=n.model.meshInstances)),r};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(a){const n=a.localPosition,r=function(l){n.set(...l)};return zc.createAnimTarget(r,"vector",3,a,"localPosition")},localRotation:function(a){const n=a.localRotation,r=function(l){n.set(...l)};return zc.createAnimTarget(r,"quaternion",4,a,"localRotation")},localScale:function(a){const n=a.localScale,r=function(l){n.set(...l)};return zc.createAnimTarget(r,"vector",3,a,"localScale")},weight:function(a,n){n.indexOf("name.")===0?n=n.replace("name.",""):n=Number(n);const r=i(a);let l;if(r){for(let u=0;u<r.length;++u)if(r[u].node.name===a.name&&r[u].morphInstance){const f=r[u].morphInstance,_=g=>{f.setWeight(n,g[0])};l||(l=[]),l.push(_)}}if(l){const u=f=>{for(let _=0;_<l.length;++_)l[_](f)};return zc.createAnimTarget(u,"number",1,a,`weight.${n}`)}return null},materialTexture:(a,n)=>{const r=i(a);if(r){let l;for(let u=0;u<r.length;++u)if(r[u].node.name===a.name){l=r[u];break}if(l){const u=f=>{const _=this.animComponent.system.app.assets.get(f[0]);_&&_.resource&&_.type==="texture"&&(l.material[n]=_.resource,l.material.update())};return zc.createAnimTarget(u,"vector",1,a,"materialTexture","material")}}return null}}}_isPathActive(e){if(!this._mask)return!0;const t=[e.entityPath[0],this.graph.name];for(let s=0;s<t.length;++s){let i=t[s];if(this._isPathInMask(i,e.entityPath.length===1))return!0;for(let a=1;a<e.entityPath.length;a++)if(i+=`/${e.entityPath[a]}`,this._isPathInMask(i,a===e.entityPath.length-1))return!0}return!1}findNode(e){if(!this._isPathActive(e))return null;let t;return this.graph&&(t=this.graph.findByPath(e.entityPath),t||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t}static createAnimTarget(e,t,s,i,a,n){const r=zp.encode(i.path,n||"entity",a);return new YA(e,t,s,r)}resolve(e){const t=zp.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;const i=this.findNode(e);if(!i)return null;const a=this.handlers[e.propertyPath];return!a||(s=a(i),!s)?null:(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s)}unresolve(e){if(e.component!=="graph")return;const t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,this.nodeCounts[t.path]===0){const s=this.activeNodes,i=s.indexOf(t.node),a=s.length;i<a-1&&(s[i]=s[a-1]),s.pop()}}update(e){const t=this.activeNodes;for(let s=0;s<t.length;++s)t[s]._dirtifyLocal()}assignMask(e){return e!==this._mask?(this._mask=e,!0):!1}}class KP extends xt{set animations(e){this._animations=e,this.onSetAnimations()}get animations(){return this._animations}set assets(e){const t=this._assets;if(t&&t.length){for(let i=0;i<t.length;i++)if(t[i]){const a=this.system.app.assets.get(t[i]);if(a){a.off("change",this.onAssetChanged,this),a.off("remove",this.onAssetRemoved,this);const n=this.animationsIndex[a.id];this.currAnim===n&&this._stopCurrentAnimation(),delete this.animations[n],delete this.animationsIndex[a.id]}}}this._assets=e;const s=e.map(i=>i instanceof Ye?i.id:i);this.loadAnimationAssets(s)}get assets(){return this._assets}set currentTime(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){const t=this.animEvaluator.clips;for(let s=0;s<t.length;++s)t[s].time=e}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){const e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.currAnim?this.animations[this.currAnim].duration:0}set loop(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e}get loop(){return this._loop}play(e,t=0){if(!(!this.enabled||!this.entity.enabled)&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){!this.skeleton&&!this.animEvaluator&&this._createAnimationController();const s=this.animations[this.prevAnim],i=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=s,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=i):this.skeleton.animation=i),this.animEvaluator){const a=this.animEvaluator;if(this.blending)for(;a.clips.length>1;)a.removeClip(0);else this.animEvaluator.removeClips();const n=new o1(this.animations[this.currAnim],0,1,!0,this.loop);n.name=this.currAnim,n.blendWeight=this.blending?0:1,n.reset(),this.animEvaluator.addClip(n)}}this.playing=!0}}getAnimation(e){return this.animations[e]}setModel(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim))}onSetAnimations(){const e=this.entity.model;if(e){const t=e.model;t&&t!==this.model&&this.setModel(t)}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){const t=Object.keys(this._animations);t.length>0&&this.play(t[0])}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}_createAnimationController(){const e=this.model,t=this.animations;let s=!1,i=!1;for(const n in t)t.hasOwnProperty(n)&&(t[n].constructor===wh?i=!0:s=!0);const a=e.getGraph();s?(this.fromSkel=new gA(a),this.toSkel=new gA(a),this.skeleton=new gA(a),this.skeleton.looping=this.loop,this.skeleton.setGraph(a)):i&&(this.animEvaluator=new jP(new zc(this.entity)))}loadAnimationAssets(e){if(!e||!e.length)return;const t=this.system.app.assets,s=a=>{if(a.resources.length>1)for(let n=0;n<a.resources.length;n++)this.animations[a.resources[n].name]=a.resources[n],this.animationsIndex[a.id]=a.resources[n].name;else this.animations[a.name]=a.resource,this.animationsIndex[a.id]=a.name;this.animations=this.animations},i=a=>{a.off("change",this.onAssetChanged,this),a.on("change",this.onAssetChanged,this),a.off("remove",this.onAssetRemoved,this),a.on("remove",this.onAssetRemoved,this),a.resource?s(a):(a.once("load",s,this),this.enabled&&this.entity.enabled&&t.load(a))};for(let a=0,n=e.length;a<n;a++){const r=t.get(e[a]);r?i(r):t.on(`add:${e[a]}`,i)}}onAssetChanged(e,t,s,i){if(t==="resource"||t==="resources")if(t==="resources"&&s&&s.length===0&&(s=null),s){let a=!1;if(s.length>1){if(i&&i.length>1)for(let n=0;n<i.length;n++)delete this.animations[i[n].name];else delete this.animations[e.name];a=!1;for(let n=0;n<s.length;n++)this.animations[s[n].name]=s[n],!a&&this.currAnim===s[n].name&&this.playing&&this.enabled&&this.entity.enabled&&(a=!0,this.play(s[n].name));a||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let n=0;n<i.length;n++)delete this.animations[i[n].name];this.animations[e.name]=s[0]||s,a=!1,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(a=!0,this.play(e.name)),a||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[e.id]=e.name}else{if(i.length>1)for(let a=0;a<i.length;a++)delete this.animations[i[a].name],this.currAnim===i[a].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}onAssetRemoved(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=!1,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips()}}onEnable(){super.onEnable();const e=this.assets,t=this.system.app.assets;if(e)for(let s=0,i=e.length;s<i;s++){let a=e[s];a instanceof Ye||(a=t.get(a)),a&&!a.resource&&t.load(a)}if(this.activate&&!this.currAnim){const s=Object.keys(this.animations);s.length>0&&this.play(s[0])}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];typeof t=="number"&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}update(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){const s=this.skeleton;if(s!==null&&this.model!==null){if(this.blending)s.blend(this.fromSkel,this.toSkel,this.blend);else{const i=e*this.speed;s.addTime(i),this.speed>0&&s._time===s.animation.duration&&!this.loop?this.playing=!1:this.speed<0&&s._time===0&&!this.loop&&(this.playing=!1)}this.blending&&this.blend===1&&(s.animation=this.toSkel.animation),s.updateGraph()}}const t=this.animEvaluator;if(t){for(let s=0;s<t.clips.length;++s){const i=t.clips[s];i.speed=this.speed,this.playing?i.resume():i.pause()}this.blending&&t.clips.length>1&&(t.clips[1].blendWeight=this.blend),t.update(e)}this.blending&&this.blend===1&&(this.blending=!1)}constructor(...e){super(...e),this._animations={},this._assets=[],this._loop=!0,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=!1,this.blendSpeed=0,this.activate=!0,this.speed=1}}class kJ{constructor(){this.enabled=!0}}const v3=["enabled"];class Mz extends ei{constructor(e){super(e),this.id="animation",this.ComponentType=KP,this.DataType=kJ,this.schema=v3,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["activate","enabled","loop","speed","assets"];for(const i of s)t.hasOwnProperty(i)&&(e[i]=t[i]);super.initializeComponentData(e,t,v3)}cloneComponent(e,t){this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.speed=e.animation.speed,t.animation.loop=e.animation.loop,t.animation.activate=e.animation.activate,t.animation.enabled=e.animation.enabled;const s={},i=e.animation.animations;for(const r in i)i.hasOwnProperty(r)&&(s[r]=i[r]);t.animation.animations=s;const a={},n=e.animation.animationsIndex;for(const r in n)n.hasOwnProperty(r)&&(a[r]=n[r]);return t.animation.animationsIndex=a,t.animation}onBeforeRemove(e,t){t.onBeforeRemove()}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];i.data.enabled&&i.entity.enabled&&i.entity.animation.update(e)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}xt._buildAccessors(KP.prototype,v3);class h1{constructor(e,t,s,i,a=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new Ee(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=a,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?`${this._parent.path}.${this._name}`:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const e=this._state.totalWeight;return e===0?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}}class dy extends h1{constructor(e,t,s,i,a,n,r,l,u){super(e,t,s,i),this._parameters=a,this._parameterValues=new Array(a.length),this._children=[],this._findParameter=u,this._syncAnimations=r!==!1,this._pointCache={};for(let f=0;f<n.length;f++){const _=n[f];_.children?this._children.push(l(_.type,e,this,_.name,1,_.parameter?[_.parameter]:_.parameters,_.children,_.syncAnimations,l,u)):this._children.push(new h1(e,this,_.name,_.point,_.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=!0;for(let t=0;t<this._parameterValues.length;t++){const s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++)this._children[t].constructor===dy?e+=this._children[t].getNodeCount():e++;return e}}class VJ extends dy{constructor(e,t,s,i,a,n,r,l,u){n.sort((f,_)=>f.point-_.point),super(e,t,s,i,a,n,r,l,u)}calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){const s=this._children[t];if(t!==this._children.length-1){const i=this._children[t+1];if(s.point===i.point)s.weight=.5,i.weight=.5;else if(ge.between(this._parameterValues[0],s.point,i.point,!0)){const a=Math.abs(s.point-i.point),n=Math.abs(s.point-this._parameterValues[0]),r=(a-n)/a;s.weight=r,i.weight=1-r}else i.weight=0}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){const s=this._children[t];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/e}}}const Ic=class Ic extends dy{pointDistanceCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;Ic._p.set(...this._parameterValues),e=0,t=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],a=i.point;Ic._pip.set(Ic._p.x,Ic._p.y).sub(a);let n=Number.MAX_VALUE;for(let r=0;r<this._children.length;r++){if(s===r)continue;const l=this.pointDistanceCache(s,r),u=ge.clamp(1-Ic._pip.dot(l)/l.lengthSq(),0,1);u<n&&(n=u)}i.weight=n,e+=n,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)}}};Ic._p=new Ee,Ic._pip=new Ee;let S3=Ic;const Oc=class Oc extends dy{pointCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=new Ee((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),Ee.angleRad(this._children[e].point,this._children[t].point)*2)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;Oc._p.set(...this._parameterValues);const s=Oc._p.length();e=0,t=0;for(let i=0;i<this._children.length;i++){const a=this._children[i],n=a.point,r=a.pointLength;let l=Number.MAX_VALUE;for(let u=0;u<this._children.length;u++){if(i===u)continue;const f=this.pointCache(i,u),_=this._children[u].pointLength;Oc._pip.set((s-r)/((_+r)/2),Ee.angleRad(n,Oc._p)*2);const g=ge.clamp(1-Math.abs(Oc._pip.dot(f)/f.lengthSq()),0,1);g<l&&(l=g)}a.weight=l,e+=l,this._syncAnimations&&(t+=a.animTrack.duration/a.absoluteSpeed*a.weight)}for(let i=0;i<this._children.length;i++){const a=this._children[i];if(a.weight=a._weight/e,this._syncAnimations){const n=a.animTrack.duration/t*e;a.weightedSpeed=a.absoluteSpeed*n}}}};Oc._p=new Ee,Oc._pip=new Ee;let b3=Oc;class GJ extends dy{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){const i=this._children[s];t+=i.animTrack.duration/i.absoluteSpeed*i.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],a=Math.max(this._parameterValues[s],0);e?(i.weight=a/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class i4{constructor(e,t,s=1,i=!0,a){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=s,this._loop=i,this._hasAnimations=!1,a?this._blendTree=this._createTree(a.type,this,null,t,1,a.parameter?[a.parameter]:a.parameters,a.children,a.syncAnimations,this._createTree,this._controller.findParameter):this._blendTree=new h1(this,null,t,1,s)}_createTree(e,t,s,i,a,n,r,l,u,f){switch(e){case Ez:return new VJ(t,s,i,a,n,r,l,u,f);case Cz:return new S3(t,s,i,a,n,r,l,u,f);case Az:return new b3(t,s,i,a,n,r,l,u,f);case wz:return new GJ(t,s,i,a,n,r,l,u,f)}}_getNodeFromPath(e){let t=this._blendTree;for(let s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){const s=e.join("."),i=this._animationList.findIndex(a=>a.path===s);if(i>=0)this._animationList[i].animTrack=t;else{const a=this._getNodeFromPath(e);a.animTrack=t,this._animationList.push(a)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(e=>e.animTrack&&e.animTrack!==wh.EMPTY)}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return!this._blendTree||this._blendTree.constructor===h1?1:this._blendTree.getNodeCount()}get playable(){return l1.indexOf(this.name)!==-1||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const e=`${this.name}.${this.animations[0].animTrack.name}`,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){const s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration)}return e}}class KA{constructor({from:e,to:t,time:s=0,priority:i=0,conditions:a=[],exitTime:n=null,transitionOffset:r=null,interruptionSource:l=qP}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=a,this._exitTime=n,this._transitionOffset=r,this._interruptionSource=l}get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class Dz{constructor(e,t,s,i,a,n,r){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=kg,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=qP,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=l=>this._findParameter(l),this._animEvaluator=e,this._eventHandler=a,this._findParameter=n,this._consumeTrigger=r;for(let l=0;l<t.length;l++)this._states[t[l].name]=new i4(this,t[l].name,t[l].speed,t[l].loop,t[l].blendTree),this._stateNames.push(t[l].name);this._transitions=s.map(l=>new KA({...l})),this._activate=i}get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=!0;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration))}this._activeStateDuration=e,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===kg||this.activeStateName===jA||this.activeStateName===hd)return 1;const t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter(s=>s.from===e),n1(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let s=this._findTransitionsBetweenStatesCache[`${e}->${t}`];return s||(s=this._transitions.filter(i=>i.from===e&&i.to===t),n1(s),this._findTransitionsBetweenStatesCache[`${e}->${t}`]=s),s}_transitionHasConditionsMet(e){const t=e.conditions;for(let s=0;s<t.length;s++){const i=t[s],a=this._findParameter(i.parameterName);switch(i.predicate){case yz:if(!(a.value>i.value))return!1;break;case vz:if(!(a.value<i.value))return!1;break;case Sz:if(!(a.value>=i.value))return!1;break;case bz:if(!(a.value<=i.value))return!1;break;case xz:if(a.value!==i.value)return!1;break;case Tz:if(a.value===i.value)return!1;break}}return!0}_findTransition(e,t){let s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(!this._isTransitioning)s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(hd));else switch(this._transitionInterruptionSource){case pz:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(hd));break;case mz:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(hd));break;case _z:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(hd));break;case gz:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(hd));break}if(s=s.filter(i=>{if(i.to===this.activeStateName)return!1;if(i.hasExitTime){let a=this._getActiveStateProgressForTime(this._timeInStateBefore),n=this._getActiveStateProgressForTime(this._timeInState);if(i.exitTime<1&&this.activeState.loop&&(a-=Math.floor(a),n-=Math.floor(n)),n===a){if(n!==i.exitTime)return null}else if(!(i.exitTime>a&&i.exitTime<=n))return null}return this._transitionHasConditionsMet(i)}),s.length>0){const i=s[0];if(i.to===jA){const a=this._findTransitionsFromState(kg)[0];i.to=a.to}return i}return null}updateStateFromTransition(e){let t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=!0;for(let u=0;u<e.conditions.length;u++){const f=e.conditions[u];this._findParameter(f.parameterName).type===gb&&this._consumeTrigger(f.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const u=Math.min(this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1,1);for(let f=0;f<this._transitionPreviousStates.length;f++){this._isTransitioning?f!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[f].weight*=1-u:this._transitionPreviousStates[f].weight=u:this._transitionPreviousStates[f].weight=1,t=this._findState(this._transitionPreviousStates[f].name);for(let _=0;_<t.animations.length;_++)s=t.animations[_],i=this._animEvaluator.findClip(`${s.name}.previous.${f}`),i||(i=this._animEvaluator.findClip(s.name),i.name=`${s.name}.previous.${f}`),f!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;const a=this.activeState,n=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1;let r=0,l=0;if(n){const u=a.timelineDuration*e.transitionOffset;r=u,l=u}this._timeInState=r,this._timeInStateBefore=l;for(let u=0;u<a.animations.length;u++){if(i=this._animEvaluator.findClip(a.animations[u].name),i)i.reset();else{const f=Number.isFinite(a.animations[u].speed)?a.animations[u].speed:a.speed;i=new o1(a.animations[u].animTrack,this._timeInState,f,!0,a.loop,this._eventHandler),i.name=a.animations[u].name,this._animEvaluator.addClip(i)}if(e.time>0?i.blendWeight=0:i.blendWeight=a.animations[u].normalizedWeight,i.play(),n)i.time=a.timelineDuration*e.transitionOffset;else{const f=a.speed>=0?0:this.activeStateDuration;i.time=f}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new KA({from:null,to:e})),this.updateStateFromTransition(t)}assignAnimation(e,t,s,i){const a=e.split(".");let n=this._findState(a[0]);n||(n=new i4(this,a[0],s),this._states[a[0]]=n,this._stateNames.push(a[0])),n.addAnimation(a,t),this._animEvaluator.updateClipTrack(n.name,t),s!==void 0&&(n.speed=s),i!==void 0&&(n.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(e){if(l1.indexOf(e)!==-1)return!1;const t=this._findState(e);return t?(t.animations=[],!0):!1}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=kg,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(!this._playing)return;let t,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));const a=this._findTransition(this._activeStateName);if(a&&this.updateStateFromTransition(a),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){const n=this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1;for(let r=0;r<this._transitionPreviousStates.length;r++){t=this._findState(this._transitionPreviousStates[r].name);const l=this._transitionPreviousStates[r].weight;for(let u=0;u<t.animations.length;u++)s=t.animations[u],i=this._animEvaluator.findClip(`${s.name}.previous.${r}`),i&&(i.blendWeight=(1-n)*s.normalizedWeight*l)}t=this.activeState;for(let r=0;r<t.animations.length;r++)s=t.animations[r],this._animEvaluator.findClip(s.name).blendWeight=n*s.normalizedWeight}else{this._isTransitioning=!1;const n=this.activeStateAnimations.length,r=this._animEvaluator.clips.length;for(let l=0;l<r-n;l++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let l=0;l<t.animations.length;l++)s=t.animations[l],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==h1){t=this.activeState;for(let n=0;n<t.animations.length;n++)s=t.animations[n],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(e,this.activeState.hasAnimations)}}const HR=new Ee,LE=new H,sS=new Ie,iS=new xe,aS=new Ne;class Lc extends zc{constructor(e,t,s,i,a){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=a}static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return HR.x=e[0],HR.y=e[1],HR}static _packVec3(e){return LE.x=e[0],LE.y=e[1],LE.z=e[2],LE}static _packVec4(e){return sS.x=e[0],sS.y=e[1],sS.z=e[2],sS.w=e[3],sS}static _packColor(e){return iS.r=e[0],iS.g=e[1],iS.b=e[2],iS.a=e[3],iS}static _packQuat(e){return aS.x=e[0],aS.y=e[1],aS.z=e[2],aS.w=e[3],aS}resolve(e){const t=zp.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;let i,a,n;switch(e.component){case"entity":i=this._getEntityFromHierarchy(e.entityPath),n=zp.encode(i.path,"entity",e.propertyPath),a=i;break;case"graph":if(a=this.findNode(e),!a)return null;n=zp.encode(a.path,"graph",e.propertyPath);break;default:if(i=this._getEntityFromHierarchy(e.entityPath),a=i.findComponent(e.component),!a)return null;n=zp.encode(i.path,e.component,e.propertyPath);break}return s=this._createAnimTargetForProperty(a,e.propertyPath,n),this.targetCache[t]=s,s}update(e){const t=this.activeNodes;if(t)for(let s=0;s<t.length;s++)t[s]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;const t=this.animComponent.entity;return e.length===1?t:t._parent.findByPath(e)}_resolvePath(e,t,s){const i=t.length-(s?0:1);for(let a=0;a<i;a++)e=e[t[a]];return e}_setter(e,t,s){const i=this._resolvePath(e,t),a=t[t.length-1],n=`set${a.substring(0,1).toUpperCase()}${a.substring(1)}`;if(i[n]){let u=i[`get${a.substring(0,1).toUpperCase()}${a.substring(1)}`].bind(i)();u=[u.x,u.y,u.z,u.w];const f=i[n].bind(i);return{set:_=>{f(s(_))},get:()=>u}}const r=i[a];if(typeof r=="object"&&r.hasOwnProperty("copy"))return function(l){r.copy(s(l))};if([Ee,H,Ie,xe,Ne].indexOf(i.constructor)!==-1&&t.length>1){const l=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,u=t[t.length-2];return function(f){i[a]=s(f),l[u]=i}}return function(l){i[a]=s(l)}}_createAnimTargetForProperty(e,t,s){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&t[0]==="material"&&t.length===2){const l=t[1];if(l.endsWith("Map"))return this.handlers.materialTexture(e,l)}const i=this._resolvePath(e,t,!0);if(typeof i>"u")return null;let a,n,r;if(typeof i=="number")a=this._setter(e,t,Lc._packFloat),n="vector",r=1;else if(typeof i=="boolean")a=this._setter(e,t,Lc._packBoolean),n="vector",r=1;else if(typeof i=="object")switch(i.constructor){case Ee:a=this._setter(e,t,Lc._packVec2),n="vector",r=2;break;case H:a=this._setter(e,t,Lc._packVec3),n="vector",r=3;break;case Ie:a=this._setter(e,t,Lc._packVec4),n="vector",r=4;break;case xe:a=this._setter(e,t,Lc._packColor),n="vector",r=4;break;case Ne:a=this._setter(e,t,Lc._packQuat),n="quaternion",r=4;break;default:return null}return t.indexOf("material")!==-1?new YA(l=>{a(l),e.material.update()},n,r,s):new YA(a,n,r,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const e={},t=function(s){e[s.name]=s;for(let i=0;i<s.children.length;++i)t(s.children[i])};t(this.graph),this.nodes=e}}class Pz{constructor(e,t,s,i=1,a=XP){this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=a}get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){const t=this._controller,s=t.playing;t.playing=!0,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=ge.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignAnimation(e,t,s,i){t instanceof wh&&(this._controller.assignAnimation(e,t,s,i),this._controller._transitions.length===0&&this._controller._transitions.push(new KA({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[`${this.name}:${e}`]}transition(e,t=0,s=null){this._controller.updateStateFromTransition(new KA({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}))}}class vb{constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(const t in e.layers){const s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let a=0;a<s.states.length;a++)i.states.push(e.states[s.states[a]]);for(let a=0;a<s.transitions.length;a++){const n=e.transitions[s.transitions[a]];if(n.conditions&&!Array.isArray(n.conditions)){const r=Object.keys(n.conditions),l=[];for(let u=0;u<r.length;u++){const f=n.conditions[r[u]];f.parameterName&&l.push(f)}n.conditions=l}Number.isInteger(n.from)&&(n.from=e.states[n.from].name),Number.isInteger(n.to)&&(n.to=e.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const t in e.parameters){const s=e.parameters[t];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class QP extends xt{set stateGraphAsset(e){if(e===null){this.removeStateGraph();return}this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);let t,s;e instanceof Ye?(t=e.id,s=this.system.app.assets.get(t),s||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),!(!s||this._stateGraphAsset===t)&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",i=>{this._stateGraph=i.resource,this.loadStateGraph(this._stateGraph)}),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if(typeof e=="string"){const t=this.entity.root.findByGuid(e);this._rootBone=t}else e instanceof Kt?this._rootBone=e:this._rootBone=null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){const t=this.animationAssets,s=this.layers.map(i=>i.mask);this.removeStateGraph(),this._stateGraph=new vb(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach((i,a)=>{i.mask=s[a]}),this.rebind()}dirtifyTargets(){const e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=!0}_addLayer({name:e,states:t,transitions:s,weight:i,mask:a,blendType:n}){let r;this.rootBone?r=this.rootBone:r=this.entity;const l=this._layers.length,u=new Lc(this,r,e,a,l),f=new jP(u),_=new Dz(f,t,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new Pz(e,_,this,i,n)),this._layerIndices[e]=l,this._layers[l]}addLayer(e,t,s,i){const a=this.findAnimationLayer(e);if(a)return a;const n=[{name:"START",speed:1}],r=[];return this._addLayer({name:e,states:n,transitions:r,weight:t,mask:s,blendType:i})}_assignParameters(e){this._parameters={};const t=Object.keys(e.parameters);for(let s=0;s<t.length;s++){const i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value}}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];let t=!1;for(let s=0;s<e.layers.length;s++){const i=e.layers[s];this._addLayer({...i}),i.states.some(a=>a.blendTree)&&(t=!0)}t||this.setupAnimationAssets()}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e],s=t.name;for(let i=0;i<t.states.length;i++){const a=t.states[i];if(l1.indexOf(a)===-1){const n=`${s}:${a}`;this._animationAssets[n]||(this._animationAssets[n]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e];for(let s=0;s<t.states.length;s++){const i=t.states[s];if(l1.indexOf(i)!==-1)continue;const a=this._animationAssets[`${t.name}:${i}`];if(!a||!a.asset){this.findAnimationLayer(t.name).assignAnimation(i,wh.EMPTY);continue}const n=a.asset,r=this.system.app.assets.get(n);r&&(r.resource?this.onAnimationAssetLoaded(t.name,i,r):(r.once("load",(function(l,u){return(function(f){this.onAnimationAssetLoaded(l,u,f)}).bind(this)}).bind(this)(t.name,i)),this.system.app.assets.load(r)))}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let e=0;e<this._layers.length;e++){const t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach(e=>{this._targets[e].unbind()})}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){const t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s=1,i=!0,a="Base"){var r;this._stateGraph||this.loadStateGraph(new vb({layers:[{name:a,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));const n=this.findAnimationLayer(a);n?n.assignAnimation(e,t,s,i):(r=this.addLayer(a))==null||r.assignAnimation(e,t,s,i)}assignAnimation(e,t,s,i=1,a=!0){if(!this._stateGraph&&e.indexOf(".")===-1){this.loadStateGraph(new vb({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:a,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),this.baseLayer.assignAnimation(e,t);return}const n=s?this.findAnimationLayer(s):this.baseLayer;n&&n.assignAnimation(e,t,i,a)}removeNodeAnimations(e,t){const s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e)}getParameterValue(e,t){const s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){const i=this._parameters[e];if(i&&i.type===t){i.value=s;return}}getFloat(e){return this.getParameterValue(e,g3)}setFloat(e,t){this.setParameterValue(e,g3,t)}getInteger(e){return this.getParameterValue(e,_3)}setInteger(e,t){typeof t=="number"&&t%1===0&&this.setParameterValue(e,_3,t)}getBoolean(e){return this.getParameterValue(e,y3)}setBoolean(e,t){this.setParameterValue(e,y3,!!t)}getTrigger(e){return this.getParameterValue(e,gb)}setTrigger(e,t=!1){this.setParameterValue(e,gb,!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,gb,!1)}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach(t=>{this.parameters[t].value=!1}),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}constructor(...e){super(...e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1,this.findParameter=t=>this._parameters[t],this.consumeTrigger=t=>{this._consumedTriggers.add(t)}}}class HJ{constructor(){this.enabled=!0}}const x3=["enabled"];class Lz extends ei{constructor(e){super(e),this.id="anim",this.ComponentType=QP,this.DataType=HJ,this.schema=x3,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,x3);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach(a=>{i.includes(a)||(e[a]=t[a])}),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers&&t.layers.forEach((a,n)=>{a._controller.states.forEach(r=>{a._controller._states[r]._animationList.forEach(l=>{if(!l.animTrack||l.animTrack===wh.EMPTY){const u=this.app.assets.get(a._component._animationAssets[`${a.name}:${l.name}`].asset);u&&!u.loaded&&u.once("load",()=>{e.layers[n].assignAnimation(l.name,u.resource)})}else e.layers[n].assignAnimation(l.name,l.animTrack)})})}),t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach(a=>{if(e.layers[a]){const n=t.masks[a].mask,r={};Object.keys(n).forEach(l=>{r[decodeURI(l)]=n[l]}),e.layers[a].mask=r}})}onAnimationUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e)}}cloneComponent(e,t){let s;(!e.anim.rootBone||e.anim.rootBone===e)&&(s={},e.anim.layers.forEach((a,n)=>{if(a.mask){const r={};Object.keys(a.mask).forEach(l=>{const u=l.split("/");u.shift();const f=[t.name,...u].join("/");r[f]=a.mask[l]}),s[n]={mask:r}}}));const i={enabled:e.anim.enabled,stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:s};return this.addComponent(t,i)}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}xt._buildAccessors(QP.prototype,x3);class $P extends xt{setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}class WJ{constructor(){this.enabled=!0}}const Iz=["enabled"];class Oz extends ei{constructor(e){super(e),this.id="audiolistener",this.ComponentType=$P,this.DataType=WJ,this.schema=Iz,this.manager=e.soundManager,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["enabled"],super.initializeComponentData(e,t,s)}onUpdate(e){if(this.current){const t=this.current.getPosition();this.manager.listener.setPosition(t);const s=this.current.getWorldTransform();this.manager.listener.setOrientation(s)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}xt._buildAccessors($P.prototype,Iz);const QA=0,T3=1,Sb="group",$A="image",ZP="text",bb="stretch",Nz="contain",Fz="cover",pi={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},Tx={};Tx[pi.DEFAULT]="_defaultTint";Tx[pi.HOVER]="hoverTint";Tx[pi.PRESSED]="pressedTint";Tx[pi.INACTIVE]="inactiveTint";const Ex={};Ex[pi.DEFAULT]="_defaultSpriteAsset";Ex[pi.HOVER]="hoverSpriteAsset";Ex[pi.PRESSED]="pressedSpriteAsset";Ex[pi.INACTIVE]="inactiveSpriteAsset";const Ax={};Ax[pi.DEFAULT]="_defaultSpriteFrame";Ax[pi.HOVER]="hoverSpriteFrame";Ax[pi.PRESSED]="pressedSpriteFrame";Ax[pi.INACTIVE]="inactiveSpriteFrame";const Ki=class Ki extends xt{constructor(e,t){super(e,t),this._visualState=pi.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new xe(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageEntity=null,this._evtElementAdd=null,this._evtImageEntityElementAdd=null,this._evtImageEntityElementRemove=null,this._evtImageEntityElementColor=null,this._evtImageEntityElementOpacity=null,this._evtImageEntityElementSpriteAsset=null,this._evtImageEntityElementSpriteFrame=null,this._visualState=pi.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new xe(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._toggleLifecycleListeners("on",e)}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set active(e){this._setValue("active",e)}get active(){return this.data.active}set imageEntity(e){if(this._imageEntity!==e){const t=typeof e=="string";if(this._imageEntity&&t&&this._imageEntity.getGuid()===e)return;this._imageEntity&&this._imageEntityUnsubscribe(),e instanceof Jt?this._imageEntity=e:t?this._imageEntity=this.system.app.getEntityFromIndex(e)||null:this._imageEntity=null,this._imageEntity&&this._imageEntitySubscribe(),this._imageEntity?this.data.imageEntity=this._imageEntity.getGuid():t&&e&&(this.data.imageEntity=e)}}get imageEntity(){return this._imageEntity}set hitPadding(e){this._setValue("hitPadding",e)}get hitPadding(){return this.data.hitPadding}set transitionMode(e){this._setValue("transitionMode",e)}get transitionMode(){return this.data.transitionMode}set hoverTint(e){this._setValue("hoverTint",e)}get hoverTint(){return this.data.hoverTint}set pressedTint(e){this._setValue("pressedTint",e)}get pressedTint(){return this.data.pressedTint}set inactiveTint(e){this._setValue("inactiveTint",e)}get inactiveTint(){return this.data.inactiveTint}set fadeDuration(e){this._setValue("fadeDuration",e)}get fadeDuration(){return this.data.fadeDuration}set hoverSpriteAsset(e){this._setValue("hoverSpriteAsset",e)}get hoverSpriteAsset(){return this.data.hoverSpriteAsset}set hoverSpriteFrame(e){this._setValue("hoverSpriteFrame",e)}get hoverSpriteFrame(){return this.data.hoverSpriteFrame}set pressedSpriteAsset(e){this._setValue("pressedSpriteAsset",e)}get pressedSpriteAsset(){return this.data.pressedSpriteAsset}set pressedSpriteFrame(e){this._setValue("pressedSpriteFrame",e)}get pressedSpriteFrame(){return this.data.pressedSpriteFrame}set inactiveSpriteAsset(e){this._setValue("inactiveSpriteAsset",e)}get inactiveSpriteAsset(){return this.data.inactiveSpriteAsset}set inactiveSpriteFrame(e){this._setValue("inactiveSpriteFrame",e)}get inactiveSpriteFrame(){return this.data.inactiveSpriteFrame}_setValue(e,t){const s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}_toggleLifecycleListeners(e,t){var s;this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),e==="on"?this._evtElementAdd=this.entity.on("element:add",this._onElementComponentAdd,this):((s=this._evtElementAdd)==null||s.off(),this._evtElementAdd=null)}_onSetActive(e,t,s){t!==s&&this._updateVisualState()}_onSetTransitionMode(e,t,s){t!==s&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())}_onSetTransitionValue(e,t,s){t!==s&&this._forceReapplyVisualState()}_imageEntitySubscribe(){this._evtImageEntityElementAdd=this._imageEntity.on("element:add",this._onImageElementGain,this),this._imageEntity.element&&this._onImageElementGain()}_imageEntityUnsubscribe(){var e,t;(e=this._evtImageEntityElementAdd)==null||e.off(),this._evtImageEntityElementAdd=null,(t=this._imageEntity)!=null&&t.element&&this._onImageElementLose()}_imageEntityElementSubscribe(){const e=this._imageEntity.element;this._evtImageEntityElementRemove=e.once("beforeremove",this._onImageElementLose,this),this._evtImageEntityElementColor=e.on("set:color",this._onSetColor,this),this._evtImageEntityElementOpacity=e.on("set:opacity",this._onSetOpacity,this),this._evtImageEntityElementSpriteAsset=e.on("set:spriteAsset",this._onSetSpriteAsset,this),this._evtImageEntityElementSpriteFrame=e.on("set:spriteFrame",this._onSetSpriteFrame,this)}_imageEntityElementUnsubscribe(){var e,t,s,i,a;(e=this._evtImageEntityElementRemove)==null||e.off(),this._evtImageEntityElementRemove=null,(t=this._evtImageEntityElementColor)==null||t.off(),this._evtImageEntityElementColor=null,(s=this._evtImageEntityElementOpacity)==null||s.off(),this._evtImageEntityElementOpacity=null,(i=this._evtImageEntityElementSpriteAsset)==null||i.off(),this._evtImageEntityElementSpriteAsset=null,(a=this._evtImageEntityElementSpriteFrame)==null||a.off(),this._evtImageEntityElementSpriteFrame=null}_onElementComponentRemove(){this._toggleHitElementListeners("off")}_onElementComponentAdd(){this._toggleHitElementListeners("on")}_onImageElementLose(){this._imageEntityElementUnsubscribe(),this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._imageEntityElementSubscribe(),this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(e){if(this.entity.element){const t=e==="on";if(t&&this._hasHitElementListeners)return;this.entity.element[e]("beforeremove",this._onElementComponentRemove,this),this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t}}_storeDefaultVisualState(){var t;const e=(t=this._imageEntity)==null?void 0:t.element;!e||e.type===Sb||(this._storeDefaultColor(e.color),this._storeDefaultOpacity(e.opacity),this._storeDefaultSpriteAsset(e.spriteAsset),this._storeDefaultSpriteFrame(e.spriteFrame))}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b}_storeDefaultOpacity(e){this._defaultTint.a=e}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())}_onMouseEnter(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)}_onMouseLeave(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)}_onMouseDown(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)}_onMouseUp(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)}_onTouchStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)}_onTouchLeave(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)}_onTouchCancel(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)}_onSelectStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)}_onSelectEnd(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)}_onSelectEnter(e){this._hoveringCounter++,this._hoveringCounter===1&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)}_onSelectLeave(e){this._hoveringCounter--,this._hoveringCounter===0&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)}_onClick(e){this._fireIfActive("click",e)}_fireIfActive(e,t){this.data.active&&this.fire(e,t)}_updateVisualState(e){const t=this._visualState,s=this._determineVisualState();if((t!==s||e)&&this.enabled)switch(this._visualState=s,t===pi.HOVER&&this._fireIfActive("hoverend"),t===pi.PRESSED&&this._fireIfActive("pressedend"),s===pi.HOVER&&this._fireIfActive("hoverstart"),s===pi.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case QA:{const i=Tx[this._visualState],a=this[i];this._applyTint(a);break}case T3:{const i=Ex[this._visualState],a=Ax[this._visualState],n=this[i],r=this[a];this._applySprite(n,r);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(e){var t;if((t=this._imageEntity)!=null&&t.element)switch(e){case QA:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case T3:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);break}}_determineVisualState(){if(this.active){if(this._isPressed)return pi.PRESSED;if(this._isHovering)return pi.HOVER}else return pi.INACTIVE;return pi.DEFAULT}_applySprite(e,t){var i;const s=(i=this._imageEntity)==null?void 0:i.element;s&&(t=t||0,this._isApplyingSprite=!0,s.spriteAsset!==e&&(s.spriteAsset=e),s.spriteFrame!==t&&(s.spriteFrame=t),this._isApplyingSprite=!1)}_applyTint(e){this._cancelTween(),this.fadeDuration===0?this._applyTintImmediately(e):this._applyTintWithTween(e)}_applyTintImmediately(e){var i;const t=(i=this._imageEntity)==null?void 0:i.element;if(!e||!t||t.type===Sb)return;const s=a4(e);this._isApplyingTint=!0,s.equals(t.color)||(t.color=s),t.opacity!==e.a&&(t.opacity=e.a),this._isApplyingTint=!1}_applyTintWithTween(e){var n;const t=(n=this._imageEntity)==null?void 0:n.element;if(!e||!t||t.type===Sb)return;const s=a4(e),i=t.color,a=t.opacity;s.equals(i)&&e.a===a||(this._tweenInfo={startTime:oo(),from:new xe(i.r,i.g,i.b,a),to:e.clone(),lerpColor:new xe})}_updateTintTween(){const e=oo()-this._tweenInfo.startTime;let t=this.fadeDuration===0?1:e/this.fadeDuration;if(t=ge.clamp(t,0,1),Math.abs(t-1)>1e-5){const s=this._tweenInfo.lerpColor;s.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new xe(s.r,s.g,s.b,s.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._imageEntityUnsubscribe(),this._toggleLifecycleListeners("off",this.system),this.onDisable()}resolveDuplicatedEntityReferenceProperties(e,t){e.imageEntity&&(this.imageEntity=t[e.imageEntity.getGuid()])}};Ki.EVENT_MOUSEDOWN="mousedown",Ki.EVENT_MOUSEUP="mouseup",Ki.EVENT_MOUSEENTER="mouseenter",Ki.EVENT_MOUSELEAVE="mouseleave",Ki.EVENT_CLICK="click",Ki.EVENT_TOUCHSTART="touchstart",Ki.EVENT_TOUCHEND="touchend",Ki.EVENT_TOUCHCANCEL="touchcancel",Ki.EVENT_TOUCHLEAVE="touchleave",Ki.EVENT_SELECTSTART="selectstart",Ki.EVENT_SELECTEND="selectend",Ki.EVENT_SELECTENTER="selectenter",Ki.EVENT_SELECTLEAVE="selectleave",Ki.EVENT_HOVERSTART="hoverstart",Ki.EVENT_HOVEREND="hoverend",Ki.EVENT_PRESSEDSTART="pressedstart",Ki.EVENT_PRESSEDEND="pressedend";let ZA=Ki;function a4(h){return new xe(h.r,h.g,h.b)}class qJ{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new Ie,this.transitionMode=QA,this.hoverTint=new xe(.75,.75,.75),this.pressedTint=new xe(.5,.5,.5),this.inactiveTint=new xe(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}const n4=["enabled","active",{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class Bz extends ei{constructor(e){super(e),this.id="button",this.ComponentType=ZA,this.DataType=qJ,this.schema=n4,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){e.imageEntity=t.imageEntity,super.initializeComponentData(e,t,n4)}onUpdate(e){const t=this.store;for(const s in t){const i=t[s].entity,a=i.button;a.enabled&&i.enabled&&a.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}const r4=new H,o4=new Ne,Ip=class Ip extends xt{constructor(e,t){super(e,t),this._compoundParent=null,this._hasOffset=!1,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_convexHull",this.onSetModel,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_linearOffset",this.onSetOffset,this),this.on("set_angularOffset",this.onSetOffset,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set type(e){this._setValue("type",e)}get type(){return this.data.type}set halfExtents(e){this._setValue("halfExtents",e)}get halfExtents(){return this.data.halfExtents}set linearOffset(e){this._setValue("linearOffset",e)}get linearOffset(){return this.data.linearOffset}set angularOffset(e){this._setValue("angularOffset",e)}get angularOffset(){return this.data.angularOffset}set radius(e){this._setValue("radius",e)}get radius(){return this.data.radius}set axis(e){this._setValue("axis",e)}get axis(){return this.data.axis}set height(e){this._setValue("height",e)}get height(){return this.data.height}set asset(e){this._setValue("asset",e)}get asset(){return this.data.asset}set renderAsset(e){this._setValue("renderAsset",e)}get renderAsset(){return this.data.renderAsset}set convexHull(e){this._setValue("convexHull",e)}get convexHull(){return this.data.convexHull}set shape(e){this._setValue("shape",e)}get shape(){return this.data.shape}set model(e){this._setValue("model",e)}get model(){return this.data.model}set render(e){this._setValue("render",e)}get render(){return this.data.render}set checkVertexDuplicates(e){this._setValue("checkVertexDuplicates",e)}get checkVertexDuplicates(){return this.data.checkVertexDuplicates}_setValue(e,t){const s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}onSetType(e,t,s){t!==s&&this.system.changeType(this,t,s)}onSetHalfExtents(e,t,s){const i=this.data.type;this.data.initialized&&i==="box"&&this.system.recreatePhysicalShapes(this)}onSetOffset(e,t,s){this._hasOffset=!this.data.linearOffset.equals(H.ZERO)||!this.data.angularOffset.equals(Ne.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this)}onSetRadius(e,t,s){const i=this.data.type;this.data.initialized&&(i==="sphere"||i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetHeight(e,t,s){const i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAxis(e,t,s){const i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAsset(e,t,s){const i=this.system.app.assets;if(t){const a=i.get(t);a&&a.off("remove",this.onAssetRemoved,this)}if(s){s instanceof Ye&&(this.data.asset=s.id);const a=i.get(this.data.asset);a&&(a.off("remove",this.onAssetRemoved,this),a.on("remove",this.onAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const a=i.get(t);a&&a.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof Ye&&(this.data.renderAsset=s.id);const a=i.get(this.data.renderAsset);a&&(a.off("remove",this.onRenderAssetRemoved,this),a.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(e,t,s){this.data.initialized&&this.data.type==="mesh"&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(e,t,s){this.onSetModel(e,t,s)}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)}onRenderAssetRemoved(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null)}getCompoundChildShapeIndex(e){const t=this.data.shape,s=t.getNumChildShapes();for(let i=0;i<s;i++){const a=t.getChildShape(i);if(Ammo.getPointer(a)===Ammo.getPointer(e))return i}return null}_onInsert(e){if(!(typeof Ammo>"u")){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let t=this.entity.parent;for(;t;){if(t.collision&&t.collision.type==="compound"){t.collision.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}}}}_updateCompound(){const e=this.entity;if(e._dirtyWorld){let t=e._dirtyLocal,s=e;for(;s&&!t&&!(s.collision&&s.collision===this._compoundParent);)s._dirtyLocal&&(t=!0),s=s.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);const i=this._compoundParent.entity.rigidbody;i&&i.activate()}}}getShapePosition(){const e=this.entity.getPosition();if(this._hasOffset){const t=this.entity.getRotation(),s=this.data.linearOffset;return o4.copy(t).transformVector(s,r4),r4.add(e)}return e}getShapeRotation(){const e=this.entity.getRotation();return this._hasOffset?o4.copy(e).mul(this.data.angularOffset):e}onEnable(){if(this.data.type==="mesh"&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(this._compoundParent.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(this._compoundParent);else{const e=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}};Ip.EVENT_CONTACT="contact",Ip.EVENT_COLLISIONSTART="collisionstart",Ip.EVENT_COLLISIONEND="collisionend",Ip.EVENT_TRIGGERENTER="triggerenter",Ip.EVENT_TRIGGERLEAVE="triggerleave";let JA=Ip;class XJ{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new H(.5,.5,.5),this.linearOffset=new H,this.angularOffset=new Ne,this.radius=.5,this.axis=1,this.height=2,this.convexHull=!1,this.asset=null,this.renderAsset=null,this.checkVertexDuplicates=!0,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}const Rp="static",cr="dynamic",cd="kinematic",Uz=1,JP=2,kp=4,c1=1,zz=2,kz=3,e2=4,qC=5,jJ=0,YJ=1,Vz=1,E3=2,Gz=4,KJ=8,A3=16,QJ=32,$J=64,ZJ=128,JJ=256,eee=512,tee=1024,see=2048,iee=4096,aee=8192,nee=16384,ree=0,C3=65535,oee=2,t2=65533,lee=65529;let Xo,up,vg;class Hz{constructor(e,t,s){this.entity=t.entity,this.component=t,this.app=e,typeof Ammo<"u"&&!Xo&&(Xo=new Ammo.btVector3,up=new Ammo.btQuaternion,vg=new Ammo.btTransform),this.initialize(s)}initialize(e){const t=this.entity,s=e.shape;if(s&&typeof Ammo<"u"){t.trigger&&t.trigger.destroy();const i=1,a=this.component;if(a){const r=a.getShapePosition(),l=a.getShapeRotation();Xo.setValue(r.x,r.y,r.z),up.setValue(l.x,l.y,l.z,l.w)}else{const r=t.getPosition(),l=t.getRotation();Xo.setValue(r.x,r.y,r.z),up.setValue(l.x,l.y,l.z,l.w)}vg.setOrigin(Xo),vg.setRotation(up);const n=this.app.systems.rigidbody.createBody(i,s,vg);n.setRestitution(0),n.setFriction(0),n.setDamping(0,0),Xo.setValue(0,0,0),n.setLinearFactor(Xo),n.setAngularFactor(Xo),n.setCollisionFlags(n.getCollisionFlags()|kp),n.entity=t,this.body=n,this.component.enabled&&t.enabled&&this.enable()}}destroy(){this.body&&(this.disable(),this.app.systems.rigidbody.destroyBody(this.body),this.body=null)}_getEntityTransform(e){const t=this.component;if(t){const s=t.getShapePosition(),i=t.getShapeRotation();Xo.setValue(s.x,s.y,s.z),up.setValue(i.x,i.y,i.z,i.w)}else{const s=this.entity.getPosition(),i=this.entity.getRotation();Xo.setValue(s.x,s.y,s.z),up.setValue(i.x,i.y,i.z,i.w)}e.setOrigin(Xo),e.setRotation(up)}updateTransform(){this._getEntityTransform(vg);const e=this.body;e.setWorldTransform(vg),e.activate()}enable(){const e=this.body;if(!e)return;const t=this.app.systems.rigidbody;t._triggers.indexOf(this)<0&&(t.addBody(e,A3,t2^A3),t._triggers.push(this)),e.forceActivationState(c1),this.updateTransform()}disable(){const e=this.body;if(!e)return;const t=this.app.systems.rigidbody,s=t._triggers.indexOf(this);s>-1&&(t.removeBody(e),t._triggers.splice(s,1)),e.forceActivationState(qC)}}const IE=new Me,hee=new H,cee=new H,dp=new Ne,l4=new Jt,uee=["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","convexHull","asset","renderAsset","shape","model","render","checkVertexDuplicates"];class Um{constructor(e){this.system=e}beforeInitialize(e,t){t.shape=null,t.model=new Lh,t.model.graph=new Jt}afterInitialize(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0}reset(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)}recreatePhysicalShapes(e){const t=e.entity,s=e.data;if(typeof Ammo<"u"){t.trigger&&(t.trigger.destroy(),delete t.trigger),s.shape&&(e._compoundParent&&(e!==e._compoundParent&&this.system._removeCompoundChild(e._compoundParent,s.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),this.destroyShape(s)),s.shape=this.createPhysicalShape(e.entity,s);const i=!e._compoundParent;if(s.type==="compound"&&(!e._compoundParent||e===e._compoundParent))e._compoundParent=e,t.forEach(this._addEachDescendant,e);else if(s.type!=="compound"&&!e.rigidbody){e._compoundParent=null;let a=t.parent;for(;a;){if(a.collision&&a.collision.type==="compound"){e._compoundParent=a.collision;break}a=a.parent}}e._compoundParent&&e!==e._compoundParent&&(i&&e._compoundParent.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t,!0),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(s):t.trigger=new Hz(this.system.app,e,s))}}createPhysicalShape(e,t){}updateTransform(e,t,s,i){e.entity.trigger&&e.entity.trigger.updateTransform()}destroyShape(e){e.shape&&(Ammo.destroy(e.shape),e.shape=null)}beforeRemove(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,this.destroyShape(t.data))}remove(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger)}clone(e,t){const s=this.system.store[e.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],linearOffset:[s.data.linearOffset.x,s.data.linearOffset.y,s.data.linearOffset.z],angularOffset:[s.data.angularOffset.x,s.data.angularOffset.y,s.data.angularOffset.z,s.data.angularOffset.w],radius:s.data.radius,axis:s.data.axis,height:s.data.height,convexHull:s.data.convexHull,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render,checkVertexDuplicates:s.data.checkVertexDuplicates};return this.system.addComponent(t,i)}}class dee extends Um{createPhysicalShape(e,t){if(typeof Ammo<"u"){const s=t.halfExtents,i=new Ammo.btVector3(s?s.x:.5,s?s.y:.5,s?s.z:.5),a=new Ammo.btBoxShape(i);return Ammo.destroy(i),a}}}class fee extends Um{createPhysicalShape(e,t){if(typeof Ammo<"u")return new Ammo.btSphereShape(t.radius)}}class pee extends Um{createPhysicalShape(e,t){const s=t.axis??1,i=t.radius??.5,a=Math.max((t.height??2)-2*i,0);let n=null;if(typeof Ammo<"u")switch(s){case 0:n=new Ammo.btCapsuleShapeX(i,a);break;case 1:n=new Ammo.btCapsuleShape(i,a);break;case 2:n=new Ammo.btCapsuleShapeZ(i,a);break}return n}}class mee extends Um{createPhysicalShape(e,t){const s=t.axis??1,i=t.radius??.5,a=t.height??1;let n=null,r=null;if(typeof Ammo<"u")switch(s){case 0:n=new Ammo.btVector3(a*.5,i,i),r=new Ammo.btCylinderShapeX(n);break;case 1:n=new Ammo.btVector3(i,a*.5,i),r=new Ammo.btCylinderShape(n);break;case 2:n=new Ammo.btVector3(i,i,a*.5),r=new Ammo.btCylinderShapeZ(n);break}return n&&Ammo.destroy(n),r}}class _ee extends Um{createPhysicalShape(e,t){const s=t.axis??1,i=t.radius??.5,a=t.height??1;let n=null;if(typeof Ammo<"u")switch(s){case 0:n=new Ammo.btConeShapeX(i,a);break;case 1:n=new Ammo.btConeShape(i,a);break;case 2:n=new Ammo.btConeShapeZ(i,a);break}return n}}class gee extends Um{beforeInitialize(e,t){}createAmmoHull(e,t,s,i){const a=new Ammo.btConvexHullShape,n=new Ammo.btVector3,r=[];e.getPositions(r);for(let u=0;u<r.length;u+=3)n.setValue(r[u]*i.x,r[u+1]*i.y,r[u+2]*i.z),a.addPoint(n,!1);Ammo.destroy(n),a.recalcLocalAabb(),a.setMargin(.01);const l=this.system._getNodeTransform(t);s.addChildShape(l,a),Ammo.destroy(l)}createAmmoMesh(e,t,s,i,a=!0){const n=this.system;let r;if(n._triMeshCache[e.id])r=n._triMeshCache[e.id];else{const f=e.vertexBuffer,_=f.getFormat();let g,y;for(let X=0;X<_.elements.length;X++){const Y=_.elements[X];if(Y.name===kt){y=new Float32Array(f.lock(),Y.offset),g=Y.stride/4;break}}const v=[];e.getIndices(v);const x=e.primitive[0].count/3,C=new Ammo.btVector3;let M,w,T;const R=e.primitive[0].base;r=new Ammo.btTriangleMesh,n._triMeshCache[e.id]=r;const D=new Map,I=r.getIndexedMeshArray();I.at(0).m_numTriangles=x;const U=i?i.x:1,O=i?i.y:1,N=i?i.z:1,z=X=>{const Y=y[X*g]*U,F=y[X*g+1]*O,q=y[X*g+2]*N;let G;if(a){const W=`${Y}:${F}:${q}`;if(G=D.get(W),G!==void 0)return G;C.setValue(Y,F,q),G=r.findOrAddVertex(C,!1),D.set(W,G)}else C.setValue(Y,F,q),G=r.findOrAddVertex(C,!1);return G};for(let X=0;X<x;X++)M=z(v[R+X*3]),w=z(v[R+X*3+1]),T=z(v[R+X*3+2]),r.addIndex(M),r.addIndex(w),r.addIndex(T);Ammo.destroy(C)}const l=new Ammo.btBvhTriangleMeshShape(r,!0);if(!i){const f=n._getNodeScaling(t);l.setLocalScaling(f),Ammo.destroy(f)}const u=n._getNodeTransform(t);s.addChildShape(u,l),Ammo.destroy(u)}createPhysicalShape(e,t){if(!(typeof Ammo>"u")&&(t.model||t.render)){const s=new Ammo.btCompoundShape,a=e.getWorldTransform().getScale();if(t.render){const n=t.render.meshes;for(let r=0;r<n.length;r++)t.convexHull?this.createAmmoHull(n[r],l4,s,a):this.createAmmoMesh(n[r],l4,s,a,t.checkVertexDuplicates)}else if(t.model){const n=t.model.meshInstances;for(let l=0;l<n.length;l++)this.createAmmoMesh(n[l].mesh,n[l].node,s,null,t.checkVertexDuplicates);const r=new Ammo.btVector3(a.x,a.y,a.z);s.setLocalScaling(r),Ammo.destroy(r)}return s}}recreatePhysicalShapes(e){const t=e.data;if((t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled){this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model");return}this.doRecreatePhysicalShape(e)}loadAsset(e,t,s){const i=e.data,a=this.system.app.assets,n=i[s],r=f=>{i[s]===n&&(i[s]=f.resource,this.doRecreatePhysicalShape(e))},l=f=>{f.ready(_=>{if(_.data.containerAsset){const g=a.get(_.data.containerAsset);g.loaded?r(_):(g.ready(()=>{r(_)}),a.load(g))}else r(_)}),a.load(f)},u=a.get(t);u?l(u):a.once(`add:${t}`,l)}doRecreatePhysicalShape(e){const t=e.entity,s=e.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(t,s),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(s):t.trigger=new Hz(this.system.app,e,s)):(this.beforeRemove(t,e),this.remove(t,s))}updateTransform(e,t,s,i){if(e.shape){const n=e.entity.getWorldTransform().getScale(),r=e.shape.getLocalScaling();(n.x!==r.x()||n.y!==r.y()||n.z!==r.z())&&this.doRecreatePhysicalShape(e)}super.updateTransform(e,t,s,i)}destroyShape(e){if(!e.shape)return;const t=e.shape.getNumChildShapes();for(let s=0;s<t;s++){const i=e.shape.getChildShape(s);Ammo.destroy(i)}Ammo.destroy(e.shape),e.shape=null}}class yee extends Um{createPhysicalShape(e,t){if(typeof Ammo<"u")return new Ammo.btCompoundShape}_addEachDescendant(e){!e.collision||e.rigidbody||(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendant(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e!==this.entity&&!e.rigidbody&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendantTransform(e){!e.collision||e.collision._compoundParent!==this.collision._compoundParent||this.collision.system.updateCompoundChildTransform(e,!1)}}class Wz extends ei{constructor(e){super(e),this.id="collision",this.ComponentType=JA,this.DataType=XJ,this.schema=uee,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,s){s=["type","halfExtents","radius","axis","height","convexHull","shape","model","asset","render","renderAsset","enabled","linearOffset","angularOffset","checkVertexDuplicates"];const i={};for(let r=0,l=s.length;r<l;r++){const u=s[r];i[u]=t[u]}let a;if(t.hasOwnProperty("asset")?(a=s.indexOf("model"),a!==-1&&s.splice(a,1),a=s.indexOf("render"),a!==-1&&s.splice(a,1)):t.hasOwnProperty("model")&&(a=s.indexOf("asset"),a!==-1&&s.splice(a,1)),i.type||(i.type=e.data.type),e.data.type=i.type,Array.isArray(i.halfExtents)&&(i.halfExtents=new H(i.halfExtents)),Array.isArray(i.linearOffset)&&(i.linearOffset=new H(i.linearOffset)),Array.isArray(i.angularOffset)){const r=i.angularOffset;r.length===3?i.angularOffset=new Ne().setFromEulerAngles(r[0],r[1],r[2]):i.angularOffset=new Ne(i.angularOffset)}const n=this._createImplementation(i.type);n.beforeInitialize(e,i),super.initializeComponentData(e,i,s),n.afterInitialize(e,i)}_createImplementation(e){if(this.implementations[e]===void 0){let t;switch(e){case"box":t=new dee(this);break;case"sphere":t=new fee(this);break;case"capsule":t=new pee(this);break;case"cylinder":t=new mee(this);break;case"cone":t=new _ee(this);break;case"mesh":t=new gee(this);break;case"compound":t=new yee(this);break}this.implementations[e]=t}return this.implementations[e]}_getImplementation(e){return this.implementations[e.collision.data.type]}cloneComponent(e,t){return this._getImplementation(e).clone(e,t)}onBeforeRemove(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove()}onRemove(e,t){this.implementations[t.type].remove(e,t)}updateCompoundChildTransform(e,t){const s=e.collision._compoundParent;if(s!==e.collision&&e.enabled&&e.collision.enabled&&(e._dirtyLocal||t)){const i=this._getNodeTransform(e,s.entity),a=s.getCompoundChildShapeIndex(e.collision.shape);a===null?s.shape.addChildShape(i,e.collision.data.shape):s.shape.updateChildTransform(a,i,!0),Ammo.destroy(i)}}_removeCompoundChild(e,t){if(e.shape.getNumChildShapes()!==0)if(e.shape.removeChildShape)e.shape.removeChildShape(t);else{const s=e.getCompoundChildShapeIndex(t);s!==null&&e.shape.removeChildShapeByIndex(s)}}onTransformChanged(e,t,s,i){this.implementations[e.data.type].updateTransform(e,t,s,i)}changeType(e,t,s){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(s).reset(e,e.data)}recreatePhysicalShapes(e){this.implementations[e.data.type].recreatePhysicalShapes(e)}_calculateNodeRelativeTransform(e,t){if(e===t){const s=e.getWorldTransform().getScale();IE.setScale(s.x,s.y,s.z)}else this._calculateNodeRelativeTransform(e.parent,t),IE.mul(e.getLocalTransform())}_getNodeScaling(e){const s=e.getWorldTransform().getScale();return new Ammo.btVector3(s.x,s.y,s.z)}_getNodeTransform(e,t){let s,i;t?(this._calculateNodeRelativeTransform(e,t),s=hee,i=dp,IE.getTranslation(s),i.setFromMat4(IE)):(s=e.getPosition(),i=e.getRotation());const a=new Ammo.btQuaternion,n=new Ammo.btTransform;n.setIdentity();const r=n.getOrigin(),l=e.collision;if(l&&l._hasOffset){const u=l.data.linearOffset,f=l.data.angularOffset,_=cee;dp.copy(i).transformVector(u,_),_.add(s),dp.copy(i).mul(f),r.setValue(_.x,_.y,_.z),a.setValue(dp.x,dp.y,dp.z,dp.w)}else r.setValue(s.x,s.y,s.z),a.setValue(i.x,i.y,i.z,i.w);return n.setRotation(a),Ammo.destroy(a),n}destroy(){for(const e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,super.destroy()}}const OE=new xe,vee=new Xn;class See{constructor(e,t,s){this._entity=e,this._element=e.element,this.model=new Lh,this.node=new Jt,this.model.graph=this.node,this.mesh=t,this.meshInstance=new ps(this.mesh,s,this.node),this.meshInstance.name=`ImageElement: ${e.name}`,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){var e,t;this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,(e=this.meshInstance)==null||e.destroy(),this.meshInstance=null,(t=this.unmaskMeshInstance)==null||t.destroy(),this.unmaskMeshInstance=null,this._entity=null,this._element=null}setMesh(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())}setMask(e){var t;if(this.meshInstance){if(this._entity.enabled&&this._element.enabled&&this._element.removeModelFromLayers(this.model),e){this.unmaskMeshInstance=new ps(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name=`Unmask: ${this._entity.name}`,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const s in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(s,this.meshInstance.parameters[s].data)}else{const s=this.model.meshInstances.indexOf(this.unmaskMeshInstance);s>=0&&this.model.meshInstances.splice(s,1)}this._entity.enabled&&this._element.enabled&&this._element.addModelToLayers(this.model),e||((t=this.unmaskMeshInstance)==null||t.destroy(),this.unmaskMeshInstance=null)}}setMaterial(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))}setParameter(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))}deleteParameter(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const e=function(t){let s;const i=t.children,a=i.length;if(a){for(let r=0;r<a;r++)i[r].element&&(s=i[r]);if(!s)return null;const n=e(s);return n||s}return null};if(this.unmaskMeshInstance){const t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(e){this.meshInstance&&(this.meshInstance.drawOrder=e)}setCull(e){if(!this.meshInstance)return;const t=this._element;let s=null;e&&t._isScreenSpace()&&(s=function(i){return t.isVisibleForCamera(i)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))}setLayer(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))}forceUpdateAabb(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))}}class qz{constructor(e){this._evtSetMeshes=null,this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new Ie(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new Ee,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new Ie,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new Ie,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new See(this._entity,this._defaultMesh,this._material),this._color=new xe(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(e){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onScreenChange(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&this._system.defaultImageMaterials.indexOf(this._material)===-1}_use9Slicing(){return this.sprite&&(this.sprite.renderMode===Bi||this.sprite.renderMode===Ui)}_updateMaterial(e){const t=!!this._mask,s=!!(this.sprite&&this.sprite.renderMode===Bi),i=!!(this.sprite&&this.sprite.renderMode===Ui);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,s,i)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?sU:lP))}_createMesh(){const e=this._element,t=e.calculatedWidth,s=e.calculatedHeight,i=this._rect,a=this._system.app.graphicsDevice,n=new Float32Array([t,0,0,0,0,1,i.x+i.z,1-i.y,t,s,0,0,0,1,i.x+i.z,1-(i.y+i.w),0,0,0,0,0,1,i.x,1-i.y,0,s,0,0,0,1,i.x,1-(i.y+i.w)]),r=vee.get(a,()=>new en(a,[{semantic:kt,components:3,type:it},{semantic:$a,components:3,type:it},{semantic:Za,components:2,type:it}])),l=new jn(a,r,4,{data:n.buffer}),u=new Ft(a);return u.vertexBuffer=l,u.primitive[0].type=hl,u.primitive[0].base=0,u.primitive[0].count=4,u.primitive[0].indexed=!1,u.aabb.setMinMax(H.ZERO,new H(t,s,0)),this._updateMesh(u),u}_updateMesh(e){const t=this._element;let s=t.calculatedWidth,i=t.calculatedHeight;if(t.fitMode!==bb&&this._targetAspectRatio>0){const n=t.calculatedWidth/t.calculatedHeight;t.fitMode===Nz&&n>this._targetAspectRatio||t.fitMode===Fz&&n<this._targetAspectRatio?s=t.calculatedHeight*this._targetAspectRatio:i=t.calculatedWidth/this._targetAspectRatio}const a=t._isScreenSpace();if(this._updateMaterial(a),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(this.sprite.renderMode===Bi||this.sprite.renderMode===Ui)){const n=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],r=2/n.rect.z,l=2/n.rect.w;this._innerOffset.set(n.border.x*r,n.border.y*l,n.border.z*r,n.border.w*l);const u=this.sprite.atlas.texture;this._atlasRect.set(n.rect.x/u.width,n.rect.y/u.height,n.rect.z/u.width,n.rect.w/u.height);const f=this._pixelsPerUnit!==null?this._pixelsPerUnit:this.sprite.pixelsPerUnit,_=n.rect.z/f,g=n.rect.w/f;this._outerScale.set(Math.max(s,this._innerOffset.x*_),Math.max(i,this._innerOffset.y*g));let y=_,v=g;this._outerScale.x/=_,this._outerScale.y/=g,y*=ge.clamp(s/(this._innerOffset.x*_),1e-4,1),v*=ge.clamp(i/(this._innerOffset.y*g),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(y,v,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*s,(.5-t.pivot.y)*i,0))}else{const n=e.vertexBuffer,r=new Float32Array(n.lock()),l=t.pivot.x,u=t.pivot.y;r[0]=s-l*s,r[1]=0-u*i,r[8]=s-l*s,r[9]=i-u*i,r[16]=0-l*s,r[17]=0-u*i,r[24]=0-l*s,r[25]=i-u*i;let f=1,_=1,g=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const x=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];x&&(g=x.rect,f=this._sprite.atlas.texture.width,_=this._sprite.atlas.texture.height)}r[6]=(g.x+g.z)/f,r[7]=1-g.y/_,r[14]=(g.x+g.z)/f,r[15]=1-(g.y+g.w)/_,r[22]=g.x/f,r[23]=1-g.y/_,r[30]=g.x/f,r[31]=1-(g.y+g.w)/_,n.unlock();const y=new H(0-l*s,0-u*i,0),v=new H(s-l*s,i-u*i,0);e.aabb.setMinMax(y,v),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}this._meshDirty=!1}_updateSprite(){let e=!1,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=this._sprite.renderMode===Bi||this._sprite.renderMode===Ui;const s=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(s==null?void 0:s.rect.w)>0&&(this._targetAspectRatio=s.rect.z/s.rect.w)}this.mesh=e?t:this._defaultMesh,this.refreshMesh()}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e}_toggleMask(){this._element._dirtifyMask();const e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)}_onMaterialLoad(e){this.material=e.resource}_onMaterialAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_bindMaterialAsset(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))}_unbindMaterialAsset(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)}_bindTextureAsset(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))}_unbindTextureAsset(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)}_onTextureLoad(e){this.texture=e.resource}_onTextureChange(e){}_onTextureRemove(e){}_onSpriteAssetAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off(`load:${e.data.textureAtlasAsset}`,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(e){if(!e||!e.resource)this.sprite=null;else if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset;if(t){const s=this._system.app.assets;s.off(`load:${t}`,this._onTextureAtlasLoad,this),s.once(`load:${t}`,this._onTextureAtlasLoad,this)}}}_onSpriteAssetChange(e){this._onSpriteAssetLoad(e)}_onSpriteAssetRemove(e){}_bindSprite(e){this._evtSetMeshes=e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(e){var t;(t=this._evtSetMeshes)==null||t.off(),this._evtSetMeshes=null,e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=ge.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){this.sprite.renderMode!==tl&&this._pixelsPerUnit===null&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof Ye?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t))}onEnable(){if(this._materialAsset){const e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e)}if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e)}if(this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==this._sprite&&this._bindSpriteAsset(e)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;let t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const s=new pr({ref:t+1,func:Fb,zpass:BF});this._renderable.unmaskMeshInstance.stencilFront=s,this._renderable.unmaskMeshInstance.stencilBack=s}}_updateRenderableEmissive(){OE.linear(this._color),this._colorUniform[0]=OE.r,this._colorUniform[1]=OE.g,this._colorUniform[2]=OE.b,this._renderable.setParameter("material_emissive",this._colorUniform)}set color(e){const{r:t,g:s,b:i}=e;(this._color.r!==t||this._color.g!==s||this._color.b!==i)&&(this._color.r=t,this._color.g=s,this._color.b=i,this._updateRenderableEmissive()),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set rect(e){let t,s,i,a;e instanceof Ie?(t=e.x,s=e.y,i=e.z,a=e.w):(t=e[0],s=e[1],i=e[2],a=e[3]),!(t===this._rect.x&&s===this._rect.y&&i===this._rect.z&&a===this._rect.w)&&(this._rect.set(t,s,i,a),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}_removeMaterialAssetEvents(){if(this._materialAsset){const e=this._system.app.assets;e.off(`add:${this._materialAsset}`,this._onMaterialAdded,this);const t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this))}}set material(e){if(this._material!==e){if(!e){const t=this._element._isScreenSpace();this.mask?e=t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e=t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}if(this._material=e,this._materialAsset){const t=this._system.app.assets.get(this._materialAsset);(!t||t.resource!==e)&&(this._removeMaterialAssetEvents(),this._materialAsset=null)}e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof Ye&&(s=e.id),this._materialAsset!==s)if(this._removeMaterialAssetEvents(),this._materialAsset=s,this._materialAsset){const i=t.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._materialAsset=null,this.material=null,this._materialAsset=s,t.on(`add:${this._materialAsset}`,this._onMaterialAdded,this))}else this._materialAsset=null,this.material=null,this._materialAsset=s}get materialAsset(){return this._materialAsset}set texture(e){if(this._texture!==e){if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a);const t=this._texture.width/this._texture.height;t!==this._targetAspectRatio&&(this._targetAspectRatio=t,this._element.fitMode!==bb&&this.refreshMesh())}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==bb&&this.refreshMesh()}}get texture(){return this._texture}set textureAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof Ye&&(s=e.id),this._textureAsset!==s){if(this._textureAsset){t.off(`add:${this._textureAsset}`,this._onTextureAdded,this);const i=t.get(this._textureAsset);i&&(i.off("load",this._onTextureLoad,this),i.off("change",this._onTextureChange,this),i.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const i=t.get(this._textureAsset);i?this._bindTextureAsset(i):(this.texture=null,t.on(`add:${this._textureAsset}`,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof Ye&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){t.off(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this);const i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){const i=t.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,t.on(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=ge.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(e){const t=this._spriteFrame;this._sprite?this._spriteFrame=ge.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e)}get spriteFrame(){return this._spriteFrame}set mesh(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(e){this._mask!==e&&(this._mask=e,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._sprite&&(this._sprite.renderMode===Bi||this._sprite.renderMode===Ui)&&this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}class Xz extends Qe{constructor(e){super(),this._app=e,e.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(e){const t=e instanceof Ye?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(e){const t=e instanceof Ye?e.id:e;this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off(`add:${this._localizedAsset}`,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset()),this._localizedAsset=t,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once(`add:${this._localizedAsset}`,this._onLocalizedAssetAdd,this)))}get localizedAsset(){return this._localizedAsset}set autoLoad(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){const e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this);const e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}_unbindLocalizedAsset(){const e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(e){this.fire("load",e)}_onLocalizedAssetChange(e,t,s,i){this.fire("change",e,t,s,i)}_onLocalizedAssetRemove(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)}_onLocaleAdd(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onLocaleRemove(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onSetLocale(e){if(!this._defaultAsset){this.localizedAsset=null;return}const t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}const s=t.getLocalizedAssetId(e);if(!s){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=s}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}}const u1="msdf",jz="bitmap",rb=0,Lg=1,w3=2,Yz=3,R3=4,M3=5,D3=6,P3=7,h4=8,bee=` 	
\r\v\f`,xee=/[\w|/]/;class Tee{constructor(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let e=this._read();for(;e===h4;)e=this._read();return e!==rb&&e!==Lg&&(this._last=this._index),e}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let t=this.read(),s="";for(;s+=`${(s.length>0?`
`:"")+e[t]} '${this.buf().join("")}'`,!(t===rb||t===Lg);)t=this.read();return s}_read(){return this._buf=[],this._eof()?rb:this._mode==="text"?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?w3:rb;case"[":return this._mode="tag",this._buf.length>0?w3:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\");break}break;default:this._store();break}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",Lg;case"[":return this._store(),Yz;case"]":return this._store(),this._mode="text",R3;case"=":return this._store(),M3;case" ":case"	":case`
`:case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",Lg)}}_whitespace(){for(this._store();bee.indexOf(this._cur)!==-1;)this._store();return h4}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",Lg;case'"':return this._next(),D3;default:this._store();break}}_identifier(){for(this._store();this._cur!==null&&this._isIdentifierSymbol(this._cur);)this._store();return P3}_isIdentifierSymbol(e){return e.length===1&&e.match(xee)!==null}_eof(){return this._cur===null}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(e){this._buf.push(e)}}class Eee{constructor(e){this._scanner=new Tee(e),this._error=null}parse(e,t){for(;;)switch(this._scanner.read()){case rb:return!0;case Lg:return!1;case w3:Array.prototype.push.apply(e,this._scanner.buf());break;case Yz:if(!this._parseTag(e,t))return!1;break;default:return!1}}error(){return`Error evaluating markup at #${this._scanner.last().toString()} (${this._scanner.error()||this._error})`}_parseTag(e,t){let s=this._scanner.read();if(s!==P3)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if(i[0]==="/"){for(let n=t.length-1;n>=0;--n)if(i===`/${t[n].name}`&&t[n].end===null)return t[n].end=e.length,s=this._scanner.read(),s!==R3?(this._error="expected close bracket",!1):!0;return this._error="failed to find matching tag",!1}const a={name:i,value:null,attributes:{},start:e.length,end:null};if(s=this._scanner.read(),s===M3){if(s=this._scanner.read(),s!==D3)return this._error="expected string",!1;a.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case R3:return t.push(a),!0;case P3:{const n=this._scanner.buf().join("");if(s=this._scanner.read(),s!==M3)return this._error="expected equals",!1;if(s=this._scanner.read(),s!==D3)return this._error="expected string",!1;const r=this._scanner.buf().join("");a.attributes[n]=r;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function Kz(h,e){for(const t in e){if(!e.hasOwnProperty(t))continue;const s=e[t];s instanceof Object?(h.hasOwnProperty(t)||(h[t]={}),Kz(h[t],e[t])):h[t]=s}}function Aee(h){if(h.length===0)return null;const e={};for(let t=0;t<h.length;++t){const s=h[t],i={};i[s.name]={value:s.value,attributes:s.attributes},Kz(e,i)}return e}function Cee(h,e){if(h.length===0)return null;const t={};for(let f=0;f<h.length;++f){const _=h[f];t.hasOwnProperty(_.start)?t[_.start].open===null?t[_.start].open=[_]:t[_.start].open.push(_):t[_.start]={open:[_],close:null},t.hasOwnProperty(_.end)?t[_.end].close===null?t[_.end].close=[_]:t[_.end].close.push(_):t[_.end]={open:null,close:[_]}}let s=[];function i(f){s=s.filter(_=>f.find(g=>g===_)===void 0)}function a(f){for(let _=0;_<f.length;++_)s.push(f[_])}const n=Object.keys(t).sort((f,_)=>f-_),r=[];for(let f=0;f<n.length;++f){const _=t[n[f]];_.close!==null&&i(_.close),_.open!==null&&a(_.open),r.push({start:n[f],tags:Aee(s)})}const l=[];let u=null;for(let f=0;f<r.length;++f){const _=r[f];for(;l.length<_.start;)l.push(u?u.tags:null);u=_}for(;l.length<e;)l.push(null);return l}function wee(h){const e=new Eee(h),t=[],s=[];if(!e.parse(t,s))return console.warn(e.error()),{symbols:h,tags:null};const i=s.find(n=>n.end===null);if(i)return console.warn(`Markup error: found unclosed tag='${i.name}'`),{symbols:h,tags:null};const a=Cee(s,t.length);return{symbols:t,tags:a}}class Ree{static evaluate(e){return wee(e)}}class Mee{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null}}function Dee(h,e){const t=new Ft(h);return t.setPositions(e.positions),t.setNormals(e.normals),t.setColors32(e.colors),t.setUvs(0,e.uvs),t.setIndices(e.indices),t.setVertexStream(g0,e.outlines,3,void 0,it,!1),t.setVertexStream(y0,e.shadows,3,void 0,it,!1),t.update(),t}const c4=/^[\r\n]$/,Pee=/^[ \t]$/,u4=/^[ \t\-]|\u200b$/,Lee=/^[a-z0-9]$/i,d4=/^[\u1100-\u11ff]|[\u3000-\u9fff\ua960-\ua97f]|[\uac00-\ud7ff]$/,Iee=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,Oee=["​","؜","‎","‏","‪","‫","‬","‭","‮","⁦","⁧","⁨","⁩"],Nee={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},f4=new xe,Fee=new Ee,Rs=new xe;class Qz{constructor(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new Xz(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new xe(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new Ee(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new Jt,this._model=new Lh,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new wt,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new xe(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new xe(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new Ee(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(e,t){this._noResize||this._font&&this._updateText()}_onScreenChange(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onDrawOrderChange(e){if(this._drawOrder=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].drawOrder=e}_onPivotChange(e){this._font&&this._updateText()}_onLocaleSet(e){if(this._i18nKey){if(this.fontAsset){const t=this._system.app.assets.get(this.fontAsset);(!t||!t.resource||t.resource!==this._font)&&(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(e){if(this.unicodeConverter){const t=this._system.getUnicodeConverter();t?e=t(e):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==e&&(this._font&&this._updateText(e),this._text=e)}_updateText(e){let t;if(e===void 0&&(e=this._text),this._symbols=Ed.getSymbols(e.normalize?e.normalize("NFC"):e),this._symbols.length===0&&(this._symbols=[" "]),this._enableMarkup){const _=Ree.evaluate(this._symbols);this._symbols=_.symbols,t=_.tags||[]}if(this._rtlReorder){const _=this._system.app.systems.element.getRtlReorder();if(_){const g=_(this._symbols);this._rtl=g.rtl,this._symbols=g.mapping.map(function(y){return this._symbols[y]},this),t&&(t=g.mapping.map(y=>t[y]))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;const s=(_,g)=>`${_.toString(!0).toLowerCase()}:${g.toFixed(2)}`,i=(_,g)=>`${_.toString(!0).toLowerCase()}:${g.x.toFixed(2)}:${g.y.toFixed(2)}`;if(t){const _={},g={},y={};this._colorPalette=[Math.round(this._color.r*255),Math.round(this._color.g*255),Math.round(this._color.b*255)],this._outlinePalette=[Math.round(this._outlineColor.r*255),Math.round(this._outlineColor.g*255),Math.round(this._outlineColor.b*255),Math.round(this._outlineColor.a*255),Math.round(this._outlineThickness*255)],this._shadowPalette=[Math.round(this._shadowColor.r*255),Math.round(this._shadowColor.g*255),Math.round(this._shadowColor.b*255),Math.round(this._shadowColor.a*255),Math.round(this._shadowOffset.x*127),Math.round(this._shadowOffset.y*127)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],_[this._color.toString(!1).toLowerCase()]=0,g[s(this._outlineColor,this._outlineThickness)]=0,y[i(this._shadowColor,this._shadowOffset)]=0;for(let v=0,x=this._symbols.length;v<x;++v){const C=t[v];let M=0;if(C&&C.color&&C.color.value){const R=C.color.value;if(R.length===7&&R[0]==="#"){const D=R.substring(1).toLowerCase();_.hasOwnProperty(D)?M=_[D]:/^[0-9a-f]{6}$/.test(D)&&(M=this._colorPalette.length/3,_[D]=M,this._colorPalette.push(parseInt(D.substring(0,2),16)),this._colorPalette.push(parseInt(D.substring(2,4),16)),this._colorPalette.push(parseInt(D.substring(4,6),16)))}}this._symbolColors.push(M);let w=0;if(C&&C.outline&&(C.outline.attributes.color||C.outline.attributes.thickness)){let R=C.outline.attributes.color?f4.fromString(C.outline.attributes.color):this._outlineColor,D=Number(C.outline.attributes.thickness);(Number.isNaN(R.r)||Number.isNaN(R.g)||Number.isNaN(R.b)||Number.isNaN(R.a))&&(R=this._outlineColor),Number.isNaN(D)&&(D=this._outlineThickness);const I=s(R,D);g.hasOwnProperty(I)?w=g[I]:(w=this._outlinePalette.length/5,g[I]=w,this._outlinePalette.push(Math.round(R.r*255),Math.round(R.g*255),Math.round(R.b*255),Math.round(R.a*255),Math.round(D*255)))}this._symbolOutlineParams.push(w);let T=0;if(C&&C.shadow&&(C.shadow.attributes.color||C.shadow.attributes.offset||C.shadow.attributes.offsetX||C.shadow.attributes.offsetY)){let R=C.shadow.attributes.color?f4.fromString(C.shadow.attributes.color):this._shadowColor;const D=Number(C.shadow.attributes.offset),I=Number(C.shadow.attributes.offsetX),U=Number(C.shadow.attributes.offsetY);(Number.isNaN(R.r)||Number.isNaN(R.g)||Number.isNaN(R.b)||Number.isNaN(R.a))&&(R=this._shadowColor);const O=Fee.set(Number.isNaN(I)?Number.isNaN(D)?this._shadowOffset.x:D:I,Number.isNaN(U)?Number.isNaN(D)?this._shadowOffset.y:D:U),N=i(R,O);y.hasOwnProperty(N)?T=y[N]:(T=this._shadowPalette.length/6,y[N]=T,this._shadowPalette.push(Math.round(R.r*255),Math.round(R.g*255),Math.round(R.b*255),Math.round(R.a*255),Math.round(O.x*127),Math.round(O.y*127)))}this._symbolShadowParams.push(T)}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();const a=this._calculateCharsPerTexture();let n=!1;const r=this._element,l=r._isScreenSpace(),u=r._isScreenCulled(),f=function(_){return r.isVisibleForCamera(_)};for(let _=0,g=this._meshInfo.length;_<g;_++){const y=a[_]||0,v=this._meshInfo[_];if(v.count!==y){if(n||(r.removeModelFromLayers(this._model),n=!0),v.count=y,v.positions.length=v.normals.length=y*3*4,v.indices.length=y*3*2,v.uvs.length=y*2*4,v.colors.length=y*4*4,v.outlines.length=y*4*3,v.shadows.length=y*4*3,v.meshInstance&&this._removeMeshInstance(v.meshInstance),y===0){v.meshInstance=null;continue}for(let M=0;M<y;M++)v.indices[M*3*2+0]=M*4,v.indices[M*3*2+1]=M*4+1,v.indices[M*3*2+2]=M*4+3,v.indices[M*3*2+3]=M*4+2,v.indices[M*3*2+4]=M*4+3,v.indices[M*3*2+5]=M*4+1,v.normals[M*4*3+0]=0,v.normals[M*4*3+1]=0,v.normals[M*4*3+2]=-1,v.normals[M*4*3+3]=0,v.normals[M*4*3+4]=0,v.normals[M*4*3+5]=-1,v.normals[M*4*3+6]=0,v.normals[M*4*3+7]=0,v.normals[M*4*3+8]=-1,v.normals[M*4*3+9]=0,v.normals[M*4*3+10]=0,v.normals[M*4*3+11]=-1;const x=Dee(this._system.app.graphicsDevice,v),C=new ps(x,this._material,this._node);if(C.name=`Text Element: ${this._entity.name}`,C.castShadow=!1,C.receiveShadow=!1,C.cull=!l,C.screenSpace=l,C.drawOrder=this._drawOrder,u&&(C.cull=!0,C.isVisibleFunc=f),this._setTextureParams(C,this._font.textures[_]),C.setParameter("material_emissive",this._colorUniform),C.setParameter("material_opacity",this._color.a),C.setParameter("font_sdfIntensity",this._font.intensity),C.setParameter("font_pxrange",this._getPxRange(this._font)),C.setParameter("font_textureWidth",this._font.data.info.maps[_].width),C.setParameter("outline_color",this._outlineColorUniform),C.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),C.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else{const M=-this._font.data.info.maps[_].width/this._font.data.info.maps[_].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=M*this._shadowOffsetScale*this._shadowOffset.y}C.setParameter("shadow_offset",this._shadowOffsetUniform),v.meshInstance=C,this._model.meshInstances.push(C)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),n&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(e){e.destroy();const t=this._model.meshInstances.indexOf(e);t!==-1&&this._model.meshInstances.splice(t,1)}_setMaterial(e){if(this._material=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++){const i=this._model.meshInstances[t];i.material=e}}_updateMaterial(e){const t=this._element,s=t._isScreenCulled(),i=function(n){return t.isVisibleForCamera(n)},a=this._font&&this._font.type===u1;if(this._material=this._system.getTextElementMaterial(e,a,this._enableMarkup),this._model)for(let n=0,r=this._model.meshInstances.length;n<r;n++){const l=this._model.meshInstances[n];l.cull=!e,l.material=this._material,l.screenSpace=e,s?(l.cull=!0,l.isVisibleFunc=i):l.isVisibleFunc=null}}_updateMaterialEmissive(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(Rs.linear(this._color),this._colorUniform[0]=Rs.r,this._colorUniform[1]=Rs.g,this._colorUniform[2]=Rs.b)}_updateMaterialOutline(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(Rs.linear(this._outlineColor),this._outlineColorUniform[0]=Rs.r,this._outlineColorUniform[1]=Rs.g,this._outlineColorUniform[2]=Rs.b,this._outlineColorUniform[3]=Rs.a)}_updateMaterialShadow(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(Rs.linear(this._shadowColor),this._shadowColorUniform[0]=Rs.r,this._shadowColorUniform[1]=Rs.g,this._shadowColorUniform[2]=Rs.b,this._shadowColorUniform[3]=Rs.a)}_isWordBoundary(e){return u4.test(e)}_isValidNextChar(e){return e!==null&&!Iee.test(e)}_isNextCJKBoundary(e,t){return d4.test(e)&&(u4.test(t)||Lee.test(t))}_isNextCJKWholeWord(e){return d4.test(e)}_updateMeshes(){const e=this._font.data,t=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,a=this._shouldAutoFit();a&&(this._fontSize=this._maxFontSize);const n=32,r=this._symbols.length;let l=0,u=0,f=0,_=0,g=1,y=0,v=0,x=0,C=0,M=0,w=0;const T=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let R=this._element.calculatedWidth;(this.autoWidth&&!T||!this._wrapLines)&&(R=Number.POSITIVE_INFINITY);let D=0,I=0,U,O,N,z;function X(k,K,ee){t._lineWidths.push(Math.abs(ee));const V=x>K?K+1:x,Q=x>K?x+1:K,se=k.slice(V,Q);if(w){let J=se.length;for(;J--&&w>0;)c4.test(se[J])&&(se.splice(J,1),w--)}t._lineContents.push(se.join("")),l=0,u-=t._scaledLineHeight,g++,C=0,M=0,w=0,y=0,x=K}let Y=!0;for(;Y;){Y=!1,a?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],l=0,u=0,f=0,_=0,g=1,y=0,v=0,x=0,C=0,M=0,w=0;const k=this._fontSize/n;D=this._fontMinY*k,I=this._fontMaxY*k;for(let te=0;te<this._meshInfo.length;te++)this._meshInfo[te].quad=0,this._meshInfo[te].lines={};let K=255,ee=255,V=255,Q=255+255*256,se=255+255*256,J=0,ie=255+255*256,oe=255+255*256,he=127+127*256;for(let te=0;te<r;te++){if(U=this._symbols[te],z=te+1>=r?null:this._symbols[te+1],c4.test(U)){w++,(!this._wrapLines||this._maxLines<0||g<this._maxLines)&&(X(this._symbols,te,_),v=te+1,x=te+1);continue}let Se=0,Ae=0,De=0,Fe=1,ot,mt;if(O=e.chars[U],!O)if(Oee.indexOf(U)!==-1)O=Nee;else if(e.chars[" "])O=e.chars[" "];else for(const Xe in e.chars){O=e.chars[Xe];break}if(O){let Xe=0;if(M>0){const Mt=this._font.data.kerning;if(Mt){const rs=Mt[Ed.getCodePoint(this._symbols[te-1])||0];rs&&(Xe=rs[Ed.getCodePoint(this._symbols[te])||0]||0)}}ot=O.scale||1,mt=(O.width+O.height)/2,Fe=k*mt/ot,De=(O.xadvance+Xe)*k,Se=(O.xoffset-Xe)*k,Ae=O.yoffset*k}else console.error(`Couldn't substitute missing character: '${U}'`);const $e=Pee.test(U),es=O&&O.map||0,ht=-this._font.data.info.maps[es].width/this._font.data.info.maps[es].height,Pe=this._meshInfo[es],Zi=l+this._spacing*De;if(Zi>R&&M>0&&!$e&&(this._maxLines<0||g<this._maxLines))if(C===0)v=te,X(this._symbols,te,_);else{const Xe=Math.max(te-v,0);if(this._meshInfo.length<=1)Pe.lines[g-1]-=Xe,Pe.quad-=Xe;else{const Mt=v,rs=te;for(let bs=Mt;bs<rs;bs++){const sn=this._symbols[bs],La=e.chars[sn],Hi=this._meshInfo[La&&La.map||0];Hi.lines[g-1]-=1,Hi.quad-=1}}te-=Xe+1,X(this._symbols,v,y);continue}N=Pe.quad,Pe.lines[g-1]=N;let zs=l-Se,oi=zs+Fe;const lt=u-Ae,ti=lt+Fe;if(this._rtl){const Xe=Fe-Se-this._spacing*De-Se;zs-=Xe,oi-=Xe}Pe.positions[N*4*3+0]=zs,Pe.positions[N*4*3+1]=lt,Pe.positions[N*4*3+2]=f,Pe.positions[N*4*3+3]=oi,Pe.positions[N*4*3+4]=lt,Pe.positions[N*4*3+5]=f,Pe.positions[N*4*3+6]=oi,Pe.positions[N*4*3+7]=ti,Pe.positions[N*4*3+8]=f,Pe.positions[N*4*3+9]=zs,Pe.positions[N*4*3+10]=ti,Pe.positions[N*4*3+11]=f,this.width=Math.max(this.width,Zi);let js;if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(js=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),js=ge.clamp(js,s,i),js!==this._element.fontSize)){this._fontSize=js,Y=!0;break}if(this.height=Math.max(this.height,I-(u+D)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(js=ge.clamp(this._fontSize-1,s,i),js!==this._element.fontSize)){this._fontSize=js,Y=!0;break}l+=this._spacing*De,$e||(_=l),(this._isWordBoundary(U)||this._isValidNextChar(z)&&(this._isNextCJKBoundary(U,z)||this._isNextCJKWholeWord(z)))&&(C++,y=_,v=te+1),M++;const Ys=this._getUv(U);if(Pe.uvs[N*4*2+0]=Ys[0],Pe.uvs[N*4*2+1]=1-Ys[1],Pe.uvs[N*4*2+2]=Ys[2],Pe.uvs[N*4*2+3]=1-Ys[1],Pe.uvs[N*4*2+4]=Ys[2],Pe.uvs[N*4*2+5]=1-Ys[3],Pe.uvs[N*4*2+6]=Ys[0],Pe.uvs[N*4*2+7]=1-Ys[3],this._symbolColors){const Xe=this._symbolColors[te]*3;K=this._colorPalette[Xe],ee=this._colorPalette[Xe+1],V=this._colorPalette[Xe+2]}if(Pe.colors[N*4*4+0]=K,Pe.colors[N*4*4+1]=ee,Pe.colors[N*4*4+2]=V,Pe.colors[N*4*4+3]=255,Pe.colors[N*4*4+4]=K,Pe.colors[N*4*4+5]=ee,Pe.colors[N*4*4+6]=V,Pe.colors[N*4*4+7]=255,Pe.colors[N*4*4+8]=K,Pe.colors[N*4*4+9]=ee,Pe.colors[N*4*4+10]=V,Pe.colors[N*4*4+11]=255,Pe.colors[N*4*4+12]=K,Pe.colors[N*4*4+13]=ee,Pe.colors[N*4*4+14]=V,Pe.colors[N*4*4+15]=255,this._symbolOutlineParams){const Xe=this._symbolOutlineParams[te]*5;Q=this._outlinePalette[Xe]+this._outlinePalette[Xe+1]*256,se=this._outlinePalette[Xe+2]+this._outlinePalette[Xe+3]*256,J=this._outlinePalette[Xe+4]}if(Pe.outlines[N*4*3+0]=Q,Pe.outlines[N*4*3+1]=se,Pe.outlines[N*4*3+2]=J,Pe.outlines[N*4*3+3]=Q,Pe.outlines[N*4*3+4]=se,Pe.outlines[N*4*3+5]=J,Pe.outlines[N*4*3+6]=Q,Pe.outlines[N*4*3+7]=se,Pe.outlines[N*4*3+8]=J,Pe.outlines[N*4*3+9]=Q,Pe.outlines[N*4*3+10]=se,Pe.outlines[N*4*3+11]=J,this._symbolShadowParams){const Xe=this._symbolShadowParams[te]*6;ie=this._shadowPalette[Xe]+this._shadowPalette[Xe+1]*256,oe=this._shadowPalette[Xe+2]+this._shadowPalette[Xe+3]*256,he=this._shadowPalette[Xe+4]+127+Math.round(ht*this._shadowPalette[Xe+5]+127)*256}Pe.shadows[N*4*3+0]=ie,Pe.shadows[N*4*3+1]=oe,Pe.shadows[N*4*3+2]=he,Pe.shadows[N*4*3+3]=ie,Pe.shadows[N*4*3+4]=oe,Pe.shadows[N*4*3+5]=he,Pe.shadows[N*4*3+6]=ie,Pe.shadows[N*4*3+7]=oe,Pe.shadows[N*4*3+8]=he,Pe.shadows[N*4*3+9]=ie,Pe.shadows[N*4*3+10]=oe,Pe.shadows[N*4*3+11]=he,Pe.quad++}Y||x<r&&X(this._symbols,r,l)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const F=this._element.pivot.x,q=this._element.pivot.y,G=this._alignment.x,W=this._alignment.y;for(let k=0;k<this._meshInfo.length;k++){if(this._meshInfo[k].count===0)continue;let K=0;for(const se in this._meshInfo[k].lines){const J=this._meshInfo[k].lines[se],ie=this._lineWidths[parseInt(se,10)],oe=-F*this._element.calculatedWidth+G*(this._element.calculatedWidth-ie)*(this._rtl?-1:1),he=(1-q)*this._element.calculatedHeight-I-(1-W)*(this._element.calculatedHeight-this.height);for(let te=K;te<=J;te++)this._meshInfo[k].positions[te*4*3]+=oe,this._meshInfo[k].positions[te*4*3+3]+=oe,this._meshInfo[k].positions[te*4*3+6]+=oe,this._meshInfo[k].positions[te*4*3+9]+=oe,this._meshInfo[k].positions[te*4*3+1]+=he,this._meshInfo[k].positions[te*4*3+4]+=he,this._meshInfo[k].positions[te*4*3+7]+=he,this._meshInfo[k].positions[te*4*3+10]+=he;if(this._rtl)for(let te=K;te<=J;te++){const le=te*4*3;for(let De=0;De<4;++De)this._meshInfo[k].positions[le+De*3]=this._element.calculatedWidth-this._meshInfo[k].positions[le+De*3]+oe*2;const Se=this._meshInfo[k].positions[le+3],Ae=this._meshInfo[k].positions[le+6];this._meshInfo[k].positions[le+3]=this._meshInfo[k].positions[le+0],this._meshInfo[k].positions[le+6]=this._meshInfo[k].positions[le+9],this._meshInfo[k].positions[le+0]=Se,this._meshInfo[k].positions[le+9]=Ae}K=J+1}const ee=this._meshInfo[k].count*4,V=this._meshInfo[k].quad*4,Q=new i0(this._meshInfo[k].meshInstance.mesh.vertexBuffer);for(let se=0;se<ee;se++)se>=V?(Q.element[kt].set(0,0,0),Q.element[Za].set(0,0),Q.element[Qi].set(0,0,0,0),Q.element[g0].set(0,0,0,0),Q.element[y0].set(0,0,0,0)):(Q.element[kt].set(this._meshInfo[k].positions[se*3+0],this._meshInfo[k].positions[se*3+1],this._meshInfo[k].positions[se*3+2]),Q.element[Za].set(this._meshInfo[k].uvs[se*2+0],this._meshInfo[k].uvs[se*2+1]),Q.element[Qi].set(this._meshInfo[k].colors[se*4+0],this._meshInfo[k].colors[se*4+1],this._meshInfo[k].colors[se*4+2],this._meshInfo[k].colors[se*4+3]),Q.element[g0].set(this._meshInfo[k].outlines[se*3+0],this._meshInfo[k].outlines[se*3+1],this._meshInfo[k].outlines[se*3+2]),Q.element[y0].set(this._meshInfo[k].shadows[se*3+0],this._meshInfo[k].shadows[se*3+1],this._meshInfo[k].shadows[se*3+2])),Q.next();Q.end(),this._meshInfo[k].meshInstance.mesh.aabb.compute(this._meshInfo[k].positions),this._meshInfo[k].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(e){this.font!==e.resource&&(this.font=e.resource)}_onFontChange(e,t,s,i){if(t==="data"){this._font.data=s;const a=this._font.data.info.maps.length;for(let n=0;n<a;n++){if(!this._meshInfo[n])continue;const r=this._meshInfo[n].meshInstance;r&&(r.setParameter("font_sdfIntensity",this._font.intensity),r.setParameter("font_pxrange",this._getPxRange(this._font)),r.setParameter("font_textureWidth",this._font.data.info.maps[n].width))}}}_onFontRemove(e){}_setTextureParams(e,t){this._font&&(this._font.type===u1?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):this._font.type===jz&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))}_getPxRange(e){const t=Object.keys(this._font.data.chars);for(let s=0;s<t.length;s++){const i=this._font.data.chars[t[s]];if(i.range)return(i.scale||1)*i.range}return 2}_getUv(e){const t=this._font.data;if(!t.chars[e]){const y=" ";return t.chars[y]?this._getUv(y):[0,0,0,0]}const s=t.chars[e].map,i=t.info.maps[s].width,a=t.info.maps[s].height,n=t.chars[e].x,r=t.chars[e].y,l=n,u=r,f=n+t.chars[e].width,_=r-t.chars[e].height,g=1-t.chars[e].height/a;return[l/i,g-u/a,f/i,g-_/a]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(e){if(this._model){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].stencilFront=e,t[s].stencilBack=e}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(e){const t={};e===void 0&&(e=this._symbols.length);for(let s=0,i=e;s<i;s++){const a=this._symbols[s];let n=this._font.data.chars[a];n||(n=this._font.data.chars[" "],n||(n=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const r=n.map;t[r]?t[r]++:t[r]=1}return t}_updateRenderRange(){const e=this._rangeStart===0?0:this._calculateCharsPerTexture(this._rangeStart),t=this._rangeEnd===0?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const a=e[s]||0,n=t[s]||0,r=this._meshInfo[s].meshInstance;if(r){const l=r.mesh;l&&(l.primitive[0].base=a*3*2,l.primitive[0].count=(n-a)*3*2)}}}set text(e){this._i18nKey=null;const t=e!=null&&e.toString()||"";this._setText(t)}get text(){return this._text}set key(e){const t=e!==null?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(e){const t=e.r,s=e.g,i=e.b;if(!(this._color.r===t&&this._color.g===s&&this._color.b===i)&&(this._color.r=t,this._color.g=s,this._color.b=i,!!this._model)){if(this._symbolColors)this._font&&this._updateText();else{Rs.linear(this._color),this._colorUniform[0]=Rs.r,this._colorUniform[1]=Rs.g,this._colorUniform[2]=Rs.b;for(let a=0,n=this._model.meshInstances.length;a<n;a++)this._model.meshInstances[a].setParameter("material_emissive",this._colorUniform)}this._element&&this._element.fire("set:color",this._color)}}get color(){return this._color}set opacity(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].setParameter("material_opacity",e);this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set lineHeight(e){const t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(e){const t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(e){const t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(e){const t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(e){this._fontAsset.defaultAsset=e}get fontAsset(){return this._fontAsset.localizedAsset}set font(e){let t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,!e)return;const s=this._font.data;for(const a in s.chars){const n=s.chars[a];n.bounds&&(this._fontMinY=Math.min(this._fontMinY,n.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,n.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t){const a=this._element._isScreenSpace();this._updateMaterial(a)}for(let a=0,n=this._font.textures.length;a<n;a++)if(!this._meshInfo[a])this._meshInfo[a]=new Mee;else{const r=this._meshInfo[a].meshInstance;r&&(r.setParameter("font_sdfIntensity",this._font.intensity),r.setParameter("font_pxrange",this._getPxRange(this._font)),r.setParameter("font_textureWidth",this._font.data.info.maps[a].width),this._setTextureParams(r,this._font.textures[a]))}let i=!1;for(let a=this._font.textures.length;a<this._meshInfo.length;a++)this._meshInfo[a].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[a].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(e){e instanceof Ee?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(e){const t=this._autoWidth;if(this._autoWidth=e,e&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),t!==e){const s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(e){const t=this._autoHeight;if(this._autoHeight=e,e&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),t!==e){const s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let e=!1;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(e){const t=e instanceof xe?e.r:e[0],s=e instanceof xe?e.g:e[1],i=e instanceof xe?e.b:e[2],a=e instanceof xe?e.a:e[3];if(!(this._outlineColor.r===t&&this._outlineColor.g===s&&this._outlineColor.b===i&&this._outlineColor.a===a)&&(this._outlineColor.r=t,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=a,!!this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else{Rs.linear(this._outlineColor),this._outlineColorUniform[0]=Rs.r,this._outlineColorUniform[1]=Rs.g,this._outlineColorUniform[2]=Rs.b,this._outlineColorUniform[3]=Rs.a;for(let n=0,r=this._model.meshInstances.length;n<r;n++)this._model.meshInstances[n].setParameter("outline_color",this._outlineColorUniform)}this._element&&this._element.fire("set:outline",this._color)}}get outlineColor(){return this._outlineColor}set outlineThickness(e){const t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(let s=0,i=this._model.meshInstances.length;s<i;s++)this._model.meshInstances[s].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}get outlineThickness(){return this._outlineThickness}set shadowColor(e){const t=e instanceof xe?e.r:e[0],s=e instanceof xe?e.g:e[1],i=e instanceof xe?e.b:e[2],a=e instanceof xe?e.a:e[3];if(!(this._shadowColor.r===t&&this._shadowColor.g===s&&this._shadowColor.b===i&&this._shadowColor.a===a)&&(this._shadowColor.r=t,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=a,!!this._model))if(this._symbolShadowParams)this._font&&this._updateText();else{Rs.linear(this._shadowColor),this._shadowColorUniform[0]=Rs.r,this._shadowColorUniform[1]=Rs.g,this._shadowColorUniform[2]=Rs.b,this._shadowColorUniform[3]=Rs.a;for(let n=0,r=this._model.meshInstances.length;n<r;n++)this._model.meshInstances[n].setParameter("shadow_color",this._shadowColorUniform)}}get shadowColor(){return this._shadowColor}set shadowOffset(e){const t=e instanceof Ee?e.x:e[0],s=e instanceof Ee?e.y:e[1];if(!(this._shadowOffset.x===t&&this._shadowOffset.y===s)&&(this._shadowOffset.set(t,s),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(let i=0,a=this._model.meshInstances.length;i<a;i++){const n=-this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=n*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[i].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(e){this._maxLines!==e&&(e===null&&this._maxLines===-1||(this._maxLines=e===null?-1:e,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(e){if(e=!!e,this._enableMarkup===e)return;this._enableMarkup=e,this.font&&this._updateText();const t=this._element._isScreenSpace();this._updateMaterial(t)}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return this._symbolColors===null?null:this._symbolColors.map(function(e){return this._colorPalette.slice(e*3,e*3+3)},this)}get symbolOutlineParams(){return this._symbolOutlineParams===null?null:this._symbolOutlineParams.map(function(e){return this._outlinePalette.slice(e*5,e*5+5)},this)}get symbolShadowParams(){return this._symbolShadowParams===null?null:this._symbolShadowParams.map(function(e){return this._shadowPalette.slice(e*6,e*6+6)},this)}get rtl(){return this._rtl}set rangeStart(e){e=Math.max(0,Math.min(e,this._symbols.length)),e!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(e){e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)),e!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}const WR=new H,p4=new Me,yc=new H,Bee=new H,Zr=new Me,NE=new Me,FE=new Me,Sg=new Me,ur=class ur extends xt{constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._beingInitialized=!1,this._anchor=new Ie,this._localAnchor=new Ie,this._pivot=new Ee,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new Ie(0,0,-32,-32),this._modelTransform=new Me,this._screenToWorld=new Me,this._anchorTransform=new Me,this._anchorDirty=!0,this._parentWorldTransform=new Me,this._screenTransform=new Me,this._screenCorners=[new H,new H,new H,new H],this._canvasCorners=[new Ee,new Ee,new Ee,new Ee],this._worldCorners=[new H,new H,new H,new H],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=Sb,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode=bb,this._useInput=!1,this._layers=[ty],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){const t=this.data,s=t.enabled;t.enabled=e,this.fire("set","enabled",s,e)}get enabled(){return this.data.enabled}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(e){e instanceof Ie?this._anchor.copy(e):this._anchor.set(...e),!this.entity._parent&&!this.screen?this._calculateLocalAnchors():this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(e){var t,s;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&((t=this.system.app.batcher)==null||t.remove(zi.ELEMENT,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&((s=this.system.app.batcher)==null||s.insert(zi.ELEMENT,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e)}get batchGroupId(){return this._batchGroupId}set bottom(e){this._margin.y=e;const t=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+e;this._setHeight(s-i),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}get bottom(){return this._margin.y}set calculatedWidth(e){this._setCalculatedWidth(e,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(e){this._setCalculatedHeight(e,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const e=this.system.app.graphicsDevice,t=this.screenCorners,s=e.canvas.clientWidth/e.width,i=e.canvas.clientHeight/e.height;for(let a=0;a<4;a++)this._canvasCorners[a].set(t[a].x*s,(e.height-t[a].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(e){let t=0;this.screen&&(t=this.screen.screen.priority),e>16777215&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(e){if(this._addedModels.length)for(let t=0;t<this._layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);if(s)for(let i=0;i<this._addedModels.length;i++)s.removeMeshInstances(this._addedModels[i].meshInstances)}if(this._layers=e,!(!this.enabled||!this.entity.enabled||!this._addedModels.length))for(let t=0;t<this._layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);if(s)for(let i=0;i<this._addedModels.length;i++)s.addMeshInstances(this._addedModels[i].meshInstances)}}get layers(){return this._layers}set left(e){this._margin.x=e;const t=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+e;this._setWidth(s-i),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}get left(){return this._margin.x}set margin(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(e){const{pivot:t,margin:s}=this,i=t.x,a=t.y;e instanceof Ee?t.copy(e):t.set(...e);const n=s.x+s.z,r=t.x-i;s.x+=n*r,s.z-=n*r;const l=s.y+s.w,u=t.y-a;s.y+=l*u,s.w-=l*u,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",t)}get pivot(){return this._pivot}set right(e){this._margin.z=e;const t=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-e;this._setWidth(i-s),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const t=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),t&&this._screenCorners[s].mulScalar(this.screen.screen.scale),e&&this._screenCorners[s].add(e);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(e){this._margin.w=e;const t=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-e;this._setHeight(i-s),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}get top(){return this._margin.w}set type(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===$A?this._image=new qz(this):e===ZP&&(this._text=new Qz(this)))}get type(){return this._type}set useInput(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e))}get useInput(){return this._useInput}set fitMode(e){this._fitMode=e,this._calculateSize(!0,!0),this._image&&this._image.refreshMesh()}get fitMode(){return this._fitMode}set width(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const e=this.screenCorners;if(!this.screen.screen.screenSpace){Zr.copy(this.screen.screen._screenMatrix),Zr.data[13]=-Zr.data[13],Zr.mul2(this.screen.getWorldTransform(),Zr);for(let t=0;t<4;t++)Zr.transformPoint(e[t],this._worldCorners[t])}}else{const e=this.entity.getLocalPosition();Zr.setTranslate(-e.x,-e.y,-e.z),NE.setTRS(H.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),FE.setTranslate(e.x,e.y,e.z);const t=this.entity.parent?this.entity.parent:this.entity;Sg.copy(t.getWorldTransform()),Sg.mul(FE).mul(NE).mul(Zr),yc.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),Sg.transformPoint(yc,this._worldCorners[0]),yc.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),Sg.transformPoint(yc,this._worldCorners[1]),yc.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),Sg.transformPoint(yc,this._worldCorners[2]),yc.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),Sg.transformPoint(yc,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}set fontSize(e){this._setValue("fontSize",e)}get fontSize(){return this._text?this._text.fontSize:null}set minFontSize(e){this._setValue("minFontSize",e)}get minFontSize(){return this._text?this._text.minFontSize:null}set maxFontSize(e){this._setValue("maxFontSize",e)}get maxFontSize(){return this._text?this._text.maxFontSize:null}set maxLines(e){this._setValue("maxLines",e)}get maxLines(){return this._text?this._text.maxLines:null}set autoFitWidth(e){this._setValue("autoFitWidth",e)}get autoFitWidth(){return this._text?this._text.autoFitWidth:null}set autoFitHeight(e){this._setValue("autoFitHeight",e)}get autoFitHeight(){return this._text?this._text.autoFitHeight:null}set color(e){this._setValue("color",e)}get color(){return this._text?this._text.color:this._image?this._image.color:null}set font(e){this._setValue("font",e)}get font(){return this._text?this._text.font:null}set fontAsset(e){this._setValue("fontAsset",e)}get fontAsset(){return this._text&&typeof this._text.fontAsset=="number"?this._text.fontAsset:null}set spacing(e){this._setValue("spacing",e)}get spacing(){return this._text?this._text.spacing:null}set lineHeight(e){this._setValue("lineHeight",e)}get lineHeight(){return this._text?this._text.lineHeight:null}set wrapLines(e){this._setValue("wrapLines",e)}get wrapLines(){return this._text?this._text.wrapLines:null}set lines(e){this._setValue("lines",e)}get lines(){return this._text?this._text.lines:null}set alignment(e){this._setValue("alignment",e)}get alignment(){return this._text?this._text.alignment:null}set autoWidth(e){this._setValue("autoWidth",e)}get autoWidth(){return this._text?this._text.autoWidth:null}set autoHeight(e){this._setValue("autoHeight",e)}get autoHeight(){return this._text?this._text.autoHeight:null}set rtlReorder(e){this._setValue("rtlReorder",e)}get rtlReorder(){return this._text?this._text.rtlReorder:null}set unicodeConverter(e){this._setValue("unicodeConverter",e)}get unicodeConverter(){return this._text?this._text.unicodeConverter:null}set text(e){this._setValue("text",e)}get text(){return this._text?this._text.text:null}set key(e){this._setValue("key",e)}get key(){return this._text?this._text.key:null}set texture(e){this._setValue("texture",e)}get texture(){return this._image?this._image.texture:null}set textureAsset(e){this._setValue("textureAsset",e)}get textureAsset(){return this._image?this._image.textureAsset:null}set material(e){this._setValue("material",e)}get material(){return this._image?this._image.material:null}set materialAsset(e){this._setValue("materialAsset",e)}get materialAsset(){return this._image?this._image.materialAsset:null}set sprite(e){this._setValue("sprite",e)}get sprite(){return this._image?this._image.sprite:null}set spriteAsset(e){this._setValue("spriteAsset",e)}get spriteAsset(){return this._image?this._image.spriteAsset:null}set spriteFrame(e){this._setValue("spriteFrame",e)}get spriteFrame(){return this._image?this._image.spriteFrame:null}set pixelsPerUnit(e){this._setValue("pixelsPerUnit",e)}get pixelsPerUnit(){return this._image?this._image.pixelsPerUnit:null}set opacity(e){this._setValue("opacity",e)}get opacity(){return this._text?this._text.opacity:this._image?this._image.opacity:null}set rect(e){this._setValue("rect",e)}get rect(){return this._image?this._image.rect:null}set mask(e){this._setValue("mask",e)}get mask(){return this._image?this._image.mask:null}set outlineColor(e){this._setValue("outlineColor",e)}get outlineColor(){return this._text?this._text.outlineColor:null}set outlineThickness(e){this._setValue("outlineThickness",e)}get outlineThickness(){return this._text?this._text.outlineThickness:null}set shadowColor(e){this._setValue("shadowColor",e)}get shadowColor(){return this._text?this._text.shadowColor:null}set shadowOffset(e){this._setValue("shadowOffset",e)}get shadowOffset(){return this._text?this._text.shadowOffset:null}set enableMarkup(e){this._setValue("enableMarkup",e)}get enableMarkup(){return this._text?this._text.enableMarkup:null}set rangeStart(e){this._setValue("rangeStart",e)}get rangeStart(){return this._text?this._text.rangeStart:null}set rangeEnd(e){this._setValue("rangeEnd",e)}get rangeEnd(){return this._text?this._text.rangeEnd:null}_setValue(e,t){this._text?(this._text[e]!==t&&this._dirtyBatch(),this._text[e]=t):this._image&&(this._image[e]!==t&&this._dirtyBatch(),this._image[e]=t)}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=Kt.prototype._sync,this.entity.setPosition=Kt.prototype.setPosition,this.entity.setLocalPosition=Kt.prototype.setLocalPosition}_setPosition(e,t,s){if(!this.element.screen){Kt.prototype.setPosition.call(this,e,t,s);return}e instanceof H?WR.copy(e):WR.set(e,t,s),this.getWorldTransform(),p4.copy(this.element._screenToWorld).invert(),p4.transformPoint(WR,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(e,t,s){e instanceof H?this.localPosition.copy(e):this.localPosition.set(e,t,s);const i=this.element,a=this.localPosition,n=i._pivot;i._margin.x=a.x-i._calculatedWidth*n.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=a.y-i._calculatedHeight*n.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const e=this.element,t=e.screen;if(t){if(e._anchorDirty){let s=0,i=0,a=0,n=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,a=this._parent.element.pivot.x,n=this._parent.element.pivot.y;else{const r=t.screen.resolution;s=r.x/t.screen.scale,i=r.y/t.screen.scale}e._anchorTransform.setTranslate(s*(e.anchor.x-a),-(i*(n-e.anchor.y)),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const s=this.localPosition,i=e._pivot;e._margin.x=s.x-e._calculatedWidth*i.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=s.y-e._calculatedHeight*i.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1}if(!t){this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),Kt.prototype._sync.call(this);return}if(this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);const s=e._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==t&&(Zr.setTRS(H.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,Zr));const a=yc;a.set(0,0,this.localPosition.z);const n=Bee;n.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),Zr.setTranslate(-n.x,-n.y,-n.z),NE.setTRS(a,this.getLocalRotation(),this.getLocalScale()),FE.setTranslate(n.x,n.y,n.z),e._screenTransform.mul2(e._parentWorldTransform,FE).mul(NE).mul(Zr),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=!1}}_onInsert(e){const t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask()}_dirtifyMask(){let e=this.entity;for(;e;){const t=e.parent;if((t===null||t.screen)&&e.element){(!this.system._prerender||!this.system._prerender.length)&&(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const s=this.system._prerender.indexOf(this.entity);s>=0&&this.system._prerender.splice(s,1),this.system._prerender.indexOf(e)<0&&this.system._prerender.push(e)}e=t}}_onPrerender(){for(let e=0;e<this.system._prerender.length;e++){const t=this.system._prerender[e];t.element&&t.element.syncMask(1)}this.system._prerender.length=0}_bindScreen(e){e._bindElement(this)}_unbindScreen(e){e._unbindElement(this)}_updateScreen(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);const t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;const s=this.entity.children;for(let i=0,a=s.length;i<a;i++)s[i].element&&s[i].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(e){const t=this._parseUpToScreen();this._updateMask(t.mask,e)}_setMaskedBy(e){const t=this._image||this._text;if(e){const s=e.element._image._maskRef;t==null||t._setStencil(new pr({ref:s,func:Fb})),this._maskedBy=e}else t==null||t._setStencil(null),this._maskedBy=null}_updateMask(e,t){var s,i;if(e){if(this._setMaskedBy(e),this.mask){const n=e.element._image._maskRef,r=new pr({ref:n,func:Fb,zpass:FF});this._image._setStencil(r),this._image._maskRef=t,t++,e=this.entity}const a=this.entity.children;for(let n=0,r=a.length;n<r;n++)(s=a[n].element)==null||s._updateMask(e,t);this.mask&&t--}else{if(this._setMaskedBy(null),this.mask){const n=new pr({ref:t,func:Sh,zpass:NF});this._image._setStencil(n),this._image._maskRef=t,t++,e=this.entity}const a=this.entity.children;for(let n=0,r=a.length;n<r;n++)(i=a[n].element)==null||i._updateMask(e,t);this.mask&&t--}}_parseUpToScreen(){const e={screen:null,mask:null};let t=this.entity._parent;for(;t&&!t.screen;)t.element&&t.element.mask&&(e.mask||(e.mask=t)),t=t.parent;return t&&t.screen&&(e.screen=t),e}_onScreenResize(e){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let e=1e3,t=1e3;const s=this.entity._parent;if(s&&s.element)e=s.element.calculatedWidth,t=s.element.calculatedHeight;else if(this.screen){const i=this.screen.screen.resolution,a=this.screen.screen.scale;e=i.x/a,t=i.y/a}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)}getOffsetPosition(e,t){const s=this.entity.getLocalPosition().clone();return s.x+=e,s.y+=t,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(e){this.layers.indexOf(e.id)<0||(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))}onEnable(){var s;const e=this.system.app.scene,t=e.layers;this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&((s=this.system.app.batcher)==null||s.insert(zi.ELEMENT,this.batchGroupId,this.entity)),this.fire("enableelement")}onDisable(){var s,i,a,n;const t=this.system.app.scene.layers;(s=this._evtLayersChanged)==null||s.off(),this._evtLayersChanged=null,t&&((i=this._evtLayerAdded)==null||i.off(),this._evtLayerAdded=null,(a=this._evtLayerRemoved)==null||a.off(),this._evtLayerRemoved=null),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&((n=this.system.app.batcher)==null||n.remove(zi.ELEMENT,this.batchGroupId,this.entity)),this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(e,t){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;e?this._setWidth(s):this._setCalculatedWidth(s,!1),t?this._setHeight(i):this._setCalculatedHeight(i,!1);const a=this.entity.getLocalPosition();a.x=this._margin.x+this._calculatedWidth*this._pivot.x,a.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(a),this._sizeDirty=!1}_setWidth(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)}_setHeight(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)}_setCalculatedWidth(e,t){if(!(Math.abs(e-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){const s=this.entity.getLocalPosition(),i=this._pivot;this._margin.x=s.x-this._calculatedWidth*i.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(e,t){if(!(Math.abs(e-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){const s=this.entity.getLocalPosition(),i=this._pivot;this._margin.y=s.y-this._calculatedHeight*i.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const e=this.entity._children;for(let t=0,s=e.length;t<s;t++)e[t].element&&(e[t].element._anchorDirty=!0,e[t].element._sizeDirty=!0)}addModelToLayers(e){this._addedModels.push(e);for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.addMeshInstances(e.meshInstances)}}removeModelFromLayers(e){const t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(let s=0;s<this.layers.length;s++){const i=this.system.app.scene.layers.getLayerById(this.layers[s]);i&&i.removeMeshInstances(e.meshInstances)}}getMaskOffset(){const e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);const t=this._maskOffset;return this._maskOffset-=.001,t}isVisibleForCamera(e){let t,s,i,a;if(this.maskedBy){const _=this.maskedBy.element.screenCorners;t=Math.min(Math.min(_[0].x,_[1].x),Math.min(_[2].x,_[3].x)),s=Math.max(Math.max(_[0].x,_[1].x),Math.max(_[2].x,_[3].x)),a=Math.min(Math.min(_[0].y,_[1].y),Math.min(_[2].y,_[3].y)),i=Math.max(Math.max(_[0].y,_[1].y),Math.max(_[2].y,_[3].y))}else{const _=this.system.app.graphicsDevice.width,g=this.system.app.graphicsDevice.height,y=e._rect.z*_,v=e._rect.w*g;t=e._rect.x*_,s=t+y,i=(1-e._rect.y)*g,a=i-v}const n=this.screenCorners,r=Math.min(Math.min(n[0].x,n[1].x),Math.min(n[2].x,n[3].x)),l=Math.max(Math.max(n[0].x,n[1].x),Math.max(n[2].x,n[3].x)),u=Math.min(Math.min(n[0].y,n[1].y),Math.min(n[2].y,n[3].y)),f=Math.max(Math.max(n[0].y,n[1].y),Math.max(n[2].y,n[3].y));return!(l<t||r>s||u>i||f<a)}_isScreenSpace(){return this.screen&&this.screen.screen?this.screen.screen.screenSpace:!1}_isScreenCulled(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1}_dirtyBatch(){var e;this.batchGroupId!==-1&&((e=this.system.app.batcher)==null||e.markGroupDirty(this.batchGroupId))}};ur.EVENT_MOUSEDOWN="mousedown",ur.EVENT_MOUSEUP="mouseup",ur.EVENT_MOUSEENTER="mouseenter",ur.EVENT_MOUSELEAVE="mouseleave",ur.EVENT_MOUSEMOVE="mousemove",ur.EVENT_MOUSEWHEEL="mousewheel",ur.EVENT_CLICK="click",ur.EVENT_TOUCHSTART="touchstart",ur.EVENT_TOUCHEND="touchend",ur.EVENT_TOUCHMOVE="touchmove",ur.EVENT_TOUCHCANCEL="touchcancel";let d1=ur;class Uee{constructor(){this.enabled=!0}}const zee=["enabled"];class $z extends ei{constructor(e){super(e),this.id="element",this.ComponentType=d1,this.DataType=Uee,this.schema=zee,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new Ge(e.graphicsDevice,{width:1,height:1,format:ki,name:"element-system"});const t=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,t.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this._defaultTextMaterials={},this.defaultImageMaterials=[],this.on("add",this.onAddComponent,this),this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(e,t,s){e._beingInitialized=!0,t.anchor!==void 0&&(t.anchor instanceof Ie?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),t.pivot!==void 0&&(t.pivot instanceof Ee?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));const i=Math.abs(e.anchor.x-e.anchor.z)>.001,a=Math.abs(e.anchor.y-e.anchor.w)>.001;let n=!1,r;t.margin!==void 0&&(t.margin instanceof Ie?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),n=!0),t.left!==void 0&&(e._margin.x=t.left,n=!0),t.bottom!==void 0&&(e._margin.y=t.bottom,n=!0),t.right!==void 0&&(e._margin.z=t.right,n=!0),t.top!==void 0&&(e._margin.w=t.top,n=!0),n&&(e.margin=e._margin);let l=!1;t.width!==void 0&&!i?e.width=t.width:i&&(l=!0),t.height!==void 0&&!a?e.height=t.height:a&&(l=!0),l&&(e.anchor=e.anchor),t.enabled!==void 0&&(e.enabled=t.enabled),t.useInput!==void 0&&(e.useInput=t.useInput),t.fitMode!==void 0&&(e.fitMode=t.fitMode),e.batchGroupId=t.batchGroupId===void 0||t.batchGroupId===null?-1:t.batchGroupId,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),t.type!==void 0&&(e.type=t.type),e.type===$A?(t.rect!==void 0&&(e.rect=t.rect),t.color!==void 0&&(r=t.color,r instanceof xe||(r=new xe(t.color[0],t.color[1],t.color[2])),e.color=r),t.opacity!==void 0&&(e.opacity=t.opacity),t.textureAsset!==void 0&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),t.spriteAsset!==void 0&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),t.spriteFrame!==void 0&&(e.spriteFrame=t.spriteFrame),t.pixelsPerUnit!==void 0&&t.pixelsPerUnit!==null&&(e.pixelsPerUnit=t.pixelsPerUnit),t.materialAsset!==void 0&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),t.mask!==void 0&&(e.mask=t.mask)):e.type===ZP&&(t.autoWidth!==void 0&&(e.autoWidth=t.autoWidth),t.autoHeight!==void 0&&(e.autoHeight=t.autoHeight),t.rtlReorder!==void 0&&(e.rtlReorder=t.rtlReorder),t.unicodeConverter!==void 0&&(e.unicodeConverter=t.unicodeConverter),t.text!==null&&t.text!==void 0?e.text=t.text:t.key!==null&&t.key!==void 0&&(e.key=t.key),t.color!==void 0&&(r=t.color,r instanceof xe||(r=new xe(r[0],r[1],r[2])),e.color=r),t.opacity!==void 0&&(e.opacity=t.opacity),t.spacing!==void 0&&(e.spacing=t.spacing),t.fontSize!==void 0&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),t.lineHeight!==void 0&&(e.lineHeight=t.lineHeight),t.maxLines!==void 0&&(e.maxLines=t.maxLines),t.wrapLines!==void 0&&(e.wrapLines=t.wrapLines),t.minFontSize!==void 0&&(e.minFontSize=t.minFontSize),t.maxFontSize!==void 0&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),t.fontAsset!==void 0&&(e.fontAsset=t.fontAsset),t.font!==void 0&&(e.font=t.font),t.alignment!==void 0&&(e.alignment=t.alignment),t.outlineColor!==void 0&&(e.outlineColor=t.outlineColor),t.outlineThickness!==void 0&&(e.outlineThickness=t.outlineThickness),t.shadowColor!==void 0&&(e.shadowColor=t.shadowColor),t.shadowOffset!==void 0&&(e.shadowOffset=t.shadowOffset),t.enableMarkup!==void 0&&(e.enableMarkup=t.enableMarkup));const u=e._parseUpToScreen();u.screen&&e._updateScreen(u.screen),super.initializeComponentData(e,t,s),e._beingInitialized=!1,e.type===$A&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh)}onAddComponent(e,t){e.fire("element:add")}onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,fitMode:s.fitMode,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return s.key!==void 0&&s.key!==null?i.key=s.key:i.text=s.text,this.addComponent(t,i)}getTextElementMaterial(e,t,s){const i=(e&&1)|(t&&2)|(s&&4);let a=this._defaultTextMaterials[i];if(a)return a;let n="TextMaterial";return a=new Vi,t?(a.msdfMap=this._defaultTexture,a.msdfTextAttribute=s,a.emissive.set(1,1,1)):(n=`Bitmap${n}`,a.emissive.set(1,1,1),a.emissiveMap=this._defaultTexture,a.opacityMap=this._defaultTexture,a.opacityMapChannel="a"),e&&(n=`ScreenSpace${n}`,a.depthTest=!1),a.name=`default${n}`,a.useLighting=!1,a.useTonemap=!1,a.useFog=!1,a.useSkybox=!1,a.diffuse.set(0,0,0),a.opacity=.5,a.blendType=Wd,a.depthWrite=!1,a.emissiveVertexColor=!0,a.update(),this._defaultTextMaterials[i]=a,a}_createBaseImageMaterial(){const e=new Vi;return e.diffuse.set(0,0,0),e.emissive.set(1,1,1),e.emissiveMap=this._defaultTexture,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.useLighting=!1,e.useTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=Wd,e.depthWrite=!1,e}getImageElementMaterial(e,t,s,i){return e?t?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=Bi,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=Ui,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=Bi,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=Ui,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):t?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=Bi,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=Ui,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=Bi,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=Ui,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(e){this._unicodeConverter=e}registerRtlReorder(e){this._rtlReorder=e}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}const Tp="free",Ep="limited",Ap="locked",kee=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class XC extends xt{constructor(e,t){super(e,t),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX=Ap,this._linearLimitsX=new Ee(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=Ap,this._linearLimitsY=new Ee(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=Ap,this._linearLimitsZ=new Ee(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=Ap,this._angularLimitsX=new Ee(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=Ap,this._angularLimitsY=new Ee(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=Ap,this._angularLimitsZ=new Ee(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(e){this._destroyConstraint(),this._entityA=e,this._createConstraint()}get entityA(){return this._entityA}set entityB(e){this._destroyConstraint(),this._entityB=e,this._createConstraint()}get entityB(){return this._entityB}set breakForce(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e)}get breakForce(){return this._breakForce}set enableCollision(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(e,t){const s=e.getTranslation(),i=new Ne;i.setFromMat4(e);const a=new Ammo.btVector3(s.x,s.y,s.z),n=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);t.setOrigin(a),t.setRotation(n),Ammo.destroy(a),Ammo.destroy(n)}_updateAngularLimits(){const e=this._constraint;if(e){let t,s,i,a,n,r;this._angularMotionX===Ep?(t=this._angularLimitsX.x*ge.DEG_TO_RAD,a=this._angularLimitsX.y*ge.DEG_TO_RAD):this._angularMotionX===Tp?(t=1,a=0):t=a=0,this._angularMotionY===Ep?(s=this._angularLimitsY.x*ge.DEG_TO_RAD,n=this._angularLimitsY.y*ge.DEG_TO_RAD):this._angularMotionY===Tp?(s=1,n=0):s=n=0,this._angularMotionZ===Ep?(i=this._angularLimitsZ.x*ge.DEG_TO_RAD,r=this._angularLimitsZ.y*ge.DEG_TO_RAD):this._angularMotionZ===Tp?(i=1,r=0):i=r=0;const l=new Ammo.btVector3(t,s,i);e.setAngularLowerLimit(l),l.setValue(a,n,r),e.setAngularUpperLimit(l),Ammo.destroy(l)}}_updateLinearLimits(){const e=this._constraint;if(e){let t,s,i,a,n,r;this._linearMotionX===Ep?(t=this._linearLimitsX.x,a=this._linearLimitsX.y):this._linearMotionX===Tp?(t=1,a=0):t=a=0,this._linearMotionY===Ep?(s=this._linearLimitsY.x,n=this._linearLimitsY.y):this._linearMotionY===Tp?(s=1,n=0):s=n=0,this._linearMotionZ===Ep?(i=this._linearLimitsZ.x,r=this._linearLimitsZ.y):this._linearMotionZ===Tp?(i=1,r=0):i=r=0;const l=new Ammo.btVector3(t,s,i);e.setLinearLowerLimit(l),l.setValue(a,n,r),e.setLinearUpperLimit(l),Ammo.destroy(l)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const e=new Me,t=this._entityA.rigidbody.body;t.activate();const s=this.entity.getWorldTransform(),a=this._entityA.getWorldTransform().clone().invert();e.mul2(a,s);const n=new Ammo.btTransform;if(this._convertTransform(e,n),this._entityB&&this._entityB.rigidbody){const f=this._entityB.rigidbody.body;f.activate();const g=this._entityB.getWorldTransform().clone().invert();e.mul2(g,s);const y=new Ammo.btTransform;this._convertTransform(e,y),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,f,n,y,!this._enableCollision),Ammo.destroy(y)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,n,!this._enableCollision);Ammo.destroy(n);const r=["X","Y","Z","X","Y","Z"];for(let f=0;f<6;f++){const _=f<3?"_linear":"_angular";this._constraint.enableSpring(f,this[`${_}Spring${r[f]}`]),this._constraint.setDamping(f,this[`${_}Damping${r[f]}`]),this._constraint.setEquilibriumPoint(f,this[`${_}Equilibrium${r[f]}`]),this._constraint.setStiffness(f,this[`${_}Stiffness${r[f]}`])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null)}initFromData(e){for(const t of kee)e.hasOwnProperty(t)&&(e[t]instanceof Ee?this[`_${t}`].copy(e[t]):this[`_${t}`]=e[t]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(e,t,s){}_onBeforeRemove(){this.fire("remove")}}const Vee={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(h=>{["Damping","Equilibrium","Spring","Stiffness"].forEach(e=>{["X","Y","Z"].forEach(t=>{const s=h+e+t,i=`_${s}`;let a=h==="linear"?0:3;t==="Y"&&(a+=1),t==="Z"&&(a+=2),Object.defineProperty(XC.prototype,s,{get:function(){return this[i]},set:function(n){this[i]!==n&&(this[i]=n,this._constraint[Vee[e]](a,n))}})})})});class Gee{constructor(){this.enabled=!0}}const L3=["enabled"];class Zz extends ei{constructor(e){super(e),this.id="joint",this.app=e,this.ComponentType=XC,this.DataType=Gee,this.schema=L3}initializeComponentData(e,t,s){e.initFromData(t),super.initializeComponentData(e,t,L3)}}xt._buildAccessors(XC.prototype,L3);class eL extends xt{set minWidth(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}constructor(...e){super(...e),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}}class Hee{constructor(){this.enabled=!0}}const Jz=["enabled"];class e8 extends ei{constructor(e){super(e),this.id="layoutchild",this.ComponentType=eL,this.DataType=Hee,this.schema=Jz}initializeComponentData(e,t,s){t.enabled!==void 0&&(e.enabled=t.enabled),t.minWidth!==void 0&&(e.minWidth=t.minWidth),t.minHeight!==void 0&&(e.minHeight=t.minHeight),t.maxWidth!==void 0&&(e.maxWidth=t.maxWidth),t.maxHeight!==void 0&&(e.maxHeight=t.maxHeight),t.fitWidthProportion!==void 0&&(e.fitWidthProportion=t.fitWidthProportion),t.fitHeightProportion!==void 0&&(e.fitHeightProportion=t.fitHeightProportion),t.excludeFromLayout!==void 0&&(e.excludeFromLayout=t.excludeFromLayout),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.layoutchild;return this.addComponent(t,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}}xt._buildAccessors(eL.prototype,Jz);const s2=0,t8=1,I3=2,s8=3,i2={};i2[At]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"};i2[Ms]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};const tL={};tL[At]=Ms;tL[Ms]=At;const Wee={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},or={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},lr=new Ee;function i8(h){let e;const t=i2[h],s=i2[tL[h]];function i(k,K){return-K[t.size]*k.pivot[t.axis]}function a(k,K){return-K[s.size]*k.pivot[s.axis]}function n(k,K){return K[t.size]*(1-k.pivot[t.axis])}function r(k,K){k=k.filter(l),e=K,lr.x=e.containerSize.x-e.padding.x-e.padding.z,lr.y=e.containerSize.y-e.padding.y-e.padding.w,u(k);const ee=_(f(k)),V=y(ee,g(ee)),Q=T(ee,V);return R(ee,V,Q),D(ee,V,Q),I(ee)}function l(k){const K=k.entity.layoutchild;return!K||!K.enabled||!K.excludeFromLayout}function u(k){for(let K=0;K<k.length;++K){const ee=k[K],V=ee.anchor;(V.x!==0||V.y!==0||V.z!==0||V.w!==0)&&(ee.anchor=Ie.ZERO)}}function f(k){if(!e.wrap)return[k];const K=[[]],ee=U(k);let V=0;const Q=e[t.fitting]===I3;for(let se=0;se<k.length;++se){K[K.length-1].length>0&&(V+=e.spacing[t.axis]);const J=ee[se][t.size];V+=J,!Q&&V>lr[t.axis]&&K[K.length-1].length!==0&&(V=J,K.push([])),K[K.length-1].push(k[se]),Q&&V>lr[t.axis]&&se!==k.length-1&&(V=0,K.push([]))}return K}function _(k){const K=e.orientation===At&&e.reverseX||e.orientation===Ms&&e.reverseY,ee=e.orientation===At&&e.reverseY||e.orientation===Ms&&e.reverseX;if(K)for(let V=0;V<k.length;++V)K&&k[V].reverse();return ee&&k.reverse(),k}function g(k){const K=[];for(let ee=0;ee<k.length;++ee){const V=k[ee],Q=U(V),se=x(Q,t),J=v(e[t.fitting],se,lr[t.axis]);J===or.APPLY_STRETCHING?C(Q,se,t):J===or.APPLY_SHRINKING&&M(Q,se,t),K.push(Q)}return K}function y(k,K){const ee=[],V=[];for(let J=0;J<k.length;++J){const ie=k[J];ie.largestElement=null,ie.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let oe=0;oe<ie.length;++oe){const he=K[J][oe];he[s.size]>ie.largestSize[s.size]&&(ie.largestElement=ie[oe],ie.largestSize=he)}ee.push(ie.largestElement),V.push(ie.largestSize)}const Q=x(V,s),se=v(e[s.fitting],Q,lr[s.axis]);se===or.APPLY_STRETCHING?C(V,Q,s):se===or.APPLY_SHRINKING&&M(V,Q,s);for(let J=0;J<k.length;++J){const ie=k[J];for(let oe=0;oe<ie.length;++oe){const he=K[J][oe],te=he[s.size],le=k.length===1?lr[s.axis]:ie.largestSize[s.size],Se=v(e[s.fitting],te,le);Se===or.APPLY_STRETCHING?he[s.size]=Math.min(le,he[s.maxSize]):Se===or.APPLY_SHRINKING&&(he[s.size]=Math.max(le,he[s.minSize]))}}return K}function v(k,K,ee){switch(k){case s2:return or.NONE;case t8:return K<ee?or.APPLY_STRETCHING:or.NONE;case I3:return K>=ee?or.APPLY_SHRINKING:or.NONE;case s8:return K<ee?or.APPLY_STRETCHING:or.APPLY_SHRINKING;default:throw new Error(`Unrecognized fitting mode: ${k}`)}}function x(k,K){const ee=z(k,K.size),V=(k.length-1)*e.spacing[K.axis];return ee+V}function C(k,K,ee){const V=F(k,ee.maxSize),Q=X(k,ee.fittingProportion),se=W(Q,V);let J=lr[ee.axis]-K;for(let ie=0;ie<k.length;++ie){const oe=V[ie],he=w(oe,J,Q,se),te=k[oe][ee.size]+he,le=k[oe][ee.maxSize],Se=Math.min(te,le);k[oe][ee.size]=Se;const Ae=Math.max(te-Se,0),De=he-Ae;J-=De}}function M(k,K,ee){const V=F(k,ee.minSize,!0),Q=X(k,ee.fittingProportion),se=Y(Q),J=W(se,V);let ie=K-lr[ee.axis];for(let oe=0;oe<k.length;++oe){const he=V[oe],te=w(he,ie,se,J),le=k[he][ee.size]-te,Se=k[he][ee.minSize],Ae=Math.max(le,Se);k[he][ee.size]=Ae;const De=Math.max(Ae-le,0),Fe=te-De;ie-=Fe}}function w(k,K,ee,V){const Q=ee[k],se=V[k];return Math.abs(Q)<1e-5&&Math.abs(se)<1e-5?K:K*Q/se}function T(k,K){const ee={};ee[t.axis]=0,ee[s.axis]=0,k[t.size]=Number.NEGATIVE_INFINITY;const V=[];for(let Q=0;Q<k.length;++Q){const se=k[Q];if(se.length===0){V.push([]);continue}const J=[],ie=K[Q];for(let oe=0;oe<se.length;++oe){const he=se[oe],te=ie[oe];ee[s.axis]-=a(he,te),ee[t.axis]-=i(he,te),J[oe]={},J[oe][t.axis]=ee[t.axis],J[oe][s.axis]=ee[s.axis],ee[s.axis]+=a(he,te),ee[t.axis]+=n(he,te)+e.spacing[t.axis]}se[t.size]=ee[t.axis]-e.spacing[t.axis],se[s.size]=se.largestSize[s.size],k[t.size]=Math.max(k[t.size],se[t.size]),ee[t.axis]=0,ee[s.axis]+=se[s.size]+e.spacing[s.axis],V.push(J)}return k[s.size]=ee[s.axis]-e.spacing[s.axis],V}function R(k,K,ee){const V=e.alignment[t.axis],Q=e.alignment[s.axis],se=e.padding[t.axis],J=e.padding[s.axis];for(let ie=0;ie<k.length;++ie){const oe=k[ie],he=K[ie],te=ee[ie],le=(lr[t.axis]-oe[t.size])*V+se,Se=(lr[s.axis]-k[s.size])*Q+J;for(let Ae=0;Ae<oe.length;++Ae){const De=(oe[s.size]-he[Ae][s.size])*e.alignment[s.axis];te[Ae][t.axis]+=le,te[Ae][s.axis]+=Se+De}}}function D(k,K,ee){for(let V=0;V<k.length;++V){const Q=k[V],se=K[V],J=ee[V];for(let ie=0;ie<Q.length;++ie){const oe=Q[ie];oe[t.calculatedSize]=se[ie][t.size],oe[s.calculatedSize]=se[ie][s.size],e.orientation===At?oe.entity.setLocalPosition(J[ie][t.axis],J[ie][s.axis],oe.entity.getLocalPosition().z):oe.entity.setLocalPosition(J[ie][s.axis],J[ie][t.axis],oe.entity.getLocalPosition().z)}}}function I(k){const K=k.width,ee=k.height,V=(lr.x-K)*e.alignment.x+e.padding.x,Q=(lr.y-ee)*e.alignment.y+e.padding.y;return{bounds:new Ie(V,Q,K,ee)}}function U(k){const K=[];for(let ee=0;ee<k.length;++ee){const V=k[ee],Q=Math.max(O(V,"minWidth"),0),se=Math.max(O(V,"minHeight"),0),J=Math.max(O(V,"maxWidth"),Q),ie=Math.max(O(V,"maxHeight"),se),oe=N(O(V,"width"),Q,J),he=N(O(V,"height"),se,ie),te=O(V,"fitWidthProportion"),le=O(V,"fitHeightProportion");K.push({minWidth:Q,minHeight:se,maxWidth:J,maxHeight:ie,width:oe,height:he,fitWidthProportion:te,fitHeightProportion:le})}return K}function O(k,K){const ee=k.entity.layoutchild;return ee&&ee.enabled&&ee[K]!==void 0&&ee[K]!==null?ee[K]:k[K]!==void 0?k[K]:Wee[K]}function N(k,K,ee){return Math.min(Math.max(k,K),ee)}function z(k,K){return k.reduce((ee,V)=>ee+V[K],0)}function X(k,K){const ee=z(k,K),V=[],Q=k.length;if(ee===0)for(let se=0;se<Q;++se)V.push(1/Q);else for(let se=0;se<Q;++se)V.push(k[se][K]/ee);return V}function Y(k){if(k.length===1)return[1];const K=[],ee=k.length;for(let V=0;V<ee;++V)K.push((1-k[V])/(ee-1));return K}function F(k,K,ee){return k.forEach(q),k.slice().sort((V,Q)=>ee?Q[K]-V[K]:V[K]-Q[K]).map(G)}function q(k,K){k.index=K}function G(k){return k.index}function W(k,K){const ee=[];ee[K[k.length-1]]=k[K[k.length-1]];for(let V=k.length-2;V>=0;--V)ee[K[V]]=ee[K[V+1]]+k[K[V]];return ee}return r}const sL={};sL[At]=i8(At);sL[Ms]=i8(Ms);class a8{calculateLayout(e,t){const s=sL[t.orientation];if(s)return s(e,t);throw new Error(`Unrecognized orientation value: ${t.orientation}`)}}function m4(h){return h.element}function qee(h){return h.enabled&&h.element&&h.element.enabled}class iL extends xt{constructor(e,t){super(e,t),this._orientation=At,this._reverseX=!1,this._reverseY=!0,this._alignment=new Ee(0,1),this._padding=new Ie,this._spacing=new Ee,this._widthFitting=s2,this._heightFitting=s2,this._wrap=!1,this._layoutCalculator=new a8,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(s=>{this._listenForReflowEvents(s,"on")}),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow())}get alignment(){return this._alignment}set padding(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow())}get padding(){return this._padding}set spacing(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(e){return e===this.entity||this.entity.children.indexOf(e)!==-1}_listenForReflowEvents(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())}_onChildInsert(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()}_onChildRemove(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const e=m4(this.entity),t=this.entity.children.filter(qee).map(m4);if(!e||t.length===0)return;const s=Math.max(e.calculatedWidth,0),i=Math.max(e.calculatedHeight,0),a={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new Ee(s,i)};this._isPerformingReflow=!0;const n=this._layoutCalculator.calculateLayout(t,a);this._isPerformingReflow=!1,this.fire("reflow",n)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(e=>{this._listenForReflowEvents(e,"off")}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}class Xee{constructor(){this.enabled=!0}}const n8=["enabled"],jee=100;class r8 extends ei{constructor(e){super(e),this.id="layoutgroup",this.ComponentType=iL,this.DataType=Xee,this.schema=n8,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t,s){t.enabled!==void 0&&(e.enabled=t.enabled),t.orientation!==void 0&&(e.orientation=t.orientation),t.reverseX!==void 0&&(e.reverseX=t.reverseX),t.reverseY!==void 0&&(e.reverseY=t.reverseY),t.alignment!==void 0&&(e.alignment=Array.isArray(t.alignment)?new Ee(t.alignment):t.alignment),t.padding!==void 0&&(e.padding=Array.isArray(t.padding)?new Ie(t.padding):t.padding),t.spacing!==void 0&&(e.spacing=Array.isArray(t.spacing)?new Ee(t.spacing):t.spacing),t.widthFitting!==void 0&&(e.widthFitting=t.widthFitting),t.heightFitting!==void 0&&(e.heightFitting=t.heightFitting),t.wrap!==void 0&&(e.wrap=t.wrap),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.layoutgroup;return this.addComponent(t,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(e){this._reflowQueue.indexOf(e)===-1&&this._reflowQueue.push(e)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(this._reflowQueue.length===0)return;let e=0;for(;this._reflowQueue.length>0;){const t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort((s,i)=>s.entity.graphDepth-i.entity.graphDepth);for(let s=0;s<t.length;++s)t[s].reflow();if(++e>=jee){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}xt._buildAccessors(iL.prototype,n8);class Yee{destroy(e){this.map.forEach(t=>t.mesh.destroy())}constructor(){this.map=new Map}}const Kee=new Xn,o8=(h,e)=>{const t=Kee.get(h,()=>new Yee);let s=t.map.get(e);if(!s){let i,a;switch(e){case"box":i=Ft.fromGeometry(h,new Kd),a={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=Ft.fromGeometry(h,new UP({radius:.5,height:2})),a={x:Math.PI*2,y:Math.PI,z:Math.PI*2,uv:1/3+1/3/3*2};break;case"cone":i=Ft.fromGeometry(h,new bx({baseRadius:.5,peakRadius:0,height:1})),a={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=Ft.fromGeometry(h,new uy({radius:.5,height:1})),a={x:Math.PI,y:.79*2,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=Ft.fromGeometry(h,new xx({halfExtents:new Ee(.5,.5),widthSegments:1,lengthSegments:1})),a={x:0,y:1,z:0,uv:1};break;case"sphere":i=Ft.fromGeometry(h,new cy({radius:.5})),a={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":i=Ft.fromGeometry(h,new D0({tubeRadius:.2,ringRadius:.3})),a={x:Math.PI*.5*.5-Math.PI*.1*.1,y:.4,z:.4,uv:1};break;default:throw new Error(`Invalid primitive type: ${e}`)}i.incRefCount(),s={mesh:i,area:a},t.map.set(e,s)}return s};class jC extends xt{constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._layers=[Ph],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(e){this._model&&(this._model.meshInstances=e)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){const t=this._model.meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e)if(this._area=null,this._type=e,e==="asset")this._asset!==null?this._bindModelAsset(this._asset):this.model=null;else{const t=o8(this.system.app.graphicsDevice,e);this._area=t.area;const s=t.mesh,i=new Jt,a=new Lh;a.graph=i,a.meshInstances=[new ps(s,this._material,i)],this.model=a,this._asset=null}}get type(){return this._type}set asset(e){const t=this.system.app.assets;let s=e;if(e instanceof Ye&&(s=e.id),this._asset!==s){if(this._asset){t.off(`add:${this._asset}`,this._onModelAssetAdded,this);const i=t.get(this._asset);i&&this._unbindModelAsset(i)}if(this._asset=s,this._asset){const i=t.get(this._asset);i?this._bindModelAsset(i):(this.model=null,t.on(`add:${this._asset}`,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(e){if(this._model!==e&&!(e&&e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),this.type==="asset"?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows===e)return;const t=this._model;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let n=0;n<s.length;n++){const r=this.system.app.scene.layers.getLayerById(this.layers[n]);r&&r.removeShadowCasters(t.meshInstances)}const a=t.meshInstances;for(let n=0;n<a.length;n++)a[n].castShadow=e;if(!this._castShadows&&e)for(let n=0;n<s.length;n++){const r=i.layers.getLayerById(s[n]);r&&r.addShadowCasters(t.meshInstances)}}this._castShadows=e}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model)){const t=this._model.meshInstances;for(let s=0,i=t.length;s<i;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;if(this.meshInstances)for(let s=0;s<this._layers.length;s++){const i=t.getLayerById(this._layers[s]);i&&i.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let s=0;s<e.length;s++)this._layers[s]=e[s];if(!(!this.enabled||!this.entity.enabled||!this.meshInstances))for(let s=0;s<this._layers.length;s++){const i=t.getLayerById(this._layers[s]);i&&i.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(e){var t,s;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&((t=this.system.app.batcher)==null||t.remove(zi.MODEL,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&((s=this.system.app.batcher)==null||s.insert(zi.MODEL,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e)}get batchGroupId(){return this._batchGroupId}set materialAsset(e){let t=e;e instanceof Ye&&(t=e.id);const s=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){s.off(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this);const i=s.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}if(this._materialAsset=t,this._materialAsset){const i=s.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._setMaterial(this.system.defaultMaterial),s.on(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}get material(){return this._material}set mapping(e){if(this._type!=="asset"||(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,!this._model))return;const t=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let a=null;for(let n=0,r=t.length;n<r;n++)if(e[n]!==void 0)e[n]?(a=this.system.app.assets.get(e[n]),this._loadAndSetMeshInstanceMaterial(a,t[n],n)):t[n].material=this.system.defaultMaterial;else if(i)if(i[n]&&(i[n].material||i[n].path)){if(i[n].material!==void 0)a=this.system.app.assets.get(i[n].material);else if(i[n].path!==void 0){const l=this._getMaterialAssetUrl(i[n].path);l&&(a=this.system.app.assets.getByUrl(l))}this._loadAndSetMeshInstanceMaterial(a,t[n],n)}else t[n].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)}_setMaterialEvent(e,t,s,i){const a=`${t}:${s}`;this.system.app.assets.on(a,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][a]={id:s,handler:i}}_unsetMaterialEvents(){const e=this.system.app.assets,t=this._materialEvents;if(t){for(let s=0,i=t.length;s<i;s++){if(!t[s])continue;const a=t[s];for(const n in a)e.off(n,a[n].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(e){let t=null;if(!isNaN(parseInt(e,10)))t=this.system.app.assets.get(e);else if(this.asset){const i=this._getMaterialAssetUrl(e);i&&(t=this.system.app.assets.getByUrl(i))}return t}_getMaterialAssetUrl(e){if(!this.asset)return null;const t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,s){const i=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial})):(this._setMaterialEvent(s,"load",e.id,function(a){t.material=a.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&i.load(e)))}onEnable(){var n;const e=this.system.app,t=e.scene,s=t==null?void 0:t.layers;this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));const i=this._type==="asset";let a;if(this._model?this.addModelToLayers():i&&this._asset&&(a=e.assets.get(this._asset),a&&a.resource!==this._model&&this._bindModelAsset(a)),this._materialAsset&&(a=e.assets.get(this._materialAsset),a&&a.resource!==this._material&&this._bindMaterialAsset(a)),i&&this._mapping)for(const r in this._mapping)this._mapping[r]&&(a=this._getAssetByIdOrPath(this._mapping[r]),a&&!a.resource&&e.assets.load(a));this._batchGroupId>=0&&((n=e.batcher)==null||n.insert(zi.MODEL,this.batchGroupId,this.entity))}onDisable(){var i,a,n,r;const e=this.system.app,s=e.scene.layers;(i=this._evtLayersChanged)==null||i.off(),this._evtLayersChanged=null,s&&((a=this._evtLayerAdded)==null||a.off(),this._evtLayerAdded=null,(n=this._evtLayerRemoved)==null||n.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&((r=e.batcher)==null||r.remove(zi.MODEL,this.batchGroupId,this.entity)),this._model&&this.removeModelFromLayers()}hide(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!1}}show(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!0}}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(e){this.system.app.assets.off(`add:${e.id}`,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_onMaterialAssetLoad(e){this._setMaterial(e.resource)}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e)}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(e){this.system.app.assets.off(`add:${e.id}`,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(e){this.model=null}_onModelAssetChange(e,t,s,i){t==="data"&&(this.mapping=this._mapping)}_onModelAssetRemove(e){this.model=null}_setMaterial(e){if(this._material===e)return;this._material=e;const t=this._model;if(t&&this._type!=="asset"){const s=t.meshInstances;for(let i=0,a=s.length;i<a;i++)s[i].material=e}}}class Qee{constructor(){this.enabled=!0}}const l8=["enabled"];class h8 extends ei{constructor(e){super(e),this.id="model",this.ComponentType=jC,this.DataType=Qee,this.schema=l8,this.defaultMaterial=ly(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(t.batchGroupId===null||t.batchGroupId===void 0)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new wt(new H(t.aabbCenter),new H(t.aabbHalfExtents))),super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:Db({},e.model.mapping)};let i=e.model.materialAsset;!(i instanceof Ye)&&i!=null&&(i=this.app.assets.get(i));const a=e.model.material;(!a||a===this.defaultMaterial||!i||a===i.resource)&&(s.materialAsset=i);const n=this.addComponent(t,s);if(e.model.model&&e.model.type==="asset"&&!e.model.asset&&(n.model=e.model.model.clone(),n._clonedModel=!0),s.materialAsset||(n.material=a),e.model.model){const r=e.model.model.meshInstances,l=n.model.meshInstances;for(let u=0;u<r.length;u++)l[u].mask=r[u].mask,l[u].material=r[u].material,l[u].layer=r[u].layer,l[u].receiveShadow=r[u].receiveShadow}return e.model.customAabb&&(n.customAabb=e.model.customAabb.clone()),n}onRemove(e,t){t.onRemove()}}xt._buildAccessors(jC.prototype,l8);const $ee=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],Zee=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],Jee=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],BE=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let bg;class c8 extends xt{constructor(e,t){super(e,t),this._requestedDepth=!1,this._drawOrder=0,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),$ee.forEach(s=>{this.on(`set_${s}`,this.onSetSimpleProperty,this)}),Zee.forEach(s=>{this.on(`set_${s}`,this.onSetComplexProperty,this)}),Jee.forEach(s=>{this.on(`set_${s}`,this.onSetGraphProperty,this)})}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set autoPlay(e){this._setValue("autoPlay",e)}get autoPlay(){return this.data.autoPlay}set numParticles(e){this._setValue("numParticles",e)}get numParticles(){return this.data.numParticles}set lifetime(e){this._setValue("lifetime",e)}get lifetime(){return this.data.lifetime}set rate(e){this._setValue("rate",e)}get rate(){return this.data.rate}set rate2(e){this._setValue("rate2",e)}get rate2(){return this.data.rate2}set startAngle(e){this._setValue("startAngle",e)}get startAngle(){return this.data.startAngle}set startAngle2(e){this._setValue("startAngle2",e)}get startAngle2(){return this.data.startAngle2}set loop(e){this._setValue("loop",e)}get loop(){return this.data.loop}set preWarm(e){this._setValue("preWarm",e)}get preWarm(){return this.data.preWarm}set lighting(e){this._setValue("lighting",e)}get lighting(){return this.data.lighting}set halfLambert(e){this._setValue("halfLambert",e)}get halfLambert(){return this.data.halfLambert}set intensity(e){this._setValue("intensity",e)}get intensity(){return this.data.intensity}set depthWrite(e){this._setValue("depthWrite",e)}get depthWrite(){return this.data.depthWrite}set noFog(e){this._setValue("noFog",e)}get noFog(){return this.data.noFog}set depthSoftening(e){this._setValue("depthSoftening",e)}get depthSoftening(){return this.data.depthSoftening}set sort(e){this._setValue("sort",e)}get sort(){return this.data.sort}set blendType(e){this._setValue("blendType",e)}get blendType(){return this.data.blendType}set stretch(e){this._setValue("stretch",e)}get stretch(){return this.data.stretch}set alignToMotion(e){this._setValue("alignToMotion",e)}get alignToMotion(){return this.data.alignToMotion}set emitterShape(e){this._setValue("emitterShape",e)}get emitterShape(){return this.data.emitterShape}set emitterExtents(e){this._setValue("emitterExtents",e)}get emitterExtents(){return this.data.emitterExtents}set emitterExtentsInner(e){this._setValue("emitterExtentsInner",e)}get emitterExtentsInner(){return this.data.emitterExtentsInner}set emitterRadius(e){this._setValue("emitterRadius",e)}get emitterRadius(){return this.data.emitterRadius}set emitterRadiusInner(e){this._setValue("emitterRadiusInner",e)}get emitterRadiusInner(){return this.data.emitterRadiusInner}set initialVelocity(e){this._setValue("initialVelocity",e)}get initialVelocity(){return this.data.initialVelocity}set wrap(e){this._setValue("wrap",e)}get wrap(){return this.data.wrap}set wrapBounds(e){this._setValue("wrapBounds",e)}get wrapBounds(){return this.data.wrapBounds}set localSpace(e){this._setValue("localSpace",e)}get localSpace(){return this.data.localSpace}set screenSpace(e){this._setValue("screenSpace",e)}get screenSpace(){return this.data.screenSpace}set colorMapAsset(e){this._setValue("colorMapAsset",e)}get colorMapAsset(){return this.data.colorMapAsset}set normalMapAsset(e){this._setValue("normalMapAsset",e)}get normalMapAsset(){return this.data.normalMapAsset}set mesh(e){this._setValue("mesh",e)}get mesh(){return this.data.mesh}set meshAsset(e){this._setValue("meshAsset",e)}get meshAsset(){return this.data.meshAsset}set renderAsset(e){this._setValue("renderAsset",e)}get renderAsset(){return this.data.renderAsset}set orientation(e){this._setValue("orientation",e)}get orientation(){return this.data.orientation}set particleNormal(e){this._setValue("particleNormal",e)}get particleNormal(){return this.data.particleNormal}set localVelocityGraph(e){this._setValue("localVelocityGraph",e)}get localVelocityGraph(){return this.data.localVelocityGraph}set localVelocityGraph2(e){this._setValue("localVelocityGraph2",e)}get localVelocityGraph2(){return this.data.localVelocityGraph2}set velocityGraph(e){this._setValue("velocityGraph",e)}get velocityGraph(){return this.data.velocityGraph}set velocityGraph2(e){this._setValue("velocityGraph2",e)}get velocityGraph2(){return this.data.velocityGraph2}set rotationSpeedGraph(e){this._setValue("rotationSpeedGraph",e)}get rotationSpeedGraph(){return this.data.rotationSpeedGraph}set rotationSpeedGraph2(e){this._setValue("rotationSpeedGraph2",e)}get rotationSpeedGraph2(){return this.data.rotationSpeedGraph2}set radialSpeedGraph(e){this._setValue("radialSpeedGraph",e)}get radialSpeedGraph(){return this.data.radialSpeedGraph}set radialSpeedGraph2(e){this._setValue("radialSpeedGraph2",e)}get radialSpeedGraph2(){return this.data.radialSpeedGraph2}set scaleGraph(e){this._setValue("scaleGraph",e)}get scaleGraph(){return this.data.scaleGraph}set scaleGraph2(e){this._setValue("scaleGraph2",e)}get scaleGraph2(){return this.data.scaleGraph2}set colorGraph(e){this._setValue("colorGraph",e)}get colorGraph(){return this.data.colorGraph}set colorGraph2(e){this._setValue("colorGraph2",e)}get colorGraph2(){return this.data.colorGraph2}set alphaGraph(e){this._setValue("alphaGraph",e)}get alphaGraph(){return this.data.alphaGraph}set alphaGraph2(e){this._setValue("alphaGraph2",e)}get alphaGraph2(){return this.data.alphaGraph2}set colorMap(e){this._setValue("colorMap",e)}get colorMap(){return this.data.colorMap}set normalMap(e){this._setValue("normalMap",e)}get normalMap(){return this.data.normalMap}set animTilesX(e){this._setValue("animTilesX",e)}get animTilesX(){return this.data.animTilesX}set animTilesY(e){this._setValue("animTilesY",e)}get animTilesY(){return this.data.animTilesY}set animStartFrame(e){this._setValue("animStartFrame",e)}get animStartFrame(){return this.data.animStartFrame}set animNumFrames(e){this._setValue("animNumFrames",e)}get animNumFrames(){return this.data.animNumFrames}set animNumAnimations(e){this._setValue("animNumAnimations",e)}get animNumAnimations(){return this.data.animNumAnimations}set animIndex(e){this._setValue("animIndex",e)}get animIndex(){return this.data.animIndex}set randomizeAnimIndex(e){this._setValue("randomizeAnimIndex",e)}get randomizeAnimIndex(){return this.data.randomizeAnimIndex}set animSpeed(e){this._setValue("animSpeed",e)}get animSpeed(){return this.data.animSpeed}set animLoop(e){this._setValue("animLoop",e)}get animLoop(){return this.data.animLoop}set layers(e){this._setValue("layers",e)}get layers(){return this.data.layers}set drawOrder(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e)}get drawOrder(){return this._drawOrder}_setValue(e,t){const s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}addMeshInstanceToLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t)}}removeMeshInstanceFromLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(e,t,s){if(this.emitter){for(let i=0;i<t.length;i++){const a=this.system.app.scene.layers.getLayerById(t[i]);a&&a.removeMeshInstances([this.emitter.meshInstance])}if(!(!this.enabled||!this.entity.enabled))for(let i=0;i<s.length;i++){const a=this.system.app.scene.layers.getLayerById(s[i]);a&&a.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){!this.emitter||this.layers.indexOf(e.id)<0||e.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(e){!this.emitter||this.layers.indexOf(e.id)<0||e.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindColorMapAsset(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(e){this.colorMap=e.resource}_onColorMapAssetUnload(e){this.colorMap=null}_onColorMapAssetRemove(e){this._onColorMapAssetUnload(e)}_onColorMapAssetChange(e){}onSetColorMapAsset(e,t,s){const i=this.system.app.assets;if(t){const a=i.get(t);a&&this._unbindColorMapAsset(a)}if(s){s instanceof Ye&&(this.data.colorMapAsset=s.id,s=s.id);const a=i.get(s);a?this._bindColorMapAsset(a):i.once(`add:${s}`,n=>{this._bindColorMapAsset(n)})}else this.colorMap=null}_bindNormalMapAsset(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindNormalMapAsset(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(e){this.normalMap=e.resource}_onNormalMapAssetUnload(e){this.normalMap=null}_onNormalMapAssetRemove(e){this._onNormalMapAssetUnload(e)}_onNormalMapAssetChange(e){}onSetNormalMapAsset(e,t,s){const i=this.system.app.assets;if(t){const a=i.get(t);a&&this._unbindNormalMapAsset(a)}if(s){s instanceof Ye&&(this.data.normalMapAsset=s.id,s=s.id);const a=i.get(s);a?this._bindNormalMapAsset(a):i.once(`add:${s}`,n=>{this._bindNormalMapAsset(n)})}else this.normalMap=null}_bindMeshAsset(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMeshAsset(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(e){this._onMeshChanged(e.resource)}_onMeshAssetUnload(e){this.mesh=null}_onMeshAssetRemove(e){this._onMeshAssetUnload(e)}_onMeshAssetChange(e){}onSetMeshAsset(e,t,s){const i=this.system.app.assets;if(t){const a=i.get(t);a&&this._unbindMeshAsset(a)}if(s){s instanceof Ye&&(this.data.meshAsset=s.id,s=s.id);const a=i.get(s);a&&this._bindMeshAsset(a)}else this._onMeshChanged(null)}onSetMesh(e,t,s){!s||s instanceof Ye||typeof s=="number"?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(e){e&&!(e instanceof Ft)&&(e.meshInstances[0]?e=e.meshInstances[0].mesh:e=null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const a=i.get(t);a&&this._unbindRenderAsset(a)}if(s){s instanceof Ye&&(this.data.renderAsset=s.id,s=s.id);const a=i.get(s);a&&this._bindRenderAsset(a)}else this._onRenderChanged(null)}_bindRenderAsset(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindRenderAsset(e){var t;e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),(t=this._evtSetMeshes)==null||t.off(),this._evtSetMeshes=null}_onRenderAssetLoad(e){this._onRenderChanged(e.resource)}_onRenderAssetUnload(e){this._onRenderChanged(null)}_onRenderAssetRemove(e){this._onRenderAssetUnload(e)}_onRenderChanged(e){var t;if(!e){this._onMeshChanged(null);return}(t=this._evtSetMeshes)==null||t.off(),this._evtSetMeshes=e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)}_onRenderSetMeshes(e){this._onMeshChanged(e&&e[0])}onSetLoop(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetTime())}onSetBlendType(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(bg||(bg=this.system.app.scene.layers.getLayerById(yn)),bg&&(bg.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&bg&&(bg.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(e,t,s){t!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[e]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial())}onSetComplexProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const e=this.system.app.scene,t=e.layers,s=this.data;for(let i=0,a=BE.length;i<a;i++){let n=s[BE[i]];if(n){if(!(n instanceof Ye))if(parseInt(n,10)>=0)n=this.system.app.assets.get(n);else continue;n&&!n.resource&&this.system.app.assets.load(n)}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){let i=s.mesh;i instanceof Ft||(i=null),this.emitter=new GU(this.system.app.graphicsDevice,{numParticles:s.numParticles,emitterExtents:s.emitterExtents,emitterExtentsInner:s.emitterExtentsInner,emitterRadius:s.emitterRadius,emitterRadiusInner:s.emitterRadiusInner,emitterShape:s.emitterShape,initialVelocity:s.initialVelocity,wrap:s.wrap,localSpace:s.localSpace,screenSpace:s.screenSpace,wrapBounds:s.wrapBounds,lifetime:s.lifetime,rate:s.rate,rate2:s.rate2,orientation:s.orientation,particleNormal:s.particleNormal,animTilesX:s.animTilesX,animTilesY:s.animTilesY,animStartFrame:s.animStartFrame,animNumFrames:s.animNumFrames,animNumAnimations:s.animNumAnimations,animIndex:s.animIndex,randomizeAnimIndex:s.randomizeAnimIndex,animSpeed:s.animSpeed,animLoop:s.animLoop,startAngle:s.startAngle,startAngle2:s.startAngle2,scaleGraph:s.scaleGraph,scaleGraph2:s.scaleGraph2,colorGraph:s.colorGraph,colorGraph2:s.colorGraph2,alphaGraph:s.alphaGraph,alphaGraph2:s.alphaGraph2,localVelocityGraph:s.localVelocityGraph,localVelocityGraph2:s.localVelocityGraph2,velocityGraph:s.velocityGraph,velocityGraph2:s.velocityGraph2,rotationSpeedGraph:s.rotationSpeedGraph,rotationSpeedGraph2:s.rotationSpeedGraph2,radialSpeedGraph:s.radialSpeedGraph,radialSpeedGraph2:s.radialSpeedGraph2,colorMap:s.colorMap,normalMap:s.normalMap,loop:s.loop,preWarm:s.preWarm,sort:s.sort,stretch:s.stretch,alignToMotion:s.alignToMotion,lighting:s.lighting,halfLambert:s.halfLambert,intensity:s.intensity,depthSoftening:s.depthSoftening,scene:this.system.app.scene,mesh:i,depthWrite:s.depthWrite,noFog:s.noFog,node:this.entity,blendType:s.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,s.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&s.depthSoftening&&this._requestDepth()}}onDisable(){var s,i,a;const t=this.system.app.scene.layers;(s=this._evtLayersChanged)==null||s.off(),this._evtLayersChanged=null,t&&((i=this._evtLayerAdded)==null||i.off(),this._evtLayerAdded=null,(a=this._evtLayerRemoved)==null||a.off(),this._evtLayerRemoved=null),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<BE.length;e++){const t=BE[e];this.data[t]&&(this[t]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime}setInTools(){const{emitter:e}=this;e&&!e.inTools&&(e.inTools=!0,this.rebuild())}rebuild(){const e=this.enabled;this.enabled=!1,this.emitter&&this.emitter.rebuild(),this.enabled=e}}class ete{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new H,this.emitterExtentsInner=new H,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=Jo,this.initialVelocity=0,this.wrap=!1,this.wrapBounds=new H,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=mP,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.renderAsset=null,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=t1,this.particleNormal=new H(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=xr,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[Ph]}}const tte=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class u8 extends ei{constructor(e){super(e),this.id="particlesystem",this.ComponentType=c8,this.DataType=ete,this.schema=tte,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i={};s=[];const a=this.propertyTypes;(t.mesh instanceof Ye||typeof t.mesh=="number")&&(t.meshAsset=t.mesh,delete t.mesh);for(const n in t){if(t.hasOwnProperty(n)&&(s.push(n),i[n]=t[n]),a[n]==="vec3")Array.isArray(i[n])&&(i[n]=new H(i[n][0],i[n][1],i[n][2]));else if(a[n]==="curve"){if(!(i[n]instanceof so)){const r=i[n].type;i[n]=new so(i[n].keys),i[n].type=r}}else if(a[n]==="curveset"&&!(i[n]instanceof Ad)){const r=i[n].type;i[n]=new Ad(i[n].keys),i[n].type=r}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(e,i,s)}cloneComponent(e,t){const s=e.particlesystem.data,i=this.schema,a={};for(let n=0,r=i.length;n<r;n++){const l=i[n];let u=s[l];u instanceof H||u instanceof so||u instanceof Ad?(u=u.clone(),a[l]=u):l==="layers"?a.layers=s.layers.slice(0):u!=null&&(a[l]=u)}return this.addComponent(t,a)}onUpdate(e){const t=this.store,s=this.app.stats.particles,i=this.app.scene.layers;for(let a=0;a<i.layerList.length;a++)i.layerList[a].requiresLightCube=!1;for(const a in t)if(t.hasOwnProperty(a)){const n=t[a],r=n.entity,l=n.data;if(l.enabled&&r.enabled){const u=r.particlesystem.emitter;if(!(u!=null&&u.meshInstance.visible))continue;if(u.lighting){const f=l.layers;for(let _=0;_<f.length;_++){const g=i.getLayerById(f[_]);g&&(g.requiresLightCube=!0)}}if(!l.paused){let f=0;if(u.simTime+=e,u.simTime>u.fixedTimeStep&&(f=Math.floor(u.simTime/u.fixedTimeStep),u.simTime-=f*u.fixedTimeStep),f){f=Math.min(f,u.maxSubSteps);for(let _=0;_<f;_++)u.addTime(u.fixedTimeStep,!1);s._updatesPerFrame+=f,s._frameTime+=u._addTimeTime,u._addTimeTime=0}u.finishFrame()}}}}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}class ste extends _C{constructor(e,t){super(),this.skin=e,this.skinInstance=t}}const dh=class dh{static createCachedSkinInstance(e,t,s){let i=dh.getCachedSkinInstance(e,t);return i||(i=new oy(e),i.resolve(t,s),dh.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){let s=null;const i=dh._skinInstanceCache.get(t);if(i){const a=i.find(n=>n.skin===e);a&&(a.incRefCount(),s=a.skinInstance)}return s}static addCachedSkinInstance(e,t,s){let i=dh._skinInstanceCache.get(t);i||(i=[],dh._skinInstanceCache.set(t,i));let a=i.find(n=>n.skin===e);a||(a=new ste(e,s),i.push(a)),a.incRefCount()}static removeCachedSkinInstance(e){if(e){const t=e.rootBone;if(t){const s=dh._skinInstanceCache.get(t);if(s){const i=s.findIndex(a=>a.skinInstance===e);if(i>=0){const a=s[i];a.decRefCount(),a.refCount===0&&(s.splice(i,1),s.length||dh._skinInstanceCache.delete(t),e&&(e.destroy(),a.skinInstance=null))}}}}}};dh._skinInstanceCache=new Map;let f1=dh;class P0{constructor(e,t,s,i,a){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=e,this.parent=t,this._scope=a,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on(`load:${this.id}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once(`add:${this.id}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on(`remove:${this.id}`,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on(`unload:${this.id}`,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on(`load:url:${this.url}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once(`add:url:${this.url}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on(`remove:url:${this.url}`,this._onRemove,this)))}_unbind(){var e,t,s,i,a,n,r;this.id&&((e=this._evtLoadById)==null||e.off(),this._evtLoadById=null,(t=this._evtAddById)==null||t.off(),this._evtAddById=null,(s=this._evtRemoveById)==null||s.off(),this._evtRemoveById=null,(i=this._evtUnloadById)==null||i.off(),this._evtUnloadById=null),this.url&&((a=this._evtLoadByUrl)==null||a.off(),this._evtLoadByUrl=null,(n=this._evtAddByUrl)==null||n.off(),this._evtAddByUrl=null,(r=this._evtRemoveByUrl)==null||r.off(),this._evtRemoveByUrl=null)}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}}class aL extends xt{constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[Ph],this._renderStyle=a0,this._meshInstances=[],this._customAabb=null,this._area=null,this._materialReferences=[],this._rootBone=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._assetReference=new P0("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,ps._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),e!=="asset")){let t=this._material;(!t||t===this.system.defaultMaterial)&&(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=o8(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new ps(s.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){const t=this._meshInstances;for(let s=0;s<t.length;s++)t[s].node||(t[s].node=this.entity),t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].renderStyle=this._renderStyle,t[s].setLightmapped(this._lightmapped),t[s].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){const t=this._meshInstances;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let a=0;a<s.length;a++){const n=i.layers.getLayerById(this.layers[a]);n&&n.removeShadowCasters(t)}for(let a=0;a<t.length;a++)t[a].castShadow=e;if(!this._castShadows&&e)for(let a=0;a<s.length;a++){const n=i.layers.getLayerById(s[a]);n&&n.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;let s;if(this._meshInstances)for(let i=0;i<this._layers.length;i++)s=t.getLayerById(this._layers[i]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let i=0;i<e.length;i++)this._layers[i]=e[i];if(!(!this.enabled||!this.entity.enabled||!this._meshInstances))for(let i=0;i<this._layers.length;i++)s=t.getLayerById(this._layers[i]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){var t,s;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&((t=this.system.app.batcher)==null||t.remove(zi.RENDER,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&((s=this.system.app.batcher)==null||s.insert(zi.RENDER,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e)}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&this._type!=="asset"))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e=[]){if(this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new P0(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){const s=e[t]instanceof Ye?e[t].id:e[t];this._materialReferences[t].id!==s&&(this._materialReferences[t].id=s),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset)}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map(e=>e.id)}set asset(e){const t=e instanceof Ye?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof Ye?e.id:e;this._assetReference.id=t}set rootBone(e){if(this._rootBone!==e){const t=typeof e=="string";if(this._rootBone&&t&&this._rootBone.getGuid()===e)return;this._rootBone&&this._clearSkinInstances(),e instanceof Jt?this._rootBone=e:t?(this._rootBone=this.system.app.getEntityFromIndex(e)||null,this._rootBone):this._rootBone=null,this._rootBone&&this._cloneSkinInstances()}}get rootBone(){return this._rootBone}destroyMeshInstances(){const e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){var a;const e=this.system.app,t=e.scene,s=t.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));const i=this._type==="asset";this._meshInstances&&this._meshInstances.length?this.addToLayers():i&&this.asset&&this._onRenderAssetAdded();for(let n=0;n<this._materialReferences.length;n++)this._materialReferences[n].asset&&this.system.app.assets.load(this._materialReferences[n].asset);this._batchGroupId>=0&&((a=e.batcher)==null||a.insert(zi.RENDER,this.batchGroupId,this.entity))}onDisable(){var i,a,n,r;const e=this.system.app,s=e.scene.layers;(i=this._evtLayersChanged)==null||i.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),s&&((a=this._evtLayerAdded)==null||a.off(),this._evtLayerAdded=null,(n=this._evtLayerRemoved)==null||n.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&((r=e.batcher)==null||r.remove(zi.RENDER,this.batchGroupId,this.entity)),this.removeFromLayers()}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){var e;if(this.destroyMeshInstances(),this._assetReference.asset){const t=this._assetReference.asset.resource;(e=this._evtSetMeshes)==null||e.off(),this._evtSetMeshes=t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e];f1.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone instanceof Jt)for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e],s=t.mesh;s.skin&&!t.skinInstance&&(t.skinInstance=f1.createCachedSkinInstance(s.skin,this._rootBone,this.entity))}}_cloneMeshes(e){if(e&&e.length){const t=[];for(let s=0;s<e.length;s++){const i=e[s],a=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,n=new ps(i,a||this.system.defaultMaterial,this.entity);t.push(n),i.morph&&(n.morphInstance=new jd(i.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){this._type==="asset"&&this.destroyMeshInstances()}_onRenderAssetRemove(){var e;(e=this._evtSetMeshes)==null||e.off(),this._evtSetMeshes=null,this._onRenderAssetUnload()}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(e,t){e===0&&(this.material=t)}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource)}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&(this.rootBone=t[e.rootBone.getGuid()])}}class ite{constructor(){this.enabled=!0}}const O3=["enabled"],fp=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"];class d8 extends ei{constructor(e){super(e),this.id="render",this.ComponentType=aL,this.DataType=ite,this.schema=O3,this.defaultMaterial=ly(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){(t.batchGroupId===null||t.batchGroupId===void 0)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<fp.length;i++)t.hasOwnProperty(fp[i])&&(e[fp[i]]=t[fp[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new wt(new H(t.aabbCenter),new H(t.aabbHalfExtents))),super.initializeComponentData(e,t,O3)}cloneComponent(e,t){const s={};for(let r=0;r<fp.length;r++)s[fp[r]]=e.render[fp[r]];s.enabled=e.render.enabled,delete s.meshInstances;const i=this.addComponent(t,s),a=e.render.meshInstances,n=a.map(r=>r.mesh);i._onSetMeshes(n);for(let r=0;r<a.length;r++)i.meshInstances[r].material=a[r].material;return e.render.customAabb&&(i.customAabb=e.render.customAabb.clone()),i}onRemove(e,t){t.onRemove()}}xt._buildAccessors(aL.prototype,O3);class qR{constructor(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t)}_resize(e){if(e>this._pool.length)for(let t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(this._pool.length*2),this._pool[this._count++]}freeAll(){this._count=0}}let hr,ss,jo,xg;const ate=new Ne,nte=new Ne,UE=new H,md=class md extends xt{static onLibraryLoaded(){typeof Ammo<"u"&&(hr=new Ammo.btTransform,ss=new Ammo.btVector3,jo=new Ammo.btVector3,xg=new Ammo.btQuaternion)}static onAppDestroy(){Ammo.destroy(hr),Ammo.destroy(ss),Ammo.destroy(jo),Ammo.destroy(xg),hr=null,ss=null,jo=null,xg=null}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}get angularDamping(){return this._angularDamping}set angularFactor(e){this._angularFactor.equals(e)||(this._angularFactor.copy(e),this._body&&this._type===cr&&(ss.setValue(e.x,e.y,e.z),this._body.setAngularFactor(ss)))}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&this._type===cr&&(this._body.activate(),ss.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(ss),this._angularVelocity.copy(e))}get angularVelocity(){if(this._body&&this._type===cr){const e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate())}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(e){this._linearFactor.equals(e)||(this._linearFactor.copy(e),this._body&&this._type===cr&&(ss.setValue(e.x,e.y,e.z),this._body.setLinearFactor(ss)))}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&this._type===cr&&(this._body.activate(),ss.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(ss),this._linearVelocity.copy(e))}get linearVelocity(){if(this._body&&this._type===cr){const e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===cr)){const t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,ss),this._body.setMassProps(e,ss),this._body.updateInertiaTensor(),t&&this.enableSimulation()}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case cr:this._group=Vz,this._mask=C3;break;case cd:this._group=Gz,this._mask=C3;break;case Rp:default:this._group=E3,this._mask=t2;break}this.createBody()}}get type(){return this._type}createBody(){const e=this.entity;let t;if(e.collision&&(t=e.collision.shape,e.trigger&&(e.trigger.destroy(),delete e.trigger)),t){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);const s=this._type===cr?this._mass:0;this._getEntityTransform(hr);const i=this.system.createBody(s,t,hr);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===cr){const a=this._linearFactor;ss.setValue(a.x,a.y,a.z),i.setLinearFactor(ss);const n=this._angularFactor;ss.setValue(n.x,n.y,n.z),i.setAngularFactor(ss)}else this._type===cd&&(i.setCollisionFlags(i.getCollisionFlags()|JP),i.setActivationState(e2));i.entity=e,this.body=i,this.enabled&&e.enabled&&this.enableSimulation()}}isActive(){return this._body?this._body.isActive():!1}activate(){this._body&&this._body.activate()}enableSimulation(){const e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){const t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case cr:this.system._dynamic.push(this),t.forceActivationState(c1),this.syncEntityToBody();break;case cd:this.system._kinematic.push(this),t.forceActivationState(e2);break;case Rp:t.forceActivationState(c1),this.syncEntityToBody();break}e.collision.type==="compound"&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=!0}}}disableSimulation(){const e=this._body;if(e&&this._simulationEnabled){const t=this.system;let s=t._compounds.indexOf(this.entity.collision);s>-1&&t._compounds.splice(s,1),s=t._dynamic.indexOf(this),s>-1&&t._dynamic.splice(s,1),s=t._kinematic.indexOf(this),s>-1&&t._kinematic.splice(s,1),t.removeBody(e),e.forceActivationState(qC),this._simulationEnabled=!1}}applyForce(e,t,s,i,a,n){const r=this._body;r&&(r.activate(),e instanceof H?ss.setValue(e.x,e.y,e.z):ss.setValue(e,t,s),t instanceof H?jo.setValue(t.x,t.y,t.z):i!==void 0?jo.setValue(i,a,n):jo.setValue(0,0,0),r.applyForce(ss,jo))}applyTorque(e,t,s){const i=this._body;i&&(i.activate(),e instanceof H?ss.setValue(e.x,e.y,e.z):ss.setValue(e,t,s),i.applyTorque(ss))}applyImpulse(e,t,s,i,a,n){const r=this._body;r&&(r.activate(),e instanceof H?ss.setValue(e.x,e.y,e.z):ss.setValue(e,t,s),t instanceof H?jo.setValue(t.x,t.y,t.z):i!==void 0?jo.setValue(i,a,n):jo.setValue(0,0,0),r.applyImpulse(ss,jo))}applyTorqueImpulse(e,t,s){const i=this._body;i&&(i.activate(),e instanceof H?ss.setValue(e.x,e.y,e.z):ss.setValue(e,t,s),i.applyTorqueImpulse(ss))}isStatic(){return this._type===Rp}isStaticOrKinematic(){return this._type===Rp||this._type===cd}isKinematic(){return this._type===cd}_getEntityTransform(e){const t=this.entity,s=t.collision;if(s){const i=s.getShapePosition(),a=s.getShapeRotation();ss.setValue(i.x,i.y,i.z),xg.setValue(a.x,a.y,a.z,a.w)}else{const i=t.getPosition(),a=t.getRotation();ss.setValue(i.x,i.y,i.z),xg.setValue(a.x,a.y,a.z,a.w)}e.setOrigin(ss),e.setRotation(xg)}syncEntityToBody(){const e=this._body;if(e){if(this._getEntityTransform(hr),e.setWorldTransform(hr),this._type===cd){const t=e.getMotionState();t&&t.setWorldTransform(hr)}e.activate()}}_updateDynamic(){const e=this._body;if(e.isActive()){const t=e.getMotionState();if(t){const s=this.entity;t.getWorldTransform(hr);const i=hr.getOrigin(),a=hr.getRotation(),n=s.collision;if(n&&n._hasOffset){const r=n.data.linearOffset,l=n.data.angularOffset,u=nte.copy(l).invert(),f=ate.set(a.x(),a.y(),a.z(),a.w()).mul(u);f.transformVector(r,UE),s.setPosition(i.x()-UE.x,i.y()-UE.y,i.z()-UE.z),s.setRotation(f)}else s.setPosition(i.x(),i.y(),i.z()),s.setRotation(a.x(),a.y(),a.z(),a.w())}}}_updateKinematic(){const e=this._body.getMotionState();e&&(this._getEntityTransform(hr),e.setWorldTransform(hr))}teleport(e,t,s,i,a,n){e instanceof H?this.entity.setPosition(e):this.entity.setPosition(e,t,s),t instanceof Ne?this.entity.setRotation(t):t instanceof H?this.entity.setEulerAngles(t):i!==void 0&&this.entity.setEulerAngles(i,a,n),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}constructor(...e){super(...e),this._angularDamping=0,this._angularFactor=new H(1,1,1),this._angularVelocity=new H,this._body=null,this._friction=.5,this._group=E3,this._linearDamping=0,this._linearFactor=new H(1,1,1),this._linearVelocity=new H,this._mask=t2,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=Rp}};md.EVENT_CONTACT="contact",md.EVENT_COLLISIONSTART="collisionstart",md.EVENT_COLLISIONEND="collisionend",md.EVENT_TRIGGERENTER="triggerenter",md.EVENT_TRIGGERLEAVE="triggerleave",md.order=-1;let Wc=md;class rte{constructor(){this.enabled=!0}}let vc,Sc;class N3{constructor(e,t,s,i){this.entity=e,this.point=t,this.normal=s,this.hitFraction=i}}class f8{constructor(e,t,s){arguments.length!==0?(this.a=e,this.b=t,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new H,this.localPointB=new H,this.pointA=new H,this.pointB=new H,this.normal=new H)}}class p8{constructor(e=new H,t=new H,s=new H,i=new H,a=new H,n=0){this.localPoint=e,this.localPointOther=t,this.point=s,this.pointOther=i,this.normal=a,this.impulse=n}}class m8{constructor(e,t){this.other=e,this.contacts=t}}const _8=["enabled"],OL=class OL extends ei{constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new H(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=Wc,this.DataType=rte,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=_8,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this)}onLibraryLoaded(){if(typeof Ammo<"u"){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}vc=new Ammo.btVector3,Sc=new Ammo.btVector3,Wc.onLibraryLoaded(),this.contactPointPool=new qR(p8,1),this.contactResultPool=new qR(m8,1),this.singleContactResultPool=new qR(f8,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const a of i)if(t.hasOwnProperty(a)){const n=t[a];Array.isArray(n)?e[a]=new H(n[0],n[1],n[2]):e[a]=n}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&(t.enabled=!1),t.body&&(this.destroyBody(t.body),t.body=null)}addBody(e,t,s){t!==void 0&&s!==void 0?this.dynamicsWorld.addRigidBody(e,t,s):this.dynamicsWorld.addRigidBody(e)}removeBody(e){this.dynamicsWorld.removeRigidBody(e)}createBody(e,t,s){const i=new Ammo.btVector3(0,0,0);e!==0&&t.calculateLocalInertia(e,i);const a=new Ammo.btDefaultMotionState(s),n=new Ammo.btRigidBodyConstructionInfo(e,a,t,i),r=new Ammo.btRigidBody(n);return Ammo.destroy(n),Ammo.destroy(i),r}destroyBody(e){const t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)}raycastFirst(e,t,s={}){if(s.filterTags||s.filterCallback)return s.sort=!0,this.raycastAll(e,t,s)[0]||null;let i=null;vc.setValue(e.x,e.y,e.z),Sc.setValue(t.x,t.y,t.z);const a=new Ammo.ClosestRayResultCallback(vc,Sc);if(typeof s.filterCollisionGroup=="number"&&a.set_m_collisionFilterGroup(s.filterCollisionGroup),typeof s.filterCollisionMask=="number"&&a.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(vc,Sc,a),a.hasHit()){const n=a.get_m_collisionObject(),r=Ammo.castObject(n,Ammo.btRigidBody);if(r){const l=a.get_m_hitPointWorld(),u=a.get_m_hitNormalWorld();i=new N3(r.entity,new H(l.x(),l.y(),l.z()),new H(u.x(),u.y(),u.z()),a.get_m_closestHitFraction())}}return Ammo.destroy(a),i}raycastAll(e,t,s={}){const i=[];vc.setValue(e.x,e.y,e.z),Sc.setValue(t.x,t.y,t.z);const a=new Ammo.AllHitsRayResultCallback(vc,Sc);if(typeof s.filterCollisionGroup=="number"&&a.set_m_collisionFilterGroup(s.filterCollisionGroup),typeof s.filterCollisionMask=="number"&&a.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(vc,Sc,a),a.hasHit()){const n=a.get_m_collisionObjects(),r=a.get_m_hitPointWorld(),l=a.get_m_hitNormalWorld(),u=a.get_m_hitFractions(),f=n.size();for(let _=0;_<f;_++){const g=Ammo.castObject(n.at(_),Ammo.btRigidBody);if(g&&g.entity){if(s.filterTags&&!g.entity.tags.has(...s.filterTags)||s.filterCallback&&!s.filterCallback(g.entity))continue;const y=r.at(_),v=l.at(_),x=new N3(g.entity,new H(y.x(),y.y(),y.z()),new H(v.x(),v.y(),v.z()),u.at(_));i.push(x)}}s.sort&&i.sort((_,g)=>_.hitFraction-g.hitFraction)}return Ammo.destroy(a),i}_storeCollision(e,t){let s=!1;const i=e.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:e},this.collisions[i].others.indexOf(t)<0&&(this.collisions[i].others.push(t),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:e},this.frameCollisions[i].others.push(t),s}_createContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),a=e.getPositionWorldOnB(),n=e.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPoint.set(t.x(),t.y(),t.z()),r.localPointOther.set(s.x(),s.y(),s.z()),r.point.set(i.x(),i.y(),i.z()),r.pointOther.set(a.x(),a.y(),a.z()),r.normal.set(n.x(),n.y(),n.z()),r.impulse=e.getAppliedImpulse(),r}_createReverseContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),a=e.getPositionWorldOnB(),n=e.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPointOther.set(t.x(),t.y(),t.z()),r.localPoint.set(s.x(),s.y(),s.z()),r.pointOther.set(i.x(),i.y(),i.z()),r.point.set(a.x(),a.y(),a.z()),r.normal.set(n.x(),n.y(),n.z()),r.impulse=e.getAppliedImpulse(),r}_createSingleContactResult(e,t,s){const i=this.singleContactResultPool.allocate();return i.a=e,i.b=t,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(e,t){const s=this.contactResultPool.allocate();return s.other=e,s.contacts=t,s}_cleanOldCollisions(){for(const e in this.collisions)if(this.collisions.hasOwnProperty(e)){const t=this.frameCollisions[e],s=this.collisions[e],i=s.entity,a=i.collision,n=i.rigidbody,r=s.others;let u=r.length;for(;u--;){const f=r[u];(!t||t.others.indexOf(f)<0)&&(r.splice(u,1),i.trigger?(a&&a.fire("triggerleave",f),f.rigidbody&&f.rigidbody.fire("triggerleave",i)):f.trigger||(n&&n.fire("collisionend",f),a&&a.fire("collisionend",f)))}r.length===0&&delete this.collisions[e]}}_hasContactEvent(e){const t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return!0;const s=e.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(e,t){const i=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),a=i.getNumManifolds();this.frameCollisions={};for(let n=0;n<a;n++){const r=i.getManifoldByIndexInternal(n),l=r.getBody0(),u=r.getBody1(),f=Ammo.castObject(l,Ammo.btRigidBody),_=Ammo.castObject(u,Ammo.btRigidBody),g=f.entity,y=_.entity;if(!g||!y)continue;const v=f.getCollisionFlags(),x=_.getCollisionFlags(),C=r.getNumContacts(),M=[],w=[];let T;if(C>0)if(v&kp||x&kp){const R=g.collision&&(g.collision.hasEvent("triggerenter")||g.collision.hasEvent("triggerleave")),D=y.collision&&(y.collision.hasEvent("triggerenter")||y.collision.hasEvent("triggerleave")),I=g.rigidbody&&(g.rigidbody.hasEvent("triggerenter")||g.rigidbody.hasEvent("triggerleave")),U=y.rigidbody&&(y.rigidbody.hasEvent("triggerenter")||y.rigidbody.hasEvent("triggerleave"));R&&(T=this._storeCollision(g,y),T&&!(x&kp)&&g.collision.fire("triggerenter",y)),D&&(T=this._storeCollision(y,g),T&&!(v&kp)&&y.collision.fire("triggerenter",g)),I&&(T||(T=this._storeCollision(y,g)),T&&g.rigidbody.fire("triggerenter",y)),U&&(T||(T=this._storeCollision(g,y)),T&&y.rigidbody.fire("triggerenter",g))}else{const R=this._hasContactEvent(g),D=this._hasContactEvent(y),I=this.hasEvent("contact");if(I||R||D){for(let U=0;U<C;U++){const O=r.getContactPoint(U),N=this._createContactPointFromAmmo(O);if(R||D){M.push(N);const z=this._createReverseContactPointFromAmmo(O);w.push(z)}if(I){const z=this._createSingleContactResult(g,y,N);this.fire("contact",z)}}if(R){const U=this._createContactResult(y,M);T=this._storeCollision(g,y),g.collision&&(g.collision.fire("contact",U),T&&g.collision.fire("collisionstart",U)),g.rigidbody&&(g.rigidbody.fire("contact",U),T&&g.rigidbody.fire("collisionstart",U))}if(D){const U=this._createContactResult(g,w);T=this._storeCollision(y,g),y.collision&&(y.collision.fire("contact",U),T&&y.collision.fire("collisionstart",U)),y.rigidbody&&(y.rigidbody.fire("contact",U),T&&y.rigidbody.fire("collisionstart",U))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(e){let t,s;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;const i=this.dynamicsWorld.getGravity();(i.x()!==this._gravityFloat32[0]||i.y()!==this._gravityFloat32[1]||i.z()!==this._gravityFloat32[2])&&(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const a=this._triggers;for(t=0,s=a.length;t<s;t++)a[t].updateTransform();const n=this._compounds;for(t=0,s=n.length;t<s;t++)n[t]._updateCompound();const r=this._kinematic;for(t=0,s=r.length;t<s;t++)r[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);const l=this._dynamic;for(t=0,s=l.length;t<s;t++)l[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),typeof Ammo<"u"&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(vc),Ammo.destroy(Sc),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,vc=null,Sc=null,Wc.onAppDestroy())}};OL.EVENT_CONTACT="contact";let p1=OL;xt._buildAccessors(Wc.prototype,_8);const Uc="none",a2="blend",_4=new Me;class nL extends xt{constructor(e,t){super(e,t),this._resolution=new Ee(640,320),this._referenceResolution=new Ee(640,320),this._scaleMode=Uc,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new Me,this._elements=new Set,e.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(e,t){var i;if(!(e instanceof Kt))return t;if(e.element){const a=e.element.drawOrder;e.element.drawOrder=t++,e.element._batchGroupId>=0&&a!==e.element.drawOrder&&((i=this.system.app.batcher)==null||i.markGroupDirty(e.element._batchGroupId))}e.particlesystem&&(e.particlesystem.drawOrder=t++);const s=e.children;for(let a=0;a<s.length;a++)t=this._recurseDrawOrderSync(s[a],t);return t}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){const e=this._resolution.x/this.scale,t=this._resolution.y/this.scale,s=0,i=e,a=-t;this._screenMatrix.setOrtho(s,i,a,0,1,-1),this._screenSpace||(_4.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(_4,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(e,t){const s=Math.log2((e.x||1)/t.x),i=Math.log2((e.y||1)/t.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)}_bindElement(e){this._elements.add(e)}_unbindElement(e){this._elements.delete(e)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(e=>e._onScreenRemove()),this._elements.clear(),this.off()}set resolution(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get resolution(){return this._resolution}set referenceResolution(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get referenceResolution(){return this._scaleMode===Uc?this._resolution:this._referenceResolution}set screenSpace(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(t=>t._onScreenSpaceChange())}get screenSpace(){return this._screenSpace}set scaleMode(e){e!==Uc&&e!==a2&&(e=Uc),!this._screenSpace&&e!==Uc&&(e=Uc),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get scaleBlend(){return this._scaleBlend}set priority(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder())}get priority(){return this._priority}}class ote{constructor(){this.enabled=!0}}const F3=["enabled"];class g8 extends ei{constructor(e){super(e),this.id="screen",this.ComponentType=nL,this.DataType=ote,this.schema=F3,this.windowResolution=new Ee,this._drawOrderSyncQueue=new lF,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(e,t,s){t.priority!==void 0&&(e.priority=t.priority),t.screenSpace!==void 0&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,t.scaleMode!==void 0&&(e.scaleMode=t.scaleMode),t.scaleBlend!==void 0&&(e.scaleBlend=t.scaleBlend),t.resolution!==void 0&&(t.resolution instanceof Ee?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),t.referenceResolution!==void 0&&(t.referenceResolution instanceof Ee?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),super.initializeComponentData(e,t,F3)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(e){const t=this.store;for(const s in t)t[s].entity.screen.update&&t[s].entity.screen.update(e)}_onResize(e,t){this.windowResolution.x=e,this.windowResolution.y=t}cloneComponent(e,t){const s=e.screen;return this.addComponent(t,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(e,t){t.onRemove()}processDrawOrderSyncQueue(){const e=this._drawOrderSyncQueue.list();for(let t=0;t<e.length;t++){const s=e[t];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(e,t,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:s})}}xt._buildAccessors(nL.prototype,F3);const td=new Ee,g4=new H,pp=new ll,y4=new E1,v4=new H,nS=new H,lte=new Ne,hte={x:"y",y:"x"},Mb=class Mb extends Qe{constructor(e,t){if(super(),!e||!(e instanceof d1))throw new Error("Element was null or not an ElementComponent");if(t&&t!=="x"&&t!=="y")throw new Error(`Unrecognized axis: ${t}`);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=!0,this._dragScale=new H,this._dragStartMousePosition=new H,this._dragStartHandlePosition=new H,this._deltaMousePosition=new H,this._deltaHandlePosition=new H,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(e){const t=e==="on";this._hasDragListeners&&t||(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),Ct.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=t)}_onMouseDownOrTouchStart(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();const t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(e){return e.inputSource?pp.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),v4.copy(this._element.entity.forward).mulScalar(-1),y4.setFromPointNormal(this._element.entity.getPosition(),v4),y4.intersectsRay(pp,nS)?(lte.copy(this._element.entity.getRotation()).invert().transformVector(nS,nS),nS.mul(this._dragScale),nS):null}_determineInputPosition(e){const t=this._app.graphicsDevice.maxPixelRatio;typeof e.x<"u"&&typeof e.y<"u"?(td.x=e.x*t,td.y=e.y*t):e.changedTouches?(td.x=e.changedTouches[0].x*t,td.y=e.changedTouches[0].y*t):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(pp.origin.set(td.x,-td.y,0),pp.direction.copy(H.FORWARD)):(g4.copy(this._dragCamera.screenToWorld(td.x,td.y,1)),pp.origin.copy(this._dragCamera.entity.getPosition()),pp.direction.copy(g4).sub(pp.origin).normalize())}_calculateDragScale(){let e=this._element.entity.parent;const t=this._element.screen&&this._element.screen.screen,s=t&&t.screenSpace,i=s?t.scale:1,a=this._dragScale;for(a.set(i,i,i);e&&(a.mul(e.getLocalScale()),e=e.parent,!(s&&e.screen)););a.x=1/a.x,a.y=1/a.y,a.z=0}_onMove(e){const{_element:t,_deltaMousePosition:s,_deltaHandlePosition:i,_axis:a}=this;if(t&&this._isDragging&&this.enabled&&t.enabled&&t.entity.enabled){const n=this._screenToLocal(e);if(n){if(s.sub2(n,this._dragStartMousePosition),i.add2(this._dragStartHandlePosition,s),a){const r=t.entity.getLocalPosition(),l=hte[a];i[l]=r[l]}t.entity.setLocalPosition(i),this.fire("drag:move",i)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(e){this._enabled=e}get enabled(){return this._enabled}get isDragging(){return this._isDragging}};Mb.EVENT_DRAGSTART="drag:start",Mb.EVENT_DRAGEND="drag:end",Mb.EVENT_DRAGMOVE="drag:move";let m1=Mb;const y8=0,B3=1,v8=2,S8=0,b8=1,rS=new Ee,NL=class NL extends xt{constructor(e,t){super(e,t),this._viewportEntity=null,this._contentEntity=null,this._horizontalScrollbarEntity=null,this._verticalScrollbarEntity=null,this._evtElementRemove=null,this._evtViewportElementRemove=null,this._evtViewportResize=null,this._evtContentEntityElementAdd=null,this._evtContentElementRemove=null,this._evtContentResize=null,this._evtHorizontalScrollbarAdd=null,this._evtHorizontalScrollbarRemove=null,this._evtHorizontalScrollbarValue=null,this._evtVerticalScrollbarAdd=null,this._evtVerticalScrollbarRemove=null,this._evtVerticalScrollbarValue=null,this._scrollbarUpdateFlags={},this._scrollbarEntities={},this._prevContentSizes={},this._prevContentSizes[At]=null,this._prevContentSizes[Ms]=null,this._scroll=new Ee,this._velocity=new H,this._dragStartPosition=new H,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on"),this._toggleElementListeners("on")}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set horizontal(e){this._setValue("horizontal",e)}get horizontal(){return this.data.horizontal}set vertical(e){this._setValue("vertical",e)}get vertical(){return this.data.vertical}set scrollMode(e){this._setValue("scrollMode",e)}get scrollMode(){return this.data.scrollMode}set bounceAmount(e){this._setValue("bounceAmount",e)}get bounceAmount(){return this.data.bounceAmount}set friction(e){this._setValue("friction",e)}get friction(){return this.data.friction}set dragThreshold(e){this._setValue("dragThreshold",e)}get dragThreshold(){return this.data.dragThreshold}set useMouseWheel(e){this._setValue("useMouseWheel",e)}get useMouseWheel(){return this.data.useMouseWheel}set mouseWheelSensitivity(e){this._setValue("mouseWheelSensitivity",e)}get mouseWheelSensitivity(){return this.data.mouseWheelSensitivity}set horizontalScrollbarVisibility(e){this._setValue("horizontalScrollbarVisibility",e)}get horizontalScrollbarVisibility(){return this.data.horizontalScrollbarVisibility}set verticalScrollbarVisibility(e){this._setValue("verticalScrollbarVisibility",e)}get verticalScrollbarVisibility(){return this.data.verticalScrollbarVisibility}set viewportEntity(e){if(this._viewportEntity===e)return;const t=typeof e=="string";this._viewportEntity&&t&&this._viewportEntity.getGuid()===e||(this._viewportEntity&&this._viewportEntityUnsubscribe(),e instanceof Jt?this._viewportEntity=e:t?this._viewportEntity=this.system.app.getEntityFromIndex(e)||null:this._viewportEntity=null,this._viewportEntity&&this._viewportEntitySubscribe(),this._viewportEntity?this.data.viewportEntity=this._viewportEntity.getGuid():t&&e&&(this.data.viewportEntity=e))}get viewportEntity(){return this._viewportEntity}set contentEntity(e){if(this._contentEntity===e)return;const t=typeof e=="string";this._contentEntity&&t&&this._contentEntity.getGuid()===e||(this._contentEntity&&this._contentEntityUnsubscribe(),e instanceof Jt?this._contentEntity=e:t?this._contentEntity=this.system.app.getEntityFromIndex(e)||null:this._contentEntity=null,this._contentEntity&&this._contentEntitySubscribe(),this._contentEntity?this.data.contentEntity=this._contentEntity.getGuid():t&&e&&(this.data.contentEntity=e))}get contentEntity(){return this._contentEntity}set horizontalScrollbarEntity(e){if(this._horizontalScrollbarEntity===e)return;const t=typeof e=="string";this._horizontalScrollbarEntity&&t&&this._horizontalScrollbarEntity.getGuid()===e||(this._horizontalScrollbarEntity&&this._horizontalScrollbarEntityUnsubscribe(),e instanceof Jt?this._horizontalScrollbarEntity=e:t?this._horizontalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._horizontalScrollbarEntity=null,this._scrollbarEntities[At]=this._horizontalScrollbarEntity,this._horizontalScrollbarEntity&&this._horizontalScrollbarEntitySubscribe(),this._horizontalScrollbarEntity?this.data.horizontalScrollbarEntity=this._horizontalScrollbarEntity.getGuid():t&&e&&(this.data.horizontalScrollbarEntity=e))}get horizontalScrollbarEntity(){return this._horizontalScrollbarEntity}set verticalScrollbarEntity(e){if(this._verticalScrollbarEntity===e)return;const t=typeof e=="string";this._verticalScrollbarEntity&&t&&this._verticalScrollbarEntity.getGuid()===e||(this._verticalScrollbarEntity&&this._verticalScrollbarEntityUnsubscribe(),e instanceof Jt?this._verticalScrollbarEntity=e:t?this._verticalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._verticalScrollbarEntity=null,this._scrollbarEntities[Ms]=this._verticalScrollbarEntity,this._verticalScrollbarEntity&&this._verticalScrollbarEntitySubscribe(),this._verticalScrollbarEntity?this.data.verticalScrollbarEntity=this._verticalScrollbarEntity.getGuid():t&&e&&(this.data.verticalScrollbarEntity=e))}get verticalScrollbarEntity(){return this._verticalScrollbarEntity}set scroll(e){this._onSetScroll(e.x,e.y)}get scroll(){return this._scroll}_setValue(e,t){const s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}_toggleLifecycleListeners(e){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),this.entity[e]("element:add",this._onElementComponentAdd,this)}_toggleElementListeners(e){if(this.entity.element){if(e==="on"&&this._hasElementListeners)return;this.entity.element[e]("resize",this._syncAll,this),this.entity.element[e]("mousewheel",this._onMouseWheel,this),this._hasElementListeners=e==="on"}}_onElementComponentAdd(e){this._evtElementRemove=this.entity.element.once("beforeremove",this._onElementComponentRemove,this),this._toggleElementListeners("on")}_onElementComponentRemove(e){var t;(t=this._evtElementRemove)==null||t.off(),this._evtElementRemove=null,this._toggleElementListeners("off")}_viewportEntitySubscribe(){this._evtViewportEntityElementAdd=this._viewportEntity.on("element:add",this._onViewportElementGain,this),this._viewportEntity.element&&this._onViewportElementGain()}_viewportEntityUnsubscribe(){var e,t;(e=this._evtViewportEntityElementAdd)==null||e.off(),this._evtViewportEntityElementAdd=null,(t=this._viewportEntity)!=null&&t.element&&this._onViewportElementLose()}_viewportEntityElementSubscribe(){const e=this._viewportEntity.element;this._evtViewportElementRemove=e.once("beforeremove",this._onViewportElementLose,this),this._evtViewportResize=e.on("resize",this._syncAll,this)}_viewportEntityElementUnsubscribe(){var e,t;(e=this._evtViewportElementRemove)==null||e.off(),this._evtViewportElementRemove=null,(t=this._evtViewportResize)==null||t.off(),this._evtViewportResize=null}_onViewportElementGain(){this._viewportEntityElementSubscribe(),this._syncAll()}_onViewportElementLose(){this._viewportEntityElementUnsubscribe()}_contentEntitySubscribe(){this._evtContentEntityElementAdd=this._contentEntity.on("element:add",this._onContentElementGain,this),this._contentEntity.element&&this._onContentElementGain()}_contentEntityUnsubscribe(){var e,t;(e=this._evtContentEntityElementAdd)==null||e.off(),this._evtContentEntityElementAdd=null,(t=this._contentEntity)!=null&&t.element&&this._onContentElementLose()}_contentEntityElementSubscribe(){const e=this._contentEntity.element;this._evtContentElementRemove=e.once("beforeremove",this._onContentElementLose,this),this._evtContentResize=e.on("resize",this._syncAll,this)}_contentEntityElementUnsubscribe(){var e,t;(e=this._evtContentElementRemove)==null||e.off(),this._evtContentElementRemove=null,(t=this._evtContentResize)==null||t.off(),this._evtContentResize=null}_onContentElementGain(){this._contentEntityElementSubscribe(),this._destroyDragHelper(),this._contentDragHelper=new m1(this._contentEntity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[At]=null,this._prevContentSizes[Ms]=null,this._syncAll()}_onContentElementLose(){this._contentEntityElementUnsubscribe(),this._destroyDragHelper()}_onContentDragStart(){this._contentEntity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentEntity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(e){if(this._contentEntity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){const t=e.x-this._dragStartPosition.x,s=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_horizontalScrollbarEntitySubscribe(){this._evtHorizontalScrollbarAdd=this._horizontalScrollbarEntity.on("scrollbar:add",this._onHorizontalScrollbarGain,this),this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarGain()}_verticalScrollbarEntitySubscribe(){this._evtVerticalScrollbarAdd=this._verticalScrollbarEntity.on("scrollbar:add",this._onVerticalScrollbarGain,this),this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarGain()}_horizontalScrollbarEntityUnsubscribe(){var e;(e=this._evtHorizontalScrollbarAdd)==null||e.off(),this._evtHorizontalScrollbarAdd=null,this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarLose()}_verticalScrollbarEntityUnsubscribe(){var e;(e=this._evtVerticalScrollbarAdd)==null||e.off(),this._evtVerticalScrollbarAdd=null,this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarLose()}_onSetHorizontalScrollbarValue(e){!this._scrollbarUpdateFlags[At]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)}_onSetVerticalScrollbarValue(e){!this._scrollbarUpdateFlags[Ms]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)}_onHorizontalScrollbarGain(){var t;const e=(t=this._horizontalScrollbarEntity)==null?void 0:t.scrollbar;this._evtHorizontalScrollbarRemove=e.on("beforeremove",this._onHorizontalScrollbarLose,this),this._evtHorizontalScrollbarValue=e.on("set:value",this._onSetHorizontalScrollbarValue,this),this._syncScrollbarEnabledState(At),this._syncScrollbarPosition(At)}_onVerticalScrollbarGain(){var t;const e=(t=this._verticalScrollbarEntity)==null?void 0:t.scrollbar;this._evtVerticalScrollbarRemove=e.on("beforeremove",this._onVerticalScrollbarLose,this),this._evtVerticalScrollbarValue=e.on("set:value",this._onSetVerticalScrollbarValue,this),this._syncScrollbarEnabledState(Ms),this._syncScrollbarPosition(Ms)}_onHorizontalScrollbarLose(){var e,t;(e=this._evtHorizontalScrollbarRemove)==null||e.off(),this._evtHorizontalScrollbarRemove=null,(t=this._evtHorizontalScrollbarValue)==null||t.off(),this._evtHorizontalScrollbarValue=null}_onVerticalScrollbarLose(){var e,t;(e=this._evtVerticalScrollbarRemove)==null||e.off(),this._evtVerticalScrollbarRemove=null,(t=this._evtVerticalScrollbarValue)==null||t.off(),this._evtVerticalScrollbarValue=null}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(At)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(Ms)}_onSetScroll(e,t,s){s!==!1&&this._velocity.set(0,0,0);const i=this._updateAxis(e,"x",At),a=this._updateAxis(t,"y",Ms);(i||a)&&this.fire("set:scroll",this._scroll)}_updateAxis(e,t,s){const i=e!==null&&Math.abs(e-this._scroll[t])>1e-5;return(i||this._isDragging()||e===0)&&(this._scroll[t]=this._determineNewScrollValue(e,t,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(e,t,s){if(!this._getScrollingEnabled(s))return this._scroll[t];switch(this.scrollMode){case y8:return ge.clamp(e,0,this._getMaxScrollValue(s));case B3:return this._setVelocityFromOvershoot(e,t,s),e;case v8:return e;default:return console.warn(`Unhandled scroll mode:${this.scrollMode}`),e}}_syncAll(){this._syncContentPosition(At),this._syncContentPosition(Ms),this._syncScrollbarPosition(At),this._syncScrollbarPosition(Ms),this._syncScrollbarEnabledState(At),this._syncScrollbarEnabledState(Ms)}_syncContentPosition(e){if(!this._contentEntity)return;const t=this._getAxis(e),s=this._getSign(e),i=this._prevContentSizes[e],a=this._getContentSize(e);if(i!==null&&Math.abs(i-a)>1e-4){const l=this._getMaxOffset(e,i),u=this._getMaxOffset(e,a);u===0?this._scroll[t]=1:this._scroll[t]=ge.clamp(this._scroll[t]*l/u,0,1)}const n=this._scroll[t]*this._getMaxOffset(e),r=this._contentEntity.getLocalPosition();r[t]=n*s,this._contentEntity.setLocalPosition(r),this._prevContentSizes[e]=a}_syncScrollbarPosition(e){const t=this._scrollbarEntities[e];if(!(t!=null&&t.scrollbar))return;const s=this._getAxis(e);this._scrollbarUpdateFlags[e]=!0,t.scrollbar.value=this._scroll[s],t.scrollbar.handleSize=this._getScrollbarHandleSize(s,e),this._scrollbarUpdateFlags[e]=!1}_syncScrollbarEnabledState(e){const t=this._scrollbarEntities[e];if(!t)return;const s=this._getScrollingEnabled(e),i=this._getScrollbarVisibility(e);switch(i){case S8:t.enabled=s;return;case b8:t.enabled=s&&this._contentIsLargerThanViewport(e);return;default:console.warn(`Unhandled scrollbar visibility:${i}`),t.enabled=s}}_contentIsLargerThanViewport(e){return this._getContentSize(e)>this._getViewportSize(e)}_contentPositionToScrollValue(e){const t=this._getMaxOffset(At),s=this._getMaxOffset(Ms);return t===0?rS.x=0:rS.x=e.x/t,s===0?rS.y=0:rS.y=e.y/-s,rS}_getMaxOffset(e,t){t=t===void 0?this._getContentSize(e):t;const s=this._getViewportSize(e);return t<s?-this._getViewportSize(e):s-t}_getMaxScrollValue(e){return this._contentIsLargerThanViewport(e)?1:0}_getScrollbarHandleSize(e,t){const s=this._getViewportSize(t),i=this._getContentSize(t);if(Math.abs(i)<.001)return 1;const a=Math.min(s/i,1),n=this._toOvershoot(this._scroll[e],t);return n===0?a:a/(1+Math.abs(n))}_getViewportSize(e){return this._getSize(e,this._viewportEntity)}_getContentSize(e){return this._getSize(e,this._contentEntity)}_getSize(e,t){return t!=null&&t.element?t.element[this._getCalculatedDimension(e)]:0}_getScrollingEnabled(e){if(e===At)return this.horizontal;if(e===Ms)return this.vertical}_getScrollbarVisibility(e){if(e===At)return this.horizontalScrollbarVisibility;if(e===Ms)return this.verticalScrollbarVisibility}_getSign(e){return e===At?1:-1}_getAxis(e){return e===At?"x":"y"}_getCalculatedDimension(e){return e===At?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentEntity&&(this._updateVelocity(),this._syncScrollbarEnabledState(At),this._syncScrollbarEnabledState(Ms))}_updateVelocity(){if(!this._isDragging()){if(this.scrollMode===B3&&(this._hasOvershoot("x",At)&&this._setVelocityFromOvershoot(this.scroll.x,"x",At),this._hasOvershoot("y",Ms)&&this._setVelocityFromOvershoot(this.scroll.y,"y",Ms)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const e=this._contentEntity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentEntity.setLocalPosition(e),this._setScrollFromContentPosition(e)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001}_toOvershoot(e,t){const s=this._getMaxScrollValue(t);return e<0?e:e>s?e-s:0}_setVelocityFromOvershoot(e,t,s){const a=this._toOvershoot(e,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(a)>0&&(this._velocity[t]=-a/(this.bounceAmount*50+1))}_setVelocityFromContentPositionDelta(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())}_setScrollFromContentPosition(e){let t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,!1)}_applyScrollValueTension(e){let s=this._getMaxScrollValue(At),i=this._toOvershoot(e.x,At);return i>0?e.x=s+1*Math.log10(1+i):i<0&&(e.x=-1*Math.log10(1-i)),s=this._getMaxScrollValue(Ms),i=this._toOvershoot(e.y,Ms),i>0?e.y=s+1*Math.log10(1+i):i<0&&(e.y=-1*Math.log10(1-i)),e}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(e){var t,s;(t=this._horizontalScrollbarEntity)!=null&&t.scrollbar&&(this._horizontalScrollbarEntity.scrollbar.enabled=e),(s=this._verticalScrollbarEntity)!=null&&s.scrollbar&&(this._verticalScrollbarEntity.scrollbar.enabled=e)}_setContentDraggingEnabled(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)}_onMouseWheel(e){var r;if(!this.useMouseWheel||!((r=this._contentEntity)!=null&&r.element))return;const t=e.event,s=t.deltaX/this._contentEntity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=t.deltaY/this._contentEntity.element.calculatedHeight*this.mouseWheelSensitivity.y,a=ge.clamp(this._scroll.x+s,0,this._getMaxScrollValue(At)),n=ge.clamp(this._scroll.y+i,0,this._getMaxScrollValue(Ms));this.scroll=new Ee(a,n)}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const e=t=>{t.element&&t.element.useInput&&(this._disabledContentInputEntities.push(t),t.element.useInput=!1);const s=t.children;for(let i=0,a=s.length;i<a;i++)e(s[i])};if(this._contentEntity){const t=this._contentEntity.children;for(let s=0,i=t.length;s<i;s++)e(t[s])}this._disabledContentInput=!0}onEnable(){this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off"),this._toggleElementListeners("off"),this._destroyDragHelper()}resolveDuplicatedEntityReferenceProperties(e,t){e.viewportEntity&&(this.viewportEntity=t[e.viewportEntity.getGuid()]),e.contentEntity&&(this.contentEntity=t[e.contentEntity.getGuid()]),e.horizontalScrollbarEntity&&(this.horizontalScrollbarEntity=t[e.horizontalScrollbarEntity.getGuid()]),e.verticalScrollbarEntity&&(this.verticalScrollbarEntity=t[e.verticalScrollbarEntity.getGuid()])}};NL.EVENT_SETSCROLL="set:scroll";let n2=NL;const cte=10;class ute{constructor(){this.enabled=!0,this.dragThreshold=cte,this.useMouseWheel=!0,this.mouseWheelSensitivity=new Ee(1,1),this.horizontalScrollbarVisibility=0,this.verticalScrollbarVisibility=0,this.viewportEntity=null,this.contentEntity=null,this.horizontalScrollbarEntity=null,this.verticalScrollbarEntity=null}}const S4=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"}],dte=10;class x8 extends ei{constructor(e){super(e),this.id="scrollview",this.ComponentType=n2,this.DataType=ute,this.schema=S4,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){t.dragThreshold===void 0&&(t.dragThreshold=dte),t.useMouseWheel===void 0&&(t.useMouseWheel=!0),t.mouseWheelSensitivity===void 0&&(t.mouseWheelSensitivity=new Ee(1,1)),super.initializeComponentData(e,t,S4),e.viewportEntity=t.viewportEntity,e.contentEntity=t.contentEntity,e.horizontalScrollbarEntity=t.horizontalScrollbarEntity,e.verticalScrollbarEntity=t.verticalScrollbarEntity}onUpdate(e){const t=this.store;for(const s in t){const i=t[s].entity,a=i.scrollview;a.enabled&&i.enabled&&a.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}const FL=class FL extends xt{constructor(e,t){super(e,t),this._handleEntity=null,this._evtHandleEntityElementAdd=null,this._evtHandleEntityChanges=[],this._toggleLifecycleListeners("on")}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set orientation(e){this._setValue("orientation",e)}get orientation(){return this.data.orientation}set value(e){this._setValue("value",e)}get value(){return this.data.value}set handleSize(e){this._setValue("handleSize",e)}get handleSize(){return this.data.handleSize}set handleEntity(e){if(this._handleEntity===e)return;const t=typeof e=="string";this._handleEntity&&t&&this._handleEntity.getGuid()===e||(this._handleEntity&&this._handleEntityUnsubscribe(),e instanceof Jt?this._handleEntity=e:t?this._handleEntity=this.system.app.getEntityFromIndex(e)||null:this._handleEntity=null,this._handleEntity&&this._handleEntitySubscribe(),this._handleEntity?this.data.handleEntity=this._handleEntity.getGuid():t&&e&&(this.data.handleEntity=e))}get handleEntity(){return this._handleEntity}_setValue(e,t){const s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}_toggleLifecycleListeners(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)}_handleEntitySubscribe(){this._evtHandleEntityElementAdd=this._handleEntity.on("element:add",this._onHandleElementGain,this),this._handleEntity.element&&this._onHandleElementGain()}_handleEntityUnsubscribe(){var e,t;(e=this._evtHandleEntityElementAdd)==null||e.off(),this._evtHandleEntityElementAdd=null,(t=this._handleEntity)!=null&&t.element&&this._onHandleElementLose()}_handleEntityElementSubscribe(){const e=this._handleEntity.element,t=this._evtHandleEntityChanges;t.push(e.once("beforeremove",this._onHandleElementLose,this)),t.push(e.on("set:anchor",this._onSetHandleAlignment,this)),t.push(e.on("set:margin",this._onSetHandleAlignment,this)),t.push(e.on("set:pivot",this._onSetHandleAlignment,this))}_handleEntityElementUnsubscribe(){for(let e=0;e<this._evtHandleEntityChanges.length;e++)this._evtHandleEntityChanges[e].off();this._evtHandleEntityChanges.length=0}_onHandleElementGain(){this._handleEntityElementSubscribe(),this._destroyDragHelper(),this._handleDragHelper=new m1(this._handleEntity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._handleEntityElementUnsubscribe(),this._destroyDragHelper()}_onHandleDrag(e){this._handleEntity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))}_onSetValue(e,t,s){Math.abs(s-t)>1e-5&&(this.data.value=ge.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(e,t,s){Math.abs(s-t)>1e-5&&(this.data.handleSize=ge.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(e,t,s){var i;s!==t&&((i=this._handleEntity)!=null&&i.element)&&(this._handleEntity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const e=this._handleEntity,t=e==null?void 0:e.element;if(e){const s=e.getLocalPosition();s[this._getAxis()]=this._getHandlePosition(),e.setLocalPosition(s)}t&&(t[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(e){return e*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(e){return e*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?this.orientation===At?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return this.orientation===At?1:-1}_getAxis(){return this.orientation===At?"x":"y"}_getDimension(){return this.orientation===At?"width":"height"}_getOppositeDimension(){return this.orientation===At?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)}onEnable(){this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}resolveDuplicatedEntityReferenceProperties(e,t){e.handleEntity&&(this.handleEntity=t[e.handleEntity.getGuid()])}};FL.EVENT_SETVALUE="set:value";let r2=FL;class fte{constructor(){this.enabled=!0,this.orientation=At,this.value=0,this.handleSize=0,this.handleEntity=null}}const b4=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"}];class T8 extends ei{constructor(e){super(e),this.id="scrollbar",this.ComponentType=r2,this.DataType=fte,this.schema=b4,this.on("add",this._onAddComponent,this),this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,b4),e.handleEntity=t.handleEntity}_onAddComponent(e){e.fire("scrollbar:add")}_onRemoveComponent(e,t){t.onRemove()}}const pte={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new H,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},Op=class Op extends Qe{constructor(e,t="Untitled",s={}){super(),this.instances=[],this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this.name=t,this._volume=s.volume!==void 0?ge.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0&&s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof Ye&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else{const t=function(s){const i=e._playWhenLoaded;e.sound=s,i&&e.play()};this.off("load",t),this.once("load",t),this.load()}return e}pause(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pause()&&(e=!0);return e}resume(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].resume()&&(e=!0);return e}stop(){let e=!1;const t=this.instances;let s=t.length;for(;s--;)t[s].stop(),e=!0;return t.length=0,e}load(){if(!this._hasAsset())return;const e=this._assets.get(this._asset);if(!e){this._assets.off(`add:${this._asset}`,this._onAssetAdd,this),this._assets.once(`add:${this._asset}`,this._onAssetAdd,this);return}if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource){e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e);return}this.fire("load",e.resource)}setExternalNodes(e,t){if(!e){console.error("The firstNode must have a valid AudioNode");return}if(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap){const s=this.instances;for(let i=0,a=s.length;i<a;i++)s[i].setExternalNodes(e,t)}}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return this._asset!=null}_createInstance(){let e=null;const t=this._component;let s=null;if(this._hasAsset()){const a=this._assets.get(this._asset);a&&(s=a.resource)}const i=pte;return i.volume=this._volume*t.volume,i.pitch=this._pitch*t.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,t.positional?(i.position.copy(t.entity.getPosition()),i.maxDistance=t.maxDistance,i.refDistance=t.refDistance,i.rollOffFactor=t.rollOffFactor,i.distanceModel=t.distanceModel,e=new wp(this._manager,s,i)):e=new vh(this._manager,s,i),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e}_onInstancePlay(e){this.fire("play",e),this._component.fire("play",this,e)}_onInstancePause(e){this.fire("pause",e),this._component.fire("pause",this,e)}_onInstanceResume(e){this.fire("resume",e),this._component.fire("resume",this,e)}_onInstanceStop(e){const t=this.instances.indexOf(e);t!==-1&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e)}_onInstanceEnd(e){const t=this.instances.indexOf(e);t!==-1&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)}_onAssetAdd(e){this.load()}_onAssetLoad(e){this.load()}_onAssetRemoved(e){e.off("remove",this._onAssetRemoved,this),this._assets.off(`add:${e.id}`,this._onAssetAdd,this),this.stop()}updatePosition(e){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].position=e}set asset(e){const t=this._asset;if(t){this._assets.off(`add:${t}`,this._onAssetAdd,this);const s=this._assets.get(t);s&&s.off("remove",this._onAssetRemoved,this)}this._asset=e,this._asset instanceof Ye&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(e){this._autoPlay=!!e}get autoPlay(){return this._autoPlay}set duration(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].duration=this._duration}}get duration(){let e=0;if(this._hasAsset()){const t=this._assets.get(this._asset);e=t!=null&&t.resource?t.resource.duration:0}return this._duration!=null?this._duration%(e||1):e}get isLoaded(){if(this._hasAsset()){const e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}get isPaused(){const e=this.instances,t=e.length;if(t===0)return!1;for(let s=0;s<t;s++)if(!e[s].isPaused)return!1;return!0}get isPlaying(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(e[t].isPlaying)return!0;return!1}get isStopped(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(!e[t].isStopped)return!1;return!0}set loop(e){this._loop=!!e;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].loop=this._loop}get loop(){return this._loop}set overlap(e){this._overlap=!!e}get overlap(){return this._overlap}set pitch(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].startTime=this._startTime}}get startTime(){return this._startTime}set volume(e){if(this._volume=ge.clamp(Number(e)||0,0,1),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].volume=this._volume*this._component.volume}}get volume(){return this._volume}};Op.EVENT_PLAY="play",Op.EVENT_PAUSE="pause",Op.EVENT_RESUME="resume",Op.EVENT_STOP="stop",Op.EVENT_LOAD="load";let h0=Op;const Np=class Np extends xt{_updateSoundInstances(e,t,s){const i=this._slots;for(const a in i){const n=i[a];if(!n.overlap){const r=n.instances;for(let l=0,u=r.length;l<u;l++)r[l][e]=s?n[e]*t:t}}}set distanceModel(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,!1)}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,!1)}get maxDistance(){return this._maxDistance}set refDistance(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,!1)}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(e){this._pitch=e,this._updateSoundInstances("pitch",e,!0)}get pitch(){return this._pitch}set volume(e){this._volume=e,this._updateSoundInstances("volume",e,!0)}get volume(){return this._volume}set positional(e){this._positional=e;const t=this._slots;for(const s in t){const i=t[s];if(!i.overlap){const a=i.instances,n=a.length;for(let r=n-1;r>=0;r--){const l=a[r].isPlaying||a[r].isSuspended,u=a[r].currentTime;l&&a[r].stop();const f=i._createInstance();l&&(f.play(),f.currentTime=u),a.push(f)}}}}get positional(){return this._positional}set slots(e){const t=this._slots;if(t)for(const i in t)t[i].stop();const s={};for(const i in e)e[i]instanceof h0?s[e[i].name]=e[i]:e[i].name&&(s[e[i].name]=new h0(this,e[i].name,e[i]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;const e=this._slots,t=this._playingBeforeDisable;for(const s in e){const i=e[s];i.autoPlay&&i.isStopped?i.play():t[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const e=this._slots,t={};for(const s in e)e[s].overlap||e[s].isPlaying&&(e[s].pause(),t[s]=!0);this._playingBeforeDisable=t}onRemove(){this.off()}addSlot(e,t){const s=this._slots;if(s[e])return null;const i=new h0(this,e,t);return s[e]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(e){const t=this._slots;t[e]&&(t[e].stop(),delete t[e])}slot(e){return this._slots[e]}_getSlotProperty(e,t){if(!this.enabled||!this.entity.enabled)return;const s=this._slots[e];if(s)return s[t]}isPlaying(e){return this._getSlotProperty(e,"isPlaying")||!1}isLoaded(e){return this._getSlotProperty(e,"isLoaded")||!1}isPaused(e){return this._getSlotProperty(e,"isPaused")||!1}isStopped(e){return this._getSlotProperty(e,"isStopped")||!1}play(e){if(!this.enabled||!this.entity.enabled)return null;const t=this._slots[e];return t?t.play():null}pause(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.pause()}else for(const s in t)t[s].pause()}resume(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.isPaused&&s.resume()}else for(const s in t)t[s].resume()}stop(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.stop()}else for(const s in t)t[s].stop()}constructor(...e){super(...e),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=A1,this._slots={},this._playingBeforeDisable={}}};Np.EVENT_PLAY="play",Np.EVENT_PAUSE="pause",Np.EVENT_RESUME="resume",Np.EVENT_STOP="stop",Np.EVENT_END="end";let _1=Np;class mte{constructor(){this.enabled=!0}}const E8=["enabled"];class A8 extends ei{constructor(e){super(e),this.id="sound",this.ComponentType=_1,this.DataType=mte,this.schema=E8,this.manager=e.soundManager,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set volume(e){this.manager.volume=e}get volume(){return this.manager.volume}get context(){return Zc()?this.manager.context:null}initializeComponentData(e,t,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.sound,i=s.slots,a={};for(const r in i){const l=i[r];a[r]={name:l.name,volume:l.volume,pitch:l.pitch,loop:l.loop,duration:l.duration,startTime:l.startTime,overlap:l.overlap,autoPlay:l.autoPlay,asset:l.asset}}const n={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:a,volume:s.volume};return this.addComponent(t,n)}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const a=t[s].entity;if(a.enabled){const n=a.sound;if(n.enabled&&n.positional){const r=a.getPosition(),l=n.slots;for(const u in l)l[u].updatePosition(r)}}}}onBeforeRemove(e,t){const s=t.slots;for(const i in s)s[i].overlap||s[i].stop();t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}xt._buildAccessors(_1.prototype,E8);const U3="simple",z3="animated",_d=class _d extends Qe{constructor(e,t){super(),this._evtSetMeshes=null,this._component=e,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){const e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}set frame(e){this._setFrame(e);const t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(e){var t;if(this._sprite&&((t=this._evtSetMeshes)==null||t.off(),this._evtSetMeshes=null,this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._evtSetMeshes=this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let s;!e||!e.atlas?(s=this._component._meshInstance,s&&(s.deleteParameter("texture_emissiveMap"),s.deleteParameter("texture_opacityMap")),this._component._hideModel()):(e.atlas.texture&&(s=this._component._meshInstance,s&&(s.setParameter("texture_emissiveMap",e.atlas.texture),s.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame)}}get sprite(){return this._sprite}set spriteAsset(e){const t=this._component.system.app.assets;let s=e;if(e instanceof Ye&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){const i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){const i=t.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,t.on(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(e){this._component.system.app.assets.off(`add:${e.id}`,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)}_unbindSpriteAsset(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off(`load:${e.data.textureAtlasAsset}`,this._onTextureAtlasLoad,this))}_onSpriteAssetLoad(e){if(!e.resource)this.sprite=null;else if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset,s=this._component.system.app.assets;s.off(`load:${t}`,this._onTextureAtlasLoad,this),s.once(`load:${t}`,this._onTextureAtlasLoad,this)}}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof Ye?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t))}_onSpriteAssetRemove(e){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&this.sprite.renderMode!==tl&&this._component._showFrame(this.frame)}_update(e){if(this.fps===0||!this._playing||this._paused||!this._sprite)return;const t=this.fps<0?-1:1,s=this._time+e*this._component.speed*t,i=this.duration,a=s>i||s<0;this._setTime(s);let n=this.frame;this._sprite?n=Math.floor(this._sprite.frameKeys.length*this._time/i):n=0,n!==this._frame&&this._setFrame(n),a&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(e){this._time=e;const t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t)}_setFrame(e){this._sprite?this._frame=ge.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){if(this._spriteAsset){const e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset))}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){!this._playing||this._paused||(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}};_d.EVENT_PLAY="play",_d.EVENT_PAUSE="pause",_d.EVENT_RESUME="resume",_d.EVENT_STOP="stop",_d.EVENT_END="end",_d.EVENT_LOOP="loop";let c0=_d;const x4="texture_emissiveMap",T4="texture_opacityMap",E4="material_emissive",A4="material_opacity",_te="innerOffset",gte="outerScale",yte="atlasRect",gd=class gd extends xt{constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._type=U3,this._material=e.defaultMaterial,this._color=new xe(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[Ph],this._outerScale=new Ee(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new Ie,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new Ie,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new Jt,this._model=new Lh,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new c0(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(e){this._type!==e&&(this._type=e,this._type===U3?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===z3&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(e){this._currentClip.frame=e}get frame(){return this._currentClip.frame}set spriteAsset(e){this._defaultClip.spriteAsset=e}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(e){this._currentClip.sprite=e}get sprite(){return this._currentClip.sprite}set material(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}get material(){return this._material}set color(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(E4,this._colorUniform))}get color(){return this._color}set opacity(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(A4,e)}get opacity(){return this._color.a}set clips(e){if(!e){for(const t in this._clips)this.removeClip(t);return}for(const t in this._clips){let s=!1;for(const i in e)if(e[i].name===t){s=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t)}for(const t in e)this._clips[e[t].name]||this.addClip(e[t]);this._autoPlayClip&&this._tryAutoPlay(),(!this._currentClip||!this._currentClip.sprite)&&this._hideModel()}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(e){this._speed=e}get speed(){return this._speed}set flipX(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}get flipX(){return this._flipX}set flipY(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}get flipY(){return this._flipY}set width(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,this.sprite&&(this.sprite.renderMode===Ui||this.sprite.renderMode===Bi)&&this._updateTransform())}get width(){return this._width}set height(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,this.sprite&&(this.sprite.renderMode===Ui||this.sprite.renderMode===Bi)&&this._updateTransform())}get height(){return this._height}set batchGroupId(e){var s,i;if(this._batchGroupId===e)return;const t=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&t>=0&&((s=this.system.app.batcher)==null||s.remove(zi.SPRITE,t,this.entity)),this.entity.enabled&&e>=0?(i=this.system.app.batcher)==null||i.insert(zi.SPRITE,e,this.entity):t>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(e){this._autoPlayClip=e instanceof c0?e.name:e,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}get drawOrder(){return this._drawOrder}set layers(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){var i;const e=this.system.app,t=e.scene,s=t.layers;this._evtLayersChanged=t.on("set:layers",this._onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this._onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&((i=e.batcher)==null||i.insert(zi.SPRITE,this._batchGroupId,this.entity))}onDisable(){var i,a,n,r;const e=this.system.app,s=e.scene.layers;(i=this._evtLayersChanged)==null||i.off(),this._evtLayersChanged=null,s&&((a=this._evtLayerAdded)==null||a.off(),this._evtLayerAdded=null,(n=this._evtLayerRemoved)==null||n.off(),this._evtLayerRemoved=null),this.stop(),this._hideModel(),this._batchGroupId>=0&&((r=e.batcher)==null||r.remove(zi.SPRITE,this._batchGroupId,this.entity))}onDestroy(){var e;this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const t in this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,(e=this._node)==null||e.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel||!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.addMeshInstances(e)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.removeMeshInstances(e)}this._addedModel=!1}_showFrame(e){if(!this.sprite)return;const t=this.sprite.meshes[e];if(!t){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1);return}let s;if(this.sprite.renderMode===Bi?s=this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===Ui?s=this.system.default9SlicedMaterialTiledMode:s=this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new ps(t,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(E4,this._colorUniform),this._meshInstance.setParameter(A4,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(x4,this.sprite.atlas.texture),this._meshInstance.setParameter(T4,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(x4),this._meshInstance.deleteParameter(T4)),this.sprite.atlas&&(this.sprite.renderMode===Bi||this.sprite.renderMode===Ui)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;const i=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(i){const a=2/i.rect.z,n=2/i.rect.w;this._innerOffset.set(i.border.x*a,i.border.y*n,i.border.z*a,i.border.w*n);const r=this.sprite.atlas.texture;this._atlasRect.set(i.rect.x/r.width,i.rect.y/r.height,i.rect.z/r.width,i.rect.w/r.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter(_te,this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter(yte,this._atlasRectUniform)}else this._meshInstance._updateAabbFunc=null;this._updateTransform()}_updateTransform(){let e=this.flipX?-1:1,t=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(this.sprite.renderMode===Bi||this.sprite.renderMode===Ui)){let a=1,n=1;if(this.sprite.atlas){const u=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];u&&(a=u.rect.z,n=u.rect.w,s=(.5-u.pivot.x)*this._width,i=(.5-u.pivot.y)*this._height)}const r=a/this.sprite.pixelsPerUnit,l=n/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*r),Math.max(this._height,this._innerOffset.y*l)),e*=r,t*=l,this._outerScale.x/=r,this._outerScale.y/=l,e*=ge.clamp(this._width/(this._innerOffset.x*r),1e-4,1),t*=ge.clamp(this._height/(this._innerOffset.y*l),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter(gte,this._outerScaleUniform))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(s,i,0)}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e}_tryAutoPlay(){if(!this._autoPlayClip||this.type!==z3)return;const e=this._clips[this._autoPlayClip];e&&!e.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(e.name)}_onLayersChanged(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(e){this.layers.indexOf(e.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])}_onLayerRemoved(e){!this._meshInstance||this.layers.indexOf(e.id)<0||e.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance])}}addClip(e){const t=new c0(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t}removeClip(e){delete this._clips[e]}clip(e){return this._clips[e]}play(e){const t=this._clips[e],s=this._currentClip;return s&&s!==t&&(s._playing=!1),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}};gd.EVENT_PLAY="play",gd.EVENT_PAUSE="pause",gd.EVENT_RESUME="resume",gd.EVENT_STOP="stop",gd.EVENT_END="end",gd.EVENT_LOOP="loop";let g1=gd;class vte{constructor(){this.enabled=!0}}const C8=["enabled"];class w8 extends ei{constructor(e){super(e),this.id="sprite",this.ComponentType=g1,this.DataType=vte,this.schema=C8,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set defaultMaterial(e){this._defaultMaterial=e}get defaultMaterial(){if(!this._defaultMaterial){const e=new Ge(this.app.graphicsDevice,{width:1,height:1,format:ki,name:"sprite"}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.unlock();const s=new Vi;s.diffuse.set(0,0,0),s.emissive.set(1,1,1),s.emissiveMap=e,s.opacityMap=e,s.opacityMapChannel="a",s.useLighting=!1,s.useTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=Wd,s.depthWrite=!1,s.pixelSnap=!1,s.cull=Xs,s.update(),this._defaultTexture=e,this._defaultMaterial=s}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(e){this._default9SlicedMaterialSlicedMode=e}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){const e=this.defaultMaterial.clone();e.nineSlicedMode=Bi,e.update(),this._default9SlicedMaterialSlicedMode=e}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(e){this._default9SlicedMaterialTiledMode=e}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){const e=this.defaultMaterial.clone();e.nineSlicedMode=Ui,e.update(),this._default9SlicedMaterialTiledMode=e}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(e,t,s){if(t.enabled!==void 0&&(e.enabled=t.enabled),e.type=t.type,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),t.drawOrder!==void 0&&(e.drawOrder=t.drawOrder),t.color!==void 0&&(t.color instanceof xe?e.color.set(t.color.r,t.color.g,t.color.b,t.opacity??1):e.color.set(t.color[0],t.color[1],t.color[2],t.opacity??1),e.color=e.color),t.opacity!==void 0&&(e.opacity=t.opacity),t.flipX!==void 0&&(e.flipX=t.flipX),t.flipY!==void 0&&(e.flipY=t.flipY),t.width!==void 0&&(e.width=t.width),t.height!==void 0&&(e.height=t.height),t.spriteAsset!==void 0&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),t.frame!==void 0&&(e.frame=t.frame),t.clips)for(const i in t.clips)e.addClip(t.clips[i]);t.speed!==void 0&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=t.batchGroupId===void 0||t.batchGroupId===null?-1:t.batchGroupId,super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.sprite;return this.addComponent(t,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,width:s.width,height:s.height,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];if(i.data.enabled&&i.entity.enabled){const a=i.entity.sprite;a._currentClip&&a._currentClip._update(e)}}}onBeforeRemove(e,t){t.onDestroy()}}xt._buildAccessors(g1.prototype,C8);const Yg=class Yg extends xt{constructor(e,t){super(e,t),this._oldState=!0,this._size=new H,this.on("set_enabled",this._onSetEnabled,this)}set size(e){e instanceof H?this._size.copy(e):e instanceof Array&&e.length>=3&&this.size.set(e[0],e[1],e[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(e,t,s){this._checkState()}_checkState(){const e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}};Yg.EVENT_ENABLE="enable",Yg.EVENT_DISABLE="disable",Yg.EVENT_STATE="state",Yg.EVENT_REMOVE="remove";let y1=Yg;class Ste{constructor(){this.enabled=!0}}const R8=["enabled"];class M8 extends ei{constructor(e){super(e),this.id="zone",this.ComponentType=y1,this.DataType=Ste,this.schema=R8,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(e,t,s){e.enabled=t.hasOwnProperty("enabled")?!!t.enabled:!0,t.size&&(t.size instanceof H?e.size.copy(t.size):t.size instanceof Array&&t.size.length>=3&&e.size.set(t.size[0],t.size[1],t.size[2]))}cloneComponent(e,t){const s={enabled:e.zone.enabled,size:e.zone.size};return this.addComponent(t,s)}_onBeforeRemove(e,t){t._onBeforeRemove()}}xt._buildAccessors(y1.prototype,R8);class bte{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}}class D8{constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(e,t){const s=this.camera.rect,i=this.destinationRenderTarget,a=this.app.graphicsDevice,n=Math.floor(s.z*((i==null?void 0:i.width)??a.width)),r=Math.floor(s.w*((i==null?void 0:i.height)??a.height));return new Ge(a,{name:t,format:e,width:n,height:r,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe})}_createOffscreenTarget(e,t){const s=this.app.graphicsDevice,a=(this.destinationRenderTarget??s.backBuffer).isColorBufferSrgb(0),n=(t&&s.getRenderableHdrFormat([Js,Ri],!0))??(a?ki:Lt),r=`${this.camera.entity.name}-posteffect-${this.effects.length}`,l=this._allocateColorBuffer(n,r);return new fs({colorBuffer:l,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?s.samples:1})}_resizeOffscreenTarget(e){const t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s),e._colorBuffers=[e._colorBuffer]}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){const t=this.effects,s=t.length===0,i=this._createOffscreenTarget(s,e.hdr),a=new bte(e,i);t.push(a),this._sourceTarget=a.inputTarget,t.length>1&&(t[t.length-2].outputTarget=a.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){let t=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),this.effects.length===0&&this.disable()}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){const s=this.effects[e].effect;this._newPostEffect!==s&&s.needsDepthBuffer&&this._requestDepthMap()}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}_requestDepthMap(){const e=this.app.scene.layers.getLayerById(yn);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const e=this.app.scene.layers.getLayerById(yn);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null;const t=this.effects.length;if(t)for(let s=0;s<t;s++){const i=this.effects[s];let a=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(a=this.destinationRenderTarget)),i.effect.render(i.inputTarget,a,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){const s=this.camera.rect,i=this.destinationRenderTarget;e=(i==null?void 0:i.width)??e,t=(i==null?void 0:i.height)??t,this.camera.camera.aspectRatio=e*s.z/(t*s.w),this.resizeRenderTargets()}resizeRenderTargets(){const e=this.app.graphicsDevice,t=this.destinationRenderTarget,s=(t==null?void 0:t.width)??e.width,i=(t==null?void 0:t.height)??e.height,a=this.camera.rect,n=Math.floor(a.z*s),r=Math.floor(a.w*i),l=this.effects;for(let u=0,f=l.length;u<f;u++){const _=l[u];(_.inputTarget.width!==n||_.inputTarget.height!==r)&&this._resizeOffscreenTarget(_.inputTarget)}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets()}}class tu extends xt{constructor(e,t){super(e,t),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=ty,this._camera=new hy,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=t,this._postEffects=new D8(e.app,this)}setShaderPass(e){const t=cl.get(this.system.app.graphicsDevice),s=e?t.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){var e;return(e=this._camera.shaderPassInfo)==null?void 0:e.name}set renderPasses(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=!0}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(e){this.camera.shaderParams.gammaCorrection=e}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(e){this.camera.shaderParams.toneMapping=e}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(e){this._camera.fogParams=e}get fog(){return this._camera.fogParams}set aperture(e){this._camera.aperture=e}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e}get horizontalFov(){return this._camera.horizontalFov}set layers(e){const t=this._camera.layers,s=this.system.app.scene;t.forEach(i=>{const a=s.layers.getLayerById(i);a==null||a.removeCamera(this)}),this._camera.layers=e,this.enabled&&this.entity.enabled&&e.forEach(i=>{const a=s.layers.getLayerById(i);a==null||a.addCamera(this)})}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(e){this._camera.projection=e}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find(s=>s===yn)){const s=this.system.app.scene.layers.getLayerById(yn);e?s==null||s.incrementCounter():s==null||s.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty()}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty()}dirtyLayerCompositionCameras(){const e=this.system.app.scene.layers;e._dirty=!0}screenToWorld(e,t,s,i){const a=this.system.app.graphicsDevice,{width:n,height:r}=a.clientRect;return this._camera.screenToWorld(e,t,s,n,r,i)}worldToScreen(e,t){const s=this.system.app.graphicsDevice,{width:i,height:a}=s.clientRect;return this._camera.worldToScreen(e,i,a,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}removeCameraFromLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){var s,i,a;const e=this.system.app.scene,t=e.layers;this.system.addCamera(this),(s=this._evtLayersChanged)==null||s.off(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&((i=this._evtLayerAdded)==null||i.off(),this._evtLayerAdded=t.on("add",this.onLayerAdded,this),(a=this._evtLayerRemoved)==null||a.off(),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){var s,i,a;const t=this.system.app.scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),(s=this._evtLayersChanged)==null||s.off(),this._evtLayersChanged=null,t&&((i=this._evtLayerAdded)==null||i.off(),this._evtLayerAdded=null,(a=this._evtLayerRemoved)==null||a.off(),this._evtLayerRemoved=null),this.system.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(e){const t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){this.aspectRatioMode===zC&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,s){this.system.app.xr.start(this,e,t,s)}endXr(e){if(!this._camera.xr){e&&e(new Error("Camera is not in XR"));return}this._camera.xr.end(e)}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter}}class xte{constructor(){this.enabled=!0}}const P8=["enabled"];class L8 extends ei{constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=tu,this.DataType=xte,this.schema=P8,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this)}initializeComponentData(e,t,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(let i=0;i<s.length;i++){const a=s[i];if(t.hasOwnProperty(a)){const n=t[a];switch(a){case"rect":case"scissorRect":Array.isArray(n)?e[a]=new Ie(n[0],n[1],n[2],n[3]):e[a]=n;break;case"clearColor":Array.isArray(n)?e[a]=new xe(n[0],n[1],n[2],n[3]):e[a]=n;break;default:e[a]=n;break}}}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.camera;return this.addComponent(t,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter,gammaCorrection:s.gammaCorrection,toneMapping:s.toneMapping})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove()}onAppPrerender(){for(let e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()}addCamera(e){this.cameras.push(e),n1(this.cameras)}removeCamera(e){const t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),n1(this.cameras))}destroy(){this.app.off("prerender",this.onAppPrerender,this),super.destroy()}}xt._buildAccessors(tu.prototype,P8);class I8{constructor(){this.enabled=!0,this.type="directional",this.color=new xe(1,1,1),this.intensity=1,this.luminance=0,this.shape=ao,this.affectSpecularity=!0,this.castShadows=!1,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=AC,this.shadowType=Un,this.vsmBlurSize=11,this.vsmBlurMode=MC,this.vsmBias=.01*.25,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=!0,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=UC,this.mask=1,this.affectDynamic=!0,this.affectLightmapped=!1,this.bake=!1,this.bakeDir=!0,this.isStatic=!1,this.layers=[Ph],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16}}const xb=Object.keys(new I8);class O8 extends xt{get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e,function(t,s){this.onSetEnabled(null,s,t)})}get enabled(){return this.data.enabled}set light(e){this._setValue("light",e)}get light(){return this.data.light}set type(e){this._setValue("type",e,function(t,s){this.system.changeType(this,s,t),this.refreshProperties()})}get type(){return this.data.type}set color(e){this._setValue("color",e,function(t,s){this.light.setColor(t)},!0)}get color(){return this.data.color}set intensity(e){this._setValue("intensity",e,function(t,s){this.light.intensity=t})}get intensity(){return this.data.intensity}set luminance(e){this._setValue("luminance",e,function(t,s){this.light.luminance=t})}get luminance(){return this.data.luminance}set shape(e){this._setValue("shape",e,function(t,s){this.light.shape=t})}get shape(){return this.data.shape}set affectSpecularity(e){this._setValue("affectSpecularity",e,function(t,s){this.light.affectSpecularity=t})}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(e){this._setValue("castShadows",e,function(t,s){this.light.castShadows=t})}get castShadows(){return this.data.castShadows}set shadowDistance(e){this._setValue("shadowDistance",e,function(t,s){this.light.shadowDistance=t})}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(e){this._setValue("shadowIntensity",e,function(t,s){this.light.shadowIntensity=t})}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(e){this._setValue("shadowResolution",e,function(t,s){this.light.shadowResolution=t})}get shadowResolution(){return this.data.shadowResolution}set shadowBias(e){this._setValue("shadowBias",e,function(t,s){this.light.shadowBias=-.01*ge.clamp(t,0,1)})}get shadowBias(){return this.data.shadowBias}set numCascades(e){this._setValue("numCascades",e,function(t,s){this.light.numCascades=ge.clamp(Math.floor(t),1,4)})}get numCascades(){return this.data.numCascades}set cascadeBlend(e){this._setValue("cascadeBlend",e,function(t,s){this.light.cascadeBlend=ge.clamp(t,0,1)})}get cascadeBlend(){return this.data.cascadeBlend}set bakeNumSamples(e){this._setValue("bakeNumSamples",e,function(t,s){this.light.bakeNumSamples=ge.clamp(Math.floor(t),1,255)})}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(e){this._setValue("bakeArea",e,function(t,s){this.light.bakeArea=ge.clamp(t,0,180)})}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(e){this._setValue("cascadeDistribution",e,function(t,s){this.light.cascadeDistribution=ge.clamp(t,0,1)})}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(e){this._setValue("normalOffsetBias",e,function(t,s){this.light.normalOffsetBias=ge.clamp(t,0,1)})}get normalOffsetBias(){return this.data.normalOffsetBias}set range(e){this._setValue("range",e,function(t,s){this.light.attenuationEnd=t})}get range(){return this.data.range}set innerConeAngle(e){this._setValue("innerConeAngle",e,function(t,s){this.light.innerConeAngle=t})}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(e){this._setValue("outerConeAngle",e,function(t,s){this.light.outerConeAngle=t})}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(e){this._setValue("falloffMode",e,function(t,s){this.light.falloffMode=t})}get falloffMode(){return this.data.falloffMode}set shadowType(e){this._setValue("shadowType",e,function(t,s){this.light.shadowType=t})}get shadowType(){return this.data.shadowType}set vsmBlurSize(e){this._setValue("vsmBlurSize",e,function(t,s){this.light.vsmBlurSize=t})}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(e){this._setValue("vsmBlurMode",e,function(t,s){this.light.vsmBlurMode=t})}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(e){this._setValue("vsmBias",e,function(t,s){this.light.vsmBias=ge.clamp(t,0,1)})}get vsmBias(){return this.data.vsmBias}set cookieAsset(e){this._setValue("cookieAsset",e,function(t,s){if(!(this._cookieAssetId&&(t instanceof Ye&&t.id===this._cookieAssetId||t===this._cookieAssetId))){if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof Ye)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if(typeof t=="number"){this._cookieAssetId=t;const i=this.system.app.assets.get(t);i?this.onCookieAssetAdd(i):(this._cookieAssetAdd=!0,this.system.app.assets.on(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this))}}})}get cookieAsset(){return this.data.cookieAsset}set cookie(e){this._setValue("cookie",e,function(t,s){this.light.cookie=t})}get cookie(){return this.data.cookie}set cookieIntensity(e){this._setValue("cookieIntensity",e,function(t,s){this.light.cookieIntensity=ge.clamp(t,0,1)})}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(e){this._setValue("cookieFalloff",e,function(t,s){this.light.cookieFalloff=t})}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(e){this._setValue("cookieChannel",e,function(t,s){this.light.cookieChannel=t})}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(e){this._setValue("cookieAngle",e,function(t,s){if(t!==0||this.cookieScale!==null){this._cookieMatrix||(this._cookieMatrix=new Ie);let i=1,a=1;this.cookieScale&&(i=this.cookieScale.x,a=this.cookieScale.y);const n=Math.cos(t*ge.DEG_TO_RAD),r=Math.sin(t*ge.DEG_TO_RAD);this._cookieMatrix.set(n/i,-r/i,r/a,n/a),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})}get cookieAngle(){return this.data.cookieAngle}set cookieScale(e){this._setValue("cookieScale",e,function(t,s){if(t!==null||this.cookieAngle!==0){this._cookieMatrix||(this._cookieMatrix=new Ie);const i=t.x,a=t.y,n=Math.cos(this.cookieAngle*ge.DEG_TO_RAD),r=Math.sin(this.cookieAngle*ge.DEG_TO_RAD);this._cookieMatrix.set(n/i,-r/i,r/a,n/a),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0)}get cookieScale(){return this.data.cookieScale}set cookieOffset(e){this._setValue("cookieOffset",e,function(t,s){this.light.cookieOffset=t},!0)}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(e){this._setValue("shadowUpdateMode",e,function(t,s){this.light.shadowUpdateMode=t},!0)}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(e){this._setValue("mask",e,function(t,s){this.light.mask=t})}get mask(){return this.data.mask}set affectDynamic(e){this._setValue("affectDynamic",e,function(t,s){t?this.light.mask|=uo:this.light.mask&=-2,this.light.layersDirty()})}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(e){this._setValue("affectLightmapped",e,function(t,s){t?(this.light.mask|=Xd,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=Pd))})}get affectLightmapped(){return this.data.affectLightmapped}set bake(e){this._setValue("bake",e,function(t,s){t?(this.light.mask|=Pd,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=Xd)),this.light.layersDirty()})}get bake(){return this.data.bake}set bakeDir(e){this._setValue("bakeDir",e,function(t,s){this.light.bakeDir=t})}get bakeDir(){return this.data.bakeDir}set isStatic(e){this._setValue("isStatic",e,function(t,s){this.light.isStatic=t})}get isStatic(){return this.data.isStatic}set layers(e){this._setValue("layers",e,function(t,s){for(let i=0;i<s.length;i++){const a=this.system.app.scene.layers.getLayerById(s[i]);a&&(a.removeLight(this),this.light.removeLayer(a))}for(let i=0;i<t.length;i++){const a=this.system.app.scene.layers.getLayerById(t[i]);a&&this.enabled&&this.entity.enabled&&(a.addLight(this),this.light.addLayer(a))}})}get layers(){return this.data.layers}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set shadowSamples(e){this.light.shadowSamples=e}get shadowSamples(){return this.light.shadowSamples}set shadowBlockerSamples(e){this.light.shadowBlockerSamples=e}get shadowBlockerSamples(){return this.light.shadowBlockerSamples}set penumbraSize(e){this.light.penumbraSize=e}get penumbraSize(){return this.light.penumbraSize}set penumbraFalloff(e){this.light.penumbraFalloff=e}get penumbraFalloff(){return this.light.penumbraFalloff}_setValue(e,t,s,i){const a=this.data,n=a[e];!i&&n===t||(a[e]=t,s&&s.call(this,t,n))}addLightToLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t))}}removeLightFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t))}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e))}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e))}refreshProperties(){for(let e=0;e<xb.length;e++){const t=xb[e];this[t]=this[t]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let e=!1;this._cookieAsset.type==="cubemap"&&!this._cookieAsset.loadFaces&&(this._cookieAsset.loadFaces=!0,e=!0),(!this._cookieAsset.resource||e)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){!this._cookieAsset||!this._cookieAsset.resource||(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){const e=this.system.app.scene,t=e.layers;this.light.enabled=!0,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){var s,i,a;const t=this.system.app.scene.layers;this.light.enabled=!1,(s=this._evtLayersChanged)==null||s.off(),this._evtLayersChanged=null,t&&((i=this._evtLayerAdded)==null||i.off(),this._evtLayerAdded=null,(a=this._evtLayerRemoved)==null||a.off(),this._evtLayerRemoved=null),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}constructor(...e){super(...e),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}}class N8 extends ei{constructor(e){super(e),this.id="light",this.ComponentType=O8,this.DataType=I8,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t){const s={...t};s.type||(s.type=e.data.type),e.data.type=s.type,s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&Array.isArray(s.color)&&(s.color=new xe(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new Ee(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new Ee(s.cookieScale[0],s.cookieScale[1])),s.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),s.enabled=s.enable),s.shape||(s.shape=ao);const i=new R0(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);i.type=n3[s.type],i._node=e.entity,e.data.light=i,super.initializeComponentData(e,s,xb)}_onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.light,i=[];let a;for(let n=0;n<xb.length;n++)a=xb[n],a!=="light"&&(s[a]&&s[a].clone?i[a]=s[a].clone():i[a]=s[a]);return this.addComponent(t,i)}changeType(e,t,s){t!==s&&(e.light.type=n3[s])}}const Tte=["x","y","z","w"],Ete=[void 0,void 0,Ee,H,Ie];function L0(h,e,t,s){switch(e.type){case"boolean":return!!t;case"number":if(typeof t=="number")return t;if(typeof t=="string"){const i=parseInt(t,10);return isNaN(i)?null:i}else if(typeof t=="boolean")return 0+t;return null;case"json":{const i={};if(Array.isArray(e.schema)){(!t||typeof t!="object")&&(t={});for(let a=0;a<e.schema.length;a++){const n=e.schema[a];if(n.name)if(n.array){i[n.name]=[];const r=Array.isArray(t[n.name])?t[n.name]:[];for(let l=0;l<r.length;l++)i[n.name].push(L0(h,n,r[l]))}else{const r=t.hasOwnProperty(n.name)?t[n.name]:n.default;i[n.name]=L0(h,n,r)}}}return i}case"asset":return t instanceof Ye?t:typeof t=="number"?h.assets.get(t)||null:typeof t=="string"&&h.assets.get(parseInt(t,10))||null;case"entity":return t instanceof Jt?t:typeof t=="string"?h.getEntityFromIndex(t):null;case"rgb":case"rgba":if(t instanceof xe)return s instanceof xe?(s.copy(t),s):t.clone();if(t instanceof Array&&t.length>=3&&t.length<=4){for(let i=0;i<t.length;i++)if(typeof t[i]!="number")return null;return s||(s=new xe),s.r=t[0],s.g=t[1],s.b=t[2],s.a=t.length===3?1:t[3],s}else if(typeof t=="string"&&/#(?:[0-9a-f]{2}){3,4}/i.test(t))return s||(s=new xe),s.fromString(t),s;return null;case"vec2":case"vec3":case"vec4":{const i=parseInt(e.type.slice(3),10),a=Ete[i];if(t instanceof a)return s instanceof a?(s.copy(t),s):t.clone();if(t instanceof Array&&t.length===i){for(let n=0;n<t.length;n++)if(typeof t[n]!="number")return null;s||(s=new a);for(let n=0;n<i;n++)s[Tte[n]]=t[n];return s}return null}case"curve":if(t){let i;if(t instanceof so||t instanceof Ad)i=t.clone();else{const a=t.keys[0]instanceof Array?Ad:so;i=new a(t.keys),i.type=t.type}return i}break}return t}function F8(h,e,t,s){return e.array?t.map((i,a)=>L0(h,e,i,s?s[a]:null)):L0(h,e,t,s)}function B8(h,e,t,s){if(t)for(const i in e){const a=e[i],n=t[i];n!==void 0&&(s[i]=F8(h,a,n,s[i]))}}const Kg=class Kg{constructor(e){this.scriptType=e,this.index={}}add(e,t){this.index[e]||Kg.reservedNames.has(e)||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(s){const i="attr",a=`attr:${e}`,n=this.__attributes[e];let r=n;if(n&&t.type!=="json"&&t.type!=="entity"&&n.clone&&(this.hasEvent(i)||this.hasEvent(a))&&(r=n.clone()),t.array){if(this.__attributes[e]=[],s)for(let l=0,u=s.length;l<u;l++)this.__attributes[e].push(L0(this.app,t,s[l],n?n[l]:null))}else this.__attributes[e]=L0(this.app,t,s,n);this.fire(i,e,this.__attributes[e],r),this.fire(a,this.__attributes[e],r)}}))}remove(e){return this.index[e]?(delete this.index[e],delete this.scriptType.prototype[e],!0):!1}has(e){return!!this.index[e]}get(e){return this.index[e]||null}};Kg.assignAttributesToScript=B8,Kg.attributeToValue=F8,Kg.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);let gm=Kg;const k3="initialize",V3="postInitialize",Ate="update",Cte="postUpdate",wte="swap",fh=class fh extends Qe{constructor(e){super(),this.initScript(e)}set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,k3)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,V3)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScript(e){const t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled=typeof e.enabled=="boolean"?e.enabled:!0,this._enabledOld=this.enabled,this.__destroyed=!1,this.__scriptType=t,this.__executionOrder=-1}static get scriptName(){return this.__name}};fh.EVENT_ENABLE="enable",fh.EVENT_DISABLE="disable",fh.EVENT_STATE="state",fh.EVENT_DESTROY="destroy",fh.EVENT_ATTR="attr",fh.EVENT_ERROR="error",fh.__name=null,fh.__getScriptName=U8;let Rh=fh;const Rte=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function U8(h){if(typeof h!="function")return;if("name"in Function.prototype)return h.name;if(h===Function||h===Function.prototype.constructor)return"Function";const e=`${h}`.match(Rte);return e?e[1]:void 0}class Ld extends Rh{constructor(e){super(e),this.initScriptType(e)}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new gm(this)),this.__attributes}initScript(e){Rh.prototype.initScript.call(this,e),this.__attributes={},this.__attributesRaw=e.attributes||{}}initScriptType(e){this.initScript(e)}__initializeAttributes(e){if(!(!e&&!this.__attributesRaw)){for(const t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(e){for(const t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])}}const Mte=h=>h[0].toLowerCase()+h.substring(1),ph=class ph extends xt{constructor(e,t){super(e,t),this._attributeDataMap=new Map,this._scripts=[],this._updateList=new Lb({sortBy:"__executionOrder"}),this._postUpdateList=new Lb({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(e){this._scriptsData=e;for(const t in e){if(!e.hasOwnProperty(t))continue;const s=this._scriptsIndex[t];if(s){if(typeof e[t].enabled=="boolean"&&(s.once("preInitialize",()=>{this.initializeAttributes(s)}),s.enabled=!!e[t].enabled),typeof e[t].attributes=="object"){for(const i in e[t].attributes)if(!gm.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const a=this.system.app.scripts.get(t);a&&a.attributes.add(i,{})}s[i]=e[t].attributes[i]}}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(e){const t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const e=this._beginLooping();for(let t=0,s=this.scripts.length;t<s;t++){const i=this.scripts[t];i._initialized&&!i._postInitialized&&i.enabled&&(i._postInitialized=!0,i.postInitialize&&this._scriptMethod(i,V3))}this._endLooping(e)}_beginLooping(){const e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(e,t,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const t=this._beginLooping();for(let s=0,i=this.scripts.length;s<i;s++){const a=this.scripts[s];a.once("preInitialize",()=>{this.initializeAttributes(a)}),a.enabled=a._enabled}this._endLooping(t)}_onBeforeRemove(){this.fire("remove");const e=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const s=this.scripts[t];s&&this.destroy(s.__scriptType.__name)}this._endLooping(e)}_removeDestroyedScripts(){const e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){const s=this._destroyedScripts[t];this._removeScriptInstance(s)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++){const s=this.scripts[e];this.initializeAttributes(s)}}initializeAttributes(e){var t;if(e instanceof Ld)e.__initializeAttributes();else{const s=e.__scriptType.__name,i=this._attributeDataMap.get(s);if(!i)return;const a=(t=this.system.app.scripts)==null?void 0:t.getSchema(s);B8(this.system.app,a.attributes,i,e)}}_scriptMethod(e,t,s){e[t](s)}_onInitialize(){const e=this._scripts,t=this._beginLooping();for(let s=0,i=e.length;s<i;s++){const a=e[s];!a._initialized&&a.enabled&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,k3))}this._endLooping(t)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(e){const t=this._updateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,Ate,e)}this._endLooping(s)}_onPostUpdate(e){const t=this._postUpdateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,Cte,e)}this._endLooping(s)}_insertScriptInstance(e,t,s){t===-1?(this._scripts.push(e),e.__executionOrder=s,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,s+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))}_removeScriptInstance(e){const t=this._scripts.indexOf(e);return t===-1||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let s=e;s<t;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(e,t,s,i,a,n){if(e.array){const r=s.length;if(!r)return;const l=s.slice();for(let u=0;u<r;u++){const f=l[u]instanceof Kt?l[u].getGuid():l[u];n[f]&&(l[u]=i?n[f].getGuid():n[f])}a[t]=l}else{if(s instanceof Kt)s=s.getGuid();else if(typeof s!="string")return;n[s]&&(a[t]=n[s])}}has(e){if(typeof e=="string")return!!this._scriptsIndex[e];if(!e)return!1;const t=e,s=t.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof t}get(e){if(typeof e=="string"){const n=this._scriptsIndex[e];return n?n.instance:null}if(!e)return null;const t=e,s=t.__name,i=this._scriptsIndex[s],a=i&&i.instance;return a instanceof t?a:null}create(e,t={}){const s=this;let i=e,a=e;if(typeof i=="string"?i=this.system.app.scripts.get(i):i&&(a=i.__name??(i.__name=Mte(U8(i)))),i){if(!this._scriptsIndex[a]||!this._scriptsIndex[a].instance){const n=new i({app:this.system.app,entity:this.entity,enabled:t.hasOwnProperty("enabled")?t.enabled:!0,attributes:t.attributes||{}});t.properties&&typeof t.properties=="object"&&Object.assign(n,t.properties),n instanceof Ld||this._attributeDataMap.set(a,t.attributes);const r=this._scripts.length;let l=-1;return typeof t.ind=="number"&&t.ind!==-1&&r>t.ind&&(l=t.ind),this._insertScriptInstance(n,l,r),this._scriptsIndex[a]={instance:n,onSwap:function(){s.swap(a)}},this[a]=n,t.preloading||this.initializeAttributes(n),this.fire("create",a,n),this.fire(`create:${a}`,n),this.system.app.scripts.on(`swap:${a}`,this._scriptsIndex[a].onSwap),t.preloading||(n.enabled&&!n._initialized&&(n._initialized=!0,n.initialize&&this._scriptMethod(n,k3)),n.enabled&&!n._postInitialized&&(n._postInitialized=!0,n.postInitialize&&this._scriptMethod(n,V3))),n}}else this._scriptsIndex[a]={awaiting:!0,ind:this._scripts.length};return null}destroy(e){let t=e,s=e;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return!1;this._attributeDataMap.delete(t);const a=i.instance;if(a&&!a._destroyed)if(a.enabled=!1,a._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(a);else{const n=this._removeScriptInstance(a);n>=0&&this._resetExecutionOrder(n,this._scripts.length)}return this.system.app.scripts.off(`swap:${t}`,i.onSwap),delete this[t],this.fire("destroy",t,a||null),this.fire(`destroy:${t}`,a||null),a&&a.fire("destroy"),!0}swap(e){let t=e,s=e;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(!i||!i.instance)return!1;const a=i.instance,n=this._scripts.indexOf(a),r=new s({app:this.system.app,entity:this.entity,enabled:a.enabled,attributes:a.__attributes});return r.swap?(this.initializeAttributes(r),this._scripts[n]=r,this._scriptsIndex[t].instance=r,this[t]=r,r.__executionOrder=n,a.update&&this._updateList.remove(a),a.postUpdate&&this._postUpdateList.remove(a),r.update&&this._updateList.insert(r),r.postUpdate&&this._postUpdateList.insert(r),this._scriptMethod(r,wte,a),this.fire("swap",t,r),this.fire(`swap:${t}`,r),!0):!1}resolveDuplicatedEntityReferenceProperties(e,t){const s=this.entity.script;for(const i in e._scriptsIndex){const a=this.system.app.scripts.get(i);if(!a)continue;const n=e._scriptsIndex[i];if(!n||!n.instance)continue;const r=s[i].__attributesRaw,l=s[i].__attributes;if(!r&&!l)continue;const u=!!r,f=n.instance.__attributes;for(const _ in f){if(!f[_])continue;const g=a.attributes.get(_);if(g){if(g.type==="entity")this._resolveEntityScriptAttribute(g,_,f[_],u,r||l,t);else if(g.type==="json"&&Array.isArray(g.schema)){const y=f[_],v=r?r[_]:l[_];for(let x=0;x<g.schema.length;x++){const C=g.schema[x];if(C.type==="entity")if(g.array)for(let M=0;M<y.length;M++)this._resolveEntityScriptAttribute(C,C.name,y[M][C.name],u,v[M],t);else this._resolveEntityScriptAttribute(C,C.name,y[C.name],u,v,t)}}}}}}move(e,t){const s=this._scripts.length;if(t>=s||t<0)return!1;let i=e,a=e;typeof a!="string"?a=e.__name:i=null;const n=this._scriptsIndex[a];if(!n||!n.instance)return!1;const r=n.instance;if(i&&!(r instanceof i))return!1;const l=this._scripts.indexOf(r);return l===-1||l===t?!1:(this._scripts.splice(t,0,this._scripts.splice(l,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",a,r,t,l),this.fire(`move:${a}`,r,t,l),!0)}};ph.EVENT_CREATE="create",ph.EVENT_DESTROY="destroy",ph.EVENT_ENABLE="enable",ph.EVENT_DISABLE="disable",ph.EVENT_REMOVE="remove",ph.EVENT_STATE="state",ph.EVENT_MOVE="move",ph.EVENT_ERROR="error";let o2=ph;class Dte{constructor(){this.enabled=!0}}const Pte="_onInitializeAttributes",Lte="_onInitialize",Ite="_onPostInitialize",Ote="_onUpdate",Nte="_onPostUpdate";let zE=0;class z8 extends ei{constructor(e){super(e),this.id="script",this.ComponentType=o2,this.DataType=Dte,this._components=new Lb({sortBy:"_executionOrder"}),this._enabledComponents=new Lb({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t){if(e._executionOrder=zE++,this._components.append(e),zE>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=t.hasOwnProperty("enabled")?!!t.enabled:!0,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(let s=0;s<t.order.length;s++)e.create(t.order[s],{enabled:t.scripts[t.order[s]].enabled,attributes:t.scripts[t.order[s]].attributes,preloading:this.preloading})}}cloneComponent(e,t){var n;const s=[],i={};for(let r=0;r<e.script._scripts.length;r++){const l=e.script._scripts[r],u=l.__scriptType.__name;s.push(u);const f=((n=e.script._attributeDataMap)==null?void 0:n.get(u))||{};for(const _ in l.__attributes)f[_]=l.__attributes[_];i[u]={enabled:l._enabled,attributes:f}}for(const r in e.script._scriptsIndex)r.awaiting&&s.splice(r.ind,0,r);const a={enabled:e.script.enabled,order:s,scripts:i};return this.addComponent(t,a)}_resetExecutionOrder(){zE=0;for(let e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=zE++}_callComponentMethod(e,t,s){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,Pte),this._callComponentMethod(this._enabledComponents,Lte)}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,Ite)}_onUpdate(e){this._callComponentMethod(this._enabledComponents,Ote,e)}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,Nte,e)}_addComponentToEnabled(e){this._enabledComponents.insert(e)}_removeComponentFromEnabled(e){this._enabledComponents.remove(e)}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class rL extends xt{constructor(e,t){super(e,t),this._layers=[Ph],this._instance=null,this._customAabb=null,this._materialOptions=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._castShadows=!1,this._assetReference=new P0("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set customAabb(e){var t,s;this._customAabb=e,(s=(t=this._instance)==null?void 0:t.meshInstance)==null||s.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(e){var t;if(this.destroyInstance(),this._instance=e,(t=this._instance)!=null&&t.meshInstance){const s=this._instance.meshInstance;s.node||(s.node=this.entity),s.castShadow=this._castShadows,s.setCustomAabb(this._customAabb),this._materialOptions&&this._instance.createMaterial(this._materialOptions),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set materialOptions(e){this._materialOptions=Object.assign({},e),this._instance&&this._instance.createMaterial(this._materialOptions)}get materialOptions(){return this._materialOptions}get material(){var e;return(e=this._instance)==null?void 0:e.material}set castShadows(e){var t;if(this._castShadows!==e){const s=(t=this.instance)==null?void 0:t.meshInstance;if(s){const i=this.layers,a=this.system.app.scene;if(this._castShadows&&!e)for(let n=0;n<i.length;n++){const r=a.layers.getLayerById(this.layers[n]);r&&r.removeShadowCasters([s])}if(s.castShadow=e,!this._castShadows&&e)for(let n=0;n<i.length;n++){const r=a.layers.getLayerById(i[n]);r&&r.addShadowCasters([s])}}this._castShadows=e}}get castShadows(){return this._castShadows}set layers(e){this.removeFromLayers(),this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];!this.enabled||!this.entity.enabled||this.addToLayers()}get layers(){return this._layers}set asset(e){const t=e instanceof Ye?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof Ye?e.id:e;this._assetReference.id=t}destroyInstance(){var e;this._instance&&(this.removeFromLayers(),(e=this._instance)==null||e.destroy(),this._instance=null)}addToLayers(){var t,s;const e=(t=this.instance)==null?void 0:t.meshInstance;if(e){const i=this.system.app.scene.layers;for(let a=0;a<this._layers.length;a++)(s=i.getLayerById(this._layers[a]))==null||s.addMeshInstances([e])}}removeFromLayers(){var t,s;const e=(t=this.instance)==null?void 0:t.meshInstance;if(e){const i=this.system.app.scene.layers;for(let a=0;a<this._layers.length;a++)(s=i.getLayerById(this._layers[a]))==null||s.removeMeshInstances([e])}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||this._instance&&e.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||this._instance&&e.removeMeshInstances(this._instance.meshInstance)}onEnable(){const e=this.system.app.scene,t=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){var s,i,a;const t=this.system.app.scene.layers;(s=this._evtLayersChanged)==null||s.off(),this._evtLayersChanged=null,t&&((i=this._evtLayerAdded)==null||i.off(),this._evtLayerAdded=null,(a=this._evtLayerRemoved)==null||a.off(),this._evtLayerRemoved=null),this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();const e=this._assetReference.asset;e&&(this.instance=e.resource.createInstance())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}}class Fte{constructor(){this.enabled=!0}}const G3=["enabled"],mp=["castShadows","instance","asset","layers"];class k8 extends ei{constructor(e){super(e),this.id="gsplat",this.ComponentType=rL,this.DataType=Fte,this.schema=G3,this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<mp.length;i++)t.hasOwnProperty(mp[i])&&(e[mp[i]]=t[mp[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new wt(new H(t.aabbCenter),new H(t.aabbHalfExtents))),super.initializeComponentData(e,t,G3)}cloneComponent(e,t){const s=e.gsplat,i={};for(let n=0;n<mp.length;n++)i[mp[n]]=s[mp[n]];i.enabled=s.enabled,delete i.instance;const a=this.addComponent(t,i);return s.instance&&(a.instance=s.instance.clone()),s.customAabb&&(a.customAabb=s.customAabb.clone()),a}onRemove(e,t){t.onRemove()}}xt._buildAccessors(rL.prototype,G3);const BL=class BL extends Qe{set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){var e;(e=this._meshes)==null||e.forEach((t,s)=>{t&&(t.decRefCount(),t.refCount<1&&(t.destroy(),this._meshes[s]=null))})}incRefMeshes(){var e;(e=this._meshes)==null||e.forEach(t=>{t==null||t.incRefCount()})}constructor(...e){super(...e),this._meshes=null}};BL.EVENT_SETMESHES="set:meshes";let l2=BL;function vA(h){const e=this;if(!e.resource)return;const t=h.resource,s=t.renders&&t.renders[e.data.renderIndex];s&&(e.resource.meshes=s.resource.meshes)}function C4(h){const e=this;e.registry.off(`load:${h.id}`,vA,e),e.registry.on(`load:${h.id}`,vA,e),e.registry.off(`remove:${h.id}`,w4,e),e.registry.once(`remove:${h.id}`,w4,e),h.resource?vA.call(e,h):e.registry.load(h)}function w4(h){const e=this;e.registry.off(`load:${h.id}`,vA,e),e.resource&&e.resource.destroy()}class V8 extends Ps{constructor(e){super(e,"render"),this._registry=e.assets}open(e,t){return new l2}patch(e,t){if(!e.data.containerAsset)return;const s=t.get(e.data.containerAsset);if(!s){t.once(`add:${e.data.containerAsset}`,C4,e);return}C4.call(e,s)}}class oL{constructor(e,t,s,i){this._paths=e,this._input=t,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class v1{constructor(e,t){this._components=e,this._data=t}get components(){return this._components}get data(){return this._data}}function Bte(h,e){let t;const a=(y,v)=>{switch(v){case t.DT_INT8:return new Int8Array(y.buffer,y.byteOffset,y.byteLength);case t.DT_INT16:return new Int16Array(y.buffer,y.byteOffset,y.byteLength/2);case t.DT_INT32:return new Int32Array(y.buffer,y.byteOffset,y.byteLength/4);case t.DT_UINT8:return new Uint8Array(y.buffer,y.byteOffset,y.byteLength);case t.DT_UINT16:return new Uint16Array(y.buffer,y.byteOffset,y.byteLength/2);case t.DT_UINT32:return new Uint32Array(y.buffer,y.byteOffset,y.byteLength/4);case t.DT_FLOAT32:return new Float32Array(y.buffer,y.byteOffset,y.byteLength/4)}return null},n=y=>{switch(y){case t.DT_INT8:return 1;case t.DT_INT16:return 2;case t.DT_INT32:return 4;case t.DT_UINT8:return 1;case t.DT_UINT16:return 2;case t.DT_UINT32:return 4;case t.DT_FLOAT32:return 4}return 1},r=y=>y.num_components()*n(y.data_type()),l={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},u=(y,v)=>{const x=(Y,F,q)=>{Y[0]=F[0]-q[0],Y[1]=F[1]-q[1],Y[2]=F[2]-q[2]},C=(Y,F,q)=>{Y[0]=F[1]*q[2]-q[1]*F[2],Y[1]=F[2]*q[0]-q[2]*F[0],Y[2]=F[0]*q[1]-q[0]*F[1]},M=(Y,F)=>{const q=Y[F+0],G=Y[F+1],W=Y[F+2],k=1/Math.sqrt(q*q+G*G+W*W);Y[F+0]*=k,Y[F+1]*=k,Y[F+2]*=k},w=(Y,F,q)=>{for(let G=0;G<3;++G)Y[G]=F[q+G]},T=v.length/3,R=y.length/3,D=new Float32Array(y.length),I=[0,0,0],U=[0,0,0],O=[0,0,0],N=[0,0,0],z=[0,0,0],X=[0,0,0];for(let Y=0;Y<T;++Y){const F=v[Y*3+0]*3,q=v[Y*3+1]*3,G=v[Y*3+2]*3;w(I,y,F),w(U,y,q),w(O,y,G),x(N,U,I),x(z,O,I),C(X,N,z),M(X,0);for(let W=0;W<3;++W)D[F+W]+=X[W],D[q+W]+=X[W],D[G+W]+=X[W]}for(let Y=0;Y<R;++Y)M(D,Y*3);return new Uint8Array(D.buffer)},f=y=>{const v={},x=new t.DecoderBuffer;x.Init(y,y.length);const C=new t.Decoder;if(C.GetEncodedGeometryType(x)!==t.TRIANGULAR_MESH)return v.error="Failed to decode draco mesh: not a mesh",v;const M=new t.Mesh,w=C.DecodeBufferToMesh(x,M);if(!w||!w.ok()||t.getPointer(M)===0)return v.error="Failed to decode draco asset",v;const T=M.num_faces()*3,R=M.num_points()<=65535,D=T*(R?2:4),I=t._malloc(D);R?(C.GetTrianglesUInt16Array(M,D,I),v.indices=new Uint16Array(t.HEAPU16.buffer,I,T).slice().buffer):(C.GetTrianglesUInt32Array(M,D,I),v.indices=new Uint32Array(t.HEAPU32.buffer,I,T).slice().buffer),t._free(I);const U=[];for(let F=0;F<M.num_attributes();++F)U.push(C.GetAttribute(M,F));U.sort((F,q)=>(l[F.attribute_type()]??l.length)-(l[q.attribute_type()]??l.length)),v.attributes=U.map(F=>F.unique_id());let O=0;const N=U.map(F=>{const q=O;return O+=Math.ceil(r(F)/4)*4,q}),z=U.some(F=>F.attribute_type()===1),X=N[1];if(!z){for(let F=1;F<N.length;++F)N[F]+=12;O+=12}v.vertices=new ArrayBuffer(M.num_points()*O);const Y=new Uint8Array(v.vertices);for(let F=0;F<M.num_attributes();++F){const q=U[F],G=r(q),W=M.num_points()*G,k=t._malloc(W);C.GetAttributeDataArrayForAllPoints(M,q,q.data_type(),W,k);const K=new Uint8Array(t.HEAPU8.buffer,k,W);for(let ee=0;ee<M.num_points();++ee)for(let V=0;V<G;++V)Y[ee*O+N[F]+V]=K[ee*G+V];if(!z&&q.attribute_type()===0){const ee=u(a(K,q.data_type()),R?new Uint16Array(v.indices):new Uint32Array(v.indices));for(let V=0;V<M.num_points();++V)for(let Q=0;Q<12;++Q)Y[V*O+X+Q]=ee[V*12+Q]}t._free(k)}return t.destroy(M),t.destroy(C),t.destroy(x),v},_=y=>{const v=f(new Uint8Array(y.buffer));self.postMessage({jobId:y.jobId,error:v.error,indices:v.indices,vertices:v.vertices,attributes:v.attributes},[v.indices,v.vertices].filter(x=>x!=null))},g=[];self.onmessage=y=>{const v=y.data;switch(v.type){case"init":self.DracoDecoderModule({instantiateWasm:(x,C)=>(WebAssembly.instantiate(v.module,x).then(M=>C(M)).catch(M=>console.error(`instantiate failed + ${M}`)),{})}).then(x=>{t=x,g.forEach(C=>_(C))});break;case"decodeMesh":t?_(v):g.push(v);break}}}const R4=3;class Ute{constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer])}}init(e){for(e.forEach(t=>{t.addEventListener("message",s=>{const i=s.data,a=this.jobCallbacks.get(i.jobId);if(a&&a(i.error,{indices:i.indices,vertices:i.vertices,attributes:i.attributes}),this.jobCallbacks.delete(i.jobId),this.jobQueue.length>0){const n=this.jobQueue.shift();this.run(t,n)}else{const n=this.workers[2].indexOf(t);if(n!==-1)this.workers[2].splice(n,1),this.workers[1].push(t);else{const r=this.workers[1].indexOf(t);r!==-1&&(this.workers[1].splice(r,1),this.workers[0].push(t))}}})}),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){const t=this.jobQueue.shift();if(this.workers[0].length>0){const s=this.workers[0].shift();this.workers[1].push(s),this.run(s,t)}else{const s=this.workers[1].shift();this.workers[2].push(s),this.run(s,t)}}}enqueueJob(e,t){const s={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(s.jobId,t),this.workers[0].length>0){const i=this.workers[0].shift();this.workers[1].push(i),this.run(i,s)}else if(this.workers[1].length>0){const i=this.workers[1].shift();this.workers[2].push(i),this.run(i,s)}else this.jobQueue.push(s)}}const zte=h=>new Promise((e,t)=>{const s={cache:!0,responseType:"text",retry:R4>0,maxRetries:R4};Us.get(h,s,(i,a)=>{i?t(i):e(a)})}),kte=h=>{const e=()=>fetch(h).then(s=>s.arrayBuffer()).then(s=>WebAssembly.compile(s)),t=()=>WebAssembly.compileStreaming(fetch(h)).catch(s=>e());return WebAssembly.compileStreaming?t():e()},M4=1;let SA,H3;const G8=h=>{if(SA)return!0;if(!h)if(H3)h=H3;else{const e=Pb.getConfig("DracoDecoderModule");e?h={jsUrl:e.glueUrl,wasmUrl:e.wasmUrl,numWorkers:e.numWorkers}:h={jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:M4}}return!h.jsUrl||!h.wasmUrl?!1:(SA=new Ute,Promise.all([zte(h.jsUrl),kte(h.wasmUrl)]).then(([e,t])=>{const s=["/* draco */",e,"/* worker */",`(
${Bte.toString()}
)()

`].join(`
`),i=new Blob([s],{type:"application/javascript"}),a=URL.createObjectURL(i),n=Math.max(1,Math.min(16,h.numWorkers||M4)),r=[];for(let l=0;l<n;++l){const u=new Worker(a);u.postMessage({type:"init",module:t}),r.push(u)}SA.init(r)}),!0)},Vte=h=>{h!=null&&h.lazyInit?H3=h:G8(h)},Gte=(h,e)=>G8()?(SA.enqueueJob(h,e),!0):!1;class Hte{destroy(){this.renders&&this.renders.forEach(e=>{e.meshes=null})}}const H8=h=>/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(h),Wte=h=>h.substring(h.indexOf(":")+1,h.indexOf(";")),S1=h=>{switch(h){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},YC=h=>{switch(h){case 5120:return ml;case 5121:return io;case 5122:return _l;case 5123:return Dh;case 5124:return jt;case 5125:return Ai;case 5126:return it;default:return 0}},qte=h=>{switch(h){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},Xte=h=>{switch(h){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},h2={POSITION:kt,NORMAL:$a,TANGENT:po,COLOR_0:Qi,JOINTS_0:gn,WEIGHTS_0:co,TEXCOORD_0:Za,TEXCOORD_1:Mh,TEXCOORD_2:Rm,TEXCOORD_3:Mm,TEXCOORD_4:Dm,TEXCOORD_5:Pm,TEXCOORD_6:Lm,TEXCOORD_7:Im},D4={[kt]:0,[$a]:1,[po]:2,[Qi]:3,[gn]:4,[co]:5,[Za]:6,[Mh]:7,[Rm]:8,[Mm]:9,[Dm]:10,[Pm]:11,[Lm]:12,[Im]:13},jte=h=>{switch(h){case ml:return e=>Math.max(e/127,-1);case io:return e=>e/255;case _l:return e=>Math.max(e/32767,-1);case Dh:return e=>e/65535;default:return e=>e}},W3=(h,e,t)=>{const s=jte(t),i=e.length;for(let a=0;a<i;++a)h[a]=s(e[a]);return h},Kp=(h,e,t=!1)=>{const s=S1(h.type),i=Xte(h.componentType);if(!i)return null;let a;if(h.sparse){const n=h.sparse,r={count:n.count,type:"SCALAR"},l=Kp(Object.assign(r,n.indices),e,!0),u={count:n.count,type:h.type,componentType:h.componentType},f=Kp(Object.assign(u,n.values),e,!0);if(h.hasOwnProperty("bufferView")){const _={bufferView:h.bufferView,byteOffset:h.byteOffset,componentType:h.componentType,count:h.count,type:h.type};a=Kp(_,e,!0).slice()}else a=new i(h.count*s);for(let _=0;_<n.count;++_){const g=l[_];for(let y=0;y<s;++y)a[g*s+y]=f[_*s+y]}}else if(h.hasOwnProperty("bufferView")){const n=e[h.bufferView];if(t&&n.hasOwnProperty("byteStride")){const r=s*i.BYTES_PER_ELEMENT,l=new ArrayBuffer(h.count*r),u=new Uint8Array(l);let f=0;for(let _=0;_<h.count;++_){let g=(h.byteOffset||0)+_*n.byteStride;for(let y=0;y<r;++y)u[f++]=n[g++]}a=new i(l)}else a=new i(n.buffer,n.byteOffset+(h.byteOffset||0),h.count*s)}else a=new i(h.count*s);return a},u0=(h,e)=>{const t=Kp(h,e,!0);if(t instanceof Float32Array||!h.normalized)return t;const s=new Float32Array(t.length);return W3(s,t,YC(h.componentType)),s},q3=h=>{let e=h.min,t=h.max;if(!e||!t)return null;if(h.normalized){const s=YC(h.componentType);e=W3([],e,s),t=W3([],t,s)}return new wt(new H((t[0]+e[0])*.5,(t[1]+e[1])*.5,(t[2]+e[2])*.5),new H((t[0]-e[0])*.5,(t[1]-e[1])*.5,(t[2]-e[2])*.5))},W8=h=>{if(!h.hasOwnProperty("mode"))return al;switch(h.mode){case 0:return Y0;case 1:return X1;case 2:return PD;case 3:return oC;case 4:return al;case 5:return hl;case 6:return wd;default:return al}},Yte=h=>{const e=new Uint16Array(h);for(let t=0;t<h;t++)e[t]=t;return e},Kte=(h,e)=>{const t=h[kt];if(!t||t.components!==3)return;let s;if(t.size!==t.stride){const r=t.stride/t0[t.type],l=new qp[t.type](t.buffer,t.offset,t.count*r);s=new qp[t.type](t.count*3);for(let u=0;u<t.count;++u)s[u*3+0]=l[u*r+0],s[u*3+1]=l[u*r+1],s[u*3+2]=l[u*r+2]}else s=new qp[t.type](t.buffer,t.offset,t.count*3);const i=t.count;e||(e=Yte(i));const a=LP(s,e),n=new Float32Array(a.length);n.set(a),h[$a]={buffer:n.buffer,size:12,offset:0,stride:12,count:i,components:3,type:it}},Qte=h=>{const e=s=>{const i=[];for(let a=0;a<s._levels.length;++a){let n=[];if(s.cubemap)for(let r=0;r<6;++r)n.push(s._levels[a][r]);else n=s._levels[a];i.push(n)}return i},t=new Ge(h.device,h);return t._levels=e(h),t},$te=h=>{const e=new Ye(`${h.name}_clone`,h.type,h.file,h.data,h.options);return e.loaded=!0,e.resource=Qte(h.resource),h.registry.add(e),e},Zte=(h,e)=>{const t=e[kt];if(!t)return null;const s=t.count,i=[];for(const M in e)if(e.hasOwnProperty(M)){const w={semantic:M,components:e[M].components,type:e[M].type,normalize:!!e[M].normalize};en.isElementValid(h,w)||w.components++,i.push(w)}i.sort((M,w)=>D4[M.semantic]-D4[w.semantic]);let a,n,r,l,u,f;const _=new en(h,i);let g=!0;for(a=0;a<_.elements.length;++a)if(u=_.elements[a],l=e[u.name],f=l.offset-t.offset,l.buffer!==t.buffer||l.stride!==u.stride||l.size!==u.size||f!==u.offset){g=!1;break}const y=new jn(h,_,s),v=y.lock(),x=new Uint32Array(v);let C;if(g)C=new Uint32Array(t.buffer,t.offset,s*y.format.size/4),x.set(C);else{let M,w;for(a=0;a<y.format.elements.length;++a){u=y.format.elements[a],M=u.stride/4,l=e[u.name],w=l.stride/4,C=new Uint32Array(l.buffer,l.offset,(l.count-1)*w+(l.size+3)/4);let T=0,R=u.offset/4;const D=Math.floor((l.size+3)/4);for(n=0;n<s;++n){for(r=0;r<D;++r)x[R+r]=C[T+r];T+=w,R+=M}}}return y.unlock(),y},Jte=(h,e,t,s,i,a)=>{const n={},r=[];for(const f in e)e.hasOwnProperty(f)&&h2.hasOwnProperty(f)&&(n[f]=e[f],r.push(`${f}:${e[f]}`));r.sort();const l=r.join();let u=a[l];if(!u){const f={};for(const _ in n){const g=s[e[_]],y=Kp(g,i),v=i[g.bufferView],x=h2[_],C=S1(g.type)*qte(g.componentType),M=v&&v.hasOwnProperty("byteStride")?v.byteStride:C;f[x]={buffer:y.buffer,size:C,offset:y.byteOffset,stride:M,count:g.count,components:S1(g.type),type:YC(g.componentType),normalize:g.normalized}}f.hasOwnProperty($a)||Kte(f,t),u=Zte(h,f),a[l]=u}return u},ese=(h,e,t,s,i,a)=>{let n,r,l;const u=e.joints,f=u.length,_=[];if(e.hasOwnProperty("inverseBindMatrices")){const x=e.inverseBindMatrices,C=Kp(t[x],s,!0),M=[];for(n=0;n<f;n++){for(r=0;r<16;r++)M[r]=C[n*16+r];l=new Me,l.set(M),_.push(l)}}else for(n=0;n<f;n++)l=new Me,_.push(l);const g=[];for(n=0;n<f;n++)g[n]=i[u[n]].name;const y=g.join("#");let v=a.get(y);return v||(v=new OP(h,_,g),a.set(y,v)),v},tse=(h,e,t,s,i,a,n)=>{var u;const r=new Ft(h);r.aabb=q3(t[e.attributes.POSITION]);const l=[];for(const[f,_]of Object.entries(e.attributes)){const g=t[_],y=h2[f],v=YC(g.componentType);l.push({semantic:y,components:S1(g.type),type:v,normalize:g.normalized??(y===Qi&&(v===io||v===Dh))})}if(n.push(new Promise((f,_)=>{const g=e.extensions.KHR_draco_mesh_compression;Gte(s[g.bufferView].slice().buffer,(y,v)=>{var x;if(y)console.log(y),_(y);else{const C={};for(const[U,O]of Object.entries(g.attributes))C[h2[U]]=v.attributes.indexOf(O);l.sort((U,O)=>C[U.semantic]-C[O.semantic]),(x=e.attributes)!=null&&x.NORMAL||l.splice(1,0,{semantic:"NORMAL",components:3,type:it});const M=new en(h,l),w=v.vertices.byteLength/M.size,T=w<=65535?ho:Th,R=v.indices.byteLength/(w<=65535?2:4),D=new jn(h,M,w,{data:v.vertices}),I=new Ah(h,T,R,_r,v.indices);r.vertexBuffer=D,r.indexBuffer[0]=I,r.primitive[0].type=W8(e),r.primitive[0].base=0,r.primitive[0].count=I?R:w,r.primitive[0].indexed=!!I,f()}})})),(u=e==null?void 0:e.extensions)!=null&&u.KHR_materials_variants){const f=e.extensions.KHR_materials_variants,_={};f.mappings.forEach(g=>{g.variants.forEach(y=>{_[y]=g.material})}),i[r.id]=_}return a[r.id]=e.material,r},sse=(h,e,t,s,i,a,n,r,l)=>{const u=[];return e.primitives.forEach(f=>{var _;if((_=f.extensions)!=null&&_.KHR_draco_mesh_compression)u.push(tse(h,f,t,s,a,n,l));else{let g=f.hasOwnProperty("indices")?Kp(t[f.indices],s,!0):null;const y=Jte(h,f.attributes,g,t,s,i),v=W8(f),x=new Ft(h);if(x.vertexBuffer=y,x.primitive[0].type=v,x.primitive[0].base=0,x.primitive[0].indexed=g!==null,g!==null){let M;g instanceof Uint8Array?M=Bb:g instanceof Uint16Array?M=ho:M=Th,M===Bb&&h.isWebGPU&&(M=ho,g=new Uint16Array(g));const w=new Ah(h,M,g.length,_r,g);x.indexBuffer[0]=w,x.primitive[0].count=g.length}else x.primitive[0].count=y.numVertices;if(f.hasOwnProperty("extensions")&&f.extensions.hasOwnProperty("KHR_materials_variants")){const M=f.extensions.KHR_materials_variants,w={};M.mappings.forEach(T=>{T.variants.forEach(R=>{w[R]=T.material})}),a[x.id]=w}n[x.id]=f.material;let C=t[f.attributes.POSITION];if(x.aabb=q3(C),f.hasOwnProperty("targets")){const M=[];f.targets.forEach((w,T)=>{const R={};w.hasOwnProperty("POSITION")&&(C=t[w.POSITION],R.deltaPositions=u0(C,s),R.aabb=q3(C)),w.hasOwnProperty("NORMAL")&&(C=t[w.NORMAL],R.deltaNormals=u0(C,s)),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?R.name=e.extras.targetNames[T]:R.name=T.toString(10),e.hasOwnProperty("weights")&&(R.defaultWeight=e.weights[T]),R.preserveData=r.morphPreserveData,M.push(new yx(R))}),x.morph=new VC(M,h,{preferHighPrecision:r.morphPreferHighPrecision})}u.push(x)}}),u},fa=(h,e,t)=>{var l;let s;const i=h.texCoord;if(i)for(s=0;s<t.length;++s)e[`${t[s]}MapUv`]=i;const a=[0,0],n=[1,1],r=(l=h.extensions)==null?void 0:l.KHR_texture_transform;if(r){const u=r.offset||a,f=r.scale||n,_=r.rotation?-r.rotation*ge.RAD_TO_DEG:0,g=new Ee(f[0],f[1]),y=new Ee(u[0],1-f[1]-u[1]);for(s=0;s<t.length;++s)e[`${t[s]}MapTiling`]=g,e[`${t[s]}MapOffset`]=y,e[`${t[s]}MapRotation`]=_}},ise=(h,e,t)=>{let s,i;if(h.hasOwnProperty("diffuseFactor")?(s=h.diffuseFactor,e.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),e.opacity=s[3]):(e.diffuse.set(1,1,1),e.opacity=1),h.hasOwnProperty("diffuseTexture")){const a=h.diffuseTexture;i=t[a.index],e.diffuseMap=i,e.diffuseMapChannel="rgb",e.opacityMap=i,e.opacityMapChannel="a",fa(a,e,["diffuse","opacity"])}if(e.useMetalness=!1,h.hasOwnProperty("specularFactor")?(s=h.specularFactor,e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))):e.specular.set(1,1,1),h.hasOwnProperty("glossinessFactor")?e.gloss=h.glossinessFactor:e.gloss=1,h.hasOwnProperty("specularGlossinessTexture")){const a=h.specularGlossinessTexture;e.specularMap=e.glossMap=t[a.index],e.specularMapChannel="rgb",e.glossMapChannel="a",fa(a,e,["gloss","metalness"])}},ase=(h,e,t)=>{if(h.hasOwnProperty("clearcoatFactor")?e.clearCoat=h.clearcoatFactor*.25:e.clearCoat=0,h.hasOwnProperty("clearcoatTexture")){const s=h.clearcoatTexture;e.clearCoatMap=t[s.index],e.clearCoatMapChannel="r",fa(s,e,["clearCoat"])}if(h.hasOwnProperty("clearcoatRoughnessFactor")?e.clearCoatGloss=h.clearcoatRoughnessFactor:e.clearCoatGloss=0,h.hasOwnProperty("clearcoatRoughnessTexture")){const s=h.clearcoatRoughnessTexture;e.clearCoatGlossMap=t[s.index],e.clearCoatGlossMapChannel="g",fa(s,e,["clearCoatGloss"])}if(h.hasOwnProperty("clearcoatNormalTexture")){const s=h.clearcoatNormalTexture;e.clearCoatNormalMap=t[s.index],fa(s,e,["clearCoatNormal"]),s.hasOwnProperty("scale")?e.clearCoatBumpiness=s.scale:e.clearCoatBumpiness=1}e.clearCoatGlossInvert=!0},nse=(h,e,t)=>{e.useLighting=!1,e.emissive.copy(e.diffuse),e.emissiveMap=e.diffuseMap,e.emissiveMapUv=e.diffuseMapUv,e.emissiveMapTiling.copy(e.diffuseMapTiling),e.emissiveMapOffset.copy(e.diffuseMapOffset),e.emissiveMapRotation=e.diffuseMapRotation,e.emissiveMapChannel=e.diffuseMapChannel,e.emissiveVertexColor=e.diffuseVertexColor,e.emissiveVertexColorChannel=e.diffuseVertexColorChannel,e.useLighting=!1,e.useSkybox=!1,e.diffuse.set(1,1,1),e.diffuseMap=null,e.diffuseVertexColor=!1},rse=(h,e,t)=>{if(e.useMetalnessSpecularColor=!0,h.hasOwnProperty("specularColorTexture")&&(e.specularMap=t[h.specularColorTexture.index],e.specularMapChannel="rgb",fa(h.specularColorTexture,e,["specular"])),h.hasOwnProperty("specularColorFactor")){const s=h.specularColorFactor;e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.specular.set(1,1,1);h.hasOwnProperty("specularFactor")?e.specularityFactor=h.specularFactor:e.specularityFactor=1,h.hasOwnProperty("specularTexture")&&(e.specularityFactorMapChannel="a",e.specularityFactorMap=t[h.specularTexture.index],fa(h.specularTexture,e,["specularityFactor"]))},ose=(h,e,t)=>{h.hasOwnProperty("ior")&&(e.refractionIndex=1/h.ior)},lse=(h,e,t)=>{h.hasOwnProperty("dispersion")&&(e.dispersion=h.dispersion)},hse=(h,e,t)=>{e.blendType=xr,e.useDynamicRefraction=!0,h.hasOwnProperty("transmissionFactor")&&(e.refraction=h.transmissionFactor),h.hasOwnProperty("transmissionTexture")&&(e.refractionMapChannel="r",e.refractionMap=t[h.transmissionTexture.index],fa(h.transmissionTexture,e,["refraction"]))},cse=(h,e,t)=>{if(e.useSheen=!0,h.hasOwnProperty("sheenColorFactor")){const s=h.sheenColorFactor;e.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.sheen.set(1,1,1);h.hasOwnProperty("sheenColorTexture")&&(e.sheenMap=t[h.sheenColorTexture.index],fa(h.sheenColorTexture,e,["sheen"])),e.sheenGloss=h.hasOwnProperty("sheenRoughnessFactor")?h.sheenRoughnessFactor:0,h.hasOwnProperty("sheenRoughnessTexture")&&(e.sheenGlossMap=t[h.sheenRoughnessTexture.index],e.sheenGlossMapChannel="a",fa(h.sheenRoughnessTexture,e,["sheenGloss"])),e.sheenGlossInvert=!0},use=(h,e,t)=>{if(e.blendType=xr,e.useDynamicRefraction=!0,h.hasOwnProperty("thicknessFactor")&&(e.thickness=h.thicknessFactor),h.hasOwnProperty("thicknessTexture")&&(e.thicknessMap=t[h.thicknessTexture.index],e.thicknessMapChannel="g",fa(h.thicknessTexture,e,["thickness"])),h.hasOwnProperty("attenuationDistance")&&(e.attenuationDistance=h.attenuationDistance),h.hasOwnProperty("attenuationColor")){const s=h.attenuationColor;e.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},dse=(h,e,t)=>{h.hasOwnProperty("emissiveStrength")&&(e.emissiveIntensity=h.emissiveStrength)},fse=(h,e,t)=>{e.useIridescence=!0,h.hasOwnProperty("iridescenceFactor")&&(e.iridescence=h.iridescenceFactor),h.hasOwnProperty("iridescenceTexture")&&(e.iridescenceMapChannel="r",e.iridescenceMap=t[h.iridescenceTexture.index],fa(h.iridescenceTexture,e,["iridescence"])),h.hasOwnProperty("iridescenceIor")&&(e.iridescenceRefractionIndex=h.iridescenceIor),h.hasOwnProperty("iridescenceThicknessMinimum")&&(e.iridescenceThicknessMin=h.iridescenceThicknessMinimum),h.hasOwnProperty("iridescenceThicknessMaximum")&&(e.iridescenceThicknessMax=h.iridescenceThicknessMaximum),h.hasOwnProperty("iridescenceThicknessTexture")&&(e.iridescenceThicknessMapChannel="g",e.iridescenceThicknessMap=t[h.iridescenceThicknessTexture.index],fa(h.iridescenceThicknessTexture,e,["iridescenceThickness"]))},q8=(h,e)=>{const t=new Vi;h.hasOwnProperty("name")&&(t.name=h.name),t.occludeSpecular=ay,t.diffuseVertexColor=!0,t.specularTint=!0,t.specularVertexColor=!0,t.specular.set(1,1,1),t.gloss=1,t.glossInvert=!0,t.useMetalness=!0;let s,i;if(h.hasOwnProperty("pbrMetallicRoughness")){const n=h.pbrMetallicRoughness;if(n.hasOwnProperty("baseColorFactor")&&(s=n.baseColorFactor,t.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),t.opacity=s[3]),n.hasOwnProperty("baseColorTexture")){const r=n.baseColorTexture;i=e[r.index],t.diffuseMap=i,t.diffuseMapChannel="rgb",t.opacityMap=i,t.opacityMapChannel="a",fa(r,t,["diffuse","opacity"])}if(n.hasOwnProperty("metallicFactor")&&(t.metalness=n.metallicFactor),n.hasOwnProperty("roughnessFactor")&&(t.gloss=n.roughnessFactor),n.hasOwnProperty("metallicRoughnessTexture")){const r=n.metallicRoughnessTexture;t.metalnessMap=t.glossMap=e[r.index],t.metalnessMapChannel="b",t.glossMapChannel="g",fa(r,t,["gloss","metalness"])}}if(h.hasOwnProperty("normalTexture")){const n=h.normalTexture;t.normalMap=e[n.index],fa(n,t,["normal"]),n.hasOwnProperty("scale")&&(t.bumpiness=n.scale)}if(h.hasOwnProperty("occlusionTexture")){const n=h.occlusionTexture;t.aoMap=e[n.index],t.aoMapChannel="r",fa(n,t,["ao"])}if(h.hasOwnProperty("emissiveFactor")&&(s=h.emissiveFactor,t.emissive.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))),h.hasOwnProperty("emissiveTexture")){const n=h.emissiveTexture;t.emissiveMap=e[n.index],fa(n,t,["emissive"])}if(h.hasOwnProperty("alphaMode"))switch(h.alphaMode){case"MASK":t.blendType=Gn,h.hasOwnProperty("alphaCutoff")?t.alphaTest=h.alphaCutoff:t.alphaTest=.5;break;case"BLEND":t.blendType=xr,t.depthWrite=!1;break;default:case"OPAQUE":t.blendType=Gn;break}else t.blendType=Gn;h.hasOwnProperty("doubleSided")?(t.twoSidedLighting=h.doubleSided,t.cull=h.doubleSided?Xs:jc):(t.twoSidedLighting=!1,t.cull=jc);const a={KHR_materials_clearcoat:ase,KHR_materials_emissive_strength:dse,KHR_materials_ior:ose,KHR_materials_dispersion:lse,KHR_materials_iridescence:fse,KHR_materials_pbrSpecularGlossiness:ise,KHR_materials_sheen:cse,KHR_materials_specular:rse,KHR_materials_transmission:hse,KHR_materials_unlit:nse,KHR_materials_volume:use};if(h.hasOwnProperty("extensions"))for(const n in h.extensions){const r=a[n];r!==void 0&&r(h.extensions[n],t,e)}return t.update(),t},pse=(h,e,t,s,i,a,n)=>{const r=O=>new v1(S1(O.type),u0(O,s)),l={STEP:WP,LINEAR:qA,CUBICSPLINE:XA},u={},f={},_={};let g=1,y;for(y=0;y<h.samplers.length;++y){const O=h.samplers[y];u.hasOwnProperty(O.input)||(u[O.input]=r(t[O.input])),f.hasOwnProperty(O.output)||(f[O.output]=r(t[O.output]));const N=O.hasOwnProperty("interpolation")&&l.hasOwnProperty(O.interpolation)?l[O.interpolation]:qA,z={paths:[],input:O.input,output:O.output,interpolation:N};_[y]=z}const v=[],x={translation:"localPosition",rotation:"localRotation",scale:"localScale"},C=O=>{const N=[];for(;O;)N.unshift(O.name),O=O.parent;return N},M=(O,N,z)=>{const X=f[O.output];if(!X)return;let Y;if(a&&a[N.mesh]){const K=a[N.mesh];K.hasOwnProperty("extras")&&K.extras.hasOwnProperty("targetNames")&&(Y=K.extras.targetNames)}const F=X.data,q=F.length/u[O.input].data.length,G=F.length/q,W=G*4,k=new ArrayBuffer(W*q);for(let K=0;K<q;K++){const ee=new Float32Array(k,W*K,G);for(let J=0;J<G;J++)ee[J]=F[J*q+K];const V=new v1(1,ee),Q=Y!=null&&Y[K]?`name.${Y[K]}`:K;f[-g]=V;const se={paths:[{entityPath:z,component:"graph",propertyPath:[`weight.${Q}`]}],input:O.input,output:-g,interpolation:O.interpolation};g++,_[`morphCurve-${y}-${K}`]=se}};for(y=0;y<h.channels.length;++y){const O=h.channels[y],N=O.target,z=_[O.sampler],X=i[N.node],Y=n[N.node],F=C(X);N.path.startsWith("weights")?(M(z,Y,F),_[O.sampler].morphCurve=!0):z.paths.push({entityPath:F,component:"graph",propertyPath:[x[N.path]]})}const w=[],T=[],R=[];for(const O in u)w.push(u[O]),u[O]=w.length-1;for(const O in f)T.push(f[O]),f[O]=T.length-1;for(const O in _){const N=_[O];N.morphCurve||(R.push(new oL(N.paths,u[N.input],f[N.output],N.interpolation)),N.paths.length>0&&N.paths[0].propertyPath[0]==="localRotation"&&N.interpolation!==XA&&v.push(R[R.length-1].output))}v.sort();let D=null,I;for(y=0;y<v.length;++y){const O=v[y];if(y===0||O!==D){if(I=T[O],I.components===4){const N=I.data,z=N.length-4;for(let X=0;X<z;X+=4)N[X+0]*N[X+4]+N[X+1]*N[X+5]+N[X+2]*N[X+6]+N[X+3]*N[X+7]<0&&(N[X+4]*=-1,N[X+5]*=-1,N[X+6]*=-1,N[X+7]*=-1)}D=O}}let U=0;for(y=0;y<w.length;y++)I=w[y]._data,U=Math.max(U,I.length===0?0:I[I.length-1]);return new wh(h.hasOwnProperty("name")?h.name:`animation_${e}`,U,w,T,R)},kE=new Me,Tg=new H,mse=(h,e,t)=>{const s=new Jt;if(h.hasOwnProperty("name")&&h.name.length>0?s.name=h.name:s.name=`node_${e}`,h.hasOwnProperty("matrix")&&(kE.data.set(h.matrix),kE.getTranslation(Tg),s.setLocalPosition(Tg),kE.getEulerAngles(Tg),s.setLocalEulerAngles(Tg),kE.getScale(Tg),s.setLocalScale(Tg)),h.hasOwnProperty("rotation")){const i=h.rotation;s.setLocalRotation(i[0],i[1],i[2],i[3])}if(h.hasOwnProperty("translation")){const i=h.translation;s.setLocalPosition(i[0],i[1],i[2])}if(h.hasOwnProperty("scale")){const i=h.scale;s.setLocalScale(i[0],i[1],i[2])}return h.hasOwnProperty("extensions")&&h.extensions.EXT_mesh_gpu_instancing&&t.set(h,{ext:h.extensions.EXT_mesh_gpu_instancing}),s},_se=(h,e)=>{const t=h.type==="orthographic"?nl:Ya,s=t===nl?h.orthographic:h.perspective,i={enabled:!1,projection:t,nearClip:s.znear,aspectRatioMode:zC};s.zfar&&(i.farClip=s.zfar),t===nl?(i.orthoHeight=.5*s.ymag,s.ymag&&(i.aspectRatioMode=FA,i.aspectRatio=s.xmag/s.ymag)):(i.fov=s.yfov*ge.RAD_TO_DEG,s.aspectRatio&&(i.aspectRatioMode=FA,i.aspectRatio=s.aspectRatio));const a=new Kt(h.name);return a.addComponent("camera",i),a},gse=(h,e)=>{const t={enabled:!1,type:h.type==="point"?"omni":h.type,color:h.hasOwnProperty("color")?new xe(h.color):xe.WHITE,range:h.hasOwnProperty("range")?h.range:9999,falloffMode:dP,intensity:h.hasOwnProperty("intensity")?ge.clamp(h.intensity,0,2):1};h.hasOwnProperty("spot")&&(t.innerConeAngle=h.spot.hasOwnProperty("innerConeAngle")?h.spot.innerConeAngle*ge.RAD_TO_DEG:0,t.outerConeAngle=h.spot.hasOwnProperty("outerConeAngle")?h.spot.outerConeAngle*ge.RAD_TO_DEG:Math.PI/4),h.hasOwnProperty("intensity")&&(t.luminance=h.intensity*R0.getLightUnitConversion(n3[t.type],t.outerConeAngle,t.innerConeAngle));const s=new Kt(e.name);return s.rotateLocal(90,0,0),s.addComponent("light",t),s},yse=(h,e,t,s)=>{if(!e.hasOwnProperty("skins")||e.skins.length===0)return[];const i=new Map;return e.skins.map(a=>ese(h,a,e.accessors,s,t,i))},vse=(h,e,t,s)=>{var f,_,g;const i={},a={},n={},r=[];return{meshes:!s.skipMeshes&&((f=e==null?void 0:e.meshes)==null?void 0:f.length)&&((_=e==null?void 0:e.accessors)==null?void 0:_.length)&&((g=e==null?void 0:e.bufferViews)==null?void 0:g.length)?e.meshes.map(y=>sse(h,y,e.accessors,t,i,a,n,s,r)):[],meshVariants:a,meshDefaultMaterials:n,promises:r}},Sse=(h,e,t)=>{var n,r,l;if(!h.hasOwnProperty("materials")||h.materials.length===0)return[];const s=(n=t==null?void 0:t.material)==null?void 0:n.preprocess,i=((r=t==null?void 0:t.material)==null?void 0:r.process)??q8,a=(l=t==null?void 0:t.material)==null?void 0:l.postprocess;return h.materials.map(u=>{s&&s(u);const f=i(u,e);return a&&a(u,f),f})},bse=h=>{if(!h.hasOwnProperty("extensions")||!h.extensions.hasOwnProperty("KHR_materials_variants"))return null;const e=h.extensions.KHR_materials_variants.variants,t={};for(let s=0;s<e.length;s++)t[e[s].name]=s;return t},xse=(h,e,t,s)=>{var n,r;if(!h.hasOwnProperty("animations")||h.animations.length===0)return[];const i=(n=s==null?void 0:s.animation)==null?void 0:n.preprocess,a=(r=s==null?void 0:s.animation)==null?void 0:r.postprocess;return h.animations.map((l,u)=>{i&&i(l);const f=pse(l,u,h.accessors,t,e,h.meshes,h.nodes);return a&&a(l,f),f})},Tse=(h,e,t,s)=>{const i=e.accessors;t.forEach((a,n)=>{const r=a.ext.attributes;let l;if(r.hasOwnProperty("TRANSLATION")){const g=i[r.TRANSLATION];l=u0(g,s)}let u;if(r.hasOwnProperty("ROTATION")){const g=i[r.ROTATION];u=u0(g,s)}let f;if(r.hasOwnProperty("SCALE")){const g=i[r.SCALE];f=u0(g,s)}const _=(l?l.length/3:0)||(u?u.length/4:0)||(f?f.length/3:0);if(_){const g=new Float32Array(_*16),y=new H,v=new Ne,x=new H(1,1,1),C=new Me;let M=0;for(let w=0;w<_;w++){const T=w*3;if(l&&y.set(l[T],l[T+1],l[T+2]),u){const R=w*4;v.set(u[R],u[R+1],u[R+2],u[R+3])}f&&x.set(f[T],f[T+1],f[T+2]),C.setTRS(y,v,x);for(let R=0;R<16;R++)g[M++]=C.data[R]}a.matrices=g}})},Ese=(h,e,t)=>{var r,l,u;if(!h.hasOwnProperty("nodes")||h.nodes.length===0)return[];const s=(r=e==null?void 0:e.node)==null?void 0:r.preprocess,i=((l=e==null?void 0:e.node)==null?void 0:l.process)??mse,a=(u=e==null?void 0:e.node)==null?void 0:u.postprocess,n=h.nodes.map((f,_)=>{s&&s(f);const g=i(f,_,t);return a&&a(f,g),g});for(let f=0;f<h.nodes.length;++f){const _=h.nodes[f];if(_.hasOwnProperty("children")){const g=n[f],y={};for(let v=0;v<_.children.length;++v){const x=n[_.children[v]];x.parent||(y.hasOwnProperty(x.name)?x.name+=y[x.name]++:y[x.name]=1,g.addChild(x))}}}return n},Ase=(h,e)=>{var i;const t=[],s=h.scenes.length;if(s===1&&((i=h.scenes[0].nodes)==null?void 0:i.length)===1){const a=h.scenes[0].nodes[0];t.push(e[a])}else for(let a=0;a<s;a++){const n=h.scenes[a];if(n.nodes){const r=new Jt(n.name);for(let l=0;l<n.nodes.length;l++){const u=e[n.nodes[l]];r.addChild(u)}t.push(r)}}return t},Cse=(h,e,t)=>{var i,a,n;let s=null;if(h.hasOwnProperty("nodes")&&h.hasOwnProperty("cameras")&&h.cameras.length>0){const r=(i=t==null?void 0:t.camera)==null?void 0:i.preprocess,l=((a=t==null?void 0:t.camera)==null?void 0:a.process)??_se,u=(n=t==null?void 0:t.camera)==null?void 0:n.postprocess;h.nodes.forEach((f,_)=>{if(f.hasOwnProperty("camera")){const g=h.cameras[f.camera];if(g){r&&r(g);const y=l(g,e[_]);u&&u(g,y),y&&(s||(s=new Map),s.set(f,y))}}})}return s},wse=(h,e,t)=>{var i,a,n;let s=null;if(h.hasOwnProperty("nodes")&&h.hasOwnProperty("extensions")&&h.extensions.hasOwnProperty("KHR_lights_punctual")&&h.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const r=h.extensions.KHR_lights_punctual.lights;if(r.length){const l=(i=t==null?void 0:t.light)==null?void 0:i.preprocess,u=((a=t==null?void 0:t.light)==null?void 0:a.process)??gse,f=(n=t==null?void 0:t.light)==null?void 0:n.postprocess;h.nodes.forEach((_,g)=>{if(_.hasOwnProperty("extensions")&&_.extensions.hasOwnProperty("KHR_lights_punctual")&&_.extensions.KHR_lights_punctual.hasOwnProperty("light")){const y=_.extensions.KHR_lights_punctual.light,v=r[y];if(v){l&&l(v);const x=u(v,e[g]);f&&f(v,x),x&&(s||(s=new Map),s.set(_,x))}}})}}return s},Rse=(h,e,t)=>{h.nodes.forEach(s=>{s.hasOwnProperty("mesh")&&s.hasOwnProperty("skin")&&e[s.mesh].meshes.forEach(a=>{a.skin=t[s.skin]})})},Mse=async(h,e,t,s,i)=>{var N,z;const a=(N=i==null?void 0:i.global)==null?void 0:N.preprocess,n=(z=i==null?void 0:i.global)==null?void 0:z.postprocess;a&&a(e),e.asset&&e.asset.generator;const r=new Map,l=Ese(e,i,r),u=Ase(e,l),f=wse(e,l,i),_=Cse(e,l,i),g=bse(e),y=await Promise.all(t),{meshes:v,meshVariants:x,meshDefaultMaterials:C,promises:M}=vse(h,e,y,i),w=xse(e,l,y,i);Tse(h,e,r,y);const T=await Promise.all(s),R=T.map(X=>X.resource),D=Sse(e,R,i),I=yse(h,e,l,y),U=[];for(let X=0;X<v.length;X++)U[X]=new l2,U[X].meshes=v[X];Rse(e,U,I);const O=new Hte;return O.gltf=e,O.nodes=l,O.scenes=u,O.animations=w,O.textures=T,O.materials=D,O.variants=g,O.meshVariants=x,O.meshDefaultMaterials=C,O.renders=U,O.skins=I,O.lights=f,O.cameras=_,O.nodeInstancingMap=r,n&&n(e,O),await Promise.all(M),O},Dse=(h,e)=>{const t=(i,a)=>{switch(i){case 9728:return Je;case 9729:return Vt;case 9984:return vm;case 9985:return bm;case 9986:return Sm;case 9987:return lo;default:return a}},s=(i,a)=>{switch(i){case 33071:return Oe;case 33648:return O0;case 10497:return Zs;default:return a}};h&&(e=e??{},h.minFilter=t(e.minFilter,lo),h.magFilter=t(e.magFilter,Vt),h.addressU=s(e.wrapS,Zs),h.addressV=s(e.wrapT,Zs))};let Pse=0;const Ig=h=>{var e,t,s,i;return((t=(e=h.extensions)==null?void 0:e.KHR_texture_basisu)==null?void 0:t.source)??((i=(s=h.extensions)==null?void 0:s.EXT_texture_webp)==null?void 0:i.source)??h.source},Lse=(h,e,t,s,i)=>{var g,y,v;if(!h.images||h.images.length===0)return[];const a=(g=i==null?void 0:i.image)==null?void 0:g.preprocess,n=(y=i==null?void 0:i.image)==null?void 0:y.processAsync,r=(v=i==null?void 0:i.image)==null?void 0:v.postprocess,l={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=x=>{const C=new Set;return x.hasOwnProperty("materials")&&x.materials.forEach(M=>{if(M.hasOwnProperty("pbrMetallicRoughness")){const w=M.pbrMetallicRoughness;if(w.hasOwnProperty("baseColorTexture")){const T=x.textures[w.baseColorTexture.index];C.add(Ig(T))}}if(M.hasOwnProperty("emissiveTexture")){const w=x.textures[M.emissiveTexture.index];C.add(Ig(w))}if(M.hasOwnProperty("extensions")){const w=M.extensions.KHR_materials_sheen;if(w&&w.hasOwnProperty("sheenColorTexture")){const D=x.textures[w.sheenColorTexture.index];C.add(Ig(D))}const T=M.extensions.KHR_materials_pbrSpecularGlossiness;if(T&&T.hasOwnProperty("specularGlossinessTexture")){const D=x.textures[T.specularGlossinessTexture.index];C.add(Ig(D))}const R=M.extensions.KHR_materials_specular;if(R&&R.hasOwnProperty("specularColorTexture")){const D=x.textures[R.specularColorTexture.index];C.add(Ig(D))}}}),C},f=(x,C,M,w,T,R)=>new Promise((D,I)=>{const U=O=>{const N=`${x.name||"gltf-texture"}-${Pse++}`,z={url:C||N};if(O&&(z.contents=O.slice(0).buffer),w){const F=l[w];F&&(z.filename=`${z.url}.${F}`)}const X={srgb:R},Y=new Ye(N,"texture",z,X,T);Y.on("load",F=>D(F)),Y.on("error",F=>I(F)),s.add(Y),s.load(Y)};M?M.then(O=>U(O)):U(null)}),_=u(h);return h.images.map((x,C)=>{a&&a(x);let M;return n?M=new Promise((w,T)=>{n(x,(R,D)=>{R?T(R):w(D)})}):M=new Promise(w=>{w(null)}),M=M.then(w=>{const T=_.has(C);return w||(x.hasOwnProperty("uri")?H8(x.uri)?f(x,x.uri,null,Wte(x.uri),null,T):f(x,_m.test(x.uri)?x.uri:bt.join(t,x.uri),null,null,{crossOrigin:"anonymous"},T):x.hasOwnProperty("bufferView")&&x.hasOwnProperty("mimeType")?f(x,null,e[x.bufferView],x.mimeType,null,T):Promise.reject(new Error(`Invalid image found in gltf (neither uri or bufferView found). index=${C}`)))}),r&&(M=M.then(w=>(r(x,w),w))),M})},Ise=(h,e,t)=>{var r,l,u,f,_;if(!((r=h==null?void 0:h.images)!=null&&r.length)||!((l=h==null?void 0:h.textures)!=null&&l.length))return[];const s=(u=t==null?void 0:t.texture)==null?void 0:u.preprocess,i=(f=t==null?void 0:t.texture)==null?void 0:f.processAsync,a=(_=t==null?void 0:t.texture)==null?void 0:_.postprocess,n=new Set;return h.textures.map(g=>{s&&s(g);let y;return i?y=new Promise((v,x)=>{i(g,h.images,(C,M)=>{C?x(C):v(M)})}):y=new Promise(v=>{v(null)}),y=y.then(v=>{v=v??Ig(g);const x=n.has(v);return n.add(v),e[v].then(C=>{const M=x?$te(C):C;return Dse(M.resource,(h.samplers??[])[g.sampler]),M})}),a&&(y=y.then(v=>(a(g,v),v))),y})},Ose=(h,e,t,s)=>{var r,l,u;if(!h.buffers||h.buffers.length===0)return[];const i=(r=s==null?void 0:s.buffer)==null?void 0:r.preprocess,a=(l=s==null?void 0:s.buffer)==null?void 0:l.processAsync,n=(u=s==null?void 0:s.buffer)==null?void 0:u.postprocess;return h.buffers.map((f,_)=>{i&&i(f);let g;return a?g=new Promise((y,v)=>{a(f,(x,C)=>{x?v(x):y(C)})}):g=new Promise(y=>{y(null)}),g=g.then(y=>{if(y)return y;if(f.hasOwnProperty("uri")){if(H8(f.uri)){const v=atob(f.uri.split(",")[1]),x=new Uint8Array(v.length);for(let C=0;C<v.length;C++)x[C]=v.charCodeAt(C);return x}return new Promise((v,x)=>{Us.get(_m.test(f.uri)?f.uri:bt.join(t,f.uri),{cache:!0,responseType:"arraybuffer",retry:!1},(C,M)=>{C?x(C):v(new Uint8Array(M))})})}return e}),n&&(g=g.then(y=>(n(h.buffers[_],y),y))),g})},Nse=(h,e)=>{const s=JSON.parse((i=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(i);let a="";for(let n=0;n<i.length;n++)a+=String.fromCharCode(i[n]);return decodeURIComponent(escape(a))})(h));if(s.asset&&s.asset.version&&parseFloat(s.asset.version)<2){e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`);return}e(null,s)},Fse=(h,e)=>{const t=h instanceof ArrayBuffer?new DataView(h):new DataView(h.buffer,h.byteOffset,h.byteLength),s=t.getUint32(0,!0),i=t.getUint32(4,!0),a=t.getUint32(8,!0);if(s!==1179937895){e(`Invalid magic number found in glb header. Expected 0x46546C67, found 0x${s.toString(16)}`);return}if(i!==2){e(`Invalid version number found in glb header. Expected 2, found ${i}`);return}if(a<=0||a>t.byteLength){e(`Invalid length found in glb header. Found ${a}`);return}const n=[];let r=12;for(;r<a;){const l=t.getUint32(r,!0);r+l+8>t.byteLength&&e(`Invalid chunk length found in glb. Found ${l}`);const u=t.getUint32(r+4,!0),f=new Uint8Array(t.buffer,t.byteOffset+r+8,l);n.push({length:l,type:u,data:f}),r+=l+8}if(n.length!==1&&n.length!==2){e("Invalid number of chunks found in glb file.");return}if(n[0].type!==1313821514){e(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${n[0].type.toString(16)}`);return}if(n.length>1&&n[1].type!==5130562){e(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${n[1].type.toString(16)}`);return}e(null,{gltfChunk:n[0].data,binaryChunk:n.length===2?n[1].data:null})},Bse=(h,e,t)=>{const s=()=>{const i=new Uint8Array(e);return i[0]===103&&i[1]===108&&i[2]===84&&i[3]===70};h&&h.toLowerCase().endsWith(".glb")||s()?Fse(e,t):t(null,{gltfChunk:e,binaryChunk:null})},Use=(h,e,t)=>{var r,l,u,f;const s=[],i=(r=t==null?void 0:t.bufferView)==null?void 0:r.preprocess,a=(l=t==null?void 0:t.bufferView)==null?void 0:l.processAsync,n=(u=t==null?void 0:t.bufferView)==null?void 0:u.postprocess;if(!((f=h.bufferViews)!=null&&f.length))return s;for(let _=0;_<h.bufferViews.length;++_){const g=h.bufferViews[_];i&&i(g);let y;a?y=new Promise((v,x)=>{a(g,e,(C,M)=>{C?x(C):v(M)})}):y=new Promise(v=>{v(null)}),y=y.then(v=>v||e[g.buffer].then(x=>new Uint8Array(x.buffer,x.byteOffset+(g.byteOffset||0),g.byteLength))),g.hasOwnProperty("byteStride")&&(y=y.then(v=>(v.byteStride=g.byteStride,v))),n&&(y=y.then(v=>(n(g,v),v))),s.push(y)}return s};class c2{static parse(e,t,s,i,a,n,r){Bse(e,s,(l,u)=>{if(l){r(l);return}Nse(u.gltfChunk,(f,_)=>{if(f){r(f);return}const g=Ose(_,u.binaryChunk,t,n),y=Use(_,g,n),v=Lse(_,y,t,a,n),x=Ise(_,v,n);Mse(i,_,y,x,n).then(C=>r(null,C)).catch(C=>r(C))})})}static createDefaultMaterial(){return q8({name:"defaultGlbMaterial"},[])}}class X8 extends Ps{constructor(e){super(e,"animation"),this.device=e.graphicsDevice,this.assets=e.assets}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(bt.getExtension(e.original).toLowerCase()===".glb"?i.responseType=Wn.ResponseType.ARRAY_BUFFER:i.responseType=Wn.ResponseType.JSON),Us.get(e.load,i,(a,n)=>{a?t(`Error loading animation resource: ${e.original} [${a}]`):bt.getExtension(e.original).toLowerCase()===".glb"?c2.parse("filename.glb","",n,this.device,this.assets,(s==null?void 0:s.options)??{},(r,l)=>{var u;if(r)t(r);else{const f=l.animations;if((u=s==null?void 0:s.data)!=null&&u.events)for(let _=0;_<f.length;_++)f[_].events=new YP(Object.values(s.data.events));l.destroy(),t(null,f)}}):t(null,this[`_parseAnimationV${n.animation.version}`](n))})}open(e,t,s){return t}_parseAnimationV3(e){const t=e.animation,s=new c3;s.name=t.name,s.duration=t.duration;for(let i=0;i<t.nodes.length;i++){const a=new h3,n=t.nodes[i];a._name=n.name;for(let r=0;r<n.keys.length;r++){const l=n.keys[r],u=l.time,f=l.pos,_=l.rot,g=l.scale,y=new H(f[0],f[1],f[2]),v=new Ne().setFromEulerAngles(_[0],_[1],_[2]),x=new H(g[0],g[1],g[2]),C=new l3(u,y,v,x);a._keys.push(C)}s.addNode(a)}return s}_parseAnimationV4(e){const t=e.animation,s=new c3;s.name=t.name,s.duration=t.duration;for(let i=0;i<t.nodes.length;i++){const a=new h3,n=t.nodes[i];a._name=n.name;const r=n.defaults.p,l=n.defaults.r,u=n.defaults.s;for(let f=0;f<n.keys.length;f++){const _=n.keys[f],g=_.t,y=r||_.p,v=l||_.r,x=u||_.s,C=new H(y[0],y[1],y[2]),M=new Ne().setFromEulerAngles(v[0],v[1],v[2]),w=new H(x[0],x[1],x[2]),T=new l3(g,C,M,w);a._keys.push(T)}s.addNode(a)}return s}}class j8 extends Ps{constructor(e){super(e,"animclip")}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=Wn.ResponseType.JSON),Us.get(e.load,s,(i,a)=>{i?t(`Error loading animation clip resource: ${e.original} [${i}]`):t(null,a)})}open(e,t){const s=t.name,i=t.duration,a=t.inputs.map(l=>new v1(1,l)),n=t.outputs.map(l=>new v1(l.components,l.data)),r=t.curves.map(l=>new oL([l.path],l.inputIndex,l.outputIndex,l.interpolation));return new wh(s,i,a,n,r)}}class Y8 extends Ps{constructor(e){super(e,"animstategraph")}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=Wn.ResponseType.JSON),Us.get(e.load,s,(i,a)=>{i?t(`Error loading animation state graph resource: ${e.original} [${i}]`):t(null,a)})}open(e,t){return new vb(t)}}const XR=function(){if(typeof window>"u")return!1;const h=window.navigator.userAgent,e=h.indexOf("MSIE ");if(e>0)return parseInt(h.substring(e+5,h.indexOf(".",e)),10);if(h.indexOf("Trident/")>0){const s=h.indexOf("rv:");return parseInt(h.substring(s+3,h.indexOf(".",s)),10)}return!1}(),zse=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"];class K8 extends Ps{constructor(e){super(e,"audio"),this.manager=e.soundManager}_isSupported(e){const t=bt.getExtension(e);return zse.indexOf(t)>-1}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=function(a){t(null,new ZB(a))},i=function(a){let n=`Error loading audio url: ${e.original}`;a&&(n+=`: ${a.message||a}`),console.warn(n),t(n)};if(this._createSound){if(!this._isSupported(e.original)){i(`Audio format for ${e.original} not supported`);return}this._createSound(e.load,s,i)}else i(null)}_createSound(e,t,s){if(Zc()){const i=this.manager;if(!i.context){s("Audio manager has no audio context");return}const a={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(a.responseType=Wn.ResponseType.ARRAY_BUFFER),Us.get(e,a,(n,r)=>{if(n){s(n);return}i.context.decodeAudioData(r,t,s)})}else{let i=null;try{i=new Audio}catch{s("No support for Audio element");return}XR&&document.body.appendChild(i);const a=function(){i.removeEventListener("canplaythrough",a),XR&&document.body.removeChild(i),t(i)};i.onerror=function(){i.onerror=null,XR&&document.body.removeChild(i),s()},i.addEventListener("canplaythrough",a),i.src=e}}}class Q8 extends Ps{constructor(e){super(e,"binary")}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Us.get(e.load,{responseType:Wn.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading binary resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return e.buffer}}class Sd{constructor(e,t,s,i){const a=function(u,f,_){const g=Sd.createAsset(t.name,u,f,_);return s.add(g),g},n=[];for(let u=0;u<e.renders.length;++u)n.push(a("render",e.renders[u],u));const r=[];for(let u=0;u<e.materials.length;++u)r.push(a("material",e.materials[u],u));const l=[];for(let u=0;u<e.animations.length;++u)l.push(a("animation",e.animations[u],u));this.data=e,this._model=null,this._assetName=t.name,this._assets=s,this._defaultMaterial=i,this.renders=n,this.materials=r,this.textures=e.textures,this.animations=l}get model(){if(!this._model){const e=Sd.createModel(this.data,this._defaultMaterial),t=Sd.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}static createAsset(e,t,s,i){const a=new Ye(`${e}/${t}/${i}`,t,{url:""});return a.resource=s,a.loaded=!0,a}instantiateModelEntity(e){const t=new Kt(void 0,this._assets._loader._app);return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){const t=this._defaultMaterial,s=[],i=function(r,l,u,f,_,g,y,v){const x=_[u.id],C=x===void 0?t:f[x],M=new ps(u,C);u.morph&&(M.morphInstance=new jd(u.morph)),y.hasOwnProperty("skin")&&s.push({meshInstance:M,rootBone:r,entity:l});const w=v.get(y);if(w){const T=w.matrices,R=en.getDefaultInstancingFormat(u.device),D=new jn(u.device,R,T.length/16,{data:T});M.setInstancing(D),M.instancingData._destroyVertexBuffer=!0}return M},a=(r,l,u)=>{const f=new Kt(void 0,this._assets._loader._app);l._cloneInternal(f),r||(r=f);let _=null,g=null;for(let v=0;v<u.nodes.length;v++)if(u.nodes[v]===l){const C=u.gltf.nodes[v];if(C.hasOwnProperty("mesh")){const M=u.renders[C.mesh].meshes;g=this.renders[C.mesh];for(let w=0;w<M.length;w++){const T=M[w];if(T){const R=i(r,f,T,u.materials,u.meshDefaultMaterials,u.skins,C,u.nodeInstancingMap);_||(_=[]),_.push(R)}}}if(u.lights){const M=u.lights.get(C);M&&f.addChild(M.clone())}if(u.cameras){const M=u.cameras.get(C);M&&M.camera.system.cloneComponent(M,f)}}_&&(f.addComponent("render",Object.assign({type:"asset",meshInstances:_},e)),f.render.assignAsset(g));const y=l.children;for(let v=0;v<y.length;v++){const x=a(r,y[v],u);f.addChild(x)}return f},n=[];for(const r of this.data.scenes)n.push(a(null,r,this.data));return s.forEach(r=>{r.meshInstance.skinInstance=f1.createCachedSkinInstance(r.meshInstance.mesh.skin,r.rootBone,r.entity),r.meshInstance.node.render.rootBone=r.rootBone}),Sd.createSceneHierarchy(n,Kt)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){const s=t?this.data.variants[t]:null;if(s===void 0)return;const i=e.findComponents("render");for(let a=0;a<i.length;a++){const n=i[a];this._applyMaterialVariant(s,n.meshInstances)}}applyMaterialVariantInstances(e,t){const s=t?this.data.variants[t]:null;s!==void 0&&this._applyMaterialVariant(s,e)}_applyMaterialVariant(e,t){t.forEach(s=>{if(e===null)s.material=this._defaultMaterial;else{const i=this.data.meshVariants[s.mesh.id];i&&(s.material=this.data.materials[i[e]])}})}static createSceneHierarchy(e,t){let s=null;if(e.length===1)s=e[0];else{s=new t("SceneGroup");for(const i of e)s.addChild(i)}return s}static createModel(e,t){const s=function(n,r,l,u,f,_,g){const y=e.meshDefaultMaterials[r.id],v=y===void 0?t:f[y],x=new ps(r,v,_);if(r.morph){const C=new jd(r.morph);x.morphInstance=C,n.morphInstances.push(C)}if(g.hasOwnProperty("skin")){const C=g.skin,M=l[C];r.skin=M;const w=u[C];x.skinInstance=w,n.skinInstances.push(w)}n.meshInstances.push(x)},i=new Lh,a=[];for(const n of e.skins){const r=new oy(n);r.bones=n.bones,a.push(r)}i.graph=Sd.createSceneHierarchy(e.scenes,Jt);for(let n=0;n<e.nodes.length;n++){const r=e.nodes[n];if(r.root===i.graph){const l=e.gltf.nodes[n];if(l.hasOwnProperty("mesh")){const u=e.renders[l.mesh].meshes;for(let f=0;f<u.length;f++){const _=u[f];_&&s(i,_,e.skins,a,e.materials,r,l)}}}}return i}destroy(){const e=this._assets,t=function(i){e.remove(i),i.unload()},s=function(i){i.forEach(a=>{t(a)})};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null}}class kse{constructor(e,t,s){this._device=e,this._assets=t,this._defaultMaterial=c2.createDefaultMaterial(),this.maxRetries=s}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,s){Ye.fetchArrayBuffer(e.load,(i,a)=>{i?t(i):c2.parse(this._getUrlWithoutParams(e.original),bt.extractPath(e.load),a,this._device,s.registry,s.options,(n,r)=>{n?t(n):t(null,new Sd(r,s,this._assets,this._defaultMaterial))})},s,this.maxRetries)}open(e,t,s){return t}patch(e,t){}}class Vse{instantiateModelEntity(e){return null}instantiateRenderEntity(e){return null}getMaterialVariants(){return null}applyMaterialVariant(e,t){}applyMaterialVariantInstances(e,t){}}class $8 extends Ps{constructor(e){super(e,"container"),this.glbContainerParser=new kse(e.graphicsDevice,e.assets,0),this.parsers={}}set maxRetries(e){this.glbContainerParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=e?bt.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return this._getParser(e).open(e,t,s)}}class Z8 extends Ps{constructor(e){super(e,"css"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Us.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading css resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}class J8 extends Ps{constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,t,s){this.loadAssets(s,t)}open(e,t,s){return s?s.resource:null}patch(e,t){this.loadAssets(e,(s,i)=>{s&&(t.fire("error",e),t.fire(`error:${e.id}`,s,e),e.fire("error",e))})}getAssetIds(e){const t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let s=0;s<6;++s)t[s+1]=e.data.textures[s];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||typeof e=="string"?e===t:e.url===t.url:e!==null==(t!==null)}update(e,t,s){const i=e.data||{},a=e._handlerState.assets,n=e._resources;let r,l,u;const f=[null,null,null,null,null,null,null],_=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?Eh:vr:null};if(!e.loaded||s[0]!==a[0]){if(s[0])if(r=s[0].resource,r.cubemap)for(u=0;u<6;++u)f[u+1]=new Ge(this._device,{name:`${e.name}_prelitCubemap${r.width>>u}`,cubemap:!0,type:_()||r.type,width:r.width>>u,height:r.height>>u,format:r.format,levels:[r._levels[u]],addressU:Oe,addressV:Oe,mipmaps:u===0});else f[1]=r}else f[1]=n[1]||null,f[2]=n[2]||null,f[3]=n[3]||null,f[4]=n[4]||null,f[5]=n[5]||null,f[6]=n[6]||null;const g=s.slice(1);if(!e.loaded||!this.cmpArrays(g,a.slice(1))){if(g.indexOf(null)===-1){const y=g.map(M=>M.resource),v=[];for(l=0;l<y[0]._levels.length;++l)v.push(y.map(M=>M._levels[l]));const x=y[0].format,C=new Ge(this._device,{name:`${e.name}_faces`,cubemap:!0,type:_()||y[0].type,width:y[0].width,height:y[0].height,format:x===pl?Lt:x,mipmaps:i.mipmaps??!0,levels:v,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:y[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:y[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:Oe,addressV:Oe});f[0]=C}}else f[0]=n[0]||null;if(!this.cmpArrays(f,n))for(e.resources=f,e._handlerState.assetIds=t,e._handlerState.assets=s,u=0;u<n.length;++u)n[u]!==null&&f.indexOf(n[u])===-1&&n[u].destroy();for(u=0;u<a.length;++u)a[u]!==null&&s.indexOf(a[u])===-1&&a[u].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0}resolveId(e){const t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(e),a=[null,null,null,null,null,null,null],n=e._handlerState.assetIds,r=e._handlerState.assets,l=s._registry;let u=7;const f=function(v,x){a[v]=x,u--,u===0&&(s.update(e,i,a),t(null,e.resources))},_=function(v,x,C){t(x)},g=function(v,x){x.loaded?f(v,x):(l.once(`load:${x.id}`,f.bind(s,v)),l.once(`error:${x.id}`,_.bind(s,v)),x.loading||l.load(x))};let y;for(let v=0;v<7;++v){const x=this.resolveId(i[v]);if(!x)f(v,null);else if(s.compareAssetIds(x,n[v]))g(v,r[v]);else if(parseInt(x,10)===x)y=l.get(x),y?g(v,y):setTimeout(((C,M)=>{const w=l.get(M);w?g(C,w):_(C,`failed to find dependent cubemap asset=${M}`)}).bind(null,v,x));else{const C=typeof x=="string"?{url:x,filename:x}:x,M=C.url.search(".dds")===-1?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:!1}:null;y=new Ye(`${e.name}_part_${v}`,"texture",C,M),l.add(y),g(v,y)}}}}class e6 extends Ps{constructor(e){super(e,"folder")}load(e,t){t(null,null)}}class X3{constructor(e,t){this.type=t&&t.type||u1,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t}set data(e){if(this._data=e,!!e&&(this._data.intensity!==void 0&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const t in this._data.chars)this._data.chars[t].map=0}get data(){return this._data}}function jR(h){return h.version<3&&(h.version<2&&(h.info.maps=h.info.maps||[{width:h.info.width,height:h.info.height}]),h.chars=Object.keys(h.chars||{}).reduce((e,t)=>{const s=h.chars[t],i=s.letter!==void 0?s.letter:Ed.fromCodePoint(t);return h.version<2&&(s.map=s.map||0),e[i]=s,e},{}),h.version=3),h}class t6 extends Ps{constructor(e){super(e,"font"),this._loader=e.loader,this.maxRetries=0}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i=this;bt.getExtension(e.original)===".json"?Us.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(a,n)=>{if(a)t(`Error loading font resource: ${e.original} [${a}]`);else{const r=jR(n);i._loadTextures(e.load.replace(".json",".png"),r,(l,u)=>{l?t(l):t(null,{data:r,textures:u})})}}):(s&&s.data&&(s.data=jR(s.data)),this._loadTextures(e.load,s&&s.data,t))}_loadTextures(e,t,s){const i=t.info.maps.length;let a=0,n=null;const r=new Array(i),l=this._loader,u=function(f){const _=function(g,y){if(!n){if(g){n=g,s(g);return}y.upload(),r[f]=y,a++,a===i&&s(null,r)}};f===0?l.load(e,"texture",_):l.load(e.replace(".png",`${f}.png`),"texture",_)};for(let f=0;f<i;f++)u(f)}open(e,t,s){let i;return t.textures?i=new X3(t.textures,t.data):i=new X3(t,null),i}patch(e,t){const s=e.resource;!s.data&&e.data?s.data=e.data:!e.data&&s.data&&(e.data=s.data),e.data&&(e.data=jR(e.data))}}const YR=.28209479177387814;class Gse{constructor(e,t,s,i,a,n){const r=(R,D)=>{const I=(1<<D)-1;return(R&I)/I},l=(R,D)=>{R.x=r(D>>>21,11),R.y=r(D>>>11,10),R.z=r(D,11)},u=(R,D)=>{R.x=r(D>>>24,8),R.y=r(D>>>16,8),R.z=r(D>>>8,8),R.w=r(D,8)},f=(R,D)=>{const I=1/(Math.sqrt(2)*.5),U=(r(D>>>20,10)-.5)*I,O=(r(D>>>10,10)-.5)*I,N=(r(D,10)-.5)*I,z=Math.sqrt(1-(U*U+O*O+N*N));switch(D>>>30){case 0:R.set(U,O,N,z);break;case 1:R.set(z,O,N,U);break;case 2:R.set(O,z,N,U);break;case 3:R.set(O,N,z,U);break}},_=(R,D,I)=>R*(1-I)+D*I,{chunkData:g,chunkSize:y,vertexData:v,shData0:x,shData1:C,shData2:M,shBands:w}=e,T=[3,8,15][w-1];this.read=R=>{const D=Math.floor(R/256)*y;if(t&&(l(t,v[R*4+0]),t.x=_(g[D+0],g[D+3],t.x),t.y=_(g[D+1],g[D+4],t.y),t.z=_(g[D+2],g[D+5],t.z)),s&&f(s,v[R*4+1]),i&&(l(i,v[R*4+2]),i.x=_(g[D+6],g[D+9],i.x),i.y=_(g[D+7],g[D+10],i.y),i.z=_(g[D+8],g[D+11],i.z)),a&&(u(a,v[R*4+3]),y>12&&(a.x=_(g[D+12],g[D+15],a.x),a.y=_(g[D+13],g[D+16],a.y),a.z=_(g[D+14],g[D+17],a.z))),n&&w>0){const I=[x,C,M];for(let U=0;U<3;++U)for(let O=0;O<15;++O)n[U*15+O]=O<T?I[U][R*16+O]*(8/255)-4:0}}}}class Hse{createIter(e,t,s,i,a){return new Gse(this,e,t,s,i,a)}calcAabb(e){const{chunkData:t,numChunks:s,chunkSize:i}=this;let a=Math.exp(Math.max(t[9],t[10],t[11])),n=t[0]-a,r=t[1]-a,l=t[2]-a,u=t[3]+a,f=t[4]+a,_=t[5]+a;for(let g=1;g<s;++g){const y=g*i;a=Math.exp(Math.max(t[y+9],t[y+10],t[y+11])),n=Math.min(n,t[y+0]-a),r=Math.min(r,t[y+1]-a),l=Math.min(l,t[y+2]-a),u=Math.max(u,t[y+3]+a),f=Math.max(f,t[y+4]+a),_=Math.max(_,t[y+5]+a)}return e.center.set((n+u)*.5,(r+f)*.5,(l+_)*.5),e.halfExtents.set((u-n)*.5,(f-r)*.5,(_-l)*.5),!0}getCenters(e){const{vertexData:t,chunkData:s,numChunks:i,chunkSize:a}=this;let n,r,l,u,f,_;for(let g=0;g<i;++g){const y=g*a;n=s[y+0],r=s[y+1],l=s[y+2],u=s[y+3],f=s[y+4],_=s[y+5];const v=Math.min(this.numSplats,(g+1)*256);for(let x=g*256;x<v;++x){const C=t[x*4],M=(C>>>21)/2047,w=(C>>>11&1023)/1023,T=(C&2047)/2047;e[x*3+0]=(1-M)*n+M*u,e[x*3+1]=(1-w)*r+w*f,e[x*3+2]=(1-T)*l+T*_}}}getChunks(e){const{chunkData:t,numChunks:s,chunkSize:i}=this;let a,n,r,l,u,f;for(let _=0;_<s;++_){const g=_*i;a=t[g+0],n=t[g+1],r=t[g+2],l=t[g+3],u=t[g+4],f=t[g+5],e[_*6+0]=a,e[_*6+1]=n,e[_*6+2]=r,e[_*6+3]=l,e[_*6+4]=u,e[_*6+5]=f}}calcFocalPoint(e){const{chunkData:t,numChunks:s,chunkSize:i}=this;e.x=0,e.y=0,e.z=0;for(let a=0;a<s;++a){const n=a*i;e.x+=t[n+0]+t[n+3],e.y+=t[n+1]+t[n+4],e.z+=t[n+2]+t[n+5]}e.mulScalar(.5/s)}get isCompressed(){return!0}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}decompress(){const e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){const f=[];for(let _=0;_<45;++_)f.push(`f_rest_${_}`);e.splice(e.indexOf("f_dc_0")+1,0,...f)}const s={};e.forEach(f=>{s[f]=new Float32Array(this.numSplats)});const i=new H,a=new Ne,n=new H,r=new Ie,l=t>0?new Float32Array(45):null,u=this.createIter(i,a,n,r,l);for(let f=0;f<this.numSplats;++f)if(u.read(f),s.x[f]=i.x,s.y[f]=i.y,s.z[f]=i.z,s.rot_1[f]=a.x,s.rot_2[f]=a.y,s.rot_3[f]=a.z,s.rot_0[f]=a.w,s.scale_0[f]=n.x,s.scale_1[f]=n.y,s.scale_2[f]=n.z,s.f_dc_0[f]=(r.x-.5)/YR,s.f_dc_1[f]=(r.y-.5)/YR,s.f_dc_2[f]=(r.z-.5)/YR,s.opacity[f]=r.w<=0?-40:r.w>=1?40:-Math.log(1/r.w-1),l)for(let _=0;_<45;++_)s[`f_rest_${_}`][f]=l[_];return new Qd([{name:"vertex",count:this.numSplats,properties:e.map(f=>({name:f,type:"float",byteSize:4,storage:s[f]}))}])}}const Wse=(h,e,t,s,i)=>{for(let a=0;a<i;++a)for(let n=0;n<s;++n)h[a*e+n]=t[a*s+n]};class qse{constructor(e,t){const{chunkData:s,chunkSize:i,numChunks:a,numSplats:n,vertexData:r,shBands:l}=t;this.device=e,this.numSplats=n,this.numSplatsVisible=n,this.aabb=new wt,t.calcAabb(this.aabb),this.centers=new Float32Array(n*3),t.getCenters(this.centers),this.chunks=new Float32Array(a*6),t.getChunks(this.chunks),this.packedTexture=this.createTexture("packedData",kn,this.evalTextureSize(n),r);const u=this.evalTextureSize(a);u.x*=5,this.chunkTexture=this.createTexture("chunkData",Ri,u);const f=this.chunkTexture.lock();if(Wse(f,20,s,i,a),i===12)for(let _=0;_<a;++_)f[_*20+15]=1,f[_*20+16]=1,f[_*20+17]=1;if(this.chunkTexture.unlock(),l>0){const _=this.evalTextureSize(n);this.shTexture0=this.createTexture("shTexture0",kn,_,new Uint32Array(t.shData0.buffer)),this.shTexture1=this.createTexture("shTexture1",kn,_,new Uint32Array(t.shData1.buffer)),this.shTexture2=this.createTexture("shTexture2",kn,_,new Uint32Array(t.shData2.buffer))}else this.shTexture0=null,this.shTexture1=null,this.shTexture2=null}destroy(){var e,t,s,i,a;(e=this.packedTexture)==null||e.destroy(),(t=this.chunkTexture)==null||t.destroy(),(s=this.shTexture0)==null||s.destroy(),(i=this.shTexture1)==null||i.destroy(),(a=this.shTexture2)==null||a.destroy()}createMaterial(e){const t=zP(e);return t.setDefine("GSPLAT_COMPRESSED_DATA",!0),t.setParameter("packedTexture",this.packedTexture),t.setParameter("chunkTexture",this.chunkTexture),t.setParameter("numSplats",this.numSplatsVisible),this.shTexture0?(t.setDefine("SH_BANDS",3),t.setParameter("shTexture0",this.shTexture0),t.setParameter("shTexture1",this.shTexture1),t.setParameter("shTexture2",this.shTexture2)):t.setDefine("SH_BANDS",0),t}evalTextureSize(e){const t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new Ee(t,s)}createTexture(e,t,s,i){return new Ge(this.device,{name:e,width:s.x,height:s.y,format:t,cubemap:!1,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe,...i?{levels:[i]}:{}})}}class Xse{constructor(e,t){this.device=e,this.gsplatData=t;const{meta:s}=t;this.numSplats=s.means.shape[0],this.numSplatsVisible=this.numSplats,this.aabb=new wt,t.calcAabb(this.aabb),this.centers=new Float32Array(this.numSplats*3),t.getCenters(this.centers)}destroy(){}createMaterial(e){const{gsplatData:t}=this,s=zP(e);return s.setDefine("GSPLAT_SOGS_DATA",!0),s.setDefine("SH_BANDS",this.gsplatData.shBands),["means_l","means_u","quats","scales","sh0","sh_centroids","sh_labels"].forEach(i=>{s.setParameter(i,t[i])}),["means","scales","sh0","shN"].forEach(i=>{const a=t.meta[i];a&&(s.setParameter(`${i}_mins`,a.mins),s.setParameter(`${i}_maxs`,a.maxs))}),s}evalTextureSize(e){return new Ee(this.gsplatData.means_l.width,this.gsplatData.means_l.height)}createTexture(e,t,s){return new Ge(this.device,{name:e,width:s.x,height:s.y,format:t,cubemap:!1,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe})}}class lL{constructor(e,t,s){this.splat=null,this.comments=null,this.app=e,this.splatData=t,this.comments=s}destroy(){var e;this.app=null,this.splatData=null,(e=this.splat)==null||e.destroy(),this.splat=null}createSplat(){if(!this.splat){const{app:e,splatData:t}=this,s=t.isCompressed?qse:t.isSogs?Xse:ZU;this.splat=new s(e.graphicsDevice,t)}return this.splat}instantiate(e={}){const t=this.createInstance(e),s=new Kt(void 0,this.app),i=s.addComponent("gsplat",{instance:t});return s.setLocalEulerAngles(0,0,180),i.customAabb=t.splat.aabb.clone(),s}createInstance(e={}){const t=this.createSplat();return new WC(t,e)}}const P4=new Uint8Array([112,108,121,10]),L4=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),j3=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]);class jse{constructor(e,t){this.head=0,this.tail=0,this.reader=e,this.progressFunc=t}async read(){var s;const{value:e,done:t}=await this.reader.read();if(t)throw new Error("Stream finished before end of header");this.push(e),(s=this.progressFunc)==null||s.call(this,e.byteLength)}push(e){if(!this.data)this.data=e,this.view=new DataView(this.data.buffer),this.tail=e.length;else{const t=this.tail-this.head,s=t+e.length;if(this.data.length>=s)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(e,t),this.head=0,this.tail=s):(this.data.set(e,this.tail),this.tail+=e.length);else{const i=new Uint8Array(s);this.head>0||this.tail<this.data.length?i.set(this.data.subarray(this.head,this.tail),0):i.set(this.data,0),i.set(e,t),this.data=i,this.view=new DataView(this.data.buffer),this.head=0,this.tail=s}}}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0)}get remaining(){return this.tail-this.head}getInt8(){const e=this.view.getInt8(this.head);return this.head++,e}getUint8(){const e=this.view.getUint8(this.head);return this.head++,e}getInt16(){const e=this.view.getInt16(this.head,!0);return this.head+=2,e}getUint16(){const e=this.view.getUint16(this.head,!0);return this.head+=2,e}getInt32(){const e=this.view.getInt32(this.head,!0);return this.head+=4,e}getUint32(){const e=this.view.getUint32(this.head,!0);return this.head+=4,e}getFloat32(){const e=this.view.getFloat32(this.head,!0);return this.head+=4,e}getFloat64(){const e=this.view.getFloat64(this.head,!0);return this.head+=8,e}}const Yse=h=>{const e=[],t=[];let s;for(let i=1;i<h.length;++i){const a=h[i].split(" ");switch(a[0]){case"comment":t.push(a.slice(1).join(" "));break;case"format":s=a[1];break;case"element":e.push({name:a[1],count:parseInt(a[2],10),properties:[]});break;case"property":{if(!j3.has(a[1]))throw new Error(`Unrecognized property data type '${a[1]}' in ply header`);e[e.length-1].properties.push({type:a[1],name:a[2],storage:null,byteSize:j3.get(a[1]).BYTES_PER_ELEMENT});break}default:throw new Error(`Unrecognized header value '${a[0]}' in ply header`)}}return{elements:e,format:s,comments:t}},Kse=h=>{const e=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],t=["packed_position","packed_rotation","packed_scale","packed_color"],s=new Array(45).fill("").map((n,r)=>`f_rest_${r}`),i=()=>h[0].name==="chunk"&&h[0].properties.every((n,r)=>n.name===e[r]&&n.type==="float")&&h[1].name==="vertex"&&h[1].properties.every((n,r)=>n.name===t[r]&&n.type==="uint"),a=()=>h[2].name==="sh"&&[9,24,45].indexOf(h[2].properties.length)!==-1&&h[2].properties.every((n,r)=>n.name===s[r]&&n.type==="uchar");return h.length===2&&i()||h.length===3&&i()&&a()},Qse=h=>h.length===1&&h[0].name==="vertex"&&h[0].properties.every(e=>e.type==="float"),$se=async(h,e)=>{const t=new Hse,s=e[0].count,i=e[0].properties.length,a=e[1].count,r=(u=>{const f=Math.ceil(Math.sqrt(u)),_=Math.ceil(u/f);return f*_})(a);t.numSplats=a,t.chunkData=new Float32Array(s*i),t.vertexData=new Uint32Array(r*4);const l=async(u,f)=>{const _=new Uint8Array(u);let g=0;for(;g<f;){for(;h.remaining===0;)await h.read();const y=Math.min(f-g,h.remaining),v=h.data;for(let x=0;x<y;++x)_[g++]=v[h.head++]}};if(await l(t.chunkData.buffer,s*i*4),await l(t.vertexData.buffer,a*4*4),e.length===3){const u=r*16,f=new Uint8Array(u),_=new Uint8Array(u),g=new Uint8Array(u),y=1024,v=e[2].properties.length/3,x=new Uint8Array(y*v*3);for(let C=0;C<t.numSplats;C+=y){const M=Math.min(y,t.numSplats-C);await l(x.buffer,M*v*3);for(let w=0;w<M;++w)for(let T=0;T<15;++T){const R=(C+w)*16+T;T<v?(f[R]=x[(w*3+0)*v+T],_[R]=x[(w*3+1)*v+T],g[R]=x[(w*3+2)*v+T]):(f[R]=127,_[R]=127,g[R]=127)}}t.shData0=f,t.shData1=_,t.shData2=g,t.shBands={3:1,8:2,15:3}[v]}else t.shBands=0;return t},Zse=async(h,e)=>{const t=e[0],s=t.properties,i=s.length,a=s.map(f=>f.storage),n=s.reduce((f,_)=>f+_.byteSize,0);let r=0,l;const u=()=>{const f=h.data.buffer;(l==null?void 0:l.buffer)!==f&&(l=new Float32Array(f,0,f.byteLength/4))};for(u();r<t.count;){for(;h.remaining<n;)await h.read(),u();const f=Math.min(t.count-r,Math.floor(h.remaining/n));for(let _=0;_<i;++_){const g=a[_];for(let y=0;y<f;++y)g[y+r]=l[y*i+_]}r+=f,h.head+=f*n}return new Qd(e)},Jse=async(h,e)=>{for(let t=0;t<e.length;++t){const s=e[t],i=s.properties.reduce((r,l)=>r+l.byteSize,0),a=s.properties.map(r=>{if(r.storage)switch(r.type){case"char":return(l,u)=>{r.storage[u]=l.getInt8()};case"uchar":return(l,u)=>{r.storage[u]=l.getUint8()};case"short":return(l,u)=>{r.storage[u]=l.getInt16()};case"ushort":return(l,u)=>{r.storage[u]=l.getUint16()};case"int":return(l,u)=>{r.storage[u]=l.getInt32()};case"uint":return(l,u)=>{r.storage[u]=l.getUint32()};case"float":return(l,u)=>{r.storage[u]=l.getFloat32()};case"double":return(l,u)=>{r.storage[u]=l.getFloat64()};default:throw new Error(`Unsupported property data type '${r.type}' in ply header`)}else return l=>{l.head+=r.byteSize}});let n=0;for(;n<s.count;){for(;h.remaining<i;)await h.read();const r=Math.min(s.count-n,Math.floor(h.remaining/i));for(let l=0;l<r;++l){for(let u=0;u<s.properties.length;++u)a[u](h,n);n++}}}return new Qd(e)},eie=async(h,e=null,t=null)=>{const s=(g,y)=>{const v=g.length-y.length;let x,C;for(x=0;x<=v;++x){for(C=0;C<y.length&&g[x+C]===y[C];++C);if(C===y.length)return x}return-1},i=(g,y)=>{if(g.length<y.length)return!1;for(let v=0;v<y.length;++v)if(g[v]!==y[v])return!1;return!0},a=new jse(h,t);let n;for(;;){if(await a.read(),a.tail>=P4.length&&!i(a.data,P4))throw new Error("Invalid ply header");if(n=s(a.data,L4),n!==-1)break}const r=new TextDecoder("ascii").decode(a.data.subarray(0,n)).split(`
`),{elements:l,format:u,comments:f}=Yse(r);if(u!=="binary_little_endian")throw new Error("Unsupported ply format");return a.head=n+L4.length,a.compact(),{data:await(async()=>Kse(l)?await $se(a,l):(l.forEach(g=>{g.properties.forEach(y=>{const v=j3.get(y.type);if(v){const x=!e||e(y.name)?new v(g.count):null;y.storage=x}})}),Qse(l)?await Zse(a,l):await Jse(a,l)))(),comments:f}},tie=h=>!0;class sie{constructor(e,t){this.app=e,this.maxRetries=t}async load(e,t,s){var i;try{const a=await(((i=s.file)==null?void 0:i.contents)??fetch(e.load));if(!a||!a.body)t("Error loading resource",null);else{const n=parseInt(a.headers.get("content-length")??"0",10);let r=0;const{data:l,comments:u}=await eie(a.body.getReader(),s.data.elementFilter??tie,_=>{r+=_,s&&s.fire("progress",r,n)});l.isCompressed||(s.data.reorder??!0)&&l.reorderData();const f=new lL(this.app,l.isCompressed&&s.data.decompress?l.decompress():l,u);t(null,f)}}catch(a){t(a,null)}}open(e,t){return t}}class iie{constructor(e,t){this.app=e,this.maxRetries=t}async loadTextures(e,t,s,i){var _,g,y,v,x,C;const{assets:a}=this.app,n=["means","quats","scales","sh0","shN"],r={},l=[];n.forEach(M=>{var T;const w=((T=i[M])==null?void 0:T.files)??[];r[M]=w.map(R=>{var U,O;const D=new Ye(R,"texture",{url:((O=(U=s.options)==null?void 0:U.mapUrl)==null?void 0:O.call(U,R))??new URL(R,e.load).toString(),filename:R},{mipmaps:!1}),I=new Promise((N,z)=>{D.on("load",()=>N(null)),D.on("error",X=>z(X))});return a.add(D),a.load(D),l.push(I),D})}),await Promise.allSettled(l);const u=new JU;u.meta=i,u.numSplats=i.means.shape[0],u.means_l=r.means[0].resource,u.means_u=r.means[1].resource,u.quats=r.quats[0].resource,u.scales=r.scales[0].resource,u.sh0=r.sh0[0].resource,u.sh_centroids=(g=(_=r.shN)==null?void 0:_[0])==null?void 0:g.resource,u.sh_labels=(v=(y=r.shN)==null?void 0:y[1])==null?void 0:v.resource,(((x=s.data)==null?void 0:x.reorder)??!0)&&await u.reorderData();const f=new lL(this.app,(C=s.data)!=null&&C.decompress?await u.decompress():u,[]);t(null,f)}load(e,t,s){var i;if((i=s.data)!=null&&i.means)this.loadTextures(e,t,s,s.data);else{typeof e=="string"&&(e={load:e,original:e});const a={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:Wn.ResponseType.JSON};Us.get(e.load,a,(n,r)=>{n?t(`Error loading gsplat meta: ${e.original} [${n}]`):this.loadTextures(e,t,s,r)})}}}class s6 extends Ps{constructor(e){super(e,"gsplat"),this.parsers={ply:new sie(e,3),json:new iie(e,3)}}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=bt.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.parsers.ply}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return t}}class Y3{static setCompressedPRS(e,t,s){const i=s.singleVecs;let a,n;const r=t.___1;r||(a=s.tripleVecs,n=t.___2);let l=r?r[0]:a[n];e.setLocalPosition(i[l],i[l+1],i[l+2]),l=r?r[1]:a[n+1],e.setLocalEulerAngles(i[l],i[l+1],i[l+2]),l=r?r[2]:a[n+2],e.setLocalScale(i[l],i[l+1],i[l+2])}static oneCharToKey(e,t){const s=e.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[s]}static multCharToKey(e,t){let s=0;for(let i=0;i<e.length;i++)s=s*t.fieldCodeBase+e.charCodeAt(i)-t.fieldFirstCode;return t.fieldArray[s]}}class u2{constructor(e,t){this._node=e,this._data=t}run(){const e=Object.prototype.toString.call(this._node);return e==="[object Object]"?this._handleMap():e==="[object Array]"?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={},Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(e){let t=e;const s=e.length;s===1?t=Y3.oneCharToKey(e,this._data):s===2&&(t=Y3.multCharToKey(e,this._data)),this._result[t]=new u2(this._node[e],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(e){const t=new u2(e,this._data).run();this._result.push(t)}}class hL{constructor(e,t){this._app=e,this._isTemplate=t}parse(e){const t={};let s=null;const i=e.compressedFormat;i&&!e.entDecompressed&&(e.entDecompressed=!0,e.entities=new u2(e.entities,i).run());for(const a in e.entities){const n=e.entities[a],r=this._createEntity(n,i);t[a]=r,n.parent===null&&(s=r)}for(const a in e.entities){const n=t[a],r=e.entities[a].children,l=r.length;for(let u=0;u<l;u++){const f=t[r[u]];f&&n.addChild(f)}}return this._openComponentData(s,e.entities),s}_createEntity(e,t){const s=new Kt(e.name,this._app);if(s.setGuid(e.resource_id),this._setPosRotScale(s,e,t),s._enabled=e.enabled??!0,this._isTemplate?s._template=!0:s._enabledInHierarchy=s._enabled,s.template=e.template,e.tags)for(let i=0;i<e.tags.length;i++)s.tags.add(e.tags[i]);return s}_setPosRotScale(e,t,s){if(s)Y3.setCompressedPRS(e,t,s);else{const i=t.position,a=t.rotation,n=t.scale;e.setLocalPosition(i[0],i[1],i[2]),e.setLocalEulerAngles(a[0],a[1],a[2]),e.setLocalScale(n[0],n[1],n[2])}}_openComponentData(e,t){const s=this._app.systems.list;let i=s.length;const a=t[e.getGuid()];for(let r=0;r<i;r++){const l=s[r],u=a.components[l.id];u&&l.addComponent(e,u)}i=a.children.length;const n=e._children;for(let r=0;r<i;r++)n[r]&&(n[r]=this._openComponentData(n[r],t));return e}}class cL{static load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),Us.get(e.load,{retry:t>0,maxRetries:t},(i,a)=>{if(!i)s(i,a);else{let n=`Error while loading scene JSON ${e.original}`;i.message?(n+=`: ${i.message}`,i.stack&&(n+=`
${i.stack}`)):n+=`: ${i}`,s(n)}})}}class i6 extends Ps{constructor(e){super(e,"hierarchy")}load(e,t){cL.load(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;const i=new hL(this._app,!1).parse(t);return this._app.systems.script.preloading=!1,i}}class a6 extends Ps{constructor(e){super(e,"html"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Us.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading html resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}class n6 extends Ps{constructor(e){super(e,"json"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=Wn.ResponseType.JSON),Us.get(e.load,s,(i,a)=>{i?t(`Error loading JSON resource: ${e.original} [${i}]`):t(null,a)})}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),JSON.parse(this.decoder.decode(e))}}class aie{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([yP,ay,vP]),cull:this._createEnumValidator([Xs,jc,e0,TF]),blendType:this._createEnumValidator([gC,yC,xr,Gn,Wd,vC,SC,bC,xC,TC,EC]),depthFunc:this._createEnumValidator([EF,Nb,Fb,RA,AF,CF,wF,Sh])}}setInvalid(e,t){this.valid=!1,this.removeInvalid&&delete t[e]}validate(e){const t=M0,s=BZ,i=e.mappingFormat==="path";for(const a in e){const n=t[a];if(!n){s[a]?delete e[a]:this.valid=!1;continue}if(n.startsWith("enum")){const r=n.split(":")[1];this.enumValidators[r]&&(this.enumValidators[r](e[a])||this.setInvalid(a,e))}else if(n==="number")typeof e[a]!="number"&&this.setInvalid(a,e);else if(n==="boolean")typeof e[a]!="boolean"&&this.setInvalid(a,e);else if(n==="string")typeof e[a]!="string"&&this.setInvalid(a,e);else if(n==="vec2")e[a]instanceof Array&&e[a].length===2||this.setInvalid(a,e);else if(n==="rgb")e[a]instanceof Array&&e[a].length===3||this.setInvalid(a,e);else if(n==="texture")i?typeof e[a]=="string"||e[a]===null||e[a]instanceof Ge||this.setInvalid(a,e):typeof e[a]=="number"||e[a]===null||e[a]instanceof Ge||this.setInvalid(a,e);else if(n==="boundingbox")e[a].center&&e[a].center instanceof Array&&e[a].center.length===3||this.setInvalid(a,e),e[a].halfExtents&&e[a].halfExtents instanceof Array&&e[a].halfExtents.length===3||this.setInvalid(a,e);else if(n==="cubemap")typeof e[a]=="number"||e[a]===null||e[a]===void 0||e[a]instanceof Ge&&e[a].cubemap||this.setInvalid(a,e);else if(n==="chunks"){const r=Object.keys(e[a]);for(let l=0;l<r.length;l++)typeof e[a][r[l]]!="string"&&this.setInvalid(r[l],e[a])}else console.error(`Unknown material type: ${n}`)}return e.validated=!0,this.valid}_createEnumValidator(e){return function(t){return e.indexOf(t)>=0}}}class r6{constructor(){this._validator=null}parse(e){const t=this.migrate(e),s=this._validate(t),i=new Vi;return this.initialize(i,s),i}initialize(e,t){t.validated||(t=this._validate(t)),t.chunks&&(e.chunks={...t.chunks});for(const s in t){const i=M0[s],a=t[s];if(i==="vec2")e[s]=new Ee(a[0],a[1]);else if(i==="rgb")e[s]=new xe(a[0],a[1],a[2]);else if(i==="texture")a instanceof Ge?e[s]=a:e[s]instanceof Ge&&typeof a=="number"&&a>0||(e[s]=null);else if(i==="cubemap")a instanceof Ge?e[s]=a:e[s]instanceof Ge&&typeof a=="number"&&a>0||(e[s]=null),s==="cubeMap"&&!a&&(e.prefilteredCubemaps=null);else if(i==="boundingbox"){const n=new H(a.center[0],a.center[1],a.center[2]),r=new H(a.halfExtents[0],a.halfExtents[1],a.halfExtents[2]);e[s]=new wt(n,r)}else e[s]=t[s]}e.update()}migrate(e){e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);let t;const s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["specularMapTint","specularTint"],["metalnessMapTint","metalnessTint"],["clearCoatGlossiness","clearCoatGloss"]];for(t=0;t<s.length;t++){const a=s[t][0],n=s[t][1];e[a]!==void 0&&(e[n]===void 0&&(e[n]=e[a]),delete e[a])}const i=["fresnelFactor","shadowSampleType"];for(t=0;t<i.length;t++){const a=i[t];e.hasOwnProperty(a)&&delete e[a]}return e}_validate(e){return e.validated||(this._validator||(this._validator=new aie),this._validator.validate(e)),e}}const nie={aoMap:"white",aoDetailMap:"white",diffuseMap:"gray",diffuseDetailMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",normalDetailMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white",thicknessMap:"black",iridescenceMap:"black",iridescenceThicknessMap:"black",envAtlas:"black"};class o6 extends Ps{constructor(e){super(e,"material"),this._assets=e.assets,this._device=e.graphicsDevice,this._parser=new r6}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Us.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t&&t(`Error loading material: ${e.original} [${s}]`):t&&(i._engine=!0,t(null,i))})}open(e,t){const s=this._parser.parse(t);return t._engine&&(s._data=t,delete t._engine),s}patch(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this)}_onAssetUnload(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name}_assignTexture(e,t,s){t.resource[e]=s}_getPlaceholderTexture(e){const t=nie[e];return Xp(this._device,t)}_assignPlaceholderTexture(e,t){t.resource[e]=this._getPlaceholderTexture(e)}_onTextureLoad(e,t,s){this._assignTexture(e,t,s.resource),t.resource.update()}_onTextureAdd(e,t,s){this._assets.load(s)}_onTextureRemoveOrUnload(e,t,s){const i=t.resource;i&&t.resource[e]===s.resource&&(this._assignPlaceholderTexture(e,t),i.update())}_assignCubemap(e,t,s){if(t.resource[e]=s[0],e==="cubeMap"){const i=s.slice(1);i.every(a=>a)?t.resource.prefilteredCubemaps=i:i[0]&&(t.resource.envAtlas=i[0])}}_onCubemapLoad(e,t,s){this._assignCubemap(e,t,s.resources),this._parser.initialize(t.resource,t.data)}_onCubemapAdd(e,t,s){this._assets.load(s)}_onCubemapRemoveOrUnload(e,t,s){const i=t.resource;t.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(e,t){const s=this._parser.migrate(e.data),i=e.resource,a=s.mappingFormat==="path",n=GC;let r,l,u;for(r=0;r<n.length;r++){l=n[r],u=i._assetReferences[l];const _=s[l],g=i[l],y=g===this._getPlaceholderTexture(l),v=s.validated;_&&(!g||!v||y)?(u||(u=new P0(l,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[l]=u),a?u.url=e.getAbsoluteUrl(_):u.id=_,u.asset&&(u.asset.resource?this._assignTexture(l,e,u.asset.resource):this._assignPlaceholderTexture(l,e),t.load(u.asset))):u&&(a?u.url=null:u.id=null)}const f=NP;for(r=0;r<f.length;r++)l=f[r],u=i._assetReferences[l],s[l]&&!e.data.prefilteredCubeMap128&&(u||(u=new P0(l,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[l]=u),a?u.url=s[l]:u.id=s[l],u.asset&&(u.asset.loaded&&this._assignCubemap(l,e,u.asset.resources),t.load(u.asset)));this._parser.initialize(i,s)}}class rie{constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial,this._assets=e.assets}parse(e,t,s){c2.parse("filename.glb","",e,this._device,this._assets,(s==null?void 0:s.options)??{},(i,a)=>{if(i)t(i);else{const n=Sd.createModel(a,this._defaultMaterial);a.destroy(),t(null,n)}})}}const oie={points:Y0,lines:X1,lineloop:PD,linestrip:oC,triangles:al,trianglestrip:hl,trianglefan:wd},lie={int8:ml,uint8:io,int16:_l,uint16:Dh,int32:jt,uint32:Ai,float32:it};class hie{constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial}parse(e,t){const s=e.model;if(!s){t(null,null);return}if(s.version<=1){t("JsonModelParser#parse: Trying to parse unsupported model format.");return}const i=this._parseNodes(e),a=this._parseSkins(e,i),n=this._parseVertexBuffers(e),r=this._parseIndexBuffers(e,n),l=this._parseMorphs(e,i,n),u=this._parseMeshes(e,a.skins,l.morphs,n,r.buffer,r.data),f=this._parseMeshInstances(e,i,u,a.skins,a.instances,l.morphs,l.instances),_=new Lh;_.graph=i[0],_.meshInstances=f,_.skinInstances=a.instances,_.morphInstances=l.instances,_.getGraph().syncHierarchy(),t(null,_)}_parseNodes(e){const t=e.model,s=[];let i;for(i=0;i<t.nodes.length;i++){const a=t.nodes[i],n=new Jt(a.name);n.setLocalPosition(a.position[0],a.position[1],a.position[2]),n.setLocalEulerAngles(a.rotation[0],a.rotation[1],a.rotation[2]),n.setLocalScale(a.scale[0],a.scale[1],a.scale[2]),n.scaleCompensation=!!a.scaleCompensation,s.push(n)}for(i=1;i<t.parents.length;i++)s[t.parents[i]].addChild(s[i]);return s}_parseSkins(e,t){const s=e.model,i=[],a=[];let n,r;for(n=0;n<s.skins.length;n++){const l=s.skins[n],u=[];for(r=0;r<l.inverseBindMatrices.length;r++){const y=l.inverseBindMatrices[r];u[r]=new Me().set(y)}const f=new OP(this._device,u,l.boneNames);i.push(f);const _=new oy(f),g=[];for(r=0;r<f.boneNames.length;r++){const y=f.boneNames[r],v=t[0].findByName(y);g.push(v)}_.bones=g,a.push(_)}return{skins:i,instances:a}}_getMorphVertexCount(e,t,s){for(let i=0;i<e.meshes.length;i++){const a=e.meshes[i];if(a.morph===t)return s[a.vertices].numVertices}}_parseMorphs(e,t,s){const i=e.model,a=[],n=[];let r,l,u,f,_,g;if(i.morphs){const y=function(v,x,C){const M=new Float32Array(C*3);for(let w=0;w<x.length;w++){const T=x[w]*3;M[T]=v[w*3],M[T+1]=v[w*3+1],M[T+2]=v[w*3+2]}return M};for(r=0;r<i.morphs.length;r++){for(f=i.morphs[r].targets,g=[],u=this._getMorphVertexCount(i,r,s),l=0;l<f.length;l++){const C=f[l].aabb,M=C.min,w=C.max,T=new wt(new H((w[0]+M[0])*.5,(w[1]+M[1])*.5,(w[2]+M[2])*.5),new H((w[0]-M[0])*.5,(w[1]-M[1])*.5,(w[2]-M[2])*.5)),R=f[l].indices;let D=f[l].deltaPositions,I=f[l].deltaNormals;R&&(D=y(D,R,u),I=y(I,R,u)),_=new yx({deltaPositions:D,deltaNormals:I,name:f[l].name,aabb:T}),g.push(_)}const v=new VC(g,this._device);a.push(v);const x=new jd(v);n.push(x)}}return{morphs:a,instances:n}}_parseVertexBuffers(e){const t=e.model,s=[],i={position:kt,normal:$a,tangent:po,blendWeight:co,blendIndices:gn,color:Qi,texCoord0:Za,texCoord1:Mh,texCoord2:Rm,texCoord3:Mm,texCoord4:Dm,texCoord5:Pm,texCoord6:Lm,texCoord7:Im};for(let a=0;a<t.vertices.length;a++){const n=t.vertices[a],r=[];for(const g in n){const y=n[g];r.push({semantic:i[g],components:y.components,type:lie[y.type],normalize:i[g]===Qi})}const l=new en(this._device,r),u=n.position.data.length/n.position.components,f=new jn(this._device,l,u),_=new i0(f);for(let g=0;g<u;g++){for(const y in n){const v=n[y];switch(v.components){case 1:_.element[i[y]].set(v.data[g]);break;case 2:_.element[i[y]].set(v.data[g*2],1-v.data[g*2+1]);break;case 3:_.element[i[y]].set(v.data[g*3],v.data[g*3+1],v.data[g*3+2]);break;case 4:_.element[i[y]].set(v.data[g*4],v.data[g*4+1],v.data[g*4+2],v.data[g*4+3]);break}}_.next()}_.end(),s.push(f)}return s}_parseIndexBuffers(e,t){const s=e.model;let i=null,a=null,n,r=0;for(n=0;n<s.meshes.length;n++){const u=s.meshes[n];u.indices!==void 0&&(r+=u.indices.length)}let l=0;for(n=0;n<t.length;n++)l=Math.max(l,t[n].numVertices);return r>0&&(l>65535?(i=new Ah(this._device,Th,r),a=new Uint32Array(i.lock())):(i=new Ah(this._device,ho,r),a=new Uint16Array(i.lock()))),{buffer:i,data:a}}_parseMeshes(e,t,s,i,a,n){const r=e.model,l=[];let u=0;for(let f=0;f<r.meshes.length;f++){const _=r.meshes[f],g=_.aabb,y=g.min,v=g.max,x=new wt(new H((v[0]+y[0])*.5,(v[1]+y[1])*.5,(v[2]+y[2])*.5),new H((v[0]-y[0])*.5,(v[1]-y[1])*.5,(v[2]-y[2])*.5)),C=_.indices!==void 0,M=new Ft(this._device);M.vertexBuffer=i[_.vertices],M.indexBuffer[0]=C?a:null,M.primitive[0].type=oie[_.type],M.primitive[0].base=C?_.base+u:_.base,M.primitive[0].count=_.count,M.primitive[0].indexed=C,M.skin=_.skin!==void 0?t[_.skin]:null,M.morph=_.morph!==void 0?s[_.morph]:null,M.aabb=x,C&&(n.set(_.indices,u),u+=_.indices.length),l.push(M)}return a!==null&&a.unlock(),l}_parseMeshInstances(e,t,s,i,a,n,r){const l=e.model,u=[];let f;for(f=0;f<l.meshInstances.length;f++){const _=l.meshInstances[f],g=t[_.node],y=s[_.mesh],v=new ps(y,this._defaultMaterial,g);if(y.skin){const x=i.indexOf(y.skin);v.skinInstance=a[x]}if(y.morph){const x=n.indexOf(y.morph);v.morphInstance=r[x]}u.push(v)}return u}}class l6 extends Ps{constructor(e){super(e,"model"),this._parsers=[],this.device=e.graphicsDevice,this.assets=e.assets,this.defaultMaterial=ly(this.device),this.addParser(new hie(this),(t,s)=>bt.getExtension(t)===".json"),this.addParser(new rie(this),(t,s)=>bt.getExtension(t)===".glb")}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(bt.getExtension(e.original).toLowerCase()===".glb"?i.responseType=Wn.ResponseType.ARRAY_BUFFER:i.responseType=Wn.ResponseType.JSON),Us.get(e.load,i,(a,n)=>{if(t)if(a)t(`Error loading model: ${e.original} [${a}]`);else{for(let r=0;r<this._parsers.length;r++){const l=this._parsers[r];if(l.decider(e.original,n)){l.parser.parse(n,(u,f)=>{u?t(u):t(null,f)},s);return}}t("No parsers found")}})}open(e,t){return t}patch(e,t){if(!e.resource)return;const s=e.data,i=this;e.resource.meshInstances.forEach((a,n)=>{if(s.mapping){const r=function(_){_.resource?a.material=_.resource:(_.once("load",r),t.load(_)),_.once("remove",g=>{a.material===g.resource&&(a.material=i.defaultMaterial)})};if(!s.mapping[n]){a.material=i.defaultMaterial;return}const l=s.mapping[n].material,u=s.mapping[n].path;let f;if(l!==void 0)l?(f=t.get(l),f?r(f):t.once(`add:${l}`,r)):a.material=i.defaultMaterial;else if(u){const _=e.getAbsoluteUrl(s.mapping[n].path);f=t.getByUrl(_),f?r(f):t.once(`add:url:${_}`,r)}}})}addParser(e,t){this._parsers.push({parser:e,decider:t})}}class h6 extends Ps{constructor(e){super(e,"scene")}load(e,t){cL.load(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;const i=new hL(this._app,!1).parse(t),a=this._app.scene;return a.root=i,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=!1,a}}const U2=class U2{static push(e){U2._types.push(e)}};U2._types=[];let Vp=U2;const uL=new Set(["system","entity","create","destroy","swap","move","data","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);function cie(){return uL}function c6(h,e){if(uL.has(h))throw new Error(`Script name '${h}' is reserved, please rename the script`);const t=function(s){Qe.prototype.initEventHandler.call(this),Ld.prototype.initScriptType.call(this,s)};return t.prototype=Object.create(Ld.prototype),t.prototype.constructor=t,t.extend=Ld.extend,t.attributes=new gm(t),d0(t,h,e),t}const u6={};gm.reservedNames.forEach((h,e,t)=>{u6[h]=1});c6.reservedAttributes=u6;function d0(h,e,t){if(typeof h!="function")throw new Error(`script class: '${h}' must be a constructor function (i.e. class).`);if(!(h.prototype instanceof Rh))throw new Error(`script class: '${Ld.__getScriptName(h)}' does not extend pc.Script.`);if(e=e||h.__name||Ld.__getScriptName(h),uL.has(e))throw new Error(`script name: '${e}' is reserved, please change script name`);h.__name=e,(t?t.scripts:fo.getApplication().scripts).add(h),Vp.push(h)}const uie=h=>h[0].toLowerCase()+h.substring(1);class d6 extends Ps{constructor(e){super(e,"script"),this._scripts={},this._cache={}}clearCache(){for(const e in this._cache){const t=this._cache[e],s=t.parentNode;s&&s.removeChild(t)}this._cache={}}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=this;VP.app=this._app;const i=(e.load,(r,l,u)=>{if(r)t(r);else{const f={};for(let g=0;g<Vp._types.length;g++)f[Vp._types[g].name]=Vp._types[g];Vp._types.length=0,t(null,f,u);const _=l.split("&hash=")[0];delete s._loader._cache[Yp.makeKey(_,"script")]}}),[a]=e.load.split("?");a.endsWith(".mjs")?this._loadModule(a,i):this._loadScript(e.load,i)}open(e,t){return t}patch(e,t){}_loadScript(e,t){const s=document.head,i=document.createElement("script");this._cache[e]=i,i.async=!1,i.addEventListener("error",n=>{t(`Script: ${n.target.src} failed to load`)},!1);let a=!1;i.onload=i.onreadystatechange=function(){!a&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")&&(a=!0,t(null,e,i))},i.src=e,s.appendChild(i)}_loadModule(e,t){const i=Ct.browser&&window.location.origin!=="null"?window.location.origin+window.location.pathname:import.meta.url,a=new URL(e,i);import(a.toString()).then(n=>{var u,f;const r=a.pathname.split("/").pop(),l=(f=(u=this._app.assets.find(r,"script"))==null?void 0:u.data)==null?void 0:f.scripts;for(const _ in n){const g=n[_];if(g.prototype instanceof Rh){const v=uie(g.name);d0(g,v),l&&this._app.scripts.addSchema(v,l[v])}}t(null,e,null)}).catch(n=>{t(n)})}}class f6 extends Ps{constructor(e){super(e,"shader"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Us.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading shader resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}function KR(h){const e=this;e.resource&&(e.resource.atlas=h.resource)}function QR(h){this.registry.load(h)}class p6 extends Ps{constructor(e){super(e,"sprite"),this._assets=e.assets,this._device=e.graphicsDevice}load(e,t){typeof e=="string"&&(e={load:e,original:e}),bt.getExtension(e.original)===".json"&&Us.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(s):t(null,i)})}open(e,t){const s=new jU(this._device);return e&&(s.__data=t),s}patch(e,t){const s=e.resource;if(s.__data&&(e.data.pixelsPerUnit=s.__data.pixelsPerUnit,e.data.renderMode=s.__data.renderMode,e.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){const i=t.getByUrl(s.__data.textureAtlasAsset);i?e.data.textureAtlasAsset=i.id:console.warn(`Could not find textureatlas with url: ${s.__data.textureAtlasAsset}`)}s.startUpdate(),s.renderMode=e.data.renderMode,s.pixelsPerUnit=e.data.pixelsPerUnit,s.frameKeys=e.data.frameKeys,this._updateAtlas(e),s.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_updateAtlas(e){const t=e.resource;if(!e.data.textureAtlasAsset){t.atlas=null;return}this._assets.off(`load:${e.data.textureAtlasAsset}`,KR,e),this._assets.on(`load:${e.data.textureAtlasAsset}`,KR,e);const s=this._assets.get(e.data.textureAtlasAsset);s&&s.resource?t.atlas=s.resource:s?this._assets.load(s):(this._assets.off(`add:${e.data.textureAtlasAsset}`,QR,e),this._assets.on(`add:${e.data.textureAtlasAsset}`,QR,e))}_onAssetChange(e,t,s,i){t==="data"&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off(`load:${i.textureAtlasAsset}`,KR,e),this._assets.off(`add:${i.textureAtlasAsset}`,QR,e))}}class K3{constructor(e,t){this._templateRoot=null,this._app=e,this._data=t}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){const e=new hL(this._app,!0);this._templateRoot=e.parse(this._data)}}class m6 extends Ps{constructor(e){super(e,"template"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};Us.get(e.load,s,(i,a)=>{i?t(`Error requesting template: ${e.original}`):t(i,a)})}open(e,t){return new K3(this._app,t)}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),new K3(this._app,JSON.parse(this.decoder.decode(e)))}}class _6 extends Ps{constructor(e){super(e,"text"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Us.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading text resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}const VE={repeat:Zs,clamp:Oe,mirror:O0},GE={nearest:Je,linear:Vt,nearest_mip_nearest:vm,linear_mip_nearest:bm,nearest_mip_linear:Sm,linear_mip_linear:lo},die=/^data\.frames\.(\d+)$/;class g6 extends Ps{constructor(e){super(e,"textureatlas"),this._loader=e.loader}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=this,i=this._loader.getHandler("texture");bt.getExtension(e.original)===".json"?Us.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(a,n)=>{if(a)t(a);else{const r=e.original.replace(".json",".png");s._loader.load(r,"texture",(l,u)=>{l?t(l):t(null,{data:n,texture:u})})}}):i.load(e,t)}open(e,t,s){const i=new YU;if(t.texture&&t.data)i.texture=t.texture,i.__data=t.data;else{const n=this._loader.getHandler("texture").open(e,t,s);if(!n)return null;i.texture=n}return i}patch(e,t){if(!e.resource)return;e.resource.__data&&(e.resource.__data.minfilter!==void 0&&(e.data.minfilter=e.resource.__data.minfilter),e.resource.__data.magfilter!==void 0&&(e.data.magfilter=e.resource.__data.magfilter),e.resource.__data.addressu!==void 0&&(e.data.addressu=e.resource.__data.addressu),e.resource.__data.addressv!==void 0&&(e.data.addressv=e.resource.__data.addressv),e.resource.__data.mipmaps!==void 0&&(e.data.mipmaps=e.resource.__data.mipmaps),e.resource.__data.anisotropy!==void 0&&(e.data.anisotropy=e.resource.__data.anisotropy),e.resource.__data.rgbm!==void 0&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);const s=e.resource.texture;if(s&&(s.name=e.name,e.data.hasOwnProperty("minfilter")&&s.minFilter!==GE[e.data.minfilter]&&(s.minFilter=GE[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&s.magFilter!==GE[e.data.magfilter]&&(s.magFilter=GE[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&s.addressU!==VE[e.data.addressu]&&(s.addressU=VE[e.data.addressu]),e.data.hasOwnProperty("addressv")&&s.addressV!==VE[e.data.addressv]&&(s.addressV=VE[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&s.mipmaps!==e.data.mipmaps&&(s.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&s.anisotropy!==e.data.anisotropy&&(s.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){const a=e.data.rgbm?Eh:vr;s.type!==a&&(s.type=a)}e.resource.texture=s;const i={};for(const a in e.data.frames){const n=e.data.frames[a];i[a]={rect:new Ie(n.rect),pivot:new Ee(n.pivot),border:new Ie(n.border)}}e.resource.frames=i,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_onAssetChange(e,t,s){let i;if(t==="data"||t==="data.frames"){const a={};for(const n in s.frames)i=s.frames[n],a[n]={rect:new Ie(i.rect),pivot:new Ee(i.pivot),border:new Ie(i.border)};e.resource.frames=a}else{const a=t.match(die);if(a){const n=a[1];s?(e.resource.frames[n]?(i=e.resource.frames[n],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):e.resource.frames[n]={rect:new Ie(s.rect),pivot:new Ee(s.pivot),border:new Ie(s.border)},e.resource.fire("set:frame",n,e.resource.frames[n])):e.resource.frames[n]&&(delete e.resource.frames[n],e.resource.fire("remove:frame",n))}}}}function fie(){const h={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16},e={astc:h.cTFASTC_4x4,dxt:h.cTFBC1,etc1:h.cTFETC1,etc2:h.cTFETC1,pvr:h.cTFPVRTC1_4_RGB,atc:h.cTFATC_RGB,none:h.cTFRGB565},t={astc:h.cTFASTC_4x4,dxt:h.cTFBC3,etc1:h.cTFRGBA4444,etc2:h.cTFETC2,pvr:h.cTFPVRTC1_4_RGBA,atc:h.cTFATC_RGBA_INTERPOLATED_ALPHA,none:h.cTFRGBA4444},s={ETC1:21,ETC2_RGB:22,ETC2_RGBA:23,DXT1:8,DXT5:10,PVRTC_4BPP_RGB_1:26,PVRTC_4BPP_RGBA_1:27,ASTC_4x4:28,ATC_RGB:29,ATC_RGBA:30,R8_G8_B8_A8:7,R5_G6_B5:3,R4_G4_B4_A4:5},i=(R,D)=>{switch(R){case h.cTFETC1:return D.formats.etc2?s.ETC2_RGB:s.ETC1;case h.cTFETC2:return s.ETC2_RGBA;case h.cTFBC1:return s.DXT1;case h.cTFBC3:return s.DXT5;case h.cTFPVRTC1_4_RGB:return s.PVRTC_4BPP_RGB_1;case h.cTFPVRTC1_4_RGBA:return s.PVRTC_4BPP_RGBA_1;case h.cTFASTC_4x4:return s.ASTC_4x4;case h.cTFATC_RGB:return s.ATC_RGB;case h.cTFATC_RGBA_INTERPOLATED_ALPHA:return s.ATC_RGBA;case h.cTFRGBA32:return s.R8_G8_B8_A8;case h.cTFRGB565:return s.R5_G6_B5;case h.cTFRGBA4444:return s.R4_G4_B4_A4}},a=R=>{const D=function(I,U){const O=I*.00784313725490196-1,N=U*(2/255)-1,z=Math.sqrt(1-Math.min(1,O*O+N*N));return Math.max(0,Math.min(255,Math.floor((z+1)*.5*255)))};for(let I=0;I<R.length;I+=4){const U=R[I+3],O=R[I+1];R[I+0]=U,R[I+2]=D(U,O),R[I+3]=255}return R},n=R=>{const D=new Uint16Array(R.length/4);for(let I=0;I<R.length;I+=4){const U=R[I+0],O=R[I+1],N=R[I+2];D[I/4]=(U&248)<<8|(O&252)<<3|N>>3}return D},r=(R,D)=>(R&R-1)===0&&(D&D-1)===0,l=()=>typeof performance<"u"?performance.now():0;let u,f,_;const g=(R,D,I)=>{if(I){if(R.formats.astc)return"astc"}else if(D){if(R.formats.etc2)return"etc2"}else{if(R.formats.etc2)return"etc2";if(R.formats.etc1)return"etc1"}return(O=>{for(let N=0;N<O.length;++N){const z=O[N];if(R.formats[z])return z}return"none"})(D?_:f)},y=(R,D,I)=>{switch(I){case h.cTFETC1:case h.cTFETC2:return!0;case h.cTFBC1:case h.cTFBC3:return(R&3)===0&&(D&3)===0;case h.cTFPVRTC1_4_RGB:case h.cTFPVRTC1_4_RGBA:return r(R,D);case h.cTFASTC_4x4:return!0;case h.cTFATC_RGB:case h.cTFATC_RGBA_INTERPOLATED_ALPHA:return!0}return!1},v=(R,D,I)=>{if(!u.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const U=l(),O=new u.KTX2File(new Uint8Array(D)),N=O.getWidth(),z=O.getHeight(),X=O.getLevels(),Y=!!O.getHasAlpha(),F=O.isUASTC&&O.isUASTC();if(!N||!z||!X)throw O.close(),O.delete(),new Error(`Invalid image dimensions url=${R} width=${N} height=${z} levels=${X}`);const q=g(I.deviceDetails,Y,F),G=!!I.isGGGR&&q==="pvr";let W;if(G?W=h.cTFRGBA32:(W=Y?t[q]:e[q],y(N,z,W)||(W=Y?h.cTFRGBA32:h.cTFRGB565)),!O.startTranscoding())throw O.close(),O.delete(),new Error(`Failed to start transcoding url=${R}`);let k;const K=[];for(let ee=0;ee<X;++ee){const V=O.getImageTranscodedSizeInBytes(ee,0,0,W),Q=new Uint8Array(V);if(!O.transcodeImage(Q,ee,0,0,W,0,-1,-1))throw O.close(),O.delete(),new Error(`Failed to transcode image url=${R}`);const se=W===h.cTFRGB565||W===h.cTFRGBA4444;K.push(se?new Uint16Array(Q.buffer):Q)}if(O.close(),O.delete(),G)for(W=h.cTFRGB565,k=0;k<K.length;++k)K[k]=n(a(K[k]));return{format:i(W,I.deviceDetails),width:N,height:z,levels:K,cubemap:!1,transcodeTime:l()-U,url:R,unswizzledGGGR:G}},x=(R,D,I)=>{const U=l(),O=new u.BasisFile(new Uint8Array(D)),N=O.getImageWidth(0,0),z=O.getImageHeight(0,0),X=O.getNumImages(),Y=O.getNumLevels(0),F=!!O.getHasAlpha(),q=O.isUASTC&&O.isUASTC();if(!N||!z||!X||!Y)throw O.close(),O.delete(),new Error(`Invalid image dimensions url=${R} width=${N} height=${z} images=${X} levels=${Y}`);const G=g(I.deviceDetails,F,q),W=!!I.isGGGR&&G==="pvr";let k;if(W?k=h.cTFRGBA32:(k=F?t[G]:e[G],y(N,z,k)||(k=F?h.cTFRGBA32:h.cTFRGB565)),!O.startTranscoding())throw O.close(),O.delete(),new Error(`Failed to start transcoding url=${R}`);let K;const ee=[];for(let V=0;V<Y;++V){const Q=O.getImageTranscodedSizeInBytes(0,V,k),se=new Uint8Array(Q);if(!O.transcodeImage(se,0,V,k,0,0))if(V===Y-1&&Q===ee[V-1].buffer.byteLength)se.set(new Uint8Array(ee[V-1].buffer)),console.warn(`Failed to transcode last mipmap level, using previous level instead url=${R}`);else throw O.close(),O.delete(),new Error(`Failed to transcode image url=${R}`);const J=k===h.cTFRGB565||k===h.cTFRGBA4444;ee.push(J?new Uint16Array(se.buffer):se)}if(O.close(),O.delete(),W)for(k=h.cTFRGB565,K=0;K<ee.length;++K)ee[K]=n(a(ee[K]));return{format:i(k,I.deviceDetails),width:N,height:z,levels:ee,cubemap:!1,transcodeTime:l()-U,url:R,unswizzledGGGR:W}},C=(R,D,I)=>I.isKTX2?v(R,D,I):x(R,D,I),M=(R,D,I)=>{try{const U=C(R,D,I);U.levels=U.levels.map(O=>O.buffer),self.postMessage({url:R,data:U},U.levels)}catch(U){self.postMessage({url:R,err:U},null)}},w=(R,D)=>{const I=(U,O)=>(WebAssembly.instantiate(R.module,U).then(N=>{O(N)}).catch(N=>{console.error(`instantiate failed + ${N}`)}),{});self.BASIS(R.module?{instantiateWasm:I}:null).then(U=>{U.initializeBasis(),u=U,f=R.rgbPriority,_=R.rgbaPriority,D(null)})},T=[];self.onmessage=R=>{const D=R.data;switch(D.type){case"init":w(D.config,()=>{for(let I=0;I<T.length;++I)M(T[I].url,T[I].data,T[I].options);T.length=0});break;case"transcode":u?M(D.url,D.data,D.options):T.push(D);break}}}const pie=h=>({astc:!!h.extCompressedTextureASTC,atc:!!h.extCompressedTextureATC,dxt:!!h.extCompressedTextureS3TC,etc1:!!h.extCompressedTextureETC1,etc2:!!h.extCompressedTextureETC,pvr:!!h.extCompressedTexturePVRTC}),mie=(h,e)=>{const t=n=>{const r=["/* basis */",n,"",`(${fie.toString()})()

`].join(`
`);return new Blob([r],{type:"application/javascript"})},s=()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){const n=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(n instanceof WebAssembly.Module)return new WebAssembly.Instance(n)instanceof WebAssembly.Instance}}catch{}return!1},i=(n,r)=>{e(null,{workerUrl:URL.createObjectURL(t(n)),module:r,rgbPriority:h.rgbPriority,rgbaPriority:h.rgbaPriority})},a={cache:!0,responseType:"text",retry:h.maxRetries>0,maxRetries:h.maxRetries};if(h.glueUrl&&h.wasmUrl&&s()){let n=null,r=null;Us.get(h.glueUrl,a,(f,_)=>{f?e(f):r?i(_,r):n=_});const l=fetch(h.wasmUrl),u=()=>{l.then(f=>f.arrayBuffer()).then(f=>WebAssembly.compile(f)).then(f=>{n?i(n,f):r=f}).catch(f=>{e(f,null)})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(l).then(f=>{n?i(n,f):r=f}).catch(f=>{u()}):u()}else Us.get(h.fallbackUrl,a,(n,r)=>{n?e(n,null):i(r,null)})};class _ie{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(e,t,s,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(s);else{this.callbacks[e]=[s];const a={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(a):this.queue.push(a)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(e,t,s){const i=this.callbacks[e];if(t)for(let a=0;a<i.length;++a)i[a](t);else{s.format===xm||s.format===Tm?s.levels=s.levels.map(a=>new Uint16Array(a)):s.levels=s.levels.map(a=>new Uint8Array(a));for(let a=0;a<i.length;++a)i[a](null,s)}delete this.callbacks[e]}}class gie{constructor(e,t,s){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",i=>{const a=i.data;this.queue.handleResponse(a.url,a.err,a.data),this.eager||this.queue.enqueueClient(this)}),this.worker.postMessage({type:"init",config:t}),this.eager=s}run(e){const t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}}const yie=1,vie=["etc2","etc1","astc","dxt","pvr","atc"],Sie=["astc","dxt","etc2","pvr","atc"],bie=5,Q3=new _ie;let I4=null,$3=!1;function dL(h){if(!$3){if(!h)h=I4||{};else if(h.lazyInit){I4=h;return}if(!h.glueUrl||!h.wasmUrl||!h.fallbackUrl){const e=Pb.getConfig("BASIS");e&&(h={glueUrl:e.glueUrl,wasmUrl:e.wasmUrl,fallbackUrl:e.fallbackUrl,numWorkers:e.numWorkers})}if(h.glueUrl||h.wasmUrl||h.fallbackUrl){$3=!0;const e=Math.max(1,Math.min(16,h.numWorkers||yie)),t=h.numWorkers===1||(h.hasOwnProperty("eagerWorkers")?h.eagerWorkers:!0);h.rgbPriority=h.rgbPriority||vie,h.rgbaPriority=h.rgbaPriority||Sie,h.maxRetries=h.hasOwnProperty("maxRetries")?h.maxRetries:bie,mie(h,(s,i)=>{if(s)console.error(`failed to initialize basis worker: ${s}`);else for(let a=0;a<e;++a)Q3.enqueueClient(new gie(Q3,i,t))})}}}let $R=null;function y6(h,e,t,s,i){return dL(),$R||($R={formats:pie(h)}),Q3.enqueueJob(e,t,s,{deviceDetails:$R,isGGGR:!!(i!=null&&i.isGGGR),isKTX2:!!(i!=null&&i.isKTX2)}),$3}class fy{load(e,t,s){throw new Error("not implemented")}open(e,t,s){throw new Error("not implemented")}}class xie extends fy{constructor(e,t){super(),this.device=t,this.maxRetries=0}load(e,t,s){const i=this.device,a=n=>{var l,u,f;y6(i,e.load,n,t,{isGGGR:(((f=(u=(l=s==null?void 0:s.file)==null?void 0:l.variants)==null?void 0:u.basis)==null?void 0:f.opt)&8)!==0})||t(`Basis module not found. Asset [${s.name}](${s.getFileUrl()}) basis texture variant will not be loaded.`)};Ye.fetchArrayBuffer(e.load,(n,r)=>{n?t(n):a(r)},s,this.maxRetries)}open(e,t,s,i={}){const a=i.srgb?q1(t.format):t.format,n=new Ge(s,{name:e,addressU:t.cubemap?Oe:Zs,addressV:t.cubemap?Oe:Zs,width:t.width,height:t.height,format:a,cubemap:t.cubemap,levels:t.levels,...i});return n.upload(),n}}class Tie extends fy{constructor(e,t){super(),this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t}load(e,t,s){var r;const i=!!((r=s==null?void 0:s.file)!=null&&r.contents);if(i){if(this.device.supportsImageBitmap){this._loadImageBitmapFromBlob(new Blob([s.file.contents]),t);return}e={load:URL.createObjectURL(new Blob([s.file.contents])),original:e.original}}const a=(l,u)=>{i&&URL.revokeObjectURL(e.load),t(l,u)};let n;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?n=s.options.crossOrigin:_m.test(e.load)&&(n=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,n,a):this._loadImage(e.load,e.original,n,a)}open(e,t,s,i={}){const a=new Ge(s,{name:e,width:t.width,height:t.height,format:i.srgb?ki:Lt,...i});return a.setSource(t),a}_loadImage(e,t,s,i){const a=new Image;s&&(a.crossOrigin=s);let n=0;const r=this.maxRetries;let l;a.onload=function(){i(null,a)},a.onerror=function(){if(!l)if(r>0&&++n<=r){const u=Math.pow(2,n)*100;console.log(`Error loading Texture from: '${t}' - Retrying in ${u}ms...`);const _=e.indexOf("?")>=0?"&":"?";l=setTimeout(()=>{a.src=`${e+_}retry=${Date.now()}`,l=null},u)}else i(`Error loading Texture from: '${t}'`)},a.src=e}_loadImageBitmap(e,t,s,i){const a={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};Us.get(e,a,(n,r)=>{n?i(n):this._loadImageBitmapFromBlob(r,i)})}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(s=>t(null,s)).catch(s=>t(s))}}const ZR=[1481919403,3140563232,169478669],Eie={33776:z0,33778:C1,33779:Em,36196:G0,37492:R1,37496:M1,35840:H0,35841:Am,35842:W0,35843:Cm,32849:pl,32856:Lt,35905:V0,35907:ki,35898:Yc,34843:k0,34842:Js};function Aie(h,e,t,s){return h===Yc?new Uint32Array(e,t,s/4):new Uint8Array(e,t,s)}class Cie extends fy{constructor(e){super(),this.maxRetries=0}load(e,t,s){Ye.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const a=this.parse(t);if(!a)return null;const n=i.srgb?q1(a.format):a.format,r=new Ge(s,{name:e,addressU:a.cubemap?Oe:Zs,addressV:a.cubemap?Oe:Zs,width:a.width,height:a.height,format:n,cubemap:a.cubemap,levels:a.levels,...i});return r.upload(),r}parse(e){const t=new Uint32Array(e);if(ZR[0]!==t[0]||ZR[1]!==t[1]||ZR[2]!==t[2])return null;const s={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(s.pixelDepth>1||s.numberOfArrayElements!==0)return null;const i=Eie[s.glInternalFormat];if(i===void 0)return null;let a=16+s.bytesOfKeyValueData/4;const n=s.numberOfFaces>1,r=[];for(let l=0;l<(s.numberOfMipmapLevels||1);l++){const u=t[a++];n&&r.push([]);const f=n?r[l]:r;for(let _=0;_<(n?6:1);++_)f.push(Aie(i,e,a*4,u)),a+=u+3>>2}return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:r,cubemap:n}}}const wie={KHR_DF_MODEL_UASTC:166};class Rie extends fy{constructor(e,t){super(),this.maxRetries=0,this.device=t}load(e,t,s){Ye.fetchArrayBuffer(e.load,(i,a)=>{i?t(i,a):this.parse(a,e,t,s)},s,this.maxRetries)}open(e,t,s,i={}){const a=i.srgb?q1(t.format):t.format,n=new Ge(s,{name:e,addressU:t.cubemap?Oe:Zs,addressV:t.cubemap?Oe:Zs,width:t.width,height:t.height,format:a,cubemap:t.cubemap,levels:t.levels,...i});return n.upload(),n}parse(e,t,s,i){var g,y,v;const a=new xD(e),n=[a.readU32be(),a.readU32be(),a.readU32be()];if(n[0]!==2873840728||n[1]!==540160187||n[2]!==218765834)return null;const r={vkFormat:a.readU32(),typeSize:a.readU32(),pixelWidth:a.readU32(),pixelHeight:a.readU32(),pixelDepth:a.readU32(),layerCount:a.readU32(),faceCount:a.readU32(),levelCount:a.readU32(),supercompressionScheme:a.readU32()},l={dfdByteOffset:a.readU32(),dfdByteLength:a.readU32(),kvdByteOffset:a.readU32(),kvdByteLength:a.readU32(),sgdByteOffset:a.readU64(),sgdByteLength:a.readU64()},u=[];for(let x=0;x<Math.max(1,r.levelCount);++x)u.push({byteOffset:a.readU64(),byteLength:a.readU64(),uncompressedByteLength:a.readU64()});if(a.readU32()!==l.kvdByteOffset-l.dfdByteOffset)return null;a.skip(8);const _=a.readU8();a.skip(l.dfdByteLength-9),a.skip(l.kvdByteLength),r.supercompressionScheme===1||_===wie.KHR_DF_MODEL_UASTC?y6(this.device,t.load,e,s,{isGGGR:(((v=(y=(g=i==null?void 0:i.file)==null?void 0:g.variants)==null?void 0:y.basis)==null?void 0:v.opt)&8)!==0,isKTX2:!0})||s(`Basis module not found. Asset [${i.name}](${i.getFileUrl()}) basis texture variant will not be loaded.`):s("unsupported KTX2 pixel format")}}class Mie extends fy{constructor(e){super(),this.maxRetries=0}load(e,t,s){Ye.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const a=new Uint32Array(t,0,32),n=a[4],r=a[3],l=Math.max(a[7],1),u=a[20]===4,f=a[21],_=a[22],g=a[28]===65024,y=827611204,v=894720068,x=113,C=116,M=826496069,w=825438800,T=825504336,R=825439312,D=825504848;let I=!1,U=!1,O=!1,N=!1,z=null,X=1,Y;if(u?f===y?(z=z0,I=!0):f===v?(z=Em,I=!0):f===x?(z=Js,X=2):f===C?(z=Ri,X=4):f===M?(z=G0,I=!0,U=!0):f===w||f===T?(z=f===w?Am:Cm,I=!0,O=!0):(f===R||f===D)&&(z=f===R?H0:W0,I=!0,N=!0):_===32&&(z=Lt),!z)return Y=new Ge(s,{width:4,height:4,format:pl,name:"dds-legacy-empty"}),Y;Y=new Ge(s,{name:e,addressU:g?Oe:Zs,addressV:g?Oe:Zs,width:n,height:r,format:z,cubemap:g,mipmaps:l>1,...i});let F=128;const q=g?6:1;let G;const W=4,k=4,K=f===y?8:16;let ee,V,Q;for(let se=0;se<q;se++){let J=n,ie=r;for(let oe=0;oe<l;oe++){I?U?G=Math.floor((J+3)/4)*Math.floor((ie+3)/4)*8:O?G=Math.max(J,16)*Math.max(ie,8)/4:N?G=Math.max(J,8)*Math.max(ie,8)/2:(ee=Math.floor((J+W-1)/W),V=Math.floor((ie+k-1)/k),Q=ee*V,G=Q*K):G=J*ie*4;const he=z===Ri?new Float32Array(t,F,G):z===Js?new Uint16Array(t,F,G):new Uint8Array(t,F,G);g?(Y._levels[oe]||(Y._levels[oe]=[]),Y._levels[oe][se]=he):Y._levels[oe]=he,F+=G*X,J=Math.max(J*.5,1),ie=Math.max(ie*.5,1)}}return Y.upload(),Y}}class Die extends fy{constructor(e){super(),this.maxRetries=0}load(e,t,s){Ye.fetchArrayBuffer(e.load,t,s,this.maxRetries),s.data&&!s.data.type&&(s.data.type=jb)}open(e,t,s,i={}){const a=this.parse(t);if(!a)return null;const n=new Ge(s,{name:e,addressU:Zs,addressV:Oe,minFilter:Je,magFilter:Je,width:a.width,height:a.height,levels:a.levels,format:Lt,type:jb,mipmaps:!1,...i});return n.upload(),n}parse(e){const t=new xD(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;const i={};for(;;){const u=t.readLine();if(u.length===0)break;{const f=u.split("=");f.length===2&&(i[f[0]]=f[1])}}if(!i.hasOwnProperty("FORMAT"))return null;const a=t.readLine().split(" ");if(a.length!==4)return null;const n=parseInt(a[1],10),r=parseInt(a[3],10),l=this._readPixels(t,r,n,a[0]==="-Y");return l?{width:r,height:n,levels:[l]}:null}_readPixels(e,t,s,i){if(t<8||t>32767)return this._readPixelsFlat(e,t,s);const a=[0,0,0,0];if(e.readArray(a),a[0]!==2||a[1]!==2||(a[2]&128)!==0)return e.skip(-4),this._readPixelsFlat(e,t,s);const n=new ArrayBuffer(t*s*4),r=new Uint8Array(n);let l=i?0:t*4*(s-1),u,f,_,g,y,v;for(f=0;f<s;++f){if(f&&e.readArray(a),(a[2]<<8)+a[3]!==t)return null;for(g=0;g<4;++g)for(u=0;u<t;)if(y=e.readU8(),y>128){if(y-=128,u+y>t)return null;for(v=e.readU8(),_=0;_<y;++_)r[l+g+4*u++]=v}else{if(y===0||u+y>t)return null;for(_=0;_<y;++_)r[l+g+4*u++]=e.readU8()}l+=t*4*(i?1:-1)}return r}_readPixelsFlat(e,t,s){return e.remainingBytes===t*s*4?new Uint8Array(e.arraybuffer,e.offset):null}}const O4={repeat:Zs,clamp:Oe,mirror:O0},N4={nearest:Je,linear:Vt,nearest_mip_nearest:vm,linear_mip_nearest:bm,nearest_mip_linear:Sm,linear_mip_linear:lo},Pie={default:vr,rgbm:Eh,rgbe:jb,rgbp:v0,swizzleGGGR:S0},Lie=function(h){const e=fr.calcMipLevelsCount(h._width,h._height),t=function(i){return i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof HTMLVideoElement};if(!(h._format===Lt||h._format===Ri)||h._volume||h._compressed||h._levels.length===1||h._levels.length===e||t(h._cubemap?h._levels[0][0]:h._levels[0]))return;const s=function(i,a,n){const r=Math.max(1,i>>1),l=Math.max(1,a>>1),u=new n.constructor(r*l*4),f=Math.floor(i/r),_=Math.floor(a/l),g=f*_;for(let y=0;y<l;++y)for(let v=0;v<r;++v)for(let x=0;x<4;++x){let C=0;for(let M=0;M<_;++M)for(let w=0;w<f;++w)C+=n[(v*f+w+(y*_+M)*i)*4+x];u[(v+y*r)*4+x]=C/g}return u};for(let i=h._levels.length;i<e;++i){const a=Math.max(1,h._width>>i-1),n=Math.max(1,h._height>>i-1);if(h._cubemap){const r=[];for(let l=0;l<6;++l)r.push(s(a,n,h._levels[i-1][l]));h._levels.push(r)}else h._levels.push(s(a,n,h._levels[i-1]))}h._levelsUpdated=h._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]};class v6 extends Ps{constructor(e){super(e,"texture");const t=e.assets,s=e.graphicsDevice;this._device=s,this._assets=t,this.imgParser=new Tie(t,s),this.parsers={dds:new Mie(t),ktx:new Cie(t),ktx2:new Rie(t,s),basis:new xie(t,s),hdr:new Die(t)}}set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){this.imgParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=bt.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){var s;const t={};if(e){((s=e.name)==null?void 0:s.length)>0&&(t.name=e.name);const i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=N4[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=N4[i.magfilter]),i.hasOwnProperty("addressu")&&(t.addressU=O4[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=O4[i.addressv]),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("srgb")&&(t.srgb=!!i.srgb),t.type=vr,i.hasOwnProperty("type")?t.type=Pie[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type=Eh:e.file&&(e.file.opt&8)!==0&&(t.type=S0)}return t}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){if(!e)return;const i=this._getTextureOptions(s);let a=this._getParser(e).open(e,t,this._device,i);return a===null?a=new Ge(this._device,{width:4,height:4,format:pl}):(Lie(a),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),a}patch(e,t){const s=e.resource;if(!s)return;const i=this._getTextureOptions(e);for(const a of Object.keys(i))s[a]=i[a]}}const S6="inline",fL="immersive-vr",f0="immersive-ar",Z3="viewer",Iie="local",Oie="local-floor",Nie="bounded-floor",Fie="unbounded",Bie="gaze",Uie="screen",zie="tracked-pointer",kie="none",Vie="left",Gie="right",Hie="none",b6="left",Wie="right",qie="point",Xie="plane",jie="mesh",x6="cpu-optimized",pL="gpu-optimized",mL="luminance-alpha",_L="unsigned-short",gL="float32";class T6{constructor(e){this._supported=Ct.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState!==null}get state(){return!this._supported||!this._manager.active||!this._manager._session.domOverlayState?null:this._manager._session.domOverlayState.type}set root(e){!this._supported||this._manager.active||(this._root=e)}get root(){return this._root}}const HE=[],F4=[],z2=class z2 extends Qe{constructor(e,t,s,i=null){super(),this.manager=e,this._xrHitTestSource=t,this._transient=s,this._inputSource=i}remove(){if(!this._xrHitTestSource)return;const e=this.manager.hitTest.sources,t=e.indexOf(this);t!==-1&&e.splice(t,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(e){if(this._transient){const t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let s=0;s<t.length;s++){const i=t[s];if(!i.results.length)continue;let a;i.inputSource&&(a=this.manager.input._getByInputSource(i.inputSource)),this.updateHitResults(i.results,a)}}else{const t=e.getHitTestResults(this._xrHitTestSource);if(!t.length)return;this.updateHitResults(t)}}updateHitResults(e,t){if(this._inputSource&&this._inputSource!==t)return;const s=HE.pop()??new H;t?s.copy(t.getOrigin()):s.copy(this.manager.camera.getPosition());let i=1/0,a=null;const n=HE.pop()??new H,r=F4.pop()??new Ne;for(let l=0;l<e.length;l++){const u=e[l].getPose(this.manager._referenceSpace),f=s.distance(u.transform.position);f>=i||(i=f,a=e[l],n.copy(u.transform.position),r.copy(u.transform.orientation))}this.fire("result",n,r,t||this._inputSource,a),this.manager.hitTest.fire("result",this,n,r,t||this._inputSource,a),HE.push(s),HE.push(n),F4.push(r)}};z2.EVENT_REMOVE="remove",z2.EVENT_RESULT="result";let d2=z2;const yd=class yd extends Qe{constructor(e){super(),this._supported=Ct.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),this._available=!1,this._checkingAvailability=!1,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){if(this.manager.session.enabledFeatures){const e=this.manager.session.enabledFeatures.indexOf("hit-test")!==-1;if(!e)return;this._available=e,this.fire("available")}else this._checkingAvailability||(this._checkingAvailability=!0,this.manager.session.requestReferenceSpace(Z3).then(e=>{this.manager.session.requestHitTestSource({space:e}).then(t=>{t.cancel(),this.manager.active&&(this._available=!0,this.fire("available"))}).catch(()=>{})}).catch(()=>{}))}_onSessionEnd(){if(this._available){this._available=!1;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable")}}start(e={}){var a,n;if(!this._supported){(a=e.callback)==null||a.call(e,new Error("XR HitTest is not supported"),null);return}if(!this._available){(n=e.callback)==null||n.call(e,new Error("XR HitTest is not available"),null);return}!e.profile&&!e.spaceType&&(e.spaceType=Z3);let t;const s=e.offsetRay;if(s){const r=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),l=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);t=new XRRay(r,l)}const i=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then(r=>{if(!this.manager.session){const l=new Error("XR Session is not started (2)");i&&i(l),this.fire("error",l);return}this.manager.session.requestHitTestSource({space:r,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(l=>{this._onHitTestSource(l,!1,e.inputSource,i)}).catch(l=>{i&&i(l),this.fire("error",l)})}).catch(r=>{i&&i(r),this.fire("error",r)}):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(r=>{this._onHitTestSource(r,!0,e.inputSource,i)}).catch(r=>{i&&i(r),this.fire("error",r)})}_onHitTestSource(e,t,s,i){if(!this.manager.session){e.cancel();const n=new Error("XR Session is not started (3)");i&&i(n),this.fire("error",n);return}const a=new d2(this.manager,e,t,s??null);this.sources.push(a),i&&i(null,a),this.fire("add",a)}update(e){if(this._available)for(let t=0;t<this.sources.length;t++)this.sources[t].update(e)}get supported(){return this._supported}get available(){return this._available}};yd.EVENT_AVAILABLE="available",yd.EVENT_UNAVAILABLE="unavailable",yd.EVENT_ADD="add",yd.EVENT_REMOVE="remove",yd.EVENT_RESULT="result",yd.EVENT_ERROR="error";let f2=yd;const k2=class k2 extends Qe{constructor(e,t){super(),this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new H,this._rotation=new Ne,this._image=e,this._width=t}get image(){return this._image}set width(e){this._width=e}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width}))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}};k2.EVENT_TRACKED="tracked",k2.EVENT_UNTRACKED="untracked";let p2=k2;const UL=class UL extends Qe{constructor(e){super(),this._supported=Ct.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(e,t){if(!this._supported||this._manager.active)return null;const s=new p2(e,t);return this._images.push(s),s}remove(e){if(this._manager.active)return;const t=this._images.indexOf(e);t!==-1&&(e.destroy(),this._images.splice(t,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then(e=>{this._available=!0;for(let t=0;t<e.length;t++)this._images[t]._trackable=e[t]==="trackable"}).catch(e=>{this._available=!1,this.fire("error",e)})}_onSessionEnd(){this._available=!1;for(let e=0;e<this._images.length;e++){const t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=!1,t.fire("untracked"))}}prepareImages(e){this._images.length?Promise.all(this._images.map(t=>t.prepare())).then(t=>{e(null,t)}).catch(t=>{e(t,null)}):e(null,null)}update(e){if(!this._available)return;const t=e.getImageTrackingResults(),s={};for(let i=0;i<t.length;i++){s[t[i].index]=t[i];const a=this._images[t[i].index];a._emulated=t[i].trackingState==="emulated",a._measuredWidth=t[i].measuredWidthInMeters,a._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace)}for(let i=0;i<this._images.length;i++)this._images[i]._tracking&&!s[i]?(this._images[i]._tracking=!1,this._images[i].fire("untracked")):!this._images[i]._tracking&&s[i]&&(this._images[i]._tracking=!0,this._images[i].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}};UL.EVENT_ERROR="error";let m2=UL;class E6{constructor(e,t){this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const B4=Ct.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],A6={};for(let h=0;h<B4.length;h++)A6[B4[h]]=!0;class J3{constructor(e,t,s,i=null){this._radius=null,this._localTransform=new Me,this._worldTransform=new Me,this._localPosition=new H,this._localRotation=new Ne,this._position=new H,this._rotation=new Ne,this._dirtyLocal=!0,this._index=e,this._id=t,this._hand=s,this._finger=i,this._wrist=t==="wrist",this._tip=this._finger&&!!A6[t]}update(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,H.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get id(){return this._id}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let bA=[];const _p=new H,WE=new H,U4=new H;Ct.browser&&window.XRHand&&(bA=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);const V2=class V2 extends Qe{constructor(e){super(),this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){const s=new J3(0,"wrist",this,null);this._wrist=s,this._joints.push(s),this._jointsById.wrist=s}for(let s=0;s<bA.length;s++){const i=new E6(s,this);for(let a=0;a<bA[s].length;a++){const n=bA[s][a];if(!t.get(n))continue;const r=new J3(a,n,this,i);this._joints.push(r),this._jointsById[n]=r,r.tip&&(this._tips.push(r),i._tip=r),i._joints.push(r)}}}update(e){const t=this._inputSource._xrInputSource;for(let f=0;f<this._joints.length;f++){const _=this._joints[f],g=t.hand.get(_._id);if(g){let y;if(e.session.visibilityState!=="hidden"&&(y=e.getJointPose(g,this._manager._referenceSpace)),y)_.update(y),_.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(_.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],a=this._jointsById["index-finger-phalanx-proximal"],n=this._jointsById["index-finger-tip"],r=this._jointsById["ring-finger-phalanx-proximal"],l=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&a&&n&&r&&l){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,n._localPosition,.5);let f=s,_=l;if(this._inputSource.handedness===b6){const g=f;f=_,_=g}_p.sub2(f._localPosition,this._wrist._localPosition),WE.sub2(_._localPosition,this._wrist._localPosition),U4.cross(_p,WE).normalize(),_p.lerp(a._localPosition,r._localPosition,.5),_p.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(U4,_p,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(e){const t=this._fingers[e];return _p.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),WE.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),_p.dot(WE)<-.8}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}};V2.EVENT_TRACKING="tracking",V2.EVENT_TRACKINGLOST="trackinglost";let _2=V2;const z4=new H,k4=new Ne;let Yie=0;const Jr=class Jr extends Qe{constructor(e,t){super(),this._ray=new ll,this._rayLocal=new ll,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=oo(),this._localTransform=null,this._worldTransform=null,this._position=new H,this._rotation=new Ne,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++Yie,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new _2(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else{const t=this._xrInputSource.gripSpace;if(t){const i=e.getPose(t,this._manager._referenceSpace);if(i){this._grip||(this._grip=!0,this._localTransform=new Me,this._worldTransform=new Me,this._localPositionLast=new H,this._localPosition=new H,this._localRotation=new Ne,this._linearVelocity=new H);const a=oo(),n=(a-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=a,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(i.transform.position),this._localRotation.copy(i.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&i.linearVelocity?this._linearVelocity.copy(i.linearVelocity):n>0&&(z4.sub2(this._localPosition,this._localPositionLast).divScalar(n),this._linearVelocity.lerp(this._linearVelocity,z4,.15))}else this._velocitiesAvailable=!1}const s=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=!0,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),k4.copy(s.transform.orientation),k4.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,H.ONE));const e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const e=this._dirtyRay;if(this._dirtyRay=!1,this._manager.camera.parent){const s=this._manager.camera.parent.getWorldTransform();s.getTranslation(this._position),this._rotation.setFromMat4(s),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e={}){e.inputSource=this,e.profile=this._xrInputSource.profiles[0];const t=e.callback;e.callback=(s,i)=>{i&&this.onHitTestSourceAdd(i),t&&t(s,i)},this._manager.hitTest.start(e)}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",(t,s,i,a)=>{i===this&&this.fire("hittest:result",e,t,s,a)}),e.once("remove",()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)})}onHitTestSourceRemove(e){const t=this._hitTestSources.indexOf(e);t!==-1&&this._hitTestSources.splice(t,1)}};Jr.EVENT_REMOVE="remove",Jr.EVENT_SELECT="select",Jr.EVENT_SELECTSTART="selectstart",Jr.EVENT_SELECTEND="selectend",Jr.EVENT_SQUEEZE="squeeze",Jr.EVENT_SQUEEZESTART="squeezestart",Jr.EVENT_SQUEEZEEND="squeezeend",Jr.EVENT_HITTESTADD="hittest:add",Jr.EVENT_HITTESTREMOVE="hittest:remove",Jr.EVENT_HITTESTRESULT="hittest:result";let ym=Jr;const mh=class mh extends Qe{constructor(e){var t,s;super(),this._inputSources=[],this.velocitiesSupported=!1,this.manager=e,this.velocitiesSupported=!!(Ct.browser&&((s=(t=window.XRPose)==null?void 0:t.prototype)!=null&&s.hasOwnProperty("linearVelocity"))),this._onInputSourcesChangeEvt=i=>{this._onInputSourcesChange(i)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("select",s),this.fire("select",i,s)}),e.addEventListener("selectstart",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!0,i.fire("selectstart",s),this.fire("selectstart",i,s)}),e.addEventListener("selectend",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!1,i.fire("selectend",s),this.fire("selectend",i,s)}),e.addEventListener("squeeze",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("squeeze",s),this.fire("squeeze",i,s)}),e.addEventListener("squeezestart",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!0,i.fire("squeezestart",s),this.fire("squeezestart",i,s)}),e.addEventListener("squeezeend",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!1,i.fire("squeezeend",s),this.fire("squeezeend",i,s)});const t=e.inputSources;for(let s=0;s<t.length;s++)this._addInputSource(t[s])}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){const s=this._inputSources[e];this._inputSources.splice(e,1),s.fire("remove"),this.fire("remove",s)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t])}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;const t=new ym(this.manager,e);this._inputSources.push(t),this.fire("add",t)}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;const s=this._inputSources[t];this._inputSources.splice(t,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();s.fire("remove"),this.fire("remove",s);return}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)}get inputSources(){return this._inputSources}};mh.EVENT_ADD="add",mh.EVENT_REMOVE="remove",mh.EVENT_SELECT="select",mh.EVENT_SELECTSTART="selectstart",mh.EVENT_SELECTEND="selectend",mh.EVENT_SQUEEZE="squeeze",mh.EVENT_SQUEEZESTART="squeezestart",mh.EVENT_SQUEEZEEND="squeezeend";let g2=mh;const Eg=new H,V4=new H,JR=new Me,G4=new Me,G2=class G2 extends Qe{constructor(e){super(),this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new Ne,this._color=new xe,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let e;if(this._manager.session||(e=new Error("XR session is not running")),!e&&this._manager.type!==f0&&(e=new Error("XR session type is not AR")),!e&&!this._supported&&(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e){this.fire("error",e);return}this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(t=>{const s=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?s&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))}).catch(t=>{this._lightProbeRequested=!1,this.fire("error",t)})}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(e){if(!this._lightProbe)return;const t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=!0,this.fire("available"));const s=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),Eg.copy(s).mulScalar(1/this._intensity),this._color.set(Eg.x,Eg.y,Eg.z),Eg.set(0,0,0),V4.copy(t.primaryLightDirection),JR.setLookAt(V4,Eg,H.UP),G4.setFromAxisAngle(H.RIGHT,90),JR.mul(G4),this._rotation.setFromMat4(JR),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}};G2.EVENT_AVAILABLE="available",G2.EVENT_ERROR="error";let y2=G2,Kie=0;const H2=class H2 extends Qe{constructor(e,t){super(),this._position=new H,this._rotation=new Ne,this._id=++Kie,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation}destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(e){const t=this._planeDetection._manager,s=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}};H2.EVENT_REMOVE="remove",H2.EVENT_CHANGE="change";let v2=H2;const Qg=class Qg extends Qe{constructor(e){super(),this._supported=Ct.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this._manager.session.enabledFeatures&&this._manager.session.enabledFeatures.indexOf("plane-detection")!==-1&&(this._available=!0,this.fire("available"))}_onSessionEnd(){for(let e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(e){if(!this._available)if(!this._manager.session.enabledFeatures&&e.detectedPlanes.size)this._available=!0,this.fire("available");else return;const t=e.detectedPlanes;for(const[s,i]of this._planesIndex)t.has(s)||(this._planesIndex.delete(s),this._planes.splice(this._planes.indexOf(i),1),i.destroy(),this.fire("remove",i));for(const s of t){let i=this._planesIndex.get(s);i?i.update(e):(i=new v2(this,s),this._planesIndex.set(s,i),this._planes.push(i),i.update(e),this.fire("add",i))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}};Qg.EVENT_AVAILABLE="available",Qg.EVENT_UNAVAILABLE="unavailable",Qg.EVENT_ADD="add",Qg.EVENT_REMOVE="remove";let S2=Qg;const $g=class $g extends Qe{constructor(e,t,s=null){super(),this._position=new H,this._rotation=new Ne,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=s}destroy(){if(!this._xrAnchor)return;const e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this)}update(e){if(!this._xrAnchor)return;const t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change")}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){if(!this._anchors.persistence){e==null||e(new Error("Persistent Anchors are not supported"),null);return}if(this._uuid){e==null||e(null,this._uuid);return}if(this._uuidRequests){e&&this._uuidRequests.push(e);return}this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(t=>{this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),e==null||e(null,t);for(const s of this._uuidRequests)s(null,t);this._uuidRequests=null,this.fire("persist",t)}).catch(t=>{e==null||e(t,null);for(const s of this._uuidRequests)s(t,null);this._uuidRequests=null})}forget(e){if(!this._uuid){e==null||e(new Error("Anchor is not persistent"));return}this._anchors.forget(this._uuid,t=>{this._uuid=null,e==null||e(t),this.fire("forget")})}get uuid(){return this._uuid}get persistent(){return!!this._uuid}};$g.EVENT_DESTROY="destroy",$g.EVENT_CHANGE="change",$g.EVENT_PERSIST="persist",$g.EVENT_FORGET="forget";let b2=$g;const Fp=class Fp extends Qe{constructor(e){var t;super(),this._supported=Ct.browser&&!!window.XRAnchor,this._available=!1,this._checkingAvailability=!1,this._persistence=Ct.browser&&!!((t=window==null?void 0:window.XRSession)!=null&&t.prototype.restorePersistentAnchor),this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){var t;const e=((t=this.manager.session.enabledFeatures)==null?void 0:t.indexOf("anchors"))>=0;e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(!this._available)return;this._available=!1;for(let t=0;t<this._creationQueue.length;t++)this._creationQueue[t].callback&&this._creationQueue[t].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let e=this._list.length;for(;e--;)this._list[e].destroy();this._list.length=0,this.fire("unavailable")}_createAnchor(e,t=null){const s=new b2(this,e,t);return this._index.set(e,s),t&&this._indexByUuid.set(t,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);const s=this._list.indexOf(t);s!==-1&&this._list.splice(s,1),this.fire("destroy",t)}create(e,t,s){if(!this._available){s==null||s(new Error("Anchors API is not available"),null);return}if(window.XRHitTestResult&&e instanceof XRHitTestResult){const i=e;if(s=t,!this._supported){s==null||s(new Error("Anchors API is not supported"),null);return}if(!i.createAnchor){s==null||s(new Error("Creating Anchor from Hit Test is not supported"),null);return}i.createAnchor().then(a=>{const n=this._createAnchor(a);s==null||s(null,n),this.fire("add",n)}).catch(a=>{s==null||s(a,null),this.fire("error",a)})}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:s})}restore(e,t){if(!this._available){t==null||t(new Error("Anchors API is not available"),null);return}if(!this._persistence){t==null||t(new Error("Anchor Persistence is not supported"),null);return}if(!this.manager.active){t==null||t(new Error("WebXR session is not active"),null);return}this.manager.session.restorePersistentAnchor(e).then(s=>{const i=this._createAnchor(s,e);t==null||t(null,i),this.fire("add",i)}).catch(s=>{t==null||t(s,null),this.fire("error",s)})}forget(e,t){if(!this._available){t==null||t(new Error("Anchors API is not available"));return}if(!this._persistence){t==null||t(new Error("Anchor Persistence is not supported"));return}if(!this.manager.active){t==null||t(new Error("WebXR session is not active"));return}this.manager.session.deletePersistentAnchor(e).then(()=>{t==null||t(null)}).catch(s=>{t==null||t(s),this.fire("error",s)})}update(e){if(!this._available){!this.manager.session.enabledFeatures&&!this._checkingAvailability&&(this._checkingAvailability=!0,e.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then(t=>{t.delete(),this.manager.active&&(this._available=!0,this.fire("available"))}).catch(()=>{}));return}if(this._creationQueue.length){for(let t=0;t<this._creationQueue.length;t++){const s=this._creationQueue[t];e.createAnchor(s.transform,this.manager._referenceSpace).then(i=>{s.callback&&this._callbacksAnchors.set(i,s.callback)}).catch(i=>{s.callback&&s.callback(i,null),this.fire("error",i)})}this._creationQueue.length=0}for(const[t,s]of this._index)e.trackedAnchors.has(t)||(this._index.delete(t),s.destroy());for(let t=0;t<this._list.length;t++)this._list[t].update(e);for(const t of e.trackedAnchors){if(this._index.has(t))continue;try{const a=t.anchorSpace}catch{continue}const s=this._createAnchor(t);s.update(e);const i=this._callbacksAnchors.get(t);i&&(this._callbacksAnchors.delete(t),i(null,s)),this.fire("add",s)}}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return!this._available||!this._persistence||!this.manager.active?null:this.manager.session.persistentAnchors}get list(){return this._list}};Fp.EVENT_AVAILABLE="available",Fp.EVENT_UNAVAILABLE="unavailable",Fp.EVENT_ERROR="error",Fp.EVENT_ADD="add",Fp.EVENT_DESTROY="destroy";let x2=Fp;const W2=class W2 extends Qe{constructor(e,t){super(),this._lastChanged=0,this._position=new H,this._rotation=new Ne,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime}get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(e){const t=this._meshDetection._manager,s=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}};W2.EVENT_REMOVE="remove",W2.EVENT_CHANGE="change";let eD=W2;const Zg=class Zg extends Qe{constructor(e){super(),this._supported=Ct.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}update(e){if(!this._available)if(!this._manager.session.enabledFeatures&&e.detectedMeshes.size)this._available=!0,this.fire("available");else return;for(const t of e.detectedMeshes){let s=this._index.get(t);s?s.update(e):(s=new eD(this,t),this._index.set(t,s),this._list.push(s),s.update(e),this.fire("add",s))}for(const t of this._index.values())e.detectedMeshes.has(t.xrMesh)||this._removeMesh(t)}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e)}_onSessionStart(){if(this._manager.session.enabledFeatures){const e=this._manager.session.enabledFeatures.indexOf("mesh-detection")!==-1;if(!e)return;this._available=e,this.fire("available")}}_onSessionEnd(){if(this._available){this._available=!1;for(const e of this._index.values())this._removeMesh(e);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}};Zg.EVENT_AVAILABLE="available",Zg.EVENT_UNAVAILABLE="unavailable",Zg.EVENT_ADD="add",Zg.EVENT_REMOVE="remove";let T2=Zg;const zL=class zL extends Qe{constructor(e,t,s){super(),this._positionData=new Float32Array(3),this._viewport=new Ie,this._projMat=new Me,this._projViewOffMat=new Me,this._viewMat=new Me,this._viewOffMat=new Me,this._viewMat3=new ol,this._viewInvMat=new Me,this._viewInvOffMat=new Me,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new Me,this._manager=e,this._xrView=t;const i=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new Ge(i,{format:pl,mipmaps:!1,addressU:Oe,addressV:Oe,minFilter:Vt,magFilter:Vt,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){const a=this._manager.views.depthGpuOptimized?Je:Vt;this._textureDepth=new Ge(i,{format:this._manager.views.depthPixelFormat,arrayLength:s===1?0:s,mipmaps:!1,addressU:Oe,addressV:Oe,minFilter:a,magFilter:a,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let n=0;n<this._textureDepth._levels.length;n++)this._textureDepth._levels[n]=this._emptyDepthBuffer;this._textureDepth.upload()}(this._textureColor||this._textureDepth)&&i.on("devicelost",this._onDeviceLost,this)}get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){var e;return((e=this._depthInfo)==null?void 0:e.rawValueToMeters)||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);const i=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=i.x,this._viewport.y=i.y,this._viewport.z=i.width,this._viewport.w=i.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e)}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;const e=this._manager.webglBinding;if(!e)return;const t=e.getCameraImage(this._xrCamera);if(!t)return;const s=this._manager.app.graphicsDevice,i=s.gl;if(!this._frameBufferSource)this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer();else{const a=i.COLOR_ATTACHMENT0,n=this._xrCamera.width,r=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,a,i.TEXTURE_2D,t,0),s.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,a,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,r,n,0,0,0,n,r,i.COLOR_BUFFER_BIT,i.NEAREST)}}_updateDepth(e){var u,f;if(!this._manager.views.availableDepth||!this._textureDepth)return;const t=this._manager.views.depthGpuOptimized,s=t?this._manager.webglBinding:e;if(!s){this._depthInfo=null;return}const i=s.getDepthInformation(this._xrView);if(!i){this._depthInfo=null;return}let a=!this._depthInfo!=!i;this._depthInfo=i;const n=((u=this._depthInfo)==null?void 0:u.width)||4,r=((f=this._depthInfo)==null?void 0:f.height)||4;let l=!1;if((this._textureDepth.width!==n||this._textureDepth.height!==r)&&(this._textureDepth._width=n,this._textureDepth._height=r,a=!0,l=!0),a&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(t){if(this._depthInfo.texture){const _=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,this._depthInfo.textureType==="texture-array"?this._textureDepth.impl._glTarget=_.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=_.TEXTURE_2D,this._manager.views.depthPixelFormat){case gr:this._textureDepth.impl._glInternalFormat=_.R32F,this._textureDepth.impl._glPixelType=_.FLOAT,this._textureDepth.impl._glFormat=_.RED;break;case il:this._textureDepth.impl._glInternalFormat=_.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=_.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=_.DEPTH_COMPONENT;break}this._textureDepth.impl._glCreated=!0}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();l&&this.fire("depth:resize",n,r)}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(e,t){var s;return this._manager.views.depthGpuOptimized?null:((s=this._depthInfo)==null?void 0:s.getDepthInMeters(e,t))??null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){const e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}};zL.EVENT_DEPTHRESIZE="depth:resize";let E2=zL;const q2=class q2 extends Qe{constructor(e){super(),this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=Ct.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=Ct.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[mL]:B0,[_L]:il,[gL]:gr},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===pL}get depthFormat(){return this._depthFormat}get depthPixelFormat(){return this._depthFormats[this._depthFormat]??null}update(e,t){for(let s=0;s<t.length;s++)this._indexTmp.set(t[s].eye,t[s]);for(const[s,i]of this._indexTmp){let a=this._index.get(s);a?a.update(e,i):(a=new E2(this._manager,i,t.length),this._index.set(s,a),this._list.push(a),a.update(e,i),this.fire("add",a))}for(const[s,i]of this._index){if(this._indexTmp.has(s))continue;i.destroy(),this._index.delete(s);const a=this._list.indexOf(i);a!==-1&&this._list.splice(a,1),this.fire("remove",i)}this._indexTmp.clear()}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===f0&&this._manager.session.enabledFeatures&&(this._availableColor=this._manager.session.enabledFeatures.indexOf("camera-access")!==-1,this._availableDepth=this._manager.session.enabledFeatures.indexOf("depth-sensing")!==-1,this._availableDepth)){const e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat}}_onSessionEnd(){for(const e of this._index.values())e.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}};q2.EVENT_ADD="add",q2.EVENT_REMOVE="remove";let b1=q2;const Bp=class Bp extends Qe{constructor(e){super(),this._supported=Ct.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this._camera=null,this._localPosition=new H,this._localRotation=new Ne,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available[S6]=!1,this._available[fL]=!1,this._available[f0]=!1,this.views=new b1(this),this.domOverlay=new T6(this),this.hitTest=new f2(this),this.imageTracking=new m2(this),this.planeDetection=new S2(this),this.meshDetection=new T2(this),this.input=new g2(this),this.lightEstimation=new y2(this),this.anchors=new x2(this),this.views=new b1(this),this._supported&&(navigator.xr.addEventListener("devicechange",()=>{this._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}destroy(){}start(e,t,s,i){var l;let a=i;if(typeof i=="object"&&(a=i.callback),!this._available[t]){a&&a(new Error("XR is not available"));return}if(this._session){a&&a(new Error("XR session is already started"));return}this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=s,this._framebufferScaleFactor=(i==null?void 0:i.framebufferScaleFactor)??1,this._setClipPlanes(e.nearClip,e.farClip);const n={requiredFeatures:[s],optionalFeatures:[]},r=(l=this.app.graphicsDevice)==null?void 0:l.isWebGL2;if(t===f0){if(n.optionalFeatures.push("light-estimation"),n.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&n.optionalFeatures.push("image-tracking"),i.planeDetection&&n.optionalFeatures.push("plane-detection"),i.meshDetection&&n.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(n.optionalFeatures.push("dom-overlay"),n.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&n.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.views.supportedDepth){n.optionalFeatures.push("depth-sensing");const u=[],f=[];if(u.push(pL,x6),f.push(gL,mL,_L),i.depthSensing.usagePreference){const _=u.indexOf(i.depthSensing.usagePreference);_!==-1&&u.splice(_,1),u.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const _=f.indexOf(i.depthSensing.dataFormatPreference);_!==-1&&f.splice(_,1),f.unshift(i.depthSensing.dataFormatPreference)}n.depthSensing={usagePreference:u,dataFormatPreference:f}}r&&i&&i.cameraColor&&this.views.supportedColor&&n.optionalFeatures.push("camera-access")}n.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(n.optionalFeatures=n.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((u,f)=>{if(u){a&&a(u),this.fire("error",u);return}f!==null&&(n.trackedImages=f),this._onStartOptionsReady(t,s,n,a)}):this._onStartOptionsReady(t,s,n,a)}_onStartOptionsReady(e,t,s,i){navigator.xr.requestSession(e,s).then(a=>{this._onSessionStart(a,t,i)}).catch(a=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(a),this.fire("error",a)})}end(e){if(!this._session){e&&e(new Error("XR Session is not initialized"));return}this.webglBinding=null,e&&this.once("end",e),this._session.end()}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(const e in this._available)this._sessionSupportCheck(e)}initiateRoomCapture(e){if(!this._session){e(new Error("Session is not active"));return}if(!this._session.initiateRoomCapture){e(new Error("Session does not support manual room capture"));return}this._session.initiateRoomCapture().then(()=>{e&&e(null)}).catch(t=>{e&&e(t)})}updateTargetFrameRate(e,t){var s;if(!((s=this._session)!=null&&s.updateTargetFrameRate)){t==null||t(new Error("unable to update frameRate"));return}this._session.updateTargetFrameRate(e).then(()=>{t==null||t()}).catch(i=>{t==null||t(i)})}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then(t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire(`available:${e}`,t))}).catch(t=>{this.fire("error",t)})}_onSessionStart(e,t,s){let i=!1;this._session=e;const a=()=>{this.fire("visibility:change",e.visibilityState)},n=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},r=()=>{this._camera&&(this._camera.off("set_nearClip",n),this._camera.off("set_farClip",n),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",r),e.removeEventListener("visibilitychange",a),i||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick()};e.addEventListener("end",r),e.addEventListener("visibilitychange",a),this._camera.on("set_nearClip",n),this._camera.on("set_farClip",n),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",()=>{var l;this.fire("frameratechange",(l=this._session)==null?void 0:l.frameRate)}),e.requestReferenceSpace(t).then(l=>{this._referenceSpace=l,this.app.tick(),s&&s(null),this.fire("start")}).catch(l=>{i=!0,e.end(),s&&s(l),this.fire("error",l)})}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){const e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:t,antialias:!1}),e!=null&&e.isWebGL2&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl)}catch(s){this.fire("error",s)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout(()=>{this.app.graphicsDevice.gl.makeXRCompatible().then(()=>{this._createBaseLayer()}).catch(e=>{this.fire("error",e)})},0)}update(e){if(!this._session)return!1;const t=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;(this._width!==t||this._height!==s)&&(this._width=t,this._height=s,this.app.graphicsDevice.setResolution(t,s));const i=e.getViewerPose(this._referenceSpace);if(!i)return!1;const a=this.views.list.length;this.views.update(e,i.views);const n=i.transform.position,r=i.transform.orientation;if(this._localPosition.set(n.x,n.y,n.z),this._localRotation.set(r.x,r.y,r.z,r.w),a===0&&this.views.list.length>0){const l=new Me,u=this.views.list[0];l.copy(u.projMat);const f=l.data,_=2*Math.atan(1/f[5])*180/Math.PI,g=f[5]/f[0],y=f[14]/(f[10]+1),v=f[14]/(f[10]-1);this._camera.camera.setXrProperties({aspectRatio:g,farClip:y,fov:_,horizontalFov:!1,nearClip:v})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===f0&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){var e;return((e=this._session)==null?void 0:e.frameRate)??null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){var t;(((t=this._baseLayer)==null?void 0:t.fixedFoveation)??null)!==null&&(this.app.graphicsDevice.samples>1,this._baseLayer.fixedFoveation=e)}get fixedFoveation(){var e;return((e=this._baseLayer)==null?void 0:e.fixedFoveation)??null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}};Bp.EVENT_AVAILABLE="available",Bp.EVENT_START="start",Bp.EVENT_END="end",Bp.EVENT_UPDATE="update",Bp.EVENT_ERROR="error";let A2=Bp;class C6 extends fo{constructor(e,t={}){super(e);const s=new uz;s.graphicsDevice=t.graphicsDevice??this.createDevice(e,t),this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=t.elementInput,s.keyboard=t.keyboard,s.mouse=t.mouse,s.touch=t.touch,s.gamepads=t.gamepads,s.scriptPrefix=t.scriptPrefix,s.assetPrefix=t.assetPrefix,s.scriptsOrder=t.scriptsOrder,s.soundManager=new $B,s.lightmapper=fz,s.batchManager=NU,s.xr=A2,this.init(s)}createDevice(e,t){return t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),Ct.browser&&navigator.xr&&(t.graphicsDeviceOptions.xrCompatible=!0),t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||!1,new sP(e,t.graphicsDeviceOptions)}addComponentSystems(e){e.componentSystems=[p1,Wz,Zz,Mz,Lz,h8,d8,L8,N8,z8,A8,Oz,u8,g8,$z,Bz,x8,T8,w8,r8,e8,M8,k8]}addResourceHandles(e){e.resourceHandlers=[V8,X8,j8,Y8,l6,o6,v6,_6,n6,K8,d6,h6,J8,a6,Z8,f6,i6,e6,t6,Q8,g6,p6,m6,$8,s6]}}class Qie extends Qe{constructor(e,t){super(),this._assets=new Set,this._loadingAssets=new Set,this._waitingAssets=new Set,this._loading=!1,this._loaded=!1,this._failed=[],this._registry=t,e.forEach(s=>{if(s instanceof Ye)s.registry||(s.registry=t),this._assets.add(s);else{const i=t.get(s);i?this._assets.add(i):this._waitForAsset(s)}})}destroy(){this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(e=>{this._registry.off(`add:${e}`,this._onAddAsset)}),this.off("progress"),this.off("load")}_assetHasDependencies(e){var t;return e.type==="model"&&((t=e.file)==null?void 0:t.url)&&e.file.url&&e.file.url.match(/.json$/g)}load(e,t){if(this._loading)return;this._loading=!0,this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);let s=!1;this._assets.forEach(i=>{i.loaded||(s=!0,this._assetHasDependencies(i)&&this._registry.loadFromUrl(i.file.url,i.type,(a,n)=>{if(a){this._onError(a,i);return}this._onLoad(i)}),this._loadingAssets.add(i),this._registry.add(i))}),this._loadingAssets.forEach(i=>{this._assetHasDependencies(i)||this._registry.load(i)}),!s&&this._waitingAssets.size===0&&this._loadingComplete()}ready(e,t=this){this._loaded?e.call(t,Array.from(this._assets)):this.once("load",s=>{e.call(t,s)})}_loadingComplete(){this._loaded||(this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))))}_onLoad(e){this._loadingAssets.has(e)&&(this.fire("progress",e),this._loadingAssets.delete(e)),this._loadingAssets.size===0&&setTimeout(()=>{this._loadingComplete()},0)}_onError(e,t){this._loadingAssets.has(t)&&(this._failed.push(t),this._loadingAssets.delete(t)),this._loadingAssets.size===0&&setTimeout(()=>{this._loadingComplete()},0)}_onAddAsset(e){this._waitingAssets.delete(e),this._assets.add(e),e.loaded||(this._loadingAssets.add(e),this._registry.load(e))}_waitForAsset(e){this._waitingAssets.add(e),this._registry.once(`add:${e}`,this._onAddAsset,this)}}const H4=4096,W4=512;class $ie{constructor(e,t,s,i){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=s,this.texture=new Ge(e,{name:i,format:ki,width:t,height:s,mipmaps:!0,minFilter:lo,magFilter:Vt,addressU:Oe,addressV:Oe,levels:[this.canvas]}),this.ctx=this.canvas.getContext("2d",{alpha:!0})}destroy(){this.texture.destroy()}clear(e){const{width:t,height:s}=this.canvas;this.ctx.clearRect(0,0,t,s),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,t,s)}}class Zie extends Qe{constructor(e,t={}){super(),this.type="bitmap",this.app=e,this.intensity=0,this.fontWeight=t.fontWeight||"normal",this.fontSize=parseInt(t.fontSize,10),this.glyphSize=this.fontSize,this.fontName=t.fontName||"Arial",this.color=t.color||new xe(1,1,1),this.padding=t.padding||0,this.width=Math.min(H4,t.width||W4),this.height=Math.min(H4,t.height||W4),this.atlases=[],this.chars="",this.data={}}createTextures(e){const t=this._normalizeCharsSet(e);if(t.length!==this.chars.length){this._renderAtlas(t);return}for(let s=0;s<t.length;s++)if(t[s]!==this.chars[s]){this._renderAtlas(t);return}}updateTextures(e){const t=this._normalizeCharsSet(e),s=[];for(let i=0;i<t.length;i++){const a=t[i];this.data.chars[a]||s.push(a)}s.length>0&&this._renderAtlas(this.chars.concat(s))}destroy(){this.atlases.forEach(e=>e.destroy()),this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.atlases=null,this.type=null,this.fontWeight=null}_colorToRgbString(e,t){let s;const i=Math.round(255*e.r),a=Math.round(255*e.g),n=Math.round(255*e.b);return t?s=`rgba(${i}, ${a}, ${n}, ${e.a})`:s=`rgb(${i}, ${a}, ${n})`,s}renderCharacter(e,t,s,i,a){e.fillStyle=a,e.fillText(t,s,i)}_getAtlas(e){return e>=this.atlases.length&&(this.atlases[e]=new $ie(this.app.graphicsDevice,this.width,this.height,`font-atlas-${this.fontName}-${e}`)),this.atlases[e]}_renderAtlas(e){this.chars=e;const t=this.width,s=this.height,i=this._colorToRgbString(this.color,!1),a=this.color.a;this.color.a=1/255;const n=this._colorToRgbString(this.color,!0);this.color.a=a;const r="center",l="alphabetic";let u=0,f=this._getAtlas(u++);f.clear(n),this.data=this._createJson(this.chars,this.fontName,t,s);const _=Ed.getSymbols(this.chars.join(""));let g=0,y=0;const v={};for(let D=0;D<_.length;D++){const I=_[D];v[I]=this._getTextMetrics(I),g=Math.max(g,v[I].height),y=Math.max(y,v[I].descent)}this.glyphSize=Math.max(this.glyphSize,g);const x=this.glyphSize+this.padding*2,C=this.glyphSize+this.padding*2,M=this.glyphSize/2+this.padding,w=C-y-this.padding;let T=0,R=0;for(let D=0;D<_.length;D++){const I=_[D],U=Ed.getCodePoint(_[D]);let O=this.fontSize;f.ctx.font=`${this.fontWeight} ${O.toString()}px ${this.fontName}`,f.ctx.textAlign=r,f.ctx.textBaseline=l;let N=f.ctx.measureText(I).width;N>O&&(O=this.fontSize*this.fontSize/N,f.ctx.font=`${this.fontWeight} ${O.toString()}px ${this.fontName}`,N=this.fontSize),this.renderCharacter(f.ctx,I,T+M,R+w,i);const z=this.padding+(this.glyphSize-N)/2,X=-this.padding+v[I].descent-y,Y=N;this._addChar(this.data,I,U,T,R,x,C,z,X,Y,u-1,t,s),T+=x,T+x>t&&(T=0,R+=C,R+C>s&&(f=this._getAtlas(u++),f.clear(n),R=0))}this.atlases.splice(u).forEach(D=>D.destroy()),this.atlases.forEach(D=>D.texture.upload()),this.fire("render")}_createJson(e,t,s,i){return{version:3,intensity:this.intensity,info:{face:t,width:s,height:i,maps:[{width:s,height:i}]},chars:{}}}_addChar(e,t,s,i,a,n,r,l,u,f,_,g,y){e.info.maps.length<_+1&&e.info.maps.push({width:g,height:y});const v=this.fontSize/32;e.chars[t]={id:s,letter:t,x:i,y:a,width:n,height:r,xadvance:f/v,xoffset:l/v,yoffset:(u+this.padding)/v,scale:v,range:1,map:_,bounds:[0,0,n/v,r/v]}}_normalizeCharsSet(e){const t=this.app.systems.element.getUnicodeConverter();t&&(e=t(e));const s={},i=Ed.getSymbols(e);for(let n=0;n<i.length;n++){const r=i[n];s[r]||(s[r]=r)}return Object.keys(s).sort()}_getTextMetrics(e){const t=document.createElement("span");t.id="content-span",t.innerHTML=e;const s=document.createElement("div");s.id="content-block",s.style.display="inline-block",s.style.width="1px",s.style.height="0px";const i=document.createElement("div");i.appendChild(t),i.appendChild(s),i.style.font=`${this.fontSize}px ${this.fontName}`,document.body.appendChild(i);let n=-1,r=-1,l=-1;try{s.style["vertical-align"]="baseline",n=s.offsetTop-t.offsetTop,s.style["vertical-align"]="bottom",l=s.offsetTop-t.offsetTop,r=l-n}finally{document.body.removeChild(i)}return{ascent:n,descent:r,height:l}}get textures(){return this.atlases.map(e=>e.texture)}}const qE=[],Jie=[[],[],[]];class eae extends pa{constructor(e,t){super(e),this.viewBindGroups=[],this.renderer=t}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}update(e,t,s,i){this.camera=e,this.scene=t,this.layers=s,this.mapping=i}execute(){const e=this.device,{renderer:t,camera:s,scene:i,layers:a,mapping:n,renderTarget:r}=this,l=i.layers.layerList,u=i.layers.subLayerEnabled,f=i.layers.subLayerList;for(let _=0;_<l.length;_++){const g=l[_];if(!(a&&a.indexOf(g)<0)&&g.enabled&&u[_]&&g.camerasSet.has(s.camera)){const y=f[_];g._clearDepthBuffer&&t.clear(s.camera,!1,!0,!1);const v=g.meshInstances;for(let x=0;x<v.length;x++){const C=v[x];C.pick&&C.transparent===y&&(qE.push(C),n.set(C.id,C))}qE.length>0&&(i.clusteredLightingEnabled&&t.worldClustersAllocator.empty.activate(),t.setCameraUniforms(s.camera,r),e.supportsUniformBuffers&&t.setupViewUniformBuffers(this.viewBindGroups,t.viewUniformFormat,t.viewBindGroupFormat,1),t.renderForward(s.camera,r,qE,Jie,ry,C=>{e.setBlendState(ms.NOBLEND)}),qE.length=0)}}}}const eM=new Set,tae=new Ie;class w6{constructor(e,t,s){this.renderTarget=null,this.mapping=new Map,this.deviceValid=!0,this.renderer=e.renderer,this.device=e.graphicsDevice,this.renderPass=new eae(this.device,e.renderer),this.width=0,this.height=0,this.resize(t,s),this.device.on("destroy",()=>{this.deviceValid=!1})}getSelection(e,t,s=1,i=1){const a=this.device;if(a.isWebGPU)return[];t=this.renderTarget.height-(t+i);const n=this.sanitizeRect(e,t,s,i);a.setRenderTarget(this.renderTarget),a.updateBegin();const r=new Uint8Array(4*n.z*n.w);return a.readPixels(n.x,n.y,n.z,n.w,r),a.updateEnd(),this.decodePixels(r,this.mapping)}getSelectionAsync(e,t,s=1,i=1){var n;(n=this.device)!=null&&n.isWebGL2&&(t=this.renderTarget.height-(t+i));const a=this.sanitizeRect(e,t,s,i);return this.renderTarget.colorBuffer.read(a.x,a.y,a.z,a.w,{renderTarget:this.renderTarget,immediate:!0}).then(r=>this.decodePixels(r,this.mapping))}sanitizeRect(e,t,s,i){const a=this.renderTarget.width,n=this.renderTarget.height;return e=ge.clamp(Math.floor(e),0,a-1),t=ge.clamp(Math.floor(t),0,n-1),s=Math.floor(Math.max(s,1)),s=Math.min(s,a-e),i=Math.floor(Math.max(i,1)),i=Math.min(i,n-t),tae.set(e,t,s,i)}decodePixels(e,t){const s=[];if(this.deviceValid){const i=e.length;for(let a=0;a<i;a+=4){const n=e[a+0],r=e[a+1],l=e[a+2],f=(e[a+3]<<24|n<<16|r<<8|l)>>>0;f!==4294967295&&eM.add(t.get(f))}eM.forEach(a=>{a&&s.push(a)}),eM.clear()}return s}allocateRenderTarget(){const e=new Ge(this.device,{format:Lt,width:this.width,height:this.height,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe,name:"pick"});this.renderTarget=new fs({colorBuffer:e,depth:!0})}releaseRenderTarget(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}prepare(e,t,s){s instanceof Fi&&(s=[s]),(!this.renderTarget||this.width!==this.renderTarget.width||this.height!==this.renderTarget.height)&&(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();const i=this.renderPass;i.init(this.renderTarget),i.colorOps.clearValue=xe.WHITE,i.colorOps.clear=!0,i.depthStencilOps.clearDepth=!0,i.update(e,t,s,this.mapping),i.render()}resize(e,t){this.width=Math.floor(e),this.height=Math.floor(t)}}class sae extends Ps{constructor(e){super(e,"scenesettings")}load(e,t){cL.load(e,this.maxRetries,t)}open(e,t){return t.settings}}let sd,id;const tM=new H,q4=new H,Mc=new ll,ob=new ll,tD=new ll;Mc.end=new H;ob.end=new H;tD.end=new H;const Ag=new H,XE=new H,sM=new H,X4=new H,iM=new H,jE=new H,YE=new H,KE=new H,QE=new H,aM=new H,iae=new H,Cg=new H,oS=new H,$E=new H,ZE=new H,lS=new H,j4=new H,Y4=new H,K4=new H,Q4=new H,aae=new Ie;function $4(h,e,t){return iae.cross(h,e).dot(t)}function nae(h,e,t){Ag.sub2(e,h),XE.sub2(t[0],h),sM.sub2(t[1],h),X4.sub2(t[2],h),jE.cross(X4,Ag);let s=XE.dot(jE),i,a;if(s>=0){if(i=-sM.dot(jE),i<0||(a=$4(Ag,sM,XE),a<0))return-1;const n=1/(i+s+a);YE.copy(t[0]).mulScalar(i*n),KE.copy(t[1]).mulScalar(s*n),QE.copy(t[2]).mulScalar(a*n),aM.copy(YE).add(KE).add(QE)}else{if(iM.sub2(t[3],h),i=iM.dot(jE),i<0||(a=$4(Ag,XE,iM),a<0))return-1;s=-s;const n=1/(i+s+a);YE.copy(t[0]).mulScalar(i*n),KE.copy(t[3]).mulScalar(s*n),QE.copy(t[2]).mulScalar(a*n),aM.copy(YE).add(KE).add(QE)}return Ag.sub2(t[0],t[2]).lengthSq()<1e-4*1e-4||Ag.sub2(t[1],t[3]).lengthSq()<1e-4*1e-4?-1:aM.sub(h).lengthSq()}class KC{constructor(e,t,s){this.event=e,this.element=t,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}class Og extends KC{constructor(e,t,s,i,a,n,r){super(e,t,s),this.x=i,this.y=a,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.button=e.button,Hd.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=i-n,this.dy=a-r),this.wheelDelta=0,e.type==="wheel"&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1))}}class Ng extends KC{constructor(e,t,s,i,a,n){super(e,t,s),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=i,this.y=a,this.touch=n}}class Dc extends KC{constructor(e,t,s,i){super(e,t,s),this.inputSource=i}}class p0{constructor(e,t){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||t.useMouse!==!1,this._useTouch=!t||t.useTouch!==!1,this._useXr=!t||t.useXr!==!1,this._selectEventsAttached=!1,Ct.touch&&(this._clickedEntities={}),this.attach(e)}set enabled(e){this._enabled=e}get enabled(){return this._enabled}set app(e){this._app=e}get app(){return this._app||rl()}attach(e){this._attached&&(this._attached=!1,this.detach()),this._target=e,this._attached=!0;const t=Ct.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&Ct.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;const e=Ct.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(e){this._elements.indexOf(e)===-1&&this._elements.push(e)}removeElement(e){const t=this._elements.indexOf(e);t!==-1&&this._elements.splice(t,1)}_handleUp(e){this._enabled&&(Hd.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mouseup",e)))}_handleDown(e){this._enabled&&(Hd.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mousedown",e)))}_handleMove(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousemove",e),this._lastX=sd,this._lastY=id)}_handleWheel(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousewheel",e))}_determineTouchedElements(e){const t={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){const a=s[i];let n=0;const r=e.changedTouches.length;for(let l=0;l<r;l++){if(t[e.changedTouches[l].identifier]){n++;continue}const u=ub(e.changedTouches[l]),f=this._getTargetElementByCoords(a,u.x,u.y);f&&(n++,t[e.changedTouches[l].identifier]={element:f,camera:a,x:u.x,y:u.y})}if(n===r)break}return t}_handleTouchStart(e){if(!this._enabled)return;const t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){const a=e.changedTouches[s],n=t[a.identifier],r=this._touchedElements[a.identifier];n&&(!r||n.element!==r.element)&&(this._fireEvent(e.type,new Ng(e,n.element,n.camera,n.x,n.y,a)),this._touchesForWhichTouchLeaveHasFired[a.identifier]=!1)}for(const s in t)this._touchedElements[s]=t[s]}_handleTouchEnd(e){if(!this._enabled)return;const t=this.app.systems.camera.cameras;for(const s in this._clickedEntities)delete this._clickedEntities[s];for(let s=0,i=e.changedTouches.length;s<i;s++){const a=e.changedTouches[s],n=this._touchedElements[a.identifier];if(!n)continue;const r=n.element,l=n.camera,u=n.x,f=n.y;delete this._touchedElements[a.identifier],delete this._touchesForWhichTouchLeaveHasFired[a.identifier];const _=ub(a);for(let g=t.length-1;g>=0;g--)this._getTargetElementByCoords(t[g],_.x,_.y)===r&&(this._clickedEntities[r.entity.getGuid()]||(this._fireEvent("click",new Ng(e,r,l,u,f,a)),this._clickedEntities[r.entity.getGuid()]=Date.now()));this._fireEvent(e.type,new Ng(e,r,l,u,f,a))}}_handleTouchMove(e){if(e.preventDefault(),!this._enabled)return;const t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){const a=e.changedTouches[s],n=t[a.identifier],r=this._touchedElements[a.identifier];if(r){const l=ub(a);(!n||n.element!==r.element)&&!this._touchesForWhichTouchLeaveHasFired[a.identifier]&&(this._fireEvent("touchleave",new Ng(e,r.element,r.camera,l.x,l.y,a)),this._touchesForWhichTouchLeaveHasFired[a.identifier]=!0),this._fireEvent("touchmove",new Ng(e,r.element,r.camera,l.x,l.y,a))}}}_onElementMouseEvent(e,t){let s=null;const i=this._hoveredElement;this._hoveredElement=null;const a=this.app.systems.camera.cameras;let n;for(let r=a.length-1;r>=0&&(n=a[r],s=this._getTargetElementByCoords(n,sd,id),!s);r--);if(this._hoveredElement=s,(e==="mousemove"||e==="mouseup")&&this._pressedElement?this._fireEvent(e,new Og(t,this._pressedElement,n,sd,id,this._lastX,this._lastY)):s&&(this._fireEvent(e,new Og(t,s,n,sd,id,this._lastX,this._lastY)),e==="mousedown"&&(this._pressedElement=s)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new Og(t,i,n,sd,id,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Og(t,this._hoveredElement,n,sd,id,this._lastX,this._lastY))),e==="mouseup"&&this._pressedElement){if(this._pressedElement===this._hoveredElement){const r=this._hoveredElement.entity.getGuid();let l=!this._clickedEntities;if(this._clickedEntities){const u=this._clickedEntities[r]||0;l=Date.now()-u>300,delete this._clickedEntities[r]}l&&this._fireEvent("click",new Og(t,this._hoveredElement,n,sd,id,this._lastX,this._lastY))}this._pressedElement=null}}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;const e=this.app.xr.input.inputSources;for(let t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null)}_onXrInputRemove(e){const t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new Dc(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id]}_onSelectStart(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t)}_onSelectEnd(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t)}_onElementSelectEvent(e,t,s){let i;const a=this._selectedElements[t.id];let n;const r=this.app.systems.camera.cameras;let l;if(t.elementInput){tD.set(t.getOrigin(),t.getDirection());for(let f=r.length-1;f>=0&&(l=r[f],i=this._getTargetElementByRay(tD,l),!i);f--);}t._elementEntity=i||null,i?(this._selectedElements[t.id]=i,n=i):delete this._selectedElements[t.id],a!==n&&(a&&this._fireEvent("selectleave",new Dc(s,a,l,t)),n&&this._fireEvent("selectenter",new Dc(s,n,l,t)));const u=this._selectedPressedElements[t.id];e==="selectmove"&&u&&this._fireEvent("selectmove",new Dc(s,u,l,t)),e==="selectstart"&&(this._selectedPressedElements[t.id]=n,n&&this._fireEvent("selectstart",new Dc(s,n,l,t))),!t.elementInput&&u&&(delete this._selectedPressedElements[t.id],a&&this._fireEvent("selectend",new Dc(s,u,l,t))),e==="selectend"&&t.elementInput&&(delete this._selectedPressedElements[t.id],u&&this._fireEvent("selectend",new Dc(s,u,l,t)),u&&u===a&&this._fireEvent("click",new Dc(s,u,l,t)))}_fireEvent(e,t){let s=t.element;for(;s.fire(e,t),!(t._stopPropagation||!s.entity.parent||(s=s.entity.parent.element,!s)););}_calcMouseCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);sd=e.clientX-s,id=e.clientY-i}_sortElements(e,t){const s=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return s!==0?s:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:!e.screen&&!t.screen?0:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder}_getTargetElementByCoords(e,t,s){const i=this._calculateRayScreen(t,s,e,Mc)?Mc:null,a=this._calculateRay3d(t,s,e,ob)?ob:null;return this._getTargetElement(e,i,a)}_getTargetElementByRay(e,t){Mc.origin.copy(e.origin),Mc.direction.copy(e.direction),Mc.end.copy(Mc.direction).mulScalar(t.farClip*2).add(Mc.origin);const s=Mc,i=t.worldToScreen(s.origin,tM),a=this._calculateRayScreen(i.x,i.y,t,ob)?ob:null;return this._getTargetElement(t,a,s)}_getTargetElement(e,t,s){let i=null,a=1/0;this._elements.sort(this._sortHandler);for(let n=0,r=this._elements.length;n<r;n++){const l=this._elements[n];if(l.layers.some(u=>e.layersSet.has(u)))if(l.screen&&l.screen.screen.screenSpace){if(!t)continue;if(this._checkElement(t,l,!0)>=0){i=l;break}}else{if(!s)continue;const u=this._checkElement(s,l,!1);if(u>=0&&(u<a&&(i=l,a=u),l.screen)){i=l;break}}}return i}_calculateRayScreen(e,t,s,i){const a=this.app.graphicsDevice.width,n=this.app.graphicsDevice.height,r=s.rect.z*a,l=s.rect.w*n,u=s.rect.x*a,f=u+r,_=(1-s.rect.y)*n,g=_-l;let y=e*a/this._target.clientWidth,v=t*n/this._target.clientHeight;return y>=u&&y<=f&&v<=_&&v>=g?(y=a*(y-u)/r,v=n*(v-g)/l,v=n-v,i.origin.set(y,v,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0):!1}_calculateRay3d(e,t,s,i){const a=this._target.clientWidth,n=this._target.clientHeight,r=s.rect.z*a,l=s.rect.w*n,u=s.rect.x*a,f=u+r,_=(1-s.rect.y)*n,g=_-l;let y=e,v=t;return e>=u&&e<=f&&t<=_&&v>=g?(y=a*(y-u)/r,v=n*(v-g)/l,s.screenToWorld(y,v,s.nearClip,tM),s.screenToWorld(y,v,s.farClip,q4),i.origin.copy(tM),i.direction.set(0,0,-1),i.end.copy(q4),!0):!1}_checkElement(e,t,s){if(t.maskedBy&&this._checkElement(e,t.maskedBy.element,s)<0)return-1;let i;s?i=p0.calculateScaleToScreen(t):i=p0.calculateScaleToWorld(t);const a=p0.buildHitCorners(t,s?t.screenCorners:t.worldCorners,i);return nae(e.origin,e.end,a)}static buildHitCorners(e,t,s){let i=t;if(e.entity&&e.entity.button){const n=e.entity.button.hitPadding||aae;oS.copy(e.entity.up),$E.copy(oS).mulScalar(-1),lS.copy(e.entity.right),ZE.copy(lS).mulScalar(-1),oS.mulScalar(n.w*s.y),$E.mulScalar(n.y*s.y),lS.mulScalar(n.z*s.x),ZE.mulScalar(n.x*s.x),j4.copy(i[0]).add($E).add(ZE),Y4.copy(i[1]).add($E).add(lS),K4.copy(i[2]).add(oS).add(lS),Q4.copy(i[3]).add(oS).add(ZE),i=[j4,Y4,K4,Q4]}if(s.x<0){const n=i[2].x,r=i[0].x;i[0].x=n,i[1].x=r,i[2].x=r,i[3].x=n}if(s.y<0){const n=i[2].y,r=i[0].y;i[0].y=n,i[1].y=n,i[2].y=r,i[3].y=r}if(s.z<0){const n=i[2].x,r=i[2].y,l=i[2].z;i[2].x=i[0].x,i[2].y=i[0].y,i[2].z=i[0].z,i[0].x=n,i[0].y=r,i[0].z=l}return i}static calculateScaleToScreen(e){let t=e.entity;const s=e.screen.screen.scale;for(Cg.set(s,s,s);t&&!t.screen;)Cg.mul(t.getLocalScale()),t=t.parent;return Cg}static calculateScaleToWorld(e){let t=e.entity;for(Cg.set(1,1,1);t;)Cg.mul(t.getLocalScale()),t=t.parent;return Cg}}Ee.prototype.scale=Ee.prototype.mulScalar;H.prototype.scale=H.prototype.mulScalar;Ie.prototype.scale=Ie.prototype.mulScalar;const rae=B0,oae=xm,lae=U0,hae=Tm,cae=pl,uae=Lt,dae=V0,fae=ki,pae=AD,mae=CD,_ae=AD,gae=CD,yae=new Ie;function vae(h,e){return Ft.fromGeometry(h,new cy(e))}function Sae(h,e){return Ft.fromGeometry(h,new xx(e))}function bae(h,e){return Ft.fromGeometry(h,new Kd(e))}function xae(h,e){return Ft.fromGeometry(h,new D0(e))}function Tae(h,e){return Ft.fromGeometry(h,new UP(e))}function Eae(h,e){return Ft.fromGeometry(h,new bx(e))}function Aae(h,e){return Ft.fromGeometry(h,new uy(e))}function Cae(h,e,t={}){const s=new dl;return s.positions=e,s.normals=t.normals,s.tangents=t.tangents,s.colors=t.colors,s.uvs=t.uvs,s.uvs1=t.uvs1,s.blendIndices=t.blendIndices,s.blendWeights=t.blendWeights,s.indices=t.indices,Ft.fromGeometry(h,s,t)}function wae(h,e,t,s,i){let a;if(i){const n=e?e.width:h.width,r=e?e.height:h.height;a=yae.set(i.x*n,i.y*r,i.z*n,i.w*r)}qn(h,e,s,a)}const Rae={"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"};Object.keys(Rae).forEach(h=>{Object.defineProperty(dt,h,{get:function(){return null},set:function(){}})});Object.defineProperties(fs.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(h){}}});Object.defineProperty(en,"defaultInstancingFormat",{get:function(){return null}});Object.defineProperties(Ge.prototype,{rgbm:{get:function(){return this.type===Eh},set:function(h){this.type=h?Eh:vr}},swizzleGGGR:{get:function(){return this.type===S0},set:function(h){this.type=h?S0:vr}},_glTexture:{get:function(){return this.impl._glTexture}}});Object.defineProperty(_s.prototype,"boneLimit",{get:function(){return 1024}});Object.defineProperty(_s.prototype,"webgl2",{get:function(){return this.isWebGL2}});Object.defineProperty(_s.prototype,"textureFloatHighPrecision",{get:function(){return!0}});Object.defineProperty(_s.prototype,"extBlendMinmax",{get:function(){return!0}});Object.defineProperty(_s.prototype,"extTextureHalfFloat",{get:function(){return!0}});Object.defineProperty(_s.prototype,"extTextureLod",{get:function(){return!0}});Object.defineProperty(_s.prototype,"textureHalfFloatFilterable",{get:function(){return!0}});Object.defineProperty(_s.prototype,"supportsMrt",{get:function(){return!0}});Object.defineProperty(_s.prototype,"supportsVolumeTextures",{get:function(){return!0}});Object.defineProperty(_s.prototype,"supportsInstancing",{get:function(){return!0}});Object.defineProperty(_s.prototype,"textureHalfFloatUpdatable",{get:function(){return!0}});Object.defineProperty(_s.prototype,"extTextureFloat",{get:function(){return!0}});Object.defineProperty(_s.prototype,"extStandardDerivatives",{get:function(){return!0}});ms.DEFAULT=Object.freeze(new ms);const mi=new ms,qc=new $i;_s.prototype.setBlendFunction=function(h,e){const t=this.blendState;mi.copy(t),mi.setColorBlend(t.colorOp,h,e),mi.setAlphaBlend(t.alphaOp,h,e),this.setBlendState(mi)};_s.prototype.setBlendFunctionSeparate=function(h,e,t,s){const i=this.blendState;mi.copy(i),mi.setColorBlend(i.colorOp,h,e),mi.setAlphaBlend(i.alphaOp,t,s),this.setBlendState(mi)};_s.prototype.setBlendEquation=function(h){const e=this.blendState;mi.copy(e),mi.setColorBlend(h,e.colorSrcFactor,e.colorDstFactor),mi.setAlphaBlend(h,e.alphaSrcFactor,e.alphaDstFactor),this.setBlendState(mi)};_s.prototype.setBlendEquationSeparate=function(h,e){const t=this.blendState;mi.copy(t),mi.setColorBlend(h,t.colorSrcFactor,t.colorDstFactor),mi.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(mi)};_s.prototype.setColorWrite=function(h,e,t,s){const i=this.blendState;mi.copy(i),mi.setColorWrite(h,e,t,s),this.setBlendState(mi)};_s.prototype.getBlending=function(){return this.blendState.blend};_s.prototype.setBlending=function(h){mi.copy(this.blendState),mi.blend=h,this.setBlendState(mi)};_s.prototype.setDepthWrite=function(h){qc.copy(this.depthState),qc.write=h,this.setDepthState(qc)};_s.prototype.setDepthFunc=function(h){qc.copy(this.depthState),qc.func=h,this.setDepthState(qc)};_s.prototype.setDepthTest=function(h){qc.copy(this.depthState),qc.test=h,this.setDepthState(qc)};_s.prototype.getCullMode=function(){return this.cullMode};const Mae=Sx;Object.defineProperty(vn.prototype,"defaultMaterial",{get:function(){return ly(rl().graphicsDevice)}});Object.defineProperty(vn.prototype,"fogColor",{set:function(h){this.fog.color=h},get:function(){return this.fog.color}});Object.defineProperty(vn.prototype,"fogEnd",{set:function(h){this.fog.end=h},get:function(){return this.fog.end}});Object.defineProperty(vn.prototype,"fogStart",{set:function(h){this.fog.start=h},get:function(){return this.fog.start}});Object.defineProperty(vn.prototype,"fogDensity",{set:function(h){this.fog.density=h},get:function(){return this.fog.density}});Object.defineProperty(vn.prototype,"toneMapping",{set:function(h){},get:function(){}});Object.defineProperty(vn.prototype,"gammaCorrection",{set:function(h){},get:function(){}});Object.defineProperty(vn.prototype,"rendering",{set:function(h){},get:function(){}});Object.defineProperty(UA.prototype,"_meshInstances",{get:function(){return null}});Object.defineProperty(vn.prototype,"drawCalls",{get:function(){return null}});["128","64","32","16","8","4"].forEach((h,e)=>{Object.defineProperty(vn.prototype,`skyboxPrefiltered${h}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})});Object.defineProperty(vn.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}});function Pa(h,e,t=""){Object.defineProperty(h.prototype,e,{set:function(s){},get:function(){}})}Pa(Fi,"renderTarget");Pa(Fi,"onPreCull");Pa(Fi,"onPreRender");Pa(Fi,"onPreRenderOpaque");Pa(Fi,"onPreRenderTransparent");Pa(Fi,"onPostCull");Pa(Fi,"onPostRender");Pa(Fi,"onPostRenderOpaque");Pa(Fi,"onPostRenderTransparent");Pa(Fi,"onDrawCall");Pa(Fi,"layerReference");Pa(tu,"onPreCull","Use Scene#EVENT_PRECULL event instead.");Pa(tu,"onPostCull","Use Scene#EVENT_POSTCULL event instead.");Pa(tu,"onPreRender","Use Scene#EVENT_PRERENDER event instead.");Pa(tu,"onPostRender","Use Scene#EVENT_POSTRENDER event instead.");Pa(tu,"onPreRenderLayer","Use Scene#EVENT_PRERENDER_LAYER event instead.");Pa(tu,"onPostRenderLayer","Use Scene#EVENT_POSTRENDER_LAYER event instead.");DP.prototype.renderComposition=function(h){rl().renderComposition(h)};ps.prototype.syncAabb=function(){};VC.prototype.getTarget=function(h){return this.targets[h]};Jt.prototype.getChildren=function(){return this.children};Jt.prototype.getName=function(){return this.name};Jt.prototype.getPath=function(){return this.path};Jt.prototype.getRoot=function(){return this.root};Jt.prototype.getParent=function(){return this.parent};Jt.prototype.setName=function(h){this.name=h};Object.defineProperty(Jc.prototype,"shader",{set:function(h){},get:function(){return null}});Object.defineProperty(Jc.prototype,"blend",{set:function(h){this.blendState.blend=h},get:function(){return this.blendState.blend}});Object.defineProperty(Vi.prototype,"shininess",{get:function(){return this.gloss*100},set:function(h){this.gloss=h*.01}});Object.defineProperty(Vi.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(h){this.useTonemap=h}});function gl(h,e){Object.defineProperty(Vi.prototype,e,{get:function(){return this[h]},set:function(t){this[h]=t}})}function QC(h){Object.defineProperty(Vi.prototype,h,{get:function(){return!0},set:function(e){}})}QC("sheenTint");QC("diffuseTint");QC("emissiveTint");QC("ambientTint");gl("specularTint","specularMapTint");gl("aoVertexColor","aoMapVertexColor");gl("diffuseVertexColor","diffuseMapVertexColor");gl("specularVertexColor","specularMapVertexColor");gl("emissiveVertexColor","emissiveMapVertexColor");gl("metalnessVertexColor","metalnessMapVertexColor");gl("glossVertexColor","glossMapVertexColor");gl("opacityVertexColor","opacityMapVertexColor");gl("lightVertexColor","lightMapVertexColor");gl("sheenGloss","sheenGlossiess");gl("clearCoatGloss","clearCostGlossiness");function R6(h,e){h!=="pass"&&Object.defineProperty(mm.prototype,h,{get:function(){return this.litOptions[e||h]},set:function(t){this.litOptions[e||h]=t}})}R6("refraction","useRefraction");const Dae=new Sx,Z4=Object.getOwnPropertyNames(Dae);for(const h in Z4)R6(Z4[h]);r1.prototype.getAssetById=function(h){return this.get(h)};Object.defineProperty(ym.prototype,"ray",{get:function(){return this._rayLocal}});Object.defineProperty(ym.prototype,"position",{get:function(){return this._localPosition}});Object.defineProperty(ym.prototype,"rotation",{get:function(){return this._localRotation}});const Pae="keydown",Lae="keyup",Iae="mousedown",Oae="mousemove",Nae="mouseup",Fae="mousewheel",Bae="touchstart",Uae="touchend",zae="touchmove",kae="touchcancel",Vae="gamepadconnected",Gae="gamepaddisconnected",Hae="select",Wae="selectstart",qae="selectend";Object.defineProperty(p0.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});Object.defineProperty(Td.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});const Xae=Rp,jae=cr,Yae=cd,Kae=Uz,Qae=JP,$ae=kp,Zae=c1,Jae=zz,ene=kz,tne=e2,sne=qC;fo.prototype.isFullscreen=function(){return!!document.fullscreenElement};fo.prototype.enableFullscreen=function(h,e,t){h=h||this.graphicsDevice.canvas;const s=function(){e(),document.removeEventListener("fullscreenchange",s)},i=function(){t(),document.removeEventListener("fullscreenerror",i)};e&&document.addEventListener("fullscreenchange",s,!1),t&&document.addEventListener("fullscreenerror",i,!1),h.requestFullscreen?h.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):t()};fo.prototype.disableFullscreen=function(h){const e=function(){h(),document.removeEventListener("fullscreenchange",e)};h&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()};fo.prototype.getSceneUrl=function(h){const e=this.scenes.find(h);return e?e.url:null};fo.prototype.loadScene=function(h,e){this.scenes.loadScene(h,e)};fo.prototype.loadSceneHierarchy=function(h,e){this.scenes.loadSceneHierarchy(h,e)};fo.prototype.loadSceneSettings=function(h,e){this.scenes.loadSceneSettings(h,e)};jC.prototype.setVisible=function(h){this.enabled=h};Object.defineProperty(Wc.prototype,"bodyType",{get:function(){return this.type},set:function(h){this.type=h}});Wc.prototype.syncBodyToEntity=function(){this._updateDynamic()};p1.prototype.setGravity=function(){arguments.length===1?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};class ine{constructor(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"))}begin(e){if(!this.enabled)return;this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);const t=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e)}mark(e){if(!this.enabled)return;const t=oo();if(this._frameIndex>0){const s=this._frameTimings[this._frameIndex-1];s[1]=t-s[1]}else if(this._timings.length>0){const s=this._timings[this._timings.length-1];s[1]=t-s[1]}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([e,t]);else{const s=this._frameTimings[this._frameIndex];s[0]=e,s[1]=t}this._frameIndex++}get timings(){return this._timings.slice(0,-1).map(e=>e[1])}}class ane{constructor(e){this.device=e,e.gpuProfiler.enabled=!0,this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,this._timings=[]}get timings(){return this._timings[0]=this.device.gpuProfiler._frameTime,this._timings}}class nne{constructor(e,t,s,i,a){this.app=e,this.values=[],this.statNames=t,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=i,this.decimalPlaces=s,this.multiplier=a||1;const n=(r,l)=>r.split(".").reduce((u,f)=>u?u[f]:null,l||this);e.on("frameupdate",r=>{for(let l=0;l<this.statNames.length;l++)this.values[l]=n(this.statNames[l],this.app.stats)*this.multiplier})}get timings(){return this.values}}class nM{constructor(e,t,s,i,a){this.app=t,this.name=e,this.device=t.graphicsDevice,this.timer=a,this.watermark=s,this.enabled=!1,this.textRefreshRate=i,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this)}destroy(){this.app.off("frameupdate",this.update,this)}loseContext(){this.timer&&typeof this.timer.loseContext=="function"&&this.timer.loseContext()}update(e){const t=this.timer.timings,s=t.reduce((i,a)=>i+a,0);if(this.avgTotal+=s,this.avgTimer+=e,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){let i=0;const a=1.5*this.watermark;for(let r=0;r<t.length;++r)i+=Math.floor(t[r]/a*255),this.sample[r]=i;this.sample[3]=this.watermark/a*255,this.texture.lock().set(this.sample,(this.cursor+this.yOffset*this.texture.width)*4),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}}render(e,t,s,i,a){e.quad(t+i,s,-i,a,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-i,0,this.texture,0)}}class rne{constructor(e,t){const s=y=>{y.font='10px "Lucida Console", Monaco, monospace',y.textAlign="left",y.textBaseline="alphabetic"},i=y=>y==="."||y.length===1&&y.charCodeAt(0)>=48&&y.charCodeAt(0)<=57,a=document.createElement("canvas"),n=a.getContext("2d",{alpha:!0});s(n);const r=new Map,l=5,u=512;let f=l,_=l;t.forEach(y=>{const v=n.measureText(y),x=Math.ceil(-v.actualBoundingBoxLeft),C=Math.ceil(v.actualBoundingBoxRight),M=Math.ceil(v.actualBoundingBoxAscent),w=Math.ceil(v.actualBoundingBoxDescent),T=x+C,R=M+w;f+T+l>=u&&(f=l,_+=16),r.set(y,{l:x,r:C,a:M,d:w,w:T,h:R,x:f,y:_}),f+=T+l}),a.width=512,a.height=ge.nextPowerOfTwo(_+16+l),s(n),n.fillStyle="rgb(0, 0, 0)",n.fillRect(0,0,a.width,a.height),r.forEach((y,v)=>{n.fillStyle=i(v)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",n.fillText(v,y.x-y.l,y.y+y.a)}),this.placements=r;const g=n.getImageData(0,0,a.width,a.height).data;for(let y=0;y<g.length;y+=4)g[y+3]=g[y+0],g[y+0]=255,g[y+1]=255,g[y+2]=255;this.texture=new Ge(e,{name:"mini-stats-word-atlas",width:a.width,height:a.height,mipmaps:!1,minFilter:Je,magFilter:Je,levels:[g]})}destroy(){this.texture.destroy(),this.texture=null}render(e,t,s,i){const a=this.placements.get(t);return a?(e.quad(s+a.l-1,i-a.d+1,a.w+1*2,a.h+1*2,a.x-1,this.texture.height-a.y-a.h-1,void 0,void 0,this.texture,1),a.w):0}}const one=`
	attribute vec3 vertex_position;
	attribute vec4 vertex_texCoord0;
	varying vec4 uv0;
	varying float wordFlag;
	void main(void) {
		gl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);
		uv0 = vertex_texCoord0;
		wordFlag = vertex_position.z;
	}
`,lne=`
		attribute vertex_position: vec3f;         // unnormalized xy, word flag
		attribute vertex_texCoord0: vec4f;        // unnormalized texture space uv, normalized uv

		varying uv0: vec4f;
		varying wordFlag: f32;

		@vertex fn vertexMain(input : VertexInput) -> VertexOutput {
				var output : VertexOutput;
				output.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);
				output.uv0 = input.vertex_texCoord0;
				output.wordFlag = input.vertex_position.z;
				return output;
		}
`,hne=`
	varying vec4 uv0;
	varying float wordFlag;
	uniform vec4 clr;
	uniform sampler2D graphTex;
	uniform sampler2D wordsTex;
	void main (void) {
		vec4 graphSample = texture2D(graphTex, uv0.xy);
		vec4 graph;
		if (uv0.w < graphSample.r)
			graph = vec4(0.7, 0.2, 0.2, 1.0);
		else if (uv0.w < graphSample.g)
			graph = vec4(0.2, 0.7, 0.2, 1.0);
		else if (uv0.w < graphSample.b)
			graph = vec4(0.2, 0.2, 0.7, 1.0);
		else
			graph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));
		vec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));
		gl_FragColor = mix(graph, words, wordFlag) * clr;
	}
`,cne=`
		varying uv0: vec4f;
		varying wordFlag: f32;

		uniform clr: vec4f;

		var graphTex : texture_2d<f32>;
		var graphTex_sampler : sampler;

		var wordsTex : texture_2d<f32>;
		var wordsTex_sampler : sampler;

		@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var uv0: vec4f = input.uv0;
				var graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);

				var graph: vec4f;
				if (uv0.w < graphSample.r) {
						graph = vec4f(0.7, 0.2, 0.2, 1.0);
				} else if (uv0.w < graphSample.g) {
						graph = vec4f(0.2, 0.7, 0.2, 1.0);
				} else if (uv0.w < graphSample.b) {
						graph = vec4f(0.2, 0.2, 0.7, 1.0);
				} else {
						graph = vec4f(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));
				}

				var words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));

				var output: FragmentOutput;
				output.color = mix(graph, words, input.wordFlag) * uniform.clr;
				return output;
		}
`;class une{constructor(e,t=512){const s=new en(e,[{semantic:kt,components:3,type:it},{semantic:Za,components:4,type:it}]),i=new Uint16Array(t*6);for(let n=0;n<t;++n)i[n*6+0]=n*4,i[n*6+1]=n*4+1,i[n*6+2]=n*4+2,i[n*6+3]=n*4,i[n*6+4]=n*4+2,i[n*6+5]=n*4+3;this.device=e,this.buffer=new jn(e,s,t*4,{usage:MD}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new Ah(e,ho,t*6,_r,i),this.prim={type:al,indexed:!0,base:0,count:0},this.quads=0,this.mesh=new Ft(e),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];const a=new Yd({uniqueName:"MiniStats",vertexGLSL:one,fragmentGLSL:hne,vertexWGSL:lne,fragmentWGSL:cne,attributes:{vertex_position:kt,vertex_texCoord0:Za}});this.material=a,a.cull=Xs,a.depthState=$i.NODEPTH,a.blendState=new ms(!0,Qa,N0,F0,Qa,wi,wi),a.update(),this.meshInstance=new ps(this.mesh,a,new Jt("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:e.width,height:e.height}}quad(e,t,s,i,a,n,r,l,u,f=0){const _=this.targetSize.width,g=this.targetSize.height,y=e/_,v=t/g,x=(e+s)/_,C=(t+i)/g,M=u.width,w=u.height,T=a/M,R=n/w,D=(a+(r??s))/M,I=(n+(l??i))/w;this.data.set([y,v,f,T,R,0,0,x,v,f,D,R,1,0,x,C,f,D,I,1,1,y,C,f,T,I,0,1],4*7*this.quads),this.quads++,this.prim.count+=6}startFrame(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight}render(e,t,s,i,a,n){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(a,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",s),this.material.setParameter("wordsTex",i),e.drawMeshInstance(this.meshInstance,t)}}class yL{constructor(e,t){const s=e.graphicsDevice;t=t||yL.getDefaultOptions(),this.initGraphs(e,s,t);const i=new Set(["","ms","0","1","2","3","4","5","6","7","8","9","."].concat(this.graphs.map(n=>n.name)).concat(t.stats?t.stats.map(n=>n.unitsName):[]).filter(n=>!!n));this.wordAtlas=new rne(s,i),this.sizes=t.sizes,this._activeSizeIndex=t.startSizeIndex;const a=document.createElement("div");a.setAttribute("id","mini-stats"),a.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(a),a.addEventListener("mouseenter",n=>{this.opacity=1}),a.addEventListener("mouseleave",n=>{this.opacity=.7}),a.addEventListener("click",n=>{n.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs))}),s.on("resizecanvas",this.updateDiv,this),s.on("losecontext",this.loseContext,this),e.on("postrender",this.postRender,this),this.app=e,this.drawLayer=e.scene.layers.getLayerById(ty),this.device=s,this.render2d=new une(s),this.div=a,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}destroy(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach(e=>e.destroy()),this.wordAtlas.destroy(),this.texture.destroy()}static getDefaultOptions(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}}set activeSizeIndex(e){this._activeSizeIndex=e,this.gspacing=this.sizes[e].spacing,this.resize(this.sizes[e].width,this.sizes[e].height,this.sizes[e].graphs)}get activeSizeIndex(){return this._activeSizeIndex}set opacity(e){this.clr[3]=e}get opacity(){return this.clr[3]}get overallHeight(){const e=this.graphs,t=this.gspacing;return this.height*e.length+t*(e.length-1)}set enabled(e){if(e!==this._enabled){this._enabled=e;for(let t=0;t<this.graphs.length;++t)this.graphs[t].enabled=e,this.graphs[t].timer.enabled=e}}get enabled(){return this._enabled}initGraphs(e,t,s){if(this.graphs=[],s.cpu.enabled){const a=new ine(e),n=new nM("CPU",e,s.cpu.watermark,s.textRefreshRate,a);this.graphs.push(n)}if(s.gpu.enabled){const a=new ane(t),n=new nM("GPU",e,s.gpu.watermark,s.textRefreshRate,a);this.graphs.push(n)}s.stats&&s.stats.forEach(a=>{const n=new nne(e,a.stats,a.decimalPlaces,a.unitsName,a.multiplier),r=new nM(a.name,e,a.watermark,s.textRefreshRate,n);this.graphs.push(r)});const i=s.sizes.reduce((a,n)=>n.width>a?n.width:a,0);this.texture=new Ge(t,{name:"mini-stats-graph-texture",width:ge.nextPowerOfTwo(i),height:ge.nextPowerOfTwo(this.graphs.length),mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Zs,addressV:Zs}),this.graphs.forEach((a,n)=>{a.texture=this.texture,a.yOffset=n})}render(){const e=this.graphs,t=this.wordAtlas,s=this.render2d,i=this.width,a=this.height,n=this.gspacing;s.startFrame();for(let r=0;r<e.length;++r){const l=e[r];let u=r*(a+n);l.render(s,0,u,i,a);let f=1;u+=a-13,f+=t.render(s,l.name,f,u)+10;const _=l.timingText;for(let g=0;g<_.length;++g)f+=t.render(s,_[g],f,u);l.timer.unitsName&&(f+=3,t.render(s,l.timer.unitsName,f,u))}s.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,a)}resize(e,t,s){const i=this.graphs;for(let a=0;a<i.length;++a)i[a].enabled=s;this.width=e,this.height=t,this.updateDiv()}updateDiv(){const e=this.device.canvas.getBoundingClientRect();this.div.style.left=`${e.left}px`,this.div.style.bottom=`${window.innerHeight-e.bottom}px`,this.div.style.width=`${this.width}px`,this.div.style.height=`${this.overallHeight}px`}loseContext(){this.graphs.forEach(e=>e.loseContext())}postRender(){this._enabled&&this.render()}}const dne=`
	varying vec2 vUv0;
	uniform vec2 uOffset;
	uniform float uSrcMultiplier;
	uniform sampler2D source;
	void main(void)
	{
		vec4 pixel;
		vec4 texel = texture2D(source, vUv0);
		vec4 firstTexel = texel;
		float diff = texel.a * uSrcMultiplier;
		pixel = texture2D(source, vUv0 + uOffset * -2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * -1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * 1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * 2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
	   gl_FragColor = vec4(texel.rgb, min(diff, 1.0));
	}
`,wg=new Float32Array(2),JE=new xe;class fne{constructor(e,t,s=-1){this.app=e,this.renderingLayer=t??e.scene.layers.getLayerByName("Immediate"),this.rt=this.createRenderTarget("OutlineTexture",1,1,!0),this.outlineCameraEntity=new Kt("OutlineCamera"),this.outlineCameraEntity.addComponent("camera",{layers:[this.renderingLayer.id],priority:s,clearColor:new xe(0,0,0,0),renderTarget:this.rt}),this.outlineShaderPass=this.outlineCameraEntity.camera.setShaderPass("OutlineShaderPass"),this.postRender=n=>{this.outlineCameraEntity.camera===n&&this.onPostRender()},e.scene.on("postrender",this.postRender),this.app.root.addChild(this.outlineCameraEntity),this.tempRt=this.createRenderTarget("OutlineTempTexture",1,1,!1),this.blendState=new ms(!0,Qa,N0,F0);const i=this.app.graphicsDevice;this.shaderExtend=Da(i,dt.fullscreenQuadVS,dne,"OutlineExtendShader"),this.shaderBlend=Da(i,dt.fullscreenQuadVS,dt.outputTex2DPS,"OutlineBlendShader"),this.quadRenderer=new C0(this.shaderBlend),this.whiteTex=new Ge(i,{name:"OutlineWhiteTexture",width:1,height:1,format:ki,mipmaps:!1}),this.whiteTex.lock().set(new Uint8Array([255,255,255,255])),this.whiteTex.unlock()}destroy(){var e;this.whiteTex.destroy(),this.whiteTex=null,this.outlineCameraEntity.destroy(),this.outlineCameraEntity=null,this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null,this.tempRt.destroyTextureBuffers(),this.tempRt.destroy(),this.tempRt=null,this.app.scene.off("postrender",this.postRender),(e=this.quadRenderer)==null||e.destroy(),this.quadRenderer=null}getMeshInstances(e,t){const s=[];return(t?e.findComponents("render"):e.render?[e.render]:[]).forEach(n=>{n.meshInstances&&s.push(...n.meshInstances)}),(t?e.findComponents("model"):e.model?[e.model]:[]).forEach(n=>{n.meshInstances&&s.push(...n.meshInstances)}),s}addEntity(e,t,s=!0){const i=this.getMeshInstances(e,s);i.forEach(a=>{if(a.material instanceof Vi){const n=this.outlineShaderPass;a.material.onUpdateShader=l=>{if(l.pass===n){const u=new mm;return u.defines=l.defines,u.opacityMap=l.opacityMap,u.opacityMapUv=l.opacityMapUv,u.opacityMapChannel=l.opacityMapChannel,u.opacityMapTransform=l.opacityMapTransform,u.opacityVertexColor=l.opacityVertexColor,u.opacityVertexColorChannel=l.opacityVertexColorChannel,u.litOptions.vertexColors=l.litOptions.vertexColors,u.litOptions.alphaTest=l.litOptions.alphaTest,u.litOptions.skin=l.litOptions.skin,u.litOptions.batch=l.litOptions.batch,u.litOptions.useInstancing=l.litOptions.useInstancing,u.litOptions.useMorphPosition=l.litOptions.useMorphPosition,u.litOptions.useMorphNormal=l.litOptions.useMorphNormal,u.litOptions.useMorphTextureBasedInt=l.litOptions.useMorphTextureBasedInt,u}return l},JE.linear(t);const r=new Float32Array([JE.r,JE.g,JE.b]);a.setParameter("material_emissive",r,1<<this.outlineShaderPass),a.setParameter("texture_emissiveMap",this.whiteTex,1<<this.outlineShaderPass)}}),this.renderingLayer.addMeshInstances(i,!0)}removeEntity(e,t=!0){const s=this.getMeshInstances(e,t);this.renderingLayer.removeMeshInstances(s),s.forEach(i=>{i.material instanceof Vi&&(i.material.onUpdateShader=null,i.deleteParameter("material_emissive"))})}removeAllEntities(){this.renderingLayer.clearMeshInstances()}blendOutlines(){const e=this.app.graphicsDevice;e.scope.resolve("source").setValue(this.rt.colorBuffer),e.setDepthState($i.NODEPTH),e.setCullMode(Xs),e.setBlendState(this.blendState),this.quadRenderer.render()}onPostRender(){const e=this.app.graphicsDevice,t=e.scope.resolve("uOffset"),s=e.scope.resolve("source"),i=e.scope.resolve("uSrcMultiplier"),{rt:a,tempRt:n,shaderExtend:r}=this,{width:l,height:u}=a;wg[0]=1/l/2,wg[1]=0,t.setValue(wg),s.setValue(a.colorBuffer),i.setValue(0),qn(e,n,r),wg[0]=0,wg[1]=1/u/2,t.setValue(wg),s.setValue(n.colorBuffer),i.setValue(1),qn(e,a,r)}createRenderTarget(e,t,s,i){const a=new Ge(this.app.graphicsDevice,{name:e,width:t,height:s,format:ki,mipmaps:!1,addressU:Oe,addressV:Oe,minFilter:lo,magFilter:Vt});return new fs({colorBuffer:a,depth:i,flipY:this.app.graphicsDevice.isWebGPU})}updateRenderTarget(e){var a,n;const t=((a=e.renderTarget)==null?void 0:a.width)??this.app.graphicsDevice.width,s=((n=e.renderTarget)==null?void 0:n.height)??this.app.graphicsDevice.height,i=this.outlineCameraEntity.camera;(!i.renderTarget||i.renderTarget.width!==t||i.renderTarget.height!==s)&&(this.rt.resize(t,s),this.tempRt.resize(t,s))}frameUpdate(e,t,s){const i=e.camera;this.updateRenderTarget(i);const a=this.app.scene.on("prerender:layer",(r,l,u)=>{i===r&&u===s&&l===t&&(this.blendOutlines(),a.off())});this.outlineCameraEntity.setLocalPosition(e.getPosition()),this.outlineCameraEntity.setLocalRotation(e.getRotation());const n=this.outlineCameraEntity.camera;n.projection=i.projection,n.horizontalFov=i.horizontalFov,n.fov=i.fov,n.orthoHeight=i.orthoHeight,n.nearClip=i.nearClip,n.farClip=i.farClip}}const pne=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
	}`,mne=`
	varying vec2 uv0;
	uniform sampler2D blitTexture;
	void main(void) {
		gl_FragColor = texture2D(blitTexture, uv0);
	}`;class M6{constructor(){}textureToCanvas(e,t={}){const s=e.getSource();if(typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap){const{width:_,height:g}=this.calcTextureSize(s.width,s.height,t.maxTextureSize),y=document.createElement("canvas");y.width=_,y.height=g;const v=y.getContext("2d");if(v===null)return Promise.resolve(void 0);if(v.drawImage(s,0,0,y.width,y.height),t.color){const{r:x,g:C,b:M}=t.color,w=v.getImageData(0,0,_,g),T=w.data;for(let R=0;R<T.length;R+=4)T[R+0]=T[R+0]*x,T[R+1]=T[R+1]*C,T[R+2]=T[R+2]*M;v.putImageData(w,0,0)}return Promise.resolve(y)}const i=e.device,{width:a,height:n}=this.calcTextureSize(e.width,e.height,t.maxTextureSize),r=qb(e.format)?Lt:e.format,l=new Ge(i,{name:"ExtractedTexture",width:a,height:n,format:r,cubemap:!1,mipmaps:!1,minFilter:Vt,magFilter:Vt,addressU:Oe,addressV:Oe}),u=new fs({colorBuffer:l,depth:!1}),f=Da(i,pne,mne,"ShaderCoreExporterBlit");return i.scope.resolve("blitTexture").setValue(e),i.setBlendState(ms.NOBLEND),qn(i,u,f),l.read(0,0,a,n,{renderTarget:u,immediate:!0}).then(_=>{l.destroy(),u.destroy();const g=new Uint8ClampedArray(a*n*4);g.set(_);const y=new ImageData(g,a,n),v=document.createElement("canvas");v.width=a,v.height=n;const x=v.getContext("2d");return x?(x.putImageData(y,0,0),Promise.resolve(v)):Promise.resolve(void 0)})}calcTextureSize(e,t,s){if(s){const i=Math.min(s/Math.max(e,t),1);e=Math.round(e*i),t=Math.round(t*i)}return{width:e,height:t}}}var tn=Uint8Array,dr=Uint16Array,vL=Int32Array,SL=new tn([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),bL=new tn([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),J4=new tn([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),D6=function(h,e){for(var t=new dr(31),s=0;s<31;++s)t[s]=e+=1<<h[s-1];for(var i=new vL(t[30]),s=1;s<30;++s)for(var a=t[s];a<t[s+1];++a)i[a]=a-t[s]<<5|s;return{b:t,r:i}},P6=D6(SL,2),_ne=P6.b,sD=P6.r;_ne[28]=258,sD[258]=28;var gne=D6(bL,0),eN=gne.r,iD=new dr(32768);for(var qs=0;qs<32768;++qs){var ad=(qs&43690)>>1|(qs&21845)<<1;ad=(ad&52428)>>2|(ad&13107)<<2,ad=(ad&61680)>>4|(ad&3855)<<4,iD[qs]=((ad&65280)>>8|(ad&255)<<8)>>1}var Qp=function(h,e,t){for(var s=h.length,i=0,a=new dr(e);i<s;++i)h[i]&&++a[h[i]-1];var n=new dr(e);for(i=1;i<e;++i)n[i]=n[i-1]+a[i-1]<<1;var r;if(t){r=new dr(1<<e);var l=15-e;for(i=0;i<s;++i)if(h[i])for(var u=i<<4|h[i],f=e-h[i],_=n[h[i]-1]++<<f,g=_|(1<<f)-1;_<=g;++_)r[iD[_]>>l]=u}else for(r=new dr(s),i=0;i<s;++i)h[i]&&(r[i]=iD[n[h[i]-1]++]>>15-h[i]);return r},$d=new tn(288);for(var qs=0;qs<144;++qs)$d[qs]=8;for(var qs=144;qs<256;++qs)$d[qs]=9;for(var qs=256;qs<280;++qs)$d[qs]=7;for(var qs=280;qs<288;++qs)$d[qs]=8;var x1=new tn(32);for(var qs=0;qs<32;++qs)x1[qs]=5;var yne=Qp($d,9,0);Qp($d,9,1);var vne=Qp(x1,5,0);Qp(x1,5,1);var L6=function(h){return(h+7)/8|0},I6=function(h,e,t){return(t==null||t>h.length)&&(t=h.length),new tn(h.subarray(e,t))},Sne=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],$C=function(h,e,t){var s=new Error(e||Sne[h]);if(s.code=h,Error.captureStackTrace&&Error.captureStackTrace(s,$C),!t)throw s;return s},bc=function(h,e,t){t<<=e&7;var s=e/8|0;h[s]|=t,h[s+1]|=t>>8},hS=function(h,e,t){t<<=e&7;var s=e/8|0;h[s]|=t,h[s+1]|=t>>8,h[s+2]|=t>>16},rM=function(h,e){for(var t=[],s=0;s<h.length;++s)h[s]&&t.push({s,f:h[s]});var i=t.length,a=t.slice();if(!i)return{t:N6,l:0};if(i==1){var n=new tn(t[0].s+1);return n[t[0].s]=1,{t:n,l:1}}t.sort(function(D,I){return D.f-I.f}),t.push({s:-1,f:25001});var r=t[0],l=t[1],u=0,f=1,_=2;for(t[0]={s:-1,f:r.f+l.f,l:r,r:l};f!=i-1;)r=t[t[u].f<t[_].f?u++:_++],l=t[u!=f&&t[u].f<t[_].f?u++:_++],t[f++]={s:-1,f:r.f+l.f,l:r,r:l};for(var g=a[0].s,s=1;s<i;++s)a[s].s>g&&(g=a[s].s);var y=new dr(g+1),v=aD(t[f-1],y,0);if(v>e){var s=0,x=0,C=v-e,M=1<<C;for(a.sort(function(I,U){return y[U.s]-y[I.s]||I.f-U.f});s<i;++s){var w=a[s].s;if(y[w]>e)x+=M-(1<<v-y[w]),y[w]=e;else break}for(x>>=C;x>0;){var T=a[s].s;y[T]<e?x-=1<<e-y[T]++-1:++s}for(;s>=0&&x;--s){var R=a[s].s;y[R]==e&&(--y[R],++x)}v=e}return{t:new tn(y),l:v}},aD=function(h,e,t){return h.s==-1?Math.max(aD(h.l,e,t+1),aD(h.r,e,t+1)):e[h.s]=t},tN=function(h){for(var e=h.length;e&&!h[--e];);for(var t=new dr(++e),s=0,i=h[0],a=1,n=function(l){t[s++]=l},r=1;r<=e;++r)if(h[r]==i&&r!=e)++a;else{if(!i&&a>2){for(;a>138;a-=138)n(32754);a>2&&(n(a>10?a-11<<5|28690:a-3<<5|12305),a=0)}else if(a>3){for(n(i),--a;a>6;a-=6)n(8304);a>2&&(n(a-3<<5|8208),a=0)}for(;a--;)n(i);a=1,i=h[r]}return{c:t.subarray(0,s),n:e}},cS=function(h,e){for(var t=0,s=0;s<e.length;++s)t+=h[s]*e[s];return t},O6=function(h,e,t){var s=t.length,i=L6(e+2);h[i]=s&255,h[i+1]=s>>8,h[i+2]=h[i]^255,h[i+3]=h[i+1]^255;for(var a=0;a<s;++a)h[i+a+4]=t[a];return(i+4+s)*8},sN=function(h,e,t,s,i,a,n,r,l,u,f){bc(e,f++,t),++i[256];for(var _=rM(i,15),g=_.t,y=_.l,v=rM(a,15),x=v.t,C=v.l,M=tN(g),w=M.c,T=M.n,R=tN(x),D=R.c,I=R.n,U=new dr(19),O=0;O<w.length;++O)++U[w[O]&31];for(var O=0;O<D.length;++O)++U[D[O]&31];for(var N=rM(U,7),z=N.t,X=N.l,Y=19;Y>4&&!z[J4[Y-1]];--Y);var F=u+5<<3,q=cS(i,$d)+cS(a,x1)+n,G=cS(i,g)+cS(a,x)+n+14+3*Y+cS(U,z)+2*U[16]+3*U[17]+7*U[18];if(l>=0&&F<=q&&F<=G)return O6(e,f,h.subarray(l,l+u));var W,k,K,ee;if(bc(e,f,1+(G<q)),f+=2,G<q){W=Qp(g,y,0),k=g,K=Qp(x,C,0),ee=x;var V=Qp(z,X,0);bc(e,f,T-257),bc(e,f+5,I-1),bc(e,f+10,Y-4),f+=14;for(var O=0;O<Y;++O)bc(e,f+3*O,z[J4[O]]);f+=3*Y;for(var Q=[w,D],se=0;se<2;++se)for(var J=Q[se],O=0;O<J.length;++O){var ie=J[O]&31;bc(e,f,V[ie]),f+=z[ie],ie>15&&(bc(e,f,J[O]>>5&127),f+=J[O]>>12)}}else W=yne,k=$d,K=vne,ee=x1;for(var O=0;O<r;++O){var oe=s[O];if(oe>255){var ie=oe>>18&31;hS(e,f,W[ie+257]),f+=k[ie+257],ie>7&&(bc(e,f,oe>>23&31),f+=SL[ie]);var he=oe&31;hS(e,f,K[he]),f+=ee[he],he>3&&(hS(e,f,oe>>5&8191),f+=bL[he])}else hS(e,f,W[oe]),f+=k[oe]}return hS(e,f,W[256]),f+k[256]},bne=new vL([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),N6=new tn(0),xne=function(h,e,t,s,i,a){var n=a.z||h.length,r=new tn(s+n+5*(1+Math.ceil(n/7e3))+i),l=r.subarray(s,r.length-i),u=a.l,f=(a.r||0)&7;if(e){f&&(l[0]=a.r>>3);for(var _=bne[e-1],g=_>>13,y=_&8191,v=(1<<t)-1,x=a.p||new dr(32768),C=a.h||new dr(v+1),M=Math.ceil(t/3),w=2*M,T=function(mt){return(h[mt]^h[mt+1]<<M^h[mt+2]<<w)&v},R=new vL(25e3),D=new dr(288),I=new dr(32),U=0,O=0,N=a.i||0,z=0,X=a.w||0,Y=0;N+2<n;++N){var F=T(N),q=N&32767,G=C[F];if(x[q]=G,C[F]=q,X<=N){var W=n-N;if((U>7e3||z>24576)&&(W>423||!u)){f=sN(h,l,0,R,D,I,O,z,Y,N-Y,f),z=U=O=0,Y=N;for(var k=0;k<286;++k)D[k]=0;for(var k=0;k<30;++k)I[k]=0}var K=2,ee=0,V=y,Q=q-G&32767;if(W>2&&F==T(N-Q))for(var se=Math.min(g,W)-1,J=Math.min(32767,N),ie=Math.min(258,W);Q<=J&&--V&&q!=G;){if(h[N+K]==h[N+K-Q]){for(var oe=0;oe<ie&&h[N+oe]==h[N+oe-Q];++oe);if(oe>K){if(K=oe,ee=Q,oe>se)break;for(var he=Math.min(Q,oe-2),te=0,k=0;k<he;++k){var le=N-Q+k&32767,Se=x[le],Ae=le-Se&32767;Ae>te&&(te=Ae,G=le)}}}q=G,G=x[q],Q+=q-G&32767}if(ee){R[z++]=268435456|sD[K]<<18|eN[ee];var De=sD[K]&31,Fe=eN[ee]&31;O+=SL[De]+bL[Fe],++D[257+De],++I[Fe],X=N+K,++U}else R[z++]=h[N],++D[h[N]]}}for(N=Math.max(N,X);N<n;++N)R[z++]=h[N],++D[h[N]];f=sN(h,l,u,R,D,I,O,z,Y,N-Y,f),u||(a.r=f&7|l[f/8|0]<<3,f-=7,a.h=C,a.p=x,a.i=N,a.w=X)}else{for(var N=a.w||0;N<n+u;N+=65535){var ot=N+65535;ot>=n&&(l[f/8|0]=u,ot=n),f=O6(l,f+1,h.subarray(N,ot))}a.i=n}return I6(r,0,s+L6(f)+i)},Tne=function(){for(var h=new Int32Array(256),e=0;e<256;++e){for(var t=e,s=9;--s;)t=(t&1&&-306674912)^t>>>1;h[e]=t}return h}(),Ene=function(){var h=-1;return{p:function(e){for(var t=h,s=0;s<e.length;++s)t=Tne[t&255^e[s]]^t>>>8;h=t},d:function(){return~h}}},Ane=function(h,e,t,s,i){if(!i&&(i={l:1},e.dictionary)){var a=e.dictionary.subarray(-32768),n=new tn(a.length+h.length);n.set(a),n.set(h,a.length),h=n,i.w=a.length}return xne(h,e.level==null?6:e.level,e.mem==null?i.l?Math.ceil(Math.max(8,Math.min(13,Math.log(h.length)))*1.5):20:12+e.mem,t,s,i)},F6=function(h,e){var t={};for(var s in h)t[s]=h[s];for(var s in e)t[s]=e[s];return t},Ra=function(h,e,t){for(;t;++e)h[e]=t,t>>>=8};function Cne(h,e){return Ane(h,e||{},0,0)}var B6=function(h,e,t,s){for(var i in h){var a=h[i],n=e+i,r=s;Array.isArray(a)&&(r=F6(s,a[1]),a=a[0]),a instanceof tn?t[n]=[a,r]:(t[n+="/"]=[new tn(0),r],B6(a,n,t,s))}},iN=typeof TextEncoder<"u"&&new TextEncoder,wne=typeof TextDecoder<"u"&&new TextDecoder,Rne=0;try{wne.decode(N6,{stream:!0}),Rne=1}catch{}function nD(h,e){var t;if(iN)return iN.encode(h);for(var s=h.length,i=new tn(h.length+(h.length>>1)),a=0,n=function(u){i[a++]=u},t=0;t<s;++t){if(a+5>i.length){var r=new tn(a+8+(s-t<<1));r.set(i),i=r}var l=h.charCodeAt(t);l<128||e?n(l):l<2048?(n(192|l>>6),n(128|l&63)):l>55295&&l<57344?(l=65536+(l&1047552)|h.charCodeAt(++t)&1023,n(240|l>>18),n(128|l>>12&63),n(128|l>>6&63),n(128|l&63)):(n(224|l>>12),n(128|l>>6&63),n(128|l&63))}return I6(i,0,a)}var rD=function(h){var e=0;if(h)for(var t in h){var s=h[t].length;s>65535&&$C(9),e+=s+4}return e},aN=function(h,e,t,s,i,a,n,r){var l=s.length,u=t.extra,f=r&&r.length,_=rD(u);Ra(h,e,n!=null?33639248:67324752),e+=4,n!=null&&(h[e++]=20,h[e++]=t.os),h[e]=20,e+=2,h[e++]=t.flag<<1|(a<0&&8),h[e++]=i&&8,h[e++]=t.compression&255,h[e++]=t.compression>>8;var g=new Date(t.mtime==null?Date.now():t.mtime),y=g.getFullYear()-1980;if((y<0||y>119)&&$C(10),Ra(h,e,y<<25|g.getMonth()+1<<21|g.getDate()<<16|g.getHours()<<11|g.getMinutes()<<5|g.getSeconds()>>1),e+=4,a!=-1&&(Ra(h,e,t.crc),Ra(h,e+4,a<0?-a-2:a),Ra(h,e+8,t.size)),Ra(h,e+12,l),Ra(h,e+14,_),e+=16,n!=null&&(Ra(h,e,f),Ra(h,e+6,t.attrs),Ra(h,e+10,n),e+=14),h.set(s,e),e+=l,_)for(var v in u){var x=u[v],C=x.length;Ra(h,e,+v),Ra(h,e+2,C),h.set(x,e+4),e+=4+C}return f&&(h.set(r,e),e+=f),e},Mne=function(h,e,t,s,i){Ra(h,e,101010256),Ra(h,e+8,t),Ra(h,e+10,t),Ra(h,e+12,s),Ra(h,e+16,i)};function Dne(h,e){e||(e={});var t={},s=[];B6(h,"",t,e);var i=0,a=0;for(var n in t){var r=t[n],l=r[0],u=r[1],f=u.level==0?0:8,_=nD(n),g=_.length,y=u.comment,v=y&&nD(y),x=v&&v.length,C=rD(u.extra);g>65535&&$C(11);var M=f?Cne(l,u):l,w=M.length,T=Ene();T.p(l),s.push(F6(u,{size:l.length,crc:T.d(),c:M,f:_,m:v,u:g!=n.length||v&&y.length!=x,o:i,compression:f})),i+=30+g+C+w,a+=76+2*(g+C)+(x||0)+w}for(var R=new tn(a+22),D=i,I=a-i,U=0;U<s.length;++U){var _=s[U];aN(R,_.o,_,_.f,_.u,_.c.length);var O=30+_.f.length+rD(_.extra);R.set(_.c,_.o+O),aN(R,i,_,_.f,_.u,_.c.length,_.o,_.m),i+=16+O+(_.m?_.m.length:0)}return Mne(R,i,s.length,I,D),R}const nN="root",Pne=`#usda 1.0
(
		customLayerData = {
				string creator = "PlayCanvas UsdzExporter"
		}
		metersPerUnit = 1
		upAxis = "Y"
)
`,Lne=h=>`
def "Materials"
{
		${h.join(`
`)}
}
`,Ine=(h,e,t,s,i,a)=>`
def "Mesh"
{
		def Mesh "Mesh"
		{
				int[] faceVertexCounts = [${h}]
				int[] faceVertexIndices = [${e}]
				normal3f[] normals = [${t}] (
						interpolation = "vertex"
				)
				point3f[] points = [${s}]
				texCoord2f[] primvars:st = [${i}] (
						interpolation = "vertex"
				)
				texCoord2f[] primvars:st1 = [${a}] (
						interpolation = "vertex"
				)
				uniform token subdivisionScheme = "none"
		}
}
`,One=(h,e,t,s)=>`
def Xform "${h}" (
		prepend references = ${e}
)
{
		matrix4d xformOp:transform = ${t}
		uniform token[] xformOpOrder = ["xformOp:transform"]

		rel material:binding = ${s}
}
`,rN=(h,e,t)=>`                    ${h} inputs:${e} = ${t}`;class Nne extends M6{init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null}build(e,t={}){this.init(),this.addFile(null,nN);const s=[];e&&e.findComponents("render").forEach(f=>{s.push(...f.meshInstances)});let i="";s.forEach(u=>{i+=this.buildMeshInstance(u)}),i+=Lne(this.materials),this.addFile(null,nN,"",i);const a={maxTextureSize:t.maxTextureSize},n=Array.from(this.textureMap.keys()),r=[];for(let u=0;u<n.length;u++){const f="image/png",_=n[u],g=this.textureToCanvas(_,a).then(y=>y?new Promise(v=>y.toBlob(v,f,1)).then(v=>v.arrayBuffer()):(console.warn(`Export of texture ${_.name} is not currently supported.`),new Promise(v=>v(null))));r.push(g)}return Promise.all(r).then(u=>{u.forEach((_,g)=>{const y=n[g],v=this.getTextureFileIds(y);this.files[v.fileName]=new Uint8Array(_)}),this.alignFiles();const f=Dne(this.files,{level:0});return this.done(),f})}alignFiles(){let e=0;for(const t in this.files){const s=this.files[t],i=34+t.length;e+=i;const a=e&63;if(a!==4){const n=64-a,r=new Uint8Array(n);this.files[t]=[s,{extra:{12345:r}}]}e=s.length}}getFileIds(e,t,s,i="usda"){const a=`${e?`${e}/`:""}${t}.${i}`,n=`@./${a}@</${s}>`;return{name:t,fileName:a,refName:n}}getTextureFileIds(e){return this.getFileIds("texture",`Texture_${e.id}`,"Texture","png")}addFile(e,t,s="",i=""){let a=null;i&&(i=`${Pne}
${i}`,a=nD(i));const n=this.getFileIds(e,t,s);return this.files[n.fileName]=a,n.refName}getMaterialRef(e){let t=this.materialMap.get(e);return t||(t=this.buildMaterial(e),this.materialMap.set(e,t)),t}getMeshRef(e){let t=this.meshMap.get(e);return t||(t=this.buildMesh(e),this.meshMap.set(e,t)),t}buildArray2(e){const t=[],s=e.length;for(let i=0;i<s;i+=2)t.push(`(${e[i]}, ${1-e[i+1]})`);return t.join(", ")}buildArray3(e){const t=[],s=e.length;for(let i=0;i<s;i+=3)t.push(`(${e[i]}, ${e[i+1]}, ${e[i+2]})`);return t.join(", ")}buildMat4(e){const t=e.data,s=[];for(let i=0;i<16;i+=4)s.push(`(${t[i]}, ${t[i+1]}, ${t[i+2]}, ${t[i+3]})`);return`( ${s.join(", ")} )`}buildMaterial(e){const t=`Material_${e.id}`,s=`/Materials/${t}`,i=f=>`<${s}${f}>`,a=(f,_,g,y,v,x,C,M)=>`
								def Shader "Transform2d_${g}" (
										sdrMetadata = {
												string role = "math"
										}
								)
								{
										uniform token info:id = "UsdTransform2d"
										float2 inputs:in.connect = ${i(`/uvReader_${y}.outputs:result`)}
										float inputs:rotation = ${C}
										float2 inputs:scale = (${v.x}, ${v.y})
										float2 inputs:translation = (${x.x}, ${x.y})
										float2 outputs:result
								}

								def Shader "Texture_${f.id}_${g}"
								{
										uniform token info:id = "UsdUVTexture"
										asset inputs:file = @${_.fileName}@
										float2 inputs:st.connect = ${i(`/Transform2d_${g}.outputs:result`)}
										token inputs:wrapS = "repeat"
										token inputs:wrapT = "repeat"
										float4 inputs:scale = (${M.r}, ${M.g}, ${M.b}, ${M.a})
										float outputs:r
										float outputs:g
										float outputs:b
										float3 outputs:rgb
										float outputs:a
								}
						`,n=[],r=[],l=(f,_,g,y,v,x=!1,C=!1)=>{const M=e[f];if(M){const w=this.getTextureFileIds(M);this.textureMap.set(M,w.refName);const T=e[`${f}Channel`]||"rgb",R=i(`/${w.name}_${v}.outputs:${T}`);n.push(rN(g,`${y}.connect`,R)),x&&e.alphaTest>0;const D=e[`${f}Tiling`],I=e[`${f}Offset`],U=e[`${f}Rotation`],O=e[`${f}Uv`]===1?"st1":"st",N=C&&_?_:xe.WHITE;r.push(a(M,w,v,O,D,I,U,N))}else if(_){const w=g==="float"?`${_}`:`(${_.r}, ${_.g}, ${_.b})`;n.push(rN(g,y,w))}};l("diffuseMap",e.diffuse,"color3f","diffuseColor","diffuse",!1,!0),(e.transparent||e.alphaTest>0)&&l("opacityMap",e.opacity,"float","opacity","opacity",!0),l("normalMap",null,"normal3f","normal","normal"),l("emissiveMap",e.emissive,"color3f","emissiveColor","emissive",!1,!0),l("aoMap",null,"float","occlusion","occlusion"),l("metalnessMap",e.metalness,"float","metallic","metallic"),l("glossMap",e.gloss,"float","roughness","roughness");const u=`
						def Material "${t}"
						{
								def Shader "PreviewSurface"
								{
										uniform token info:id = "UsdPreviewSurface"
${n.join(`
`)}
										int inputs:useSpecularWorkflow = 0
										token outputs:surface
								}

								token outputs:surface.connect = ${i("/PreviewSurface.outputs:surface")}

								def Shader "uvReader_st"
								{
										uniform token info:id = "UsdPrimvarReader_float2"
										token inputs:varname = "st"
										float2 inputs:fallback = (0.0, 0.0)
										float2 outputs:result
								}

								def Shader "uvReader_st1"
								{
										uniform token info:id = "UsdPrimvarReader_float2"
										token inputs:varname = "st1"
										float2 inputs:fallback = (0.0, 0.0)
										float2 outputs:result
								}

								${r.join(`
`)}
						}
				`;return this.materials.push(u),i("")}buildMesh(e){let t=[];const s=[];let i=[],a=[],n=[];e.getVertexStream(kt,t),e.getVertexStream($a,i),e.getVertexStream(Za,a),e.getVertexStream(Mh,n),e.getIndices(s);const r=s.length||t.length,l=Array(r/3).fill(3).join(", ");if(!s.length)for(let g=0;g<r;g++)s[g]=g;const u=t.length/3;i=i.length?i:Array(u*3).fill(0),a=a.length?a:Array(u*2).fill(0),n=n.length?n:Array(u*2).fill(0),t=this.buildArray3(t),i=this.buildArray3(i),a=this.buildArray2(a),n=this.buildArray2(n);const f=Ine(l,s,i,t,a,n);return this.addFile("mesh",`Mesh_${e.id}`,"Mesh",f)}buildMeshInstance(e){const t=this.getMeshRef(e.mesh),s=this.getMaterialRef(e.material),i=this.buildMat4(e.node.getWorldTransform()),a=e.node.name.replace(/[^a-z0-9]/gi,"_");let n=a;for(;this.nodeNames.has(n);)n=`${a}_${Math.random().toString(36).slice(2,7)}`;return this.nodeNames.add(n),One(n,t,i,s)}}const oM=34962,oN=34963,Fne=h=>{switch(h){case Bb:return 5121;case ho:return 5123;case Th:return 5125}return 0},lN=h=>{switch(h){case ml:return 5120;case io:return 5121;case _l:return 5122;case Dh:return 5123;case jt:return 5124;case Ai:return 5125;case it:return 5126}return 0},Bne=h=>{switch(h){case 1:return"SCALAR";case 2:return"VEC2";case 3:return"VEC3";case 4:return"VEC4"}return 0},Une=h=>{switch(h){case kt:return"POSITION";case $a:return"NORMAL";case po:return"TANGENT";case Qi:return"COLOR_0";case gn:return"JOINTS_0";case co:return"WEIGHTS_0";case Za:return"TEXCOORD_0";case Mh:return"TEXCOORD_1";case Rm:return"TEXCOORD_2";case Mm:return"TEXCOORD_3";case Dm:return"TEXCOORD_4";case Pm:return"TEXCOORD_5";case Lm:return"TEXCOORD_6";case Im:return"TEXCOORD_7"}return""},hN=function(h){switch(h){case Je:return 9728;case Vt:return 9729;case vm:return 9984;case bm:return 9985;case Sm:return 9986;case lo:return 9987}return 0},cN=function(h){switch(h){case Oe:return 33071;case O0:return 33648;case Zs:return 10497}return 0};function zne(h){const t=h.getContext("2d").getImageData(0,0,h.width,h.height).data;for(let s=3;s<t.length;s+=4)if(t[s]<255)return!0;return!1}const uN=["diffuseMap","colorMap","normalMap","metalnessMap","emissiveMap"];class ud extends M6{collectResources(e){const t={buffers:[],cameras:[],entities:[],materials:[],skins:[],textures:[],entityMeshInstances:[],bufferViewMap:new Map,compressableTexture:new Set},{materials:s,buffers:i,entityMeshInstances:a,textures:n}=t;e.forEach(l=>{t.entities.push(l)});const r=l=>{l.forEach(u=>{const f=u.material;s.indexOf(f)<0&&(t.materials.push(f),uN.forEach(C=>{const M=f[C];M&&n.indexOf(M)<0&&(C!=="normalMap"&&t.compressableTexture.add(M),n.push(M))}));const _=u.node;let g=a.find(C=>C.node===_);g||(g={node:_,meshInstances:[]},a.push(g)),g.meshInstances.push(u);const y=u.mesh,v=y.vertexBuffer;i.indexOf(v)<0&&i.unshift(v);const x=y.indexBuffer[0];i.indexOf(x)<0&&i.push(x),y.skin&&t.skins.indexOf(y.skin)<0&&t.skins.push(y.skin)})};return t.entities.forEach(l=>{l.camera&&t.cameras.push(l.camera),l.render&&l.render.enabled&&r(l.render.meshInstances),l.model&&l.model.enabled&&l.model.meshInstances&&r(l.model.meshInstances)}),t}writeBufferViews(e,t){t.bufferViews=[];for(const s of e.buffers)ud.writeBufferView(e,t,s)}static writeBufferView(e,t,s){t.buffers=t.buffers??[],t.buffers[0]=t.buffers[0]??{byteLength:0};const i=t.buffers[0];i.byteLength=ge.roundUp(i.byteLength,4);const a=i.byteLength,n=(l,u,f,_)=>{const g={buffer:0,byteLength:u,byteOffset:f};return(l===oM||l===oN)&&(g.target=l),_!==void 0&&(g.byteStride=_),t.bufferViews.push(g)-1};let r;if(s instanceof jn){r=s.lock();const l=s.getFormat();if(l.interleaved){const u=n(oM,r.byteLength,a,l.size);e.bufferViewMap.set(s,[u])}else{const u=[];for(const f of l.elements){const _=n(oM,f.size*l.vertexCount,a+f.offset,f.size);u.push(_)}e.bufferViewMap.set(s,u)}}else if(s instanceof Ah){r=s.lock();const l=n(oN,r.byteLength,a);e.bufferViewMap.set(s,[l])}else{r=s;const l=n(void 0,r.byteLength,a);e.bufferViewMap.set(s,[l])}i.byteLength+=r.byteLength}writeCameras(e,t){e.cameras.length>0&&(t.cameras=e.cameras.map(s=>{const i=s.projection,a=s.nearClip,n=s.farClip,r={};if(i===nl)r.type="orthographic",r.orthographic={xmag:1,ymag:1,znear:a,zfar:n};else{const l=s.fov;r.type="perspective",r.perspective={yfov:l*Math.PI/180,znear:a,zfar:n}}return r}))}attachTexture(e,t,s,i,a,n){const r=t[a];if(r){const l=e.textures.indexOf(r);l<0&&console.warn(`Texture ${r.name} wasn't collected.`),s[i]={index:l};const u=t[`${a}Tiling`],f=t[`${a}Offset`],_=t[`${a}Rotation`];(u&&!u.equals(Ee.ONE)||f&&!f.equals(Ee.ZERO)||_!==0)&&(s[i].extensions={KHR_texture_transform:{}},n.extensionsUsed=n.extensionsUsed??[],n.extensionsUsed.indexOf("KHR_texture_transform")<0&&n.extensionsUsed.push("KHR_texture_transform"),n.extensionsRequired=n.extensionsRequired??[],n.extensionsRequired.indexOf("KHR_texture_transform")<0&&n.extensionsRequired.push("KHR_texture_transform"),u&&!u.equals(Ee.ONE)&&(s[i].extensions.KHR_texture_transform.scale=[u.x,u.y]),f&&!f.equals(Ee.ZERO)&&(s[i].extensions.KHR_texture_transform.offset=[f.x,f.y-1+u.y]),_!==0&&(s[i].extensions.KHR_texture_transform.rotation=_*ge.DEG_TO_RAD))}}writeStandardMaterial(e,t,s,i){const{diffuse:a,emissive:n,opacity:r,metalness:l,gloss:u,glossInvert:f}=t,_=s.pbrMetallicRoughness;(!a.equals(xe.WHITE)||r!==1)&&(_.baseColorFactor=[a.r,a.g,a.b,r]),l!==1&&(_.metallicFactor=l);const g=f?u:1-u;g!==1&&(_.roughnessFactor=g),this.attachTexture(e,t,_,"baseColorTexture","diffuseMap",i),this.attachTexture(e,t,_,"metallicRoughnessTexture","metalnessMap",i),n.equals(xe.BLACK)||(s.emissiveFactor=[n.r,n.g,n.b])}writeMaterials(e,t){e.materials.length>0&&(t.materials=e.materials.map(s=>{const{name:i,blendType:a,cull:n,alphaTest:r}=s,l={pbrMetallicRoughness:{}};return i&&i.length>0&&(l.name=i),s instanceof Vi&&this.writeStandardMaterial(e,s,l,t),a===xr?l.alphaMode="BLEND":a===Gn&&r!==0&&(l.alphaMode="MASK",l.alphaCutoff=r),n===Xs&&(l.doubleSided=!0),this.attachTexture(e,s,l,"normalTexture","normalMap",t),this.attachTexture(e,s,l,"occlusionTexture","aoMap",t),this.attachTexture(e,s,l,"emissiveTexture","emissiveMap",t),l}))}writeNodes(e,t){e.entities.length>0&&(t.nodes=e.entities.map(s=>{const i=s.name,a=s.getLocalPosition(),n=s.getLocalRotation(),r=s.getLocalScale(),l={};i&&i.length>0&&(l.name=i),a.equals(H.ZERO)||(l.translation=[a.x,a.y,a.z]),n.equals(Ne.IDENTITY)||(l.rotation=[n.x,n.y,n.z,n.w]),r.equals(H.ONE)||(l.scale=[r.x,r.y,r.z]),s.camera&&s.camera.enabled&&(l.camera=e.cameras.indexOf(s.camera));const u=e.entityMeshInstances.find(f=>f.node===s);if(u){l.mesh=e.entityMeshInstances.indexOf(u);const f=u.meshInstances[0];f&&f.mesh.skin&&(l.skin=e.skins.indexOf(f.mesh.skin))}return s.children.length>0&&(l.children=[],s.children.forEach(f=>{l.children.push(e.entities.indexOf(f))})),l}))}writeMeshes(e,t,s){e.entityMeshInstances.length>0&&(t.accessors=[],t.meshes=[],e.entityMeshInstances.forEach(i=>{const a={primitives:[]};i.meshInstances.forEach(r=>{const l=ud.createPrimitive(e,t,r.mesh,s);l.material=e.materials.indexOf(r.material),a.primitives.push(l)}),t.meshes.push(a)}))}static createPrimitive(e,t,s,i={}){const a={attributes:{}},{vertexBuffer:n}=s,{format:r}=n,{interleaved:l,elements:u}=r,f=n.getNumVertices();u.forEach((g,y)=>{const v=Une(g.name);if(i.stripUnusedAttributes){let T=!0;if(v.startsWith("TEXCOORD_")){const R=parseInt(v.split("_")[1],10);T=e.materials.some(D=>uN.some(I=>{var O;return D[I]&&(R===0||((O=D[`${I}Tiling`])==null?void 0:O.uv)===R)}))}if(v==="COLOR_0"&&(T=e.materials.some(R=>R.vertexColors)),v==="TANGENT"&&(T=e.materials.some(R=>R.normalMap)),(v==="JOINTS_0"||v==="WEIGHTS_0")&&(T=e.entityMeshInstances.some(R=>R.meshInstances.some(D=>D.mesh.skin))),!T)return}let x=e.bufferViewMap.get(n);x||(ud.writeBufferView(e,t,n),e.buffers.push(n),x=e.bufferViewMap.get(n));const M={bufferView:x[l?0:y],byteOffset:l?g.offset:0,componentType:lN(g.dataType),type:Bne(g.numComponents),count:f},w=t.accessors.push(M)-1;if(a.attributes[v]=w,g.name===kt){const T=[];s.getPositions(T);const R=new H,D=new H;wt.computeMinMax(T,R,D),M.min=[R.x,R.y,R.z],M.max=[D.x,D.y,D.z]}});const _=s.indexBuffer[0];if(_){let g=e.bufferViewMap.get(_);g||(ud.writeBufferView(e,t,_),e.buffers.push(_),g=e.bufferViewMap.get(_));const v={bufferView:g[0],componentType:Fne(_.getFormat()),count:_.getNumIndices(),type:"SCALAR"},x=t.accessors.push(v)-1;a.indices=x}return a}writeSkins(e,t){e.skins.length>0&&(t.skins=e.skins.map(s=>{const i=new Float32Array(s.inverseBindPose.length*16);for(let f=0;f<s.inverseBindPose.length;f++){const _=s.inverseBindPose[f];i.set(_.data,f*16)}const a=i.buffer;ud.writeBufferView(e,t,a),e.buffers.push(a);const r={bufferView:e.bufferViewMap.get(a)[0],componentType:lN(it),count:s.inverseBindPose.length,type:"MAT4"},l=t.accessors.push(r)-1,u=s.boneNames.map(f=>{const _=e.entities.find(g=>g.name===f);return e.entities.indexOf(_)});return{inverseBindMatrices:l,joints:u}}))}convertTextures(e,t){const s={maxTextureSize:t.maxTextureSize},i=[];return e.forEach(a=>{const n=this.textureToCanvas(a,s);n.then(r=>new Promise(l=>l(r))),i.push(n)}),i}writeTextures(e,t,s,i){const a=e.textures,n=[];for(let r=0;r<t.length;r++){const l=a[r],u=t[r],_=zne(u)||!e.compressableTexture.has(l)?"image/png":"image/jpeg";n.push(this.getBlob(u,_).then(g=>{const y=new FileReader;return y.readAsArrayBuffer(g),new Promise(v=>{y.onloadend=()=>{v(y)}})}).then(g=>{const y=this.getPaddedArrayBuffer(g.result);ud.writeBufferView(e,s,y),e.buffers.push(y);const v=e.bufferViewMap.get(y);s.images[r]={mimeType:_,bufferView:v[0]},s.samplers[r]={minFilter:hN(l.minFilter),magFilter:hN(l.magFilter),wrapS:cN(l.addressU),wrapT:cN(l.addressV)},s.textures[r]={sampler:r,source:r}}))}return Promise.all(n)}getBlob(e,t){if(e.toBlob!==void 0)return new Promise(i=>{e.toBlob(i,t)});let s=1;return t==="image/jpeg"&&(s=.92),e.convertToBlob({type:t,quality:s})}getPaddedArrayBuffer(e,t=0){const s=ge.roundUp(e.byteLength,4);if(s!==e.byteLength){const i=new Uint8Array(s);if(i.set(new Uint8Array(e)),t!==0)for(let a=e.byteLength;a<s;a++)i[a]=t;return i.buffer}return e}buildJson(e,t){const s=this.convertTextures(e.textures,t);return Promise.all(s).then(async i=>{const a={asset:{version:"2.0",generator:"PlayCanvas GltfExporter"},scenes:[{nodes:[0]}],images:[],samplers:[],textures:[],scene:0};return this.writeBufferViews(e,a),this.writeCameras(e,a),this.writeMeshes(e,a,t),this.writeMaterials(e,a),this.writeNodes(e,a,t),this.writeSkins(e,a),await this.writeTextures(e,i,a,t),a.images.length||delete a.images,a.samplers.length||delete a.samplers,a.textures.length||delete a.textures,a})}build(e,t={}){const s=this.collectResources(e);return this.buildJson(s,t).then(i=>{const n=new TextEncoder().encode(JSON.stringify(i)),r=12,l=8,u=n.length,f=4-(u&3)&3,_=8,g=i.buffers.reduce((M,w)=>ge.roundUp(M+w.byteLength,4),0);let y=r+l+u+f;g>0&&(y+=_+g);const v=new ArrayBuffer(y),x=new DataView(v);x.setUint32(0,1179937895,!0),x.setUint32(4,2,!0),x.setUint32(8,y,!0),x.setUint32(12,u+f,!0),x.setUint32(16,1313821514,!0);let C=r+l;new Uint8Array(v,C,u).set(n),C+=u;for(let M=0;M<f;M++)x.setUint8(C+M,32);return C+=f,g>0&&(x.setUint32(C,g,!0),x.setUint32(C+4,5130562,!0),C+=_,s.buffers.forEach(M=>{let w;const T=s.bufferViewMap.get(M)[0],R=i.bufferViews[T].byteOffset;if(M instanceof ArrayBuffer)w=new Uint8Array(M);else{const I=M.lock();I instanceof ArrayBuffer?w=new Uint8Array(I):w=new Uint8Array(I.buffer,I.byteOffset,I.byteLength)}new Uint8Array(v,C+R,w.byteLength).set(w)})),Promise.resolve(v)})}}const $p="none",U6="lighting",z6="combine";class ZC extends fl{constructor(e,t,s={}){super(e),this.sourceTexture=t,this.premultiplyTexture=s.premultiplyTexture;const i=s.boxFilter??!1,a=`${i?"Box":""}-${s.premultiplyTexture?"Premultiply":""}-${s.premultiplySrcChannel??""}}`;this.shader=this.createQuadShader(`DownSampleShader:${a}`,`
			${i?"#define BOXFILTER":""}
			${s.premultiplyTexture?"#define PREMULTIPLY":""}
			uniform sampler2D sourceTexture;
			uniform vec2 sourceInvResolution;
			varying vec2 uv0;
			#ifdef PREMULTIPLY
				uniform sampler2D premultiplyTexture;
			#endif
			void main()
			{
				vec3 e = texture2D (sourceTexture, vec2 (uv0.x, uv0.y)).rgb;
				#ifdef BOXFILTER
					vec3 value = e;
					#ifdef PREMULTIPLY
						float premultiply = texture2D(premultiplyTexture, vec2 (uv0.x, uv0.y)).${s.premultiplySrcChannel};
						value *= vec3(premultiply);
					#endif
				#else
					float x = sourceInvResolution.x;
					float y = sourceInvResolution.y;
					vec3 a = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y + 2.0 * y)).rgb;
					vec3 b = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y + 2.0 * y)).rgb;
					vec3 c = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y + 2.0 * y)).rgb;
					vec3 d = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y)).rgb;
					vec3 f = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y)).rgb;
					vec3 g = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y - 2.0 * y)).rgb;
					vec3 h = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y - 2.0 * y)).rgb;
					vec3 i = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y - 2.0 * y)).rgb;
					vec3 j = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;
					vec3 k = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;
					vec3 l = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;
					vec3 m = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;
					vec3 value = e * 0.125;
					value += (a + c + g + i) * 0.03125;
					value += (b + d + f + h) * 0.0625;
					value += (j + k + l + m) * 0.125;
				#endif
				gl_FragColor = vec4(value, 1.0);
			}`),this.sourceTextureId=e.scope.resolve("sourceTexture"),this.premultiplyTextureId=e.scope.resolve("premultiplyTexture"),this.sourceInvResolutionId=e.scope.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2)}setSourceTexture(e){this._sourceTexture=e,this.options.resizeSource=e}execute(){this.sourceTextureId.setValue(this.sourceTexture),this.premultiplyTexture&&this.premultiplyTextureId.setValue(this.premultiplyTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute()}}class k6 extends fl{constructor(e,t){super(e),this.sourceTexture=t,this.shader=this.createQuadShader("UpSampleShader",`
			uniform sampler2D sourceTexture;
			uniform vec2 sourceInvResolution;
			varying vec2 uv0;
			void main()
			{
				float x = sourceInvResolution.x;
				float y = sourceInvResolution.y;
				vec3 a = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;
				vec3 b = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y + y)).rgb;
				vec3 c = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;
				vec3 d = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y)).rgb;
				vec3 e = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y)).rgb;
				vec3 f = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y)).rgb;
				vec3 g = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;
				vec3 h = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y - y)).rgb;
				vec3 i = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;
				vec3 value = e * 4.0;
				value += (b + d + f + h) * 2.0;
				value += (a + c + g + i);
				value *= 1.0 / 16.0;
				gl_FragColor = vec4(value, 1.0);
			}`),this.sourceTextureId=e.scope.resolve("sourceTexture"),this.sourceInvResolutionId=e.scope.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2)}execute(){this.sourceTextureId.setValue(this.sourceTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute()}}class V6 extends pa{constructor(e,t,s){super(e),this.blurLevel=16,this.renderTargets=[],this._sourceTexture=t,this.textureFormat=s,this.bloomRenderTarget=this.createRenderTarget(0),this.bloomTexture=this.bloomRenderTarget.colorBuffer}destroy(){this.destroyRenderPasses(),this.destroyRenderTargets()}destroyRenderTargets(e=0){for(let t=e;t<this.renderTargets.length;t++){const s=this.renderTargets[t];s.destroyTextureBuffers(),s.destroy()}this.renderTargets.length=0}destroyRenderPasses(){for(let e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0}createRenderTarget(e){return new fs({depth:!1,colorBuffer:new Ge(this.device,{name:`BloomTexture${e}`,width:1,height:1,format:this.textureFormat,mipmaps:!1,minFilter:Vt,magFilter:Vt,addressU:Oe,addressV:Oe})})}createRenderTargets(e){for(let t=0;t<e;t++){const s=t===0?this.bloomRenderTarget:this.createRenderTarget(t);this.renderTargets.push(s)}}calcMipLevels(e,t,s){const i=Math.min(e,t);return Math.floor(Math.log2(i)-Math.log2(s))}createRenderPasses(e){const t=this.device;let s=this._sourceTexture;for(let i=0;i<e;i++){const a=new ZC(t,s),n=this.renderTargets[i];a.init(n,{resizeSource:s,scaleX:.5,scaleY:.5}),a.setClearColor(xe.BLACK),this.beforePasses.push(a),s=n.colorBuffer}s=this.renderTargets[e-1].colorBuffer;for(let i=e-2;i>=0;i--){const a=new k6(t,s),n=this.renderTargets[i];a.init(n),a.blendState=ms.ADDBLEND,this.beforePasses.push(a),s=n.colorBuffer}}onDisable(){var e;(e=this.renderTargets[0])==null||e.resize(1,1),this.destroyRenderPasses(),this.destroyRenderTargets(1)}frameUpdate(){super.frameUpdate();const e=this.calcMipLevels(this._sourceTexture.width,this._sourceTexture.height,1),t=ge.clamp(e,1,this.blurLevel);this.renderTargets.length!==t&&(this.destroyRenderPasses(),this.destroyRenderTargets(1),this.createRenderTargets(t),this.createRenderPasses(t))}}const kne=`
	#include "tonemappingPS"
	#include "gammaPS"
	varying vec2 uv0;
	uniform sampler2D sceneTexture;
	uniform vec2 sceneTextureInvRes;
	#ifdef BLOOM
		uniform sampler2D bloomTexture;
		uniform float bloomIntensity;
	#endif
	#ifdef DOF
		uniform sampler2D cocTexture;
		uniform sampler2D blurTexture;
		vec3 dofBlur(vec2 uv, out vec2 coc) {
			coc = texture2DLod(cocTexture, uv, 0.0).rg;
			#if DOF_UPSCALE
				vec2 blurTexelSize = 1.0 / vec2(textureSize(blurTexture, 0));
				vec3 bilinearBlur = vec3(0.0);
				float totalWeight = 0.0;
				for (int i = -1; i <= 1; i++) {
					for (int j = -1; j <= 1; j++) {
						vec2 offset = vec2(i, j) * blurTexelSize;
						vec2 cocSample = texture2DLod(cocTexture, uv + offset, 0.0).rg;
						vec3 blurSample = texture2DLod(blurTexture, uv + offset, 0.0).rgb;
						float cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);
						bilinearBlur += blurSample * cocWeight;
						totalWeight += cocWeight;
					}
				}
				if (totalWeight > 0.0) {
					bilinearBlur /= totalWeight;
				}
				return bilinearBlur;
			#else
				return texture2DLod(blurTexture, uv, 0.0).rgb;
			#endif
		}
	#endif
	#ifdef SSAO
		#define SSAO_TEXTURE
	#endif
	#if DEBUG_COMPOSE == ssao
		#define SSAO_TEXTURE
	#endif
	#ifdef SSAO_TEXTURE
		uniform sampler2D ssaoTexture;
	#endif
	#ifdef GRADING
		uniform vec3 brightnessContrastSaturation;
		uniform vec3 tint;
		vec3 colorGradingHDR(vec3 color, float brt, float sat, float con)
		{
			color *= tint;
			color = color * brt;
			float grey = dot(color, vec3(0.3, 0.59, 0.11));
			grey = grey / max(1.0, max(color.r, max(color.g, color.b)));
			color = mix(vec3(grey), color, sat);
			return mix(vec3(0.5), color, con);
		}
	
	#endif
	#ifdef VIGNETTE
		uniform vec4 vignetterParams;
		float vignette(vec2 uv) {
			float inner = vignetterParams.x;
			float outer = vignetterParams.y;
			float curvature = vignetterParams.z;
			float intensity = vignetterParams.w;
			vec2 curve = pow(abs(uv * 2.0 -1.0), vec2(1.0 / curvature));
			float edge = pow(length(curve), curvature);
			return 1.0 - intensity * smoothstep(inner, outer, edge);
		}		
	#endif
	#ifdef FRINGING
		uniform float fringingIntensity;
		vec3 fringing(vec2 uv, vec3 color) {
			vec2 centerDistance = uv - 0.5;
			vec2 offset = fringingIntensity * pow(centerDistance, vec2(2.0, 2.0));
			color.r = texture2D(sceneTexture, uv - offset).r;
			color.b = texture2D(sceneTexture, uv + offset).b;
			return color;
		}
	#endif
	#ifdef CAS
		uniform float sharpness;
		float maxComponent(float x, float y, float z) { return max(x, max(y, z)); }
		vec3 toSDR(vec3 c) { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }
		vec3 toHDR(vec3 c) { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }
		vec3 cas(vec3 color, vec2 uv, float sharpness) {
			float x = sceneTextureInvRes.x;
			float y = sceneTextureInvRes.y;
			vec3 a = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, -y), 0.0).rgb);
			vec3 b = toSDR(texture2DLod(sceneTexture, uv + vec2(-x, 0.0), 0.0).rgb);
			vec3 c = toSDR(color.rgb);
			vec3 d = toSDR(texture2DLod(sceneTexture, uv + vec2(x, 0.0), 0.0).rgb);
			vec3 e = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, y), 0.0).rgb);
			float min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));
			float max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));
			float sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);
			float w = sharpening_amount * sharpness;
			vec3 res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);
			res = max(res, 0.0);
			return toHDR(res);
		}
	#endif
	void main() {
		vec2 uv = uv0;
		#ifdef TAA
		#ifdef WEBGPU
			uv.y = 1.0 - uv.y;
		#endif
		#endif
		vec4 scene = texture2DLod(sceneTexture, uv, 0.0);
		vec3 result = scene.rgb;
		#ifdef CAS
			result = cas(result, uv, sharpness);
		#endif
		#ifdef DOF
			vec2 coc;
			vec3 blur = dofBlur(uv0, coc);
			result = mix(result, blur, coc.r + coc.g);
		#endif
		#ifdef SSAO_TEXTURE
			mediump float ssao = texture2DLod(ssaoTexture, uv0, 0.0).r;
		#endif
		#ifdef SSAO
			result *= ssao;
		#endif
		#ifdef FRINGING
			result = fringing(uv, result);
		#endif
		#ifdef BLOOM
			vec3 bloom = texture2DLod(bloomTexture, uv0, 0.0).rgb;
			result += bloom * bloomIntensity;
		#endif
		#ifdef GRADING
			result = colorGradingHDR(result, brightnessContrastSaturation.x, brightnessContrastSaturation.z, brightnessContrastSaturation.y);
		#endif
		result = toneMap(result);
		#ifdef VIGNETTE
			mediump float vig = vignette(uv);
			result *= vig;
		#endif
		#ifdef DEBUG_COMPOSE
			#ifdef BLOOM
				#if DEBUG_COMPOSE == bloom
					result = bloom * bloomIntensity;
				#endif
			#endif
			#ifdef DOF
				#ifdef DEBUG_COMPOSE == dofcoc
					result = vec3(coc, 0.0);
				#endif
				#ifdef DEBUG_COMPOSE == dofblur
					result = blur;
				#endif
			#endif
			#if DEBUG_COMPOSE == ssao
				result = vec3(ssao);
			#endif
			#if DEBUG_COMPOSE == vignette
				result = vec3(vig);
			#endif
			#if DEBUG_COMPOSE == scene
				result = scene.rgb;
			#endif
		#endif
		result = gammaCorrectOutput(result);
		gl_FragColor = vec4(result, scene.a);
	}
`;class G6 extends fl{constructor(e){super(e),this.sceneTexture=null,this.bloomIntensity=.01,this._bloomTexture=null,this._cocTexture=null,this.blurTexture=null,this.blurTextureUpscale=!1,this._ssaoTexture=null,this._toneMapping=sy,this._gradingEnabled=!1,this.gradingSaturation=1,this.gradingContrast=1,this.gradingBrightness=1,this.gradingTint=new xe(1,1,1,1),this._shaderDirty=!0,this._vignetteEnabled=!1,this.vignetteInner=.5,this.vignetteOuter=1,this.vignetteCurvature=.5,this.vignetteIntensity=.3,this._fringingEnabled=!1,this.fringingIntensity=10,this._taaEnabled=!1,this._sharpness=.5,this._gammaCorrection=Gc,this._key="",this._debug=null;const{scope:t}=e;this.sceneTextureId=t.resolve("sceneTexture"),this.bloomTextureId=t.resolve("bloomTexture"),this.cocTextureId=t.resolve("cocTexture"),this.ssaoTextureId=t.resolve("ssaoTexture"),this.blurTextureId=t.resolve("blurTexture"),this.bloomIntensityId=t.resolve("bloomIntensity"),this.bcsId=t.resolve("brightnessContrastSaturation"),this.tintId=t.resolve("tint"),this.vignetterParamsId=t.resolve("vignetterParams"),this.fringingIntensityId=t.resolve("fringingIntensity"),this.sceneTextureInvResId=t.resolve("sceneTextureInvRes"),this.sceneTextureInvResValue=new Float32Array(2),this.sharpnessId=t.resolve("sharpness")}set debug(e){this._debug!==e&&(this._debug=e,this._shaderDirty=!0)}get debug(){return this._debug}set bloomTexture(e){this._bloomTexture!==e&&(this._bloomTexture=e,this._shaderDirty=!0)}get bloomTexture(){return this._bloomTexture}set cocTexture(e){this._cocTexture!==e&&(this._cocTexture=e,this._shaderDirty=!0)}get cocTexture(){return this._cocTexture}set ssaoTexture(e){this._ssaoTexture!==e&&(this._ssaoTexture=e,this._shaderDirty=!0)}get ssaoTexture(){return this._ssaoTexture}set taaEnabled(e){this._taaEnabled!==e&&(this._taaEnabled=e,this._shaderDirty=!0)}get taaEnabled(){return this._taaEnabled}set gradingEnabled(e){this._gradingEnabled!==e&&(this._gradingEnabled=e,this._shaderDirty=!0)}get gradingEnabled(){return this._gradingEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._shaderDirty=!0)}get vignetteEnabled(){return this._vignetteEnabled}set fringingEnabled(e){this._fringingEnabled!==e&&(this._fringingEnabled=e,this._shaderDirty=!0)}get fringingEnabled(){return this._fringingEnabled}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this._shaderDirty=!0)}get toneMapping(){return this._toneMapping}set sharpness(e){this._sharpness!==e&&(this._sharpness=e,this._shaderDirty=!0)}get sharpness(){return this._sharpness}get isSharpnessEnabled(){return this._sharpness>0}postInit(){this.setClearColor(xe.BLACK),this.setClearDepth(1),this.setClearStencil(0)}frameUpdate(){const s=(this.renderTarget??this.device.backBuffer).isColorBufferSrgb(0)?Ch:Gc;if(this._gammaCorrection!==s&&(this._gammaCorrection=s,this._shaderDirty=!0),this._shaderDirty){this._shaderDirty=!1;const i=gP[this._gammaCorrection],a=`${this.toneMapping}-${i}-${this.bloomTexture?"bloom":"nobloom"}-${this.cocTexture?"dof":"nodof"}-${this.blurTextureUpscale?"dofupscale":""}-${this.ssaoTexture?"ssao":"nossao"}-${this.gradingEnabled?"grading":"nograding"}-${this.vignetteEnabled?"vignette":"novignette"}-${this.fringingEnabled?"fringing":"nofringing"}-${this.taaEnabled?"taa":"notaa"}-${this.isSharpnessEnabled?"cas":"nocas"}-${this._debug??""}`;if(this._key!==a){this._key=a;const n=new Map;n.set("TONEMAP",PC[this.toneMapping]),n.set("GAMMA",i),this.bloomTexture&&n.set("BLOOM",!0),this.cocTexture&&n.set("DOF",!0),this.blurTextureUpscale&&n.set("DOF_UPSCALE",!0),this.ssaoTexture&&n.set("SSAO",!0),this.gradingEnabled&&n.set("GRADING",!0),this.vignetteEnabled&&n.set("VIGNETTE",!0),this.fringingEnabled&&n.set("FRINGING",!0),this.taaEnabled&&n.set("TAA",!0),this.isSharpnessEnabled&&n.set("CAS",!0),this._debug&&n.set("DEBUG_COMPOSE",this._debug);const r=new Map(Object.entries(dt));this.shader=this.createQuadShader(`ComposeShader-${a}`,kne,{fragmentIncludes:r,fragmentDefines:n})}}}execute(){this.sceneTextureId.setValue(this.sceneTexture),this.sceneTextureInvResValue[0]=1/this.sceneTexture.width,this.sceneTextureInvResValue[1]=1/this.sceneTexture.height,this.sceneTextureInvResId.setValue(this.sceneTextureInvResValue),this._bloomTexture&&(this.bloomTextureId.setValue(this._bloomTexture),this.bloomIntensityId.setValue(this.bloomIntensity)),this._cocTexture&&(this.cocTextureId.setValue(this._cocTexture),this.blurTextureId.setValue(this.blurTexture)),this._ssaoTexture&&this.ssaoTextureId.setValue(this._ssaoTexture),this._gradingEnabled&&(this.bcsId.setValue([this.gradingBrightness,this.gradingContrast,this.gradingSaturation]),this.tintId.setValue([this.gradingTint.r,this.gradingTint.g,this.gradingTint.b])),this._vignetteEnabled&&this.vignetterParamsId.setValue([this.vignetteInner,this.vignetteOuter,this.vignetteCurvature,this.vignetteIntensity]),this._fringingEnabled&&this.fringingIntensityId.setValue(this.fringingIntensity/1024),this.isSharpnessEnabled&&this.sharpnessId.setValue(ge.lerp(-.125,-.2,this.sharpness)),super.execute()}}const Vne=`
	uniform sampler2D sourceTexture;
	uniform sampler2D historyTexture;
	uniform mat4 matrix_viewProjectionPrevious;
	uniform mat4 matrix_viewProjectionInverse;
	uniform vec4 jitters;
	uniform vec2 textureSize;
	varying vec2 uv0;
	vec2 reproject(vec2 uv, float depth) {
		#ifndef WEBGPU
			depth = depth * 2.0 - 1.0;
		#endif
		vec4 ndc = vec4(uv * 2.0 - 1.0, depth, 1.0);
		ndc.xy -= jitters.xy;
		vec4 worldPosition = matrix_viewProjectionInverse * ndc;
		worldPosition /= worldPosition.w;
	
		vec4 screenPrevious = matrix_viewProjectionPrevious * worldPosition;
		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;
	}
	vec4 colorClamp(vec2 uv, vec4 historyColor) {
		vec3 minColor = vec3(9999.0);
		vec3 maxColor = vec3(-9999.0);
 
		for(float x = -1.0; x <= 1.0; ++x)
		{
			for(float y = -1.0; y <= 1.0; ++y)
			{
				vec3 color = texture2D(sourceTexture, uv + vec2(x, y) / textureSize).rgb;
				minColor = min(minColor, color);
				maxColor = max(maxColor, color);
			}
		}
 
		vec3 clamped = clamp(historyColor.rgb, minColor, maxColor);
		return vec4(clamped, historyColor.a);
	}
	void main()
	{
		vec2 uv = uv0;
		#ifdef WEBGPU
			uv.y = 1.0 - uv.y;
		#endif
		vec4 srcColor = texture2D(sourceTexture, uv);
		float linearDepth = getLinearScreenDepth(uv0);
		float depth = delinearizeDepth(linearDepth);
		vec2 historyUv = reproject(uv0, depth);
		#ifdef QUALITY_HIGH
			vec4 historyColor = SampleTextureCatmullRom(TEXTURE_PASS(historyTexture), historyUv, textureSize);
		#else
			vec4 historyColor = texture2D(historyTexture, historyUv);
		#endif
		vec4 historyColorClamped = colorClamp(uv, historyColor);
		float mixFactor = (historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0) ?
			1.0 : 0.05;
		gl_FragColor = mix(historyColorClamped, srcColor, mixFactor);
	}
`;class H6 extends fl{constructor(e,t,s){super(e),this.historyIndex=0,this.historyTexture=null,this.historyTextures=[],this.historyRenderTargets=[],this.sourceTexture=t,this.cameraComponent=s;const i=`
			#define QUALITY_HIGH
		`,a=mr.getScreenDepthChunk(e,s.shaderParams),n=dt.sampleCatmullRomPS+a;this.shader=this.createQuadShader("TaaResolveShader",i+n+Vne);const{scope:r}=e;this.sourceTextureId=r.resolve("sourceTexture"),this.textureSizeId=r.resolve("textureSize"),this.textureSize=new Float32Array(2),this.historyTextureId=r.resolve("historyTexture"),this.viewProjPrevId=r.resolve("matrix_viewProjectionPrevious"),this.viewProjInvId=r.resolve("matrix_viewProjectionInverse"),this.jittersId=r.resolve("jitters"),this.cameraParams=new Float32Array(4),this.cameraParamsId=r.resolve("camera_params"),this.setup()}destroy(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}setup(){for(let e=0;e<2;++e)this.historyTextures[e]=new Ge(this.device,{name:`TAA-History-${e}`,width:4,height:4,format:this.sourceTexture.format,mipmaps:!1,minFilter:Vt,magFilter:Vt,addressU:Oe,addressV:Oe}),this.historyRenderTargets[e]=new fs({colorBuffer:this.historyTextures[e],depth:!1});this.historyTexture=this.historyTextures[0],this.init(this.historyRenderTargets[0],{resizeSource:this.sourceTexture})}before(){this.sourceTextureId.setValue(this.sourceTexture),this.historyTextureId.setValue(this.historyTextures[1-this.historyIndex]),this.textureSize[0]=this.sourceTexture.width,this.textureSize[1]=this.sourceTexture.height,this.textureSizeId.setValue(this.textureSize);const e=this.cameraComponent.camera;this.viewProjPrevId.setValue(e._viewProjPrevious.data),this.viewProjInvId.setValue(e._viewProjInverse.data),this.jittersId.setValue(e._jitters);const t=e._farClip;this.cameraParams[0]=1/t,this.cameraParams[1]=t,this.cameraParams[2]=e._nearClip,this.cameraParams[3]=e.projection===nl?1:0,this.cameraParamsId.setValue(this.cameraParams)}update(){return this.historyIndex=1-this.historyIndex,this.historyTexture=this.historyTextures[this.historyIndex],this.renderTarget=this.historyRenderTargets[this.historyIndex],this.historyTexture}}class Gne extends fl{constructor(e,t,s){super(e),this.cameraComponent=t;const i=mr.getScreenDepthChunk(e,t.shaderParams);this.shader=this.createQuadShader(`CocShader-${s}`,`
			${s?"#define NEAR_BLUR":""}
			${i}
			varying vec2 uv0;
			uniform vec3 params;
			void main()
			{
				float depth = getLinearScreenDepth(uv0);
				float focusDistance = params.x;
				float focusRange = params.y;
				float invRange = params.z;
				float farRange = focusDistance + focusRange * 0.5;
				
				float cocFar = min((depth - farRange) * invRange, 1.0);
				#ifdef NEAR_BLUR
					float nearRange = focusDistance - focusRange * 0.5;
					float cocNear = min((nearRange - depth) * invRange, 1.0);
				#else
					float cocNear = 0.0;
				#endif
				gl_FragColor = vec4(cocFar, cocNear, 0.0, 0.0);
			}`),this.paramsId=e.scope.resolve("params"),this.paramsValue=new Float32Array(3),this.cameraParams=new Float32Array(4),this.cameraParamsId=e.scope.resolve("camera_params")}execute(){const{paramsValue:e,focusRange:t}=this;e[0]=this.focusDistance+.001,e[1]=t,e[2]=1/t,this.paramsId.setValue(e);const s=this.cameraComponent.camera,i=s._farClip;this.cameraParams[0]=1/i,this.cameraParams[1]=i,this.cameraParams[2]=s._nearClip,this.cameraParams[3]=s.projection===nl?1:0,this.cameraParamsId.setValue(this.cameraParams),super.execute()}}class Hne extends fl{constructor(e,t,s,i){super(e),this.blurRadiusNear=1,this.blurRadiusFar=1,this._blurRings=3,this._blurRingPoints=3,this.nearTexture=t,this.farTexture=s,this.cocTexture=i;const{scope:a}=e;this.kernelId=a.resolve("kernel[0]"),this.kernelCountId=a.resolve("kernelCount"),this.blurRadiusNearId=a.resolve("blurRadiusNear"),this.blurRadiusFarId=a.resolve("blurRadiusFar"),this.nearTextureId=a.resolve("nearTexture"),this.farTextureId=a.resolve("farTexture"),this.cocTextureId=a.resolve("cocTexture")}set blurRings(e){this._blurRings!==e&&(this._blurRings=e,this.shader=null)}get blurRings(){return this._blurRings}set blurRingPoints(e){this._blurRingPoints!==e&&(this._blurRingPoints=e,this.shader=null)}get blurRingPoints(){return this._blurRingPoints}createShader(){this.kernel=new Float32Array(dF.concentric(this.blurRings,this.blurRingPoints));const e=this.kernel.length>>1,t=this.nearTexture!==null,s=`DofBlurShader-${e}-${t?"nearBlur":"noNearBlur"}`;this.shader=this.createQuadShader(s,`
			${t?"#define NEAR_BLUR":""}
			#if defined(NEAR_BLUR)
				uniform sampler2D nearTexture;
			#endif
			uniform sampler2D farTexture;
			uniform sampler2D cocTexture;
			uniform float blurRadiusNear;
			uniform float blurRadiusFar;
			uniform vec2 kernel[${e}];
			varying vec2 uv0;
			void main()
			{
				vec2 coc = texture2D(cocTexture, uv0).rg;
				float cocFar = coc.r;
				vec3 sum = vec3(0.0, 0.0, 0.0);
				#if defined(NEAR_BLUR)
					float cocNear = coc.g;
					if (cocNear > 0.0001) {
						ivec2 nearTextureSize = textureSize(nearTexture, 0);
						vec2 step = cocNear * blurRadiusNear / vec2(nearTextureSize);
						for (int i = 0; i < ${e}; i++) {
							vec2 uv = uv0 + step * kernel[i];
							vec3 tap = texture2DLod(nearTexture, uv, 0.0).rgb;
							sum += tap.rgb;
						}
						sum *= ${1/e};
					} else
				#endif
					
					if (cocFar > 0.0001) {
					ivec2 farTextureSize = textureSize(farTexture, 0);
					vec2 step = cocFar * blurRadiusFar / vec2(farTextureSize);
					float sumCoC = 0.0; 
					for (int i = 0; i < ${e}; i++) {
						vec2 uv = uv0 + step * kernel[i];
						vec3 tap = texture2DLod(farTexture, uv, 0.0).rgb;
						float cocThis = texture2DLod(cocTexture, uv, 0.0).r;
						tap *= cocThis;
						sumCoC += cocThis;
						sum += tap.rgb;
					}
					if (sumCoC > 0.0)
						sum /= sumCoC;
					sum /= cocFar;
				}
				pcFragColor0 = vec4(sum, 1.0);
			}`)}execute(){this.shader||this.createShader(),this.nearTextureId.setValue(this.nearTexture),this.farTextureId.setValue(this.farTexture),this.cocTextureId.setValue(this.cocTexture),this.kernelId.setValue(this.kernel),this.kernelCountId.setValue(this.kernel.length>>1),this.blurRadiusNearId.setValue(this.blurRadiusNear),this.blurRadiusFarId.setValue(this.blurRadiusFar),super.execute()}}class W6 extends pa{constructor(e,t,s,i,a,n){super(e),this.focusDistance=100,this.focusRange=50,this.blurRadius=1,this.blurRings=3,this.blurRingPoints=3,this.highQuality=!0,this.cocTexture=null,this.blurTexture=null,this.cocPass=null,this.farPass=null,this.blurPass=null,this.highQuality=a,this.cocPass=this.setupCocPass(e,t,s,n),this.beforePasses.push(this.cocPass);const r=a?s:i;this.farPass=this.setupFarPass(e,r,.5),this.beforePasses.push(this.farPass),this.blurPass=this.setupBlurPass(e,i,n,a?2:.5),this.beforePasses.push(this.blurPass)}destroy(){this.destroyRenderPasses(),this.cocPass=null,this.farPass=null,this.blurPass=null,this.destroyRT(this.cocRT),this.destroyRT(this.farRt),this.destroyRT(this.blurRt),this.cocRT=null,this.farRt=null,this.blurRt=null}destroyRenderPasses(){for(let e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0}destroyRT(e){e&&(e.destroyTextureBuffers(),e.destroy())}setupCocPass(e,t,s,i){const a=i?j0:wm;this.cocRT=this.createRenderTarget("CoCTexture",a),this.cocTexture=this.cocRT.colorBuffer;const n=new Gne(e,t,i);return n.init(this.cocRT,{resizeSource:s}),n.setClearColor(xe.BLACK),n}setupFarPass(e,t,s){this.farRt=this.createRenderTarget("FarDofTexture",t.format);const i=new ZC(e,t,{boxFilter:!0,premultiplyTexture:this.cocTexture,premultiplySrcChannel:"r"});return i.init(this.farRt,{resizeSource:t,scaleX:s,scaleY:s}),i.setClearColor(xe.BLACK),i}setupBlurPass(e,t,s,i){var r;const a=(r=this.farRt)==null?void 0:r.colorBuffer;this.blurRt=this.createRenderTarget("DofBlurTexture",t.format),this.blurTexture=this.blurRt.colorBuffer;const n=new Hne(e,s?t:null,a,this.cocTexture);return n.init(this.blurRt,{resizeSource:t,scaleX:i,scaleY:i}),n.setClearColor(xe.BLACK),n}createTexture(e,t){return new Ge(this.device,{name:e,width:1,height:1,format:t,mipmaps:!1,minFilter:Vt,magFilter:Vt,addressU:Oe,addressV:Oe})}createRenderTarget(e,t){return new fs({colorBuffer:this.createTexture(e,t),depth:!1,stencil:!1})}frameUpdate(){super.frameUpdate(),this.cocPass.focusDistance=this.focusDistance,this.cocPass.focusRange=this.focusRange,this.blurPass.blurRadiusNear=this.blurRadius,this.blurPass.blurRadiusFar=this.blurRadius*(this.highQuality?1:.5),this.blurPass.blurRings=this.blurRings,this.blurPass.blurRingPoints=this.blurRingPoints}}const lM=[],Wne="uSceneDepthMap";class q6 extends pa{constructor(e,t,s,i,a){super(e),this.viewBindGroups=[],this.linearDepthClearValue=new xe(0,0,0,0),this.scene=t,this.renderer=s,this.camera=i,this.setupRenderTarget(a)}destroy(){var e,t;super.destroy(),(e=this.renderTarget)==null||e.destroy(),this.renderTarget=null,(t=this.linearDepthTexture)==null||t.destroy(),this.linearDepthTexture=null,this.viewBindGroups.forEach(s=>{s.defaultUniformBuffer.destroy(),s.destroy()}),this.viewBindGroups.length=0}setupRenderTarget(e){const{device:t}=this;this.linearDepthFormat=t.textureFloatRenderable?gr:Lt,this.linearDepthTexture=new Ge(t,{name:"SceneLinearDepthTexture",width:1,height:1,format:this.linearDepthFormat,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe});const s=new fs({name:"PrepassRT",colorBuffer:this.linearDepthTexture,depth:!0,samples:1});this.camera.shaderParams.sceneDepthMapLinear=!0,this.init(s,e)}after(){this.device.scope.resolve(Wne).setValue(this.linearDepthTexture)}execute(){var l;const{renderer:e,scene:t,renderTarget:s}=this,i=this.camera.camera,a=t.layers.layerList,n=t.layers.subLayerEnabled,r=t.layers.subLayerList;for(let u=0;u<a.length;u++){const f=a[u];if(f.id===yn)break;if(f.enabled&&n[u]&&f.camerasSet.has(i)){const _=f.getCulledInstances(i),g=r[u]?_.transparent:_.opaque;for(let y=0;y<g.length;y++){const v=g[y];(l=v.material)!=null&&l.depthWrite&&lM.push(v)}e.renderForwardLayer(i,s,null,void 0,ny,this.viewBindGroups,{meshInstances:lM}),lM.length=0}}}frameUpdate(){super.frameUpdate();const{camera:e}=this;this.setClearDepth(e.clearDepthBuffer?1:void 0);let t;if(e.clearDepthBuffer){const s=e.farClip-Number.MIN_VALUE;t=this.linearDepthClearValue,this.linearDepthFormat===gr?t.r=s:Xc.float2RGBA8(s,t)}this.setClearColor(t)}}class oD extends fl{constructor(e,t,s,i){super(e),this.sourceTexture=t;const a=mr.getScreenDepthChunk(e,s.shaderParams);this.shader=this.createQuadShader(`DepthAware${i?"Horizontal":"Vertical"}BlurShader`,`${a}
			${i?"#define HORIZONTAL":""}
			varying vec2 uv0;
			uniform sampler2D sourceTexture;
			uniform vec2 sourceInvResolution;
			uniform int filterSize;
			float random(const highp vec2 w) {
				const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
				return fract(m.z * fract(dot(w, m.xy)));
			}
			mediump float bilateralWeight(in mediump float depth, in mediump float sampleDepth) {
				mediump float diff = (sampleDepth - depth);
				return max(0.0, 1.0 - diff * diff);
			}
			void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {
				mediump float color = texture2D(sourceTexture, position).r;
				mediump float textureDepth = -getLinearScreenDepth(position);
			
				mediump float bilateral = bilateralWeight(depth, textureDepth);
				bilateral *= weight;
				sum += color * bilateral;
				totalWeight += bilateral;
			}
			void main() {
				mediump float depth = -getLinearScreenDepth(uv0);
				mediump float totalWeight = 1.0;
				mediump float color = texture2D(sourceTexture, uv0 ).r;
				mediump float sum = color * totalWeight;
				for (mediump int i = -filterSize; i <= filterSize; i++) {
					mediump float weight = 1.0;
					#ifdef HORIZONTAL
						vec2 offset = vec2(i, 0) * sourceInvResolution;
					#else
						vec2 offset = vec2(0, i) * sourceInvResolution;
					#endif
					tap(sum, totalWeight, weight, depth, uv0 + offset);
				}
				mediump float ao = sum / totalWeight;
				gl_FragColor.r = ao;
			}
		`);const n=this.device.scope;this.sourceTextureId=n.resolve("sourceTexture"),this.sourceInvResolutionId=n.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2),this.filterSizeId=n.resolve("filterSize")}execute(){this.filterSizeId.setValue(4),this.sourceTextureId.setValue(this.sourceTexture);const{width:e,height:t}=this.sourceTexture;this.sourceInvResolutionValue[0]=1/e,this.sourceInvResolutionValue[1]=1/t,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute()}}const qne=`
	varying vec2 uv0;
	uniform vec2 uInvResolution;
	uniform float uAspect;
	#define saturate(x) clamp(x,0.0,1.0)
	highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {
		return -v.z;
	}
	highp float getViewSpaceZFromW(const mat4 p, const float w) {
		return -w;
	}
	const float kLog2LodRate = 3.0;
	float random(const highp vec2 w) {
		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	highp vec2 getFragCoord() {
		return gl_FragCoord.xy;
	}
	highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {
		return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);
	}
	highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {
		return normalize(cross(dpdx, dpdy));
	}
	highp vec3 computeViewSpaceNormal(const highp vec3 position) {
		return faceNormal(dFdx(position), dFdy(position));
	}
	highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {
		highp vec2 uvdx = uv + vec2(uInvResolution.x, 0.0);
		highp vec2 uvdy = uv + vec2(0.0, uInvResolution.y);
		highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));
		highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));
		highp vec3 dpdx = px - position;
		highp vec3 dpdy = py - position;
		return faceNormal(dpdx, dpdy);
	}
	uniform vec2 uSampleCount;
	uniform float uSpiralTurns;
	#define PI (3.14159)
	mediump vec3 tapLocation(mediump float i, const mediump float noise) {
		mediump float offset = ((2.0 * PI) * 2.4) * noise;
		mediump float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;
		mediump float radius = (i + noise + 0.5) * uSampleCount.y;
		return vec3(cos(angle), sin(angle), radius * radius);
	}
	highp vec2 startPosition(const float noise) {
		float angle = ((2.0 * PI) * 2.4) * noise;
		return vec2(cos(angle), sin(angle));
	}
	uniform vec2 uAngleIncCosSin;
	highp mat2 tapAngleStep() {
		highp vec2 t = uAngleIncCosSin;
		return mat2(t.x, t.y, -t.y, t.x);
	}
	mediump vec3 tapLocationFast(mediump float i, mediump vec2 p, const mediump float noise) {
		mediump float radius = (i + noise + 0.5) * uSampleCount.y;
		return vec3(p, radius * radius);
	}
	uniform float uMaxLevel;
	uniform float uInvRadiusSquared;
	uniform float uMinHorizonAngleSineSquared;
	uniform float uBias;
	uniform float uPeak2;
	void computeAmbientOcclusionSAO(inout mediump float occlusion, mediump float i, mediump float ssDiskRadius,
			const highp vec2 uv, const highp vec3 origin, const mediump vec3 normal,
			const mediump vec2 tapPosition, const float noise) {
		mediump vec3 tap = tapLocationFast(i, tapPosition, noise);
		mediump float ssRadius = max(1.0, tap.z * ssDiskRadius);
		mediump vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uInvResolution;
		mediump float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));
		highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);
		highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);
		vec3 v = p - origin;
		float vv = dot(v, v);
		float vn = dot(v, normal);
		mediump float w = max(0.0, 1.0 - vv * uInvRadiusSquared);
		w = w * w;
		w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);
		occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);
	}
	uniform float uProjectionScaleRadius;
	uniform float uIntensity;
	uniform float uRandomize;
	float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {
		float noise = random(getFragCoord()) + uRandomize;
		highp vec2 tapPosition = startPosition(noise);
		highp mat2 angleStep = tapAngleStep();
		float ssDiskRadius = -(uProjectionScaleRadius / origin.z);
		float occlusion = 0.0;
		for (float i = 0.0; i < uSampleCount.x; i += 1.0) {
			computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);
			tapPosition = angleStep * tapPosition;
		}
		return occlusion;
	}
	uniform float uPower;
	void main() {
		highp vec2 uv = uv0;
		highp float depth = -getLinearScreenDepth(uv0);
		highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);
		vec3 normal = computeViewSpaceNormal(origin, uv);
		float occlusion = 0.0;
		if (uIntensity > 0.0) {
			occlusion = scalableAmbientObscurance(uv, origin, normal);
		}
		float ao = max(0.0, 1.0 - occlusion * uIntensity);
		ao = pow(ao, uPower);
		gl_FragColor = vec4(ao, ao, ao, 1.0);
	}
`;class X6 extends fl{constructor(e,t,s,i){super(e),this.radius=5,this.intensity=1,this.power=1,this.sampleCount=10,this.minAngle=5,this.randomize=!1,this._scale=1,this._blueNoise=new UU(19),this.sourceTexture=t,this.cameraComponent=s;const a=mr.getScreenDepthChunk(e,s.shaderParams);this.shader=this.createQuadShader("SsaoShader",a+qne);const n=this.createRenderTarget("SsaoFinalTexture");this.ssaoTexture=n.colorBuffer,this.init(n,{resizeSource:this.sourceTexture});const r=new xe(0,0,0,0);if(this.setClearColor(r),i){const l=this.createRenderTarget("SsaoTempTexture"),u=new oD(e,n.colorBuffer,s,!0);u.init(l,{resizeSource:n.colorBuffer}),u.setClearColor(r);const f=new oD(e,l.colorBuffer,s,!1);f.init(n,{resizeSource:n.colorBuffer}),f.setClearColor(r),this.afterPasses.push(u),this.afterPasses.push(f)}this.ssaoTextureId=e.scope.resolve("ssaoTexture"),this.ssaoTextureSizeInvId=e.scope.resolve("ssaoTextureSizeInv")}destroy(){var e,t;if((e=this.renderTarget)==null||e.destroyTextureBuffers(),(t=this.renderTarget)==null||t.destroy(),this.renderTarget=null,this.afterPasses.length>0){const s=this.afterPasses[0].renderTarget;s==null||s.destroyTextureBuffers(),s==null||s.destroy()}this.afterPasses.forEach(s=>s.destroy()),this.afterPasses.length=0,super.destroy()}set scale(e){this._scale=e,this.scaleX=e,this.scaleY=e}get scale(){return this._scale}createRenderTarget(e){return new fs({depth:!1,colorBuffer:new Ge(this.device,{name:e,width:1,height:1,format:wm,mipmaps:!1,minFilter:Je,magFilter:Je,addressU:Oe,addressV:Oe})})}execute(){const{device:e,sourceTexture:t,sampleCount:s,minAngle:i,scale:a}=this,{width:n,height:r}=this.renderTarget.colorBuffer,l=e.scope;l.resolve("uAspect").setValue(n/r),l.resolve("uInvResolution").setValue([1/n,1/r]),l.resolve("uSampleCount").setValue([s,1/s]);const u=Math.sin(i*Math.PI/180);l.resolve("uMinHorizonAngleSineSquared").setValue(u*u);const f=10,_=1/(s-.5)*f*2*3.141,g=this.radius/a,y=.001,v=.1*g,x=2*(v*2*3.141)*this.intensity/s,C=.5*t.height;l.resolve("uSpiralTurns").setValue(f),l.resolve("uAngleIncCosSin").setValue([Math.cos(_),Math.sin(_)]),l.resolve("uMaxLevel").setValue(0),l.resolve("uInvRadiusSquared").setValue(1/(g*g)),l.resolve("uBias").setValue(y),l.resolve("uPeak2").setValue(v*v),l.resolve("uIntensity").setValue(x),l.resolve("uPower").setValue(this.power),l.resolve("uProjectionScaleRadius").setValue(C*g),l.resolve("uRandomize").setValue(this.randomize?this._blueNoise.value():0),super.execute()}after(){this.ssaoTextureId.setValue(this.ssaoTexture);const e=this.sourceTexture;this.ssaoTextureSizeInvId.setValue([1/e.width,1/e.height])}}class xL{constructor(){this.stencil=!1,this.samples=1,this.sceneColorMap=!1,this.lastGrabLayerId=dm,this.lastGrabLayerIsTransparent=!1,this.lastSceneLayerId=hx,this.lastSceneLayerIsTransparent=!0,this.taaEnabled=!1,this.bloomEnabled=!1,this.ssaoType=$p,this.ssaoBlurEnabled=!0,this.prepassEnabled=!1,this.dofEnabled=!1,this.dofNearBlur=!1,this.dofHighQuality=!0}}const Xne=new xL;class j6 extends pa{constructor(e,t,s={}){super(e.graphicsDevice),this._renderTargetScale=1,this.rt=null,this.app=e,this.cameraComponent=t,this.options=this.sanitizeOptions(s),this.setupRenderPasses(this.options)}destroy(){this.reset()}reset(){this.sceneTexture=null,this.sceneTextureHalf=null,this.rt&&(this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null),this.rtHalf&&(this.rtHalf.destroyTextureBuffers(),this.rtHalf.destroy(),this.rtHalf=null),this.beforePasses.forEach(e=>e.destroy()),this.beforePasses.length=0,this.prePass=null,this.scenePass=null,this.scenePassTransparent=null,this.colorGrabPass=null,this.composePass=null,this.bloomPass=null,this.ssaoPass=null,this.taaPass=null,this.afterPass=null,this.scenePassHalf=null,this.dofPass=null}sanitizeOptions(e){return e=Object.assign({},Xne,e),(e.taaEnabled||e.ssaoType!==$p||e.dofEnabled)&&(e.prepassEnabled=!0),e}set renderTargetScale(e){this._renderTargetScale=e,this.scenePass&&(this.scenePass.scaleX=e,this.scenePass.scaleY=e)}get renderTargetScale(){return this._renderTargetScale}needsReset(e){const t=this.options,s=(i,a)=>i!==a&&(!(Array.isArray(i)&&Array.isArray(a))||i.length!==a.length||!i.every((n,r)=>n===a[r]));return e.ssaoType!==t.ssaoType||e.ssaoBlurEnabled!==t.ssaoBlurEnabled||e.taaEnabled!==t.taaEnabled||e.samples!==t.samples||e.stencil!==t.stencil||e.bloomEnabled!==t.bloomEnabled||e.prepassEnabled!==t.prepassEnabled||e.sceneColorMap!==t.sceneColorMap||e.dofEnabled!==t.dofEnabled||e.dofNearBlur!==t.dofNearBlur||e.dofHighQuality!==t.dofHighQuality||s(e.formats,t.formats)}update(e){e=this.sanitizeOptions(e),this.needsReset(e)&&this.reset(),this.options=e,this.sceneTexture||this.setupRenderPasses(this.options)}createRenderTarget(e,t,s,i,a){const n=new Ge(this.device,{name:e,width:4,height:4,format:this.hdrFormat,mipmaps:!1,minFilter:Vt,magFilter:Vt,addressU:Oe,addressV:Oe});return new fs({colorBuffer:n,depth:t,stencil:s,samples:i,flipY:a})}setupRenderPasses(e){const{device:t}=this,s=this.cameraComponent,i=s.renderTarget;this.hdrFormat=t.getRenderableHdrFormat(e.formats,!0,e.samples)||Lt,this._bloomEnabled=e.bloomEnabled&&this.hdrFormat!==Lt,this._sceneHalfEnabled=this._bloomEnabled||e.dofEnabled,s.shaderParams.ssaoEnabled=e.ssaoType===U6;const a=!!(i!=null&&i.flipY);this.rt=this.createRenderTarget("SceneColor",!0,e.stencil,e.samples,a),this.sceneTexture=this.rt.colorBuffer,this._sceneHalfEnabled&&(this.rtHalf=this.createRenderTarget("SceneColorHalf",!1,!1,1,a),this.sceneTextureHalf=this.rtHalf.colorBuffer),this.sceneOptions={resizeSource:i,scaleX:this.renderTargetScale,scaleY:this.renderTargetScale},this.createPasses(e);const n=this.collectPasses();this.beforePasses=n.filter(r=>r!=null)}collectPasses(){return[this.prePass,this.ssaoPass,this.scenePass,this.colorGrabPass,this.scenePassTransparent,this.taaPass,this.scenePassHalf,this.bloomPass,this.dofPass,this.composePass,this.afterPass]}createPasses(e){this.setupScenePrepass(e),this.setupSsaoPass(e);const t=this.setupScenePass(e),s=this.setupTaaPass(e);this.setupSceneHalfPass(e,s),this.setupBloomPass(e,this.sceneTextureHalf),this.setupDofPass(e,this.sceneTexture,this.sceneTextureHalf),this.setupComposePass(e),this.setupAfterPass(e,t)}setupScenePrepass(e){if(e.prepassEnabled){const{app:t,device:s,cameraComponent:i}=this,{scene:a,renderer:n}=t;this.prePass=new q6(s,a,n,i,this.sceneOptions)}}setupScenePassSettings(e){e.gammaCorrection=Ch,e.toneMapping=iy}setupScenePass(e){const{app:t,device:s,cameraComponent:i}=this,{scene:a,renderer:n}=t,r=a.layers;this.scenePass=new mb(s,r,a,n),this.setupScenePassSettings(this.scenePass),this.scenePass.init(this.rt,this.sceneOptions);const l=e.sceneColorMap?e.lastGrabLayerId:e.lastSceneLayerId,u=e.sceneColorMap?e.lastGrabLayerIsTransparent:e.lastSceneLayerIsTransparent,f={lastAddedIndex:0,clearRenderTarget:!0};return f.lastAddedIndex=this.scenePass.addLayers(r,i,f.lastAddedIndex,f.clearRenderTarget,l,u),f.clearRenderTarget=!1,e.sceneColorMap&&(this.colorGrabPass=new wP(s),this.colorGrabPass.source=this.rt,this.scenePassTransparent=new mb(s,r,a,n),this.setupScenePassSettings(this.scenePassTransparent),this.scenePassTransparent.init(this.rt),f.lastAddedIndex=this.scenePassTransparent.addLayers(r,i,f.lastAddedIndex,f.clearRenderTarget,e.lastSceneLayerId,e.lastSceneLayerIsTransparent),this.scenePassTransparent.rendersAnything||(this.scenePassTransparent.destroy(),this.scenePassTransparent=null),this.scenePassTransparent&&e.prepassEnabled&&(this.scenePassTransparent.depthStencilOps.storeDepth=!0)),f}setupSsaoPass(e){const{ssaoBlurEnabled:t,ssaoType:s}=e,{device:i,cameraComponent:a}=this;s!==$p&&(this.ssaoPass=new X6(i,this.sceneTexture,a,t))}setupSceneHalfPass(e,t){this._sceneHalfEnabled&&(this.scenePassHalf=new ZC(this.device,this.sceneTexture,{boxFilter:!0}),this.scenePassHalf.name="RenderPassSceneHalf",this.scenePassHalf.init(this.rtHalf,{resizeSource:t,scaleX:.5,scaleY:.5}),this.scenePassHalf.setClearColor(xe.BLACK))}setupBloomPass(e,t){this._bloomEnabled&&(this.bloomPass=new V6(this.device,t,this.hdrFormat))}setupDofPass(e,t,s){e.dofEnabled&&(this.dofPass=new W6(this.device,this.cameraComponent,t,s,e.dofHighQuality,e.dofNearBlur))}setupTaaPass(e){let t=this.sceneTexture;return e.taaEnabled&&(this.taaPass=new H6(this.device,this.sceneTexture,this.cameraComponent),t=this.taaPass.historyTexture),t}setupComposePass(e){var i,a,n,r;this.composePass=new G6(this.device),this.composePass.bloomTexture=(i=this.bloomPass)==null?void 0:i.bloomTexture,this.composePass.taaEnabled=e.taaEnabled,this.composePass.cocTexture=(a=this.dofPass)==null?void 0:a.cocTexture,this.composePass.blurTexture=(n=this.dofPass)==null?void 0:n.blurTexture,this.composePass.blurTextureUpscale=!((r=this.dofPass)!=null&&r.highQuality);const s=this.cameraComponent.renderTarget;this.composePass.init(s),this.composePass.ssaoTexture=e.ssaoType===z6?this.ssaoPass.ssaoTexture:null}setupAfterPass(e,t){const{app:s,cameraComponent:i}=this,{scene:a,renderer:n}=s,r=a.layers,l=i.renderTarget;this.afterPass=new mb(this.device,r,a,n),this.afterPass.init(l),this.afterPass.addLayers(r,i,t.lastAddedIndex,t.clearRenderTarget)}frameUpdate(){var t,s;super.frameUpdate();const e=((t=this.taaPass)==null?void 0:t.update())??this.rt.colorBuffer;this.composePass.sceneTexture=e,(s=this.scenePassHalf)==null||s.setSourceTexture(e)}}class jne{constructor(e,t){this._enabled=!0,this.rendering={renderFormats:[Yc,Js,Ri],stencil:!1,renderTargetScale:1,samples:1,sceneColorMap:!1,sceneDepthMap:!1,toneMapping:0,sharpness:0},this.ssao={type:$p,blurEnabled:!0,randomize:!1,intensity:.5,radius:30,samples:12,power:6,minAngle:10,scale:1},this.bloom={intensity:0,blurLevel:16},this.grading={enabled:!1,brightness:1,contrast:1,saturation:1,tint:new xe(1,1,1,1)},this.vignette={intensity:0,inner:.5,outer:1,curvature:.5},this.taa={enabled:!1,jitter:1},this.fringing={intensity:0},this.dof={enabled:!1,nearBlur:!1,focusDistance:100,focusRange:10,blurRadius:3,blurRings:4,blurRingPoints:5,highQuality:!0},this.debug=null,this.options=new xL,this.renderPassCamera=null,this.app=e,this.cameraComponent=t,this.updateOptions(),this.enable()}destroy(){this.disable()}enable(){this.renderPassCamera=this.createRenderPass(),this.cameraComponent.renderPasses=[this.renderPassCamera]}disable(){var t;const e=this.cameraComponent;(t=e.renderPasses)==null||t.forEach(s=>{s.destroy()}),e.renderPasses=[],e.rendering=null,e.jitter=0,e.shaderParams.ssaoEnabled=!1,this.renderPassCamera=null}createRenderPass(){return new j6(this.app,this.cameraComponent,this.options)}set enabled(e){this._enabled!==e&&(e?this.enable():this.disable(),this._enabled=e)}get enabled(){return this._enabled}updateOptions(){const{options:e,rendering:t,bloom:s,taa:i,ssao:a}=this;e.stencil=t.stencil,e.samples=t.samples,e.sceneColorMap=t.sceneColorMap,e.prepassEnabled=t.sceneDepthMap,e.bloomEnabled=s.intensity>0,e.taaEnabled=i.enabled,e.ssaoType=a.type,e.ssaoBlurEnabled=a.blurEnabled,e.formats=t.renderFormats.slice(),e.dofEnabled=this.dof.enabled,e.dofNearBlur=this.dof.nearBlur,e.dofHighQuality=this.dof.highQuality}update(){if(!this._enabled)return;const e=this.cameraComponent,{options:t,renderPassCamera:s,rendering:i,bloom:a,grading:n,vignette:r,fringing:l,taa:u,ssao:f}=this;this.updateOptions(),s.update(t);const{composePass:_,bloomPass:g,ssaoPass:y,dofPass:v}=s;s.renderTargetScale=ge.clamp(i.renderTargetScale,.1,1),_.toneMapping=i.toneMapping,_.sharpness=i.sharpness,t.bloomEnabled&&g&&(_.bloomIntensity=a.intensity,g.blurLevel=a.blurLevel),t.dofEnabled&&(v.focusDistance=this.dof.focusDistance,v.focusRange=this.dof.focusRange,v.blurRadius=this.dof.blurRadius,v.blurRings=this.dof.blurRings,v.blurRingPoints=this.dof.blurRingPoints),t.ssaoType!==$p&&(y.intensity=f.intensity,y.power=f.power,y.radius=f.radius,y.sampleCount=f.samples,y.minAngle=f.minAngle,y.scale=f.scale,y.randomize=f.randomize),_.gradingEnabled=n.enabled,n.enabled&&(_.gradingSaturation=n.saturation,_.gradingBrightness=n.brightness,_.gradingContrast=n.contrast,_.gradingTint=n.tint),_.vignetteEnabled=r.intensity>0,_.vignetteEnabled&&(_.vignetteInner=r.inner,_.vignetteOuter=r.outer,_.vignetteCurvature=r.curvature,_.vignetteIntensity=r.intensity),_.fringingEnabled=l.intensity>0,_.fringingEnabled&&(_.fringingIntensity=l.intensity),e.jitter=u.enabled?u.jitter:0,_.debug=this.debug,_.debug==="ssao"&&t.ssaoType===$p&&(_.debug=null),_.debug==="vignette"&&!_.vignetteEnabled&&(_.debug=null)}}const I0="local",lD="world",Id="x",Od="y",Nd="z",Yne="yz",Kne="xz",Qne="xy",Tb="xyz",el="face",Dn=new H,dN=new H,$ne=new Me,Zne=new Me,Jne=new ll,ere="Gizmo",tre=1e-4,sre=.3,ire=.32,hM=1e-6,Ei=class Ei extends Qe{static createLayer(e,t=ere,s){const i=new Fi({name:t,clearDepthBuffer:!0,opaqueSortMode:jp,transparentSortMode:jp});return e.scene.layers.insert(i,s??e.scene.layers.layerList.length),i}constructor(e,t){super(),this._size=1,this._scale=1,this._coordSpace=lD,this.nodes=[],this.intersectShapes=[],this._camera=e,this._app=e.system.app,this._device=this._app.graphicsDevice,this._layer=t,e.layers=e.layers.concat(t.id),this.root=new Kt("gizmo"),this._app.root.addChild(this.root),this.root.enabled=!1,this._updateScale(),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._device.canvas.addEventListener("pointerdown",this._onPointerDown),this._device.canvas.addEventListener("pointermove",this._onPointerMove),this._device.canvas.addEventListener("pointerup",this._onPointerUp),this._app.on("update",()=>{this._updatePosition(),this._updateRotation(),this._updateScale()}),this._app.on("destroy",()=>this.destroy())}get layer(){return this._layer}set coordSpace(e){this._coordSpace=e??lD,this._updateRotation()}get coordSpace(){return this._coordSpace}set size(e){this._size=e,this._updateScale()}get size(){return this._size}get facing(){if(this._camera.projection===Ya){const e=this.root.getPosition(),t=this._camera.entity.getPosition();return dN.sub2(t,e).normalize()}return dN.copy(this._camera.entity.forward).mulScalar(-1)}_onPointerDown(e){if(!this.root.enabled||document.pointerLockElement)return;const t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation());const{canvas:s}=this._device;s.setPointerCapture(e.pointerId),this.fire(Ei.EVENT_POINTERDOWN,e.offsetX,e.offsetY,t[0])}_onPointerMove(e){if(!this.root.enabled||document.pointerLockElement)return;const t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation()),this.fire(Ei.EVENT_POINTERMOVE,e.offsetX,e.offsetY,t[0])}_onPointerUp(e){if(!this.root.enabled||document.pointerLockElement)return;const t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation());const{canvas:s}=this._device;s.releasePointerCapture(e.pointerId),this.fire(Ei.EVENT_POINTERUP,e.offsetX,e.offsetY,t[0])}_updatePosition(){Dn.set(0,0,0);for(let e=0;e<this.nodes.length;e++){const t=this.nodes[e];Dn.add(t.getPosition())}Dn.mulScalar(1/(this.nodes.length||1)),!(Dn.distance(this.root.getPosition())<hM)&&(this.root.setPosition(Dn),this.fire(Ei.EVENT_POSITIONUPDATE,Dn))}_updateRotation(){Dn.set(0,0,0),this._coordSpace===I0&&this.nodes.length!==0&&Dn.copy(this.nodes[this.nodes.length-1].getEulerAngles()),!(Dn.distance(this.root.getEulerAngles())<hM)&&(this.root.setEulerAngles(Dn),this.fire(Ei.EVENT_ROTATIONUPDATE,Dn))}_updateScale(){if(this._camera.projection===Ya){const e=this.root.getPosition(),t=this._camera.entity.getPosition(),s=e.distance(t);this._scale=Math.tan(.5*this._camera.fov*ge.DEG_TO_RAD)*s*sre}else this._scale=this._camera.orthoHeight*ire;this._scale=Math.max(this._scale*this._size,tre),!(Math.abs(this._scale-this.root.getLocalScale().x)<hM)&&(this.root.setLocalScale(this._scale,this._scale,this._scale),this.fire(Ei.EVENT_SCALEUPDATE,this._scale))}_getSelection(e,t){const s=this._camera.screenToWorld(e,t,0),i=this._camera.screenToWorld(e,t,this._camera.farClip-this._camera.nearClip),a=Dn.copy(i).sub(s).normalize(),n=[];for(let r=0;r<this.intersectShapes.length;r++){const l=this.intersectShapes[r];if(l.disabled||!l.entity.enabled)continue;const u=l.entity.getWorldTransform();for(let f=0;f<l.triData.length;f++){const{tris:_,transform:g,priority:y}=l.triData[f],v=$ne.copy(u).mul(g),x=Zne.copy(v).invert(),C=Jne;x.transformPoint(s,C.origin),x.transformVector(a,C.direction),C.direction.normalize();for(let M=0;M<_.length;M++)_[M].intersectsRay(C,Dn)&&n.push({dist:v.transformPoint(Dn).sub(s).length(),meshInstances:l.meshInstances,priority:y})}}return n.length?(n.sort((r,l)=>r.priority!==0&&l.priority!==0?l.priority-r.priority:r.dist-l.dist),n[0].meshInstances):[]}attach(e=[]){if(Array.isArray(e)){if(e.length===0)return;this.nodes=e}else this.nodes=[e];this._updatePosition(),this._updateRotation(),this._updateScale(),this.fire(Ei.EVENT_NODESATTACH),this.root.enabled=!0,this.fire(Ei.EVENT_RENDERUPDATE)}detach(){this.root.enabled=!1,this.fire(Ei.EVENT_RENDERUPDATE),this.fire(Ei.EVENT_NODESDETACH),this.nodes=[]}destroy(){this.detach(),this._device.canvas.removeEventListener("pointerdown",this._onPointerDown),this._device.canvas.removeEventListener("pointermove",this._onPointerMove),this._device.canvas.removeEventListener("pointerup",this._onPointerUp),this.root.destroy()}};Ei.EVENT_POINTERDOWN="pointer:down",Ei.EVENT_POINTERMOVE="pointer:move",Ei.EVENT_POINTERUP="pointer:up",Ei.EVENT_POSITIONUPDATE="position:update",Ei.EVENT_ROTATIONUPDATE="rotation:update",Ei.EVENT_SCALEUPDATE="scale:update",Ei.EVENT_NODESATTACH="nodes:attach",Ei.EVENT_NODESDETACH="nodes:detach",Ei.EVENT_RENDERUPDATE="render:update";let _h=Ei;const xA=Object.freeze(new xe(1,.3,.3)),TA=Object.freeze(new xe(.3,1,.3)),EA=Object.freeze(new xe(.3,.3,1)),fN=Object.freeze(new xe(1,1,.5)),Y6=Object.freeze(new xe(.5,.5,.5,.5)),are=h=>new xe(h.r,h.g,h.b),nre=(h,e)=>new xe(h.r,h.g,h.b,e),Ln=new H,Rg=new H,rre=new Ne,gp=new ll,pN=new E1,mN=Object.keys(Ln),vd=class vd extends _h{constructor(e,t){super(e,t),this._colorAlpha=.6,this._meshColors={axis:{x:this._colorSemi(xA),y:this._colorSemi(TA),z:this._colorSemi(EA),xyz:this._colorSemi(xe.WHITE),f:this._colorSemi(xe.WHITE)},hover:{x:xA.clone(),y:TA.clone(),z:EA.clone(),xyz:xe.WHITE.clone(),f:fN.clone()},disabled:Y6.clone()},this._guideColors={x:xA.clone(),y:TA.clone(),z:EA.clone(),f:fN.clone()},this._rootStartPos=new H,this._rootStartRot=new Ne,this._shading=!1,this._shapes={},this._shapeMap=new Map,this._hoverShape=null,this._hoverAxis="",this._hoverIsPlane=!1,this._noSelection=!1,this._selectedAxis="",this._selectedIsPlane=!1,this._selectionStartPoint=new H,this._dragging=!1,this._snap=!1,this.snapIncrement=1,this._app.on("prerender",()=>{this.root.enabled&&this._drawGuideLines()}),this.on(_h.EVENT_POINTERDOWN,(s,i,a)=>{const n=this._shapeMap.get(a);if(n!=null&&n.disabled||this._dragging)return;if(!a){this._noSelection=!0;return}this._selectedAxis=this._getAxis(a),this._selectedIsPlane=this._getIsPlane(a),this._rootStartPos.copy(this.root.getPosition()),this._rootStartRot.copy(this.root.getRotation());const r=this._screenToPoint(s,i);this._selectionStartPoint.copy(r),this._dragging=!0,this.fire(vd.EVENT_TRANSFORMSTART,r,s,i)}),this.on(_h.EVENT_POINTERMOVE,(s,i,a)=>{const n=this._shapeMap.get(a);if(n!=null&&n.disabled||(this._noSelection||this._hover(a),!this._dragging))return;const r=this._screenToPoint(s,i);this.fire(vd.EVENT_TRANSFORMMOVE,r,s,i),this._hoverAxis="",this._hoverIsPlane=!1}),this.on(_h.EVENT_POINTERUP,(s,i,a)=>{this._noSelection=!1,this._hover(a),this._dragging&&(this._dragging=!1,this.fire(vd.EVENT_TRANSFORMEND),this._selectedAxis="",this._selectedIsPlane=!1)}),this.on(_h.EVENT_NODESDETACH,()=>{this.snap=!1,this._hoverAxis="",this._hoverIsPlane=!1,this._hover(),this.fire(_h.EVENT_POINTERUP)})}set shading(e){this._shading=this.root.enabled&&e;for(const t in this._shapes)this._shapes[t].shading=this._shading}get shading(){return this._shading}set snap(e){this._snap=this.root.enabled&&e}get snap(){return this._snap}set xAxisColor(e){this._updateAxisColor(Id,e)}get xAxisColor(){return this._meshColors.axis.x}set yAxisColor(e){this._updateAxisColor(Od,e)}get yAxisColor(){return this._meshColors.axis.y}set zAxisColor(e){this._updateAxisColor(Nd,e)}get zAxisColor(){return this._meshColors.axis.z}set colorAlpha(e){this._colorAlpha=ge.clamp(e,0,1),this._meshColors.axis.x.copy(this._colorSemi(this._meshColors.axis.x)),this._meshColors.axis.y.copy(this._colorSemi(this._meshColors.axis.y)),this._meshColors.axis.z.copy(this._colorSemi(this._meshColors.axis.z)),this._meshColors.axis.xyz.copy(this._colorSemi(this._meshColors.axis.xyz)),this._meshColors.axis.f.copy(this._colorSemi(this._meshColors.axis.f));for(const t in this._shapes)this._shapes[t].hover(!!this._hoverAxis)}get colorAlpha(){return this._colorAlpha}_colorSemi(e){return nre(e,this._colorAlpha)}_updateAxisColor(e,t){const s=are(t),i=this._colorSemi(t);this._guideColors[e].copy(s),this._meshColors.axis[e].copy(i),this._meshColors.hover[e].copy(s);for(const a in this._shapes)this._shapes[a].hover(!!this._hoverAxis)}_getAxis(e){return e?e.node.name.split(":")[1]:""}_getIsPlane(e){return e?e.node.name.indexOf("plane")!==-1:!1}_hover(e){if(this._dragging)return;this._hoverAxis=this._getAxis(e),this._hoverIsPlane=this._getIsPlane(e);const t=e?this._shapeMap.get(e)??null:null;t!==this._hoverShape&&(this._hoverShape&&(this._hoverShape.hover(!1),this._hoverShape=null),t&&(t.hover(!0),this._hoverShape=t),this.fire(_h.EVENT_RENDERUPDATE))}_createRay(e){if(this._camera.projection===Ya)return gp.origin.copy(this._camera.entity.getPosition()),gp.direction.sub2(e,gp.origin).normalize(),gp;const t=this._camera.farClip-this._camera.nearClip;return gp.origin.sub2(e,Ln.copy(this._camera.entity.forward).mulScalar(t)),gp.direction.copy(this._camera.entity.forward),gp}_createPlane(e,t,s){const i=Ln.copy(this.facing),a=pN.normal.set(0,0,0);return t?a.copy(i):(a[e]=1,this._rootStartRot.transformVector(a,a),s&&(Rg.cross(a,i).normalize(),a.cross(Rg,a).normalize())),pN.setFromPointNormal(this._rootStartPos,a)}_dirFromAxis(e,t){return e===el?t.copy(this._camera.entity.forward).mulScalar(-1):(t.set(0,0,0),t[e]=1),t}_projectToAxis(e,t){Ln.set(0,0,0),Ln[t]=1,e.copy(Ln.mulScalar(Ln.dot(e)));const s=e[t];e.set(0,0,0),e[t]=s}_screenToPoint(e,t,s=!1,i=!1){const a=this._camera.screenToWorld(e,t,1),n=this._selectedAxis,r=this._createRay(a),l=this._createPlane(n,s,i),u=new H;return l.intersectsRay(r,u),u}_drawGuideLines(){const e=this.root.getPosition(),t=rre.copy(this.root.getRotation()),s=this._hoverAxis||this._selectedAxis,i=this._hoverIsPlane||this._selectedIsPlane;for(let a=0;a<mN.length;a++){const n=mN[a];if(s===Tb){this._drawSpanLine(e,t,n);continue}i?n!==s&&this._drawSpanLine(e,t,n):n===s&&this._drawSpanLine(e,t,n)}}_drawSpanLine(e,t,s){Ln.set(0,0,0),Ln[s]=1,Ln.mulScalar(this._camera.farClip-this._camera.nearClip),Rg.copy(Ln).mulScalar(-1),t.transformVector(Ln,Ln),t.transformVector(Rg,Rg),this._app.drawLine(Ln.add(e),Rg.add(e),this._guideColors[s],!0)}_createTransform(){for(const e in this._shapes){const t=this._shapes[e];this.root.addChild(t.entity),this.intersectShapes.push(t);for(let s=0;s<t.meshInstances.length;s++)this._shapeMap.set(t.meshInstances[s],t)}}enableShape(e,t){this._shapes.hasOwnProperty(e)&&(this._shapes[e].disabled=!t)}isShapeEnabled(e){return this._shapes.hasOwnProperty(e)?!this._shapes[e].disabled:!1}destroy(){super.destroy();for(const e in this._shapes)this._shapes[e].destroy()}};vd.EVENT_TRANSFORMSTART="transform:start",vd.EVENT_TRANSFORMMOVE="transform:move",vd.EVENT_TRANSFORMEND="transform:end";let Ma=vd;const _N=new H,gN=new H,yN=new H;class Zd{constructor(e,t=0){this._priority=0,this._transform=new Me,this.tris=[],this.fromGeometry(e),this._priority=t}get transform(){return this._transform}get priority(){return this._priority}setTransform(e=new H,t=new Ne,s=new H){this.transform.setTRS(e,t,s)}fromGeometry(e){if(!e||!(e instanceof dl))throw new Error("No geometry provided.");const t=e.positions??[],s=e.indices??[];this.tris=[];for(let i=0;i<s.length;i+=3){const a=s[i],n=s[i+1],r=s[i+2];_N.set(t[a*3],t[a*3+1],t[a*3+2]),gN.set(t[n*3],t[n*3+1],t[n*3+2]),yN.set(t[r*3],t[r*3+1],t[r*3+2]);const l=new pF(_N,gN,yN);this.tris.push(l)}}}const ore=.25,lre=.75,hre=new H(1,2,3),cre={box:Kd,cone:bx,cylinder:uy,plane:xx,sphere:cy,torus:D0},ure={uniqueName:"axis-shape",attributes:{vertex_position:kt,vertex_color:Qi},vertexGLSL:`
		attribute vec3 vertex_position;
		attribute vec4 vertex_color;
		varying vec4 vColor;
		uniform mat4 matrix_model;
		uniform mat4 matrix_viewProjection;
		void main(void) {
			gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);
			gl_Position.z = clamp(gl_Position.z, -abs(gl_Position.w), abs(gl_Position.w));
			vColor = vertex_color;
		}
	`,fragmentGLSL:`
		#include "gammaPS"
		precision highp float;
		varying vec4 vColor;
		void main(void) {
			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(vColor)), vColor.w);
		}
	`},hD=new Map,vN=new H,dre=new H,fre=new Me,Eb=new dl;Eb.positions=[];Eb.normals=[];const SN=(h,e,t)=>{if(!h.normals||!h.positions)return[];let s;t&&(s=fre.copy(t).invert().transformVector(vN.copy(hre),vN).normalize()),h.colors=[];const i=[],a=h.positions.length/3;for(let n=0;n<a;n++){let r=1;if(s){const l=h.normals[n*3],u=h.normals[n*3+1],f=h.normals[n*3+2],_=dre.set(l,u,f);r=s.dot(_)*ore+lre}i.push(r),h.colors.push(r*e.r*255,r*e.g*255,r*e.b*255,e.a*255)}return i},cM=(h,e)=>{const t=hD.get(h),s=[];for(let i=0;i<t.length;i++)s.push(t[i]*e.r*255,t[i]*e.g*255,t[i]*e.b*255,e.a*255);h.setColors32(s),h.update()};let py=class{constructor(e,t){this._layers=[],this._shading=!0,this._defaultColor=xe.WHITE,this._hoverColor=xe.BLACK,this._disabledColor=Y6,this._cull=jc,this.triData=[],this.meshInstances=[],this.device=e,this.axis=t.axis??"x",this._position=t.position??new H,this._rotation=t.rotation??new H,this._scale=t.scale??new H(1,1,1),this._disabled=t.disabled??!1,this._layers=t.layers??this._layers,this._shading=t.shading??this._shading,t.defaultColor instanceof xe&&(this._defaultColor=t.defaultColor),t.hoverColor instanceof xe&&(this._hoverColor=t.hoverColor),t.disabledColor instanceof xe&&(this._disabledColor=t.disabledColor)}set disabled(e){for(let t=0;t<this.meshInstances.length;t++)cM(this.meshInstances[t].mesh,e?this._disabledColor:this._defaultColor);this._disabled=e??!1}get disabled(){return this._disabled}set shading(e){this._shading=e??!0;const t=this._disabled?this._disabledColor:this._defaultColor;for(let s=0;s<this.meshInstances.length;s++){const i=this.meshInstances[s].mesh;i.getPositions(Eb.positions),i.getNormals(Eb.normals);const a=SN(Eb,t,this._shading?this.entity.getWorldTransform():void 0);hD.set(i,a),cM(i,t)}}get shading(){return this._shading}_createRoot(e){this.entity=new Kt(`${e}:${this.axis}`),this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale)}_createMesh(e,t=!0){const s=this._disabled?this._disabledColor:this._defaultColor,i=SN(e,s,t?this.entity.getWorldTransform():void 0),a=Ft.fromGeometry(this.device,e);return hD.set(a,i),a}_createRenderComponent(e,t){const s=new Yd(ure);s.cull=this._cull,s.blendType=xr,s.update();const i=[];for(let a=0;a<t.length;a++){const n=new ps(t[a],s);n.cull=!1,i.push(n),this.meshInstances.push(n)}e.addComponent("render",{meshInstances:i,layers:this._layers,castShadows:!1})}_addRenderMesh(e,t,s){const i=cre[t];if(!i)throw new Error("Invalid primitive type.");this._createRenderComponent(e,[this._createMesh(new i,s)])}hover(e){if(!this._disabled)for(let t=0;t<this.meshInstances.length;t++){const s=e?this._hoverColor:this._defaultColor,i=this.meshInstances[t].mesh;cM(i,s)}}destroy(){this.entity.destroy()}};const pre=1e-6;class m0 extends py{constructor(e,t={}){super(e,t),this._cull=Xs,this._size=.2,this._gap=.1,this._flipped=new H,this.triData=[new Zd(new xx)],this._createPlane()}set size(e){this._size=e??1,this._updateTransform()}get size(){return this._size}set gap(e){this._gap=e??0,this._updateTransform()}get gap(){return this._gap}set flipped(e){this._flipped.distance(e)<pre||(this._flipped.copy(e),this.entity.setLocalPosition(this._getPosition()))}get flipped(){return this._flipped}_getPosition(){const e=this._size/2+this._gap,t=new H(this._flipped.x?-e:e,this._flipped.y?-e:e,this._flipped.z?-e:e);return t[this.axis]=0,t}_createPlane(){this._createRoot("plane"),this._updateTransform(),this._addRenderMesh(this.entity,"plane",this._shading)}_updateTransform(){this.entity.setLocalPosition(this._getPosition()),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._size,this._size,this._size)}}const yp=new H,eA=new H,tA=new Ne;class uM extends py{constructor(e,t={}){super(e,t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._arrowThickness=.12,this._arrowLength=.18,this._tolerance=.1,this._flipped=!1,this.triData=[new Zd(new bx),new Zd(new uy,1)],this._createArrow()}set gap(e){this._gap=e??0,this._updateHead(),this._updateLine()}get gap(){return this._gap}set lineThickness(e){this._lineThickness=e??1,this._updateHead(),this._updateLine()}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e??1,this._updateHead(),this._updateLine()}get lineLength(){return this._lineLength}set arrowThickness(e){this._arrowThickness=e??1,this._updateHead()}get arrowThickness(){return this._arrowThickness}set arrowLength(e){this._arrowLength=e??1,this._updateHead()}get arrowLength(){return this._arrowLength}set tolerance(e){this._tolerance=e,this._updateLine()}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(H.ZERO)?yp.set(0,0,this._flipped?180:0):yp.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(yp))}get flipped(){return this._flipped}_createArrow(){this._createRoot("arrow"),this._head=new Kt(`head:${this.axis}`),this.entity.addChild(this._head),this._updateHead(),this._addRenderMesh(this._head,"cone",this._shading),this._line=new Kt(`line:${this.axis}`),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading)}_updateHead(){yp.set(0,this._gap+this._arrowLength*.5+this._lineLength,0),tA.set(0,0,0,1),eA.set(this._arrowThickness,this._arrowLength,this._arrowThickness),this.triData[0].setTransform(yp,tA,eA),this._head.setLocalPosition(0,this._gap+this._arrowLength*.5+this._lineLength,0),this._head.setLocalScale(this._arrowThickness,this._arrowLength,this._arrowThickness)}_updateLine(){yp.set(0,this._gap+this._lineLength*.5,0),tA.set(0,0,0,1),eA.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(yp,tA,eA),this._line.setLocalPosition(0,this._gap+this._lineLength*.5,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness)}}class mre extends py{constructor(e,t={}){super(e,t),this._size=.12,this._tolerance=.05,this.triData=[new Zd(new cy,2)],this._createCenter()}_createCenter(){this._createRoot("sphereCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"sphere",this._shading)}set size(e){this._size=e??1,this._updateTransform()}get size(){return this._size}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.entity.setLocalScale(this._size,this._size,this._size)}}const ua=new H,Yo=new H,_re=new H,bN=new Ne,Mg=.98;class gre extends Ma{constructor(e,t){super(e,t),this._shapes={face:new mre(this._device,{axis:el,layers:[this._layer.id],shading:this._shading,defaultColor:this._meshColors.axis.xyz,hoverColor:this._meshColors.hover.xyz}),yz:new m0(this._device,{axis:Id,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),xz:new m0(this._device,{axis:Od,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),xy:new m0(this._device,{axis:Nd,layers:[this._layer.id],shading:this._shading,rotation:new H(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z}),x:new uM(this._device,{axis:Id,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),y:new uM(this._device,{axis:Od,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),z:new uM(this._device,{axis:Nd,layers:[this._layer.id],shading:this._shading,rotation:new H(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z})},this._nodeLocalPositions=new Map,this._nodePositions=new Map,this.snapIncrement=1,this.flipShapes=!0,this._createTransform(),this.on(Ma.EVENT_TRANSFORMSTART,()=>{this._storeNodePositions()}),this.on(Ma.EVENT_TRANSFORMMOVE,s=>{const i=_re.copy(s).sub(this._selectionStartPoint);this.snap&&(i.mulScalar(1/this.snapIncrement),i.round(),i.mulScalar(this.snapIncrement)),this._setNodePositions(i)}),this.on(Ma.EVENT_NODESDETACH,()=>{this._nodeLocalPositions.clear(),this._nodePositions.clear()}),this._app.on("prerender",()=>{this._shapesLookAtCamera()})}set axisGap(e){this._setArrowProp("gap",e)}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e)}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e)}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e)}get axisLineTolerance(){return this._shapes.x.tolerance}set axisArrowThickness(e){this._setArrowProp("arrowThickness",e)}get axisArrowThickness(){return this._shapes.x.arrowThickness}set axisArrowLength(e){this._setArrowProp("arrowLength",e)}get axisArrowLength(){return this._shapes.x.arrowLength}set axisPlaneSize(e){this._setPlaneProp("size",e)}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e)}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.face.size=e}get axisCenterSize(){return this._shapes.face.size}set axisCenterTolerance(e){this._shapes.face.tolerance=e}get axisCenterTolerance(){return this._shapes.face.tolerance}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t}_shapesLookAtCamera(){const e=this.facing;let t=e.dot(this.root.right);this._shapes.x.entity.enabled=Math.abs(t)<Mg,this.flipShapes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=Math.abs(t)<Mg,this.flipShapes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=Math.abs(t)<Mg,this.flipShapes&&(this._shapes.z.flipped=t>0),ua.cross(e,this.root.right),this._shapes.yz.entity.enabled=ua.length()<Mg,this.flipShapes&&(this._shapes.yz.flipped=Yo.set(0,+(ua.dot(this.root.forward)<0),+(ua.dot(this.root.up)<0))),ua.cross(e,this.root.forward),this._shapes.xy.entity.enabled=ua.length()<Mg,this.flipShapes&&(this._shapes.xy.flipped=Yo.set(+(ua.dot(this.root.up)<0),+(ua.dot(this.root.right)>0),0)),ua.cross(e,this.root.up),this._shapes.xz.entity.enabled=ua.length()<Mg,this.flipShapes&&(this._shapes.xz.flipped=Yo.set(+(ua.dot(this.root.forward)>0),0,+(ua.dot(this.root.right)>0)))}_storeNodePositions(){for(let e=0;e<this.nodes.length;e++){const t=this.nodes[e];this._nodeLocalPositions.set(t,t.getLocalPosition().clone()),this._nodePositions.set(t,t.getPosition().clone())}}_setNodePositions(e){var t;for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s];if(this._coordSpace===I0){const a=this._nodeLocalPositions.get(i);if(!a)continue;ua.copy(e),(t=i.parent)==null||t.getWorldTransform().getScale(Yo),Yo.x=1/Yo.x,Yo.y=1/Yo.y,Yo.z=1/Yo.z,bN.copy(i.getLocalRotation()).transformVector(ua,ua),ua.mul(Yo),i.setLocalPosition(ua.add(a))}else{const a=this._nodePositions.get(i);if(!a)continue;i.setPosition(ua.copy(e).add(a))}}this._updatePosition()}_screenToPoint(e,t){const s=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,a=this._selectedIsPlane,n=this._createRay(s),r=this._createPlane(i,i===el,!a),l=new H;return r.intersectsRay(n,l),bN.copy(this._rootStartRot).invert().transformVector(l,l),!a&&i!==el&&this._projectToAxis(l,i),l}}const yre=80,vre=20;class sA extends py{constructor(e,t={}){super(e,t),this._tubeRadius=.01,this._ringRadius=.5,this._tolerance=.05,this._tubeRadius=t.tubeRadius??this._tubeRadius,this._ringRadius=t.ringRadius??this._ringRadius,this._sectorAngle=t.sectorAngle??this._sectorAngle,this.triData=[new Zd(this._createTorusGeometry())],this._createDisk()}_createTorusGeometry(){return new D0({tubeRadius:this._tubeRadius+this._tolerance,ringRadius:this._ringRadius,sectorAngle:this._sectorAngle,segments:vre})}_createTorusMesh(e){const t=new D0({tubeRadius:this._tubeRadius,ringRadius:this._ringRadius,sectorAngle:e,segments:yre});return this._createMesh(t,this._shading)}_createDisk(){this._createRoot("disk"),this._createRenderComponent(this.entity,[this._createTorusMesh(this._sectorAngle),this._createTorusMesh(360)]),this.drag(!1)}set tubeRadius(e){this._tubeRadius=e??.1,this._updateTransform()}get tubeRadius(){return this._tubeRadius}set ringRadius(e){this._ringRadius=e??.1,this._updateTransform()}get ringRadius(){return this._ringRadius}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.triData[0].fromGeometry(this._createTorusGeometry()),this.meshInstances[0].mesh=this._createTorusMesh(this._sectorAngle),this.meshInstances[1].mesh=this._createTorusMesh(360)}drag(e){this.meshInstances[0].visible=!e,this.meshInstances[1].visible=e}hide(e){if(e){this.meshInstances[0].visible=!1,this.meshInstances[1].visible=!1;return}this.drag(!1)}}const cs=new H,vp=new H,xN=new H,TN=new H,EN=new Me,Ko=new Ne,iA=new Ne,Sre=.9,bre=new xe(0,0,0,.3);class xre extends Ma{constructor(e,t){super(e,t),this._shapes={z:new sA(this._device,{axis:Nd,layers:[this._layer.id],shading:this._shading,rotation:new H(90,0,90),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z,sectorAngle:180}),x:new sA(this._device,{axis:Id,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x,sectorAngle:180}),y:new sA(this._device,{axis:Od,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y,sectorAngle:180}),face:new sA(this._device,{axis:el,layers:[this._layer.id],shading:this._shading,rotation:this._getLookAtEulerAngles(this._camera.entity.getPosition()),defaultColor:this._meshColors.axis.f,hoverColor:this._meshColors.hover.f,ringRadius:.55})},this._selectionStartAngle=0,this._nodeLocalRotations=new Map,this._nodeRotations=new Map,this._nodeOffsets=new Map,this._guideAngleStartColor=bre.clone(),this._guideAngleStart=new H,this._guideAngleEnd=new H,this.snapIncrement=5,this.orbitRotation=!1,this._createTransform(),this.on(Ma.EVENT_TRANSFORMSTART,(s,i,a)=>{this._selectionStartAngle=this._calculateAngle(s,i,a),this._storeNodeRotations(),this._storeGuidePoints(),this._drag(!0)}),this.on(Ma.EVENT_TRANSFORMMOVE,(s,i,a)=>{const n=this._selectedAxis;let r=this._calculateAngle(s,i,a)-this._selectionStartAngle;this.snap&&(r=Math.round(r/this.snapIncrement)*this.snapIncrement),this._setNodeRotations(n,r),this._updateGuidePoints(r)}),this.on(Ma.EVENT_TRANSFORMEND,()=>{this._drag(!1)}),this.on(Ma.EVENT_NODESDETACH,()=>{this._nodeLocalRotations.clear(),this._nodeRotations.clear(),this._nodeOffsets.clear()}),this._app.on("prerender",()=>{if(this._shapesLookAtCamera(),this._dragging){const s=this.root.getPosition();this._drawGuideAngleLine(s,this._selectedAxis,this._guideAngleStart,this._guideAngleStartColor),this._drawGuideAngleLine(s,this._selectedAxis,this._guideAngleEnd)}})}set xyzTubeRadius(e){this._setDiskProp("tubeRadius",e)}get xyzTubeRadius(){return this._shapes.x.tubeRadius}set xyzRingRadius(e){this._setDiskProp("ringRadius",e)}get xyzRingRadius(){return this._shapes.x.ringRadius}set faceTubeRadius(e){this._shapes.face.tubeRadius=e}get faceTubeRadius(){return this._shapes.face.tubeRadius}set faceRingRadius(e){this._shapes.face.ringRadius=e}get faceRingRadius(){return this._shapes.face.ringRadius}set ringTolerance(e){this._setDiskProp("tolerance",e),this._shapes.face.tolerance=e}get ringTolerance(){return this._shapes.x.tolerance}_setDiskProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_storeGuidePoints(){const e=this.root.getPosition(),i=this._selectedAxis===el?this.faceRingRadius:this.xyzRingRadius;this._guideAngleStart.copy(this._selectionStartPoint).sub(e).normalize(),this._guideAngleStart.mulScalar(i),this._guideAngleEnd.copy(this._guideAngleStart)}_updateGuidePoints(e){const t=this._selectedAxis;t===el?cs.copy(this.facing):(cs.set(0,0,0),cs[t]=1,this._rootStartRot.transformVector(cs,cs)),Ko.setFromAxisAngle(cs,e),Ko.transformVector(this._guideAngleStart,this._guideAngleEnd)}_drawGuideAngleLine(e,t,s,i=this._guideColors[t]){cs.set(0,0,0),vp.copy(s).mulScalar(this._scale),this._app.drawLine(cs.add(e),vp.add(e),i,!1,this._layer)}_getLookAtEulerAngles(e){return cs.set(0,0,0),EN.setLookAt(cs,e,H.UP),Ko.setFromMat4(EN),Ko.getEulerAngles(cs),cs.x+=90,cs}_shapesLookAtCamera(){this._camera.projection===Ya?(this._shapes.face.entity.lookAt(this._camera.entity.getPosition()),this._shapes.face.entity.rotateLocal(90,0,0)):(Ko.copy(this._camera.entity.getRotation()).getEulerAngles(cs),this._shapes.face.entity.setEulerAngles(cs),this._shapes.face.entity.rotateLocal(-90,0,0));const e=cs.copy(this.facing);Ko.copy(this.root.getRotation()).invert().transformVector(e,e);let t=Math.atan2(e.z,e.y)*ge.RAD_TO_DEG;this._shapes.x.entity.setLocalEulerAngles(0,t-90,-90),t=Math.atan2(e.x,e.z)*ge.RAD_TO_DEG,this._shapes.y.entity.setLocalEulerAngles(0,t,0),t=Math.atan2(e.y,e.x)*ge.RAD_TO_DEG,this._shapes.z.entity.setLocalEulerAngles(90,0,t+90)}_drag(e){for(const t in this._shapes){const s=this._shapes[t];t===this._selectedAxis?s.drag(e):s.hide(e)}this.fire(Ma.EVENT_RENDERUPDATE)}_storeNodeRotations(){const e=this.root.getPosition();for(let t=0;t<this.nodes.length;t++){const s=this.nodes[t];this._nodeLocalRotations.set(s,s.getLocalRotation().clone()),this._nodeRotations.set(s,s.getRotation().clone()),this._nodeOffsets.set(s,s.getPosition().clone().sub(e))}}_setNodeRotations(e,t){const s=this.root.getPosition(),i=e===el;Ko.setFromAxisAngle(this._dirFromAxis(e,cs),t);for(let a=0;a<this.nodes.length;a++){const n=this.nodes[a];if(!i&&this._coordSpace===I0){const r=this._nodeLocalRotations.get(n);if(!r)continue;iA.copy(r).mul(Ko),n.setLocalRotation(iA)}else{const r=this._nodeRotations.get(n);if(!r)continue;const l=this._nodeOffsets.get(n);if(!l)continue;cs.copy(l),Ko.transformVector(cs,cs),iA.copy(Ko).mul(r),n.setEulerAngles(iA.getEulerAngles()),n.setPosition(cs.add(s))}}this._coordSpace===I0&&this._updateRotation()}_screenToPoint(e,t){const s=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,a=this._createRay(s),n=this._createPlane(i,i===el,!1),r=new H;return n.intersectsRay(a,r),r}_calculateAngle(e,t,s){const i=this.root.getPosition(),a=this._selectedAxis,n=this._createPlane(a,a===el,!1);let r=0;const l=vp.copy(this.facing),u=n.normal.dot(l);return this.orbitRotation||Math.abs(u)>Sre?(cs.sub2(e,i),Ko.copy(this._camera.entity.getRotation()).invert().transformVector(cs,cs),r=Math.sign(u)*Math.atan2(cs.y,cs.x)*ge.RAD_TO_DEG):(cs.copy(i),vp.cross(n.normal,l).normalize().add(i),this._camera.worldToScreen(cs,xN),this._camera.worldToScreen(vp,TN),cs.sub2(TN,xN).normalize(),vp.set(t,s,0),r=cs.dot(vp)),r}}class Tre extends py{constructor(e,t={}){super(e,t),this._size=.12,this._tolerance=.05,this.triData=[new Zd(new Kd,2)],this._createCenter()}_createCenter(){this._createRoot("boxCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"box",this._shading)}set size(e){this._size=e??1,this._updateTransform()}get size(){return this._size}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.entity.setLocalScale(this._size,this._size,this._size)}}const Sp=new H,aA=new H,nA=new Ne;class dM extends py{constructor(e,t={}){super(e,t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._boxSize=.12,this._tolerance=.1,this._flipped=!1,this.triData=[new Zd(new Kd),new Zd(new uy,1)],this._createBoxLine()}set gap(e){this._gap=e??0,this._updateLine(),this._updateBox()}get gap(){return this._gap}set lineThickness(e){this._lineThickness=e??1,this._updateLine(),this._updateBox()}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e??1,this._updateLine(),this._updateBox()}get lineLength(){return this._lineLength}set boxSize(e){this._boxSize=e??1,this._updateBox()}get boxSize(){return this._boxSize}set tolerance(e){this._tolerance=e,this._updateLine()}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(H.ZERO)?Sp.set(0,0,this._flipped?180:0):Sp.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(Sp))}get flipped(){return this._flipped}_createBoxLine(){this._createRoot("boxLine"),this._box=new Kt(`box:${this.axis}`),this.entity.addChild(this._box),this._updateBox(),this._addRenderMesh(this._box,"box",this._shading),this._line=new Kt(`line:${this.axis}`),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading)}_updateBox(){Sp.set(0,this._gap+this._boxSize*.5+this._lineLength,0),nA.set(0,0,0,1),aA.set(this._boxSize,this._boxSize,this._boxSize),this.triData[0].setTransform(Sp,nA,aA),this._box.setLocalPosition(0,this._gap+this._boxSize*.5+this._lineLength,0),this._box.setLocalScale(this._boxSize,this._boxSize,this._boxSize)}_updateLine(){Sp.set(0,this._gap+this._lineLength*.5,0),nA.set(0,0,0,1),aA.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(Sp,nA,aA),this._line.setLocalPosition(0,this._gap+this._lineLength*.5,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness)}}const xi=new H,xc=new H,Ere=new H,Are=new Ne,Dg=.98;class Cre extends Ma{constructor(e,t){super(e,t),this._shapes={xyz:new Tre(this._device,{axis:Tb,layers:[this._layer.id],shading:this._shading,defaultColor:this._meshColors.axis.xyz,hoverColor:this._meshColors.hover.xyz}),yz:new m0(this._device,{axis:Id,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),xz:new m0(this._device,{axis:Od,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),xy:new m0(this._device,{axis:Nd,layers:[this._layer.id],shading:this._shading,rotation:new H(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z}),x:new dM(this._device,{axis:Id,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),y:new dM(this._device,{axis:Od,layers:[this._layer.id],shading:this._shading,rotation:new H(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),z:new dM(this._device,{axis:Nd,layers:[this._layer.id],shading:this._shading,rotation:new H(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z})},this._coordSpace=I0,this._nodeScales=new Map,this._useUniformScaling=!1,this.snapIncrement=1,this.flipShapes=!0,this.lowerBoundScale=new H(-1/0,-1/0,-1/0),this._createTransform(),this.on(Ma.EVENT_TRANSFORMSTART,()=>{this._storeNodeScales()}),this.on(Ma.EVENT_TRANSFORMMOVE,s=>{const i=Ere.copy(s).sub(this._selectionStartPoint);this.snap&&(i.mulScalar(1/this.snapIncrement),i.round(),i.mulScalar(this.snapIncrement)),i.mulScalar(1/this._scale),this._setNodeScales(i.add(H.ONE))}),this.on(Ma.EVENT_NODESDETACH,()=>{this._nodeScales.clear()}),this._app.on("prerender",()=>{this._shapesLookAtCamera()})}set coordSpace(e){}get coordSpace(){return this._coordSpace}set uniform(e){this._useUniformScaling=e??!0}get uniform(){return this._useUniformScaling}set axisGap(e){this._setArrowProp("gap",e)}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e)}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e)}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e)}get axisLineTolerance(){return this._shapes.x.tolerance}set axisBoxSize(e){this._setArrowProp("boxSize",e)}get axisBoxSize(){return this._shapes.x.boxSize}set axisPlaneSize(e){this._setPlaneProp("size",e)}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e)}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.xyz.size=e}get axisCenterSize(){return this._shapes.xyz.size}set axisCenterTolerance(e){this._shapes.xyz.tolerance=e}get axisCenterTolerance(){return this._shapes.xyz.tolerance}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t}_shapesLookAtCamera(){const e=this.facing;let t=e.dot(this.root.right);this._shapes.x.entity.enabled=Math.abs(t)<Dg,this.flipShapes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=Math.abs(t)<Dg,this.flipShapes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=Math.abs(t)<Dg,this.flipShapes&&(this._shapes.z.flipped=t>0),xi.cross(e,this.root.right),this._shapes.yz.entity.enabled=xi.length()<Dg,this.flipShapes&&(this._shapes.yz.flipped=xc.set(0,+(xi.dot(this.root.forward)<0),+(xi.dot(this.root.up)<0))),xi.cross(e,this.root.forward),this._shapes.xy.entity.enabled=xi.length()<Dg,this.flipShapes&&(this._shapes.xy.flipped=xc.set(+(xi.dot(this.root.up)<0),+(xi.dot(this.root.right)>0),0)),xi.cross(e,this.root.up),this._shapes.xz.entity.enabled=xi.length()<Dg,this.flipShapes&&(this._shapes.xz.flipped=xc.set(+(xi.dot(this.root.forward)>0),0,+(xi.dot(this.root.right)>0)))}_storeNodeScales(){for(let e=0;e<this.nodes.length;e++){const t=this.nodes[e];this._nodeScales.set(t,t.getLocalScale().clone())}}_setNodeScales(e){for(let t=0;t<this.nodes.length;t++){const s=this.nodes[t],i=this._nodeScales.get(s);i&&s.setLocalScale(xi.copy(i).mul(e).max(this.lowerBoundScale))}}_screenToPoint(e,t){const s=this.root.getPosition(),i=this._camera.screenToWorld(e,t,1),a=this._selectedAxis,n=this._selectedIsPlane,r=this._useUniformScaling&&n||a===Tb,l=this._createRay(i),u=this._createPlane(a,r,!n),f=new H;if(u.intersectsRay(l,f),r){switch(a){case Id:xi.copy(this.root.up),xc.copy(this.root.forward).mulScalar(-1);break;case Od:xi.copy(this.root.right),xc.copy(this.root.forward).mulScalar(-1);break;case Nd:xi.copy(this.root.up),xc.copy(this.root.right);break;default:xi.copy(this._camera.entity.up),xc.copy(this._camera.entity.right);break}xc.add(xi).normalize(),xi.sub2(f,s);const g=xi.length()*xi.normalize().dot(xc);return f.set(g,g,g),a!==Tb&&(f[a]=1),f}return Are.copy(this._rootStartRot).invert().transformVector(f,f),n||this._projectToAxis(f,a),f}}const Tc=new H,Ec=new H,Ac=new H,rA=new Me,Nc=class Nc extends Qe{constructor(e){super(),this._size=0,this._anchor=new Ie(1,1,1,1),this._colorX=xA.clone(),this._colorY=TA.clone(),this._colorZ=EA.clone(),this._colorNeg=new xe(.3,.3,.3),this._radius=10,this._textSize=10,this._lineThickness=2,this._lineLength=40,this.dom=document.createElement("div"),this.dom.id="view-cube-container",this.dom.style.cssText=["position: absolute","margin: auto","pointer-events: none"].join(";"),document.body.appendChild(this.dom),this.anchor=e??this._anchor,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svg.id="view-cube-svg",this._group=document.createElementNS(this._svg.namespaceURI,"g"),this._svg.appendChild(this._group),this._resize();const t=this._colorX.toString(!1),s=this._colorY.toString(!1),i=this._colorZ.toString(!1);this._shapes={nx:this._circle(t),ny:this._circle(s),nz:this._circle(i),px:this._circle(t,!0,"X"),py:this._circle(s,!0,"Y"),pz:this._circle(i,!0,"Z"),xaxis:this._line(t),yaxis:this._line(s),zaxis:this._line(i)},this._shapes.px.children[0].addEventListener("pointerdown",()=>{this.fire(Nc.EVENT_CAMERAALIGN,H.RIGHT)}),this._shapes.py.children[0].addEventListener("pointerdown",()=>{this.fire(Nc.EVENT_CAMERAALIGN,H.UP)}),this._shapes.pz.children[0].addEventListener("pointerdown",()=>{this.fire(Nc.EVENT_CAMERAALIGN,H.BACK)}),this._shapes.nx.children[0].addEventListener("pointerdown",()=>{this.fire(Nc.EVENT_CAMERAALIGN,H.LEFT)}),this._shapes.ny.children[0].addEventListener("pointerdown",()=>{this.fire(Nc.EVENT_CAMERAALIGN,H.DOWN)}),this._shapes.nz.children[0].addEventListener("pointerdown",()=>{this.fire(Nc.EVENT_CAMERAALIGN,H.FORWARD)}),this.dom.appendChild(this._svg)}set anchor(e){this._anchor.copy(e),this.dom.style.top=this._anchor.x?"0px":"auto",this.dom.style.right=this._anchor.y?"0px":"auto",this.dom.style.bottom=this._anchor.z?"0px":"auto",this.dom.style.left=this._anchor.w?"0px":"auto"}get anchor(){return this._anchor}set colorX(e){this._colorX.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorX.toString(!1)),this._shapes.px.children[0].setAttribute("stroke",this._colorX.toString(!1)),this._shapes.nx.children[0].setAttribute("stroke",this._colorX.toString(!1)),this._shapes.xaxis.setAttribute("stroke",this._colorX.toString(!1))}get colorX(){return this._colorX}set colorY(e){this._colorY.copy(e),this._shapes.py.children[0].setAttribute("fill",this._colorY.toString(!1)),this._shapes.py.children[0].setAttribute("stroke",this._colorY.toString(!1)),this._shapes.ny.children[0].setAttribute("stroke",this._colorY.toString(!1)),this._shapes.yaxis.setAttribute("stroke",this._colorY.toString(!1))}get colorY(){return this._colorY}set colorZ(e){this._colorZ.copy(e),this._shapes.pz.children[0].setAttribute("fill",this._colorZ.toString(!1)),this._shapes.pz.children[0].setAttribute("stroke",this._colorZ.toString(!1)),this._shapes.nz.children[0].setAttribute("stroke",this._colorZ.toString(!1)),this._shapes.zaxis.setAttribute("stroke",this._colorZ.toString(!1))}get colorZ(){return this._colorZ}set colorNeg(e){this._colorNeg.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorNeg.toString(!1)),this._shapes.py.children[0].setAttribute("fill",this._colorNeg.toString(!1)),this._shapes.pz.children[0].setAttribute("fill",this._colorNeg.toString(!1))}get colorNeg(){return this._colorNeg}set radius(e){this._radius=e,this._shapes.px.children[0].setAttribute("r",`${e}`),this._shapes.py.children[0].setAttribute("r",`${e}`),this._shapes.pz.children[0].setAttribute("r",`${e}`),this._shapes.nx.children[0].setAttribute("r",`${e}`),this._shapes.ny.children[0].setAttribute("r",`${e}`),this._shapes.nz.children[0].setAttribute("r",`${e}`),this._resize()}get radius(){return this._radius}set textSize(e){this._textSize=e,this._shapes.px.children[1].setAttribute("font-size",`${e}`),this._shapes.py.children[1].setAttribute("font-size",`${e}`),this._shapes.pz.children[1].setAttribute("font-size",`${e}`)}get textSize(){return this._textSize}set lineThickness(e){this._lineThickness=e,this._shapes.xaxis.setAttribute("stroke-width",`${e}`),this._shapes.yaxis.setAttribute("stroke-width",`${e}`),this._shapes.zaxis.setAttribute("stroke-width",`${e}`),this._shapes.px.children[0].setAttribute("stroke-width",`${e}`),this._shapes.py.children[0].setAttribute("stroke-width",`${e}`),this._shapes.pz.children[0].setAttribute("stroke-width",`${e}`),this._shapes.nx.children[0].setAttribute("stroke-width",`${e}`),this._shapes.ny.children[0].setAttribute("stroke-width",`${e}`),this._shapes.nz.children[0].setAttribute("stroke-width",`${e}`),this._resize()}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e,this._resize()}get lineLength(){return this._lineLength}_resize(){this._size=2*(this.lineLength+this.radius+this.lineThickness),this.dom.style.width=`${this._size}px`,this.dom.style.height=`${this._size}px`,this._svg.setAttribute("width",`${this._size}`),this._svg.setAttribute("height",`${this._size}`),this._group.setAttribute("transform",`translate(${this._size*.5}, ${this._size*.5})`)}_transform(e,t,s){e.setAttribute("transform",`translate(${t*this._lineLength}, ${s*this._lineLength})`)}_x2y2(e,t,s){e.setAttribute("x2",`${t*this._lineLength}`),e.setAttribute("y2",`${s*this._lineLength}`)}_line(e){const t=document.createElementNS(this._svg.namespaceURI,"line");return t.setAttribute("stroke",e),t.setAttribute("stroke-width",`${this._lineThickness}`),this._group.appendChild(t),t}_circle(e,t=!1,s){const i=document.createElementNS(this._svg.namespaceURI,"g"),a=document.createElementNS(this._svg.namespaceURI,"circle");if(a.setAttribute("fill",t?e:this._colorNeg.toString(!1)),a.setAttribute("stroke",e),a.setAttribute("stroke-width",`${this._lineThickness}`),a.setAttribute("r",`${this._radius}`),a.setAttribute("cx","0"),a.setAttribute("cy","0"),a.setAttribute("pointer-events","all"),i.appendChild(a),s){const n=document.createElementNS(this._svg.namespaceURI,"text");n.setAttribute("font-size",`${this._textSize}`),n.setAttribute("font-family","Arial"),n.setAttribute("font-weight","bold"),n.setAttribute("text-anchor","middle"),n.setAttribute("alignment-baseline","central"),n.textContent=s,i.appendChild(n)}return i.setAttribute("cursor","pointer"),this._group.appendChild(i),i}update(e){if(!this._size)return;rA.invert(e),rA.getX(Tc),rA.getY(Ec),rA.getZ(Ac),this._transform(this._shapes.px,Tc.x,-Tc.y),this._transform(this._shapes.nx,-Tc.x,Tc.y),this._transform(this._shapes.py,Ec.x,-Ec.y),this._transform(this._shapes.ny,-Ec.x,Ec.y),this._transform(this._shapes.pz,Ac.x,-Ac.y),this._transform(this._shapes.nz,-Ac.x,Ac.y),this._x2y2(this._shapes.xaxis,Tc.x,-Tc.y),this._x2y2(this._shapes.yaxis,Ec.x,-Ec.y),this._x2y2(this._shapes.zaxis,Ac.x,-Ac.y);const t=[{n:["xaxis","px"],value:Tc.z},{n:["yaxis","py"],value:Ec.z},{n:["zaxis","pz"],value:Ac.z},{n:["nx"],value:-Tc.z},{n:["ny"],value:-Ec.z},{n:["nz"],value:-Ac.z}].sort((i,a)=>i.value-a.value),s=document.createDocumentFragment();t.forEach(i=>{i.n.forEach(a=>{s.appendChild(this._shapes[a])})}),this._group.appendChild(s)}destroy(){this.dom.remove(),this.off()}};Nc.EVENT_CAMERAALIGN="camera:align";let cD=Nc;const wre=Object.freeze(Object.defineProperty({__proto__:null,ABSOLUTE_URL:_m,ACTION_GAMEPAD:pA,ACTION_KEYBOARD:fA,ACTION_MOUSE:dA,ADDRESS_CLAMP_TO_EDGE:Oe,ADDRESS_MIRRORED_REPEAT:O0,ADDRESS_REPEAT:Zs,AMBIENTSRC_AMBIENTSH:LC,AMBIENTSRC_CONSTANT:OC,AMBIENTSRC_ENVALATLAS:IC,ANIM_BLEND_1D:Ez,ANIM_BLEND_2D_CARTESIAN:Cz,ANIM_BLEND_2D_DIRECTIONAL:Az,ANIM_BLEND_DIRECT:wz,ANIM_CONTROL_STATES:l1,ANIM_EQUAL_TO:xz,ANIM_GREATER_THAN:yz,ANIM_GREATER_THAN_EQUAL_TO:Sz,ANIM_INTERRUPTION_NEXT:mz,ANIM_INTERRUPTION_NEXT_PREV:gz,ANIM_INTERRUPTION_NONE:qP,ANIM_INTERRUPTION_PREV:pz,ANIM_INTERRUPTION_PREV_NEXT:_z,ANIM_LAYER_ADDITIVE:Rz,ANIM_LAYER_OVERWRITE:XP,ANIM_LESS_THAN:vz,ANIM_LESS_THAN_EQUAL_TO:bz,ANIM_NOT_EQUAL_TO:Tz,ANIM_PARAMETER_BOOLEAN:y3,ANIM_PARAMETER_FLOAT:g3,ANIM_PARAMETER_INTEGER:_3,ANIM_PARAMETER_TRIGGER:gb,ANIM_STATE_ANY:hd,ANIM_STATE_END:jA,ANIM_STATE_START:kg,ASPECT_AUTO:zC,ASPECT_MANUAL:FA,ASSET_ANIMATION:rJ,ASSET_AUDIO:oJ,ASSET_CONTAINER:SJ,ASSET_CSS:gJ,ASSET_CUBEMAP:mJ,ASSET_HTML:yJ,ASSET_IMAGE:lJ,ASSET_JSON:hJ,ASSET_MATERIAL:uJ,ASSET_MODEL:cJ,ASSET_SCRIPT:vJ,ASSET_SHADER:_J,ASSET_TEXT:dJ,ASSET_TEXTURE:fJ,ASSET_TEXTUREATLAS:pJ,AXIS_KEY:G7,AXIS_MOUSE_X:F7,AXIS_MOUSE_Y:B7,AXIS_PAD_L_X:U7,AXIS_PAD_L_Y:z7,AXIS_PAD_R_X:k7,AXIS_PAD_R_Y:V7,AnimBinder:zp,AnimClip:o1,AnimClipHandler:j8,AnimComponent:QP,AnimComponentLayer:Pz,AnimComponentSystem:Lz,AnimController:Dz,AnimCurve:oL,AnimData:v1,AnimEvaluator:jP,AnimEvents:YP,AnimSnapshot:m3,AnimStateGraph:vb,AnimStateGraphHandler:Y8,AnimTarget:YA,AnimTrack:wh,Animation:c3,AnimationComponent:KP,AnimationComponentSystem:Mz,AnimationHandler:X8,AppBase:fo,AppOptions:uz,Application:C6,Asset:Ye,AssetListLoader:Qie,AssetReference:P0,AssetRegistry:r1,AudioHandler:K8,AudioListenerComponent:$P,AudioListenerComponentSystem:Oz,BAKE_COLOR:xq,BAKE_COLORDIR:fb,BINDGROUP_MESH:Q0,BINDGROUP_MESH_UB:um,BINDGROUP_VIEW:Qb,BLENDEQUATION_ADD:Qa,BLENDEQUATION_MAX:vF,BLENDEQUATION_MIN:yF,BLENDEQUATION_REVERSE_SUBTRACT:gF,BLENDEQUATION_SUBTRACT:V9,BLENDMODE_CONSTANT:AD,BLENDMODE_CONSTANT_ALPHA:_ae,BLENDMODE_CONSTANT_COLOR:pae,BLENDMODE_DST_ALPHA:z9,BLENDMODE_DST_COLOR:ED,BLENDMODE_ONE:wi,BLENDMODE_ONE_MINUS_CONSTANT:CD,BLENDMODE_ONE_MINUS_CONSTANT_ALPHA:gae,BLENDMODE_ONE_MINUS_CONSTANT_COLOR:mae,BLENDMODE_ONE_MINUS_DST_ALPHA:k9,BLENDMODE_ONE_MINUS_DST_COLOR:_F,BLENDMODE_ONE_MINUS_SRC_ALPHA:F0,BLENDMODE_ONE_MINUS_SRC_COLOR:B9,BLENDMODE_SRC_ALPHA:N0,BLENDMODE_SRC_ALPHA_SATURATE:U9,BLENDMODE_SRC_COLOR:mF,BLENDMODE_ZERO:Y2,BLEND_ADDITIVE:yC,BLEND_ADDITIVEALPHA:SC,BLEND_MAX:EC,BLEND_MIN:TC,BLEND_MULTIPLICATIVE:vC,BLEND_MULTIPLICATIVE2X:bC,BLEND_NONE:Gn,BLEND_NORMAL:xr,BLEND_PREMULTIPLIED:Wd,BLEND_SCREEN:xC,BLEND_SUBTRACTIVE:gC,BLUR_BOX:eq,BLUR_GAUSSIAN:MC,BODYFLAG_KINEMATIC_OBJECT:JP,BODYFLAG_NORESPONSE_OBJECT:kp,BODYFLAG_STATIC_OBJECT:Uz,BODYGROUP_DEFAULT:YJ,BODYGROUP_DYNAMIC:Vz,BODYGROUP_ENGINE_1:KJ,BODYGROUP_ENGINE_2:QJ,BODYGROUP_ENGINE_3:$J,BODYGROUP_KINEMATIC:Gz,BODYGROUP_NONE:jJ,BODYGROUP_STATIC:E3,BODYGROUP_TRIGGER:A3,BODYGROUP_USER_1:ZJ,BODYGROUP_USER_2:JJ,BODYGROUP_USER_3:eee,BODYGROUP_USER_4:tee,BODYGROUP_USER_5:see,BODYGROUP_USER_6:iee,BODYGROUP_USER_7:aee,BODYGROUP_USER_8:nee,BODYMASK_ALL:C3,BODYMASK_NONE:ree,BODYMASK_NOT_STATIC:t2,BODYMASK_NOT_STATIC_KINEMATIC:lee,BODYMASK_STATIC:oee,BODYSTATE_ACTIVE_TAG:c1,BODYSTATE_DISABLE_DEACTIVATION:e2,BODYSTATE_DISABLE_SIMULATION:qC,BODYSTATE_ISLAND_SLEEPING:zz,BODYSTATE_WANTS_DEACTIVATION:kz,BODYTYPE_DYNAMIC:cr,BODYTYPE_KINEMATIC:cd,BODYTYPE_STATIC:Rp,BUFFERUSAGE_COPY_DST:RD,BUFFERUSAGE_COPY_SRC:H9,BUFFERUSAGE_INDEX:SF,BUFFERUSAGE_INDIRECT:W9,BUFFERUSAGE_READ:wD,BUFFERUSAGE_STORAGE:K2,BUFFERUSAGE_UNIFORM:xF,BUFFERUSAGE_VERTEX:bF,BUFFERUSAGE_WRITE:G9,BUFFER_DYNAMIC:Ob,BUFFER_GPUDYNAMIC:wA,BUFFER_STATIC:_r,BUFFER_STREAM:MD,BUTTON_TRANSITION_MODE_SPRITE_CHANGE:T3,BUTTON_TRANSITION_MODE_TINT:QA,Batch:i3,BatchGroup:zi,BatchManager:NU,BinaryHandler:Q8,BindGroupFormat:Nm,BindStorageBufferFormat:JD,BindStorageTextureFormat:nB,BindTextureFormat:Zb,BindUniformBufferFormat:nx,BlendState:ms,BoundingBox:wt,BoundingSphere:T1,BoxGeometry:Kd,Bundle:WA,BundleHandler:nz,BundleRegistry:iz,ButtonComponent:ZA,ButtonComponentSystem:Bz,CHUNKAPI_1_51:lV,CHUNKAPI_1_55:hV,CHUNKAPI_1_56:cV,CHUNKAPI_1_57:uV,CHUNKAPI_1_58:dV,CHUNKAPI_1_60:fV,CHUNKAPI_1_62:pV,CHUNKAPI_1_65:aB,CHUNKAPI_1_70:mV,CHUNKAPI_2_1:_V,CHUNKAPI_2_3:gV,CHUNKAPI_2_5:yV,CHUNKAPI_2_6:vV,CHUNKAPI_2_7:SV,CLEARFLAG_COLOR:Jp,CLEARFLAG_DEPTH:em,CLEARFLAG_STENCIL:_0,CUBEFACE_NEGX:X9,CUBEFACE_NEGY:Y9,CUBEFACE_NEGZ:Q9,CUBEFACE_POSX:q9,CUBEFACE_POSY:j9,CUBEFACE_POSZ:K9,CUBEPROJ_BOX:_P,CUBEPROJ_NONE:DC,CULLFACE_BACK:jc,CULLFACE_FRONT:e0,CULLFACE_FRONTANDBACK:TF,CULLFACE_NONE:Xs,CURVE_LINEAR:hF,CURVE_SMOOTHSTEP:X2,CURVE_SPLINE:zM,CURVE_STEP:cF,Camera:hy,CameraComponent:tu,CameraComponentSystem:L8,CameraFrame:jne,CameraFrameOptions:xL,CameraShaderParams:RP,CanvasFont:Zie,CapsuleGeometry:UP,ChunkUtils:mr,CollisionComponent:JA,CollisionComponentSystem:Wz,Color:xe,Component:xt,ComponentSystem:ei,ComponentSystemRegistry:az,Compute:_7,ConeGeometry:bx,ContactPoint:p8,ContactResult:m8,ContainerHandler:$8,ContainerResource:Vse,Controller:zW,CssHandler:Z8,CubemapHandler:J8,Curve:so,CurveSet:Ad,CylinderGeometry:uy,DETAILMODE_ADD:rq,DETAILMODE_MAX:cq,DETAILMODE_MIN:hq,DETAILMODE_MUL:t3,DETAILMODE_OVERLAY:lq,DETAILMODE_SCREEN:oq,DEVICETYPE_NULL:hb,DEVICETYPE_WEBGL2:lb,DEVICETYPE_WEBGPU:GD,DISPLAYFORMAT_HDR:tB,DISPLAYFORMAT_LDR:eB,DISPLAYFORMAT_LDR_SRGB:sb,DISTANCE_EXPONENTIAL:TD,DISTANCE_INVERSE:j2,DISTANCE_LINEAR:A1,DITHER_BAYER8:TU,DITHER_BLUENOISE:EU,DITHER_IGNNOISE:AU,DITHER_NONE:br,DefaultAnimBinder:zc,DepthState:$i,DomeGeometry:HU,ELEMENTTYPE_GROUP:Sb,ELEMENTTYPE_IMAGE:$A,ELEMENTTYPE_TEXT:ZP,EMITTERSHAPE_BOX:Jo,EMITTERSHAPE_SPHERE:nU,EVENT_GAMEPADCONNECTED:Vae,EVENT_GAMEPADDISCONNECTED:Gae,EVENT_KEYDOWN:Pae,EVENT_KEYUP:Lae,EVENT_MOUSEDOWN:Iae,EVENT_MOUSEMOVE:Oae,EVENT_MOUSEUP:Nae,EVENT_MOUSEWHEEL:Fae,EVENT_POSTCULL:LU,EVENT_POSTRENDER:RU,EVENT_POSTRENDER_LAYER:DU,EVENT_PRECULL:PU,EVENT_PRERENDER:wU,EVENT_PRERENDER_LAYER:MU,EVENT_SELECT:Hae,EVENT_SELECTEND:qae,EVENT_SELECTSTART:Wae,EVENT_TOUCHCANCEL:kae,EVENT_TOUCHEND:Uae,EVENT_TOUCHMOVE:zae,EVENT_TOUCHSTART:Bae,ElementComponent:d1,ElementComponentSystem:$z,ElementDragHelper:m1,ElementInput:p0,ElementInputEvent:KC,ElementMouseEvent:Og,ElementSelectEvent:Dc,ElementTouchEvent:Ng,Entity:Kt,EnvLighting:n0,EventHandle:oF,EventHandler:Qe,FILLMODE_FILL_WINDOW:kP,FILLMODE_KEEP_ASPECT:d3,FILLMODE_NONE:tJ,FILTER_LINEAR:Vt,FILTER_LINEAR_MIPMAP_LINEAR:lo,FILTER_LINEAR_MIPMAP_NEAREST:bm,FILTER_NEAREST:Je,FILTER_NEAREST_MIPMAP_LINEAR:Sm,FILTER_NEAREST_MIPMAP_NEAREST:vm,FITMODE_CONTAIN:Nz,FITMODE_COVER:Fz,FITMODE_STRETCH:bb,FITTING_BOTH:s8,FITTING_NONE:s2,FITTING_SHRINK:I3,FITTING_STRETCH:t8,FOG_EXP:WW,FOG_EXP2:qW,FOG_LINEAR:JB,FOG_NONE:Fm,FONT_BITMAP:jz,FONT_MSDF:u1,FRESNEL_NONE:eU,FRESNEL_SCHLICK:lx,FUNC_ALWAYS:Sh,FUNC_EQUAL:Fb,FUNC_GREATER:AF,FUNC_GREATEREQUAL:wF,FUNC_LESS:Nb,FUNC_LESSEQUAL:RA,FUNC_NEVER:EF,FUNC_NOTEQUAL:CF,FloatPacking:Xc,FogParams:XU,FolderHandler:e6,Font:X3,FontHandler:t6,ForwardRenderer:DP,Frustum:fF,GAMMA_NONE:Ch,GAMMA_SRGB:Gc,GIZMOAXIS_FACE:el,GIZMOAXIS_X:Id,GIZMOAXIS_XY:Qne,GIZMOAXIS_XYZ:Tb,GIZMOAXIS_XZ:Kne,GIZMOAXIS_Y:Od,GIZMOAXIS_YZ:Yne,GIZMOAXIS_Z:Nd,GIZMOSPACE_LOCAL:I0,GIZMOSPACE_WORLD:lD,GSplat:ZU,GSplatComponent:rL,GSplatComponentSystem:k8,GSplatData:Qd,GSplatHandler:s6,GSplatInstance:WC,GSplatResource:lL,GSplatSogsData:JU,GamePads:QM,Geometry:dl,Gizmo:_h,GltfExporter:ud,GraphNode:Jt,GraphicsDevice:_s,HierarchyHandler:i6,HtmlHandler:a6,Http:Wn,I18n:rz,INDEXFORMAT_UINT16:ho,INDEXFORMAT_UINT32:Th,INDEXFORMAT_UINT8:Bb,INTERPOLATION_CUBIC:XA,INTERPOLATION_LINEAR:qA,INTERPOLATION_STEP:WP,ImageElement:qz,IndexBuffer:Ah,IndexedList:lF,JointComponent:XC,JointComponentSystem:Zz,JsonHandler:n6,JsonStandardMaterialParser:r6,KEY_0:uH,KEY_1:dH,KEY_2:fH,KEY_3:pH,KEY_4:mH,KEY_5:_H,KEY_6:gH,KEY_7:yH,KEY_8:vH,KEY_9:SH,KEY_A:TH,KEY_ADD:lW,KEY_ALT:K7,KEY_B:EH,KEY_BACKSPACE:H7,KEY_BACK_SLASH:MW,KEY_C:AH,KEY_CAPS_LOCK:$7,KEY_CLOSE_BRACKET:DW,KEY_COMMA:AW,KEY_CONTEXT_MENU:QH,KEY_CONTROL:Y7,KEY_D:CH,KEY_DECIMAL:uW,KEY_DELETE:cH,KEY_DIVIDE:dW,KEY_DOWN:oH,KEY_E:wH,KEY_END:sH,KEY_ENTER:X7,KEY_EQUAL:xH,KEY_ESCAPE:Z7,KEY_F:RH,KEY_F1:fW,KEY_F10:xW,KEY_F11:TW,KEY_F12:EW,KEY_F2:pW,KEY_F3:mW,KEY_F4:_W,KEY_F5:gW,KEY_F6:yW,KEY_F7:vW,KEY_F8:SW,KEY_F9:bW,KEY_G:MH,KEY_H:DH,KEY_HOME:iH,KEY_I:PH,KEY_INSERT:hH,KEY_J:LH,KEY_K:IH,KEY_L:OH,KEY_LEFT:aH,KEY_M:NH,KEY_META:PW,KEY_MULTIPLY:oW,KEY_N:FH,KEY_NUMPAD_0:$H,KEY_NUMPAD_1:ZH,KEY_NUMPAD_2:JH,KEY_NUMPAD_3:eW,KEY_NUMPAD_4:tW,KEY_NUMPAD_5:sW,KEY_NUMPAD_6:iW,KEY_NUMPAD_7:aW,KEY_NUMPAD_8:nW,KEY_NUMPAD_9:rW,KEY_O:BH,KEY_OPEN_BRACKET:RW,KEY_P:UH,KEY_PAGE_DOWN:tH,KEY_PAGE_UP:eH,KEY_PAUSE:Q7,KEY_PERIOD:CW,KEY_PRINT_SCREEN:lH,KEY_Q:zH,KEY_R:kH,KEY_RETURN:q7,KEY_RIGHT:rH,KEY_S:VH,KEY_SEMICOLON:bH,KEY_SEPARATOR:hW,KEY_SHIFT:j7,KEY_SLASH:wW,KEY_SPACE:J7,KEY_SUBTRACT:cW,KEY_T:GH,KEY_TAB:W7,KEY_U:HH,KEY_UP:nH,KEY_V:WH,KEY_W:qH,KEY_WINDOWS:KH,KEY_X:XH,KEY_Y:jH,KEY_Z:YH,Kernel:dF,Key:l3,Keyboard:Jb,KeyboardEvent:YB,LAYERID_DEPTH:yn,LAYERID_IMMEDIATE:hx,LAYERID_SKYBOX:dm,LAYERID_UI:ty,LAYERID_WORLD:Ph,LAYER_GIZMO:XW,LAYER_HUD:sU,LAYER_WORLD:lP,LIGHTFALLOFF_INVERSESQUARED:dP,LIGHTFALLOFF_LINEAR:AC,LIGHTSHAPE_DISK:cP,LIGHTSHAPE_PUNCTUAL:ao,LIGHTSHAPE_RECT:hP,LIGHTSHAPE_SPHERE:uP,LIGHTTYPE_COUNT:YW,LIGHTTYPE_DIRECTIONAL:ft,LIGHTTYPE_OMNI:Ds,LIGHTTYPE_POINT:jW,LIGHTTYPE_SPOT:Ns,LIGHT_COLOR_DIVIDER:db,Layer:Fi,LayerComposition:UA,LayoutCalculator:a8,LayoutChildComponent:eL,LayoutChildComponentSystem:e8,LayoutGroupComponent:iL,LayoutGroupComponentSystem:r8,Light:R0,LightComponent:O8,LightComponentSystem:N8,LightingParams:PP,Lightmapper:fz,LitMaterial:LZ,LitOptions:Mae,LitShaderOptions:Sx,LocalizedAsset:Xz,MASK_AFFECT_DYNAMIC:uo,MASK_AFFECT_LIGHTMAPPED:Xd,MASK_BAKE:Pd,MOTION_FREE:Tp,MOTION_LIMITED:Ep,MOTION_LOCKED:Ap,MOUSEBUTTON_LEFT:LW,MOUSEBUTTON_MIDDLE:IW,MOUSEBUTTON_NONE:vB,MOUSEBUTTON_RIGHT:OW,Mat3:ol,Mat4:Me,Material:Jc,MaterialHandler:o6,Mesh:Ft,MeshInstance:ps,MiniStats:yL,Model:Lh,ModelComponent:jC,ModelComponentSystem:h8,ModelHandler:l6,Morph:VC,MorphInstance:jd,MorphTarget:yx,Mouse:Hd,MouseEvent:Td,Node:h3,NullGraphicsDevice:yB,ORIENTATION_HORIZONTAL:At,ORIENTATION_VERTICAL:Ms,OrientedBox:F9,OutlineRenderer:fne,PAD_1:SB,PAD_2:NW,PAD_3:FW,PAD_4:BW,PAD_DOWN:OB,PAD_FACE_1:bB,PAD_FACE_2:xB,PAD_FACE_3:TB,PAD_FACE_4:EB,PAD_LEFT:NB,PAD_L_SHOULDER_1:AB,PAD_L_SHOULDER_2:wB,PAD_L_STICK_BUTTON:PB,PAD_L_STICK_X:iP,PAD_L_STICK_Y:aP,PAD_RIGHT:FB,PAD_R_SHOULDER_1:CB,PAD_R_SHOULDER_2:RB,PAD_R_STICK_BUTTON:LB,PAD_R_STICK_X:nP,PAD_R_STICK_Y:rP,PAD_SELECT:MB,PAD_START:DB,PAD_UP:IB,PAD_VENDOR:BB,PARTICLEMODE_CPU:aq,PARTICLEMODE_GPU:mP,PARTICLEORIENTATION_EMITTER:nq,PARTICLEORIENTATION_SCREEN:t1,PARTICLEORIENTATION_WORLD:rU,PARTICLESORT_DISTANCE:tq,PARTICLESORT_NEWER_FIRST:sq,PARTICLESORT_NONE:IA,PARTICLESORT_OLDER_FIRST:iq,PIXELFORMAT_111110F:Yc,PIXELFORMAT_A8:Q2,PIXELFORMAT_ASTC_4x4:Z2,PIXELFORMAT_ASTC_4x4_SRGB:Hb,PIXELFORMAT_ATC_RGB:J2,PIXELFORMAT_ATC_RGBA:eC,PIXELFORMAT_BC6F:aC,PIXELFORMAT_BC6UF:nC,PIXELFORMAT_BC7:rC,PIXELFORMAT_BC7_SRGBA:Wb,PIXELFORMAT_BGRA8:D1,PIXELFORMAT_DEPTH:il,PIXELFORMAT_DEPTH16:Cd,PIXELFORMAT_DEPTHSTENCIL:Fd,PIXELFORMAT_DXT1:z0,PIXELFORMAT_DXT1_SRGB:Ub,PIXELFORMAT_DXT3:C1,PIXELFORMAT_DXT3_SRGBA:zb,PIXELFORMAT_DXT5:Em,PIXELFORMAT_DXT5_SRGBA:kb,PIXELFORMAT_ETC1:G0,PIXELFORMAT_ETC2_RGB:R1,PIXELFORMAT_ETC2_RGBA:M1,PIXELFORMAT_ETC2_SRGB:Vb,PIXELFORMAT_ETC2_SRGBA:Gb,PIXELFORMAT_L8:$2,PIXELFORMAT_L8_A8:rae,PIXELFORMAT_LA8:B0,PIXELFORMAT_PVRTC_2BPP_RGBA_1:Cm,PIXELFORMAT_PVRTC_2BPP_RGB_1:Am,PIXELFORMAT_PVRTC_4BPP_RGBA_1:W0,PIXELFORMAT_PVRTC_4BPP_RGB_1:H0,PIXELFORMAT_R16F:X0,PIXELFORMAT_R16I:L1,PIXELFORMAT_R16U:I1,PIXELFORMAT_R32F:gr,PIXELFORMAT_R32I:O1,PIXELFORMAT_R32U:Jd,PIXELFORMAT_R4_G4_B4_A4:hae,PIXELFORMAT_R5_G5_B5_A1:lae,PIXELFORMAT_R5_G6_B5:oae,PIXELFORMAT_R8:wm,PIXELFORMAT_R8I:P1,PIXELFORMAT_R8U:tC,PIXELFORMAT_R8_G8_B8:cae,PIXELFORMAT_R8_G8_B8_A8:uae,PIXELFORMAT_RG16F:H1,PIXELFORMAT_RG16I:F1,PIXELFORMAT_RG16U:B1,PIXELFORMAT_RG32I:U1,PIXELFORMAT_RG32U:z1,PIXELFORMAT_RG8:j0,PIXELFORMAT_RG8I:N1,PIXELFORMAT_RG8U:sC,PIXELFORMAT_RGB16F:k0,PIXELFORMAT_RGB32F:w1,PIXELFORMAT_RGB565:xm,PIXELFORMAT_RGB8:pl,PIXELFORMAT_RGBA16F:Js,PIXELFORMAT_RGBA16I:V1,PIXELFORMAT_RGBA16U:q0,PIXELFORMAT_RGBA32F:Ri,PIXELFORMAT_RGBA32I:G1,PIXELFORMAT_RGBA32U:kn,PIXELFORMAT_RGBA4:Tm,PIXELFORMAT_RGBA5551:U0,PIXELFORMAT_RGBA8:Lt,PIXELFORMAT_RGBA8I:k1,PIXELFORMAT_RGBA8U:iC,PIXELFORMAT_SBGRA8:W1,PIXELFORMAT_SRGB:dae,PIXELFORMAT_SRGB8:V0,PIXELFORMAT_SRGBA:fae,PIXELFORMAT_SRGBA8:ki,PRIMITIVE_LINELOOP:PD,PRIMITIVE_LINES:X1,PRIMITIVE_LINESTRIP:oC,PRIMITIVE_POINTS:Y0,PRIMITIVE_TRIANGLES:al,PRIMITIVE_TRIFAN:wd,PRIMITIVE_TRISTRIP:hl,PROJECTION_ORTHOGRAPHIC:nl,PROJECTION_PERSPECTIVE:Ya,ParticleEmitter:GU,ParticleSystemComponent:c8,ParticleSystemComponentSystem:u8,Picker:w6,Plane:E1,PlaneGeometry:xx,PostEffect:u3,PostEffectQueue:D8,ProgramLibrary:$U,QuadRender:C0,Quat:Ne,REFLECTIONSRC_CUBEMAP:a1,REFLECTIONSRC_ENVATLAS:s1,REFLECTIONSRC_ENVATLASHQ:i1,REFLECTIONSRC_NONE:Hc,REFLECTIONSRC_SPHEREMAP:SP,RENDERSTYLE_POINTS:ab,RENDERSTYLE_SOLID:a0,RENDERSTYLE_WIREFRAME:od,RESOLUTION_AUTO:VA,RESOLUTION_FIXED:ez,RIGIDBODY_ACTIVE_TAG:Zae,RIGIDBODY_CF_KINEMATIC_OBJECT:Qae,RIGIDBODY_CF_NORESPONSE_OBJECT:$ae,RIGIDBODY_CF_STATIC_OBJECT:Kae,RIGIDBODY_DISABLE_DEACTIVATION:tne,RIGIDBODY_DISABLE_SIMULATION:sne,RIGIDBODY_ISLAND_SLEEPING:Jae,RIGIDBODY_TYPE_DYNAMIC:jae,RIGIDBODY_TYPE_KINEMATIC:Yae,RIGIDBODY_TYPE_STATIC:Xae,RIGIDBODY_WANTS_DEACTIVATION:ene,Ray:ll,RaycastResult:N3,ReadStream:xD,RenderComponent:aL,RenderComponentSystem:d8,RenderHandler:V8,RenderPass:pa,RenderPassBloom:V6,RenderPassCameraFrame:j6,RenderPassColorGrab:wP,RenderPassCompose:G6,RenderPassDepthAwareBlur:oD,RenderPassDof:W6,RenderPassDownsample:ZC,RenderPassForward:mb,RenderPassPrepass:q6,RenderPassShaderQuad:fl,RenderPassSsao:X6,RenderPassTAA:H6,RenderPassUpsample:k6,RenderTarget:fs,ResourceHandler:Ps,ResourceLoader:Yp,RigidBodyComponent:Wc,RigidBodyComponentSystem:p1,RotateGizmo:xre,SAMPLETYPE_DEPTH:b0,SAMPLETYPE_FLOAT:Om,SAMPLETYPE_INT:Bd,SAMPLETYPE_UINT:sm,SAMPLETYPE_UNFILTERABLE_FLOAT:j1,SCALEMODE_BLEND:a2,SCALEMODE_NONE:Uc,SCROLLBAR_VISIBILITY_SHOW_ALWAYS:S8,SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED:b8,SCROLL_MODE_BOUNCE:B3,SCROLL_MODE_CLAMP:y8,SCROLL_MODE_INFINITE:v8,SEMANTIC_ATTR0:MA,SEMANTIC_ATTR1:DA,SEMANTIC_ATTR10:IF,SEMANTIC_ATTR11:OF,SEMANTIC_ATTR12:lC,SEMANTIC_ATTR13:K0,SEMANTIC_ATTR14:hC,SEMANTIC_ATTR15:tm,SEMANTIC_ATTR2:LD,SEMANTIC_ATTR3:ID,SEMANTIC_ATTR4:OD,SEMANTIC_ATTR5:DF,SEMANTIC_ATTR6:PF,SEMANTIC_ATTR7:LF,SEMANTIC_ATTR8:g0,SEMANTIC_ATTR9:y0,SEMANTIC_BLENDINDICES:gn,SEMANTIC_BLENDWEIGHT:co,SEMANTIC_COLOR:Qi,SEMANTIC_NORMAL:$a,SEMANTIC_POSITION:kt,SEMANTIC_TANGENT:po,SEMANTIC_TEXCOORD:VM,SEMANTIC_TEXCOORD0:Za,SEMANTIC_TEXCOORD1:Mh,SEMANTIC_TEXCOORD2:Rm,SEMANTIC_TEXCOORD3:Mm,SEMANTIC_TEXCOORD4:Dm,SEMANTIC_TEXCOORD5:Pm,SEMANTIC_TEXCOORD6:Lm,SEMANTIC_TEXCOORD7:Im,SHADERDEF_BATCH:NA,SHADERDEF_DIRLM:EP,SHADERDEF_INSTANCING:dx,SHADERDEF_LM:OA,SHADERDEF_LMAMBIENT:AP,SHADERDEF_MORPH_NORMAL:px,SHADERDEF_MORPH_POSITION:fx,SHADERDEF_MORPH_TEXTURE_BASED_INT:mx,SHADERDEF_NOSHADOW:NC,SHADERDEF_SCREENSPACE:FC,SHADERDEF_SKIN:ux,SHADERDEF_TANGENTS:BC,SHADERDEF_UV0:bP,SHADERDEF_UV1:xP,SHADERDEF_VCOLOR:TP,SHADERLANGUAGE_GLSL:Sr,SHADERLANGUAGE_WGSL:Ja,SHADERPASS_ALBEDO:dq,SHADERPASS_AO:yq,SHADERPASS_EMISSION:vq,SHADERPASS_FORWARD:uq,SHADERPASS_GLOSS:_q,SHADERPASS_LIGHTING:Sq,SHADERPASS_METALNESS:gq,SHADERPASS_OPACITY:pq,SHADERPASS_SPECULARITY:mq,SHADERPASS_UV0:bq,SHADERPASS_WORLDNORMAL:fq,SHADERSTAGE_COMPUTE:HD,SHADERSTAGE_FRAGMENT:Gd,SHADERSTAGE_VERTEX:Vd,SHADERTAG_MATERIAL:ND,SHADER_DEPTH:_x,SHADER_FORWARD:tf,SHADER_PICK:ry,SHADER_PREPASS:ny,SHADER_SHADOW:CP,SHADOWUPDATE_NONE:no,SHADOWUPDATE_REALTIME:UC,SHADOWUPDATE_THISFRAME:qd,SHADOW_PCF1:JW,SHADOW_PCF1_16F:wC,SHADOW_PCF1_32F:CC,SHADOW_PCF3:KW,SHADOW_PCF3_16F:RC,SHADOW_PCF3_32F:Un,SHADOW_PCF5:ZW,SHADOW_PCF5_16F:pP,SHADOW_PCF5_32F:fP,SHADOW_PCSS_32F:fm,SHADOW_VSM16:QW,SHADOW_VSM32:$W,SHADOW_VSM_16F:e1,SHADOW_VSM_32F:cx,SKYTYPE_BOX:bU,SKYTYPE_DOME:xU,SKYTYPE_INFINITE:pb,SORTMODE_BACK2FRONT:s3,SORTMODE_CUSTOM:SU,SORTMODE_FRONT2BACK:vU,SORTMODE_MANUAL:gU,SORTMODE_MATERIALMESH:yU,SORTMODE_NONE:jp,SPECOCC_AO:ay,SPECOCC_GLOSSDEPENDENT:vP,SPECOCC_NONE:yP,SPRITETYPE_ANIMATED:z3,SPRITETYPE_SIMPLE:U3,SPRITE_RENDERMODE_SIMPLE:tl,SPRITE_RENDERMODE_SLICED:Bi,SPRITE_RENDERMODE_TILED:Ui,SSAOTYPE_COMBINE:z6,SSAOTYPE_LIGHTING:U6,SSAOTYPE_NONE:$p,STENCILOP_DECREMENT:BF,STENCILOP_DECREMENTWRAP:J9,STENCILOP_INCREMENT:FF,STENCILOP_INCREMENTWRAP:Z9,STENCILOP_INVERT:eV,STENCILOP_KEEP:Gp,STENCILOP_REPLACE:NF,STENCILOP_ZERO:$9,ScaleGizmo:Cre,Scene:vn,SceneHandler:h6,SceneRegistry:cz,SceneRegistryItem:p3,SceneSettingsHandler:sae,ScopeId:oB,ScopeSpace:lB,ScreenComponent:nL,ScreenComponentSystem:g8,Script:Rh,ScriptAttributes:gm,ScriptComponent:o2,ScriptComponentSystem:z8,ScriptHandler:d6,ScriptRegistry:oz,ScriptType:Ld,ScrollViewComponent:n2,ScrollViewComponentSystem:x8,ScrollbarComponent:r2,ScrollbarComponentSystem:T8,Shader:ef,ShaderHandler:f6,ShaderMaterial:Yd,ShaderPass:cl,SingleContactResult:f8,Skeleton:gA,Skin:OP,SkinBatchInstance:a3,SkinInstance:oy,Sky:WU,SortedLoopArray:Lb,Sound:ZB,SoundComponent:_1,SoundComponentSystem:A8,SoundInstance:vh,SoundInstance3d:wp,SoundManager:$B,SoundSlot:h0,SphereGeometry:cy,Sprite:jU,SpriteAnimationClip:c0,SpriteComponent:g1,SpriteComponentSystem:w8,SpriteHandler:p6,StandardMaterial:Vi,StandardMaterialOptions:mm,StencilParameters:pr,StorageBuffer:b7,TEXHINT_ASSET:iV,TEXHINT_LIGHTMAP:aV,TEXHINT_NONE:tV,TEXHINT_SHADOWMAP:sV,TEXPROPERTY_ADDRESS_U:XD,TEXPROPERTY_ADDRESS_V:jD,TEXPROPERTY_ADDRESS_W:YD,TEXPROPERTY_ALL:sB,TEXPROPERTY_ANISOTROPY:$D,TEXPROPERTY_COMPARE_FUNC:QD,TEXPROPERTY_COMPARE_ON_READ:KD,TEXPROPERTY_MAG_FILTER:qD,TEXPROPERTY_MIN_FILTER:WD,TEXTUREDIMENSION_1D:BD,TEXTUREDIMENSION_2D:bh,TEXTUREDIMENSION_2D_ARRAY:bd,TEXTUREDIMENSION_3D:Hp,TEXTUREDIMENSION_CUBE:xd,TEXTUREDIMENSION_CUBE_ARRAY:UD,TEXTURELOCK_NONE:uA,TEXTURELOCK_READ:FD,TEXTURELOCK_WRITE:GM,TEXTUREPROJECTION_CUBE:PA,TEXTUREPROJECTION_EQUIRECT:HM,TEXTUREPROJECTION_NONE:UF,TEXTUREPROJECTION_OCTAHEDRAL:zF,TEXTURETYPE_DEFAULT:vr,TEXTURETYPE_RGBE:jb,TEXTURETYPE_RGBM:Eh,TEXTURETYPE_RGBP:v0,TEXTURETYPE_SWIZZLEGGGR:S0,TONEMAP_ACES:cU,TONEMAP_ACES2:uU,TONEMAP_FILMIC:lU,TONEMAP_HEJL:hU,TONEMAP_LINEAR:sy,TONEMAP_NEUTRAL:dU,TONEMAP_NONE:iy,TRACEID_BINDGROUPFORMAT_ALLOC:l9,TRACEID_BINDGROUP_ALLOC:o9,TRACEID_COMPUTEPIPELINE_ALLOC:c9,TRACEID_ELEMENT:d9,TRACEID_GPU_TIMINGS:tF,TRACEID_PIPELINELAYOUT_ALLOC:u9,TRACEID_RENDERPIPELINE_ALLOC:h9,TRACEID_RENDER_ACTION:Zk,TRACEID_RENDER_FRAME:Yk,TRACEID_RENDER_FRAME_TIME:Kk,TRACEID_RENDER_PASS:Qk,TRACEID_RENDER_PASS_DETAIL:$k,TRACEID_RENDER_QUEUE:p9,TRACEID_RENDER_TARGET_ALLOC:Jk,TRACEID_SHADER_ALLOC:t9,TRACEID_SHADER_COMPILE:s9,TRACEID_TEXTURES:f9,TRACEID_TEXTURE_ALLOC:e9,TRACEID_VRAM_IB:n9,TRACEID_VRAM_SB:r9,TRACEID_VRAM_TEXTURE:i9,TRACEID_VRAM_VB:a9,TYPE_FLOAT16:Y1,TYPE_FLOAT32:it,TYPE_INT16:_l,TYPE_INT32:jt,TYPE_INT8:ml,TYPE_UINT16:Dh,TYPE_UINT32:Ai,TYPE_UINT8:io,Tags:Ib,Template:K3,TemplateHandler:m6,TextElement:Qz,TextHandler:_6,Texture:Ge,TextureAtlas:YU,TextureAtlasHandler:g6,TextureHandler:v6,TextureUtils:fr,TorusGeometry:D0,Touch:$M,TouchDevice:ZM,TouchEvent:ib,Tracing:CA,TransformFeedback:x7,TransformGizmo:Ma,TranslateGizmo:gre,Tri:pF,UNIFORMTYPE_BOOL:Wp,UNIFORMTYPE_BOOLARRAY:J1,UNIFORMTYPE_BVEC2:x0,UNIFORMTYPE_BVEC2ARRAY:tx,UNIFORMTYPE_BVEC3:T0,UNIFORMTYPE_BVEC3ARRAY:ix,UNIFORMTYPE_BVEC4:E0,UNIFORMTYPE_BVEC4ARRAY:dC,UNIFORMTYPE_FLOAT:Vn,UNIFORMTYPE_FLOATARRAY:K1,UNIFORMTYPE_INT:Ud,UNIFORMTYPE_INTARRAY:lm,UNIFORMTYPE_ITEXTURE2D:XF,UNIFORMTYPE_ITEXTURE2D_ARRAY:ZF,UNIFORMTYPE_ITEXTURE3D:QF,UNIFORMTYPE_ITEXTURECUBE:YF,UNIFORMTYPE_IVEC2:Rd,UNIFORMTYPE_IVEC2ARRAY:hm,UNIFORMTYPE_IVEC3:Md,UNIFORMTYPE_IVEC3ARRAY:cm,UNIFORMTYPE_IVEC4:Dd,UNIFORMTYPE_IVEC4ARRAY:Kb,UNIFORMTYPE_MAT2:Yb,UNIFORMTYPE_MAT3:A0,UNIFORMTYPE_MAT4:im,UNIFORMTYPE_MAT4ARRAY:zD,UNIFORMTYPE_TEXTURE2D:kF,UNIFORMTYPE_TEXTURE2D_ARRAY:qF,UNIFORMTYPE_TEXTURE2D_SHADOW:GF,UNIFORMTYPE_TEXTURE3D:WF,UNIFORMTYPE_TEXTURECUBE:VF,UNIFORMTYPE_TEXTURECUBE_SHADOW:HF,UNIFORMTYPE_UINT:am,UNIFORMTYPE_UINTARRAY:Z1,UNIFORMTYPE_UTEXTURE2D:jF,UNIFORMTYPE_UTEXTURE2D_ARRAY:JF,UNIFORMTYPE_UTEXTURE3D:$F,UNIFORMTYPE_UTEXTURECUBE:KF,UNIFORMTYPE_UVEC2:nm,UNIFORMTYPE_UVEC2ARRAY:ex,UNIFORMTYPE_UVEC3:rm,UNIFORMTYPE_UVEC3ARRAY:sx,UNIFORMTYPE_UVEC4:om,UNIFORMTYPE_UVEC4ARRAY:uC,UNIFORMTYPE_VEC2:zd,UNIFORMTYPE_VEC2ARRAY:Q1,UNIFORMTYPE_VEC3:Fn,UNIFORMTYPE_VEC3ARRAY:$1,UNIFORMTYPE_VEC4:kd,UNIFORMTYPE_VEC4ARRAY:cC,UNIFORM_BUFFER_DEFAULT_SLOT_NAME:ax,UNUSED_UNIFORM_NAME:fC,URI:cA,UniformBufferFormat:ey,UniformFormat:ri,UsdzExporter:Nne,VIEW_CENTER:nb,VIEW_LEFT:Tq,VIEW_RIGHT:Eq,Vec2:Ee,Vec3:H,Vec4:Ie,VertexBuffer:jn,VertexFormat:en,VertexIterator:i0,ViewCube:cD,WasmModule:Pb,WebglGraphicsDevice:sP,WebgpuGraphicsDevice:_B,WorldClusters:BA,XRDEPTHSENSINGFORMAT_F32:gL,XRDEPTHSENSINGFORMAT_L8A8:mL,XRDEPTHSENSINGFORMAT_R16U:_L,XRDEPTHSENSINGUSAGE_CPU:x6,XRDEPTHSENSINGUSAGE_GPU:pL,XREYE_LEFT:Vie,XREYE_NONE:kie,XREYE_RIGHT:Gie,XRHAND_LEFT:b6,XRHAND_NONE:Hie,XRHAND_RIGHT:Wie,XRPAD_A:XB,XRPAD_B:jB,XRPAD_SQUEEZE:WB,XRPAD_STICK_BUTTON:qB,XRPAD_STICK_X:kB,XRPAD_STICK_Y:VB,XRPAD_TOUCHPAD_BUTTON:GB,XRPAD_TOUCHPAD_X:UB,XRPAD_TOUCHPAD_Y:zB,XRPAD_TRIGGER:HB,XRSPACE_BOUNDEDFLOOR:Nie,XRSPACE_LOCAL:Iie,XRSPACE_LOCALFLOOR:Oie,XRSPACE_UNBOUNDED:Fie,XRSPACE_VIEWER:Z3,XRTARGETRAY_GAZE:Bie,XRTARGETRAY_POINTER:zie,XRTARGETRAY_SCREEN:Uie,XRTRACKABLE_MESH:jie,XRTRACKABLE_PLANE:Xie,XRTRACKABLE_POINT:qie,XRTYPE_AR:f0,XRTYPE_INLINE:S6,XRTYPE_VR:fL,XrAnchor:b2,XrAnchors:x2,XrDomOverlay:T6,XrFinger:E6,XrHand:_2,XrHitTest:f2,XrHitTestSource:d2,XrImageTracking:m2,XrInput:g2,XrInputSource:ym,XrJoint:J3,XrLightEstimation:y2,XrManager:A2,XrMeshDetection:T2,XrPlane:v2,XrPlaneDetection:S2,XrTrackedImage:p2,XrView:E2,XrViews:b1,ZoneComponent:y1,ZoneComponentSystem:M8,ambientSrcNames:mU,get app(){return HP},basisInitialize:dL,bindGroupNames:ZD,blendNames:oP,calculateNormals:LP,calculateTangents:eu,createBox:bae,createCapsule:Tae,createCone:Eae,createCylinder:Aae,createGraphicsDevice:p7,createMesh:Cae,createPlane:Sae,createScript:c6,createShader:gK,createShaderFromCode:Da,createSphere:vae,createTorus:xae,createURI:P9,cubemaProjectionNames:oU,ditherNames:CU,dracoInitialize:Vte,drawFullscreenQuad:wae,drawQuadWithShader:qn,extend:Db,fresnelNames:tU,gammaNames:gP,getPixelFormatArrayType:DD,getReservedScriptNames:cie,getTouchTargetCoords:ub,guid:iF,http:Us,isCompressedPixelFormat:qb,isIntegerPixelFormat:kc,isSrgbPixelFormat:Xb,lightFalloffNames:aU,lightShapeNames:iU,lightTypeNames:e3,math:ge,now:oo,path:bt,pixelFormatGammaToLinear:RF,pixelFormatInfo:yr,pixelFormatLinearToGamma:q1,platform:Ct,reflectionSrcNames:pU,registerScript:d0,reprojectTexture:oh,requiresManualGamma:MF,revision:sF,script:VP,semanticToLocation:Bt,shaderChunks:dt,shaderChunksLightmapper:o0,shadowTypeInfo:xh,specularOcclusionNames:fU,spriteRenderModeNames:_U,string:Ed,tonemapNames:PC,typedArrayIndexFormats:$b,typedArrayIndexFormatsByteSize:iB,typedArrayToType:oV,typedArrayTypes:qp,typedArrayTypesByteSize:t0,uniformTypeToName:WM,uniformTypeToNameMapWGSL:VD,uniformTypeToNameWGSL:kD,uniformTypeToStorage:nV,version:bD,vertexTypesNames:rV},Symbol.toStringTag,{value:"Module"}));class zm extends HTMLElement{constructor(){super(),this._readyPromise=new Promise(e=>{this._readyResolve=e})}get closestApp(){var e;return(e=this.parentElement)===null||e===void 0?void 0:e.closest("pc-app")}get closestEntity(){var e;return(e=this.parentElement)===null||e===void 0?void 0:e.closest("pc-entity")}_onReady(){this._readyResolve(),this.dispatchEvent(new CustomEvent("ready"))}ready(){return this._readyPromise.then(()=>this)}}class Rre extends HTMLElement{constructor(){super(),this.loadPromise=this.loadModule()}async loadModule(){const e=this.getAttribute("name"),t=this.getAttribute("glue"),s=this.getAttribute("wasm"),i=this.getAttribute("fallback"),a={glueUrl:t,wasmUrl:s,fallbackUrl:i};e==="Basis"?dL(a):(Pb.setConfig(e,a),await new Promise(n=>{Pb.getInstance(e,()=>n())}))}getLoadPromise(){return this.loadPromise}}customElements.define("pc-module",Rre);class Mre extends zm{constructor(){super(),this._canvas=null,this._alpha=!0,this._antialias=!0,this._depth=!0,this._stencil=!0,this._highResolution=!0,this._hierarchyReady=!1,this._picker=null,this._hasPointerListeners={pointerenter:!1,pointerleave:!1,pointerdown:!1,pointerup:!1,pointermove:!1},this._hoveredEntity=null,this._pointerHandlers={pointermove:null,pointerdown:null,pointerup:null},this.app=null,this._onWindowResize=this._onWindowResize.bind(this)}async connectedCallback(){const e=this.querySelectorAll(":scope > pc-module");await Promise.all(Array.from(e).map(a=>a.getLoadPromise())),this._canvas=document.createElement("canvas"),this.appendChild(this._canvas),this.app=new C6(this._canvas,{graphicsDeviceOptions:{alpha:this._alpha,antialias:this._antialias,depth:this._depth,stencil:this._stencil},keyboard:new Jb(window),mouse:new Hd(this._canvas)}),this.app.graphicsDevice.maxPixelRatio=this._highResolution?window.devicePixelRatio:1,this.app.setCanvasFillMode(kP),this.app.setCanvasResolution(VA),this._pickerCreate();const t=this.querySelectorAll(":scope > pc-asset");Array.from(t).forEach(a=>{a.createAsset();const n=a.asset;n&&this.app.assets.add(n)});const s=this.querySelectorAll(":scope > pc-material");Array.from(s).forEach(a=>{a.createMaterial()});const i=this.querySelectorAll("pc-entity");Array.from(i).forEach(a=>{a.createEntity(this.app)}),i.forEach(a=>{a.buildHierarchy(this.app)}),this._hierarchyReady=!0,this.app.preload(()=>{this.app.start(),window.addEventListener("resize",this._onWindowResize),this._onReady()})}disconnectedCallback(){this._pickerDestroy(),this.app&&(this.app.destroy(),this.app=null),window.removeEventListener("resize",this._onWindowResize),this._canvas&&this.contains(this._canvas)&&(this.removeChild(this._canvas),this._canvas=null)}_onWindowResize(){this.app&&this.app.resizeCanvas()}_pickerCreate(){const{width:e,height:t}=this.app.graphicsDevice;this._picker=new w6(this.app,e,t),this._pointerHandlers.pointermove=this._onPointerMove.bind(this),this._pointerHandlers.pointerdown=this._onPointerDown.bind(this),this._pointerHandlers.pointerup=this._onPointerUp.bind(this),["pointermove","pointerdown","pointerup","pointerenter","pointerleave"].forEach(s=>{this.addEventListener(`${s}:connect`,()=>this._onPointerListenerAdded(s)),this.addEventListener(`${s}:disconnect`,()=>this._onPointerListenerRemoved(s))})}_pickerDestroy(){this._canvas&&Object.entries(this._pointerHandlers).forEach(([e,t])=>{t&&this._canvas.removeEventListener(e,t)}),this._picker=null,this._pointerHandlers={pointermove:null,pointerdown:null,pointerup:null}}_getPickerCoordinates(e){const t=this._canvas.getBoundingClientRect(),s=this._canvas.width/t.width,i=this._canvas.height/t.height,a=(e.clientX-t.left)*s,n=(e.clientY-t.top)*i;return{x:a,y:n}}_onPointerMove(e){if(!this._picker||!this.app)return;const t=this.app.root.findComponent("camera");if(!t)return;const{x:s,y:i}=this._getPickerCoordinates(e);this._picker.prepare(t,this.app.scene);const a=this._picker.getSelection(s,i);let n=null;if(a.length>0){let r=a[0].node;for(;r!==null;){const l=this.querySelector(`pc-entity[name="${r.name}"]`);if(l){n=l;break}r=r.parent}}this._hoveredEntity!==n&&(this._hoveredEntity&&this._hoveredEntity.hasListeners("pointerleave")&&this._hoveredEntity.dispatchEvent(new PointerEvent("pointerleave",e)),n&&n.hasListeners("pointerenter")&&n.dispatchEvent(new PointerEvent("pointerenter",e))),this._hoveredEntity=n,n&&n.hasListeners("pointermove")&&n.dispatchEvent(new PointerEvent("pointermove",e))}_onPointerDown(e){if(!this._picker||!this.app)return;const t=this.app.root.findComponent("camera");if(!t)return;const{x:s,y:i}=this._getPickerCoordinates(e);this._picker.prepare(t,this.app.scene);const a=this._picker.getSelection(s,i);if(a.length>0){let n=a[0].node;for(;n!==null;){const r=this.querySelector(`pc-entity[name="${n.name}"]`);if(r&&r.hasListeners("pointerdown")){r.dispatchEvent(new PointerEvent("pointerdown",e));break}n=n.parent}}}_onPointerUp(e){if(!this._picker||!this.app)return;const t=this.app.root.findComponent("camera");if(!t)return;const{x:s,y:i}=this._getPickerCoordinates(e);this._picker.prepare(t,this.app.scene);const a=this._picker.getSelection(s,i);if(a.length>0){const n=this.querySelector(`pc-entity[name="${a[0].node.name}"]`);n&&n.hasListeners("pointerup")&&n.dispatchEvent(new PointerEvent("pointerup",e))}}_onPointerListenerAdded(e){if(!this._hasPointerListeners[e]&&this._canvas){this._hasPointerListeners[e]=!0;const t=e==="pointerenter"||e==="pointerleave"?this._pointerHandlers.pointermove:this._pointerHandlers[e];t&&this._canvas.addEventListener(e==="pointerenter"||e==="pointerleave"?"pointermove":e,t)}}_onPointerListenerRemoved(e){if(!Array.from(this.querySelectorAll("pc-entity")).some(s=>s.hasListeners(e))&&this._canvas){this._hasPointerListeners[e]=!1;const s=e==="pointerenter"||e==="pointerleave"?this._pointerHandlers.pointermove:this._pointerHandlers[e];s&&this._canvas.removeEventListener(e==="pointerenter"||e==="pointerleave"?"pointermove":e,s)}}set alpha(e){this._alpha=e}get alpha(){return this._alpha}set antialias(e){this._antialias=e}get antialias(){return this._antialias}set depth(e){this._depth=e}get depth(){return this._depth}get hierarchyReady(){return this._hierarchyReady}set highResolution(e){this._highResolution=e,this.app&&(this.app.graphicsDevice.maxPixelRatio=e?window.devicePixelRatio:1)}get highResolution(){return this._highResolution}set stencil(e){this._stencil=e}get stencil(){return this._stencil}static get observedAttributes(){return["alpha","antialias","depth","stencil","high-resolution"]}attributeChangedCallback(e,t,s){switch(e){case"alpha":this.alpha=s!=="false";break;case"antialias":this.antialias=s!=="false";break;case"depth":this.depth=s!=="false";break;case"high-resolution":this.highResolution=s!=="false";break;case"stencil":this.stencil=s!=="false";break}}}customElements.define("pc-app",Mre);const Dre={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},Cx=h=>{const e=Dre[h.toLowerCase()];if(e)return new xe().fromString(e);if(h.startsWith("#"))return new xe().fromString(h);const t=h.split(" ").map(Number);return new xe(t)},Pre=h=>{const[e,t,s]=h.split(" ").map(Number),i=new Ne;return i.setFromEulerAngles(e,t,s),i},uD=h=>{const e=h.split(" ").map(Number);return new Ee(e)},zn=h=>{const e=h.split(" ").map(Number);return new H(e)},dD=h=>{const e=h.split(" ").map(Number);return new Ie(e)};class Lre extends zm{constructor(){super(...arguments),this._enabled=!0,this._name="Untitled",this._position=new H,this._rotation=new H,this._scale=new H(1,1,1),this._tags=[],this._listeners={},this.entity=null}createEntity(e){this.entity=new Kt(this.getAttribute("name")||this._name,e);const t=this.getAttribute("enabled");t&&(this.entity.enabled=t!=="false");const s=this.getAttribute("position");s&&this.entity.setLocalPosition(zn(s));const i=this.getAttribute("rotation");i&&this.entity.setLocalEulerAngles(zn(i));const a=this.getAttribute("scale");a&&this.entity.setLocalScale(zn(a));const n=this.getAttribute("tags");n&&this.entity.tags.add(n.split(",").map(l=>l.trim())),["onpointerenter","onpointerleave","onpointerdown","onpointerup","onpointermove"].forEach(l=>{const u=this.getAttribute(l);if(u){const f=l.substring(2),_=g=>{try{new Function("event",u).call(this,g)}catch(y){console.error("Error in event handler:",y)}};this.addEventListener(f,_)}})}buildHierarchy(e){if(!this.entity)return;const t=this.closestEntity;t!=null&&t.entity?t.entity.addChild(this.entity):e.root.addChild(this.entity),this._onReady()}connectedCallback(){const e=this.closestApp;if(e&&e.hierarchyReady){const t=e.app;this.createEntity(t),this.buildHierarchy(t);const s=this.querySelectorAll("pc-entity");s.forEach(i=>{i.createEntity(t)}),s.forEach(i=>{i.buildHierarchy(t)})}}disconnectedCallback(){this.entity&&(this.querySelectorAll("pc-entity").forEach(t=>{t.entity=null}),this.entity.destroy(),this.entity=null)}set enabled(e){this._enabled=e,this.entity&&(this.entity.enabled=e)}get enabled(){return this._enabled}set name(e){this._name=e,this.entity&&(this.entity.name=e)}get name(){return this._name}set position(e){this._position=e,this.entity&&this.entity.setLocalPosition(this._position)}get position(){return this._position}set rotation(e){this._rotation=e,this.entity&&this.entity.setLocalEulerAngles(this._rotation)}get rotation(){return this._rotation}set scale(e){this._scale=e,this.entity&&this.entity.setLocalScale(this._scale)}get scale(){return this._scale}set tags(e){this._tags=e,this.entity&&(this.entity.tags.clear(),this.entity.tags.add(this._tags))}get tags(){return this._tags}static get observedAttributes(){return["enabled","name","position","rotation","scale","tags","onpointerenter","onpointerleave","onpointerdown","onpointerup","onpointermove"]}attributeChangedCallback(e,t,s){switch(e){case"enabled":this.enabled=s!=="false";break;case"name":this.name=s;break;case"position":this.position=zn(s);break;case"rotation":this.rotation=zn(s);break;case"scale":this.scale=zn(s);break;case"tags":this.tags=s.split(",").map(i=>i.trim());break;case"onpointerenter":case"onpointerleave":case"onpointerdown":case"onpointerup":case"onpointermove":if(s){const i=e.substring(2),a=n=>{try{const r=this.getAttribute(i)||"";new Function("event",r).call(this,n)}catch(r){console.error("Error in event handler:",r)}};this.addEventListener(i,a)}break}}addEventListener(e,t,s){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t),super.addEventListener(e,t,s),e.startsWith("pointer")&&this.dispatchEvent(new CustomEvent(`${e}:connect`,{bubbles:!0}))}removeEventListener(e,t,s){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(i=>i!==t)),super.removeEventListener(e,t,s),e.startsWith("pointer")&&this.dispatchEvent(new CustomEvent(`${e}:disconnect`,{bubbles:!0}))}hasListeners(e){var t;return!!(!((t=this._listeners[e])===null||t===void 0)&&t.length)}}customElements.define("pc-entity",Lre);var AN=function(){var h="b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",e="b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),s=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if(typeof WebAssembly!="object")return{supported:!1};var i=WebAssembly.validate(t)?e:h,a,n=WebAssembly.instantiate(r(i),{}).then(function(M){a=M.instance,a.exports.__wasm_call_ctors()});function r(M){for(var w=new Uint8Array(M.length),T=0;T<M.length;++T){var R=M.charCodeAt(T);w[T]=R>96?R-97:R>64?R-39:R+4}for(var D=0,T=0;T<M.length;++T)w[D++]=w[T]<60?s[w[T]]:(w[T]-60)*64+w[++T];return w.buffer.slice(0,D)}function l(M,w,T,R,D,I){var U=a.exports.sbrk,O=T+3&-4,N=U(O*R),z=U(D.length),X=new Uint8Array(a.exports.memory.buffer);X.set(D,z);var Y=M(N,T,R,z,D.length);if(Y==0&&I&&I(N,O,R),w.set(X.subarray(N,N+T*R)),U(N-U(0)),Y!=0)throw new Error("Malformed buffer data: "+Y)}var u={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},f={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},_=[],g=0;function y(M){var w={object:new Worker(M),pending:0,requests:{}};return w.object.onmessage=function(T){var R=T.data;w.pending-=R.count,w.requests[R.id][R.action](R.value),delete w.requests[R.id]},w}function v(M){for(var w="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(r(i))+"]), {}).then(function(result) { instance = result.instance; instance.exports.__wasm_call_ctors(); });self.onmessage = workerProcess;"+l.toString()+C.toString(),T=new Blob([w],{type:"text/javascript"}),R=URL.createObjectURL(T),D=0;D<M;++D)_[D]=y(R);URL.revokeObjectURL(R)}function x(M,w,T,R,D){for(var I=_[0],U=1;U<_.length;++U)_[U].pending<I.pending&&(I=_[U]);return new Promise(function(O,N){var z=new Uint8Array(T),X=g++;I.pending+=M,I.requests[X]={resolve:O,reject:N},I.object.postMessage({id:X,count:M,size:w,source:z,mode:R,filter:D},[z.buffer])})}function C(M){n.then(function(){var w=M.data;try{var T=new Uint8Array(w.count*w.size);l(a.exports[w.mode],T,w.count,w.size,w.source,a.exports[w.filter]),self.postMessage({id:w.id,count:w.count,action:"resolve",value:T},[T.buffer])}catch(R){self.postMessage({id:w.id,count:w.count,action:"reject",value:R})}})}return{ready:n,supported:!0,useWorkers:function(M){v(M)},decodeVertexBuffer:function(M,w,T,R,D){l(a.exports.meshopt_decodeVertexBuffer,M,w,T,R,a.exports[u[D]])},decodeIndexBuffer:function(M,w,T,R){l(a.exports.meshopt_decodeIndexBuffer,M,w,T,R)},decodeIndexSequence:function(M,w,T,R){l(a.exports.meshopt_decodeIndexSequence,M,w,T,R)},decodeGltfBuffer:function(M,w,T,R,D,I){l(a.exports[f[D]],M,w,T,R,a.exports[u[I]])},decodeGltfBufferAsync:function(M,w,T,R,D){return _.length>0?x(M,w,T,f[R],u[D]):n.then(function(){var I=new Uint8Array(M*w);return l(a.exports[f[R]],I,M,w,T,a.exports[u[D]]),I})}}}();const Ire=new Map([["bin","binary"],["css","css"],["frag","shader"],["glb","container"],["glsl","shader"],["hdr","texture"],["html","html"],["jpg","texture"],["js","script"],["json","json"],["mp3","audio"],["mjs","script"],["ply","gsplat"],["png","texture"],["txt","text"],["vert","shader"],["webp","texture"]]),Ore=(h,e,t)=>{if(h.extensions&&h.extensions.EXT_meshopt_compression){const s=h.extensions.EXT_meshopt_compression;Promise.all([AN.ready,e[s.buffer]]).then(i=>{const a=i[1],n=s.byteOffset||0,r=s.byteLength||0,l=s.count,u=s.byteStride,f=new Uint8Array(l*u),_=new Uint8Array(a.buffer,a.byteOffset+n,r);AN.decodeGltfBuffer(f,l,u,_,s.mode,s.filter),t(null,f)})}else t(null,null)};class ro extends HTMLElement{constructor(){super(...arguments),this._lazy=!1,this.asset=null}disconnectedCallback(){this.destroyAsset()}createAsset(){var e;const t=this.getAttribute("id")||"",s=this.getAttribute("src")||"";let i=this.getAttribute("type");if(!i){const a=s.split(".").pop();i=(e=Ire.get(a||""))!==null&&e!==void 0?e:null}if(!i){console.warn(`Unsupported asset type: ${s}`);return}i==="container"?this.asset=new Ye(t,i,{url:s},void 0,{bufferView:{processAsync:Ore.bind(this)}}):this.asset=new Ye(t,i,{url:s}),this.asset.preload=!this._lazy}destroyAsset(){this.asset&&(this.asset.unload(),this.asset=null)}set lazy(e){this._lazy=e,this.asset&&(this.asset.preload=!e)}get lazy(){return this._lazy}static get(e){const t=document.querySelector(`pc-asset[id="${e}"]`);return t==null?void 0:t.asset}static get observedAttributes(){return["lazy"]}attributeChangedCallback(e,t,s){e==="lazy"&&(this.lazy=this.hasAttribute("lazy"))}}customElements.define("pc-asset",ro);class mo extends zm{constructor(e){super(),this._enabled=!0,this._component=null,this._componentName=e}getInitialComponentData(){return{}}async addComponent(){const e=this.closestEntity;if(e){await e.ready();const t=this.getInitialComponentData();this._component=e.entity.addComponent(this._componentName,t)}}initComponent(){}async connectedCallback(){var e;await((e=this.closestApp)===null||e===void 0?void 0:e.ready()),await this.addComponent(),this.initComponent(),this._onReady()}disconnectedCallback(){this.component&&this.component.entity&&(this._component.entity.removeComponent(this._componentName),this._component=null)}get component(){return this._component}set enabled(e){this._enabled=e,this.component&&(this.component.enabled=e)}get enabled(){return this._enabled}static get observedAttributes(){return["enabled"]}attributeChangedCallback(e,t,s){switch(e){case"enabled":this.enabled=s!=="false";break}}}class Nre extends mo{constructor(){super("audiolistener")}get component(){return super.component}}customElements.define("pc-listener",Nre);const CN=new Map([["none",iy],["linear",sy],["filmic",lU],["hejl",hU],["aces",cU],["aces2",uU],["neutral",dU]]);class Fre extends mo{constructor(){super("camera"),this._clearColor=new xe(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepthBuffer=!0,this._clearStencilBuffer=!1,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._gamma="srgb",this._horizontalFov=!1,this._nearClip=.1,this._orthographic=!1,this._orthoHeight=10,this._priority=0,this._rect=new Ie(0,0,1,1),this._scissorRect=new Ie(0,0,1,1),this._tonemap="none"}getInitialComponentData(){return{clearColor:this._clearColor,clearColorBuffer:this._clearColorBuffer,clearDepthBuffer:this._clearDepthBuffer,clearStencilBuffer:this._clearStencilBuffer,cullFaces:this._cullFaces,farClip:this._farClip,flipFaces:this._flipFaces,fov:this._fov,frustumCulling:this._frustumCulling,gammaCorrection:this._gamma==="srgb"?Gc:Ch,horizontalFov:this._horizontalFov,nearClip:this._nearClip,orthographic:this._orthographic,orthoHeight:this._orthoHeight,priority:this._priority,rect:this._rect,scissorRect:this._scissorRect,toneMapping:CN.get(this._tonemap)}}get xrAvailable(){var e;const t=(e=this.component)===null||e===void 0?void 0:e.system.app.xr;return t&&t.supported&&t.isAvailable(fL)}startXr(e,t){this.component&&this.xrAvailable&&this.component.startXr(e,t,{callback:s=>{s&&console.error(`WebXR Immersive VR failed to start: ${s.message}`)}})}endXr(){this.component&&this.component.endXr()}get component(){return super.component}set clearColor(e){this._clearColor=e,this.component&&(this.component.clearColor=e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e,this.component&&(this.component.clearColorBuffer=e)}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this.component&&(this.component.clearDepthBuffer=e)}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this.component&&(this.component.clearStencilBuffer=e)}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e,this.component&&(this.component.cullFaces=e)}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip=e,this.component&&(this.component.farClip=e)}get farClip(){return this._farClip}set flipFaces(e){this._flipFaces=e,this.component&&(this.component.flipFaces=e)}get flipFaces(){return this._flipFaces}set fov(e){this._fov=e,this.component&&(this.component.fov=e)}get fov(){return this._fov}set frustumCulling(e){this._frustumCulling=e,this.component&&(this.component.frustumCulling=e)}get frustumCulling(){return this._frustumCulling}set gamma(e){this._gamma=e,this.component&&(this.component.gammaCorrection=e==="srgb"?Gc:Ch)}get gamma(){return this._gamma}set horizontalFov(e){this._horizontalFov=e,this.component&&(this.component.horizontalFov=e)}get horizontalFov(){return this._horizontalFov}set nearClip(e){this._nearClip=e,this.component&&(this.component.nearClip=e)}get nearClip(){return this._nearClip}set orthographic(e){this._orthographic=e,this.component&&(this.component.projection=e?nl:Ya)}get orthographic(){return this._orthographic}set orthoHeight(e){this._orthoHeight=e,this.component&&(this.component.orthoHeight=e)}get orthoHeight(){return this._orthoHeight}set priority(e){this._priority=e,this.component&&(this.component.priority=e)}get priority(){return this._priority}set rect(e){this._rect=e,this.component&&(this.component.rect=e)}get rect(){return this._rect}set scissorRect(e){this._scissorRect=e,this.component&&(this.component.scissorRect=e)}get scissorRect(){return this._scissorRect}set tonemap(e){var t;this._tonemap=e,this.component&&(this.component.toneMapping=(t=CN.get(e))!==null&&t!==void 0?t:iy)}get tonemap(){return this._tonemap}static get observedAttributes(){return[...super.observedAttributes,"clear-color","clear-color-buffer","clear-depth-buffer","clear-stencil-buffer","cull-faces","far-clip","flip-faces","fov","frustum-culling","gamma","horizontal-fov","near-clip","orthographic","ortho-height","priority","rect","scissor-rect","tonemap"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"clear-color":this.clearColor=Cx(s);break;case"clear-color-buffer":this.clearColorBuffer=s!=="false";break;case"clear-depth-buffer":this.clearDepthBuffer=s!=="false";break;case"clear-stencil-buffer":this.clearStencilBuffer=s!=="false";break;case"cull-faces":this.cullFaces=s!=="false";break;case"far-clip":this.farClip=parseFloat(s);break;case"flip-faces":this.flipFaces=s!=="true";break;case"fov":this.fov=parseFloat(s);break;case"frustum-culling":this.frustumCulling=s!=="false";break;case"gamma":this.gamma=s;break;case"horizontal-fov":this.horizontalFov=this.hasAttribute("horizontal-fov");break;case"near-clip":this.nearClip=parseFloat(s);break;case"orthographic":this.orthographic=this.hasAttribute("orthographic");break;case"ortho-height":this.orthoHeight=parseFloat(s);break;case"priority":this.priority=parseFloat(s);break;case"rect":this.rect=dD(s);break;case"scissor-rect":this.scissorRect=dD(s);break;case"tonemap":this.tonemap=s;break}}}customElements.define("pc-camera",Fre);class Bre extends mo{constructor(){super("collision"),this._angularOffset=new Ne,this._axis=1,this._convexHull=!1,this._halfExtents=new H(.5,.5,.5),this._height=2,this._linearOffset=new H,this._radius=.5,this._type="box"}getInitialComponentData(){return{axis:this._axis,angularOffset:this._angularOffset,convexHull:this._convexHull,halfExtents:this._halfExtents,height:this._height,linearOffset:this._linearOffset,radius:this._radius,type:this._type}}get component(){return super.component}set angularOffset(e){this._angularOffset=e,this.component&&(this.component.angularOffset=e)}get angularOffset(){return this._angularOffset}set axis(e){this._axis=e,this.component&&(this.component.axis=e)}get axis(){return this._axis}set convexHull(e){this._convexHull=e,this.component&&(this.component.convexHull=e)}get convexHull(){return this._convexHull}set halfExtents(e){this._halfExtents=e,this.component&&(this.component.halfExtents=e)}get halfExtents(){return this._halfExtents}set height(e){this._height=e,this.component&&(this.component.height=e)}get height(){return this._height}set linearOffset(e){this._linearOffset=e,this.component&&(this.component.linearOffset=e)}get linearOffset(){return this._linearOffset}set radius(e){this._radius=e,this.component&&(this.component.radius=e)}get radius(){return this._radius}set type(e){this._type=e,this.component&&(this.component.type=e)}get type(){return this._type}static get observedAttributes(){return[...super.observedAttributes,"angular-offset","axis","convex-hull","half-extents","height","linear-offset","radius","type"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"angular-offset":this.angularOffset=Pre(s);break;case"axis":this.axis=parseInt(s,10);break;case"convex-hull":this.convexHull=this.hasAttribute("convex-hull");break;case"half-extents":this.halfExtents=zn(s);break;case"height":this.height=parseFloat(s);break;case"linear-offset":this.linearOffset=zn(s);break;case"radius":this.radius=parseFloat(s);break;case"type":this.type=s;break}}}customElements.define("pc-collision",Bre);class Ure extends mo{constructor(){super("element"),this._anchor=new Ie(.5,.5,.5,.5),this._asset="",this._autoWidth=!0,this._color=new xe(1,1,1,1),this._fontSize=32,this._lineHeight=32,this._pivot=new Ee(.5,.5),this._text="",this._type="group",this._width=0,this._wrapLines=!1}initComponent(){this.component._text._material.useFog=!0}getInitialComponentData(){return{anchor:this._anchor,autoWidth:this._autoWidth,color:this._color,fontAsset:ro.get(this._asset).id,fontSize:this._fontSize,lineHeight:this._lineHeight,pivot:this._pivot,type:this._type,text:this._text,width:this._width,wrapLines:this._wrapLines}}get component(){return super.component}set anchor(e){this._anchor=e,this.component&&(this.component.anchor=e)}get anchor(){return this._anchor}set asset(e){this._asset=e;const t=ro.get(e);this.component&&t&&(this.component.fontAsset=t.id)}get asset(){return this._asset}set autoWidth(e){this._autoWidth=e,this.component&&(this.component.autoWidth=e)}get autoWidth(){return this._autoWidth}set color(e){this._color=e,this.component&&(this.component.color=e)}get color(){return this._color}set fontSize(e){this._fontSize=e,this.component&&(this.component.fontSize=e)}get fontSize(){return this._fontSize}set lineHeight(e){this._lineHeight=e,this.component&&(this.component.lineHeight=e)}get lineHeight(){return this._lineHeight}set pivot(e){this._pivot=e,this.component&&(this.component.pivot=e)}get pivot(){return this._pivot}set text(e){this._text=e,this.component&&(this.component.text=e)}get text(){return this._text}set type(e){this._type=e,this.component&&(this.component.type=e)}get type(){return this._type}set width(e){this._width=e,this.component&&(this.component.width=e)}get width(){return this._width}set wrapLines(e){this._wrapLines=e,this.component&&(this.component.wrapLines=e)}get wrapLines(){return this._wrapLines}static get observedAttributes(){return[...super.observedAttributes,"anchor","asset","auto-width","color","font-size","line-height","pivot","text","type","width","wrap-lines"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"anchor":this.anchor=dD(s);break;case"asset":this.asset=s;break;case"auto-width":this.autoWidth=s!=="false";break;case"color":this.color=Cx(s);break;case"font-size":this.fontSize=Number(s);break;case"line-height":this.lineHeight=Number(s);break;case"pivot":this.pivot=uD(s);break;case"text":this.text=s;break;case"type":this.type=s;break;case"width":this.width=Number(s);break;case"wrap-lines":this.wrapLines=this.hasAttribute(e);break}}}customElements.define("pc-element",Ure);const wN=new Map([["pcf1-16f",wC],["pcf1-32f",CC],["pcf3-16f",RC],["pcf3-32f",Un],["pcf5-16f",pP],["pcf5-32f",fP],["vsm-16f",e1],["vsm-32f",cx],["pcss-32f",fm]]);class zre extends mo{constructor(){super("light"),this._castShadows=!1,this._color=new xe(1,1,1),this._innerConeAngle=40,this._intensity=1,this._normalOffsetBias=.05,this._outerConeAngle=45,this._range=10,this._shadowBias=.2,this._shadowDistance=16,this._shadowIntensity=1,this._shadowResolution=1024,this._shadowType="pcf3-32f",this._type="directional",this._vsmBias=.01,this._vsmBlurSize=11}getInitialComponentData(){return{castShadows:this._castShadows,color:this._color,innerConeAngle:this._innerConeAngle,intensity:this._intensity,normalOffsetBias:this._normalOffsetBias,outerConeAngle:this._outerConeAngle,range:this._range,shadowBias:this._shadowBias,shadowDistance:this._shadowDistance,shadowIntensity:this._shadowIntensity,shadowResolution:this._shadowResolution,shadowType:wN.get(this._shadowType),type:this._type,vsmBias:this._vsmBias,vsmBlurSize:this._vsmBlurSize}}get component(){return super.component}set castShadows(e){this._castShadows=e,this.component&&(this.component.castShadows=e)}get castShadows(){return this._castShadows}set color(e){this._color=e,this.component&&(this.component.color=e)}get color(){return this._color}set innerConeAngle(e){this._innerConeAngle=e,this.component&&(this.component.innerConeAngle=e)}get innerConeAngle(){return this._innerConeAngle}set intensity(e){this._intensity=e,this.component&&(this.component.intensity=e)}get intensity(){return this._intensity}set normalOffsetBias(e){this._normalOffsetBias=e,this.component&&(this.component.normalOffsetBias=e)}get normalOffsetBias(){return this._normalOffsetBias}set outerConeAngle(e){this._outerConeAngle=e,this.component&&(this.component.outerConeAngle=e)}get outerConeAngle(){return this._outerConeAngle}set range(e){this._range=e,this.component&&(this.component.range=e)}get range(){return this._range}set shadowBias(e){this._shadowBias=e,this.component&&(this.component.shadowBias=e)}get shadowBias(){return this._shadowBias}set shadowDistance(e){this._shadowDistance=e,this.component&&(this.component.shadowDistance=e)}get shadowDistance(){return this._shadowDistance}set shadowIntensity(e){this._shadowIntensity=e,this.component&&(this.component.shadowIntensity=e)}get shadowIntensity(){return this._shadowIntensity}set shadowResolution(e){this._shadowResolution=e,this.component&&(this.component.shadowResolution=e)}get shadowResolution(){return this._shadowResolution}set shadowType(e){var t;this._shadowType=e,this.component&&(this.component.shadowType=(t=wN.get(e))!==null&&t!==void 0?t:Un)}get shadowType(){return this._shadowType}set type(e){if(!["directional","omni","spot"].includes(e)){console.warn(`Invalid light type '${e}', using default type '${this._type}'.`);return}this._type=e,this.component&&(this.component.type=e)}get type(){return this._type}set vsmBias(e){this._vsmBias=e,this.component&&(this.component.vsmBias=e)}get vsmBias(){return this._vsmBias}set vsmBlurSize(e){this._vsmBlurSize=e,this.component&&(this.component.vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}static get observedAttributes(){return[...super.observedAttributes,"color","cast-shadows","intensity","inner-cone-angle","normal-offset-bias","outer-cone-angle","range","shadow-bias","shadow-distance","shadow-intensity","shadow-resolution","shadow-type","type","vsm-bias","vsm-blur-size"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"color":this.color=Cx(s);break;case"cast-shadows":this.castShadows=this.hasAttribute("cast-shadows");break;case"inner-cone-angle":this.innerConeAngle=Number(s);break;case"intensity":this.intensity=Number(s);break;case"normal-offset-bias":this.normalOffsetBias=Number(s);break;case"outer-cone-angle":this.outerConeAngle=Number(s);break;case"range":this.range=Number(s);break;case"shadow-bias":this.shadowBias=Number(s);break;case"shadow-distance":this.shadowDistance=Number(s);break;case"shadow-resolution":this.shadowResolution=Number(s);break;case"shadow-intensity":this.shadowIntensity=Number(s);break;case"shadow-type":this.shadowType=s;break;case"type":this.type=s;break;case"vsm-bias":this.vsmBias=Number(s);break;case"vsm-blur-size":this.vsmBlurSize=Number(s);break}}}customElements.define("pc-light",zre);class kre extends mo{constructor(){super("particlesystem"),this._asset=""}getInitialComponentData(){var e;const t=ro.get(this._asset);if(!t)return{};if(t.resource.colorMapAsset){const s=t.resource.colorMapAsset,i=(e=ro.get(s))===null||e===void 0?void 0:e.id;i&&(t.resource.colorMapAsset=i)}return t.resource}get component(){return super.component}applyConfig(e){if(this.component)for(const t in e)e.hasOwnProperty(t)&&(this.component[t]=e[t])}async _loadAsset(){var e;const t=await((e=this.closestApp)===null||e===void 0?void 0:e.ready()),s=t==null?void 0:t.app,i=ro.get(this._asset);i&&(i.loaded?this.applyConfig(i.resource):(i.once("load",()=>{this.applyConfig(i.resource)}),s.assets.load(i)))}set asset(e){this._asset=e,this.isConnected&&this._loadAsset()}get asset(){return this._asset}play(){this.component&&this.component.play()}pause(){this.component&&this.component.pause()}reset(){this.component&&this.component.reset()}stop(){this.component&&this.component.stop()}static get observedAttributes(){return[...super.observedAttributes,"asset"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"asset":this.asset=s;break}}}customElements.define("pc-particles",kre);class fD extends HTMLElement{constructor(){super(...arguments),this._diffuse=new xe(1,1,1),this._diffuseMap="",this._metalnessMap="",this._normalMap="",this._roughnessMap="",this.material=null}createMaterial(){this.material=new Vi,this.material.glossInvert=!1,this.material.useMetalness=!1,this.material.diffuse=this._diffuse,this.diffuseMap=this._diffuseMap,this.metalnessMap=this._metalnessMap,this.normalMap=this._normalMap,this.roughnessMap=this._roughnessMap,this.material.update()}disconnectedCallback(){this.material&&(this.material.destroy(),this.material=null)}setMap(e,t){if(this.material){const s=ro.get(e);s&&(s.loaded?(this.material[t]=s.resource,this.material[t].anisotropy=4):s.once("load",()=>{this.material[t]=s.resource,this.material[t].anisotropy=4,this.material.update()}))}}set diffuse(e){this._diffuse=e,this.material&&(this.material.diffuse=e)}get diffuse(){return this._diffuse}set diffuseMap(e){this._diffuseMap=e,this.setMap(e,"diffuseMap")}get diffuseMap(){return this._diffuseMap}set metalnessMap(e){this._metalnessMap=e,this.setMap(e,"metalnessMap")}get metalnessMap(){return this._metalnessMap}set normalMap(e){this._normalMap=e,this.setMap(e,"normalMap")}get normalMap(){return this._normalMap}set roughnessMap(e){this._roughnessMap=e,this.setMap(e,"glossMap")}get roughnessMap(){return this._roughnessMap}static get(e){const t=document.querySelector(`pc-material[id="${e}"]`);return t==null?void 0:t.material}static get observedAttributes(){return["diffuse","diffuse-map","metalness-map","normal-map","roughness-map"]}attributeChangedCallback(e,t,s){switch(e){case"diffuse":this.diffuse=Cx(s);break;case"diffuse-map":this.diffuseMap=s;break;case"metalness-map":this.metalnessMap=s;break;case"normal-map":this.normalMap=s;break;case"roughness-map":this.roughnessMap=s;break}}}customElements.define("pc-material",fD);class Vre extends mo{constructor(){super("render"),this._castShadows=!0,this._material="",this._receiveShadows=!0,this._type="asset"}getInitialComponentData(){return{type:this._type,castShadows:this._castShadows,material:fD.get(this._material),receiveShadows:this._receiveShadows}}get component(){return super.component}set type(e){this._type=e,this.component&&(this.component.type=e)}get type(){return this._type}set castShadows(e){this._castShadows=e,this.component&&(this.component.castShadows=e)}get castShadows(){return this._castShadows}set material(e){this._material=e,this.component&&(this.component.material=fD.get(e))}get material(){return this._material}set receiveShadows(e){this._receiveShadows=e,this.component&&(this.component.receiveShadows=e)}get receiveShadows(){return this._receiveShadows}static get observedAttributes(){return[...super.observedAttributes,"cast-shadows","material","receive-shadows","type"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"cast-shadows":this.castShadows=s!=="false";break;case"material":this.material=s;break;case"receive-shadows":this.receiveShadows=s!=="false";break;case"type":this.type=s;break}}}customElements.define("pc-render",Vre);class Gre extends mo{constructor(){super("rigidbody"),this._angularDamping=0,this._angularFactor=new H(1,1,1),this._friction=.5,this._linearDamping=0,this._linearFactor=new H(1,1,1),this._mass=1,this._restitution=0,this._rollingFriction=0,this._type="static"}getInitialComponentData(){return{angularDamping:this._angularDamping,angularFactor:this._angularFactor,friction:this._friction,linearDamping:this._linearDamping,linearFactor:this._linearFactor,mass:this._mass,restitution:this._restitution,rollingFriction:this._rollingFriction,type:this._type}}get component(){return super.component}set angularDamping(e){this._angularDamping=e,this.component&&(this.component.angularDamping=e)}get angularDamping(){return this._angularDamping}set angularFactor(e){this._angularFactor=e,this.component&&(this.component.angularFactor=e)}get angularFactor(){return this._angularFactor}set friction(e){this._friction=e,this.component&&(this.component.friction=e)}get friction(){return this._friction}set linearDamping(e){this._linearDamping=e,this.component&&(this.component.linearDamping=e)}get linearDamping(){return this._linearDamping}set linearFactor(e){this._linearFactor=e,this.component&&(this.component.linearFactor=e)}get linearFactor(){return this._linearFactor}set mass(e){this._mass=e,this.component&&(this.component.mass=e)}get mass(){return this._mass}set restitution(e){this._restitution=e,this.component&&(this.component.restitution=e)}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction=e,this.component&&(this.component.rollingFriction=e)}get rollingFriction(){return this._rollingFriction}set type(e){this._type=e,this.component&&(this.component.type=e)}get type(){return this._type}static get observedAttributes(){return[...super.observedAttributes,"angular-damping","angular-factor","friction","linear-damping","linear-factor","mass","restitution","rolling-friction","type"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"angular-damping":this.angularDamping=parseFloat(s);break;case"angular-factor":this.angularFactor=zn(s);break;case"friction":this.friction=parseFloat(s);break;case"linear-damping":this.linearDamping=parseFloat(s);break;case"linear-factor":this.linearFactor=zn(s);break;case"mass":this.mass=parseFloat(s);break;case"restitution":this.restitution=parseFloat(s);break;case"rolling-friction":this.rollingFriction=parseFloat(s);break;case"type":this.type=s;break}}}customElements.define("pc-rigidbody",Gre);class Hre extends mo{constructor(){super("screen"),this._screenSpace=!1,this._resolution=new Ee(640,320),this._referenceResolution=new Ee(640,320),this._priority=0,this._blend=!1,this._scaleBlend=.5}getInitialComponentData(){return{priority:this._priority,referenceResolution:this._referenceResolution,resolution:this._resolution,scaleBlend:this._scaleBlend,scaleMode:this._blend?a2:Uc,screenSpace:this._screenSpace}}get component(){return super.component}set priority(e){this._priority=e,this.component&&(this.component.priority=this._priority)}get priority(){return this._priority}set referenceResolution(e){this._referenceResolution=e,this.component&&(this.component.referenceResolution=this._referenceResolution)}get referenceResolution(){return this._referenceResolution}set resolution(e){this._resolution=e,this.component&&(this.component.resolution=this._resolution)}get resolution(){return this._resolution}set scaleBlend(e){this._scaleBlend=e,this.component&&(this.component.scaleBlend=this._scaleBlend)}get scaleBlend(){return this._scaleBlend}set blend(e){this._blend=e,this.component&&(this.component.scaleMode=this._blend?a2:Uc)}get blend(){return this._blend}set screenSpace(e){this._screenSpace=e,this.component&&(this.component.screenSpace=this._screenSpace)}get screenSpace(){return this._screenSpace}static get observedAttributes(){return[...super.observedAttributes,"blend","screen-space","resolution","reference-resolution","priority","scale-blend"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"priority":this.priority=parseInt(s,10);break;case"reference-resolution":this.referenceResolution=uD(s);break;case"resolution":this.resolution=uD(s);break;case"scale-blend":this.scaleBlend=parseFloat(s);break;case"blend":this.blend=this.hasAttribute("blend");break;case"screen-space":this.screenSpace=this.hasAttribute("screen-space");break}}}customElements.define("pc-screen",Hre);class Wre extends mo{constructor(){super("script"),this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(this,{childList:!0}),this.addEventListener("scriptattributeschange",this.handleScriptAttributesChange.bind(this)),this.addEventListener("scriptenablechange",this.handleScriptEnableChange.bind(this))}initComponent(){this.querySelectorAll(":scope > pc-script").forEach(e=>{const t=e.getAttribute("name"),s=e.getAttribute("attributes");t&&this.createScript(t,s)})}convertAttributes(e){if(typeof e=="string"){if(e.startsWith("asset:")){const t=e.slice(6),s=document.querySelector(`pc-asset#${t}`);if(s)return s.asset}if(e.startsWith("entity:")){const t=e.slice(7),s=document.querySelector(`pc-entity[name="${t}"]`);if(s)return s.entity}if(e.startsWith("vec2:")){const t=e.slice(5).split(",").map(Number);if(t.length===2&&t.every(s=>!isNaN(s)))return new Ee(t[0],t[1])}if(e.startsWith("vec3:")){const t=e.slice(5).split(",").map(Number);if(t.length===3&&t.every(s=>!isNaN(s)))return new H(t[0],t[1],t[2])}if(e.startsWith("vec4:")){const t=e.slice(5).split(",").map(Number);if(t.length===4&&t.every(s=>!isNaN(s)))return new Ie(t[0],t[1],t[2],t[3])}if(e.startsWith("color:")){const t=e.slice(6).split(",").map(Number);if(t.length===4&&t.every(s=>!isNaN(s)))return new xe(t[0],t[1],t[2],t[3])}return e}if(Array.isArray(e))return e.length>0&&typeof e[0]=="object"?e.map(t=>this.convertAttributes(t)):e.map(t=>this.convertAttributes(t));if(e&&typeof e=="object"){const t={};for(const s in e)t[s]=this.convertAttributes(e[s]);return t}return e}preprocessAttributes(e){return this.convertAttributes(e)}mergeDeep(e,t){for(const s in t)t[s]&&typeof t[s]=="object"&&!Array.isArray(t[s])?((!e[s]||typeof e[s]!="object")&&(e[s]={}),this.mergeDeep(e[s],t[s])):e[s]=t[s];return e}applyAttributes(e,t){try{const s=t?JSON.parse(t):{},i=this.convertAttributes(s);this.mergeDeep(e,i)}catch(s){console.error(`Error parsing attributes JSON string ${t}:`,s)}}handleScriptAttributesChange(e){const s=e.target.getAttribute("name");if(!s||!this.component)return;const i=this.component.get(s);i&&this.applyAttributes(i,e.detail.attributes)}handleScriptEnableChange(e){const s=e.target.getAttribute("name");if(!s||!this.component)return;const i=this.component.get(s);i&&(i.enabled=e.detail.enabled)}createScript(e,t){if(!this.component)return null;let s={};if(t)try{s=JSON.parse(t),s=this.preprocessAttributes(s)}catch(i){console.error(`Error parsing attributes JSON string ${t}:`,i)}return this.component.create(e,{properties:s})}destroyScript(e){this.component&&this.component.destroy(e)}handleMutations(e){for(const t of e)t.addedNodes.forEach(s=>{if(s instanceof HTMLElement&&s.tagName.toLowerCase()==="pc-script"){const i=s.getAttribute("name"),a=s.getAttribute("attributes");i&&this.createScript(i,a)}}),t.removedNodes.forEach(s=>{if(s instanceof HTMLElement&&s.tagName.toLowerCase()==="pc-script"){const i=s.getAttribute("name");i&&this.destroyScript(i)}})}disconnectedCallback(){var e;this.observer.disconnect(),(e=super.disconnectedCallback)===null||e===void 0||e.call(this)}get component(){return super.component}}customElements.define("pc-scripts",Wre);class qre extends HTMLElement{constructor(){super(...arguments),this._attributes="{}",this._enabled=!0,this._name=""}set scriptAttributes(e){this._attributes=e,this.dispatchEvent(new CustomEvent("scriptattributeschange",{detail:{attributes:e},bubbles:!0}))}get scriptAttributes(){return this._attributes}set enabled(e){this._enabled=e,this.dispatchEvent(new CustomEvent("scriptenablechange",{detail:{enabled:e},bubbles:!0}))}get enabled(){return this._enabled}set name(e){this._name=e}get name(){return this._name}static get observedAttributes(){return["attributes","enabled","name"]}attributeChangedCallback(e,t,s){switch(e){case"attributes":this.scriptAttributes=s;break;case"enabled":this.enabled=s!=="false";break;case"name":this.name=s;break}}}customElements.define("pc-script",qre);class K6 extends mo{constructor(){super("sound"),this._distanceModel="linear",this._maxDistance=1e4,this._pitch=1,this._positional=!1,this._refDistance=1,this._rollOffFactor=1,this._volume=1}getInitialComponentData(){return{distanceModel:this._distanceModel,maxDistance:this._maxDistance,pitch:this._pitch,positional:this._positional,refDistance:this._refDistance,rollOffFactor:this._rollOffFactor,volume:this._volume}}get component(){return super.component}set distanceModel(e){this._distanceModel=e,this.component&&(this.component.distanceModel=e)}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this.component&&(this.component.maxDistance=e)}get maxDistance(){return this._maxDistance}set pitch(e){this._pitch=e,this.component&&(this.component.pitch=e)}get pitch(){return this._pitch}set positional(e){this._positional=e,this.component&&(this.component.positional=e)}get positional(){return this._positional}set refDistance(e){this._refDistance=e,this.component&&(this.component.refDistance=e)}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this.component&&(this.component.rollOffFactor=e)}get rollOffFactor(){return this._rollOffFactor}set volume(e){this._volume=e,this.component&&(this.component.volume=e)}get volume(){return this._volume}static get observedAttributes(){return[...super.observedAttributes,"distance-model","max-distance","pitch","positional","ref-distance","roll-off-factor","volume"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"distance-model":this.distanceModel=s;break;case"max-distance":this.maxDistance=parseFloat(s);break;case"pitch":this.pitch=parseFloat(s);break;case"positional":this.positional=this.hasAttribute("positional");break;case"ref-distance":this.refDistance=parseFloat(s);break;case"roll-off-factor":this.rollOffFactor=parseFloat(s);break;case"volume":this.volume=parseFloat(s);break}}}customElements.define("pc-sounds",K6);class Xre extends zm{constructor(){super(...arguments),this._asset="",this._autoPlay=!1,this._duration=null,this._loop=!1,this._name="",this._overlap=!1,this._pitch=1,this._startTime=0,this._volume=1,this.soundSlot=null}async connectedCallback(){var e;await((e=this.soundElement)===null||e===void 0?void 0:e.ready());const t={autoPlay:this._autoPlay,loop:this._loop,overlap:this._overlap,pitch:this._pitch,startTime:this._startTime,volume:this._volume};this._duration&&(t.duration=this._duration),this.soundSlot=this.soundElement.component.addSlot(this._name,t),this.asset=this._asset,this._onReady()}disconnectedCallback(){this.soundElement.component.removeSlot(this._name)}get soundElement(){const e=this.parentElement;return e instanceof K6?e:(console.warn("pc-sound-slot must be a direct child of a pc-sound element"),null)}set asset(e){var t;if(this._asset=e,this.soundSlot){const s=(t=ro.get(e))===null||t===void 0?void 0:t.id;s&&(this.soundSlot.asset=s)}}get asset(){return this._asset}set autoPlay(e){this._autoPlay=e,this.soundSlot&&(this.soundSlot.autoPlay=e)}get autoPlay(){return this._autoPlay}set duration(e){this._duration=e,this.soundSlot&&(this.soundSlot.duration=e)}get duration(){return this._duration}set loop(e){this._loop=e,this.soundSlot&&(this.soundSlot.loop=e)}get loop(){return this._loop}set name(e){this._name=e,this.soundSlot&&(this.soundSlot.name=e)}get name(){return this._name}set overlap(e){this._overlap=e,this.soundSlot&&(this.soundSlot.overlap=e)}get overlap(){return this._overlap}set pitch(e){this._pitch=e,this.soundSlot&&(this.soundSlot.pitch=e)}get pitch(){return this._pitch}set startTime(e){this._startTime=e,this.soundSlot&&(this.soundSlot.startTime=e)}get startTime(){return this._startTime}set volume(e){this._volume=e,this.soundSlot&&(this.soundSlot.volume=e)}get volume(){return this._volume}static get observedAttributes(){return["asset","auto-play","duration","loop","name","overlap","pitch","start-time","volume"]}attributeChangedCallback(e,t,s){switch(e){case"asset":this.asset=s;break;case"auto-play":this.autoPlay=this.hasAttribute("auto-play");break;case"duration":this.duration=parseFloat(s);break;case"loop":this.loop=this.hasAttribute("loop");break;case"name":this.name=s;break;case"overlap":this.overlap=this.hasAttribute("overlap");break;case"pitch":this.pitch=parseFloat(s);break;case"start-time":this.startTime=parseFloat(s);break;case"volume":this.volume=parseFloat(s);break}}}customElements.define("pc-sound",Xre);class jre extends mo{constructor(){super("gsplat"),this._asset="",this._castShadows=!1}getInitialComponentData(){return{asset:ro.get(this._asset),castShadows:this._castShadows}}get component(){return super.component}set asset(e){this._asset=e;const t=ro.get(e);this.component&&t&&(this.component.asset=t)}get asset(){return this._asset}set castShadows(e){this._castShadows=e,this.component&&(this.component.castShadows=e)}get castShadows(){return this._castShadows}static get observedAttributes(){return[...super.observedAttributes,"asset","cast-shadows"]}attributeChangedCallback(e,t,s){switch(super.attributeChangedCallback(e,t,s),e){case"asset":this.asset=s;break;case"cast-shadows":this.castShadows=this.hasAttribute("cast-shadows");break}}}customElements.define("pc-splat",jre);class Yre extends zm{constructor(){super(...arguments),this._asset="",this._entity=null}connectedCallback(){this._loadModel(),this._onReady()}disconnectedCallback(){this._unloadModel()}_instantiate(e){this._entity=e.instantiateRenderEntity(),e.animations.length>0&&(this._entity.addComponent("anim"),this._entity.anim.assignAnimation("animation",e.animations[0].resource));const t=this.closestEntity;if(t)t.ready().then(()=>{t.entity.addChild(this._entity)});else{const s=this.closestApp;s&&s.ready().then(()=>{s.app.root.addChild(this._entity)})}}async _loadModel(){var e;this._unloadModel();const t=await((e=this.closestApp)===null||e===void 0?void 0:e.ready()),s=t==null?void 0:t.app,i=ro.get(this._asset);i&&(i.loaded?this._instantiate(i.resource):(i.once("load",()=>{this._instantiate(i.resource)}),s.assets.load(i)))}_unloadModel(){var e;(e=this._entity)===null||e===void 0||e.destroy(),this._entity=null}set asset(e){this._asset=e,this.isConnected&&this._loadModel()}get asset(){return this._asset}static get observedAttributes(){return["asset"]}attributeChangedCallback(e,t,s){switch(e){case"asset":this.asset=s;break}}}customElements.define("pc-model",Yre);class Kre extends zm{constructor(){super(...arguments),this._fog="none",this._fogColor=new xe(1,1,1),this._fogDensity=0,this._fogStart=0,this._fogEnd=1e3,this._gravity=new H(0,-9.81,0),this.scene=null}async connectedCallback(){var e;await((e=this.closestApp)===null||e===void 0?void 0:e.ready()),this.scene=this.closestApp.app.scene,this.updateSceneSettings(),this._onReady()}updateSceneSettings(){this.scene&&(this.scene.fog.type=this._fog,this.scene.fog.color=this._fogColor,this.scene.fog.density=this._fogDensity,this.scene.fog.start=this._fogStart,this.scene.fog.end=this._fogEnd,this.parentElement.app.systems.rigidbody.gravity.copy(this._gravity))}set fog(e){this._fog=e,this.scene&&(this.scene.fog.type=e)}get fog(){return this._fog}set fogColor(e){this._fogColor=e,this.scene&&(this.scene.fog.color=e)}get fogColor(){return this._fogColor}set fogDensity(e){this._fogDensity=e,this.scene&&(this.scene.fog.density=e)}get fogDensity(){return this._fogDensity}set fogStart(e){this._fogStart=e,this.scene&&(this.scene.fog.start=e)}get fogStart(){return this._fogStart}set fogEnd(e){this._fogEnd=e,this.scene&&(this.scene.fog.end=e)}get fogEnd(){return this._fogEnd}set gravity(e){this._gravity=e,this.scene&&this.parentElement.app.systems.rigidbody.gravity.copy(e)}get gravity(){return this._gravity}static get observedAttributes(){return["fog","fog-color","fog-density","fog-start","fog-end","gravity"]}attributeChangedCallback(e,t,s){switch(e){case"fog":this.fog=s;break;case"fog-color":this.fogColor=Cx(s);break;case"fog-density":this.fogDensity=parseFloat(s);break;case"fog-start":this.fogStart=parseFloat(s);break;case"fog-end":this.fogEnd=parseFloat(s);break;case"gravity":this.gravity=zn(s);break}}}customElements.define("pc-scene",Kre);class Qre extends zm{constructor(){super(...arguments),this._asset="",this._center=new H(0,.01,0),this._intensity=1,this._rotation=new H,this._level=0,this._lighting=!1,this._scale=new H(100,100,100),this._type="infinite",this._scene=null}connectedCallback(){this._loadSkybox(),this._onReady()}disconnectedCallback(){this._unloadSkybox()}_generateSkybox(e){if(!this._scene)return;const t=e.resource,s=n0.generateSkyboxCubemap(t);if(s.anisotropy=4,this._scene.skybox=s,this._lighting){const a=n0.generateLightingSource(t),n=n0.generateAtlas(a);this._scene.envAtlas=n}const i=this._scene.layers.getLayerById(dm);i&&(i.enabled=this._type!=="none"),this._scene.sky.type=this._type,this._scene.sky.node.setLocalScale(this._scale),this._scene.sky.center=this._center,this._scene.skyboxIntensity=this._intensity,this._scene.skyboxMip=this._level}async _loadSkybox(){var e;const t=await((e=this.closestApp)===null||e===void 0?void 0:e.ready()),s=t==null?void 0:t.app;if(!s)return;const i=ro.get(this._asset);i&&(this._scene=s.scene,i.loaded?this._generateSkybox(i):(i.once("load",()=>{this._generateSkybox(i)}),s.assets.load(i)))}_unloadSkybox(){var e,t;this._scene&&((e=this._scene.skybox)===null||e===void 0||e.destroy(),this._scene.skybox=null,(t=this._scene.envAtlas)===null||t===void 0||t.destroy(),this._scene.envAtlas=null,this._scene=null)}set asset(e){this._asset=e,this.isConnected&&this._loadSkybox()}get asset(){return this._asset}set center(e){this._center=e,this._scene&&(this._scene.sky.center=this._center)}get center(){return this._center}set intensity(e){this._intensity=e,this._scene&&(this._scene.skyboxIntensity=this._intensity)}get intensity(){return this._intensity}set level(e){this._level=e,this._scene&&(this._scene.skyboxMip=this._level)}get level(){return this._level}set lighting(e){this._lighting=e}get lighting(){return this._lighting}set rotation(e){this._rotation=e,this._scene&&(this._scene.skyboxRotation=new Ne().setFromEulerAngles(e))}get rotation(){return this._rotation}set scale(e){this._scale=e,this._scene&&this._scene.sky.node.setLocalScale(this._scale)}get scale(){return this._scale}set type(e){if(this._type=e,this._scene){this._scene.sky.type=this._type;const t=this._scene.layers.getLayerById(dm);t&&(t.enabled=this._type!=="none")}}get type(){return this._type}static get observedAttributes(){return["asset","center","intensity","level","lighting","rotation","scale","type"]}attributeChangedCallback(e,t,s){switch(e){case"asset":this.asset=s;break;case"center":this.center=zn(s);break;case"intensity":this.intensity=parseFloat(s);break;case"level":this.level=parseInt(s,10);break;case"lighting":this.lighting=this.hasAttribute(e);break;case"rotation":this.rotation=zn(s);break;case"scale":this.scale=zn(s);break;case"type":this.type=s;break}}}customElements.define("pc-sky",Qre);const RN=new Ee,us=new H,$re=new H,fM=new Me,Zre=new Ne,Jre=new ll,eoe=new E1,MN={passive:!1},toe=10,soe=1e-4,pM=(h,e)=>1-Math.pow(h,e*1e3),Jg=class Jg extends Rh{constructor(){super(...arguments);rt(this,"_camera",null);rt(this,"_origin",new H);rt(this,"_position",new H);rt(this,"_dir",new Ee);rt(this,"_angles",new H);rt(this,"_pitchRange",new Ee(-360,360));rt(this,"_zoomMin",0);rt(this,"_zoomMax",0);rt(this,"_zoomDist",0);rt(this,"_cameraDist",0);rt(this,"_pointerEvents",new Map);rt(this,"_lastPinchDist",-1);rt(this,"_lastPosition",new Ee);rt(this,"_dragging",!1);rt(this,"_orbiting",!0);rt(this,"_panning",!1);rt(this,"_flying",!1);rt(this,"_moving",!1);rt(this,"_focusing",!1);rt(this,"_key",{forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,sprint:!1,crouch:!1});rt(this,"_element",this.app.graphicsDevice.canvas);rt(this,"_cameraTransform",new Me);rt(this,"_baseTransform",new Me);rt(this,"sceneSize",100);rt(this,"enableOrbit",!0);rt(this,"enablePan",!0);rt(this,"enableFly",!0);rt(this,"focusDamping",.98);rt(this,"rotateSpeed",.2);rt(this,"rotateDamping",.98);rt(this,"moveSpeed",2);rt(this,"moveFastSpeed",4);rt(this,"moveSlowSpeed",1);rt(this,"moveDamping",.98);rt(this,"zoomSpeed",.005);rt(this,"zoomPinchSens",5);rt(this,"zoomDamping",.98);rt(this,"zoomScaleMin",0)}initialize(){if(this._onWheel=this._onWheel.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this),!this.entity.camera)throw new Error("CameraControls script requires a camera component");this.attach(this.entity.camera),this.focusPoint=this._origin??this.focusPoint,this.pitchRange=this._pitchRange??this.pitchRange,this.zoomMin=this._zoomMin??this.zoomMin,this.zoomMax=this._zoomMax??this.zoomMax,this.on("destroy",this.destroy,this)}set element(t){this._element=t;const s=this._camera;this.detach(),s&&this.attach(s)}get element(){return this._element}set focusPoint(t){if(!this._camera){t instanceof H&&this._origin.copy(t);return}this.focus(t,this.entity.getPosition(),!1)}get focusPoint(){return this._origin}set pitchRange(t){t instanceof Ee&&(this._pitchRange.copy(t),this._clampAngles(this._dir),this._smoothTransform(-1))}get pitchRange(){return this._pitchRange}set zoomMin(t){this._zoomMin=t??this._zoomMin,this._zoomDist=this._clampZoom(this._zoomDist),this._smoothZoom(-1)}get zoomMin(){return this._zoomMin}set zoomMax(t){this._zoomMax=t??this._zoomMax,this._zoomDist=this._clampZoom(this._zoomDist),this._smoothZoom(-1)}get zoomMax(){return this._zoomMax}_focusDir(t){return t.copy(this.entity.forward).mulScalar(this._zoomDist)}_clampAngles(t){const s=this._pitchRange.x===-360?-1/0:this._pitchRange.x,i=this._pitchRange.y===360?1/0:this._pitchRange.y;t.x=ge.clamp(t.x,s,i),this.fire(Jg.EVENT_CLAMP_ANGLES,t)}_clampPosition(t){this._flying?us.set(0,0,0):this._focusDir(us),t.sub(us),this.fire(Jg.EVENT_CLAMP_POSITION,t),t.add(us)}_clampZoom(t){var a;const s=(((a=this._camera)==null?void 0:a.nearClip)??0)+this.zoomMin*this.sceneSize,i=this.zoomMax<=this.zoomMin?1/0:this.zoomMax*this.sceneSize;return ge.clamp(t,s,i)}_onContextMenu(t){t.preventDefault()}_isStartMousePan(t){return this.enablePan?t.shiftKey?!0:!this.enableOrbit&&!this.enableFly?t.button===0||t.button===1||t.button===2:!this.enableOrbit||!this.enableFly?t.button===1||t.button===2:t.button===1:!1}_isStartFly(t){return this.enableFly?!this.enableOrbit&&!this.enablePan?t.button===0||t.button===1||t.button===2:this.enableOrbit?t.button===2:t.button===0:!1}_isStartOrbit(t){return this.enableOrbit?!this.enableFly&&!this.enablePan?t.button===0||t.button===1||t.button===2:t.button===0:!1}_switchToOrbit(){return this.enableOrbit?(this._flying&&(this._flying=!1,this._focusDir(us),this._origin.add(us),this._position.add(us)),this._orbiting=!0,!0):!1}_switchToFly(){return this.enableFly?(this._orbiting&&(this._orbiting=!1,this._zoomDist=this._cameraDist,this._origin.copy(this.entity.getPosition()),this._position.copy(this._origin),this._cameraTransform.setTranslate(0,0,0)),this._flying=!0,!0):!1}_onPointerDown(t){if(!this._camera)return;this._element.setPointerCapture(t.pointerId),this._pointerEvents.set(t.pointerId,t);const s=this.enablePan&&this._pointerEvents.size===2,i=this._isStartMousePan(t),a=this._isStartFly(t),n=this._isStartOrbit(t);this._focusing&&(this._cancelSmoothTransform(),this._focusing=!1),s&&(this._lastPinchDist=this._getPinchDist(),this._getMidPoint(this._lastPosition),this._panning=!0),i&&(this._lastPosition.set(t.clientX,t.clientY),this._panning=!0,this._dragging=!0),a&&(this._switchToFly(),this._dragging=!0),n&&(this._switchToOrbit(),this._dragging=!0)}_onPointerMove(t){if(this._pointerEvents.size!==0){if(this._pointerEvents.set(t.pointerId,t),this._focusing&&(this._cancelSmoothTransform(),this._focusing=!1),this._pointerEvents.size===1){this._panning?this._pan(RN.set(t.clientX,t.clientY)):(this._orbiting||this._flying)&&this._look(t);return}if(this._pointerEvents.size===2){this._panning&&this._pan(this._getMidPoint(RN));const s=this._getPinchDist();this._lastPinchDist>0&&this._zoom((this._lastPinchDist-s)*this.zoomPinchSens),this._lastPinchDist=s}}}_onPointerUp(t){this._element.releasePointerCapture(t.pointerId),this._pointerEvents.delete(t.pointerId),this._pointerEvents.size<2&&(this._lastPinchDist=-1,this._panning=!1),this._panning&&(this._panning=!1),this._dragging&&(this._dragging=!1)}_onWheel(t){t.preventDefault(),this._zoom(t.deltaY)}_onKeyDown(t){switch(t.stopPropagation(),t.key.toLowerCase()){case"w":case"arrowup":this._key.forward=!0;break;case"s":case"arrowdown":this._key.backward=!0;break;case"a":case"arrowleft":this._key.left=!0;break;case"d":case"arrowright":this._key.right=!0;break;case"q":this._key.up=!0;break;case"e":this._key.down=!0;break;case"shift":this._key.sprint=!0;break;case"control":this._key.crouch=!0;break}}_onKeyUp(t){switch(t.stopPropagation(),t.key.toLowerCase()){case"w":case"arrowup":this._key.forward=!1;break;case"s":case"arrowdown":this._key.backward=!1;break;case"a":case"arrowleft":this._key.left=!1;break;case"d":case"arrowright":this._key.right=!1;break;case"q":this._key.up=!1;break;case"e":this._key.down=!1;break;case"shift":this._key.sprint=!1;break;case"control":this._key.crouch=!1;break}}_look(t){if(t.target!==this.app.graphicsDevice.canvas)return;const s=t.movementX||0,i=t.movementY||0;this._dir.x-=i*this.rotateSpeed,this._dir.y-=s*this.rotateSpeed,this._clampAngles(this._dir)}_move(t){if(!this.enableFly)return;us.set(0,0,0),this._key.forward&&us.add(this.entity.forward),this._key.backward&&us.sub(this.entity.forward),this._key.left&&us.sub(this.entity.right),this._key.right&&us.add(this.entity.right),this._key.up&&us.add(this.entity.up),this._key.down&&us.sub(this.entity.up),us.normalize(),this._moving=us.length()>0;const s=this._key.crouch?this.moveSlowSpeed:this._key.sprint?this.moveFastSpeed:this.moveSpeed;us.mulScalar(this.sceneSize*s*t),this._origin.add(us),this._moving&&(this._focusing&&(this._cancelSmoothTransform(),this._focusing=!1),this._clampPosition(this._origin))}_getMidPoint(t){const[s,i]=this._pointerEvents.values(),a=s.clientX-i.clientX,n=s.clientY-i.clientY;return t.set(i.clientX+a*.5,i.clientY+n*.5)}_getPinchDist(){const[t,s]=this._pointerEvents.values(),i=t.clientX-s.clientX,a=t.clientY-s.clientY;return Math.sqrt(i*i+a*a)}_screenToWorldPan(t,s){if(!this._camera)return;const i=this._camera.screenToWorld(t.x,t.y,1),a=this.entity.getPosition(),n=this._focusDir(us),r=$re.add2(a,n),l=n.mulScalar(-1).normalize(),u=eoe.setFromPointNormal(r,l),f=Jre.set(a,i.sub(a).normalize());u.intersectsRay(f,s)}_pan(t){if(!this.enablePan)return;const s=new H,i=new H;this._screenToWorldPan(this._lastPosition,s),this._screenToWorldPan(t,i),us.sub2(s,i),this._origin.add(us),this._lastPosition.copy(t)}_zoom(t){if(!this.enableOrbit&&!this.enablePan||this._flying&&(this._dragging||!this._switchToOrbit())||!this._camera)return;const s=this._zoomDist/(toe*this.sceneSize),i=ge.clamp(s,this.zoomScaleMin,1);this._zoomDist+=t*this.zoomSpeed*this.sceneSize*i,this._zoomDist=this._clampZoom(this._zoomDist)}_smoothZoom(t){const s=t===-1?1:pM(this.zoomDamping,t);this._cameraDist=ge.lerp(this._cameraDist,this._zoomDist,s),this._cameraTransform.setTranslate(0,0,this._cameraDist)}_smoothTransform(t){const s=t===-1?1:pM(this._focusing?this.focusDamping:this.rotateDamping,t),i=t===-1?1:pM(this._focusing?this.focusDamping:this.moveDamping,t);this._angles.x=ge.lerpAngle(this._angles.x%360,this._dir.x%360,s),this._angles.y=ge.lerpAngle(this._angles.y%360,this._dir.y%360,s),this._position.lerp(this._position,this._origin,i),this._baseTransform.setTRS(this._position,Zre.setFromEulerAngles(this._angles),H.ONE);const a=this._position.distance(this._origin)+Math.abs(this._angles.x-this._dir.x)+Math.abs(this._angles.y-this._dir.y);this._focusing&&a<soe&&(this._focusing=!1)}_cancelSmoothZoom(){this._cameraDist=this._zoomDist}_cancelSmoothTransform(){this._origin.copy(this._position),this._dir.set(this._angles.x,this._angles.y)}_updateTransform(){fM.copy(this._baseTransform).mul(this._cameraTransform),this.entity.setPosition(fM.getTranslation()),this.entity.setEulerAngles(fM.getEulerAngles())}focus(t,s,i=!0){if(this._camera&&!(this._flying&&(this._dragging||!this._switchToOrbit()))){if(s){us.sub2(s,t);const a=Math.atan2(us.y,Math.sqrt(us.x*us.x+us.z*us.z))*ge.RAD_TO_DEG,n=Math.atan2(us.x,us.z)*ge.RAD_TO_DEG;this._clampAngles(this._dir.set(-a,n)),this._origin.copy(t),this._cameraTransform.setTranslate(0,0,0);const r=this.entity.getPosition(),l=this.entity.getRotation();this._baseTransform.setTRS(r,l,H.ONE),this._zoomDist=this._clampZoom(us.length()),i||(this._smoothZoom(-1),this._smoothTransform(-1)),this._updateTransform()}else this._origin.copy(t),i||this._position.copy(t);i&&(this._focusing=!0)}}resetZoom(t=0,s=!0){this._zoomDist=t,s||(this._cameraDist=t)}refocus(t,s,i,a=!0){typeof i=="number"&&this.resetZoom(i,a),this.focus(t,s,a)}attach(t){this._camera!==t&&(this._camera=t,this._element.addEventListener("wheel",this._onWheel,MN),this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1))}detach(){this._camera&&(this._element.removeEventListener("wheel",this._onWheel,MN),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("keydown",this._onKeyDown,!1),window.removeEventListener("keyup",this._onKeyUp,!1),this._camera=null,this._cancelSmoothZoom(),this._cancelSmoothTransform(),this._pointerEvents.clear(),this._lastPinchDist=-1,this._panning=!1,this._key={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,sprint:!1,crouch:!1})}update(t){var s;(s=this.app.xr)!=null&&s.active||this._camera&&(this._move(t),this._flying||this._smoothZoom(t),this._smoothTransform(t),this._updateTransform())}destroy(){this.detach()}};rt(Jg,"EVENT_CLAMP_POSITION","clamp:position"),rt(Jg,"EVENT_CLAMP_ANGLES","clamp:angles");let pD=Jg;class ioe extends Rh{constructor(){super(...arguments);rt(this,"basePath","https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets/dist/profiles");rt(this,"controllers",new Map)}initialize(){if(!this.app.xr){console.error("XrControllers script requires XR to be enabled on the application");return}this.app.xr.input.on("add",async t=>{var n;if(!((n=t.profiles)!=null&&n.length)){console.warn("No profiles available for input source");return}const s=t.profiles.map(async r=>{var u;const l=`${this.basePath}/${r}/profile.json`;try{const f=await fetch(l);if(!f.ok)return null;const _=await f.json(),g=((u=_.layouts[t.handedness])==null?void 0:u.assetPath)||"",y=`${this.basePath}/${_.profileId}/${t.handedness}${g.replace(/^\/?(left|right)/,"")}`,v=await new Promise((x,C)=>{this.app.assets.loadFromUrl(y,"container",(M,w)=>{M?C(M):x(w)})});return{profileId:r,asset:v}}catch{return console.warn(`Failed to process profile ${r}`),null}}),a=(await Promise.all(s)).find(r=>r!==null);if(a){const{asset:r}=a,u=r.resource.instantiateRenderEntity();this.app.root.addChild(u);const f=new Map;if(t.hand)for(const _ of t.hand.joints){const g=u.findByName(_.id);g&&f.set(_,g)}this.controllers.set(t,{entity:u,jointMap:f})}else console.warn("No compatible profiles found")}),this.app.xr.input.on("remove",t=>{const s=this.controllers.get(t);s&&(s.entity.destroy(),this.controllers.delete(t))})}update(t){var s;if((s=this.app.xr)!=null&&s.active)for(const[i,{entity:a,jointMap:n}]of this.controllers)if(i.hand)for(const[r,l]of n)l.setPosition(r.getPosition()),l.setRotation(r.getRotation());else a.setPosition(i.getPosition()),a.setRotation(i.getRotation())}}class aoe extends Rh{constructor(){super(...arguments);rt(this,"inputSources",new Set);rt(this,"activePointers",new Map);rt(this,"validColor",new xe(0,1,0));rt(this,"invalidColor",new xe(1,0,0));rt(this,"inputHandlers",new Map)}initialize(){if(!this.app.xr){console.error("XrNavigation script requires XR to be enabled on the application");return}this.app.xr.input.on("add",t=>{const s=()=>{this.activePointers.set(t,!0)},i=()=>{this.activePointers.set(t,!1),this.tryTeleport(t)};t.on("selectstart",s),t.on("selectend",i),this.inputHandlers.set(t,{handleSelectStart:s,handleSelectEnd:i}),this.inputSources.add(t)}),this.app.xr.input.on("remove",t=>{const s=this.inputHandlers.get(t);s&&(t.off("selectstart",s.handleSelectStart),t.off("selectend",s.handleSelectEnd),this.inputHandlers.delete(t)),this.activePointers.delete(t),this.inputSources.delete(t)})}findPlaneIntersection(t,s){if(Math.abs(s.y)<1e-5)return null;const i=-t.y/s.y;return i<0?null:new H(t.x+s.x*i,0,t.z+s.z*i)}tryTeleport(t){const s=t.getOrigin(),i=t.getDirection(),a=this.findPlaneIntersection(s,i);if(a){const n=this.entity.getPosition().y;a.y=n,this.entity.setPosition(a)}}update(){for(const t of this.inputSources){if(!this.activePointers.get(t))continue;const s=t.getOrigin(),i=t.getDirection(),a=this.findPlaneIntersection(s,i);if(a)this.app.drawLine(s,a,this.validColor),this.drawTeleportIndicator(a);else{const n=s.clone().add(i.clone().mulScalar(100));this.app.drawLine(s,n,this.invalidColor)}}}drawTeleportIndicator(t){for(let a=0;a<32;a++){const n=a/32*Math.PI*2,r=(a+1)/32*Math.PI*2,l=t.x+Math.cos(n)*.2,u=t.z+Math.sin(n)*.2,f=t.x+Math.cos(r)*.2,_=t.z+Math.sin(r)*.2;this.app.drawLine(new H(l,.01,u),new H(f,.01,_),this.validColor)}}}var DN=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function JC(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var mM={exports:{}},St={};/**
 * @license React
 * react.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var PN;function noe(){if(PN)return St;PN=1;var h=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),t=Symbol.for("react.fragment"),s=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),a=Symbol.for("react.consumer"),n=Symbol.for("react.context"),r=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),u=Symbol.for("react.memo"),f=Symbol.for("react.lazy"),_=Symbol.iterator;function g(V){return V===null||typeof V!="object"?null:(V=_&&V[_]||V["@@iterator"],typeof V=="function"?V:null)}var y={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},v=Object.assign,x={};function C(V,Q,se){this.props=V,this.context=Q,this.refs=x,this.updater=se||y}C.prototype.isReactComponent={},C.prototype.setState=function(V,Q){if(typeof V!="object"&&typeof V!="function"&&V!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,V,Q,"setState")},C.prototype.forceUpdate=function(V){this.updater.enqueueForceUpdate(this,V,"forceUpdate")};function M(){}M.prototype=C.prototype;function w(V,Q,se){this.props=V,this.context=Q,this.refs=x,this.updater=se||y}var T=w.prototype=new M;T.constructor=w,v(T,C.prototype),T.isPureReactComponent=!0;var R=Array.isArray,D={H:null,A:null,T:null,S:null,V:null},I=Object.prototype.hasOwnProperty;function U(V,Q,se,J,ie,oe){return se=oe.ref,{$$typeof:h,type:V,key:Q,ref:se!==void 0?se:null,props:oe}}function O(V,Q){return U(V.type,Q,void 0,void 0,void 0,V.props)}function N(V){return typeof V=="object"&&V!==null&&V.$$typeof===h}function z(V){var Q={"=":"=0",":":"=2"};return"$"+V.replace(/[=:]/g,function(se){return Q[se]})}var X=/\/+/g;function Y(V,Q){return typeof V=="object"&&V!==null&&V.key!=null?z(""+V.key):Q.toString(36)}function F(){}function q(V){switch(V.status){case"fulfilled":return V.value;case"rejected":throw V.reason;default:switch(typeof V.status=="string"?V.then(F,F):(V.status="pending",V.then(function(Q){V.status==="pending"&&(V.status="fulfilled",V.value=Q)},function(Q){V.status==="pending"&&(V.status="rejected",V.reason=Q)})),V.status){case"fulfilled":return V.value;case"rejected":throw V.reason}}throw V}function G(V,Q,se,J,ie){var oe=typeof V;(oe==="undefined"||oe==="boolean")&&(V=null);var he=!1;if(V===null)he=!0;else switch(oe){case"bigint":case"string":case"number":he=!0;break;case"object":switch(V.$$typeof){case h:case e:he=!0;break;case f:return he=V._init,G(he(V._payload),Q,se,J,ie)}}if(he)return ie=ie(V),he=J===""?"."+Y(V,0):J,R(ie)?(se="",he!=null&&(se=he.replace(X,"$&/")+"/"),G(ie,Q,se,"",function(Se){return Se})):ie!=null&&(N(ie)&&(ie=O(ie,se+(ie.key==null||V&&V.key===ie.key?"":(""+ie.key).replace(X,"$&/")+"/")+he)),Q.push(ie)),1;he=0;var te=J===""?".":J+":";if(R(V))for(var le=0;le<V.length;le++)J=V[le],oe=te+Y(J,le),he+=G(J,Q,se,oe,ie);else if(le=g(V),typeof le=="function")for(V=le.call(V),le=0;!(J=V.next()).done;)J=J.value,oe=te+Y(J,le++),he+=G(J,Q,se,oe,ie);else if(oe==="object"){if(typeof V.then=="function")return G(q(V),Q,se,J,ie);throw Q=String(V),Error("Objects are not valid as a React child (found: "+(Q==="[object Object]"?"object with keys {"+Object.keys(V).join(", ")+"}":Q)+"). If you meant to render a collection of children, use an array instead.")}return he}function W(V,Q,se){if(V==null)return V;var J=[],ie=0;return G(V,J,"","",function(oe){return Q.call(se,oe,ie++)}),J}function k(V){if(V._status===-1){var Q=V._result;Q=Q(),Q.then(function(se){(V._status===0||V._status===-1)&&(V._status=1,V._result=se)},function(se){(V._status===0||V._status===-1)&&(V._status=2,V._result=se)}),V._status===-1&&(V._status=0,V._result=Q)}if(V._status===1)return V._result.default;throw V._result}var K=typeof reportError=="function"?reportError:function(V){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var Q=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof V=="object"&&V!==null&&typeof V.message=="string"?String(V.message):String(V),error:V});if(!window.dispatchEvent(Q))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",V);return}console.error(V)};function ee(){}return St.Children={map:W,forEach:function(V,Q,se){W(V,function(){Q.apply(this,arguments)},se)},count:function(V){var Q=0;return W(V,function(){Q++}),Q},toArray:function(V){return W(V,function(Q){return Q})||[]},only:function(V){if(!N(V))throw Error("React.Children.only expected to receive a single React element child.");return V}},St.Component=C,St.Fragment=t,St.Profiler=i,St.PureComponent=w,St.StrictMode=s,St.Suspense=l,St.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=D,St.__COMPILER_RUNTIME={__proto__:null,c:function(V){return D.H.useMemoCache(V)}},St.cache=function(V){return function(){return V.apply(null,arguments)}},St.cloneElement=function(V,Q,se){if(V==null)throw Error("The argument must be a React element, but you passed "+V+".");var J=v({},V.props),ie=V.key,oe=void 0;if(Q!=null)for(he in Q.ref!==void 0&&(oe=void 0),Q.key!==void 0&&(ie=""+Q.key),Q)!I.call(Q,he)||he==="key"||he==="__self"||he==="__source"||he==="ref"&&Q.ref===void 0||(J[he]=Q[he]);var he=arguments.length-2;if(he===1)J.children=se;else if(1<he){for(var te=Array(he),le=0;le<he;le++)te[le]=arguments[le+2];J.children=te}return U(V.type,ie,void 0,void 0,oe,J)},St.createContext=function(V){return V={$$typeof:n,_currentValue:V,_currentValue2:V,_threadCount:0,Provider:null,Consumer:null},V.Provider=V,V.Consumer={$$typeof:a,_context:V},V},St.createElement=function(V,Q,se){var J,ie={},oe=null;if(Q!=null)for(J in Q.key!==void 0&&(oe=""+Q.key),Q)I.call(Q,J)&&J!=="key"&&J!=="__self"&&J!=="__source"&&(ie[J]=Q[J]);var he=arguments.length-2;if(he===1)ie.children=se;else if(1<he){for(var te=Array(he),le=0;le<he;le++)te[le]=arguments[le+2];ie.children=te}if(V&&V.defaultProps)for(J in he=V.defaultProps,he)ie[J]===void 0&&(ie[J]=he[J]);return U(V,oe,void 0,void 0,null,ie)},St.createRef=function(){return{current:null}},St.forwardRef=function(V){return{$$typeof:r,render:V}},St.isValidElement=N,St.lazy=function(V){return{$$typeof:f,_payload:{_status:-1,_result:V},_init:k}},St.memo=function(V,Q){return{$$typeof:u,type:V,compare:Q===void 0?null:Q}},St.startTransition=function(V){var Q=D.T,se={};D.T=se;try{var J=V(),ie=D.S;ie!==null&&ie(se,J),typeof J=="object"&&J!==null&&typeof J.then=="function"&&J.then(ee,K)}catch(oe){K(oe)}finally{D.T=Q}},St.unstable_useCacheRefresh=function(){return D.H.useCacheRefresh()},St.use=function(V){return D.H.use(V)},St.useActionState=function(V,Q,se){return D.H.useActionState(V,Q,se)},St.useCallback=function(V,Q){return D.H.useCallback(V,Q)},St.useContext=function(V){return D.H.useContext(V)},St.useDebugValue=function(){},St.useDeferredValue=function(V,Q){return D.H.useDeferredValue(V,Q)},St.useEffect=function(V,Q,se){var J=D.H;if(typeof se=="function")throw Error("useEffect CRUD overload is not enabled in this build of React.");return J.useEffect(V,Q)},St.useId=function(){return D.H.useId()},St.useImperativeHandle=function(V,Q,se){return D.H.useImperativeHandle(V,Q,se)},St.useInsertionEffect=function(V,Q){return D.H.useInsertionEffect(V,Q)},St.useLayoutEffect=function(V,Q){return D.H.useLayoutEffect(V,Q)},St.useMemo=function(V,Q){return D.H.useMemo(V,Q)},St.useOptimistic=function(V,Q){return D.H.useOptimistic(V,Q)},St.useReducer=function(V,Q,se){return D.H.useReducer(V,Q,se)},St.useRef=function(V){return D.H.useRef(V)},St.useState=function(V){return D.H.useState(V)},St.useSyncExternalStore=function(V,Q,se){return D.H.useSyncExternalStore(V,Q,se)},St.useTransition=function(){return D.H.useTransition()},St.version="19.1.0",St}var LN;function ew(){return LN||(LN=1,mM.exports=noe()),mM.exports}var ds=ew();const Ci=JC(ds);var _M={exports:{}},uS={},gM={exports:{}},yM={};/**
 * @license React
 * scheduler.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var IN;function roe(){return IN||(IN=1,function(h){function e(W,k){var K=W.length;W.push(k);e:for(;0<K;){var ee=K-1>>>1,V=W[ee];if(0<i(V,k))W[ee]=k,W[K]=V,K=ee;else break e}}function t(W){return W.length===0?null:W[0]}function s(W){if(W.length===0)return null;var k=W[0],K=W.pop();if(K!==k){W[0]=K;e:for(var ee=0,V=W.length,Q=V>>>1;ee<Q;){var se=2*(ee+1)-1,J=W[se],ie=se+1,oe=W[ie];if(0>i(J,K))ie<V&&0>i(oe,J)?(W[ee]=oe,W[ie]=K,ee=ie):(W[ee]=J,W[se]=K,ee=se);else if(ie<V&&0>i(oe,K))W[ee]=oe,W[ie]=K,ee=ie;else break e}}return k}function i(W,k){var K=W.sortIndex-k.sortIndex;return K!==0?K:W.id-k.id}if(h.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var a=performance;h.unstable_now=function(){return a.now()}}else{var n=Date,r=n.now();h.unstable_now=function(){return n.now()-r}}var l=[],u=[],f=1,_=null,g=3,y=!1,v=!1,x=!1,C=!1,M=typeof setTimeout=="function"?setTimeout:null,w=typeof clearTimeout=="function"?clearTimeout:null,T=typeof setImmediate<"u"?setImmediate:null;function R(W){for(var k=t(u);k!==null;){if(k.callback===null)s(u);else if(k.startTime<=W)s(u),k.sortIndex=k.expirationTime,e(l,k);else break;k=t(u)}}function D(W){if(x=!1,R(W),!v)if(t(l)!==null)v=!0,I||(I=!0,Y());else{var k=t(u);k!==null&&G(D,k.startTime-W)}}var I=!1,U=-1,O=5,N=-1;function z(){return C?!0:!(h.unstable_now()-N<O)}function X(){if(C=!1,I){var W=h.unstable_now();N=W;var k=!0;try{e:{v=!1,x&&(x=!1,w(U),U=-1),y=!0;var K=g;try{t:{for(R(W),_=t(l);_!==null&&!(_.expirationTime>W&&z());){var ee=_.callback;if(typeof ee=="function"){_.callback=null,g=_.priorityLevel;var V=ee(_.expirationTime<=W);if(W=h.unstable_now(),typeof V=="function"){_.callback=V,R(W),k=!0;break t}_===t(l)&&s(l),R(W)}else s(l);_=t(l)}if(_!==null)k=!0;else{var Q=t(u);Q!==null&&G(D,Q.startTime-W),k=!1}}break e}finally{_=null,g=K,y=!1}k=void 0}}finally{k?Y():I=!1}}}var Y;if(typeof T=="function")Y=function(){T(X)};else if(typeof MessageChannel<"u"){var F=new MessageChannel,q=F.port2;F.port1.onmessage=X,Y=function(){q.postMessage(null)}}else Y=function(){M(X,0)};function G(W,k){U=M(function(){W(h.unstable_now())},k)}h.unstable_IdlePriority=5,h.unstable_ImmediatePriority=1,h.unstable_LowPriority=4,h.unstable_NormalPriority=3,h.unstable_Profiling=null,h.unstable_UserBlockingPriority=2,h.unstable_cancelCallback=function(W){W.callback=null},h.unstable_forceFrameRate=function(W){0>W||125<W?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):O=0<W?Math.floor(1e3/W):5},h.unstable_getCurrentPriorityLevel=function(){return g},h.unstable_next=function(W){switch(g){case 1:case 2:case 3:var k=3;break;default:k=g}var K=g;g=k;try{return W()}finally{g=K}},h.unstable_requestPaint=function(){C=!0},h.unstable_runWithPriority=function(W,k){switch(W){case 1:case 2:case 3:case 4:case 5:break;default:W=3}var K=g;g=W;try{return k()}finally{g=K}},h.unstable_scheduleCallback=function(W,k,K){var ee=h.unstable_now();switch(typeof K=="object"&&K!==null?(K=K.delay,K=typeof K=="number"&&0<K?ee+K:ee):K=ee,W){case 1:var V=-1;break;case 2:V=250;break;case 5:V=1073741823;break;case 4:V=1e4;break;default:V=5e3}return V=K+V,W={id:f++,callback:k,priorityLevel:W,startTime:K,expirationTime:V,sortIndex:-1},K>ee?(W.sortIndex=K,e(u,W),t(l)===null&&W===t(u)&&(x?(w(U),U=-1):x=!0,G(D,K-ee))):(W.sortIndex=V,e(l,W),v||y||(v=!0,I||(I=!0,Y()))),W},h.unstable_shouldYield=z,h.unstable_wrapCallback=function(W){var k=g;return function(){var K=g;g=k;try{return W.apply(this,arguments)}finally{g=K}}}}(yM)),yM}var ON;function TL(){return ON||(ON=1,gM.exports=roe()),gM.exports}var vM={exports:{}},Wa={};/**
 * @license React
 * react-dom.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var NN;function ooe(){if(NN)return Wa;NN=1;var h=ew();function e(l){var u="https://react.dev/errors/"+l;if(1<arguments.length){u+="?args[]="+encodeURIComponent(arguments[1]);for(var f=2;f<arguments.length;f++)u+="&args[]="+encodeURIComponent(arguments[f])}return"Minified React error #"+l+"; visit "+u+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function t(){}var s={d:{f:t,r:function(){throw Error(e(522))},D:t,C:t,L:t,m:t,X:t,S:t,M:t},p:0,findDOMNode:null},i=Symbol.for("react.portal");function a(l,u,f){var _=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:i,key:_==null?null:""+_,children:l,containerInfo:u,implementation:f}}var n=h.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function r(l,u){if(l==="font")return"";if(typeof u=="string")return u==="use-credentials"?u:""}return Wa.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=s,Wa.createPortal=function(l,u){var f=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!u||u.nodeType!==1&&u.nodeType!==9&&u.nodeType!==11)throw Error(e(299));return a(l,u,null,f)},Wa.flushSync=function(l){var u=n.T,f=s.p;try{if(n.T=null,s.p=2,l)return l()}finally{n.T=u,s.p=f,s.d.f()}},Wa.preconnect=function(l,u){typeof l=="string"&&(u?(u=u.crossOrigin,u=typeof u=="string"?u==="use-credentials"?u:"":void 0):u=null,s.d.C(l,u))},Wa.prefetchDNS=function(l){typeof l=="string"&&s.d.D(l)},Wa.preinit=function(l,u){if(typeof l=="string"&&u&&typeof u.as=="string"){var f=u.as,_=r(f,u.crossOrigin),g=typeof u.integrity=="string"?u.integrity:void 0,y=typeof u.fetchPriority=="string"?u.fetchPriority:void 0;f==="style"?s.d.S(l,typeof u.precedence=="string"?u.precedence:void 0,{crossOrigin:_,integrity:g,fetchPriority:y}):f==="script"&&s.d.X(l,{crossOrigin:_,integrity:g,fetchPriority:y,nonce:typeof u.nonce=="string"?u.nonce:void 0})}},Wa.preinitModule=function(l,u){if(typeof l=="string")if(typeof u=="object"&&u!==null){if(u.as==null||u.as==="script"){var f=r(u.as,u.crossOrigin);s.d.M(l,{crossOrigin:f,integrity:typeof u.integrity=="string"?u.integrity:void 0,nonce:typeof u.nonce=="string"?u.nonce:void 0})}}else u==null&&s.d.M(l)},Wa.preload=function(l,u){if(typeof l=="string"&&typeof u=="object"&&u!==null&&typeof u.as=="string"){var f=u.as,_=r(f,u.crossOrigin);s.d.L(l,f,{crossOrigin:_,integrity:typeof u.integrity=="string"?u.integrity:void 0,nonce:typeof u.nonce=="string"?u.nonce:void 0,type:typeof u.type=="string"?u.type:void 0,fetchPriority:typeof u.fetchPriority=="string"?u.fetchPriority:void 0,referrerPolicy:typeof u.referrerPolicy=="string"?u.referrerPolicy:void 0,imageSrcSet:typeof u.imageSrcSet=="string"?u.imageSrcSet:void 0,imageSizes:typeof u.imageSizes=="string"?u.imageSizes:void 0,media:typeof u.media=="string"?u.media:void 0})}},Wa.preloadModule=function(l,u){if(typeof l=="string")if(u){var f=r(u.as,u.crossOrigin);s.d.m(l,{as:typeof u.as=="string"&&u.as!=="script"?u.as:void 0,crossOrigin:f,integrity:typeof u.integrity=="string"?u.integrity:void 0})}else s.d.m(l)},Wa.requestFormReset=function(l){s.d.r(l)},Wa.unstable_batchedUpdates=function(l,u){return l(u)},Wa.useFormState=function(l,u,f){return n.H.useFormState(l,u,f)},Wa.useFormStatus=function(){return n.H.useHostTransitionStatus()},Wa.version="19.1.0",Wa}var FN;function loe(){if(FN)return vM.exports;FN=1;function h(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(h)}catch(e){console.error(e)}}return h(),vM.exports=ooe(),vM.exports}/**
 * @license React
 * react-dom-client.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var BN;function hoe(){if(BN)return uS;BN=1;var h=TL(),e=ew(),t=loe();function s(o){var c="https://react.dev/errors/"+o;if(1<arguments.length){c+="?args[]="+encodeURIComponent(arguments[1]);for(var m=2;m<arguments.length;m++)c+="&args[]="+encodeURIComponent(arguments[m])}return"Minified React error #"+o+"; visit "+c+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function i(o){return!(!o||o.nodeType!==1&&o.nodeType!==9&&o.nodeType!==11)}function a(o){var c=o,m=o;if(o.alternate)for(;c.return;)c=c.return;else{o=c;do c=o,(c.flags&4098)!==0&&(m=c.return),o=c.return;while(o)}return c.tag===3?m:null}function n(o){if(o.tag===13){var c=o.memoizedState;if(c===null&&(o=o.alternate,o!==null&&(c=o.memoizedState)),c!==null)return c.dehydrated}return null}function r(o){if(a(o)!==o)throw Error(s(188))}function l(o){var c=o.alternate;if(!c){if(c=a(o),c===null)throw Error(s(188));return c!==o?null:o}for(var m=o,S=c;;){var E=m.return;if(E===null)break;var P=E.alternate;if(P===null){if(S=E.return,S!==null){m=S;continue}break}if(E.child===P.child){for(P=E.child;P;){if(P===m)return r(E),o;if(P===S)return r(E),c;P=P.sibling}throw Error(s(188))}if(m.return!==S.return)m=E,S=P;else{for(var j=!1,$=E.child;$;){if($===m){j=!0,m=E,S=P;break}if($===S){j=!0,S=E,m=P;break}$=$.sibling}if(!j){for($=P.child;$;){if($===m){j=!0,m=P,S=E;break}if($===S){j=!0,S=P,m=E;break}$=$.sibling}if(!j)throw Error(s(189))}}if(m.alternate!==S)throw Error(s(190))}if(m.tag!==3)throw Error(s(188));return m.stateNode.current===m?o:c}function u(o){var c=o.tag;if(c===5||c===26||c===27||c===6)return o;for(o=o.child;o!==null;){if(c=u(o),c!==null)return c;o=o.sibling}return null}var f=Object.assign,_=Symbol.for("react.element"),g=Symbol.for("react.transitional.element"),y=Symbol.for("react.portal"),v=Symbol.for("react.fragment"),x=Symbol.for("react.strict_mode"),C=Symbol.for("react.profiler"),M=Symbol.for("react.provider"),w=Symbol.for("react.consumer"),T=Symbol.for("react.context"),R=Symbol.for("react.forward_ref"),D=Symbol.for("react.suspense"),I=Symbol.for("react.suspense_list"),U=Symbol.for("react.memo"),O=Symbol.for("react.lazy"),N=Symbol.for("react.activity"),z=Symbol.for("react.memo_cache_sentinel"),X=Symbol.iterator;function Y(o){return o===null||typeof o!="object"?null:(o=X&&o[X]||o["@@iterator"],typeof o=="function"?o:null)}var F=Symbol.for("react.client.reference");function q(o){if(o==null)return null;if(typeof o=="function")return o.$$typeof===F?null:o.displayName||o.name||null;if(typeof o=="string")return o;switch(o){case v:return"Fragment";case C:return"Profiler";case x:return"StrictMode";case D:return"Suspense";case I:return"SuspenseList";case N:return"Activity"}if(typeof o=="object")switch(o.$$typeof){case y:return"Portal";case T:return(o.displayName||"Context")+".Provider";case w:return(o._context.displayName||"Context")+".Consumer";case R:var c=o.render;return o=o.displayName,o||(o=c.displayName||c.name||"",o=o!==""?"ForwardRef("+o+")":"ForwardRef"),o;case U:return c=o.displayName||null,c!==null?c:q(o.type)||"Memo";case O:c=o._payload,o=o._init;try{return q(o(c))}catch{}}return null}var G=Array.isArray,W=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,k=t.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,K={pending:!1,data:null,method:null,action:null},ee=[],V=-1;function Q(o){return{current:o}}function se(o){0>V||(o.current=ee[V],ee[V]=null,V--)}function J(o,c){V++,ee[V]=o.current,o.current=c}var ie=Q(null),oe=Q(null),he=Q(null),te=Q(null);function le(o,c){switch(J(he,c),J(oe,o),J(ie,null),c.nodeType){case 9:case 11:o=(o=c.documentElement)&&(o=o.namespaceURI)?jL(o):0;break;default:if(o=c.tagName,c=c.namespaceURI)c=jL(c),o=YL(c,o);else switch(o){case"svg":o=1;break;case"math":o=2;break;default:o=0}}se(ie),J(ie,o)}function Se(){se(ie),se(oe),se(he)}function Ae(o){o.memoizedState!==null&&J(te,o);var c=ie.current,m=YL(c,o.type);c!==m&&(J(oe,o),J(ie,m))}function De(o){oe.current===o&&(se(ie),se(oe)),te.current===o&&(se(te),Fv._currentValue=K)}var Fe=Object.prototype.hasOwnProperty,ot=h.unstable_scheduleCallback,mt=h.unstable_cancelCallback,$e=h.unstable_shouldYield,es=h.unstable_requestPaint,ht=h.unstable_now,Pe=h.unstable_getCurrentPriorityLevel,Zi=h.unstable_ImmediatePriority,zs=h.unstable_UserBlockingPriority,oi=h.unstable_NormalPriority,lt=h.unstable_LowPriority,ti=h.unstable_IdlePriority,js=h.log,Ys=h.unstable_setDisableYieldValue,Xe=null,Mt=null;function rs(o){if(typeof js=="function"&&Ys(o),Mt&&typeof Mt.setStrictMode=="function")try{Mt.setStrictMode(Xe,o)}catch{}}var bs=Math.clz32?Math.clz32:Hi,sn=Math.log,La=Math.LN2;function Hi(o){return o>>>=0,o===0?32:31-(sn(o)/La|0)|0}var Wi=256,Ji=4194304;function an(o){var c=o&42;if(c!==0)return c;switch(o&-o){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return o&4194048;case 4194304:case 8388608:case 16777216:case 33554432:return o&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return o}}function su(o,c,m){var S=o.pendingLanes;if(S===0)return 0;var E=0,P=o.suspendedLanes,j=o.pingedLanes;o=o.warmLanes;var $=S&134217727;return $!==0?(S=$&~P,S!==0?E=an(S):(j&=$,j!==0?E=an(j):m||(m=$&~o,m!==0&&(E=an(m))))):($=S&~P,$!==0?E=an($):j!==0?E=an(j):m||(m=S&~o,m!==0&&(E=an(m)))),E===0?0:c!==0&&c!==E&&(c&P)===0&&(P=E&-E,m=c&-c,P>=m||P===32&&(m&4194048)!==0)?c:E}function iu(o,c){return(o.pendingLanes&~(o.suspendedLanes&~o.pingedLanes)&c)===0}function nw(o,c){switch(o){case 1:case 2:case 4:case 8:case 64:return c+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return c+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function km(){var o=Wi;return Wi<<=1,(Wi&4194048)===0&&(Wi=256),o}function nf(){var o=Ji;return Ji<<=1,(Ji&62914560)===0&&(Ji=4194304),o}function Vm(o){for(var c=[],m=0;31>m;m++)c.push(o);return c}function yl(o,c){o.pendingLanes|=c,c!==268435456&&(o.suspendedLanes=0,o.pingedLanes=0,o.warmLanes=0)}function wx(o,c,m,S,E,P){var j=o.pendingLanes;o.pendingLanes=m,o.suspendedLanes=0,o.pingedLanes=0,o.warmLanes=0,o.expiredLanes&=m,o.entangledLanes&=m,o.errorRecoveryDisabledLanes&=m,o.shellSuspendCounter=0;var $=o.entanglements,ae=o.expirationTimes,pe=o.hiddenUpdates;for(m=j&~m;0<m;){var be=31-bs(m),Ce=1<<be;$[be]=0,ae[be]=-1;var _e=pe[be];if(_e!==null)for(pe[be]=null,be=0;be<_e.length;be++){var ye=_e[be];ye!==null&&(ye.lane&=-536870913)}m&=~Ce}S!==0&&rf(o,S,0),P!==0&&E===0&&o.tag!==0&&(o.suspendedLanes|=P&~(j&~c))}function rf(o,c,m){o.pendingLanes|=c,o.suspendedLanes&=~c;var S=31-bs(c);o.entangledLanes|=c,o.entanglements[S]=o.entanglements[S]|1073741824|m&4194090}function my(o,c){var m=o.entangledLanes|=c;for(o=o.entanglements;m;){var S=31-bs(m),E=1<<S;E&c|o[S]&c&&(o[S]|=c),m&=~E}}function Gm(o){switch(o){case 2:o=1;break;case 8:o=4;break;case 32:o=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:o=128;break;case 268435456:o=134217728;break;default:o=0}return o}function Hm(o){return o&=-o,2<o?8<o?(o&134217727)!==0?32:268435456:8:2}function of(){var o=k.p;return o!==0?o:(o=window.event,o===void 0?32:fI(o.type))}function Wm(o,c){var m=k.p;try{return k.p=o,c()}finally{k.p=m}}var Tr=Math.random().toString(36).slice(2),si="__reactFiber$"+Tr,_a="__reactProps$"+Tr,_o="__reactContainer$"+Tr,lf="__reactEvents$"+Tr,_y="__reactListeners$"+Tr,vl="__reactHandles$"+Tr,go="__reactResources$"+Tr,yo="__reactMarker$"+Tr;function hf(o){delete o[si],delete o[_a],delete o[lf],delete o[_y],delete o[vl]}function Er(o){var c=o[si];if(c)return c;for(var m=o.parentNode;m;){if(c=m[_o]||m[si]){if(m=c.alternate,c.child!==null||m!==null&&m.child!==null)for(o=ZL(o);o!==null;){if(m=o[si])return m;o=ZL(o)}return c}o=m,m=o.parentNode}return null}function Ar(o){if(o=o[si]||o[_o]){var c=o.tag;if(c===5||c===6||c===13||c===26||c===27||c===3)return o}return null}function au(o){var c=o.tag;if(c===5||c===26||c===27||c===6)return o.stateNode;throw Error(s(33))}function Ih(o){var c=o[go];return c||(c=o[go]={hoistableStyles:new Map,hoistableScripts:new Map}),c}function gi(o){o[yo]=!0}var qm=new Set,Xm={};function ys(o,c){Sl(o,c),Sl(o+"Capture",c)}function Sl(o,c){for(Xm[o]=c,o=0;o<c.length;o++)qm.add(c[o])}var gy=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),yy={},vy={};function rw(o){return Fe.call(vy,o)?!0:Fe.call(yy,o)?!1:gy.test(o)?vy[o]=!0:(yy[o]=!0,!1)}function nu(o,c,m){if(rw(c))if(m===null)o.removeAttribute(c);else{switch(typeof m){case"undefined":case"function":case"symbol":o.removeAttribute(c);return;case"boolean":var S=c.toLowerCase().slice(0,5);if(S!=="data-"&&S!=="aria-"){o.removeAttribute(c);return}}o.setAttribute(c,""+m)}}function ru(o,c,m){if(m===null)o.removeAttribute(c);else{switch(typeof m){case"undefined":case"function":case"symbol":case"boolean":o.removeAttribute(c);return}o.setAttribute(c,""+m)}}function Yn(o,c,m,S){if(S===null)o.removeAttribute(m);else{switch(typeof S){case"undefined":case"function":case"symbol":case"boolean":o.removeAttribute(m);return}o.setAttributeNS(c,m,""+S)}}var ea,ii;function bl(o){if(ea===void 0)try{throw Error()}catch(m){var c=m.stack.trim().match(/\n( *(at )?)/);ea=c&&c[1]||"",ii=-1<m.stack.indexOf(`
    at`)?" (<anonymous>)":-1<m.stack.indexOf("@")?"@unknown:0:0":""}return`
`+ea+o+ii}var Oh=!1;function ou(o,c){if(!o||Oh)return"";Oh=!0;var m=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var S={DetermineComponentFrameRoot:function(){try{if(c){var Ce=function(){throw Error()};if(Object.defineProperty(Ce.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(Ce,[])}catch(ye){var _e=ye}Reflect.construct(o,[],Ce)}else{try{Ce.call()}catch(ye){_e=ye}o.call(Ce.prototype)}}else{try{throw Error()}catch(ye){_e=ye}(Ce=o())&&typeof Ce.catch=="function"&&Ce.catch(function(){})}}catch(ye){if(ye&&_e&&typeof ye.stack=="string")return[ye.stack,_e.stack]}return[null,null]}};S.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var E=Object.getOwnPropertyDescriptor(S.DetermineComponentFrameRoot,"name");E&&E.configurable&&Object.defineProperty(S.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var P=S.DetermineComponentFrameRoot(),j=P[0],$=P[1];if(j&&$){var ae=j.split(`
`),pe=$.split(`
`);for(E=S=0;S<ae.length&&!ae[S].includes("DetermineComponentFrameRoot");)S++;for(;E<pe.length&&!pe[E].includes("DetermineComponentFrameRoot");)E++;if(S===ae.length||E===pe.length)for(S=ae.length-1,E=pe.length-1;1<=S&&0<=E&&ae[S]!==pe[E];)E--;for(;1<=S&&0<=E;S--,E--)if(ae[S]!==pe[E]){if(S!==1||E!==1)do if(S--,E--,0>E||ae[S]!==pe[E]){var be=`
`+ae[S].replace(" at new "," at ");return o.displayName&&be.includes("<anonymous>")&&(be=be.replace("<anonymous>",o.displayName)),be}while(1<=S&&0<=E);break}}}finally{Oh=!1,Error.prepareStackTrace=m}return(m=o?o.displayName||o.name:"")?bl(m):""}function Sy(o){switch(o.tag){case 26:case 27:case 5:return bl(o.type);case 16:return bl("Lazy");case 13:return bl("Suspense");case 19:return bl("SuspenseList");case 0:case 15:return ou(o.type,!1);case 11:return ou(o.type.render,!1);case 1:return ou(o.type,!0);case 31:return bl("Activity");default:return""}}function Cr(o){try{var c="";do c+=Sy(o),o=o.return;while(o);return c}catch(m){return`
Error generating stack: `+m.message+`
`+m.stack}}function ga(o){switch(typeof o){case"bigint":case"boolean":case"number":case"string":case"undefined":return o;case"object":return o;default:return""}}function jm(o){var c=o.type;return(o=o.nodeName)&&o.toLowerCase()==="input"&&(c==="checkbox"||c==="radio")}function by(o){var c=jm(o)?"checked":"value",m=Object.getOwnPropertyDescriptor(o.constructor.prototype,c),S=""+o[c];if(!o.hasOwnProperty(c)&&typeof m<"u"&&typeof m.get=="function"&&typeof m.set=="function"){var E=m.get,P=m.set;return Object.defineProperty(o,c,{configurable:!0,get:function(){return E.call(this)},set:function(j){S=""+j,P.call(this,j)}}),Object.defineProperty(o,c,{enumerable:m.enumerable}),{getValue:function(){return S},setValue:function(j){S=""+j},stopTracking:function(){o._valueTracker=null,delete o[c]}}}}function cf(o){o._valueTracker||(o._valueTracker=by(o))}function xy(o){if(!o)return!1;var c=o._valueTracker;if(!c)return!0;var m=c.getValue(),S="";return o&&(S=jm(o)?o.checked?"true":"false":o.value),o=S,o!==m?(c.setValue(o),!0):!1}function uf(o){if(o=o||(typeof document<"u"?document:void 0),typeof o>"u")return null;try{return o.activeElement||o.body}catch{return o.body}}var Rx=/[\n"\\]/g;function nn(o){return o.replace(Rx,function(c){return"\\"+c.charCodeAt(0).toString(16)+" "})}function Ym(o,c,m,S,E,P,j,$){o.name="",j!=null&&typeof j!="function"&&typeof j!="symbol"&&typeof j!="boolean"?o.type=j:o.removeAttribute("type"),c!=null?j==="number"?(c===0&&o.value===""||o.value!=c)&&(o.value=""+ga(c)):o.value!==""+ga(c)&&(o.value=""+ga(c)):j!=="submit"&&j!=="reset"||o.removeAttribute("value"),c!=null?Qm(o,j,ga(c)):m!=null?Qm(o,j,ga(m)):S!=null&&o.removeAttribute("value"),E==null&&P!=null&&(o.defaultChecked=!!P),E!=null&&(o.checked=E&&typeof E!="function"&&typeof E!="symbol"),$!=null&&typeof $!="function"&&typeof $!="symbol"&&typeof $!="boolean"?o.name=""+ga($):o.removeAttribute("name")}function Km(o,c,m,S,E,P,j,$){if(P!=null&&typeof P!="function"&&typeof P!="symbol"&&typeof P!="boolean"&&(o.type=P),c!=null||m!=null){if(!(P!=="submit"&&P!=="reset"||c!=null))return;m=m!=null?""+ga(m):"",c=c!=null?""+ga(c):m,$||c===o.value||(o.value=c),o.defaultValue=c}S=S??E,S=typeof S!="function"&&typeof S!="symbol"&&!!S,o.checked=$?o.checked:!!S,o.defaultChecked=!!S,j!=null&&typeof j!="function"&&typeof j!="symbol"&&typeof j!="boolean"&&(o.name=j)}function Qm(o,c,m){c==="number"&&uf(o.ownerDocument)===o||o.defaultValue===""+m||(o.defaultValue=""+m)}function lu(o,c,m,S){if(o=o.options,c){c={};for(var E=0;E<m.length;E++)c["$"+m[E]]=!0;for(m=0;m<o.length;m++)E=c.hasOwnProperty("$"+o[m].value),o[m].selected!==E&&(o[m].selected=E),E&&S&&(o[m].defaultSelected=!0)}else{for(m=""+ga(m),c=null,E=0;E<o.length;E++){if(o[E].value===m){o[E].selected=!0,S&&(o[E].defaultSelected=!0);return}c!==null||o[E].disabled||(c=o[E])}c!==null&&(c.selected=!0)}}function Ty(o,c,m){if(c!=null&&(c=""+ga(c),c!==o.value&&(o.value=c),m==null)){o.defaultValue!==c&&(o.defaultValue=c);return}o.defaultValue=m!=null?""+ga(m):""}function Ey(o,c,m,S){if(c==null){if(S!=null){if(m!=null)throw Error(s(92));if(G(S)){if(1<S.length)throw Error(s(93));S=S[0]}m=S}m==null&&(m=""),c=m}m=ga(c),o.defaultValue=m,S=o.textContent,S===m&&S!==""&&S!==null&&(o.value=S)}function Nh(o,c){if(c){var m=o.firstChild;if(m&&m===o.lastChild&&m.nodeType===3){m.nodeValue=c;return}}o.textContent=c}var Ay=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function Cy(o,c,m){var S=c.indexOf("--")===0;m==null||typeof m=="boolean"||m===""?S?o.setProperty(c,""):c==="float"?o.cssFloat="":o[c]="":S?o.setProperty(c,m):typeof m!="number"||m===0||Ay.has(c)?c==="float"?o.cssFloat=m:o[c]=(""+m).trim():o[c]=m+"px"}function wy(o,c,m){if(c!=null&&typeof c!="object")throw Error(s(62));if(o=o.style,m!=null){for(var S in m)!m.hasOwnProperty(S)||c!=null&&c.hasOwnProperty(S)||(S.indexOf("--")===0?o.setProperty(S,""):S==="float"?o.cssFloat="":o[S]="");for(var E in c)S=c[E],c.hasOwnProperty(E)&&m[E]!==S&&Cy(o,E,S)}else for(var P in c)c.hasOwnProperty(P)&&Cy(o,P,c[P])}function $m(o){if(o.indexOf("-")===-1)return!1;switch(o){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Mx=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),Dx=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function Zm(o){return Dx.test(""+o)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":o}var Jm=null;function xl(o){return o=o.target||o.srcElement||window,o.correspondingUseElement&&(o=o.correspondingUseElement),o.nodeType===3?o.parentNode:o}var vo=null,Fh=null;function df(o){var c=Ar(o);if(c&&(o=c.stateNode)){var m=o[_a]||null;e:switch(o=c.stateNode,c.type){case"input":if(Ym(o,m.value,m.defaultValue,m.defaultValue,m.checked,m.defaultChecked,m.type,m.name),c=m.name,m.type==="radio"&&c!=null){for(m=o;m.parentNode;)m=m.parentNode;for(m=m.querySelectorAll('input[name="'+nn(""+c)+'"][type="radio"]'),c=0;c<m.length;c++){var S=m[c];if(S!==o&&S.form===o.form){var E=S[_a]||null;if(!E)throw Error(s(90));Ym(S,E.value,E.defaultValue,E.defaultValue,E.checked,E.defaultChecked,E.type,E.name)}}for(c=0;c<m.length;c++)S=m[c],S.form===o.form&&xy(S)}break e;case"textarea":Ty(o,m.value,m.defaultValue);break e;case"select":c=m.value,c!=null&&lu(o,!!m.multiple,c,!1)}}}var Bh=!1;function Ry(o,c,m){if(Bh)return o(c,m);Bh=!0;try{var S=o(c);return S}finally{if(Bh=!1,(vo!==null||Fh!==null)&&($l(),vo&&(c=vo,o=Fh,Fh=vo=null,df(c),o)))for(c=0;c<o.length;c++)df(o[c])}}function hu(o,c){var m=o.stateNode;if(m===null)return null;var S=m[_a]||null;if(S===null)return null;m=S[c];e:switch(c){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(S=!S.disabled)||(o=o.type,S=!(o==="button"||o==="input"||o==="select"||o==="textarea")),o=!S;break e;default:o=!1}if(o)return null;if(m&&typeof m!="function")throw Error(s(231,c,typeof m));return m}var wr=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),e_=!1;if(wr)try{var cu={};Object.defineProperty(cu,"passive",{get:function(){e_=!0}}),window.addEventListener("test",cu,cu),window.removeEventListener("test",cu,cu)}catch{e_=!1}var So=null,ff=null,pf=null;function My(){if(pf)return pf;var o,c=ff,m=c.length,S,E="value"in So?So.value:So.textContent,P=E.length;for(o=0;o<m&&c[o]===E[o];o++);var j=m-o;for(S=1;S<=j&&c[m-S]===E[P-S];S++);return pf=E.slice(o,1<S?1-S:void 0)}function uu(o){var c=o.keyCode;return"charCode"in o?(o=o.charCode,o===0&&c===13&&(o=13)):o=c,o===10&&(o=13),32<=o||o===13?o:0}function mf(){return!0}function Dy(){return!1}function ya(o){function c(m,S,E,P,j){this._reactName=m,this._targetInst=E,this.type=S,this.nativeEvent=P,this.target=j,this.currentTarget=null;for(var $ in o)o.hasOwnProperty($)&&(m=o[$],this[$]=m?m(P):P[$]);return this.isDefaultPrevented=(P.defaultPrevented!=null?P.defaultPrevented:P.returnValue===!1)?mf:Dy,this.isPropagationStopped=Dy,this}return f(c.prototype,{preventDefault:function(){this.defaultPrevented=!0;var m=this.nativeEvent;m&&(m.preventDefault?m.preventDefault():typeof m.returnValue!="unknown"&&(m.returnValue=!1),this.isDefaultPrevented=mf)},stopPropagation:function(){var m=this.nativeEvent;m&&(m.stopPropagation?m.stopPropagation():typeof m.cancelBubble!="unknown"&&(m.cancelBubble=!0),this.isPropagationStopped=mf)},persist:function(){},isPersistent:mf}),c}var bo={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(o){return o.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},_f=ya(bo),du=f({},bo,{view:0,detail:0}),ow=ya(du),Py,t_,xo,fu=f({},du,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:n_,button:0,buttons:0,relatedTarget:function(o){return o.relatedTarget===void 0?o.fromElement===o.srcElement?o.toElement:o.fromElement:o.relatedTarget},movementX:function(o){return"movementX"in o?o.movementX:(o!==xo&&(xo&&o.type==="mousemove"?(Py=o.screenX-xo.screenX,t_=o.screenY-xo.screenY):t_=Py=0,xo=o),Py)},movementY:function(o){return"movementY"in o?o.movementY:t_}}),gf=ya(fu),Px=f({},fu,{dataTransfer:0}),Lx=ya(Px),s_=f({},du,{relatedTarget:0}),Uh=ya(s_),i_=f({},bo,{animationName:0,elapsedTime:0,pseudoElement:0}),Ix=ya(i_),Ox=f({},bo,{clipboardData:function(o){return"clipboardData"in o?o.clipboardData:window.clipboardData}}),Tl=ya(Ox),Nx=f({},bo,{data:0}),To=ya(Nx),Eo={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},a_={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Ly={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Fx(o){var c=this.nativeEvent;return c.getModifierState?c.getModifierState(o):(o=Ly[o])?!!c[o]:!1}function n_(){return Fx}var zh=f({},du,{key:function(o){if(o.key){var c=Eo[o.key]||o.key;if(c!=="Unidentified")return c}return o.type==="keypress"?(o=uu(o),o===13?"Enter":String.fromCharCode(o)):o.type==="keydown"||o.type==="keyup"?a_[o.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:n_,charCode:function(o){return o.type==="keypress"?uu(o):0},keyCode:function(o){return o.type==="keydown"||o.type==="keyup"?o.keyCode:0},which:function(o){return o.type==="keypress"?uu(o):o.type==="keydown"||o.type==="keyup"?o.keyCode:0}}),r_=ya(zh),Bx=f({},fu,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),o_=ya(Bx),Ux=f({},du,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:n_}),zx=ya(Ux),lw=f({},bo,{propertyName:0,elapsedTime:0,pseudoElement:0}),qi=ya(lw),kx=f({},fu,{deltaX:function(o){return"deltaX"in o?o.deltaX:"wheelDeltaX"in o?-o.wheelDeltaX:0},deltaY:function(o){return"deltaY"in o?o.deltaY:"wheelDeltaY"in o?-o.wheelDeltaY:"wheelDelta"in o?-o.wheelDelta:0},deltaZ:0,deltaMode:0}),Vx=ya(kx),Gx=f({},bo,{newState:0,oldState:0}),Hx=ya(Gx),Wx=[9,13,27,32],pu=wr&&"CompositionEvent"in window,kh=null;wr&&"documentMode"in document&&(kh=document.documentMode);var qx=wr&&"TextEvent"in window&&!kh,Iy=wr&&(!pu||kh&&8<kh&&11>=kh),Oy=" ",l_=!1;function h_(o,c){switch(o){case"keyup":return Wx.indexOf(c.keyCode)!==-1;case"keydown":return c.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Ny(o){return o=o.detail,typeof o=="object"&&"data"in o?o.data:null}var El=!1;function c_(o,c){switch(o){case"compositionend":return Ny(c);case"keypress":return c.which!==32?null:(l_=!0,Oy);case"textInput":return o=c.data,o===Oy&&l_?null:o;default:return null}}function Fy(o,c){if(El)return o==="compositionend"||!pu&&h_(o,c)?(o=My(),pf=ff=So=null,El=!1,o):null;switch(o){case"paste":return null;case"keypress":if(!(c.ctrlKey||c.altKey||c.metaKey)||c.ctrlKey&&c.altKey){if(c.char&&1<c.char.length)return c.char;if(c.which)return String.fromCharCode(c.which)}return null;case"compositionend":return Iy&&c.locale!=="ko"?null:c.data;default:return null}}var Xx={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function u_(o){var c=o&&o.nodeName&&o.nodeName.toLowerCase();return c==="input"?!!Xx[o.type]:c==="textarea"}function By(o,c,m,S){vo?Fh?Fh.push(S):Fh=[S]:vo=S,c=HT(c,"onChange"),0<c.length&&(m=new _f("onChange","change",null,m,S),o.push({event:m,listeners:c}))}var rn=null,Vh=null;function hw(o){GL(o,0)}function yf(o){var c=au(o);if(xy(c))return o}function Ia(o,c){if(o==="change")return c}var Uy=!1;if(wr){var vf;if(wr){var d_="oninput"in document;if(!d_){var zy=document.createElement("div");zy.setAttribute("oninput","return;"),d_=typeof zy.oninput=="function"}vf=d_}else vf=!1;Uy=vf&&(!document.documentMode||9<document.documentMode)}function f_(){rn&&(rn.detachEvent("onpropertychange",p_),Vh=rn=null)}function p_(o){if(o.propertyName==="value"&&yf(Vh)){var c=[];By(c,Vh,o,xl(o)),Ry(hw,c)}}function jx(o,c,m){o==="focusin"?(f_(),rn=c,Vh=m,rn.attachEvent("onpropertychange",p_)):o==="focusout"&&f_()}function m_(o){if(o==="selectionchange"||o==="keyup"||o==="keydown")return yf(Vh)}function Sf(o,c){if(o==="click")return yf(c)}function ks(o,c){if(o==="input"||o==="change")return yf(c)}function cw(o,c){return o===c&&(o!==0||1/o===1/c)||o!==o&&c!==c}var on=typeof Object.is=="function"?Object.is:cw;function mu(o,c){if(on(o,c))return!0;if(typeof o!="object"||o===null||typeof c!="object"||c===null)return!1;var m=Object.keys(o),S=Object.keys(c);if(m.length!==S.length)return!1;for(S=0;S<m.length;S++){var E=m[S];if(!Fe.call(c,E)||!on(o[E],c[E]))return!1}return!0}function _u(o){for(;o&&o.firstChild;)o=o.firstChild;return o}function Ao(o,c){var m=_u(o);o=0;for(var S;m;){if(m.nodeType===3){if(S=o+m.textContent.length,o<=c&&S>=c)return{node:m,offset:c-o};o=S}e:{for(;m;){if(m.nextSibling){m=m.nextSibling;break e}m=m.parentNode}m=void 0}m=_u(m)}}function ky(o,c){return o&&c?o===c?!0:o&&o.nodeType===3?!1:c&&c.nodeType===3?ky(o,c.parentNode):"contains"in o?o.contains(c):o.compareDocumentPosition?!!(o.compareDocumentPosition(c)&16):!1:!1}function Vy(o){o=o!=null&&o.ownerDocument!=null&&o.ownerDocument.defaultView!=null?o.ownerDocument.defaultView:window;for(var c=uf(o.document);c instanceof o.HTMLIFrameElement;){try{var m=typeof c.contentWindow.location.href=="string"}catch{m=!1}if(m)o=c.contentWindow;else break;c=uf(o.document)}return c}function Gh(o){var c=o&&o.nodeName&&o.nodeName.toLowerCase();return c&&(c==="input"&&(o.type==="text"||o.type==="search"||o.type==="tel"||o.type==="url"||o.type==="password")||c==="textarea"||o.contentEditable==="true")}var Rr=wr&&"documentMode"in document&&11>=document.documentMode,Hh=null,bf=null,gu=null,xf=!1;function __(o,c,m){var S=m.window===m?m.document:m.nodeType===9?m:m.ownerDocument;xf||Hh==null||Hh!==uf(S)||(S=Hh,"selectionStart"in S&&Gh(S)?S={start:S.selectionStart,end:S.selectionEnd}:(S=(S.ownerDocument&&S.ownerDocument.defaultView||window).getSelection(),S={anchorNode:S.anchorNode,anchorOffset:S.anchorOffset,focusNode:S.focusNode,focusOffset:S.focusOffset}),gu&&mu(gu,S)||(gu=S,S=HT(bf,"onSelect"),0<S.length&&(c=new _f("onSelect","select",null,c,m),o.push({event:c,listeners:S}),c.target=Hh)))}function Mr(o,c){var m={};return m[o.toLowerCase()]=c.toLowerCase(),m["Webkit"+o]="webkit"+c,m["Moz"+o]="moz"+c,m}var Wh={animationend:Mr("Animation","AnimationEnd"),animationiteration:Mr("Animation","AnimationIteration"),animationstart:Mr("Animation","AnimationStart"),transitionrun:Mr("Transition","TransitionRun"),transitionstart:Mr("Transition","TransitionStart"),transitioncancel:Mr("Transition","TransitionCancel"),transitionend:Mr("Transition","TransitionEnd")},g_={},Yx={};wr&&(Yx=document.createElement("div").style,"AnimationEvent"in window||(delete Wh.animationend.animation,delete Wh.animationiteration.animation,delete Wh.animationstart.animation),"TransitionEvent"in window||delete Wh.transitionend.transition);function Al(o){if(g_[o])return g_[o];if(!Wh[o])return o;var c=Wh[o],m;for(m in c)if(c.hasOwnProperty(m)&&m in Yx)return g_[o]=c[m];return o}var Gy=Al("animationend"),Sn=Al("animationiteration"),y_=Al("animationstart"),Kx=Al("transitionrun"),uw=Al("transitionstart"),Hy=Al("transitioncancel"),ta=Al("transitionend"),Wy=new Map,sa="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");sa.push("scrollEnd");function bn(o,c){Wy.set(o,c),ys(c,[o])}var Co=new WeakMap;function Di(o,c){if(typeof o=="object"&&o!==null){var m=Co.get(o);return m!==void 0?m:(c={value:o,source:c,stack:Cr(c)},Co.set(o,c),c)}return{value:o,source:c,stack:Cr(c)}}var yi=[],Cl=0,Tf=0;function ln(){for(var o=Cl,c=Tf=Cl=0;c<o;){var m=yi[c];yi[c++]=null;var S=yi[c];yi[c++]=null;var E=yi[c];yi[c++]=null;var P=yi[c];if(yi[c++]=null,S!==null&&E!==null){var j=S.pending;j===null?E.next=E:(E.next=j.next,j.next=E),S.pending=E}P!==0&&Rl(m,E,P)}}function Ef(o,c,m,S){yi[Cl++]=o,yi[Cl++]=c,yi[Cl++]=m,yi[Cl++]=S,Tf|=S,o.lanes|=S,o=o.alternate,o!==null&&(o.lanes|=S)}function wl(o,c,m,S){return Ef(o,c,m,S),Af(o)}function Dr(o,c){return Ef(o,null,null,c),Af(o)}function Rl(o,c,m){o.lanes|=m;var S=o.alternate;S!==null&&(S.lanes|=m);for(var E=!1,P=o.return;P!==null;)P.childLanes|=m,S=P.alternate,S!==null&&(S.childLanes|=m),P.tag===22&&(o=P.stateNode,o===null||o._visibility&1||(E=!0)),o=P,P=P.return;return o.tag===3?(P=o.stateNode,E&&c!==null&&(E=31-bs(m),o=P.hiddenUpdates,S=o[E],S===null?o[E]=[c]:S.push(c),c.lane=m|536870912),P):null}function Af(o){if(50<Xr)throw Xr=0,ip=null,Error(s(185));for(var c=o.return;c!==null;)o=c,c=o.return;return o.tag===3?o.stateNode:null}var qh={};function Cf(o,c,m,S){this.tag=o,this.key=m,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=c,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=S,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Oa(o,c,m,S){return new Cf(o,c,m,S)}function yu(o){return o=o.prototype,!(!o||!o.isReactComponent)}function Pr(o,c){var m=o.alternate;return m===null?(m=Oa(o.tag,c,o.key,o.mode),m.elementType=o.elementType,m.type=o.type,m.stateNode=o.stateNode,m.alternate=o,o.alternate=m):(m.pendingProps=c,m.type=o.type,m.flags=0,m.subtreeFlags=0,m.deletions=null),m.flags=o.flags&65011712,m.childLanes=o.childLanes,m.lanes=o.lanes,m.child=o.child,m.memoizedProps=o.memoizedProps,m.memoizedState=o.memoizedState,m.updateQueue=o.updateQueue,c=o.dependencies,m.dependencies=c===null?null:{lanes:c.lanes,firstContext:c.firstContext},m.sibling=o.sibling,m.index=o.index,m.ref=o.ref,m.refCleanup=o.refCleanup,m}function v_(o,c){o.flags&=65011714;var m=o.alternate;return m===null?(o.childLanes=0,o.lanes=c,o.child=null,o.subtreeFlags=0,o.memoizedProps=null,o.memoizedState=null,o.updateQueue=null,o.dependencies=null,o.stateNode=null):(o.childLanes=m.childLanes,o.lanes=m.lanes,o.child=m.child,o.subtreeFlags=0,o.deletions=null,o.memoizedProps=m.memoizedProps,o.memoizedState=m.memoizedState,o.updateQueue=m.updateQueue,o.type=m.type,c=m.dependencies,o.dependencies=c===null?null:{lanes:c.lanes,firstContext:c.firstContext}),o}function vu(o,c,m,S,E,P){var j=0;if(S=o,typeof o=="function")yu(o)&&(j=1);else if(typeof o=="string")j=Ik(o,m,ie.current)?26:o==="html"||o==="head"||o==="body"?27:5;else e:switch(o){case N:return o=Oa(31,m,c,E),o.elementType=N,o.lanes=P,o;case v:return wo(m.children,E,P,c);case x:j=8,E|=24;break;case C:return o=Oa(12,m,c,E|2),o.elementType=C,o.lanes=P,o;case D:return o=Oa(13,m,c,E),o.elementType=D,o.lanes=P,o;case I:return o=Oa(19,m,c,E),o.elementType=I,o.lanes=P,o;default:if(typeof o=="object"&&o!==null)switch(o.$$typeof){case M:case T:j=10;break e;case w:j=9;break e;case R:j=11;break e;case U:j=14;break e;case O:j=16,S=null;break e}j=29,m=Error(s(130,o===null?"null":typeof o,"")),S=null}return c=Oa(j,m,c,E),c.elementType=o,c.type=S,c.lanes=P,c}function wo(o,c,m,S){return o=Oa(7,o,S,c),o.lanes=m,o}function S_(o,c,m){return o=Oa(6,o,null,c),o.lanes=m,o}function wf(o,c,m){return c=Oa(4,o.children!==null?o.children:[],o.key,c),c.lanes=m,c.stateNode={containerInfo:o.containerInfo,pendingChildren:null,implementation:o.implementation},c}var Pi=[],Xh=0,ia=null,Rf=0,hn=[],xn=0,Na=null,Lr=1,Kn="";function Tn(o,c){Pi[Xh++]=Rf,Pi[Xh++]=ia,ia=o,Rf=c}function qy(o,c,m){hn[xn++]=Lr,hn[xn++]=Kn,hn[xn++]=Na,Na=o;var S=Lr;o=Kn;var E=32-bs(S)-1;S&=~(1<<E),m+=1;var P=32-bs(c)+E;if(30<P){var j=E-E%5;P=(S&(1<<j)-1).toString(32),S>>=j,E-=j,Lr=1<<32-bs(c)+E|m<<E|S,Kn=P+o}else Lr=1<<P|m<<E|S,Kn=o}function b_(o){o.return!==null&&(Tn(o,1),qy(o,1,0))}function x_(o){for(;o===ia;)ia=Pi[--Xh],Pi[Xh]=null,Rf=Pi[--Xh],Pi[Xh]=null;for(;o===Na;)Na=hn[--xn],hn[xn]=null,Kn=hn[--xn],hn[xn]=null,Lr=hn[--xn],hn[xn]=null}var aa=null,Fs=null,Ht=!1,jh=null,Ir=!1,Xy=Error(s(519));function Ml(o){var c=Error(s(418,""));throw bu(Di(c,o)),Xy}function jy(o){var c=o.stateNode,m=o.type,S=o.memoizedProps;switch(c[si]=o,c[_a]=S,m){case"dialog":Nt("cancel",c),Nt("close",c);break;case"iframe":case"object":case"embed":Nt("load",c);break;case"video":case"audio":for(m=0;m<Dv.length;m++)Nt(Dv[m],c);break;case"source":Nt("error",c);break;case"img":case"image":case"link":Nt("error",c),Nt("load",c);break;case"details":Nt("toggle",c);break;case"input":Nt("invalid",c),Km(c,S.value,S.defaultValue,S.checked,S.defaultChecked,S.type,S.name,!0),cf(c);break;case"select":Nt("invalid",c);break;case"textarea":Nt("invalid",c),Ey(c,S.value,S.defaultValue,S.children),cf(c)}m=S.children,typeof m!="string"&&typeof m!="number"&&typeof m!="bigint"||c.textContent===""+m||S.suppressHydrationWarning===!0||XL(c.textContent,m)?(S.popover!=null&&(Nt("beforetoggle",c),Nt("toggle",c)),S.onScroll!=null&&Nt("scroll",c),S.onScrollEnd!=null&&Nt("scrollend",c),S.onClick!=null&&(c.onclick=WT),c=!0):c=!1,c||Ml(o)}function Yh(o){for(aa=o.return;aa;)switch(aa.tag){case 5:case 13:Ir=!1;return;case 27:case 3:Ir=!0;return;default:aa=aa.return}}function Dl(o){if(o!==aa)return!1;if(!Ht)return Yh(o),Ht=!0,!1;var c=o.tag,m;if((m=c!==3&&c!==27)&&((m=c===5)&&(m=o.type,m=!(m!=="form"&&m!=="button")||Mw(o.type,o.memoizedProps)),m=!m),m&&Fs&&Ml(o),Yh(o),c===13){if(o=o.memoizedState,o=o!==null?o.dehydrated:null,!o)throw Error(s(317));e:{for(o=o.nextSibling,c=0;o;){if(o.nodeType===8)if(m=o.data,m==="/$"){if(c===0){Fs=Go(o.nextSibling);break e}c--}else m!=="$"&&m!=="$!"&&m!=="$?"||c++;o=o.nextSibling}Fs=null}}else c===27?(c=Fs,Wu(o.type)?(o=Iw,Iw=null,Fs=o):Fs=c):Fs=aa?Go(o.stateNode.nextSibling):null;return!0}function Su(){Fs=aa=null,Ht=!1}function Yy(){var o=jh;return o!==null&&(Yi===null?Yi=o:Yi.push.apply(Yi,o),jh=null),o}function bu(o){jh===null?jh=[o]:jh.push(o)}var T_=Q(null),Pl=null,Or=null;function En(o,c,m){J(T_,c._currentValue),c._currentValue=m}function Nr(o){o._currentValue=T_.current,se(T_)}function E_(o,c,m){for(;o!==null;){var S=o.alternate;if((o.childLanes&c)!==c?(o.childLanes|=c,S!==null&&(S.childLanes|=c)):S!==null&&(S.childLanes&c)!==c&&(S.childLanes|=c),o===m)break;o=o.return}}function Qt(o,c,m,S){var E=o.child;for(E!==null&&(E.return=o);E!==null;){var P=E.dependencies;if(P!==null){var j=E.child;P=P.firstContext;e:for(;P!==null;){var $=P;P=E;for(var ae=0;ae<c.length;ae++)if($.context===c[ae]){P.lanes|=m,$=P.alternate,$!==null&&($.lanes|=m),E_(P.return,m,o),S||(j=null);break e}P=$.next}}else if(E.tag===18){if(j=E.return,j===null)throw Error(s(341));j.lanes|=m,P=j.alternate,P!==null&&(P.lanes|=m),E_(j,m,o),j=null}else j=E.child;if(j!==null)j.return=E;else for(j=E;j!==null;){if(j===o){j=null;break}if(E=j.sibling,E!==null){E.return=j.return,j=E;break}j=j.return}E=j}}function Kh(o,c,m,S){o=null;for(var E=c,P=!1;E!==null;){if(!P){if((E.flags&524288)!==0)P=!0;else if((E.flags&262144)!==0)break}if(E.tag===10){var j=E.alternate;if(j===null)throw Error(s(387));if(j=j.memoizedProps,j!==null){var $=E.type;on(E.pendingProps.value,j.value)||(o!==null?o.push($):o=[$])}}else if(E===te.current){if(j=E.alternate,j===null)throw Error(s(387));j.memoizedState.memoizedState!==E.memoizedState.memoizedState&&(o!==null?o.push(Fv):o=[Fv])}E=E.return}o!==null&&Qt(c,o,m,S),c.flags|=262144}function A_(o){for(o=o.firstContext;o!==null;){if(!on(o.context._currentValue,o.memoizedValue))return!0;o=o.next}return!1}function Ll(o){Pl=o,Or=null,o=o.dependencies,o!==null&&(o.firstContext=null)}function na(o){return Qx(Pl,o)}function C_(o,c){return Pl===null&&Ll(o),Qx(o,c)}function Qx(o,c){var m=c._currentValue;if(c={context:c,memoizedValue:m,next:null},Or===null){if(o===null)throw Error(s(308));Or=c,o.dependencies={lanes:0,firstContext:c},o.flags|=524288}else Or=Or.next=c;return m}var dw=typeof AbortController<"u"?AbortController:function(){var o=[],c=this.signal={aborted:!1,addEventListener:function(m,S){o.push(S)}};this.abort=function(){c.aborted=!0,o.forEach(function(m){return m()})}},Ky=h.unstable_scheduleCallback,Ro=h.unstable_NormalPriority,li={$$typeof:T,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function xu(){return{controller:new dw,data:new Map,refCount:0}}function Qn(o){o.refCount--,o.refCount===0&&Ky(Ro,function(){o.controller.abort()})}var Qh=null,Mf=0,Tu=0,$h=null;function $x(o,c){if(Qh===null){var m=Qh=[];Mf=0,Tu=Sw(),$h={status:"pending",value:void 0,then:function(S){m.push(S)}}}return Mf++,c.then(Qy,Qy),c}function Qy(){if(--Mf===0&&Qh!==null){$h!==null&&($h.status="fulfilled");var o=Qh;Qh=null,Tu=0,$h=null;for(var c=0;c<o.length;c++)(0,o[c])()}}function Zx(o,c){var m=[],S={status:"pending",value:null,reason:null,then:function(E){m.push(E)}};return o.then(function(){S.status="fulfilled",S.value=c;for(var E=0;E<m.length;E++)(0,m[E])(c)},function(E){for(S.status="rejected",S.reason=E,E=0;E<m.length;E++)(0,m[E])(void 0)}),S}var $y=W.S;W.S=function(o,c){typeof c=="object"&&c!==null&&typeof c.then=="function"&&$x(o,c),$y!==null&&$y(o,c)};var Mo=Q(null);function _t(){var o=Mo.current;return o!==null?o:hs.pooledCache}function w_(o,c){c===null?J(Mo,Mo.current):J(Mo,c.pool)}function Fa(){var o=_t();return o===null?null:{parent:li._currentValue,pool:o}}var Zh=Error(s(460)),Jx=Error(s(474)),Jh=Error(s(542)),Il={then:function(){}};function ec(o){return o=o.status,o==="fulfilled"||o==="rejected"}function Df(){}function R_(o,c,m){switch(m=o[m],m===void 0?o.push(c):m!==c&&(c.then(Df,Df),c=m),c.status){case"fulfilled":return c.value;case"rejected":throw o=c.reason,Do(o),o;default:if(typeof c.status=="string")c.then(Df,Df);else{if(o=hs,o!==null&&100<o.shellSuspendCounter)throw Error(s(482));o=c,o.status="pending",o.then(function(S){if(c.status==="pending"){var E=c;E.status="fulfilled",E.value=S}},function(S){if(c.status==="pending"){var E=c;E.status="rejected",E.reason=S}})}switch(c.status){case"fulfilled":return c.value;case"rejected":throw o=c.reason,Do(o),o}throw Pf=c,Zh}}var Pf=null;function Zy(){if(Pf===null)throw Error(s(459));var o=Pf;return Pf=null,o}function Do(o){if(o===Zh||o===Jh)throw Error(s(483))}var Fr=!1;function Lf(o){o.updateQueue={baseState:o.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function If(o,c){o=o.updateQueue,c.updateQueue===o&&(c.updateQueue={baseState:o.baseState,firstBaseUpdate:o.firstBaseUpdate,lastBaseUpdate:o.lastBaseUpdate,shared:o.shared,callbacks:null})}function Br(o){return{lane:o,tag:0,payload:null,callback:null,next:null}}function va(o,c,m){var S=o.updateQueue;if(S===null)return null;if(S=S.shared,(st&2)!==0){var E=S.pending;return E===null?c.next=c:(c.next=E.next,E.next=c),S.pending=c,c=Af(o),Rl(o,null,m),c}return Ef(o,S,c,m),Af(o)}function tc(o,c,m){if(c=c.updateQueue,c!==null&&(c=c.shared,(m&4194048)!==0)){var S=c.lanes;S&=o.pendingLanes,m|=S,c.lanes=m,my(o,m)}}function Jy(o,c){var m=o.updateQueue,S=o.alternate;if(S!==null&&(S=S.updateQueue,m===S)){var E=null,P=null;if(m=m.firstBaseUpdate,m!==null){do{var j={lane:m.lane,tag:m.tag,payload:m.payload,callback:null,next:null};P===null?E=P=j:P=P.next=j,m=m.next}while(m!==null);P===null?E=P=c:P=P.next=c}else E=P=c;m={baseState:S.baseState,firstBaseUpdate:E,lastBaseUpdate:P,shared:S.shared,callbacks:S.callbacks},o.updateQueue=m;return}o=m.lastBaseUpdate,o===null?m.firstBaseUpdate=c:o.next=c,m.lastBaseUpdate=c}var M_=!1;function Of(){if(M_){var o=$h;if(o!==null)throw o}}function Ol(o,c,m,S){M_=!1;var E=o.updateQueue;Fr=!1;var P=E.firstBaseUpdate,j=E.lastBaseUpdate,$=E.shared.pending;if($!==null){E.shared.pending=null;var ae=$,pe=ae.next;ae.next=null,j===null?P=pe:j.next=pe,j=ae;var be=o.alternate;be!==null&&(be=be.updateQueue,$=be.lastBaseUpdate,$!==j&&($===null?be.firstBaseUpdate=pe:$.next=pe,be.lastBaseUpdate=ae))}if(P!==null){var Ce=E.baseState;j=0,be=pe=ae=null,$=P;do{var _e=$.lane&-536870913,ye=_e!==$.lane;if(ye?(Ot&_e)===_e:(S&_e)===_e){_e!==0&&_e===Tu&&(M_=!0),be!==null&&(be=be.next={lane:0,tag:$.tag,payload:$.payload,callback:null,next:null});e:{var nt=o,Ze=$;_e=c;var Cs=m;switch(Ze.tag){case 1:if(nt=Ze.payload,typeof nt=="function"){Ce=nt.call(Cs,Ce,_e);break e}Ce=nt;break e;case 3:nt.flags=nt.flags&-65537|128;case 0:if(nt=Ze.payload,_e=typeof nt=="function"?nt.call(Cs,Ce,_e):nt,_e==null)break e;Ce=f({},Ce,_e);break e;case 2:Fr=!0}}_e=$.callback,_e!==null&&(o.flags|=64,ye&&(o.flags|=8192),ye=E.callbacks,ye===null?E.callbacks=[_e]:ye.push(_e))}else ye={lane:_e,tag:$.tag,payload:$.payload,callback:$.callback,next:null},be===null?(pe=be=ye,ae=Ce):be=be.next=ye,j|=_e;if($=$.next,$===null){if($=E.shared.pending,$===null)break;ye=$,$=ye.next,ye.next=null,E.lastBaseUpdate=ye,E.shared.pending=null}}while(!0);be===null&&(ae=Ce),E.baseState=ae,E.firstBaseUpdate=pe,E.lastBaseUpdate=be,P===null&&(E.shared.lanes=0),Ss|=j,o.lanes=j,o.memoizedState=Ce}}function je(o,c){if(typeof o!="function")throw Error(s(191,o));o.call(c)}function eT(o,c){var m=o.callbacks;if(m!==null)for(o.callbacks=null,o=0;o<m.length;o++)je(m[o],c)}var Eu=Q(null),Nf=Q(0);function Au(o,c){o=qr,J(Nf,o),J(Eu,c),qr=o|c.baseLanes}function ev(){J(Nf,qr),J(Eu,Eu.current)}function tv(){qr=Nf.current,se(Eu),se(Nf)}var Nl=0,gt=null,os=null,Ks=null,Ff=!1,Po=!1,Fl=!1,D_=0,Bf=0,An=null,Lo=0;function Dt(){throw Error(s(321))}function Ur(o,c){if(c===null)return!1;for(var m=0;m<c.length&&m<o.length;m++)if(!on(o[m],c[m]))return!1;return!0}function Ba(o,c,m,S,E,P){return Nl=P,gt=c,c.memoizedState=null,c.updateQueue=null,c.lanes=0,W.H=o===null||o.memoizedState===null?PT:yv,Fl=!1,P=m(S,E),Fl=!1,Po&&(P=sT(c,m,S,E)),tT(o),P}function tT(o){W.H=F_;var c=os!==null&&os.next!==null;if(Nl=0,Ks=os=gt=null,Ff=!1,Bf=0,An=null,c)throw Error(s(300));o===null||ls||(o=o.dependencies,o!==null&&A_(o)&&(ls=!0))}function sT(o,c,m,S){gt=o;var E=0;do{if(Po&&(An=null),Bf=0,Po=!1,25<=E)throw Error(s(301));if(E+=1,Ks=os=null,o.updateQueue!=null){var P=o.updateQueue;P.lastEffect=null,P.events=null,P.stores=null,P.memoCache!=null&&(P.memoCache.index=0)}W.H=_w,P=c(m,S)}while(Po);return P}function Li(){var o=W.H,c=o.useState()[0];return c=typeof c.then=="function"?Uf(c):c,o=o.useState()[0],(os!==null?os.memoizedState:null)!==o&&(gt.flags|=1024),c}function $n(){var o=D_!==0;return D_=0,o}function sv(o,c,m){c.updateQueue=o.updateQueue,c.flags&=-2053,o.lanes&=~m}function iv(o){if(Ff){for(o=o.memoizedState;o!==null;){var c=o.queue;c!==null&&(c.pending=null),o=o.next}Ff=!1}Nl=0,Ks=os=gt=null,Po=!1,Bf=D_=0,An=null}function Ua(){var o={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Ks===null?gt.memoizedState=Ks=o:Ks=Ks.next=o,Ks}function hi(){if(os===null){var o=gt.alternate;o=o!==null?o.memoizedState:null}else o=os.next;var c=Ks===null?gt.memoizedState:Ks.next;if(c!==null)Ks=c,os=o;else{if(o===null)throw gt.alternate===null?Error(s(467)):Error(s(310));os=o,o={memoizedState:os.memoizedState,baseState:os.baseState,baseQueue:os.baseQueue,queue:os.queue,next:null},Ks===null?gt.memoizedState=Ks=o:Ks=Ks.next=o}return Ks}function P_(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function Uf(o){var c=Bf;return Bf+=1,An===null&&(An=[]),o=R_(An,o,c),c=gt,(Ks===null?c.memoizedState:Ks.next)===null&&(c=c.alternate,W.H=c===null||c.memoizedState===null?PT:yv),o}function zf(o){if(o!==null&&typeof o=="object"){if(typeof o.then=="function")return Uf(o);if(o.$$typeof===T)return na(o)}throw Error(s(438,String(o)))}function av(o){var c=null,m=gt.updateQueue;if(m!==null&&(c=m.memoCache),c==null){var S=gt.alternate;S!==null&&(S=S.updateQueue,S!==null&&(S=S.memoCache,S!=null&&(c={data:S.data.map(function(E){return E.slice()}),index:0})))}if(c==null&&(c={data:[],index:0}),m===null&&(m=P_(),gt.updateQueue=m),m.memoCache=c,m=c.data[c.index],m===void 0)for(m=c.data[c.index]=Array(o),S=0;S<o;S++)m[S]=z;return c.index++,m}function za(o,c){return typeof c=="function"?c(o):c}function zr(o){var c=hi();return nv(c,os,o)}function nv(o,c,m){var S=o.queue;if(S===null)throw Error(s(311));S.lastRenderedReducer=m;var E=o.baseQueue,P=S.pending;if(P!==null){if(E!==null){var j=E.next;E.next=P.next,P.next=j}c.baseQueue=E=P,S.pending=null}if(P=o.baseState,E===null)o.memoizedState=P;else{c=E.next;var $=j=null,ae=null,pe=c,be=!1;do{var Ce=pe.lane&-536870913;if(Ce!==pe.lane?(Ot&Ce)===Ce:(Nl&Ce)===Ce){var _e=pe.revertLane;if(_e===0)ae!==null&&(ae=ae.next={lane:0,revertLane:0,action:pe.action,hasEagerState:pe.hasEagerState,eagerState:pe.eagerState,next:null}),Ce===Tu&&(be=!0);else if((Nl&_e)===_e){pe=pe.next,_e===Tu&&(be=!0);continue}else Ce={lane:0,revertLane:pe.revertLane,action:pe.action,hasEagerState:pe.hasEagerState,eagerState:pe.eagerState,next:null},ae===null?($=ae=Ce,j=P):ae=ae.next=Ce,gt.lanes|=_e,Ss|=_e;Ce=pe.action,Fl&&m(P,Ce),P=pe.hasEagerState?pe.eagerState:m(P,Ce)}else _e={lane:Ce,revertLane:pe.revertLane,action:pe.action,hasEagerState:pe.hasEagerState,eagerState:pe.eagerState,next:null},ae===null?($=ae=_e,j=P):ae=ae.next=_e,gt.lanes|=Ce,Ss|=Ce;pe=pe.next}while(pe!==null&&pe!==c);if(ae===null?j=P:ae.next=$,!on(P,o.memoizedState)&&(ls=!0,be&&(m=$h,m!==null)))throw m;o.memoizedState=P,o.baseState=j,o.baseQueue=ae,S.lastRenderedState=P}return E===null&&(S.lanes=0),[o.memoizedState,S.dispatch]}function rv(o){var c=hi(),m=c.queue;if(m===null)throw Error(s(311));m.lastRenderedReducer=o;var S=m.dispatch,E=m.pending,P=c.memoizedState;if(E!==null){m.pending=null;var j=E=E.next;do P=o(P,j.action),j=j.next;while(j!==E);on(P,c.memoizedState)||(ls=!0),c.memoizedState=P,c.baseQueue===null&&(c.baseState=P),m.lastRenderedState=P}return[P,S]}function iT(o,c,m){var S=gt,E=hi(),P=Ht;if(P){if(m===void 0)throw Error(s(407));m=m()}else m=c();var j=!on((os||E).memoizedState,m);j&&(E.memoizedState=m,ls=!0),E=E.queue;var $=nT.bind(null,S,E,o);if(kf(2048,8,$,[o]),E.getSnapshot!==c||j||Ks!==null&&Ks.memoizedState.tag&1){if(S.flags|=2048,Ru(9,L_(),aT.bind(null,S,E,m,c),null),hs===null)throw Error(s(349));P||(Nl&124)!==0||Cu(S,c,m)}return m}function Cu(o,c,m){o.flags|=16384,o={getSnapshot:c,value:m},c=gt.updateQueue,c===null?(c=P_(),gt.updateQueue=c,c.stores=[o]):(m=c.stores,m===null?c.stores=[o]:m.push(o))}function aT(o,c,m,S){c.value=m,c.getSnapshot=S,rT(c)&&wu(o)}function nT(o,c,m){return m(function(){rT(c)&&wu(o)})}function rT(o){var c=o.getSnapshot;o=o.value;try{var m=c();return!on(o,m)}catch{return!0}}function wu(o){var c=Dr(o,2);c!==null&&fi(c,o,2)}function ov(o){var c=Ua();if(typeof o=="function"){var m=o;if(o=m(),Fl){rs(!0);try{m()}finally{rs(!1)}}}return c.memoizedState=c.baseState=o,c.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:za,lastRenderedState:o},c}function oT(o,c,m,S){return o.baseState=m,nv(o,os,typeof S=="function"?S:za)}function fw(o,c,m,S,E){if(N_(o))throw Error(s(485));if(o=c.action,o!==null){var P={payload:E,action:o,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(j){P.listeners.push(j)}};W.T!==null?m(!0):P.isTransition=!1,S(P),m=c.pending,m===null?(P.next=c.pending=P,lT(c,P)):(P.next=m.next,c.pending=m.next=P)}}function lT(o,c){var m=c.action,S=c.payload,E=o.state;if(c.isTransition){var P=W.T,j={};W.T=j;try{var $=m(E,S),ae=W.S;ae!==null&&ae(j,$),hT(o,c,$)}catch(pe){lv(o,c,pe)}finally{W.T=P}}else try{P=m(E,S),hT(o,c,P)}catch(pe){lv(o,c,pe)}}function hT(o,c,m){m!==null&&typeof m=="object"&&typeof m.then=="function"?m.then(function(S){cT(o,c,S)},function(S){return lv(o,c,S)}):cT(o,c,m)}function cT(o,c,m){c.status="fulfilled",c.value=m,uT(c),o.state=m,c=o.pending,c!==null&&(m=c.next,m===c?o.pending=null:(m=m.next,c.next=m,lT(o,m)))}function lv(o,c,m){var S=o.pending;if(o.pending=null,S!==null){S=S.next;do c.status="rejected",c.reason=m,uT(c),c=c.next;while(c!==S)}o.action=null}function uT(o){o=o.listeners;for(var c=0;c<o.length;c++)(0,o[c])()}function dT(o,c){return c}function fT(o,c){if(Ht){var m=hs.formState;if(m!==null){e:{var S=gt;if(Ht){if(Fs){t:{for(var E=Fs,P=Ir;E.nodeType!==8;){if(!P){E=null;break t}if(E=Go(E.nextSibling),E===null){E=null;break t}}P=E.data,E=P==="F!"||P==="F"?E:null}if(E){Fs=Go(E.nextSibling),S=E.data==="F!";break e}}Ml(S)}S=!1}S&&(c=m[0])}}return m=Ua(),m.memoizedState=m.baseState=c,S={pending:null,lanes:0,dispatch:null,lastRenderedReducer:dT,lastRenderedState:c},m.queue=S,m=RT.bind(null,gt,S),S.dispatch=m,S=ov(!1),P=gv.bind(null,gt,!1,S.queue),S=Ua(),E={state:c,dispatch:null,action:o,pending:null},S.queue=E,m=fw.bind(null,gt,E,P,m),E.dispatch=m,S.memoizedState=o,[c,m,!1]}function pT(o){var c=hi();return mT(c,os,o)}function mT(o,c,m){if(c=nv(o,c,dT)[0],o=zr(za)[0],typeof c=="object"&&c!==null&&typeof c.then=="function")try{var S=Uf(c)}catch(j){throw j===Zh?Jh:j}else S=c;c=hi();var E=c.queue,P=E.dispatch;return m!==c.memoizedState&&(gt.flags|=2048,Ru(9,L_(),_T.bind(null,E,m),null)),[S,P,o]}function _T(o,c){o.action=c}function gT(o){var c=hi(),m=os;if(m!==null)return mT(c,m,o);hi(),c=c.memoizedState,m=hi();var S=m.queue.dispatch;return m.memoizedState=o,[c,S,!1]}function Ru(o,c,m,S){return o={tag:o,create:m,deps:S,inst:c,next:null},c=gt.updateQueue,c===null&&(c=P_(),gt.updateQueue=c),m=c.lastEffect,m===null?c.lastEffect=o.next=o:(S=m.next,m.next=o,o.next=S,c.lastEffect=o),o}function L_(){return{destroy:void 0,resource:void 0}}function yT(){return hi().memoizedState}function I_(o,c,m,S){var E=Ua();S=S===void 0?null:S,gt.flags|=o,E.memoizedState=Ru(1|c,L_(),m,S)}function kf(o,c,m,S){var E=hi();S=S===void 0?null:S;var P=E.memoizedState.inst;os!==null&&S!==null&&Ur(S,os.memoizedState.deps)?E.memoizedState=Ru(c,P,m,S):(gt.flags|=o,E.memoizedState=Ru(1|c,P,m,S))}function hv(o,c){I_(8390656,8,o,c)}function cv(o,c){kf(2048,8,o,c)}function vT(o,c){return kf(4,2,o,c)}function uv(o,c){return kf(4,4,o,c)}function dv(o,c){if(typeof c=="function"){o=o();var m=c(o);return function(){typeof m=="function"?m():c(null)}}if(c!=null)return o=o(),c.current=o,function(){c.current=null}}function fv(o,c,m){m=m!=null?m.concat([o]):null,kf(4,4,dv.bind(null,c,o),m)}function Vf(){}function O_(o,c){var m=hi();c=c===void 0?null:c;var S=m.memoizedState;return c!==null&&Ur(c,S[1])?S[0]:(m.memoizedState=[o,c],o)}function ST(o,c){var m=hi();c=c===void 0?null:c;var S=m.memoizedState;if(c!==null&&Ur(c,S[1]))return S[0];if(S=o(),Fl){rs(!0);try{o()}finally{rs(!1)}}return m.memoizedState=[S,c],S}function pv(o,c,m){return m===void 0||(Nl&1073741824)!==0?o.memoizedState=c:(o.memoizedState=m,o=Gs(),gt.lanes|=o,Ss|=o,m)}function bT(o,c,m,S){return on(m,c)?m:Eu.current!==null?(o=pv(o,m,S),on(o,c)||(ls=!0),o):(Nl&42)===0?(ls=!0,o.memoizedState=m):(o=Gs(),gt.lanes|=o,Ss|=o,c)}function xT(o,c,m,S,E){var P=k.p;k.p=P!==0&&8>P?P:8;var j=W.T,$={};W.T=$,gv(o,!1,c,m);try{var ae=E(),pe=W.S;if(pe!==null&&pe($,ae),ae!==null&&typeof ae=="object"&&typeof ae.then=="function"){var be=Zx(ae,S);Gf(o,c,be,ai(o))}else Gf(o,c,S,ai(o))}catch(Ce){Gf(o,c,{then:function(){},status:"rejected",reason:Ce},ai())}finally{k.p=P,W.T=j}}function TT(){}function mv(o,c,m,S){if(o.tag!==5)throw Error(s(476));var E=ET(o).queue;xT(o,E,c,K,m===null?TT:function(){return AT(o),m(S)})}function ET(o){var c=o.memoizedState;if(c!==null)return c;c={memoizedState:K,baseState:K,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:za,lastRenderedState:K},next:null};var m={};return c.next={memoizedState:m,baseState:m,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:za,lastRenderedState:m},next:null},o.memoizedState=c,o=o.alternate,o!==null&&(o.memoizedState=c),c}function AT(o){var c=ET(o).next.queue;Gf(o,c,{},ai())}function _v(){return na(Fv)}function CT(){return hi().memoizedState}function wT(){return hi().memoizedState}function pw(o){for(var c=o.return;c!==null;){switch(c.tag){case 24:case 3:var m=ai();o=Br(m);var S=va(c,o,m);S!==null&&(fi(S,c,m),tc(S,c,m)),c={cache:xu()},o.payload=c;return}c=c.return}}function mw(o,c,m){var S=ai();m={lane:S,revertLane:0,action:m,hasEagerState:!1,eagerState:null,next:null},N_(o)?MT(c,m):(m=wl(o,c,m,S),m!==null&&(fi(m,o,S),DT(m,c,S)))}function RT(o,c,m){var S=ai();Gf(o,c,m,S)}function Gf(o,c,m,S){var E={lane:S,revertLane:0,action:m,hasEagerState:!1,eagerState:null,next:null};if(N_(o))MT(c,E);else{var P=o.alternate;if(o.lanes===0&&(P===null||P.lanes===0)&&(P=c.lastRenderedReducer,P!==null))try{var j=c.lastRenderedState,$=P(j,m);if(E.hasEagerState=!0,E.eagerState=$,on($,j))return Ef(o,c,E,0),hs===null&&ln(),!1}catch{}finally{}if(m=wl(o,c,E,S),m!==null)return fi(m,o,S),DT(m,c,S),!0}return!1}function gv(o,c,m,S){if(S={lane:2,revertLane:Sw(),action:S,hasEagerState:!1,eagerState:null,next:null},N_(o)){if(c)throw Error(s(479))}else c=wl(o,m,S,2),c!==null&&fi(c,o,2)}function N_(o){var c=o.alternate;return o===gt||c!==null&&c===gt}function MT(o,c){Po=Ff=!0;var m=o.pending;m===null?c.next=c:(c.next=m.next,m.next=c),o.pending=c}function DT(o,c,m){if((m&4194048)!==0){var S=c.lanes;S&=o.pendingLanes,m|=S,c.lanes=m,my(o,m)}}var F_={readContext:na,use:zf,useCallback:Dt,useContext:Dt,useEffect:Dt,useImperativeHandle:Dt,useLayoutEffect:Dt,useInsertionEffect:Dt,useMemo:Dt,useReducer:Dt,useRef:Dt,useState:Dt,useDebugValue:Dt,useDeferredValue:Dt,useTransition:Dt,useSyncExternalStore:Dt,useId:Dt,useHostTransitionStatus:Dt,useFormState:Dt,useActionState:Dt,useOptimistic:Dt,useMemoCache:Dt,useCacheRefresh:Dt},PT={readContext:na,use:zf,useCallback:function(o,c){return Ua().memoizedState=[o,c===void 0?null:c],o},useContext:na,useEffect:hv,useImperativeHandle:function(o,c,m){m=m!=null?m.concat([o]):null,I_(4194308,4,dv.bind(null,c,o),m)},useLayoutEffect:function(o,c){return I_(4194308,4,o,c)},useInsertionEffect:function(o,c){I_(4,2,o,c)},useMemo:function(o,c){var m=Ua();c=c===void 0?null:c;var S=o();if(Fl){rs(!0);try{o()}finally{rs(!1)}}return m.memoizedState=[S,c],S},useReducer:function(o,c,m){var S=Ua();if(m!==void 0){var E=m(c);if(Fl){rs(!0);try{m(c)}finally{rs(!1)}}}else E=c;return S.memoizedState=S.baseState=E,o={pending:null,lanes:0,dispatch:null,lastRenderedReducer:o,lastRenderedState:E},S.queue=o,o=o.dispatch=mw.bind(null,gt,o),[S.memoizedState,o]},useRef:function(o){var c=Ua();return o={current:o},c.memoizedState=o},useState:function(o){o=ov(o);var c=o.queue,m=RT.bind(null,gt,c);return c.dispatch=m,[o.memoizedState,m]},useDebugValue:Vf,useDeferredValue:function(o,c){var m=Ua();return pv(m,o,c)},useTransition:function(){var o=ov(!1);return o=xT.bind(null,gt,o.queue,!0,!1),Ua().memoizedState=o,[!1,o]},useSyncExternalStore:function(o,c,m){var S=gt,E=Ua();if(Ht){if(m===void 0)throw Error(s(407));m=m()}else{if(m=c(),hs===null)throw Error(s(349));(Ot&124)!==0||Cu(S,c,m)}E.memoizedState=m;var P={value:m,getSnapshot:c};return E.queue=P,hv(nT.bind(null,S,P,o),[o]),S.flags|=2048,Ru(9,L_(),aT.bind(null,S,P,m,c),null),m},useId:function(){var o=Ua(),c=hs.identifierPrefix;if(Ht){var m=Kn,S=Lr;m=(S&~(1<<32-bs(S)-1)).toString(32)+m,c="«"+c+"R"+m,m=D_++,0<m&&(c+="H"+m.toString(32)),c+="»"}else m=Lo++,c="«"+c+"r"+m.toString(32)+"»";return o.memoizedState=c},useHostTransitionStatus:_v,useFormState:fT,useActionState:fT,useOptimistic:function(o){var c=Ua();c.memoizedState=c.baseState=o;var m={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return c.queue=m,c=gv.bind(null,gt,!0,m),m.dispatch=c,[o,c]},useMemoCache:av,useCacheRefresh:function(){return Ua().memoizedState=pw.bind(null,gt)}},yv={readContext:na,use:zf,useCallback:O_,useContext:na,useEffect:cv,useImperativeHandle:fv,useInsertionEffect:vT,useLayoutEffect:uv,useMemo:ST,useReducer:zr,useRef:yT,useState:function(){return zr(za)},useDebugValue:Vf,useDeferredValue:function(o,c){var m=hi();return bT(m,os.memoizedState,o,c)},useTransition:function(){var o=zr(za)[0],c=hi().memoizedState;return[typeof o=="boolean"?o:Uf(o),c]},useSyncExternalStore:iT,useId:CT,useHostTransitionStatus:_v,useFormState:pT,useActionState:pT,useOptimistic:function(o,c){var m=hi();return oT(m,os,o,c)},useMemoCache:av,useCacheRefresh:wT},_w={readContext:na,use:zf,useCallback:O_,useContext:na,useEffect:cv,useImperativeHandle:fv,useInsertionEffect:vT,useLayoutEffect:uv,useMemo:ST,useReducer:rv,useRef:yT,useState:function(){return rv(za)},useDebugValue:Vf,useDeferredValue:function(o,c){var m=hi();return os===null?pv(m,o,c):bT(m,os.memoizedState,o,c)},useTransition:function(){var o=rv(za)[0],c=hi().memoizedState;return[typeof o=="boolean"?o:Uf(o),c]},useSyncExternalStore:iT,useId:CT,useHostTransitionStatus:_v,useFormState:gT,useActionState:gT,useOptimistic:function(o,c){var m=hi();return os!==null?oT(m,os,o,c):(m.baseState=o,[o,m.queue.dispatch])},useMemoCache:av,useCacheRefresh:wT},Mu=null,Sa=0;function Hf(o){var c=Sa;return Sa+=1,Mu===null&&(Mu=[]),R_(Mu,o,c)}function sc(o,c){c=c.props.ref,o.ref=c!==void 0?c:null}function Wf(o,c){throw c.$$typeof===_?Error(s(525)):(o=Object.prototype.toString.call(c),Error(s(31,o==="[object Object]"?"object with keys {"+Object.keys(c).join(", ")+"}":o)))}function vv(o){var c=o._init;return c(o._payload)}function Sv(o){function c(ue,re){if(o){var fe=ue.deletions;fe===null?(ue.deletions=[re],ue.flags|=16):fe.push(re)}}function m(ue,re){if(!o)return null;for(;re!==null;)c(ue,re),re=re.sibling;return null}function S(ue){for(var re=new Map;ue!==null;)ue.key!==null?re.set(ue.key,ue):re.set(ue.index,ue),ue=ue.sibling;return re}function E(ue,re){return ue=Pr(ue,re),ue.index=0,ue.sibling=null,ue}function P(ue,re,fe){return ue.index=fe,o?(fe=ue.alternate,fe!==null?(fe=fe.index,fe<re?(ue.flags|=67108866,re):fe):(ue.flags|=67108866,re)):(ue.flags|=1048576,re)}function j(ue){return o&&ue.alternate===null&&(ue.flags|=67108866),ue}function $(ue,re,fe,Te){return re===null||re.tag!==6?(re=S_(fe,ue.mode,Te),re.return=ue,re):(re=E(re,fe),re.return=ue,re)}function ae(ue,re,fe,Te){var Ve=fe.type;return Ve===v?be(ue,re,fe.props.children,Te,fe.key):re!==null&&(re.elementType===Ve||typeof Ve=="object"&&Ve!==null&&Ve.$$typeof===O&&vv(Ve)===re.type)?(re=E(re,fe.props),sc(re,fe),re.return=ue,re):(re=vu(fe.type,fe.key,fe.props,null,ue.mode,Te),sc(re,fe),re.return=ue,re)}function pe(ue,re,fe,Te){return re===null||re.tag!==4||re.stateNode.containerInfo!==fe.containerInfo||re.stateNode.implementation!==fe.implementation?(re=wf(fe,ue.mode,Te),re.return=ue,re):(re=E(re,fe.children||[]),re.return=ue,re)}function be(ue,re,fe,Te,Ve){return re===null||re.tag!==7?(re=wo(fe,ue.mode,Te,Ve),re.return=ue,re):(re=E(re,fe),re.return=ue,re)}function Ce(ue,re,fe){if(typeof re=="string"&&re!==""||typeof re=="number"||typeof re=="bigint")return re=S_(""+re,ue.mode,fe),re.return=ue,re;if(typeof re=="object"&&re!==null){switch(re.$$typeof){case g:return fe=vu(re.type,re.key,re.props,null,ue.mode,fe),sc(fe,re),fe.return=ue,fe;case y:return re=wf(re,ue.mode,fe),re.return=ue,re;case O:var Te=re._init;return re=Te(re._payload),Ce(ue,re,fe)}if(G(re)||Y(re))return re=wo(re,ue.mode,fe,null),re.return=ue,re;if(typeof re.then=="function")return Ce(ue,Hf(re),fe);if(re.$$typeof===T)return Ce(ue,C_(ue,re),fe);Wf(ue,re)}return null}function _e(ue,re,fe,Te){var Ve=re!==null?re.key:null;if(typeof fe=="string"&&fe!==""||typeof fe=="number"||typeof fe=="bigint")return Ve!==null?null:$(ue,re,""+fe,Te);if(typeof fe=="object"&&fe!==null){switch(fe.$$typeof){case g:return fe.key===Ve?ae(ue,re,fe,Te):null;case y:return fe.key===Ve?pe(ue,re,fe,Te):null;case O:return Ve=fe._init,fe=Ve(fe._payload),_e(ue,re,fe,Te)}if(G(fe)||Y(fe))return Ve!==null?null:be(ue,re,fe,Te,null);if(typeof fe.then=="function")return _e(ue,re,Hf(fe),Te);if(fe.$$typeof===T)return _e(ue,re,C_(ue,fe),Te);Wf(ue,fe)}return null}function ye(ue,re,fe,Te,Ve){if(typeof Te=="string"&&Te!==""||typeof Te=="number"||typeof Te=="bigint")return ue=ue.get(fe)||null,$(re,ue,""+Te,Ve);if(typeof Te=="object"&&Te!==null){switch(Te.$$typeof){case g:return ue=ue.get(Te.key===null?fe:Te.key)||null,ae(re,ue,Te,Ve);case y:return ue=ue.get(Te.key===null?fe:Te.key)||null,pe(re,ue,Te,Ve);case O:var Pt=Te._init;return Te=Pt(Te._payload),ye(ue,re,fe,Te,Ve)}if(G(Te)||Y(Te))return ue=ue.get(fe)||null,be(re,ue,Te,Ve,null);if(typeof Te.then=="function")return ye(ue,re,fe,Hf(Te),Ve);if(Te.$$typeof===T)return ye(ue,re,fe,C_(re,Te),Ve);Wf(re,Te)}return null}function nt(ue,re,fe,Te){for(var Ve=null,Pt=null,qe=re,tt=re=0,ca=null;qe!==null&&tt<fe.length;tt++){qe.index>tt?(ca=qe,qe=null):ca=qe.sibling;var ts=_e(ue,qe,fe[tt],Te);if(ts===null){qe===null&&(qe=ca);break}o&&qe&&ts.alternate===null&&c(ue,qe),re=P(ts,re,tt),Pt===null?Ve=ts:Pt.sibling=ts,Pt=ts,qe=ca}if(tt===fe.length)return m(ue,qe),Ht&&Tn(ue,tt),Ve;if(qe===null){for(;tt<fe.length;tt++)qe=Ce(ue,fe[tt],Te),qe!==null&&(re=P(qe,re,tt),Pt===null?Ve=qe:Pt.sibling=qe,Pt=qe);return Ht&&Tn(ue,tt),Ve}for(qe=S(qe);tt<fe.length;tt++)ca=ye(qe,ue,tt,fe[tt],Te),ca!==null&&(o&&ca.alternate!==null&&qe.delete(ca.key===null?tt:ca.key),re=P(ca,re,tt),Pt===null?Ve=ca:Pt.sibling=ca,Pt=ca);return o&&qe.forEach(function(Ku){return c(ue,Ku)}),Ht&&Tn(ue,tt),Ve}function Ze(ue,re,fe,Te){if(fe==null)throw Error(s(151));for(var Ve=null,Pt=null,qe=re,tt=re=0,ca=null,ts=fe.next();qe!==null&&!ts.done;tt++,ts=fe.next()){qe.index>tt?(ca=qe,qe=null):ca=qe.sibling;var Ku=_e(ue,qe,ts.value,Te);if(Ku===null){qe===null&&(qe=ca);break}o&&qe&&Ku.alternate===null&&c(ue,qe),re=P(Ku,re,tt),Pt===null?Ve=Ku:Pt.sibling=Ku,Pt=Ku,qe=ca}if(ts.done)return m(ue,qe),Ht&&Tn(ue,tt),Ve;if(qe===null){for(;!ts.done;tt++,ts=fe.next())ts=Ce(ue,ts.value,Te),ts!==null&&(re=P(ts,re,tt),Pt===null?Ve=ts:Pt.sibling=ts,Pt=ts);return Ht&&Tn(ue,tt),Ve}for(qe=S(qe);!ts.done;tt++,ts=fe.next())ts=ye(qe,ue,tt,ts.value,Te),ts!==null&&(o&&ts.alternate!==null&&qe.delete(ts.key===null?tt:ts.key),re=P(ts,re,tt),Pt===null?Ve=ts:Pt.sibling=ts,Pt=ts);return o&&qe.forEach(function(qk){return c(ue,qk)}),Ht&&Tn(ue,tt),Ve}function Cs(ue,re,fe,Te){if(typeof fe=="object"&&fe!==null&&fe.type===v&&fe.key===null&&(fe=fe.props.children),typeof fe=="object"&&fe!==null){switch(fe.$$typeof){case g:e:{for(var Ve=fe.key;re!==null;){if(re.key===Ve){if(Ve=fe.type,Ve===v){if(re.tag===7){m(ue,re.sibling),Te=E(re,fe.props.children),Te.return=ue,ue=Te;break e}}else if(re.elementType===Ve||typeof Ve=="object"&&Ve!==null&&Ve.$$typeof===O&&vv(Ve)===re.type){m(ue,re.sibling),Te=E(re,fe.props),sc(Te,fe),Te.return=ue,ue=Te;break e}m(ue,re);break}else c(ue,re);re=re.sibling}fe.type===v?(Te=wo(fe.props.children,ue.mode,Te,fe.key),Te.return=ue,ue=Te):(Te=vu(fe.type,fe.key,fe.props,null,ue.mode,Te),sc(Te,fe),Te.return=ue,ue=Te)}return j(ue);case y:e:{for(Ve=fe.key;re!==null;){if(re.key===Ve)if(re.tag===4&&re.stateNode.containerInfo===fe.containerInfo&&re.stateNode.implementation===fe.implementation){m(ue,re.sibling),Te=E(re,fe.children||[]),Te.return=ue,ue=Te;break e}else{m(ue,re);break}else c(ue,re);re=re.sibling}Te=wf(fe,ue.mode,Te),Te.return=ue,ue=Te}return j(ue);case O:return Ve=fe._init,fe=Ve(fe._payload),Cs(ue,re,fe,Te)}if(G(fe))return nt(ue,re,fe,Te);if(Y(fe)){if(Ve=Y(fe),typeof Ve!="function")throw Error(s(150));return fe=Ve.call(fe),Ze(ue,re,fe,Te)}if(typeof fe.then=="function")return Cs(ue,re,Hf(fe),Te);if(fe.$$typeof===T)return Cs(ue,re,C_(ue,fe),Te);Wf(ue,fe)}return typeof fe=="string"&&fe!==""||typeof fe=="number"||typeof fe=="bigint"?(fe=""+fe,re!==null&&re.tag===6?(m(ue,re.sibling),Te=E(re,fe),Te.return=ue,ue=Te):(m(ue,re),Te=S_(fe,ue.mode,Te),Te.return=ue,ue=Te),j(ue)):m(ue,re)}return function(ue,re,fe,Te){try{Sa=0;var Ve=Cs(ue,re,fe,Te);return Mu=null,Ve}catch(qe){if(qe===Zh||qe===Jh)throw qe;var Pt=Oa(29,qe,null,ue.mode);return Pt.lanes=Te,Pt.return=ue,Pt}finally{}}}var Du=Sv(!0),bv=Sv(!1),cn=Q(null),kr=null;function Bl(o){var c=o.alternate;J(Et,Et.current&1),J(cn,o),kr===null&&(c===null||Eu.current!==null||c.memoizedState!==null)&&(kr=o)}function LT(o){if(o.tag===22){if(J(Et,Et.current),J(cn,o),kr===null){var c=o.alternate;c!==null&&c.memoizedState!==null&&(kr=o)}}else Io()}function Io(){J(Et,Et.current),J(cn,cn.current)}function Oo(o){se(cn),kr===o&&(kr=null),se(Et)}var Et=Q(0);function qf(o){for(var c=o;c!==null;){if(c.tag===13){var m=c.memoizedState;if(m!==null&&(m=m.dehydrated,m===null||m.data==="$?"||Lw(m)))return c}else if(c.tag===19&&c.memoizedProps.revealOrder!==void 0){if((c.flags&128)!==0)return c}else if(c.child!==null){c.child.return=c,c=c.child;continue}if(c===o)break;for(;c.sibling===null;){if(c.return===null||c.return===o)return null;c=c.return}c.sibling.return=c.return,c=c.sibling}return null}function xv(o,c,m,S){c=o.memoizedState,m=m(S,c),m=m==null?c:f({},c,m),o.memoizedState=m,o.lanes===0&&(o.updateQueue.baseState=m)}var B_={enqueueSetState:function(o,c,m){o=o._reactInternals;var S=ai(),E=Br(S);E.payload=c,m!=null&&(E.callback=m),c=va(o,E,S),c!==null&&(fi(c,o,S),tc(c,o,S))},enqueueReplaceState:function(o,c,m){o=o._reactInternals;var S=ai(),E=Br(S);E.tag=1,E.payload=c,m!=null&&(E.callback=m),c=va(o,E,S),c!==null&&(fi(c,o,S),tc(c,o,S))},enqueueForceUpdate:function(o,c){o=o._reactInternals;var m=ai(),S=Br(m);S.tag=2,c!=null&&(S.callback=c),c=va(o,S,m),c!==null&&(fi(c,o,m),tc(c,o,m))}};function Tv(o,c,m,S,E,P,j){return o=o.stateNode,typeof o.shouldComponentUpdate=="function"?o.shouldComponentUpdate(S,P,j):c.prototype&&c.prototype.isPureReactComponent?!mu(m,S)||!mu(E,P):!0}function ic(o,c,m,S){o=c.state,typeof c.componentWillReceiveProps=="function"&&c.componentWillReceiveProps(m,S),typeof c.UNSAFE_componentWillReceiveProps=="function"&&c.UNSAFE_componentWillReceiveProps(m,S),c.state!==o&&B_.enqueueReplaceState(c,c.state,null)}function No(o,c){var m=c;if("ref"in c){m={};for(var S in c)S!=="ref"&&(m[S]=c[S])}if(o=o.defaultProps){m===c&&(m=f({},m));for(var E in o)m[E]===void 0&&(m[E]=o[E])}return m}var Fo=typeof reportError=="function"?reportError:function(o){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var c=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof o=="object"&&o!==null&&typeof o.message=="string"?String(o.message):String(o),error:o});if(!window.dispatchEvent(c))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",o);return}console.error(o)};function ac(o){Fo(o)}function ka(o){console.error(o)}function IT(o){Fo(o)}function U_(o,c){try{var m=o.onUncaughtError;m(c.value,{componentStack:c.stack})}catch(S){setTimeout(function(){throw S})}}function Xf(o,c,m){try{var S=o.onCaughtError;S(m.value,{componentStack:m.stack,errorBoundary:c.tag===1?c.stateNode:null})}catch(E){setTimeout(function(){throw E})}}function Pu(o,c,m){return m=Br(m),m.tag=3,m.payload={element:null},m.callback=function(){U_(o,c)},m}function jf(o){return o=Br(o),o.tag=3,o}function z_(o,c,m,S){var E=m.type.getDerivedStateFromError;if(typeof E=="function"){var P=S.value;o.payload=function(){return E(P)},o.callback=function(){Xf(c,m,S)}}var j=m.stateNode;j!==null&&typeof j.componentDidCatch=="function"&&(o.callback=function(){Xf(c,m,S),typeof E!="function"&&(Kl===null?Kl=new Set([this]):Kl.add(this));var $=S.stack;this.componentDidCatch(S.value,{componentStack:$!==null?$:""})})}function gw(o,c,m,S,E){if(m.flags|=32768,S!==null&&typeof S=="object"&&typeof S.then=="function"){if(c=m.alternate,c!==null&&Kh(c,m,E,!0),m=cn.current,m!==null){switch(m.tag){case 13:return kr===null?jr():m.alternate===null&&yt===0&&(yt=3),m.flags&=-257,m.flags|=65536,m.lanes=E,S===Il?m.flags|=16384:(c=m.updateQueue,c===null?m.updateQueue=new Set([S]):c.add(S),we(o,S,E)),!1;case 22:return m.flags|=65536,S===Il?m.flags|=16384:(c=m.updateQueue,c===null?(c={transitions:null,markerInstances:null,retryQueue:new Set([S])},m.updateQueue=c):(m=c.retryQueue,m===null?c.retryQueue=new Set([S]):m.add(S)),we(o,S,E)),!1}throw Error(s(435,m.tag))}return we(o,S,E),jr(),!1}if(Ht)return c=cn.current,c!==null?((c.flags&65536)===0&&(c.flags|=256),c.flags|=65536,c.lanes=E,S!==Xy&&(o=Error(s(422),{cause:S}),bu(Di(o,m)))):(S!==Xy&&(c=Error(s(423),{cause:S}),bu(Di(c,m))),o=o.current.alternate,o.flags|=65536,E&=-E,o.lanes|=E,S=Di(S,m),E=Pu(o.stateNode,S,E),Jy(o,E),yt!==4&&(yt=2)),!1;var P=Error(s(520),{cause:S});if(P=Di(P,m),jl===null?jl=[P]:jl.push(P),yt!==4&&(yt=2),c===null)return!0;S=Di(S,m),m=c;do{switch(m.tag){case 3:return m.flags|=65536,o=E&-E,m.lanes|=o,o=Pu(m.stateNode,S,o),Jy(m,o),!1;case 1:if(c=m.type,P=m.stateNode,(m.flags&128)===0&&(typeof c.getDerivedStateFromError=="function"||P!==null&&typeof P.componentDidCatch=="function"&&(Kl===null||!Kl.has(P))))return m.flags|=65536,E&=-E,m.lanes|=E,E=jf(E),z_(E,o,m,S),Jy(m,E),!1}m=m.return}while(m!==null);return!1}var OT=Error(s(461)),ls=!1;function Ii(o,c,m,S){c.child=o===null?bv(c,null,m,S):Du(c,o.child,m,S)}function NT(o,c,m,S,E){m=m.render;var P=c.ref;if("ref"in S){var j={};for(var $ in S)$!=="ref"&&(j[$]=S[$])}else j=S;return Ll(c),S=Ba(o,c,m,j,P,E),$=$n(),o!==null&&!ls?(sv(o,c,E),Ls(o,c,E)):(Ht&&$&&b_(c),c.flags|=1,Ii(o,c,S,E),c.child)}function k_(o,c,m,S,E){if(o===null){var P=m.type;return typeof P=="function"&&!yu(P)&&P.defaultProps===void 0&&m.compare===null?(c.tag=15,c.type=P,FT(o,c,P,S,E)):(o=vu(m.type,null,S,c,c.mode,E),o.ref=c.ref,o.return=c,c.child=o)}if(P=o.child,!nc(o,E)){var j=P.memoizedProps;if(m=m.compare,m=m!==null?m:mu,m(j,S)&&o.ref===c.ref)return Ls(o,c,E)}return c.flags|=1,o=Pr(P,S),o.ref=c.ref,o.return=c,c.child=o}function FT(o,c,m,S,E){if(o!==null){var P=o.memoizedProps;if(mu(P,S)&&o.ref===c.ref)if(ls=!1,c.pendingProps=S=P,nc(o,E))(o.flags&131072)!==0&&(ls=!0);else return c.lanes=o.lanes,Ls(o,c,E)}return ba(o,c,m,S,E)}function BT(o,c,m){var S=c.pendingProps,E=S.children,P=o!==null?o.memoizedState:null;if(S.mode==="hidden"){if((c.flags&128)!==0){if(S=P!==null?P.baseLanes|m:m,o!==null){for(E=c.child=o.child,P=0;E!==null;)P=P|E.lanes|E.childLanes,E=E.sibling;c.childLanes=P&~S}else c.childLanes=0,c.child=null;return UT(o,c,S,m)}if((m&536870912)!==0)c.memoizedState={baseLanes:0,cachePool:null},o!==null&&w_(c,P!==null?P.cachePool:null),P!==null?Au(c,P):ev(),LT(c);else return c.lanes=c.childLanes=536870912,UT(o,c,P!==null?P.baseLanes|m:m,m)}else P!==null?(w_(c,P.cachePool),Au(c,P),Io(),c.memoizedState=null):(o!==null&&w_(c,null),ev(),Io());return Ii(o,c,E,m),c.child}function UT(o,c,m,S){var E=_t();return E=E===null?null:{parent:li._currentValue,pool:E},c.memoizedState={baseLanes:m,cachePool:E},o!==null&&w_(c,null),ev(),LT(c),o!==null&&Kh(o,c,S,!0),null}function Ul(o,c){var m=c.ref;if(m===null)o!==null&&o.ref!==null&&(c.flags|=4194816);else{if(typeof m!="function"&&typeof m!="object")throw Error(s(284));(o===null||o.ref!==m)&&(c.flags|=4194816)}}function ba(o,c,m,S,E){return Ll(c),m=Ba(o,c,m,S,void 0,E),S=$n(),o!==null&&!ls?(sv(o,c,E),Ls(o,c,E)):(Ht&&S&&b_(c),c.flags|=1,Ii(o,c,m,E),c.child)}function V_(o,c,m,S,E,P){return Ll(c),c.updateQueue=null,m=sT(c,S,m,E),tT(o),S=$n(),o!==null&&!ls?(sv(o,c,P),Ls(o,c,P)):(Ht&&S&&b_(c),c.flags|=1,Ii(o,c,m,P),c.child)}function Ev(o,c,m,S,E){if(Ll(c),c.stateNode===null){var P=qh,j=m.contextType;typeof j=="object"&&j!==null&&(P=na(j)),P=new m(S,P),c.memoizedState=P.state!==null&&P.state!==void 0?P.state:null,P.updater=B_,c.stateNode=P,P._reactInternals=c,P=c.stateNode,P.props=S,P.state=c.memoizedState,P.refs={},Lf(c),j=m.contextType,P.context=typeof j=="object"&&j!==null?na(j):qh,P.state=c.memoizedState,j=m.getDerivedStateFromProps,typeof j=="function"&&(xv(c,m,j,S),P.state=c.memoizedState),typeof m.getDerivedStateFromProps=="function"||typeof P.getSnapshotBeforeUpdate=="function"||typeof P.UNSAFE_componentWillMount!="function"&&typeof P.componentWillMount!="function"||(j=P.state,typeof P.componentWillMount=="function"&&P.componentWillMount(),typeof P.UNSAFE_componentWillMount=="function"&&P.UNSAFE_componentWillMount(),j!==P.state&&B_.enqueueReplaceState(P,P.state,null),Ol(c,S,P,E),Of(),P.state=c.memoizedState),typeof P.componentDidMount=="function"&&(c.flags|=4194308),S=!0}else if(o===null){P=c.stateNode;var $=c.memoizedProps,ae=No(m,$);P.props=ae;var pe=P.context,be=m.contextType;j=qh,typeof be=="object"&&be!==null&&(j=na(be));var Ce=m.getDerivedStateFromProps;be=typeof Ce=="function"||typeof P.getSnapshotBeforeUpdate=="function",$=c.pendingProps!==$,be||typeof P.UNSAFE_componentWillReceiveProps!="function"&&typeof P.componentWillReceiveProps!="function"||($||pe!==j)&&ic(c,P,S,j),Fr=!1;var _e=c.memoizedState;P.state=_e,Ol(c,S,P,E),Of(),pe=c.memoizedState,$||_e!==pe||Fr?(typeof Ce=="function"&&(xv(c,m,Ce,S),pe=c.memoizedState),(ae=Fr||Tv(c,m,ae,S,_e,pe,j))?(be||typeof P.UNSAFE_componentWillMount!="function"&&typeof P.componentWillMount!="function"||(typeof P.componentWillMount=="function"&&P.componentWillMount(),typeof P.UNSAFE_componentWillMount=="function"&&P.UNSAFE_componentWillMount()),typeof P.componentDidMount=="function"&&(c.flags|=4194308)):(typeof P.componentDidMount=="function"&&(c.flags|=4194308),c.memoizedProps=S,c.memoizedState=pe),P.props=S,P.state=pe,P.context=j,S=ae):(typeof P.componentDidMount=="function"&&(c.flags|=4194308),S=!1)}else{P=c.stateNode,If(o,c),j=c.memoizedProps,be=No(m,j),P.props=be,Ce=c.pendingProps,_e=P.context,pe=m.contextType,ae=qh,typeof pe=="object"&&pe!==null&&(ae=na(pe)),$=m.getDerivedStateFromProps,(pe=typeof $=="function"||typeof P.getSnapshotBeforeUpdate=="function")||typeof P.UNSAFE_componentWillReceiveProps!="function"&&typeof P.componentWillReceiveProps!="function"||(j!==Ce||_e!==ae)&&ic(c,P,S,ae),Fr=!1,_e=c.memoizedState,P.state=_e,Ol(c,S,P,E),Of();var ye=c.memoizedState;j!==Ce||_e!==ye||Fr||o!==null&&o.dependencies!==null&&A_(o.dependencies)?(typeof $=="function"&&(xv(c,m,$,S),ye=c.memoizedState),(be=Fr||Tv(c,m,be,S,_e,ye,ae)||o!==null&&o.dependencies!==null&&A_(o.dependencies))?(pe||typeof P.UNSAFE_componentWillUpdate!="function"&&typeof P.componentWillUpdate!="function"||(typeof P.componentWillUpdate=="function"&&P.componentWillUpdate(S,ye,ae),typeof P.UNSAFE_componentWillUpdate=="function"&&P.UNSAFE_componentWillUpdate(S,ye,ae)),typeof P.componentDidUpdate=="function"&&(c.flags|=4),typeof P.getSnapshotBeforeUpdate=="function"&&(c.flags|=1024)):(typeof P.componentDidUpdate!="function"||j===o.memoizedProps&&_e===o.memoizedState||(c.flags|=4),typeof P.getSnapshotBeforeUpdate!="function"||j===o.memoizedProps&&_e===o.memoizedState||(c.flags|=1024),c.memoizedProps=S,c.memoizedState=ye),P.props=S,P.state=ye,P.context=ae,S=be):(typeof P.componentDidUpdate!="function"||j===o.memoizedProps&&_e===o.memoizedState||(c.flags|=4),typeof P.getSnapshotBeforeUpdate!="function"||j===o.memoizedProps&&_e===o.memoizedState||(c.flags|=1024),S=!1)}return P=S,Ul(o,c),S=(c.flags&128)!==0,P||S?(P=c.stateNode,m=S&&typeof m.getDerivedStateFromError!="function"?null:P.render(),c.flags|=1,o!==null&&S?(c.child=Du(c,o.child,null,E),c.child=Du(c,null,m,E)):Ii(o,c,m,E),c.memoizedState=P.state,o=c.child):o=Ls(o,c,E),o}function G_(o,c,m,S){return Su(),c.flags|=256,Ii(o,c,m,S),c.child}var H_={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function zl(o){return{baseLanes:o,cachePool:Fa()}}function kl(o,c,m){return o=o!==null?o.childLanes&~m:0,c&&(o|=ji),o}function Yf(o,c,m){var S=c.pendingProps,E=!1,P=(c.flags&128)!==0,j;if((j=P)||(j=o!==null&&o.memoizedState===null?!1:(Et.current&2)!==0),j&&(E=!0,c.flags&=-129),j=(c.flags&32)!==0,c.flags&=-33,o===null){if(Ht){if(E?Bl(c):Io(),Ht){var $=Fs,ae;if(ae=$){e:{for(ae=$,$=Ir;ae.nodeType!==8;){if(!$){$=null;break e}if(ae=Go(ae.nextSibling),ae===null){$=null;break e}}$=ae}$!==null?(c.memoizedState={dehydrated:$,treeContext:Na!==null?{id:Lr,overflow:Kn}:null,retryLane:536870912,hydrationErrors:null},ae=Oa(18,null,null,0),ae.stateNode=$,ae.return=c,c.child=ae,aa=c,Fs=null,ae=!0):ae=!1}ae||Ml(c)}if($=c.memoizedState,$!==null&&($=$.dehydrated,$!==null))return Lw($)?c.lanes=32:c.lanes=536870912,null;Oo(c)}return $=S.children,S=S.fallback,E?(Io(),E=c.mode,$=xa({mode:"hidden",children:$},E),S=wo(S,E,m,null),$.return=c,S.return=c,$.sibling=S,c.child=$,E=c.child,E.memoizedState=zl(m),E.childLanes=kl(o,j,m),c.memoizedState=H_,S):(Bl(c),Lu(c,$))}if(ae=o.memoizedState,ae!==null&&($=ae.dehydrated,$!==null)){if(P)c.flags&256?(Bl(c),c.flags&=-257,c=Va(o,c,m)):c.memoizedState!==null?(Io(),c.child=o.child,c.flags|=128,c=null):(Io(),E=S.fallback,$=c.mode,S=xa({mode:"visible",children:S.children},$),E=wo(E,$,m,null),E.flags|=2,S.return=c,E.return=c,S.sibling=E,c.child=S,Du(c,o.child,null,m),S=c.child,S.memoizedState=zl(m),S.childLanes=kl(o,j,m),c.memoizedState=H_,c=E);else if(Bl(c),Lw($)){if(j=$.nextSibling&&$.nextSibling.dataset,j)var pe=j.dgst;j=pe,S=Error(s(419)),S.stack="",S.digest=j,bu({value:S,source:null,stack:null}),c=Va(o,c,m)}else if(ls||Kh(o,c,m,!1),j=(m&o.childLanes)!==0,ls||j){if(j=hs,j!==null&&(S=m&-m,S=(S&42)!==0?1:Gm(S),S=(S&(j.suspendedLanes|m))!==0?0:S,S!==0&&S!==ae.retryLane))throw ae.retryLane=S,Dr(o,S),fi(j,o,S),OT;$.data==="$?"||jr(),c=Va(o,c,m)}else $.data==="$?"?(c.flags|=192,c.child=o.child,c=null):(o=ae.treeContext,Fs=Go($.nextSibling),aa=c,Ht=!0,jh=null,Ir=!1,o!==null&&(hn[xn++]=Lr,hn[xn++]=Kn,hn[xn++]=Na,Lr=o.id,Kn=o.overflow,Na=c),c=Lu(c,S.children),c.flags|=4096);return c}return E?(Io(),E=S.fallback,$=c.mode,ae=o.child,pe=ae.sibling,S=Pr(ae,{mode:"hidden",children:S.children}),S.subtreeFlags=ae.subtreeFlags&65011712,pe!==null?E=Pr(pe,E):(E=wo(E,$,m,null),E.flags|=2),E.return=c,S.return=c,S.sibling=E,c.child=S,S=E,E=c.child,$=o.child.memoizedState,$===null?$=zl(m):(ae=$.cachePool,ae!==null?(pe=li._currentValue,ae=ae.parent!==pe?{parent:pe,pool:pe}:ae):ae=Fa(),$={baseLanes:$.baseLanes|m,cachePool:ae}),E.memoizedState=$,E.childLanes=kl(o,j,m),c.memoizedState=H_,S):(Bl(c),m=o.child,o=m.sibling,m=Pr(m,{mode:"visible",children:S.children}),m.return=c,m.sibling=null,o!==null&&(j=c.deletions,j===null?(c.deletions=[o],c.flags|=16):j.push(o)),c.child=m,c.memoizedState=null,m)}function Lu(o,c){return c=xa({mode:"visible",children:c},o.mode),c.return=o,o.child=c}function xa(o,c){return o=Oa(22,o,null,c),o.lanes=0,o.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null},o}function Va(o,c,m){return Du(c,o.child,null,m),o=Lu(c,c.pendingProps.children),o.flags|=2,c.memoizedState=null,o}function Vl(o,c,m){o.lanes|=c;var S=o.alternate;S!==null&&(S.lanes|=c),E_(o.return,c,m)}function Zn(o,c,m,S,E){var P=o.memoizedState;P===null?o.memoizedState={isBackwards:c,rendering:null,renderingStartTime:0,last:S,tail:m,tailMode:E}:(P.isBackwards=c,P.rendering=null,P.renderingStartTime=0,P.last=S,P.tail=m,P.tailMode=E)}function Vr(o,c,m){var S=c.pendingProps,E=S.revealOrder,P=S.tail;if(Ii(o,c,S.children,m),S=Et.current,(S&2)!==0)S=S&1|2,c.flags|=128;else{if(o!==null&&(o.flags&128)!==0)e:for(o=c.child;o!==null;){if(o.tag===13)o.memoizedState!==null&&Vl(o,m,c);else if(o.tag===19)Vl(o,m,c);else if(o.child!==null){o.child.return=o,o=o.child;continue}if(o===c)break e;for(;o.sibling===null;){if(o.return===null||o.return===c)break e;o=o.return}o.sibling.return=o.return,o=o.sibling}S&=1}switch(J(Et,S),E){case"forwards":for(m=c.child,E=null;m!==null;)o=m.alternate,o!==null&&qf(o)===null&&(E=m),m=m.sibling;m=E,m===null?(E=c.child,c.child=null):(E=m.sibling,m.sibling=null),Zn(c,!1,E,m,P);break;case"backwards":for(m=null,E=c.child,c.child=null;E!==null;){if(o=E.alternate,o!==null&&qf(o)===null){c.child=E;break}o=E.sibling,E.sibling=m,m=E,E=o}Zn(c,!0,m,null,P);break;case"together":Zn(c,!1,null,null,void 0);break;default:c.memoizedState=null}return c.child}function Ls(o,c,m){if(o!==null&&(c.dependencies=o.dependencies),Ss|=c.lanes,(m&c.childLanes)===0)if(o!==null){if(Kh(o,c,m,!1),(m&c.childLanes)===0)return null}else return null;if(o!==null&&c.child!==o.child)throw Error(s(153));if(c.child!==null){for(o=c.child,m=Pr(o,o.pendingProps),c.child=m,m.return=c;o.sibling!==null;)o=o.sibling,m=m.sibling=Pr(o,o.pendingProps),m.return=c;m.sibling=null}return c.child}function nc(o,c){return(o.lanes&c)!==0?!0:(o=o.dependencies,!!(o!==null&&A_(o)))}function Gl(o,c,m){switch(c.tag){case 3:le(c,c.stateNode.containerInfo),En(c,li,o.memoizedState.cache),Su();break;case 27:case 5:Ae(c);break;case 4:le(c,c.stateNode.containerInfo);break;case 10:En(c,c.type,c.memoizedProps.value);break;case 13:var S=c.memoizedState;if(S!==null)return S.dehydrated!==null?(Bl(c),c.flags|=128,null):(m&c.child.childLanes)!==0?Yf(o,c,m):(Bl(c),o=Ls(o,c,m),o!==null?o.sibling:null);Bl(c);break;case 19:var E=(o.flags&128)!==0;if(S=(m&c.childLanes)!==0,S||(Kh(o,c,m,!1),S=(m&c.childLanes)!==0),E){if(S)return Vr(o,c,m);c.flags|=128}if(E=c.memoizedState,E!==null&&(E.rendering=null,E.tail=null,E.lastEffect=null),J(Et,Et.current),S)break;return null;case 22:case 23:return c.lanes=0,BT(o,c,m);case 24:En(c,li,o.memoizedState.cache)}return Ls(o,c,m)}function Kf(o,c,m){if(o!==null)if(o.memoizedProps!==c.pendingProps)ls=!0;else{if(!nc(o,m)&&(c.flags&128)===0)return ls=!1,Gl(o,c,m);ls=(o.flags&131072)!==0}else ls=!1,Ht&&(c.flags&1048576)!==0&&qy(c,Rf,c.index);switch(c.lanes=0,c.tag){case 16:e:{o=c.pendingProps;var S=c.elementType,E=S._init;if(S=E(S._payload),c.type=S,typeof S=="function")yu(S)?(o=No(S,o),c.tag=1,c=Ev(null,c,S,o,m)):(c.tag=0,c=ba(null,c,S,o,m));else{if(S!=null){if(E=S.$$typeof,E===R){c.tag=11,c=NT(null,c,S,o,m);break e}else if(E===U){c.tag=14,c=k_(null,c,S,o,m);break e}}throw c=q(S)||S,Error(s(306,c,""))}}return c;case 0:return ba(o,c,c.type,c.pendingProps,m);case 1:return S=c.type,E=No(S,c.pendingProps),Ev(o,c,S,E,m);case 3:e:{if(le(c,c.stateNode.containerInfo),o===null)throw Error(s(387));S=c.pendingProps;var P=c.memoizedState;E=P.element,If(o,c),Ol(c,S,null,m);var j=c.memoizedState;if(S=j.cache,En(c,li,S),S!==P.cache&&Qt(c,[li],m,!0),Of(),S=j.element,P.isDehydrated)if(P={element:S,isDehydrated:!1,cache:j.cache},c.updateQueue.baseState=P,c.memoizedState=P,c.flags&256){c=G_(o,c,S,m);break e}else if(S!==E){E=Di(Error(s(424)),c),bu(E),c=G_(o,c,S,m);break e}else{switch(o=c.stateNode.containerInfo,o.nodeType){case 9:o=o.body;break;default:o=o.nodeName==="HTML"?o.ownerDocument.body:o}for(Fs=Go(o.firstChild),aa=c,Ht=!0,jh=null,Ir=!0,m=bv(c,null,S,m),c.child=m;m;)m.flags=m.flags&-3|4096,m=m.sibling}else{if(Su(),S===E){c=Ls(o,c,m);break e}Ii(o,c,S,m)}c=c.child}return c;case 26:return Ul(o,c),o===null?(m=sI(c.type,null,c.pendingProps,null))?c.memoizedState=m:Ht||(m=c.type,o=c.pendingProps,S=qT(he.current).createElement(m),S[si]=c,S[_a]=o,Ca(S,m,o),gi(S),c.stateNode=S):c.memoizedState=sI(c.type,o.memoizedProps,c.pendingProps,o.memoizedState),null;case 27:return Ae(c),o===null&&Ht&&(S=c.stateNode=JL(c.type,c.pendingProps,he.current),aa=c,Ir=!0,E=Fs,Wu(c.type)?(Iw=E,Fs=Go(S.firstChild)):Fs=E),Ii(o,c,c.pendingProps.children,m),Ul(o,c),o===null&&(c.flags|=4194304),c.child;case 5:return o===null&&Ht&&((E=S=Fs)&&(S=Sk(S,c.type,c.pendingProps,Ir),S!==null?(c.stateNode=S,aa=c,Fs=Go(S.firstChild),Ir=!1,E=!0):E=!1),E||Ml(c)),Ae(c),E=c.type,P=c.pendingProps,j=o!==null?o.memoizedProps:null,S=P.children,Mw(E,P)?S=null:j!==null&&Mw(E,j)&&(c.flags|=32),c.memoizedState!==null&&(E=Ba(o,c,Li,null,null,m),Fv._currentValue=E),Ul(o,c),Ii(o,c,S,m),c.child;case 6:return o===null&&Ht&&((o=m=Fs)&&(m=bk(m,c.pendingProps,Ir),m!==null?(c.stateNode=m,aa=c,Fs=null,o=!0):o=!1),o||Ml(c)),null;case 13:return Yf(o,c,m);case 4:return le(c,c.stateNode.containerInfo),S=c.pendingProps,o===null?c.child=Du(c,null,S,m):Ii(o,c,S,m),c.child;case 11:return NT(o,c,c.type,c.pendingProps,m);case 7:return Ii(o,c,c.pendingProps,m),c.child;case 8:return Ii(o,c,c.pendingProps.children,m),c.child;case 12:return Ii(o,c,c.pendingProps.children,m),c.child;case 10:return S=c.pendingProps,En(c,c.type,S.value),Ii(o,c,S.children,m),c.child;case 9:return E=c.type._context,S=c.pendingProps.children,Ll(c),E=na(E),S=S(E),c.flags|=1,Ii(o,c,S,m),c.child;case 14:return k_(o,c,c.type,c.pendingProps,m);case 15:return FT(o,c,c.type,c.pendingProps,m);case 19:return Vr(o,c,m);case 31:return S=c.pendingProps,m=c.mode,S={mode:S.mode,children:S.children},o===null?(m=xa(S,m),m.ref=c.ref,c.child=m,m.return=c,c=m):(m=Pr(o.child,S),m.ref=c.ref,c.child=m,m.return=c,c=m),c;case 22:return BT(o,c,m);case 24:return Ll(c),S=na(li),o===null?(E=_t(),E===null&&(E=hs,P=xu(),E.pooledCache=P,P.refCount++,P!==null&&(E.pooledCacheLanes|=m),E=P),c.memoizedState={parent:S,cache:E},Lf(c),En(c,li,E)):((o.lanes&m)!==0&&(If(o,c),Ol(c,null,null,m),Of()),E=o.memoizedState,P=c.memoizedState,E.parent!==S?(E={parent:S,cache:S},c.memoizedState=E,c.lanes===0&&(c.memoizedState=c.updateQueue.baseState=E),En(c,li,S)):(S=P.cache,En(c,li,S),S!==E.cache&&Qt(c,[li],m,!0))),Ii(o,c,c.pendingProps.children,m),c.child;case 29:throw c.pendingProps}throw Error(s(156,c.tag))}function Vs(o){o.flags|=4}function ci(o,c){if(c.type!=="stylesheet"||(c.state.loading&4)!==0)o.flags&=-16777217;else if(o.flags|=16777216,!oI(c)){if(c=cn.current,c!==null&&((Ot&4194048)===Ot?kr!==null:(Ot&62914560)!==Ot&&(Ot&536870912)===0||c!==kr))throw Pf=Il,Jx;o.flags|=8192}}function zt(o,c){c!==null&&(o.flags|=4),o.flags&16384&&(c=o.tag!==22?nf():536870912,o.lanes|=c,Uu|=c)}function Jn(o,c){if(!Ht)switch(o.tailMode){case"hidden":c=o.tail;for(var m=null;c!==null;)c.alternate!==null&&(m=c),c=c.sibling;m===null?o.tail=null:m.sibling=null;break;case"collapsed":m=o.tail;for(var S=null;m!==null;)m.alternate!==null&&(S=m),m=m.sibling;S===null?c||o.tail===null?o.tail=null:o.tail.sibling=null:S.sibling=null}}function Yt(o){var c=o.alternate!==null&&o.alternate.child===o.child,m=0,S=0;if(c)for(var E=o.child;E!==null;)m|=E.lanes|E.childLanes,S|=E.subtreeFlags&65011712,S|=E.flags&65011712,E.return=o,E=E.sibling;else for(E=o.child;E!==null;)m|=E.lanes|E.childLanes,S|=E.subtreeFlags,S|=E.flags,E.return=o,E=E.sibling;return o.subtreeFlags|=S,o.childLanes=m,c}function Av(o,c,m){var S=c.pendingProps;switch(x_(c),c.tag){case 31:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Yt(c),null;case 1:return Yt(c),null;case 3:return m=c.stateNode,S=null,o!==null&&(S=o.memoizedState.cache),c.memoizedState.cache!==S&&(c.flags|=2048),Nr(li),Se(),m.pendingContext&&(m.context=m.pendingContext,m.pendingContext=null),(o===null||o.child===null)&&(Dl(c)?Vs(c):o===null||o.memoizedState.isDehydrated&&(c.flags&256)===0||(c.flags|=1024,Yy())),Yt(c),null;case 26:return m=c.memoizedState,o===null?(Vs(c),m!==null?(Yt(c),ci(c,m)):(Yt(c),c.flags&=-16777217)):m?m!==o.memoizedState?(Vs(c),Yt(c),ci(c,m)):(Yt(c),c.flags&=-16777217):(o.memoizedProps!==S&&Vs(c),Yt(c),c.flags&=-16777217),null;case 27:De(c),m=he.current;var E=c.type;if(o!==null&&c.stateNode!=null)o.memoizedProps!==S&&Vs(c);else{if(!S){if(c.stateNode===null)throw Error(s(166));return Yt(c),null}o=ie.current,Dl(c)?jy(c):(o=JL(E,S,m),c.stateNode=o,Vs(c))}return Yt(c),null;case 5:if(De(c),m=c.type,o!==null&&c.stateNode!=null)o.memoizedProps!==S&&Vs(c);else{if(!S){if(c.stateNode===null)throw Error(s(166));return Yt(c),null}if(o=ie.current,Dl(c))jy(c);else{switch(E=qT(he.current),o){case 1:o=E.createElementNS("http://www.w3.org/2000/svg",m);break;case 2:o=E.createElementNS("http://www.w3.org/1998/Math/MathML",m);break;default:switch(m){case"svg":o=E.createElementNS("http://www.w3.org/2000/svg",m);break;case"math":o=E.createElementNS("http://www.w3.org/1998/Math/MathML",m);break;case"script":o=E.createElement("div"),o.innerHTML="<script><\/script>",o=o.removeChild(o.firstChild);break;case"select":o=typeof S.is=="string"?E.createElement("select",{is:S.is}):E.createElement("select"),S.multiple?o.multiple=!0:S.size&&(o.size=S.size);break;default:o=typeof S.is=="string"?E.createElement(m,{is:S.is}):E.createElement(m)}}o[si]=c,o[_a]=S;e:for(E=c.child;E!==null;){if(E.tag===5||E.tag===6)o.appendChild(E.stateNode);else if(E.tag!==4&&E.tag!==27&&E.child!==null){E.child.return=E,E=E.child;continue}if(E===c)break e;for(;E.sibling===null;){if(E.return===null||E.return===c)break e;E=E.return}E.sibling.return=E.return,E=E.sibling}c.stateNode=o;e:switch(Ca(o,m,S),m){case"button":case"input":case"select":case"textarea":o=!!S.autoFocus;break e;case"img":o=!0;break e;default:o=!1}o&&Vs(c)}}return Yt(c),c.flags&=-16777217,null;case 6:if(o&&c.stateNode!=null)o.memoizedProps!==S&&Vs(c);else{if(typeof S!="string"&&c.stateNode===null)throw Error(s(166));if(o=he.current,Dl(c)){if(o=c.stateNode,m=c.memoizedProps,S=null,E=aa,E!==null)switch(E.tag){case 27:case 5:S=E.memoizedProps}o[si]=c,o=!!(o.nodeValue===m||S!==null&&S.suppressHydrationWarning===!0||XL(o.nodeValue,m)),o||Ml(c)}else o=qT(o).createTextNode(S),o[si]=c,c.stateNode=o}return Yt(c),null;case 13:if(S=c.memoizedState,o===null||o.memoizedState!==null&&o.memoizedState.dehydrated!==null){if(E=Dl(c),S!==null&&S.dehydrated!==null){if(o===null){if(!E)throw Error(s(318));if(E=c.memoizedState,E=E!==null?E.dehydrated:null,!E)throw Error(s(317));E[si]=c}else Su(),(c.flags&128)===0&&(c.memoizedState=null),c.flags|=4;Yt(c),E=!1}else E=Yy(),o!==null&&o.memoizedState!==null&&(o.memoizedState.hydrationErrors=E),E=!0;if(!E)return c.flags&256?(Oo(c),c):(Oo(c),null)}if(Oo(c),(c.flags&128)!==0)return c.lanes=m,c;if(m=S!==null,o=o!==null&&o.memoizedState!==null,m){S=c.child,E=null,S.alternate!==null&&S.alternate.memoizedState!==null&&S.alternate.memoizedState.cachePool!==null&&(E=S.alternate.memoizedState.cachePool.pool);var P=null;S.memoizedState!==null&&S.memoizedState.cachePool!==null&&(P=S.memoizedState.cachePool.pool),P!==E&&(S.flags|=2048)}return m!==o&&m&&(c.child.flags|=8192),zt(c,c.updateQueue),Yt(c),null;case 4:return Se(),o===null&&Ew(c.stateNode.containerInfo),Yt(c),null;case 10:return Nr(c.type),Yt(c),null;case 19:if(se(Et),E=c.memoizedState,E===null)return Yt(c),null;if(S=(c.flags&128)!==0,P=E.rendering,P===null)if(S)Jn(E,!1);else{if(yt!==0||o!==null&&(o.flags&128)!==0)for(o=c.child;o!==null;){if(P=qf(o),P!==null){for(c.flags|=128,Jn(E,!1),o=P.updateQueue,c.updateQueue=o,zt(c,o),c.subtreeFlags=0,o=m,m=c.child;m!==null;)v_(m,o),m=m.sibling;return J(Et,Et.current&1|2),c.child}o=o.sibling}E.tail!==null&&ht()>lc&&(c.flags|=128,S=!0,Jn(E,!1),c.lanes=4194304)}else{if(!S)if(o=qf(P),o!==null){if(c.flags|=128,S=!0,o=o.updateQueue,c.updateQueue=o,zt(c,o),Jn(E,!0),E.tail===null&&E.tailMode==="hidden"&&!P.alternate&&!Ht)return Yt(c),null}else 2*ht()-E.renderingStartTime>lc&&m!==536870912&&(c.flags|=128,S=!0,Jn(E,!1),c.lanes=4194304);E.isBackwards?(P.sibling=c.child,c.child=P):(o=E.last,o!==null?o.sibling=P:c.child=P,E.last=P)}return E.tail!==null?(c=E.tail,E.rendering=c,E.tail=c.sibling,E.renderingStartTime=ht(),c.sibling=null,o=Et.current,J(Et,S?o&1|2:o&1),c):(Yt(c),null);case 22:case 23:return Oo(c),tv(),S=c.memoizedState!==null,o!==null?o.memoizedState!==null!==S&&(c.flags|=8192):S&&(c.flags|=8192),S?(m&536870912)!==0&&(c.flags&128)===0&&(Yt(c),c.subtreeFlags&6&&(c.flags|=8192)):Yt(c),m=c.updateQueue,m!==null&&zt(c,m.retryQueue),m=null,o!==null&&o.memoizedState!==null&&o.memoizedState.cachePool!==null&&(m=o.memoizedState.cachePool.pool),S=null,c.memoizedState!==null&&c.memoizedState.cachePool!==null&&(S=c.memoizedState.cachePool.pool),S!==m&&(c.flags|=2048),o!==null&&se(Mo),null;case 24:return m=null,o!==null&&(m=o.memoizedState.cache),c.memoizedState.cache!==m&&(c.flags|=2048),Nr(li),Yt(c),null;case 25:return null;case 30:return null}throw Error(s(156,c.tag))}function un(o,c){switch(x_(c),c.tag){case 1:return o=c.flags,o&65536?(c.flags=o&-65537|128,c):null;case 3:return Nr(li),Se(),o=c.flags,(o&65536)!==0&&(o&128)===0?(c.flags=o&-65537|128,c):null;case 26:case 27:case 5:return De(c),null;case 13:if(Oo(c),o=c.memoizedState,o!==null&&o.dehydrated!==null){if(c.alternate===null)throw Error(s(340));Su()}return o=c.flags,o&65536?(c.flags=o&-65537|128,c):null;case 19:return se(Et),null;case 4:return Se(),null;case 10:return Nr(c.type),null;case 22:case 23:return Oo(c),tv(),o!==null&&se(Mo),o=c.flags,o&65536?(c.flags=o&-65537|128,c):null;case 24:return Nr(li),null;case 25:return null;default:return null}}function Qf(o,c){switch(x_(c),c.tag){case 3:Nr(li),Se();break;case 26:case 27:case 5:De(c);break;case 4:Se();break;case 13:Oo(c);break;case 19:se(Et);break;case 10:Nr(c.type);break;case 22:case 23:Oo(c),tv(),o!==null&&se(Mo);break;case 24:Nr(li)}}function er(o,c){try{var m=c.updateQueue,S=m!==null?m.lastEffect:null;if(S!==null){var E=S.next;m=E;do{if((m.tag&o)===o){S=void 0;var P=m.create,j=m.inst;S=P(),j.destroy=S}m=m.next}while(m!==E)}}catch($){de(c,c.return,$)}}function ra(o,c,m){try{var S=c.updateQueue,E=S!==null?S.lastEffect:null;if(E!==null){var P=E.next;S=P;do{if((S.tag&o)===o){var j=S.inst,$=j.destroy;if($!==void 0){j.destroy=void 0,E=c;var ae=m,pe=$;try{pe()}catch(be){de(E,ae,be)}}}S=S.next}while(S!==P)}}catch(be){de(c,c.return,be)}}function zT(o){var c=o.updateQueue;if(c!==null){var m=o.stateNode;try{eT(c,m)}catch(S){de(o,o.return,S)}}}function kT(o,c,m){m.props=No(o.type,o.memoizedProps),m.state=o.memoizedState;try{m.componentWillUnmount()}catch(S){de(o,c,S)}}function $f(o,c){try{var m=o.ref;if(m!==null){switch(o.tag){case 26:case 27:case 5:var S=o.stateNode;break;case 30:S=o.stateNode;break;default:S=o.stateNode}typeof m=="function"?o.refCleanup=m(S):m.current=S}}catch(E){de(o,c,E)}}function $t(o,c){var m=o.ref,S=o.refCleanup;if(m!==null)if(typeof S=="function")try{S()}catch(E){de(o,c,E)}finally{o.refCleanup=null,o=o.alternate,o!=null&&(o.refCleanup=null)}else if(typeof m=="function")try{m(null)}catch(E){de(o,c,E)}else m.current=null}function Zf(o){var c=o.type,m=o.memoizedProps,S=o.stateNode;try{e:switch(c){case"button":case"input":case"select":case"textarea":m.autoFocus&&S.focus();break e;case"img":m.src?S.src=m.src:m.srcSet&&(S.srcset=m.srcSet)}}catch(E){de(o,o.return,E)}}function Hl(o,c,m){try{var S=o.stateNode;mk(S,o.type,m,c),S[_a]=c}catch(E){de(o,o.return,E)}}function W_(o){return o.tag===5||o.tag===3||o.tag===26||o.tag===27&&Wu(o.type)||o.tag===4}function Iu(o){e:for(;;){for(;o.sibling===null;){if(o.return===null||W_(o.return))return null;o=o.return}for(o.sibling.return=o.return,o=o.sibling;o.tag!==5&&o.tag!==6&&o.tag!==18;){if(o.tag===27&&Wu(o.type)||o.flags&2||o.child===null||o.tag===4)continue e;o.child.return=o,o=o.child}if(!(o.flags&2))return o.stateNode}}function Jf(o,c,m){var S=o.tag;if(S===5||S===6)o=o.stateNode,c?(m.nodeType===9?m.body:m.nodeName==="HTML"?m.ownerDocument.body:m).insertBefore(o,c):(c=m.nodeType===9?m.body:m.nodeName==="HTML"?m.ownerDocument.body:m,c.appendChild(o),m=m._reactRootContainer,m!=null||c.onclick!==null||(c.onclick=WT));else if(S!==4&&(S===27&&Wu(o.type)&&(m=o.stateNode,c=null),o=o.child,o!==null))for(Jf(o,c,m),o=o.sibling;o!==null;)Jf(o,c,m),o=o.sibling}function Bo(o,c,m){var S=o.tag;if(S===5||S===6)o=o.stateNode,c?m.insertBefore(o,c):m.appendChild(o);else if(S!==4&&(S===27&&Wu(o.type)&&(m=o.stateNode),o=o.child,o!==null))for(Bo(o,c,m),o=o.sibling;o!==null;)Bo(o,c,m),o=o.sibling}function Ou(o){var c=o.stateNode,m=o.memoizedProps;try{for(var S=o.type,E=c.attributes;E.length;)c.removeAttributeNode(E[0]);Ca(c,S,m),c[si]=o,c[_a]=m}catch(P){de(o,o.return,P)}}var tr=!1,xs=!1,Wl=!1,Cv=typeof WeakSet=="function"?WeakSet:Set,Bs=null;function yw(o,c){if(o=o.containerInfo,ww=$T,o=Vy(o),Gh(o)){if("selectionStart"in o)var m={start:o.selectionStart,end:o.selectionEnd};else e:{m=(m=o.ownerDocument)&&m.defaultView||window;var S=m.getSelection&&m.getSelection();if(S&&S.rangeCount!==0){m=S.anchorNode;var E=S.anchorOffset,P=S.focusNode;S=S.focusOffset;try{m.nodeType,P.nodeType}catch{m=null;break e}var j=0,$=-1,ae=-1,pe=0,be=0,Ce=o,_e=null;t:for(;;){for(var ye;Ce!==m||E!==0&&Ce.nodeType!==3||($=j+E),Ce!==P||S!==0&&Ce.nodeType!==3||(ae=j+S),Ce.nodeType===3&&(j+=Ce.nodeValue.length),(ye=Ce.firstChild)!==null;)_e=Ce,Ce=ye;for(;;){if(Ce===o)break t;if(_e===m&&++pe===E&&($=j),_e===P&&++be===S&&(ae=j),(ye=Ce.nextSibling)!==null)break;Ce=_e,_e=Ce.parentNode}Ce=ye}m=$===-1||ae===-1?null:{start:$,end:ae}}else m=null}m=m||{start:0,end:0}}else m=null;for(Rw={focusedElem:o,selectionRange:m},$T=!1,Bs=c;Bs!==null;)if(c=Bs,o=c.child,(c.subtreeFlags&1024)!==0&&o!==null)o.return=c,Bs=o;else for(;Bs!==null;){switch(c=Bs,P=c.alternate,o=c.flags,c.tag){case 0:break;case 11:case 15:break;case 1:if((o&1024)!==0&&P!==null){o=void 0,m=c,E=P.memoizedProps,P=P.memoizedState,S=m.stateNode;try{var nt=No(m.type,E,m.elementType===m.type);o=S.getSnapshotBeforeUpdate(nt,P),S.__reactInternalSnapshotBeforeUpdate=o}catch(Ze){de(m,m.return,Ze)}}break;case 3:if((o&1024)!==0){if(o=c.stateNode.containerInfo,m=o.nodeType,m===9)Pw(o);else if(m===1)switch(o.nodeName){case"HEAD":case"HTML":case"BODY":Pw(o);break;default:o.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((o&1024)!==0)throw Error(s(163))}if(o=c.sibling,o!==null){o.return=c.return,Bs=o;break}Bs=c.return}}function Nu(o,c,m){var S=m.flags;switch(m.tag){case 0:case 11:case 15:It(o,m),S&4&&er(5,m);break;case 1:if(It(o,m),S&4)if(o=m.stateNode,c===null)try{o.componentDidMount()}catch(j){de(m,m.return,j)}else{var E=No(m.type,c.memoizedProps);c=c.memoizedState;try{o.componentDidUpdate(E,c,o.__reactInternalSnapshotBeforeUpdate)}catch(j){de(m,m.return,j)}}S&64&&zT(m),S&512&&$f(m,m.return);break;case 3:if(It(o,m),S&64&&(o=m.updateQueue,o!==null)){if(c=null,m.child!==null)switch(m.child.tag){case 27:case 5:c=m.child.stateNode;break;case 1:c=m.child.stateNode}try{eT(o,c)}catch(j){de(m,m.return,j)}}break;case 27:c===null&&S&4&&Ou(m);case 26:case 5:It(o,m),c===null&&S&4&&Zf(m),S&512&&$f(m,m.return);break;case 12:It(o,m);break;case 13:It(o,m),S&4&&rc(o,m),S&64&&(o=m.memoizedState,o!==null&&(o=o.dehydrated,o!==null&&(m=Ue.bind(null,m),xk(o,m))));break;case 22:if(S=m.memoizedState!==null||tr,!S){c=c!==null&&c.memoizedState!==null||xs,E=tr;var P=xs;tr=S,(xs=c)&&!P?sr(o,m,(m.subtreeFlags&8772)!==0):It(o,m),tr=E,xs=P}break;case 30:break;default:It(o,m)}}function q_(o){var c=o.alternate;c!==null&&(o.alternate=null,q_(c)),o.child=null,o.deletions=null,o.sibling=null,o.tag===5&&(c=o.stateNode,c!==null&&hf(c)),o.stateNode=null,o.return=null,o.dependencies=null,o.memoizedProps=null,o.memoizedState=null,o.pendingProps=null,o.stateNode=null,o.updateQueue=null}var vs=null,Xi=!1;function Ga(o,c,m){for(m=m.child;m!==null;)dn(o,c,m),m=m.sibling}function dn(o,c,m){if(Mt&&typeof Mt.onCommitFiberUnmount=="function")try{Mt.onCommitFiberUnmount(Xe,m)}catch{}switch(m.tag){case 26:xs||$t(m,c),Ga(o,c,m),m.memoizedState?m.memoizedState.count--:m.stateNode&&(m=m.stateNode,m.parentNode.removeChild(m));break;case 27:xs||$t(m,c);var S=vs,E=Xi;Wu(m.type)&&(vs=m.stateNode,Xi=!1),Ga(o,c,m),Lv(m.stateNode),vs=S,Xi=E;break;case 5:xs||$t(m,c);case 6:if(S=vs,E=Xi,vs=null,Ga(o,c,m),vs=S,Xi=E,vs!==null)if(Xi)try{(vs.nodeType===9?vs.body:vs.nodeName==="HTML"?vs.ownerDocument.body:vs).removeChild(m.stateNode)}catch(P){de(m,c,P)}else try{vs.removeChild(m.stateNode)}catch(P){de(m,c,P)}break;case 18:vs!==null&&(Xi?(o=vs,$L(o.nodeType===9?o.body:o.nodeName==="HTML"?o.ownerDocument.body:o,m.stateNode),kv(o)):$L(vs,m.stateNode));break;case 4:S=vs,E=Xi,vs=m.stateNode.containerInfo,Xi=!0,Ga(o,c,m),vs=S,Xi=E;break;case 0:case 11:case 14:case 15:xs||ra(2,m,c),xs||ra(4,m,c),Ga(o,c,m);break;case 1:xs||($t(m,c),S=m.stateNode,typeof S.componentWillUnmount=="function"&&kT(m,c,S)),Ga(o,c,m);break;case 21:Ga(o,c,m);break;case 22:xs=(S=xs)||m.memoizedState!==null,Ga(o,c,m),xs=S;break;default:Ga(o,c,m)}}function rc(o,c){if(c.memoizedState===null&&(o=c.alternate,o!==null&&(o=o.memoizedState,o!==null&&(o=o.dehydrated,o!==null))))try{kv(o)}catch(m){de(c,c.return,m)}}function wv(o){switch(o.tag){case 13:case 19:var c=o.stateNode;return c===null&&(c=o.stateNode=new Cv),c;case 22:return o=o.stateNode,c=o._retryCache,c===null&&(c=o._retryCache=new Cv),c;default:throw Error(s(435,o.tag))}}function Gr(o,c){var m=wv(o);c.forEach(function(S){var E=ut.bind(null,o,S);m.has(S)||(m.add(S),S.then(E,E))})}function Ta(o,c){var m=c.deletions;if(m!==null)for(var S=0;S<m.length;S++){var E=m[S],P=o,j=c,$=j;e:for(;$!==null;){switch($.tag){case 27:if(Wu($.type)){vs=$.stateNode,Xi=!1;break e}break;case 5:vs=$.stateNode,Xi=!1;break e;case 3:case 4:vs=$.stateNode.containerInfo,Xi=!0;break e}$=$.return}if(vs===null)throw Error(s(160));dn(P,j,E),vs=null,Xi=!1,P=E.alternate,P!==null&&(P.return=null),E.return=null}if(c.subtreeFlags&13878)for(c=c.child;c!==null;)ep(c,o),c=c.sibling}var oa=null;function ep(o,c){var m=o.alternate,S=o.flags;switch(o.tag){case 0:case 11:case 14:case 15:Ta(c,o),ui(o),S&4&&(ra(3,o,o.return),er(3,o),ra(5,o,o.return));break;case 1:Ta(c,o),ui(o),S&512&&(xs||m===null||$t(m,m.return)),S&64&&tr&&(o=o.updateQueue,o!==null&&(S=o.callbacks,S!==null&&(m=o.shared.hiddenCallbacks,o.shared.hiddenCallbacks=m===null?S:m.concat(S))));break;case 26:var E=oa;if(Ta(c,o),ui(o),S&512&&(xs||m===null||$t(m,m.return)),S&4){var P=m!==null?m.memoizedState:null;if(S=o.memoizedState,m===null)if(S===null)if(o.stateNode===null){e:{S=o.type,m=o.memoizedProps,E=E.ownerDocument||E;t:switch(S){case"title":P=E.getElementsByTagName("title")[0],(!P||P[yo]||P[si]||P.namespaceURI==="http://www.w3.org/2000/svg"||P.hasAttribute("itemprop"))&&(P=E.createElement(S),E.head.insertBefore(P,E.querySelector("head > title"))),Ca(P,S,m),P[si]=o,gi(P),S=P;break e;case"link":var j=nI("link","href",E).get(S+(m.href||""));if(j){for(var $=0;$<j.length;$++)if(P=j[$],P.getAttribute("href")===(m.href==null||m.href===""?null:m.href)&&P.getAttribute("rel")===(m.rel==null?null:m.rel)&&P.getAttribute("title")===(m.title==null?null:m.title)&&P.getAttribute("crossorigin")===(m.crossOrigin==null?null:m.crossOrigin)){j.splice($,1);break t}}P=E.createElement(S),Ca(P,S,m),E.head.appendChild(P);break;case"meta":if(j=nI("meta","content",E).get(S+(m.content||""))){for($=0;$<j.length;$++)if(P=j[$],P.getAttribute("content")===(m.content==null?null:""+m.content)&&P.getAttribute("name")===(m.name==null?null:m.name)&&P.getAttribute("property")===(m.property==null?null:m.property)&&P.getAttribute("http-equiv")===(m.httpEquiv==null?null:m.httpEquiv)&&P.getAttribute("charset")===(m.charSet==null?null:m.charSet)){j.splice($,1);break t}}P=E.createElement(S),Ca(P,S,m),E.head.appendChild(P);break;default:throw Error(s(468,S))}P[si]=o,gi(P),S=P}o.stateNode=S}else rI(E,o.type,o.stateNode);else o.stateNode=aI(E,S,o.memoizedProps);else P!==S?(P===null?m.stateNode!==null&&(m=m.stateNode,m.parentNode.removeChild(m)):P.count--,S===null?rI(E,o.type,o.stateNode):aI(E,S,o.memoizedProps)):S===null&&o.stateNode!==null&&Hl(o,o.memoizedProps,m.memoizedProps)}break;case 27:Ta(c,o),ui(o),S&512&&(xs||m===null||$t(m,m.return)),m!==null&&S&4&&Hl(o,o.memoizedProps,m.memoizedProps);break;case 5:if(Ta(c,o),ui(o),S&512&&(xs||m===null||$t(m,m.return)),o.flags&32){E=o.stateNode;try{Nh(E,"")}catch(ye){de(o,o.return,ye)}}S&4&&o.stateNode!=null&&(E=o.memoizedProps,Hl(o,E,m!==null?m.memoizedProps:E)),S&1024&&(Wl=!0);break;case 6:if(Ta(c,o),ui(o),S&4){if(o.stateNode===null)throw Error(s(162));S=o.memoizedProps,m=o.stateNode;try{m.nodeValue=S}catch(ye){de(o,o.return,ye)}}break;case 3:if(YT=null,E=oa,oa=XT(c.containerInfo),Ta(c,o),oa=E,ui(o),S&4&&m!==null&&m.memoizedState.isDehydrated)try{kv(c.containerInfo)}catch(ye){de(o,o.return,ye)}Wl&&(Wl=!1,pt(o));break;case 4:S=oa,oa=XT(o.stateNode.containerInfo),Ta(c,o),ui(o),oa=S;break;case 12:Ta(c,o),ui(o);break;case 13:Ta(c,o),ui(o),o.child.flags&8192&&o.memoizedState!==null!=(m!==null&&m.memoizedState!==null)&&(ku=ht()),S&4&&(S=o.updateQueue,S!==null&&(o.updateQueue=null,Gr(o,S)));break;case 22:E=o.memoizedState!==null;var ae=m!==null&&m.memoizedState!==null,pe=tr,be=xs;if(tr=pe||E,xs=be||ae,Ta(c,o),xs=be,tr=pe,ui(o),S&8192)e:for(c=o.stateNode,c._visibility=E?c._visibility&-2:c._visibility|1,E&&(m===null||ae||tr||xs||Ts(o)),m=null,c=o;;){if(c.tag===5||c.tag===26){if(m===null){ae=m=c;try{if(P=ae.stateNode,E)j=P.style,typeof j.setProperty=="function"?j.setProperty("display","none","important"):j.display="none";else{$=ae.stateNode;var Ce=ae.memoizedProps.style,_e=Ce!=null&&Ce.hasOwnProperty("display")?Ce.display:null;$.style.display=_e==null||typeof _e=="boolean"?"":(""+_e).trim()}}catch(ye){de(ae,ae.return,ye)}}}else if(c.tag===6){if(m===null){ae=c;try{ae.stateNode.nodeValue=E?"":ae.memoizedProps}catch(ye){de(ae,ae.return,ye)}}}else if((c.tag!==22&&c.tag!==23||c.memoizedState===null||c===o)&&c.child!==null){c.child.return=c,c=c.child;continue}if(c===o)break e;for(;c.sibling===null;){if(c.return===null||c.return===o)break e;m===c&&(m=null),c=c.return}m===c&&(m=null),c.sibling.return=c.return,c=c.sibling}S&4&&(S=o.updateQueue,S!==null&&(m=S.retryQueue,m!==null&&(S.retryQueue=null,Gr(o,m))));break;case 19:Ta(c,o),ui(o),S&4&&(S=o.updateQueue,S!==null&&(o.updateQueue=null,Gr(o,S)));break;case 30:break;case 21:break;default:Ta(c,o),ui(o)}}function ui(o){var c=o.flags;if(c&2){try{for(var m,S=o.return;S!==null;){if(W_(S)){m=S;break}S=S.return}if(m==null)throw Error(s(160));switch(m.tag){case 27:var E=m.stateNode,P=Iu(o);Bo(o,P,E);break;case 5:var j=m.stateNode;m.flags&32&&(Nh(j,""),m.flags&=-33);var $=Iu(o);Bo(o,$,j);break;case 3:case 4:var ae=m.stateNode.containerInfo,pe=Iu(o);Jf(o,pe,ae);break;default:throw Error(s(161))}}catch(be){de(o,o.return,be)}o.flags&=-3}c&4096&&(o.flags&=-4097)}function pt(o){if(o.subtreeFlags&1024)for(o=o.child;o!==null;){var c=o;pt(c),c.tag===5&&c.flags&1024&&c.stateNode.reset(),o=o.sibling}}function It(o,c){if(c.subtreeFlags&8772)for(c=c.child;c!==null;)Nu(o,c.alternate,c),c=c.sibling}function Ts(o){for(o=o.child;o!==null;){var c=o;switch(c.tag){case 0:case 11:case 14:case 15:ra(4,c,c.return),Ts(c);break;case 1:$t(c,c.return);var m=c.stateNode;typeof m.componentWillUnmount=="function"&&kT(c,c.return,m),Ts(c);break;case 27:Lv(c.stateNode);case 26:case 5:$t(c,c.return),Ts(c);break;case 22:c.memoizedState===null&&Ts(c);break;case 30:Ts(c);break;default:Ts(c)}o=o.sibling}}function sr(o,c,m){for(m=m&&(c.subtreeFlags&8772)!==0,c=c.child;c!==null;){var S=c.alternate,E=o,P=c,j=P.flags;switch(P.tag){case 0:case 11:case 15:sr(E,P,m),er(4,P);break;case 1:if(sr(E,P,m),S=P,E=S.stateNode,typeof E.componentDidMount=="function")try{E.componentDidMount()}catch(pe){de(S,S.return,pe)}if(S=P,E=S.updateQueue,E!==null){var $=S.stateNode;try{var ae=E.shared.hiddenCallbacks;if(ae!==null)for(E.shared.hiddenCallbacks=null,E=0;E<ae.length;E++)je(ae[E],$)}catch(pe){de(S,S.return,pe)}}m&&j&64&&zT(P),$f(P,P.return);break;case 27:Ou(P);case 26:case 5:sr(E,P,m),m&&S===null&&j&4&&Zf(P),$f(P,P.return);break;case 12:sr(E,P,m);break;case 13:sr(E,P,m),m&&j&4&&rc(E,P);break;case 22:P.memoizedState===null&&sr(E,P,m),$f(P,P.return);break;case 30:break;default:sr(E,P,m)}c=c.sibling}}function ql(o,c){var m=null;o!==null&&o.memoizedState!==null&&o.memoizedState.cachePool!==null&&(m=o.memoizedState.cachePool.pool),o=null,c.memoizedState!==null&&c.memoizedState.cachePool!==null&&(o=c.memoizedState.cachePool.pool),o!==m&&(o!=null&&o.refCount++,m!=null&&Qn(m))}function Uo(o,c){o=null,c.alternate!==null&&(o=c.alternate.memoizedState.cache),c=c.memoizedState.cache,c!==o&&(c.refCount++,o!=null&&Qn(o))}function fn(o,c,m,S){if(c.subtreeFlags&10256)for(c=c.child;c!==null;)Fu(o,c,m,S),c=c.sibling}function Fu(o,c,m,S){var E=c.flags;switch(c.tag){case 0:case 11:case 15:fn(o,c,m,S),E&2048&&er(9,c);break;case 1:fn(o,c,m,S);break;case 3:fn(o,c,m,S),E&2048&&(o=null,c.alternate!==null&&(o=c.alternate.memoizedState.cache),c=c.memoizedState.cache,c!==o&&(c.refCount++,o!=null&&Qn(o)));break;case 12:if(E&2048){fn(o,c,m,S),o=c.stateNode;try{var P=c.memoizedProps,j=P.id,$=P.onPostCommit;typeof $=="function"&&$(j,c.alternate===null?"mount":"update",o.passiveEffectDuration,-0)}catch(ae){de(c,c.return,ae)}}else fn(o,c,m,S);break;case 13:fn(o,c,m,S);break;case 23:break;case 22:P=c.stateNode,j=c.alternate,c.memoizedState!==null?P._visibility&2?fn(o,c,m,S):tp(o,c):P._visibility&2?fn(o,c,m,S):(P._visibility|=2,ir(o,c,m,S,(c.subtreeFlags&10256)!==0)),E&2048&&ql(j,c);break;case 24:fn(o,c,m,S),E&2048&&Uo(c.alternate,c);break;default:fn(o,c,m,S)}}function ir(o,c,m,S,E){for(E=E&&(c.subtreeFlags&10256)!==0,c=c.child;c!==null;){var P=o,j=c,$=m,ae=S,pe=j.flags;switch(j.tag){case 0:case 11:case 15:ir(P,j,$,ae,E),er(8,j);break;case 23:break;case 22:var be=j.stateNode;j.memoizedState!==null?be._visibility&2?ir(P,j,$,ae,E):tp(P,j):(be._visibility|=2,ir(P,j,$,ae,E)),E&&pe&2048&&ql(j.alternate,j);break;case 24:ir(P,j,$,ae,E),E&&pe&2048&&Uo(j.alternate,j);break;default:ir(P,j,$,ae,E)}c=c.sibling}}function tp(o,c){if(c.subtreeFlags&10256)for(c=c.child;c!==null;){var m=o,S=c,E=S.flags;switch(S.tag){case 22:tp(m,S),E&2048&&ql(S.alternate,S);break;case 24:tp(m,S),E&2048&&Uo(S.alternate,S);break;default:tp(m,S)}c=c.sibling}}var Xl=8192;function oc(o){if(o.subtreeFlags&Xl)for(o=o.child;o!==null;)Rv(o),o=o.sibling}function Rv(o){switch(o.tag){case 26:oc(o),o.flags&Xl&&o.memoizedState!==null&&Nk(oa,o.memoizedState,o.memoizedProps);break;case 5:oc(o);break;case 3:case 4:var c=oa;oa=XT(o.stateNode.containerInfo),oc(o),oa=c;break;case 22:o.memoizedState===null&&(c=o.alternate,c!==null&&c.memoizedState!==null?(c=Xl,Xl=16777216,oc(o),Xl=c):oc(o));break;default:oc(o)}}function VT(o){var c=o.alternate;if(c!==null&&(o=c.child,o!==null)){c.child=null;do c=o.sibling,o.sibling=null,o=c;while(o!==null)}}function Hr(o){var c=o.deletions;if((o.flags&16)!==0){if(c!==null)for(var m=0;m<c.length;m++){var S=c[m];Bs=S,Mv(S,o)}VT(o)}if(o.subtreeFlags&10256)for(o=o.child;o!==null;)Bu(o),o=o.sibling}function Bu(o){switch(o.tag){case 0:case 11:case 15:Hr(o),o.flags&2048&&ra(9,o,o.return);break;case 3:Hr(o);break;case 12:Hr(o);break;case 22:var c=o.stateNode;o.memoizedState!==null&&c._visibility&2&&(o.return===null||o.return.tag!==13)?(c._visibility&=-3,zo(o)):Hr(o);break;default:Hr(o)}}function zo(o){var c=o.deletions;if((o.flags&16)!==0){if(c!==null)for(var m=0;m<c.length;m++){var S=c[m];Bs=S,Mv(S,o)}VT(o)}for(o=o.child;o!==null;){switch(c=o,c.tag){case 0:case 11:case 15:ra(8,c,c.return),zo(c);break;case 22:m=c.stateNode,m._visibility&2&&(m._visibility&=-3,zo(c));break;default:zo(c)}o=o.sibling}}function Mv(o,c){for(;Bs!==null;){var m=Bs;switch(m.tag){case 0:case 11:case 15:ra(8,m,c);break;case 23:case 22:if(m.memoizedState!==null&&m.memoizedState.cachePool!==null){var S=m.memoizedState.cachePool.pool;S!=null&&S.refCount++}break;case 24:Qn(m.memoizedState.cache)}if(S=m.child,S!==null)S.return=m,Bs=S;else e:for(m=o;Bs!==null;){S=Bs;var E=S.sibling,P=S.return;if(q_(S),S===m){Bs=null;break e}if(E!==null){E.return=P,Bs=E;break e}Bs=P}}}var Cn={getCacheForType:function(o){var c=na(li),m=c.data.get(o);return m===void 0&&(m=o(),c.data.set(o,m)),m}},Wr=typeof WeakMap=="function"?WeakMap:Map,st=0,hs=null,Tt=null,Ot=0,at=0,Ea=null,la=!1,Es=!1,sp=!1,qr=0,yt=0,Ss=0,di=0,pn=0,ji=0,Uu=0,jl=null,Yi=null,zu=!1,ku=0,lc=1/0,Yl=null,Kl=null,Ke=0,Wt=null,ct=null,vt=0,Zt=0,Aa=null,ko=null,Xr=0,ip=null;function ai(){if((st&2)!==0&&Ot!==0)return Ot&-Ot;if(W.T!==null){var o=Tu;return o!==0?o:Sw()}return of()}function Gs(){ji===0&&(ji=(Ot&536870912)===0||Ht?km():536870912);var o=cn.current;return o!==null&&(o.flags|=32),ji}function fi(o,c,m){(o===hs&&(at===2||at===9)||o.cancelPendingCommit!==null)&&(Zl(o,0),mn(o,Ot,ji,!1)),yl(o,m),((st&2)===0||o!==hs)&&(o===hs&&((st&2)===0&&(di|=m),yt===4&&mn(o,Ot,ji,!1)),ke(o))}function Ql(o,c,m){if((st&6)!==0)throw Error(s(327));var S=!m&&(c&124)===0&&(c&o.expiredLanes)===0||iu(o,c),E=S?Gu(o,c):vi(o,c,!0),P=S;do{if(E===0){Es&&!S&&mn(o,c,0,!1);break}else{if(m=o.current.alternate,P&&!wn(m)){E=vi(o,c,!1),P=!1;continue}if(E===2){if(P=c,o.errorRecoveryDisabledLanes&P)var j=0;else j=o.pendingLanes&-536870913,j=j!==0?j:j&536870912?536870912:0;if(j!==0){c=j;e:{var $=o;E=jl;var ae=$.current.memoizedState.isDehydrated;if(ae&&(Zl($,j).flags|=256),j=vi($,j,!1),j!==2){if(sp&&!ae){$.errorRecoveryDisabledLanes|=P,di|=P,E=4;break e}P=Yi,Yi=E,P!==null&&(Yi===null?Yi=P:Yi.push.apply(Yi,P))}E=j}if(P=!1,E!==2)continue}}if(E===1){Zl(o,0),mn(o,c,0,!0);break}e:{switch(S=o,P=E,P){case 0:case 1:throw Error(s(345));case 4:if((c&4194048)!==c)break;case 6:mn(S,c,ji,!la);break e;case 2:Yi=null;break;case 3:case 5:break;default:throw Error(s(329))}if((c&62914560)===c&&(E=ku+300-ht(),10<E)){if(mn(S,c,ji,!la),su(S,0,!0)!==0)break e;S.timeoutHandle=KL(X_.bind(null,S,m,Yi,Yl,zu,c,ji,di,Uu,la,P,2,-0,0),E);break e}X_(S,m,Yi,Yl,zu,c,ji,di,Uu,la,P,0,-0,0)}}break}while(!0);ke(o)}function X_(o,c,m,S,E,P,j,$,ae,pe,be,Ce,_e,ye){if(o.timeoutHandle=-1,Ce=c.subtreeFlags,(Ce&8192||(Ce&16785408)===16785408)&&(Nv={stylesheets:null,count:0,unsuspend:Ok},Rv(c),Ce=Fk(),Ce!==null)){o.cancelPendingCommit=Ce(d.bind(null,o,c,P,m,S,E,j,$,ae,be,1,_e,ye)),mn(o,P,j,!pe);return}d(o,c,P,m,S,E,j,$,ae)}function wn(o){for(var c=o;;){var m=c.tag;if((m===0||m===11||m===15)&&c.flags&16384&&(m=c.updateQueue,m!==null&&(m=m.stores,m!==null)))for(var S=0;S<m.length;S++){var E=m[S],P=E.getSnapshot;E=E.value;try{if(!on(P(),E))return!1}catch{return!1}}if(m=c.child,c.subtreeFlags&16384&&m!==null)m.return=c,c=m;else{if(c===o)break;for(;c.sibling===null;){if(c.return===null||c.return===o)return!0;c=c.return}c.sibling.return=c.return,c=c.sibling}}return!0}function mn(o,c,m,S){c&=~pn,c&=~di,o.suspendedLanes|=c,o.pingedLanes&=~c,S&&(o.warmLanes|=c),S=o.expirationTimes;for(var E=c;0<E;){var P=31-bs(E),j=1<<P;S[P]=-1,E&=~j}m!==0&&rf(o,m,c)}function $l(){return(st&6)===0?(is(0),!1):!0}function ha(){if(Tt!==null){if(at===0)var o=Tt.return;else o=Tt,Or=Pl=null,iv(o),Mu=null,Sa=0,o=Tt;for(;o!==null;)Qf(o.alternate,o),o=o.return;Tt=null}}function Zl(o,c){var m=o.timeoutHandle;m!==-1&&(o.timeoutHandle=-1,gk(m)),m=o.cancelPendingCommit,m!==null&&(o.cancelPendingCommit=null,m()),ha(),hs=o,Tt=m=Pr(o.current,null),Ot=c,at=0,Ea=null,la=!1,Es=iu(o,c),sp=!1,Uu=ji=pn=di=Ss=yt=0,Yi=jl=null,zu=!1,(c&8)!==0&&(c|=c&32);var S=o.entangledLanes;if(S!==0)for(o=o.entanglements,S&=c;0<S;){var E=31-bs(S),P=1<<E;c|=o[E],S&=~P}return qr=c,ln(),m}function j_(o,c){gt=null,W.H=F_,c===Zh||c===Jh?(c=Zy(),at=3):c===Jx?(c=Zy(),at=4):at=c===OT?8:c!==null&&typeof c=="object"&&typeof c.then=="function"?6:1,Ea=c,Tt===null&&(yt=1,U_(o,Di(c,o.current)))}function Vu(){var o=W.H;return W.H=F_,o===null?F_:o}function ap(){var o=W.A;return W.A=Cn,o}function jr(){yt=4,la||(Ot&4194048)!==Ot&&cn.current!==null||(Es=!0),(Ss&134217727)===0&&(di&134217727)===0||hs===null||mn(hs,Ot,ji,!1)}function vi(o,c,m){var S=st;st|=2;var E=Vu(),P=ap();(hs!==o||Ot!==c)&&(Yl=null,Zl(o,c)),c=!1;var j=yt;e:do try{if(at!==0&&Tt!==null){var $=Tt,ae=Ea;switch(at){case 8:ha(),j=6;break e;case 3:case 2:case 9:case 6:cn.current===null&&(c=!0);var pe=at;if(at=0,Ea=null,hc(o,$,ae,pe),m&&Es){j=0;break e}break;default:pe=at,at=0,Ea=null,hc(o,$,ae,pe)}}Jl(),j=yt;break}catch(be){j_(o,be)}while(!0);return c&&o.shellSuspendCounter++,Or=Pl=null,st=S,W.H=E,W.A=P,Tt===null&&(hs=null,Ot=0,ln()),j}function Jl(){for(;Tt!==null;)Y_(Tt)}function Gu(o,c){var m=st;st|=2;var S=Vu(),E=ap();hs!==o||Ot!==c?(Yl=null,lc=ht()+500,Zl(o,c)):Es=iu(o,c);e:do try{if(at!==0&&Tt!==null){c=Tt;var P=Ea;t:switch(at){case 1:at=0,Ea=null,hc(o,c,P,1);break;case 2:case 9:if(ec(P)){at=0,Ea=null,K_(c);break}c=function(){at!==2&&at!==9||hs!==o||(at=7),ke(o)},P.then(c,c);break e;case 3:at=7;break e;case 4:at=5;break e;case 7:ec(P)?(at=0,Ea=null,K_(c)):(at=0,Ea=null,hc(o,c,P,7));break;case 5:var j=null;switch(Tt.tag){case 26:j=Tt.memoizedState;case 5:case 27:var $=Tt;if(!j||oI(j)){at=0,Ea=null;var ae=$.sibling;if(ae!==null)Tt=ae;else{var pe=$.return;pe!==null?(Tt=pe,eh(pe)):Tt=null}break t}}at=0,Ea=null,hc(o,c,P,5);break;case 6:at=0,Ea=null,hc(o,c,P,6);break;case 8:ha(),yt=6;break e;default:throw Error(s(462))}}Hu();break}catch(be){j_(o,be)}while(!0);return Or=Pl=null,W.H=S,W.A=E,st=m,Tt!==null?0:(hs=null,Ot=0,ln(),yt)}function Hu(){for(;Tt!==null&&!$e();)Y_(Tt)}function Y_(o){var c=Kf(o.alternate,o,qr);o.memoizedProps=o.pendingProps,c===null?eh(o):Tt=c}function K_(o){var c=o,m=c.alternate;switch(c.tag){case 15:case 0:c=V_(m,c,c.pendingProps,c.type,void 0,Ot);break;case 11:c=V_(m,c,c.pendingProps,c.type.render,c.ref,Ot);break;case 5:iv(c);default:Qf(m,c),c=Tt=v_(c,qr),c=Kf(m,c,qr)}o.memoizedProps=o.pendingProps,c===null?eh(o):Tt=c}function hc(o,c,m,S){Or=Pl=null,iv(c),Mu=null,Sa=0;var E=c.return;try{if(gw(o,E,c,m,Ot)){yt=1,U_(o,Di(m,o.current)),Tt=null;return}}catch(P){if(E!==null)throw Tt=E,P;yt=1,U_(o,Di(m,o.current)),Tt=null;return}c.flags&32768?(Ht||S===1?o=!0:Es||(Ot&536870912)!==0?o=!1:(la=o=!0,(S===2||S===9||S===3||S===6)&&(S=cn.current,S!==null&&S.tag===13&&(S.flags|=16384))),Q_(c,o)):eh(c)}function eh(o){var c=o;do{if((c.flags&32768)!==0){Q_(c,la);return}o=c.return;var m=Av(c.alternate,c,qr);if(m!==null){Tt=m;return}if(c=c.sibling,c!==null){Tt=c;return}Tt=c=o}while(c!==null);yt===0&&(yt=5)}function Q_(o,c){do{var m=un(o.alternate,o);if(m!==null){m.flags&=32767,Tt=m;return}if(m=o.return,m!==null&&(m.flags|=32768,m.subtreeFlags=0,m.deletions=null),!c&&(o=o.sibling,o!==null)){Tt=o;return}Tt=o=m}while(o!==null);yt=6,Tt=null}function d(o,c,m,S,E,P,j,$,ae){o.cancelPendingCommit=null;do B();while(Ke!==0);if((st&6)!==0)throw Error(s(327));if(c!==null){if(c===o.current)throw Error(s(177));if(P=c.lanes|c.childLanes,P|=Tf,wx(o,m,P,j,$,ae),o===hs&&(Tt=hs=null,Ot=0),ct=c,Wt=o,vt=m,Zt=P,Aa=E,ko=S,(c.subtreeFlags&10256)!==0||(c.flags&10256)!==0?(o.callbackNode=null,o.callbackPriority=0,Rn(oi,function(){return Z(),null})):(o.callbackNode=null,o.callbackPriority=0),S=(c.flags&13878)!==0,(c.subtreeFlags&13878)!==0||S){S=W.T,W.T=null,E=k.p,k.p=2,j=st,st|=4;try{yw(o,c,m)}finally{st=j,k.p=E,W.T=S}}Ke=1,p(),b(),A()}}function p(){if(Ke===1){Ke=0;var o=Wt,c=ct,m=(c.flags&13878)!==0;if((c.subtreeFlags&13878)!==0||m){m=W.T,W.T=null;var S=k.p;k.p=2;var E=st;st|=4;try{ep(c,o);var P=Rw,j=Vy(o.containerInfo),$=P.focusedElem,ae=P.selectionRange;if(j!==$&&$&&$.ownerDocument&&ky($.ownerDocument.documentElement,$)){if(ae!==null&&Gh($)){var pe=ae.start,be=ae.end;if(be===void 0&&(be=pe),"selectionStart"in $)$.selectionStart=pe,$.selectionEnd=Math.min(be,$.value.length);else{var Ce=$.ownerDocument||document,_e=Ce&&Ce.defaultView||window;if(_e.getSelection){var ye=_e.getSelection(),nt=$.textContent.length,Ze=Math.min(ae.start,nt),Cs=ae.end===void 0?Ze:Math.min(ae.end,nt);!ye.extend&&Ze>Cs&&(j=Cs,Cs=Ze,Ze=j);var ue=Ao($,Ze),re=Ao($,Cs);if(ue&&re&&(ye.rangeCount!==1||ye.anchorNode!==ue.node||ye.anchorOffset!==ue.offset||ye.focusNode!==re.node||ye.focusOffset!==re.offset)){var fe=Ce.createRange();fe.setStart(ue.node,ue.offset),ye.removeAllRanges(),Ze>Cs?(ye.addRange(fe),ye.extend(re.node,re.offset)):(fe.setEnd(re.node,re.offset),ye.addRange(fe))}}}}for(Ce=[],ye=$;ye=ye.parentNode;)ye.nodeType===1&&Ce.push({element:ye,left:ye.scrollLeft,top:ye.scrollTop});for(typeof $.focus=="function"&&$.focus(),$=0;$<Ce.length;$++){var Te=Ce[$];Te.element.scrollLeft=Te.left,Te.element.scrollTop=Te.top}}$T=!!ww,Rw=ww=null}finally{st=E,k.p=S,W.T=m}}o.current=c,Ke=2}}function b(){if(Ke===2){Ke=0;var o=Wt,c=ct,m=(c.flags&8772)!==0;if((c.subtreeFlags&8772)!==0||m){m=W.T,W.T=null;var S=k.p;k.p=2;var E=st;st|=4;try{Nu(o,c.alternate,c)}finally{st=E,k.p=S,W.T=m}}Ke=3}}function A(){if(Ke===4||Ke===3){Ke=0,es();var o=Wt,c=ct,m=vt,S=ko;(c.subtreeFlags&10256)!==0||(c.flags&10256)!==0?Ke=5:(Ke=0,ct=Wt=null,L(o,o.pendingLanes));var E=o.pendingLanes;if(E===0&&(Kl=null),Hm(m),c=c.stateNode,Mt&&typeof Mt.onCommitFiberRoot=="function")try{Mt.onCommitFiberRoot(Xe,c,void 0,(c.current.flags&128)===128)}catch{}if(S!==null){c=W.T,E=k.p,k.p=2,W.T=null;try{for(var P=o.onRecoverableError,j=0;j<S.length;j++){var $=S[j];P($.value,{componentStack:$.stack})}}finally{W.T=c,k.p=E}}(vt&3)!==0&&B(),ke(o),E=o.pendingLanes,(m&4194090)!==0&&(E&42)!==0?o===ip?Xr++:(Xr=0,ip=o):Xr=0,is(0)}}function L(o,c){(o.pooledCacheLanes&=c)===0&&(c=o.pooledCache,c!=null&&(o.pooledCache=null,Qn(c)))}function B(o){return p(),b(),A(),Z()}function Z(){if(Ke!==5)return!1;var o=Wt,c=Zt;Zt=0;var m=Hm(vt),S=W.T,E=k.p;try{k.p=32>m?32:m,W.T=null,m=Aa,Aa=null;var P=Wt,j=vt;if(Ke=0,ct=Wt=null,vt=0,(st&6)!==0)throw Error(s(331));var $=st;if(st|=4,Bu(P.current),Fu(P,P.current,j,m),st=$,is(0,!1),Mt&&typeof Mt.onPostCommitFiberRoot=="function")try{Mt.onPostCommitFiberRoot(Xe,P)}catch{}return!0}finally{k.p=E,W.T=S,L(o,c)}}function ne(o,c,m){c=Di(m,c),c=Pu(o.stateNode,c,2),o=va(o,c,2),o!==null&&(yl(o,2),ke(o))}function de(o,c,m){if(o.tag===3)ne(o,o,m);else for(;c!==null;){if(c.tag===3){ne(c,o,m);break}else if(c.tag===1){var S=c.stateNode;if(typeof c.type.getDerivedStateFromError=="function"||typeof S.componentDidCatch=="function"&&(Kl===null||!Kl.has(S))){o=Di(m,o),m=jf(2),S=va(c,m,2),S!==null&&(z_(m,S,c,o),yl(S,2),ke(S));break}}c=c.return}}function we(o,c,m){var S=o.pingCache;if(S===null){S=o.pingCache=new Wr;var E=new Set;S.set(c,E)}else E=S.get(c),E===void 0&&(E=new Set,S.set(c,E));E.has(m)||(sp=!0,E.add(m),o=Le.bind(null,o,c,m),c.then(o,o))}function Le(o,c,m){var S=o.pingCache;S!==null&&S.delete(c),o.pingedLanes|=o.suspendedLanes&m,o.warmLanes&=~m,hs===o&&(Ot&m)===m&&(yt===4||yt===3&&(Ot&62914560)===Ot&&300>ht()-ku?(st&2)===0&&Zl(o,0):pn|=m,Uu===Ot&&(Uu=0)),ke(o)}function Be(o,c){c===0&&(c=nf()),o=Dr(o,c),o!==null&&(yl(o,c),ke(o))}function Ue(o){var c=o.memoizedState,m=0;c!==null&&(m=c.retryLane),Be(o,m)}function ut(o,c){var m=0;switch(o.tag){case 13:var S=o.stateNode,E=o.memoizedState;E!==null&&(m=E.retryLane);break;case 19:S=o.stateNode;break;case 22:S=o.stateNode._retryCache;break;default:throw Error(s(314))}S!==null&&S.delete(c),Be(o,m)}function Rn(o,c){return ot(o,c)}var th=null,Mn=null,me=!1,ce=!1,ve=!1,Re=0;function ke(o){o!==Mn&&o.next===null&&(Mn===null?th=Mn=o:Mn=Mn.next=o),ce=!0,me||(me=!0,vw())}function is(o,c){if(!ve&&ce){ve=!0;do for(var m=!1,S=th;S!==null;){if(o!==0){var E=S.pendingLanes;if(E===0)var P=0;else{var j=S.suspendedLanes,$=S.pingedLanes;P=(1<<31-bs(42|o)+1)-1,P&=E&~(j&~$),P=P&201326741?P&201326741|1:P?P|2:0}P!==0&&(m=!0,Vo(S,P))}else P=Ot,P=su(S,S===hs?P:0,S.cancelPendingCommit!==null||S.timeoutHandle!==-1),(P&3)===0||iu(S,P)||(m=!0,Vo(S,P));S=S.next}while(m);ve=!1}}function et(){qt()}function qt(){ce=me=!1;var o=0;Re!==0&&(_k()&&(o=Re),Re=0);for(var c=ht(),m=null,S=th;S!==null;){var E=S.next,P=Si(S,c);P===0?(S.next=null,m===null?th=E:m.next=E,E===null&&(Mn=m)):(m=S,(o!==0||(P&3)!==0)&&(ce=!0)),S=E}is(o)}function Si(o,c){for(var m=o.suspendedLanes,S=o.pingedLanes,E=o.expirationTimes,P=o.pendingLanes&-62914561;0<P;){var j=31-bs(P),$=1<<j,ae=E[j];ae===-1?(($&m)===0||($&S)!==0)&&(E[j]=nw($,c)):ae<=c&&(o.expiredLanes|=$),P&=~$}if(c=hs,m=Ot,m=su(o,o===c?m:0,o.cancelPendingCommit!==null||o.timeoutHandle!==-1),S=o.callbackNode,m===0||o===c&&(at===2||at===9)||o.cancelPendingCommit!==null)return S!==null&&S!==null&&mt(S),o.callbackNode=null,o.callbackPriority=0;if((m&3)===0||iu(o,m)){if(c=m&-m,c===o.callbackPriority)return c;switch(S!==null&&mt(S),Hm(m)){case 2:case 8:m=zs;break;case 32:m=oi;break;case 268435456:m=ti;break;default:m=oi}return S=Xt.bind(null,o),m=ot(m,S),o.callbackPriority=c,o.callbackNode=m,c}return S!==null&&S!==null&&mt(S),o.callbackPriority=2,o.callbackNode=null,2}function Xt(o,c){if(Ke!==0&&Ke!==5)return o.callbackNode=null,o.callbackPriority=0,null;var m=o.callbackNode;if(B()&&o.callbackNode!==m)return null;var S=Ot;return S=su(o,o===hs?S:0,o.cancelPendingCommit!==null||o.timeoutHandle!==-1),S===0?null:(Ql(o,S,c),Si(o,ht()),o.callbackNode!=null&&o.callbackNode===m?Xt.bind(null,o):null)}function Vo(o,c){if(B())return null;Ql(o,c,!0)}function vw(){yk(function(){(st&6)!==0?ot(Zi,et):qt()})}function Sw(){return Re===0&&(Re=km()),Re}function kL(o){return o==null||typeof o=="symbol"||typeof o=="boolean"?null:typeof o=="function"?o:Zm(""+o)}function VL(o,c){var m=c.ownerDocument.createElement("input");return m.name=c.name,m.value=c.value,o.id&&m.setAttribute("form",o.id),c.parentNode.insertBefore(m,c),o=new FormData(o),m.parentNode.removeChild(m),o}function hk(o,c,m,S,E){if(c==="submit"&&m&&m.stateNode===E){var P=kL((E[_a]||null).action),j=S.submitter;j&&(c=(c=j[_a]||null)?kL(c.formAction):j.getAttribute("formAction"),c!==null&&(P=c,j=null));var $=new _f("action","action",null,S,E);o.push({event:$,listeners:[{instance:null,listener:function(){if(S.defaultPrevented){if(Re!==0){var ae=j?VL(E,j):new FormData(E);mv(m,{pending:!0,data:ae,method:E.method,action:P},null,ae)}}else typeof P=="function"&&($.preventDefault(),ae=j?VL(E,j):new FormData(E),mv(m,{pending:!0,data:ae,method:E.method,action:P},P,ae))},currentTarget:E}]})}}for(var bw=0;bw<sa.length;bw++){var xw=sa[bw],ck=xw.toLowerCase(),uk=xw[0].toUpperCase()+xw.slice(1);bn(ck,"on"+uk)}bn(Gy,"onAnimationEnd"),bn(Sn,"onAnimationIteration"),bn(y_,"onAnimationStart"),bn("dblclick","onDoubleClick"),bn("focusin","onFocus"),bn("focusout","onBlur"),bn(Kx,"onTransitionRun"),bn(uw,"onTransitionStart"),bn(Hy,"onTransitionCancel"),bn(ta,"onTransitionEnd"),Sl("onMouseEnter",["mouseout","mouseover"]),Sl("onMouseLeave",["mouseout","mouseover"]),Sl("onPointerEnter",["pointerout","pointerover"]),Sl("onPointerLeave",["pointerout","pointerover"]),ys("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),ys("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),ys("onBeforeInput",["compositionend","keypress","textInput","paste"]),ys("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),ys("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),ys("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Dv="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),dk=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(Dv));function GL(o,c){c=(c&4)!==0;for(var m=0;m<o.length;m++){var S=o[m],E=S.event;S=S.listeners;e:{var P=void 0;if(c)for(var j=S.length-1;0<=j;j--){var $=S[j],ae=$.instance,pe=$.currentTarget;if($=$.listener,ae!==P&&E.isPropagationStopped())break e;P=$,E.currentTarget=pe;try{P(E)}catch(be){Fo(be)}E.currentTarget=null,P=ae}else for(j=0;j<S.length;j++){if($=S[j],ae=$.instance,pe=$.currentTarget,$=$.listener,ae!==P&&E.isPropagationStopped())break e;P=$,E.currentTarget=pe;try{P(E)}catch(be){Fo(be)}E.currentTarget=null,P=ae}}}}function Nt(o,c){var m=c[lf];m===void 0&&(m=c[lf]=new Set);var S=o+"__bubble";m.has(S)||(HL(c,o,2,!1),m.add(S))}function Tw(o,c,m){var S=0;c&&(S|=4),HL(m,o,S,c)}var GT="_reactListening"+Math.random().toString(36).slice(2);function Ew(o){if(!o[GT]){o[GT]=!0,qm.forEach(function(m){m!=="selectionchange"&&(dk.has(m)||Tw(m,!1,o),Tw(m,!0,o))});var c=o.nodeType===9?o:o.ownerDocument;c===null||c[GT]||(c[GT]=!0,Tw("selectionchange",!1,c))}}function HL(o,c,m,S){switch(fI(c)){case 2:var E=zk;break;case 8:E=kk;break;default:E=Uw}m=E.bind(null,c,m,o),E=void 0,!e_||c!=="touchstart"&&c!=="touchmove"&&c!=="wheel"||(E=!0),S?E!==void 0?o.addEventListener(c,m,{capture:!0,passive:E}):o.addEventListener(c,m,!0):E!==void 0?o.addEventListener(c,m,{passive:E}):o.addEventListener(c,m,!1)}function Aw(o,c,m,S,E){var P=S;if((c&1)===0&&(c&2)===0&&S!==null)e:for(;;){if(S===null)return;var j=S.tag;if(j===3||j===4){var $=S.stateNode.containerInfo;if($===E)break;if(j===4)for(j=S.return;j!==null;){var ae=j.tag;if((ae===3||ae===4)&&j.stateNode.containerInfo===E)return;j=j.return}for(;$!==null;){if(j=Er($),j===null)return;if(ae=j.tag,ae===5||ae===6||ae===26||ae===27){S=P=j;continue e}$=$.parentNode}}S=S.return}Ry(function(){var pe=P,be=xl(m),Ce=[];e:{var _e=Wy.get(o);if(_e!==void 0){var ye=_f,nt=o;switch(o){case"keypress":if(uu(m)===0)break e;case"keydown":case"keyup":ye=r_;break;case"focusin":nt="focus",ye=Uh;break;case"focusout":nt="blur",ye=Uh;break;case"beforeblur":case"afterblur":ye=Uh;break;case"click":if(m.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":ye=gf;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":ye=Lx;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":ye=zx;break;case Gy:case Sn:case y_:ye=Ix;break;case ta:ye=qi;break;case"scroll":case"scrollend":ye=ow;break;case"wheel":ye=Vx;break;case"copy":case"cut":case"paste":ye=Tl;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":ye=o_;break;case"toggle":case"beforetoggle":ye=Hx}var Ze=(c&4)!==0,Cs=!Ze&&(o==="scroll"||o==="scrollend"),ue=Ze?_e!==null?_e+"Capture":null:_e;Ze=[];for(var re=pe,fe;re!==null;){var Te=re;if(fe=Te.stateNode,Te=Te.tag,Te!==5&&Te!==26&&Te!==27||fe===null||ue===null||(Te=hu(re,ue),Te!=null&&Ze.push(Pv(re,Te,fe))),Cs)break;re=re.return}0<Ze.length&&(_e=new ye(_e,nt,null,m,be),Ce.push({event:_e,listeners:Ze}))}}if((c&7)===0){e:{if(_e=o==="mouseover"||o==="pointerover",ye=o==="mouseout"||o==="pointerout",_e&&m!==Jm&&(nt=m.relatedTarget||m.fromElement)&&(Er(nt)||nt[_o]))break e;if((ye||_e)&&(_e=be.window===be?be:(_e=be.ownerDocument)?_e.defaultView||_e.parentWindow:window,ye?(nt=m.relatedTarget||m.toElement,ye=pe,nt=nt?Er(nt):null,nt!==null&&(Cs=a(nt),Ze=nt.tag,nt!==Cs||Ze!==5&&Ze!==27&&Ze!==6)&&(nt=null)):(ye=null,nt=pe),ye!==nt)){if(Ze=gf,Te="onMouseLeave",ue="onMouseEnter",re="mouse",(o==="pointerout"||o==="pointerover")&&(Ze=o_,Te="onPointerLeave",ue="onPointerEnter",re="pointer"),Cs=ye==null?_e:au(ye),fe=nt==null?_e:au(nt),_e=new Ze(Te,re+"leave",ye,m,be),_e.target=Cs,_e.relatedTarget=fe,Te=null,Er(be)===pe&&(Ze=new Ze(ue,re+"enter",nt,m,be),Ze.target=fe,Ze.relatedTarget=Cs,Te=Ze),Cs=Te,ye&&nt)t:{for(Ze=ye,ue=nt,re=0,fe=Ze;fe;fe=$_(fe))re++;for(fe=0,Te=ue;Te;Te=$_(Te))fe++;for(;0<re-fe;)Ze=$_(Ze),re--;for(;0<fe-re;)ue=$_(ue),fe--;for(;re--;){if(Ze===ue||ue!==null&&Ze===ue.alternate)break t;Ze=$_(Ze),ue=$_(ue)}Ze=null}else Ze=null;ye!==null&&WL(Ce,_e,ye,Ze,!1),nt!==null&&Cs!==null&&WL(Ce,Cs,nt,Ze,!0)}}e:{if(_e=pe?au(pe):window,ye=_e.nodeName&&_e.nodeName.toLowerCase(),ye==="select"||ye==="input"&&_e.type==="file")var Ve=Ia;else if(u_(_e))if(Uy)Ve=ks;else{Ve=m_;var Pt=jx}else ye=_e.nodeName,!ye||ye.toLowerCase()!=="input"||_e.type!=="checkbox"&&_e.type!=="radio"?pe&&$m(pe.elementType)&&(Ve=Ia):Ve=Sf;if(Ve&&(Ve=Ve(o,pe))){By(Ce,Ve,m,be);break e}Pt&&Pt(o,_e,pe),o==="focusout"&&pe&&_e.type==="number"&&pe.memoizedProps.value!=null&&Qm(_e,"number",_e.value)}switch(Pt=pe?au(pe):window,o){case"focusin":(u_(Pt)||Pt.contentEditable==="true")&&(Hh=Pt,bf=pe,gu=null);break;case"focusout":gu=bf=Hh=null;break;case"mousedown":xf=!0;break;case"contextmenu":case"mouseup":case"dragend":xf=!1,__(Ce,m,be);break;case"selectionchange":if(Rr)break;case"keydown":case"keyup":__(Ce,m,be)}var qe;if(pu)e:{switch(o){case"compositionstart":var tt="onCompositionStart";break e;case"compositionend":tt="onCompositionEnd";break e;case"compositionupdate":tt="onCompositionUpdate";break e}tt=void 0}else El?h_(o,m)&&(tt="onCompositionEnd"):o==="keydown"&&m.keyCode===229&&(tt="onCompositionStart");tt&&(Iy&&m.locale!=="ko"&&(El||tt!=="onCompositionStart"?tt==="onCompositionEnd"&&El&&(qe=My()):(So=be,ff="value"in So?So.value:So.textContent,El=!0)),Pt=HT(pe,tt),0<Pt.length&&(tt=new To(tt,o,null,m,be),Ce.push({event:tt,listeners:Pt}),qe?tt.data=qe:(qe=Ny(m),qe!==null&&(tt.data=qe)))),(qe=qx?c_(o,m):Fy(o,m))&&(tt=HT(pe,"onBeforeInput"),0<tt.length&&(Pt=new To("onBeforeInput","beforeinput",null,m,be),Ce.push({event:Pt,listeners:tt}),Pt.data=qe)),hk(Ce,o,pe,m,be)}GL(Ce,c)})}function Pv(o,c,m){return{instance:o,listener:c,currentTarget:m}}function HT(o,c){for(var m=c+"Capture",S=[];o!==null;){var E=o,P=E.stateNode;if(E=E.tag,E!==5&&E!==26&&E!==27||P===null||(E=hu(o,m),E!=null&&S.unshift(Pv(o,E,P)),E=hu(o,c),E!=null&&S.push(Pv(o,E,P))),o.tag===3)return S;o=o.return}return[]}function $_(o){if(o===null)return null;do o=o.return;while(o&&o.tag!==5&&o.tag!==27);return o||null}function WL(o,c,m,S,E){for(var P=c._reactName,j=[];m!==null&&m!==S;){var $=m,ae=$.alternate,pe=$.stateNode;if($=$.tag,ae!==null&&ae===S)break;$!==5&&$!==26&&$!==27||pe===null||(ae=pe,E?(pe=hu(m,P),pe!=null&&j.unshift(Pv(m,pe,ae))):E||(pe=hu(m,P),pe!=null&&j.push(Pv(m,pe,ae)))),m=m.return}j.length!==0&&o.push({event:c,listeners:j})}var fk=/\r\n?/g,pk=/\u0000|\uFFFD/g;function qL(o){return(typeof o=="string"?o:""+o).replace(fk,`
`).replace(pk,"")}function XL(o,c){return c=qL(c),qL(o)===c}function WT(){}function As(o,c,m,S,E,P){switch(m){case"children":typeof S=="string"?c==="body"||c==="textarea"&&S===""||Nh(o,S):(typeof S=="number"||typeof S=="bigint")&&c!=="body"&&Nh(o,""+S);break;case"className":ru(o,"class",S);break;case"tabIndex":ru(o,"tabindex",S);break;case"dir":case"role":case"viewBox":case"width":case"height":ru(o,m,S);break;case"style":wy(o,S,P);break;case"data":if(c!=="object"){ru(o,"data",S);break}case"src":case"href":if(S===""&&(c!=="a"||m!=="href")){o.removeAttribute(m);break}if(S==null||typeof S=="function"||typeof S=="symbol"||typeof S=="boolean"){o.removeAttribute(m);break}S=Zm(""+S),o.setAttribute(m,S);break;case"action":case"formAction":if(typeof S=="function"){o.setAttribute(m,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof P=="function"&&(m==="formAction"?(c!=="input"&&As(o,c,"name",E.name,E,null),As(o,c,"formEncType",E.formEncType,E,null),As(o,c,"formMethod",E.formMethod,E,null),As(o,c,"formTarget",E.formTarget,E,null)):(As(o,c,"encType",E.encType,E,null),As(o,c,"method",E.method,E,null),As(o,c,"target",E.target,E,null)));if(S==null||typeof S=="symbol"||typeof S=="boolean"){o.removeAttribute(m);break}S=Zm(""+S),o.setAttribute(m,S);break;case"onClick":S!=null&&(o.onclick=WT);break;case"onScroll":S!=null&&Nt("scroll",o);break;case"onScrollEnd":S!=null&&Nt("scrollend",o);break;case"dangerouslySetInnerHTML":if(S!=null){if(typeof S!="object"||!("__html"in S))throw Error(s(61));if(m=S.__html,m!=null){if(E.children!=null)throw Error(s(60));o.innerHTML=m}}break;case"multiple":o.multiple=S&&typeof S!="function"&&typeof S!="symbol";break;case"muted":o.muted=S&&typeof S!="function"&&typeof S!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(S==null||typeof S=="function"||typeof S=="boolean"||typeof S=="symbol"){o.removeAttribute("xlink:href");break}m=Zm(""+S),o.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",m);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":S!=null&&typeof S!="function"&&typeof S!="symbol"?o.setAttribute(m,""+S):o.removeAttribute(m);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":S&&typeof S!="function"&&typeof S!="symbol"?o.setAttribute(m,""):o.removeAttribute(m);break;case"capture":case"download":S===!0?o.setAttribute(m,""):S!==!1&&S!=null&&typeof S!="function"&&typeof S!="symbol"?o.setAttribute(m,S):o.removeAttribute(m);break;case"cols":case"rows":case"size":case"span":S!=null&&typeof S!="function"&&typeof S!="symbol"&&!isNaN(S)&&1<=S?o.setAttribute(m,S):o.removeAttribute(m);break;case"rowSpan":case"start":S==null||typeof S=="function"||typeof S=="symbol"||isNaN(S)?o.removeAttribute(m):o.setAttribute(m,S);break;case"popover":Nt("beforetoggle",o),Nt("toggle",o),nu(o,"popover",S);break;case"xlinkActuate":Yn(o,"http://www.w3.org/1999/xlink","xlink:actuate",S);break;case"xlinkArcrole":Yn(o,"http://www.w3.org/1999/xlink","xlink:arcrole",S);break;case"xlinkRole":Yn(o,"http://www.w3.org/1999/xlink","xlink:role",S);break;case"xlinkShow":Yn(o,"http://www.w3.org/1999/xlink","xlink:show",S);break;case"xlinkTitle":Yn(o,"http://www.w3.org/1999/xlink","xlink:title",S);break;case"xlinkType":Yn(o,"http://www.w3.org/1999/xlink","xlink:type",S);break;case"xmlBase":Yn(o,"http://www.w3.org/XML/1998/namespace","xml:base",S);break;case"xmlLang":Yn(o,"http://www.w3.org/XML/1998/namespace","xml:lang",S);break;case"xmlSpace":Yn(o,"http://www.w3.org/XML/1998/namespace","xml:space",S);break;case"is":nu(o,"is",S);break;case"innerText":case"textContent":break;default:(!(2<m.length)||m[0]!=="o"&&m[0]!=="O"||m[1]!=="n"&&m[1]!=="N")&&(m=Mx.get(m)||m,nu(o,m,S))}}function Cw(o,c,m,S,E,P){switch(m){case"style":wy(o,S,P);break;case"dangerouslySetInnerHTML":if(S!=null){if(typeof S!="object"||!("__html"in S))throw Error(s(61));if(m=S.__html,m!=null){if(E.children!=null)throw Error(s(60));o.innerHTML=m}}break;case"children":typeof S=="string"?Nh(o,S):(typeof S=="number"||typeof S=="bigint")&&Nh(o,""+S);break;case"onScroll":S!=null&&Nt("scroll",o);break;case"onScrollEnd":S!=null&&Nt("scrollend",o);break;case"onClick":S!=null&&(o.onclick=WT);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!Xm.hasOwnProperty(m))e:{if(m[0]==="o"&&m[1]==="n"&&(E=m.endsWith("Capture"),c=m.slice(2,E?m.length-7:void 0),P=o[_a]||null,P=P!=null?P[m]:null,typeof P=="function"&&o.removeEventListener(c,P,E),typeof S=="function")){typeof P!="function"&&P!==null&&(m in o?o[m]=null:o.hasAttribute(m)&&o.removeAttribute(m)),o.addEventListener(c,S,E);break e}m in o?o[m]=S:S===!0?o.setAttribute(m,""):nu(o,m,S)}}}function Ca(o,c,m){switch(c){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":Nt("error",o),Nt("load",o);var S=!1,E=!1,P;for(P in m)if(m.hasOwnProperty(P)){var j=m[P];if(j!=null)switch(P){case"src":S=!0;break;case"srcSet":E=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(s(137,c));default:As(o,c,P,j,m,null)}}E&&As(o,c,"srcSet",m.srcSet,m,null),S&&As(o,c,"src",m.src,m,null);return;case"input":Nt("invalid",o);var $=P=j=E=null,ae=null,pe=null;for(S in m)if(m.hasOwnProperty(S)){var be=m[S];if(be!=null)switch(S){case"name":E=be;break;case"type":j=be;break;case"checked":ae=be;break;case"defaultChecked":pe=be;break;case"value":P=be;break;case"defaultValue":$=be;break;case"children":case"dangerouslySetInnerHTML":if(be!=null)throw Error(s(137,c));break;default:As(o,c,S,be,m,null)}}Km(o,P,$,ae,pe,j,E,!1),cf(o);return;case"select":Nt("invalid",o),S=j=P=null;for(E in m)if(m.hasOwnProperty(E)&&($=m[E],$!=null))switch(E){case"value":P=$;break;case"defaultValue":j=$;break;case"multiple":S=$;default:As(o,c,E,$,m,null)}c=P,m=j,o.multiple=!!S,c!=null?lu(o,!!S,c,!1):m!=null&&lu(o,!!S,m,!0);return;case"textarea":Nt("invalid",o),P=E=S=null;for(j in m)if(m.hasOwnProperty(j)&&($=m[j],$!=null))switch(j){case"value":S=$;break;case"defaultValue":E=$;break;case"children":P=$;break;case"dangerouslySetInnerHTML":if($!=null)throw Error(s(91));break;default:As(o,c,j,$,m,null)}Ey(o,S,E,P),cf(o);return;case"option":for(ae in m)if(m.hasOwnProperty(ae)&&(S=m[ae],S!=null))switch(ae){case"selected":o.selected=S&&typeof S!="function"&&typeof S!="symbol";break;default:As(o,c,ae,S,m,null)}return;case"dialog":Nt("beforetoggle",o),Nt("toggle",o),Nt("cancel",o),Nt("close",o);break;case"iframe":case"object":Nt("load",o);break;case"video":case"audio":for(S=0;S<Dv.length;S++)Nt(Dv[S],o);break;case"image":Nt("error",o),Nt("load",o);break;case"details":Nt("toggle",o);break;case"embed":case"source":case"link":Nt("error",o),Nt("load",o);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(pe in m)if(m.hasOwnProperty(pe)&&(S=m[pe],S!=null))switch(pe){case"children":case"dangerouslySetInnerHTML":throw Error(s(137,c));default:As(o,c,pe,S,m,null)}return;default:if($m(c)){for(be in m)m.hasOwnProperty(be)&&(S=m[be],S!==void 0&&Cw(o,c,be,S,m,void 0));return}}for($ in m)m.hasOwnProperty($)&&(S=m[$],S!=null&&As(o,c,$,S,m,null))}function mk(o,c,m,S){switch(c){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var E=null,P=null,j=null,$=null,ae=null,pe=null,be=null;for(ye in m){var Ce=m[ye];if(m.hasOwnProperty(ye)&&Ce!=null)switch(ye){case"checked":break;case"value":break;case"defaultValue":ae=Ce;default:S.hasOwnProperty(ye)||As(o,c,ye,null,S,Ce)}}for(var _e in S){var ye=S[_e];if(Ce=m[_e],S.hasOwnProperty(_e)&&(ye!=null||Ce!=null))switch(_e){case"type":P=ye;break;case"name":E=ye;break;case"checked":pe=ye;break;case"defaultChecked":be=ye;break;case"value":j=ye;break;case"defaultValue":$=ye;break;case"children":case"dangerouslySetInnerHTML":if(ye!=null)throw Error(s(137,c));break;default:ye!==Ce&&As(o,c,_e,ye,S,Ce)}}Ym(o,j,$,ae,pe,be,P,E);return;case"select":ye=j=$=_e=null;for(P in m)if(ae=m[P],m.hasOwnProperty(P)&&ae!=null)switch(P){case"value":break;case"multiple":ye=ae;default:S.hasOwnProperty(P)||As(o,c,P,null,S,ae)}for(E in S)if(P=S[E],ae=m[E],S.hasOwnProperty(E)&&(P!=null||ae!=null))switch(E){case"value":_e=P;break;case"defaultValue":$=P;break;case"multiple":j=P;default:P!==ae&&As(o,c,E,P,S,ae)}c=$,m=j,S=ye,_e!=null?lu(o,!!m,_e,!1):!!S!=!!m&&(c!=null?lu(o,!!m,c,!0):lu(o,!!m,m?[]:"",!1));return;case"textarea":ye=_e=null;for($ in m)if(E=m[$],m.hasOwnProperty($)&&E!=null&&!S.hasOwnProperty($))switch($){case"value":break;case"children":break;default:As(o,c,$,null,S,E)}for(j in S)if(E=S[j],P=m[j],S.hasOwnProperty(j)&&(E!=null||P!=null))switch(j){case"value":_e=E;break;case"defaultValue":ye=E;break;case"children":break;case"dangerouslySetInnerHTML":if(E!=null)throw Error(s(91));break;default:E!==P&&As(o,c,j,E,S,P)}Ty(o,_e,ye);return;case"option":for(var nt in m)if(_e=m[nt],m.hasOwnProperty(nt)&&_e!=null&&!S.hasOwnProperty(nt))switch(nt){case"selected":o.selected=!1;break;default:As(o,c,nt,null,S,_e)}for(ae in S)if(_e=S[ae],ye=m[ae],S.hasOwnProperty(ae)&&_e!==ye&&(_e!=null||ye!=null))switch(ae){case"selected":o.selected=_e&&typeof _e!="function"&&typeof _e!="symbol";break;default:As(o,c,ae,_e,S,ye)}return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var Ze in m)_e=m[Ze],m.hasOwnProperty(Ze)&&_e!=null&&!S.hasOwnProperty(Ze)&&As(o,c,Ze,null,S,_e);for(pe in S)if(_e=S[pe],ye=m[pe],S.hasOwnProperty(pe)&&_e!==ye&&(_e!=null||ye!=null))switch(pe){case"children":case"dangerouslySetInnerHTML":if(_e!=null)throw Error(s(137,c));break;default:As(o,c,pe,_e,S,ye)}return;default:if($m(c)){for(var Cs in m)_e=m[Cs],m.hasOwnProperty(Cs)&&_e!==void 0&&!S.hasOwnProperty(Cs)&&Cw(o,c,Cs,void 0,S,_e);for(be in S)_e=S[be],ye=m[be],!S.hasOwnProperty(be)||_e===ye||_e===void 0&&ye===void 0||Cw(o,c,be,_e,S,ye);return}}for(var ue in m)_e=m[ue],m.hasOwnProperty(ue)&&_e!=null&&!S.hasOwnProperty(ue)&&As(o,c,ue,null,S,_e);for(Ce in S)_e=S[Ce],ye=m[Ce],!S.hasOwnProperty(Ce)||_e===ye||_e==null&&ye==null||As(o,c,Ce,_e,S,ye)}var ww=null,Rw=null;function qT(o){return o.nodeType===9?o:o.ownerDocument}function jL(o){switch(o){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function YL(o,c){if(o===0)switch(c){case"svg":return 1;case"math":return 2;default:return 0}return o===1&&c==="foreignObject"?0:o}function Mw(o,c){return o==="textarea"||o==="noscript"||typeof c.children=="string"||typeof c.children=="number"||typeof c.children=="bigint"||typeof c.dangerouslySetInnerHTML=="object"&&c.dangerouslySetInnerHTML!==null&&c.dangerouslySetInnerHTML.__html!=null}var Dw=null;function _k(){var o=window.event;return o&&o.type==="popstate"?o===Dw?!1:(Dw=o,!0):(Dw=null,!1)}var KL=typeof setTimeout=="function"?setTimeout:void 0,gk=typeof clearTimeout=="function"?clearTimeout:void 0,QL=typeof Promise=="function"?Promise:void 0,yk=typeof queueMicrotask=="function"?queueMicrotask:typeof QL<"u"?function(o){return QL.resolve(null).then(o).catch(vk)}:KL;function vk(o){setTimeout(function(){throw o})}function Wu(o){return o==="head"}function $L(o,c){var m=c,S=0,E=0;do{var P=m.nextSibling;if(o.removeChild(m),P&&P.nodeType===8)if(m=P.data,m==="/$"){if(0<S&&8>S){m=S;var j=o.ownerDocument;if(m&1&&Lv(j.documentElement),m&2&&Lv(j.body),m&4)for(m=j.head,Lv(m),j=m.firstChild;j;){var $=j.nextSibling,ae=j.nodeName;j[yo]||ae==="SCRIPT"||ae==="STYLE"||ae==="LINK"&&j.rel.toLowerCase()==="stylesheet"||m.removeChild(j),j=$}}if(E===0){o.removeChild(P),kv(c);return}E--}else m==="$"||m==="$?"||m==="$!"?E++:S=m.charCodeAt(0)-48;else S=0;m=P}while(m);kv(c)}function Pw(o){var c=o.firstChild;for(c&&c.nodeType===10&&(c=c.nextSibling);c;){var m=c;switch(c=c.nextSibling,m.nodeName){case"HTML":case"HEAD":case"BODY":Pw(m),hf(m);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(m.rel.toLowerCase()==="stylesheet")continue}o.removeChild(m)}}function Sk(o,c,m,S){for(;o.nodeType===1;){var E=m;if(o.nodeName.toLowerCase()!==c.toLowerCase()){if(!S&&(o.nodeName!=="INPUT"||o.type!=="hidden"))break}else if(S){if(!o[yo])switch(c){case"meta":if(!o.hasAttribute("itemprop"))break;return o;case"link":if(P=o.getAttribute("rel"),P==="stylesheet"&&o.hasAttribute("data-precedence"))break;if(P!==E.rel||o.getAttribute("href")!==(E.href==null||E.href===""?null:E.href)||o.getAttribute("crossorigin")!==(E.crossOrigin==null?null:E.crossOrigin)||o.getAttribute("title")!==(E.title==null?null:E.title))break;return o;case"style":if(o.hasAttribute("data-precedence"))break;return o;case"script":if(P=o.getAttribute("src"),(P!==(E.src==null?null:E.src)||o.getAttribute("type")!==(E.type==null?null:E.type)||o.getAttribute("crossorigin")!==(E.crossOrigin==null?null:E.crossOrigin))&&P&&o.hasAttribute("async")&&!o.hasAttribute("itemprop"))break;return o;default:return o}}else if(c==="input"&&o.type==="hidden"){var P=E.name==null?null:""+E.name;if(E.type==="hidden"&&o.getAttribute("name")===P)return o}else return o;if(o=Go(o.nextSibling),o===null)break}return null}function bk(o,c,m){if(c==="")return null;for(;o.nodeType!==3;)if((o.nodeType!==1||o.nodeName!=="INPUT"||o.type!=="hidden")&&!m||(o=Go(o.nextSibling),o===null))return null;return o}function Lw(o){return o.data==="$!"||o.data==="$?"&&o.ownerDocument.readyState==="complete"}function xk(o,c){var m=o.ownerDocument;if(o.data!=="$?"||m.readyState==="complete")c();else{var S=function(){c(),m.removeEventListener("DOMContentLoaded",S)};m.addEventListener("DOMContentLoaded",S),o._reactRetry=S}}function Go(o){for(;o!=null;o=o.nextSibling){var c=o.nodeType;if(c===1||c===3)break;if(c===8){if(c=o.data,c==="$"||c==="$!"||c==="$?"||c==="F!"||c==="F")break;if(c==="/$")return null}}return o}var Iw=null;function ZL(o){o=o.previousSibling;for(var c=0;o;){if(o.nodeType===8){var m=o.data;if(m==="$"||m==="$!"||m==="$?"){if(c===0)return o;c--}else m==="/$"&&c++}o=o.previousSibling}return null}function JL(o,c,m){switch(c=qT(m),o){case"html":if(o=c.documentElement,!o)throw Error(s(452));return o;case"head":if(o=c.head,!o)throw Error(s(453));return o;case"body":if(o=c.body,!o)throw Error(s(454));return o;default:throw Error(s(451))}}function Lv(o){for(var c=o.attributes;c.length;)o.removeAttributeNode(c[0]);hf(o)}var Yr=new Map,eI=new Set;function XT(o){return typeof o.getRootNode=="function"?o.getRootNode():o.nodeType===9?o:o.ownerDocument}var cc=k.d;k.d={f:Tk,r:Ek,D:Ak,C:Ck,L:wk,m:Rk,X:Dk,S:Mk,M:Pk};function Tk(){var o=cc.f(),c=$l();return o||c}function Ek(o){var c=Ar(o);c!==null&&c.tag===5&&c.type==="form"?AT(c):cc.r(o)}var Z_=typeof document>"u"?null:document;function tI(o,c,m){var S=Z_;if(S&&typeof c=="string"&&c){var E=nn(c);E='link[rel="'+o+'"][href="'+E+'"]',typeof m=="string"&&(E+='[crossorigin="'+m+'"]'),eI.has(E)||(eI.add(E),o={rel:o,crossOrigin:m,href:c},S.querySelector(E)===null&&(c=S.createElement("link"),Ca(c,"link",o),gi(c),S.head.appendChild(c)))}}function Ak(o){cc.D(o),tI("dns-prefetch",o,null)}function Ck(o,c){cc.C(o,c),tI("preconnect",o,c)}function wk(o,c,m){cc.L(o,c,m);var S=Z_;if(S&&o&&c){var E='link[rel="preload"][as="'+nn(c)+'"]';c==="image"&&m&&m.imageSrcSet?(E+='[imagesrcset="'+nn(m.imageSrcSet)+'"]',typeof m.imageSizes=="string"&&(E+='[imagesizes="'+nn(m.imageSizes)+'"]')):E+='[href="'+nn(o)+'"]';var P=E;switch(c){case"style":P=J_(o);break;case"script":P=eg(o)}Yr.has(P)||(o=f({rel:"preload",href:c==="image"&&m&&m.imageSrcSet?void 0:o,as:c},m),Yr.set(P,o),S.querySelector(E)!==null||c==="style"&&S.querySelector(Iv(P))||c==="script"&&S.querySelector(Ov(P))||(c=S.createElement("link"),Ca(c,"link",o),gi(c),S.head.appendChild(c)))}}function Rk(o,c){cc.m(o,c);var m=Z_;if(m&&o){var S=c&&typeof c.as=="string"?c.as:"script",E='link[rel="modulepreload"][as="'+nn(S)+'"][href="'+nn(o)+'"]',P=E;switch(S){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":P=eg(o)}if(!Yr.has(P)&&(o=f({rel:"modulepreload",href:o},c),Yr.set(P,o),m.querySelector(E)===null)){switch(S){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(m.querySelector(Ov(P)))return}S=m.createElement("link"),Ca(S,"link",o),gi(S),m.head.appendChild(S)}}}function Mk(o,c,m){cc.S(o,c,m);var S=Z_;if(S&&o){var E=Ih(S).hoistableStyles,P=J_(o);c=c||"default";var j=E.get(P);if(!j){var $={loading:0,preload:null};if(j=S.querySelector(Iv(P)))$.loading=5;else{o=f({rel:"stylesheet",href:o,"data-precedence":c},m),(m=Yr.get(P))&&Ow(o,m);var ae=j=S.createElement("link");gi(ae),Ca(ae,"link",o),ae._p=new Promise(function(pe,be){ae.onload=pe,ae.onerror=be}),ae.addEventListener("load",function(){$.loading|=1}),ae.addEventListener("error",function(){$.loading|=2}),$.loading|=4,jT(j,c,S)}j={type:"stylesheet",instance:j,count:1,state:$},E.set(P,j)}}}function Dk(o,c){cc.X(o,c);var m=Z_;if(m&&o){var S=Ih(m).hoistableScripts,E=eg(o),P=S.get(E);P||(P=m.querySelector(Ov(E)),P||(o=f({src:o,async:!0},c),(c=Yr.get(E))&&Nw(o,c),P=m.createElement("script"),gi(P),Ca(P,"link",o),m.head.appendChild(P)),P={type:"script",instance:P,count:1,state:null},S.set(E,P))}}function Pk(o,c){cc.M(o,c);var m=Z_;if(m&&o){var S=Ih(m).hoistableScripts,E=eg(o),P=S.get(E);P||(P=m.querySelector(Ov(E)),P||(o=f({src:o,async:!0,type:"module"},c),(c=Yr.get(E))&&Nw(o,c),P=m.createElement("script"),gi(P),Ca(P,"link",o),m.head.appendChild(P)),P={type:"script",instance:P,count:1,state:null},S.set(E,P))}}function sI(o,c,m,S){var E=(E=he.current)?XT(E):null;if(!E)throw Error(s(446));switch(o){case"meta":case"title":return null;case"style":return typeof m.precedence=="string"&&typeof m.href=="string"?(c=J_(m.href),m=Ih(E).hoistableStyles,S=m.get(c),S||(S={type:"style",instance:null,count:0,state:null},m.set(c,S)),S):{type:"void",instance:null,count:0,state:null};case"link":if(m.rel==="stylesheet"&&typeof m.href=="string"&&typeof m.precedence=="string"){o=J_(m.href);var P=Ih(E).hoistableStyles,j=P.get(o);if(j||(E=E.ownerDocument||E,j={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},P.set(o,j),(P=E.querySelector(Iv(o)))&&!P._p&&(j.instance=P,j.state.loading=5),Yr.has(o)||(m={rel:"preload",as:"style",href:m.href,crossOrigin:m.crossOrigin,integrity:m.integrity,media:m.media,hrefLang:m.hrefLang,referrerPolicy:m.referrerPolicy},Yr.set(o,m),P||Lk(E,o,m,j.state))),c&&S===null)throw Error(s(528,""));return j}if(c&&S!==null)throw Error(s(529,""));return null;case"script":return c=m.async,m=m.src,typeof m=="string"&&c&&typeof c!="function"&&typeof c!="symbol"?(c=eg(m),m=Ih(E).hoistableScripts,S=m.get(c),S||(S={type:"script",instance:null,count:0,state:null},m.set(c,S)),S):{type:"void",instance:null,count:0,state:null};default:throw Error(s(444,o))}}function J_(o){return'href="'+nn(o)+'"'}function Iv(o){return'link[rel="stylesheet"]['+o+"]"}function iI(o){return f({},o,{"data-precedence":o.precedence,precedence:null})}function Lk(o,c,m,S){o.querySelector('link[rel="preload"][as="style"]['+c+"]")?S.loading=1:(c=o.createElement("link"),S.preload=c,c.addEventListener("load",function(){return S.loading|=1}),c.addEventListener("error",function(){return S.loading|=2}),Ca(c,"link",m),gi(c),o.head.appendChild(c))}function eg(o){return'[src="'+nn(o)+'"]'}function Ov(o){return"script[async]"+o}function aI(o,c,m){if(c.count++,c.instance===null)switch(c.type){case"style":var S=o.querySelector('style[data-href~="'+nn(m.href)+'"]');if(S)return c.instance=S,gi(S),S;var E=f({},m,{"data-href":m.href,"data-precedence":m.precedence,href:null,precedence:null});return S=(o.ownerDocument||o).createElement("style"),gi(S),Ca(S,"style",E),jT(S,m.precedence,o),c.instance=S;case"stylesheet":E=J_(m.href);var P=o.querySelector(Iv(E));if(P)return c.state.loading|=4,c.instance=P,gi(P),P;S=iI(m),(E=Yr.get(E))&&Ow(S,E),P=(o.ownerDocument||o).createElement("link"),gi(P);var j=P;return j._p=new Promise(function($,ae){j.onload=$,j.onerror=ae}),Ca(P,"link",S),c.state.loading|=4,jT(P,m.precedence,o),c.instance=P;case"script":return P=eg(m.src),(E=o.querySelector(Ov(P)))?(c.instance=E,gi(E),E):(S=m,(E=Yr.get(P))&&(S=f({},m),Nw(S,E)),o=o.ownerDocument||o,E=o.createElement("script"),gi(E),Ca(E,"link",S),o.head.appendChild(E),c.instance=E);case"void":return null;default:throw Error(s(443,c.type))}else c.type==="stylesheet"&&(c.state.loading&4)===0&&(S=c.instance,c.state.loading|=4,jT(S,m.precedence,o));return c.instance}function jT(o,c,m){for(var S=m.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),E=S.length?S[S.length-1]:null,P=E,j=0;j<S.length;j++){var $=S[j];if($.dataset.precedence===c)P=$;else if(P!==E)break}P?P.parentNode.insertBefore(o,P.nextSibling):(c=m.nodeType===9?m.head:m,c.insertBefore(o,c.firstChild))}function Ow(o,c){o.crossOrigin==null&&(o.crossOrigin=c.crossOrigin),o.referrerPolicy==null&&(o.referrerPolicy=c.referrerPolicy),o.title==null&&(o.title=c.title)}function Nw(o,c){o.crossOrigin==null&&(o.crossOrigin=c.crossOrigin),o.referrerPolicy==null&&(o.referrerPolicy=c.referrerPolicy),o.integrity==null&&(o.integrity=c.integrity)}var YT=null;function nI(o,c,m){if(YT===null){var S=new Map,E=YT=new Map;E.set(m,S)}else E=YT,S=E.get(m),S||(S=new Map,E.set(m,S));if(S.has(o))return S;for(S.set(o,null),m=m.getElementsByTagName(o),E=0;E<m.length;E++){var P=m[E];if(!(P[yo]||P[si]||o==="link"&&P.getAttribute("rel")==="stylesheet")&&P.namespaceURI!=="http://www.w3.org/2000/svg"){var j=P.getAttribute(c)||"";j=o+j;var $=S.get(j);$?$.push(P):S.set(j,[P])}}return S}function rI(o,c,m){o=o.ownerDocument||o,o.head.insertBefore(m,c==="title"?o.querySelector("head > title"):null)}function Ik(o,c,m){if(m===1||c.itemProp!=null)return!1;switch(o){case"meta":case"title":return!0;case"style":if(typeof c.precedence!="string"||typeof c.href!="string"||c.href==="")break;return!0;case"link":if(typeof c.rel!="string"||typeof c.href!="string"||c.href===""||c.onLoad||c.onError)break;switch(c.rel){case"stylesheet":return o=c.disabled,typeof c.precedence=="string"&&o==null;default:return!0}case"script":if(c.async&&typeof c.async!="function"&&typeof c.async!="symbol"&&!c.onLoad&&!c.onError&&c.src&&typeof c.src=="string")return!0}return!1}function oI(o){return!(o.type==="stylesheet"&&(o.state.loading&3)===0)}var Nv=null;function Ok(){}function Nk(o,c,m){if(Nv===null)throw Error(s(475));var S=Nv;if(c.type==="stylesheet"&&(typeof m.media!="string"||matchMedia(m.media).matches!==!1)&&(c.state.loading&4)===0){if(c.instance===null){var E=J_(m.href),P=o.querySelector(Iv(E));if(P){o=P._p,o!==null&&typeof o=="object"&&typeof o.then=="function"&&(S.count++,S=KT.bind(S),o.then(S,S)),c.state.loading|=4,c.instance=P,gi(P);return}P=o.ownerDocument||o,m=iI(m),(E=Yr.get(E))&&Ow(m,E),P=P.createElement("link"),gi(P);var j=P;j._p=new Promise(function($,ae){j.onload=$,j.onerror=ae}),Ca(P,"link",m),c.instance=P}S.stylesheets===null&&(S.stylesheets=new Map),S.stylesheets.set(c,o),(o=c.state.preload)&&(c.state.loading&3)===0&&(S.count++,c=KT.bind(S),o.addEventListener("load",c),o.addEventListener("error",c))}}function Fk(){if(Nv===null)throw Error(s(475));var o=Nv;return o.stylesheets&&o.count===0&&Fw(o,o.stylesheets),0<o.count?function(c){var m=setTimeout(function(){if(o.stylesheets&&Fw(o,o.stylesheets),o.unsuspend){var S=o.unsuspend;o.unsuspend=null,S()}},6e4);return o.unsuspend=c,function(){o.unsuspend=null,clearTimeout(m)}}:null}function KT(){if(this.count--,this.count===0){if(this.stylesheets)Fw(this,this.stylesheets);else if(this.unsuspend){var o=this.unsuspend;this.unsuspend=null,o()}}}var QT=null;function Fw(o,c){o.stylesheets=null,o.unsuspend!==null&&(o.count++,QT=new Map,c.forEach(Bk,o),QT=null,KT.call(o))}function Bk(o,c){if(!(c.state.loading&4)){var m=QT.get(o);if(m)var S=m.get(null);else{m=new Map,QT.set(o,m);for(var E=o.querySelectorAll("link[data-precedence],style[data-precedence]"),P=0;P<E.length;P++){var j=E[P];(j.nodeName==="LINK"||j.getAttribute("media")!=="not all")&&(m.set(j.dataset.precedence,j),S=j)}S&&m.set(null,S)}E=c.instance,j=E.getAttribute("data-precedence"),P=m.get(j)||S,P===S&&m.set(null,E),m.set(j,E),this.count++,S=KT.bind(this),E.addEventListener("load",S),E.addEventListener("error",S),P?P.parentNode.insertBefore(E,P.nextSibling):(o=o.nodeType===9?o.head:o,o.insertBefore(E,o.firstChild)),c.state.loading|=4}}var Fv={$$typeof:T,Provider:null,Consumer:null,_currentValue:K,_currentValue2:K,_threadCount:0};function Uk(o,c,m,S,E,P,j,$){this.tag=1,this.containerInfo=o,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=Vm(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Vm(0),this.hiddenUpdates=Vm(null),this.identifierPrefix=S,this.onUncaughtError=E,this.onCaughtError=P,this.onRecoverableError=j,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=$,this.incompleteTransitions=new Map}function lI(o,c,m,S,E,P,j,$,ae,pe,be,Ce){return o=new Uk(o,c,m,j,$,ae,pe,Ce),c=1,P===!0&&(c|=24),P=Oa(3,null,null,c),o.current=P,P.stateNode=o,c=xu(),c.refCount++,o.pooledCache=c,c.refCount++,P.memoizedState={element:S,isDehydrated:m,cache:c},Lf(P),o}function hI(o){return o?(o=qh,o):qh}function cI(o,c,m,S,E,P){E=hI(E),S.context===null?S.context=E:S.pendingContext=E,S=Br(c),S.payload={element:m},P=P===void 0?null:P,P!==null&&(S.callback=P),m=va(o,S,c),m!==null&&(fi(m,o,c),tc(m,o,c))}function uI(o,c){if(o=o.memoizedState,o!==null&&o.dehydrated!==null){var m=o.retryLane;o.retryLane=m!==0&&m<c?m:c}}function Bw(o,c){uI(o,c),(o=o.alternate)&&uI(o,c)}function dI(o){if(o.tag===13){var c=Dr(o,67108864);c!==null&&fi(c,o,67108864),Bw(o,67108864)}}var $T=!0;function zk(o,c,m,S){var E=W.T;W.T=null;var P=k.p;try{k.p=2,Uw(o,c,m,S)}finally{k.p=P,W.T=E}}function kk(o,c,m,S){var E=W.T;W.T=null;var P=k.p;try{k.p=8,Uw(o,c,m,S)}finally{k.p=P,W.T=E}}function Uw(o,c,m,S){if($T){var E=zw(S);if(E===null)Aw(o,c,S,ZT,m),pI(o,S);else if(Gk(E,o,c,m,S))S.stopPropagation();else if(pI(o,S),c&4&&-1<Vk.indexOf(o)){for(;E!==null;){var P=Ar(E);if(P!==null)switch(P.tag){case 3:if(P=P.stateNode,P.current.memoizedState.isDehydrated){var j=an(P.pendingLanes);if(j!==0){var $=P;for($.pendingLanes|=2,$.entangledLanes|=2;j;){var ae=1<<31-bs(j);$.entanglements[1]|=ae,j&=~ae}ke(P),(st&6)===0&&(lc=ht()+500,is(0))}}break;case 13:$=Dr(P,2),$!==null&&fi($,P,2),$l(),Bw(P,2)}if(P=zw(S),P===null&&Aw(o,c,S,ZT,m),P===E)break;E=P}E!==null&&S.stopPropagation()}else Aw(o,c,S,null,m)}}function zw(o){return o=xl(o),kw(o)}var ZT=null;function kw(o){if(ZT=null,o=Er(o),o!==null){var c=a(o);if(c===null)o=null;else{var m=c.tag;if(m===13){if(o=n(c),o!==null)return o;o=null}else if(m===3){if(c.stateNode.current.memoizedState.isDehydrated)return c.tag===3?c.stateNode.containerInfo:null;o=null}else c!==o&&(o=null)}}return ZT=o,null}function fI(o){switch(o){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(Pe()){case Zi:return 2;case zs:return 8;case oi:case lt:return 32;case ti:return 268435456;default:return 32}default:return 32}}var Vw=!1,qu=null,Xu=null,ju=null,Bv=new Map,Uv=new Map,Yu=[],Vk="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function pI(o,c){switch(o){case"focusin":case"focusout":qu=null;break;case"dragenter":case"dragleave":Xu=null;break;case"mouseover":case"mouseout":ju=null;break;case"pointerover":case"pointerout":Bv.delete(c.pointerId);break;case"gotpointercapture":case"lostpointercapture":Uv.delete(c.pointerId)}}function zv(o,c,m,S,E,P){return o===null||o.nativeEvent!==P?(o={blockedOn:c,domEventName:m,eventSystemFlags:S,nativeEvent:P,targetContainers:[E]},c!==null&&(c=Ar(c),c!==null&&dI(c)),o):(o.eventSystemFlags|=S,c=o.targetContainers,E!==null&&c.indexOf(E)===-1&&c.push(E),o)}function Gk(o,c,m,S,E){switch(c){case"focusin":return qu=zv(qu,o,c,m,S,E),!0;case"dragenter":return Xu=zv(Xu,o,c,m,S,E),!0;case"mouseover":return ju=zv(ju,o,c,m,S,E),!0;case"pointerover":var P=E.pointerId;return Bv.set(P,zv(Bv.get(P)||null,o,c,m,S,E)),!0;case"gotpointercapture":return P=E.pointerId,Uv.set(P,zv(Uv.get(P)||null,o,c,m,S,E)),!0}return!1}function mI(o){var c=Er(o.target);if(c!==null){var m=a(c);if(m!==null){if(c=m.tag,c===13){if(c=n(m),c!==null){o.blockedOn=c,Wm(o.priority,function(){if(m.tag===13){var S=ai();S=Gm(S);var E=Dr(m,S);E!==null&&fi(E,m,S),Bw(m,S)}});return}}else if(c===3&&m.stateNode.current.memoizedState.isDehydrated){o.blockedOn=m.tag===3?m.stateNode.containerInfo:null;return}}}o.blockedOn=null}function JT(o){if(o.blockedOn!==null)return!1;for(var c=o.targetContainers;0<c.length;){var m=zw(o.nativeEvent);if(m===null){m=o.nativeEvent;var S=new m.constructor(m.type,m);Jm=S,m.target.dispatchEvent(S),Jm=null}else return c=Ar(m),c!==null&&dI(c),o.blockedOn=m,!1;c.shift()}return!0}function _I(o,c,m){JT(o)&&m.delete(c)}function Hk(){Vw=!1,qu!==null&&JT(qu)&&(qu=null),Xu!==null&&JT(Xu)&&(Xu=null),ju!==null&&JT(ju)&&(ju=null),Bv.forEach(_I),Uv.forEach(_I)}function eE(o,c){o.blockedOn===c&&(o.blockedOn=null,Vw||(Vw=!0,h.unstable_scheduleCallback(h.unstable_NormalPriority,Hk)))}var tE=null;function gI(o){tE!==o&&(tE=o,h.unstable_scheduleCallback(h.unstable_NormalPriority,function(){tE===o&&(tE=null);for(var c=0;c<o.length;c+=3){var m=o[c],S=o[c+1],E=o[c+2];if(typeof S!="function"){if(kw(S||m)===null)continue;break}var P=Ar(m);P!==null&&(o.splice(c,3),c-=3,mv(P,{pending:!0,data:E,method:m.method,action:S},S,E))}}))}function kv(o){function c(ae){return eE(ae,o)}qu!==null&&eE(qu,o),Xu!==null&&eE(Xu,o),ju!==null&&eE(ju,o),Bv.forEach(c),Uv.forEach(c);for(var m=0;m<Yu.length;m++){var S=Yu[m];S.blockedOn===o&&(S.blockedOn=null)}for(;0<Yu.length&&(m=Yu[0],m.blockedOn===null);)mI(m),m.blockedOn===null&&Yu.shift();if(m=(o.ownerDocument||o).$$reactFormReplay,m!=null)for(S=0;S<m.length;S+=3){var E=m[S],P=m[S+1],j=E[_a]||null;if(typeof P=="function")j||gI(m);else if(j){var $=null;if(P&&P.hasAttribute("formAction")){if(E=P,j=P[_a]||null)$=j.formAction;else if(kw(E)!==null)continue}else $=j.action;typeof $=="function"?m[S+1]=$:(m.splice(S,3),S-=3),gI(m)}}}function Gw(o){this._internalRoot=o}sE.prototype.render=Gw.prototype.render=function(o){var c=this._internalRoot;if(c===null)throw Error(s(409));var m=c.current,S=ai();cI(m,S,o,c,null,null)},sE.prototype.unmount=Gw.prototype.unmount=function(){var o=this._internalRoot;if(o!==null){this._internalRoot=null;var c=o.containerInfo;cI(o.current,2,null,o,null,null),$l(),c[_o]=null}};function sE(o){this._internalRoot=o}sE.prototype.unstable_scheduleHydration=function(o){if(o){var c=of();o={blockedOn:null,target:o,priority:c};for(var m=0;m<Yu.length&&c!==0&&c<Yu[m].priority;m++);Yu.splice(m,0,o),m===0&&mI(o)}};var yI=e.version;if(yI!=="19.1.0")throw Error(s(527,yI,"19.1.0"));k.findDOMNode=function(o){var c=o._reactInternals;if(c===void 0)throw typeof o.render=="function"?Error(s(188)):(o=Object.keys(o).join(","),Error(s(268,o)));return o=l(c),o=o!==null?u(o):null,o=o===null?null:o.stateNode,o};var Wk={bundleType:0,version:"19.1.0",rendererPackageName:"react-dom",currentDispatcherRef:W,reconcilerVersion:"19.1.0"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var iE=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!iE.isDisabled&&iE.supportsFiber)try{Xe=iE.inject(Wk),Mt=iE}catch{}}return uS.createRoot=function(o,c){if(!i(o))throw Error(s(299));var m=!1,S="",E=ac,P=ka,j=IT,$=null;return c!=null&&(c.unstable_strictMode===!0&&(m=!0),c.identifierPrefix!==void 0&&(S=c.identifierPrefix),c.onUncaughtError!==void 0&&(E=c.onUncaughtError),c.onCaughtError!==void 0&&(P=c.onCaughtError),c.onRecoverableError!==void 0&&(j=c.onRecoverableError),c.unstable_transitionCallbacks!==void 0&&($=c.unstable_transitionCallbacks)),c=lI(o,1,!1,null,null,m,S,E,P,j,$,null),o[_o]=c.current,Ew(o),new Gw(c)},uS.hydrateRoot=function(o,c,m){if(!i(o))throw Error(s(299));var S=!1,E="",P=ac,j=ka,$=IT,ae=null,pe=null;return m!=null&&(m.unstable_strictMode===!0&&(S=!0),m.identifierPrefix!==void 0&&(E=m.identifierPrefix),m.onUncaughtError!==void 0&&(P=m.onUncaughtError),m.onCaughtError!==void 0&&(j=m.onCaughtError),m.onRecoverableError!==void 0&&($=m.onRecoverableError),m.unstable_transitionCallbacks!==void 0&&(ae=m.unstable_transitionCallbacks),m.formState!==void 0&&(pe=m.formState)),c=lI(o,1,!0,c,m??null,S,E,P,j,$,ae,pe),c.context=hI(null),m=c.current,S=ai(),S=Gm(S),E=Br(S),E.callback=null,va(m,E,S),m=S,c.current.lanes=m,yl(c,m),ke(c),o[_o]=c.current,Ew(o),new sE(c)},uS.version="19.1.0",uS}var UN;function coe(){if(UN)return _M.exports;UN=1;function h(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(h)}catch(e){console.error(e)}}return h(),_M.exports=hoe(),_M.exports}var uoe=coe(),SM={exports:{}},dS={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var zN;function doe(){if(zN)return dS;zN=1;var h=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function t(s,i,a){var n=null;if(a!==void 0&&(n=""+a),i.key!==void 0&&(n=""+i.key),"key"in i){a={};for(var r in i)r!=="key"&&(a[r]=i[r])}else a=i;return i=a.ref,{$$typeof:h,type:s,key:n,ref:i!==void 0?i:null,props:a}}return dS.Fragment=e,dS.jsx=t,dS.jsxs=t,dS}var kN;function foe(){return kN||(kN=1,SM.exports=doe()),SM.exports}var qa=foe(),AA={exports:{}},fS={},bM={},xM={},VN;function Rt(){return VN||(VN=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h._registerNode=h.Konva=h.glob=void 0;const e=Math.PI/180;function t(){return typeof window<"u"&&({}.toString.call(window)==="[object Window]"||{}.toString.call(window)==="[object global]")}h.glob=typeof DN<"u"?DN:typeof window<"u"?window:typeof WorkerGlobalScope<"u"?self:{},h.Konva={_global:h.glob,version:"9.3.20",isBrowser:t(),isUnminified:/param/.test((function(i){}).toString()),dblClickWindow:400,getAngle(i){return h.Konva.angleDeg?i*e:i},enableTrace:!1,pointerEventsEnabled:!0,autoDrawEnabled:!0,hitOnDragEnabled:!1,capturePointerEventsEnabled:!1,_mouseListenClick:!1,_touchListenClick:!1,_pointerListenClick:!1,_mouseInDblClickWindow:!1,_touchInDblClickWindow:!1,_pointerInDblClickWindow:!1,_mouseDblClickPointerId:null,_touchDblClickPointerId:null,_pointerDblClickPointerId:null,_fixTextRendering:!1,pixelRatio:typeof window<"u"&&window.devicePixelRatio||1,dragDistance:3,angleDeg:!0,showWarnings:!0,dragButtons:[0,1],isDragging(){return h.Konva.DD.isDragging},isTransforming(){var i;return(i=h.Konva.Transformer)===null||i===void 0?void 0:i.isTransforming()},isDragReady(){return!!h.Konva.DD.node},releaseCanvasOnDestroy:!0,document:h.glob.document,_injectGlobal(i){h.glob.Konva=i}};const s=i=>{h.Konva[i.prototype.getClassName()]=i};h._registerNode=s,h.Konva._injectGlobal(h.Konva)}(xM)),xM}var TM={},GN;function _i(){return GN||(GN=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h.Util=h.Transform=void 0;const e=Rt();class t{constructor(R=[1,0,0,1,0,0]){this.dirty=!1,this.m=R&&R.slice()||[1,0,0,1,0,0]}reset(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=1,this.m[4]=0,this.m[5]=0}copy(){return new t(this.m)}copyInto(R){R.m[0]=this.m[0],R.m[1]=this.m[1],R.m[2]=this.m[2],R.m[3]=this.m[3],R.m[4]=this.m[4],R.m[5]=this.m[5]}point(R){const D=this.m;return{x:D[0]*R.x+D[2]*R.y+D[4],y:D[1]*R.x+D[3]*R.y+D[5]}}translate(R,D){return this.m[4]+=this.m[0]*R+this.m[2]*D,this.m[5]+=this.m[1]*R+this.m[3]*D,this}scale(R,D){return this.m[0]*=R,this.m[1]*=R,this.m[2]*=D,this.m[3]*=D,this}rotate(R){const D=Math.cos(R),I=Math.sin(R),U=this.m[0]*D+this.m[2]*I,O=this.m[1]*D+this.m[3]*I,N=this.m[0]*-I+this.m[2]*D,z=this.m[1]*-I+this.m[3]*D;return this.m[0]=U,this.m[1]=O,this.m[2]=N,this.m[3]=z,this}getTranslation(){return{x:this.m[4],y:this.m[5]}}skew(R,D){const I=this.m[0]+this.m[2]*D,U=this.m[1]+this.m[3]*D,O=this.m[2]+this.m[0]*R,N=this.m[3]+this.m[1]*R;return this.m[0]=I,this.m[1]=U,this.m[2]=O,this.m[3]=N,this}multiply(R){const D=this.m[0]*R.m[0]+this.m[2]*R.m[1],I=this.m[1]*R.m[0]+this.m[3]*R.m[1],U=this.m[0]*R.m[2]+this.m[2]*R.m[3],O=this.m[1]*R.m[2]+this.m[3]*R.m[3],N=this.m[0]*R.m[4]+this.m[2]*R.m[5]+this.m[4],z=this.m[1]*R.m[4]+this.m[3]*R.m[5]+this.m[5];return this.m[0]=D,this.m[1]=I,this.m[2]=U,this.m[3]=O,this.m[4]=N,this.m[5]=z,this}invert(){const R=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),D=this.m[3]*R,I=-this.m[1]*R,U=-this.m[2]*R,O=this.m[0]*R,N=R*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),z=R*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=D,this.m[1]=I,this.m[2]=U,this.m[3]=O,this.m[4]=N,this.m[5]=z,this}getMatrix(){return this.m}decompose(){const R=this.m[0],D=this.m[1],I=this.m[2],U=this.m[3],O=this.m[4],N=this.m[5],z=R*U-D*I,X={x:O,y:N,rotation:0,scaleX:0,scaleY:0,skewX:0,skewY:0};if(R!=0||D!=0){const Y=Math.sqrt(R*R+D*D);X.rotation=D>0?Math.acos(R/Y):-Math.acos(R/Y),X.scaleX=Y,X.scaleY=z/Y,X.skewX=(R*I+D*U)/z,X.skewY=0}else if(I!=0||U!=0){const Y=Math.sqrt(I*I+U*U);X.rotation=Math.PI/2-(U>0?Math.acos(-I/Y):-Math.acos(I/Y)),X.scaleX=z/Y,X.scaleY=Y,X.skewX=0,X.skewY=(R*I+D*U)/z}return X.rotation=h.Util._getRotation(X.rotation),X}}h.Transform=t;const s="[object Array]",i="[object Number]",a="[object String]",n="[object Boolean]",r=Math.PI/180,l=180/Math.PI,u="#",f="",_="0",g="Konva warning: ",y="Konva error: ",v="rgb(",x={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],transparent:[255,255,255,0],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]},C=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;let M=[];const w=typeof requestAnimationFrame<"u"&&requestAnimationFrame||function(T){setTimeout(T,60)};h.Util={_isElement(T){return!!(T&&T.nodeType==1)},_isFunction(T){return!!(T&&T.constructor&&T.call&&T.apply)},_isPlainObject(T){return!!T&&T.constructor===Object},_isArray(T){return Object.prototype.toString.call(T)===s},_isNumber(T){return Object.prototype.toString.call(T)===i&&!isNaN(T)&&isFinite(T)},_isString(T){return Object.prototype.toString.call(T)===a},_isBoolean(T){return Object.prototype.toString.call(T)===n},isObject(T){return T instanceof Object},isValidSelector(T){if(typeof T!="string")return!1;const R=T[0];return R==="#"||R==="."||R===R.toUpperCase()},_sign(T){return T===0||T>0?1:-1},requestAnimFrame(T){M.push(T),M.length===1&&w(function(){const R=M;M=[],R.forEach(function(D){D()})})},createCanvasElement(){const T=document.createElement("canvas");try{T.style=T.style||{}}catch{}return T},createImageElement(){return document.createElement("img")},_isInDocument(T){for(;T=T.parentNode;)if(T==document)return!0;return!1},_urlToImage(T,R){const D=h.Util.createImageElement();D.onload=function(){R(D)},D.src=T},_rgbToHex(T,R,D){return((1<<24)+(T<<16)+(R<<8)+D).toString(16).slice(1)},_hexToRgb(T){T=T.replace(u,f);const R=parseInt(T,16);return{r:R>>16&255,g:R>>8&255,b:R&255}},getRandomColor(){let T=(Math.random()*16777215<<0).toString(16);for(;T.length<6;)T=_+T;return u+T},getRGB(T){let R;return T in x?(R=x[T],{r:R[0],g:R[1],b:R[2]}):T[0]===u?this._hexToRgb(T.substring(1)):T.substr(0,4)===v?(R=C.exec(T.replace(/ /g,"")),{r:parseInt(R[1],10),g:parseInt(R[2],10),b:parseInt(R[3],10)}):{r:0,g:0,b:0}},colorToRGBA(T){return T=T||"black",h.Util._namedColorToRBA(T)||h.Util._hex3ColorToRGBA(T)||h.Util._hex4ColorToRGBA(T)||h.Util._hex6ColorToRGBA(T)||h.Util._hex8ColorToRGBA(T)||h.Util._rgbColorToRGBA(T)||h.Util._rgbaColorToRGBA(T)||h.Util._hslColorToRGBA(T)},_namedColorToRBA(T){const R=x[T.toLowerCase()];return R?{r:R[0],g:R[1],b:R[2],a:1}:null},_rgbColorToRGBA(T){if(T.indexOf("rgb(")===0){T=T.match(/rgb\(([^)]+)\)/)[1];const R=T.split(/ *, */).map(Number);return{r:R[0],g:R[1],b:R[2],a:1}}},_rgbaColorToRGBA(T){if(T.indexOf("rgba(")===0){T=T.match(/rgba\(([^)]+)\)/)[1];const R=T.split(/ *, */).map((D,I)=>D.slice(-1)==="%"?I===3?parseInt(D)/100:parseInt(D)/100*255:Number(D));return{r:R[0],g:R[1],b:R[2],a:R[3]}}},_hex8ColorToRGBA(T){if(T[0]==="#"&&T.length===9)return{r:parseInt(T.slice(1,3),16),g:parseInt(T.slice(3,5),16),b:parseInt(T.slice(5,7),16),a:parseInt(T.slice(7,9),16)/255}},_hex6ColorToRGBA(T){if(T[0]==="#"&&T.length===7)return{r:parseInt(T.slice(1,3),16),g:parseInt(T.slice(3,5),16),b:parseInt(T.slice(5,7),16),a:1}},_hex4ColorToRGBA(T){if(T[0]==="#"&&T.length===5)return{r:parseInt(T[1]+T[1],16),g:parseInt(T[2]+T[2],16),b:parseInt(T[3]+T[3],16),a:parseInt(T[4]+T[4],16)/255}},_hex3ColorToRGBA(T){if(T[0]==="#"&&T.length===4)return{r:parseInt(T[1]+T[1],16),g:parseInt(T[2]+T[2],16),b:parseInt(T[3]+T[3],16),a:1}},_hslColorToRGBA(T){if(/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.test(T)){const[R,...D]=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(T),I=Number(D[0])/360,U=Number(D[1])/100,O=Number(D[2])/100;let N,z,X;if(U===0)return X=O*255,{r:Math.round(X),g:Math.round(X),b:Math.round(X),a:1};O<.5?N=O*(1+U):N=O+U-O*U;const Y=2*O-N,F=[0,0,0];for(let q=0;q<3;q++)z=I+1/3*-(q-1),z<0&&z++,z>1&&z--,6*z<1?X=Y+(N-Y)*6*z:2*z<1?X=N:3*z<2?X=Y+(N-Y)*(2/3-z)*6:X=Y,F[q]=X*255;return{r:Math.round(F[0]),g:Math.round(F[1]),b:Math.round(F[2]),a:1}}},haveIntersection(T,R){return!(R.x>T.x+T.width||R.x+R.width<T.x||R.y>T.y+T.height||R.y+R.height<T.y)},cloneObject(T){const R={};for(const D in T)this._isPlainObject(T[D])?R[D]=this.cloneObject(T[D]):this._isArray(T[D])?R[D]=this.cloneArray(T[D]):R[D]=T[D];return R},cloneArray(T){return T.slice(0)},degToRad(T){return T*r},radToDeg(T){return T*l},_degToRad(T){return h.Util.warn("Util._degToRad is removed. Please use public Util.degToRad instead."),h.Util.degToRad(T)},_radToDeg(T){return h.Util.warn("Util._radToDeg is removed. Please use public Util.radToDeg instead."),h.Util.radToDeg(T)},_getRotation(T){return e.Konva.angleDeg?h.Util.radToDeg(T):T},_capitalize(T){return T.charAt(0).toUpperCase()+T.slice(1)},throw(T){throw new Error(y+T)},error(T){console.error(y+T)},warn(T){e.Konva.showWarnings&&console.warn(g+T)},each(T,R){for(const D in T)R(D,T[D])},_inRange(T,R,D){return R<=T&&T<D},_getProjectionToSegment(T,R,D,I,U,O){let N,z,X;const Y=(T-D)*(T-D)+(R-I)*(R-I);if(Y==0)N=T,z=R,X=(U-D)*(U-D)+(O-I)*(O-I);else{const F=((U-T)*(D-T)+(O-R)*(I-R))/Y;F<0?(N=T,z=R,X=(T-U)*(T-U)+(R-O)*(R-O)):F>1?(N=D,z=I,X=(D-U)*(D-U)+(I-O)*(I-O)):(N=T+F*(D-T),z=R+F*(I-R),X=(N-U)*(N-U)+(z-O)*(z-O))}return[N,z,X]},_getProjectionToLine(T,R,D){const I=h.Util.cloneObject(T);let U=Number.MAX_VALUE;return R.forEach(function(O,N){if(!D&&N===R.length-1)return;const z=R[(N+1)%R.length],X=h.Util._getProjectionToSegment(O.x,O.y,z.x,z.y,T.x,T.y),Y=X[0],F=X[1],q=X[2];q<U&&(I.x=Y,I.y=F,U=q)}),I},_prepareArrayForTween(T,R,D){const I=[],U=[];if(T.length>R.length){const N=R;R=T,T=N}for(let N=0;N<T.length;N+=2)I.push({x:T[N],y:T[N+1]});for(let N=0;N<R.length;N+=2)U.push({x:R[N],y:R[N+1]});const O=[];return U.forEach(function(N){const z=h.Util._getProjectionToLine(N,I,D);O.push(z.x),O.push(z.y)}),O},_prepareToStringify(T){let R;T.visitedByCircularReferenceRemoval=!0;for(const D in T)if(T.hasOwnProperty(D)&&T[D]&&typeof T[D]=="object"){if(R=Object.getOwnPropertyDescriptor(T,D),T[D].visitedByCircularReferenceRemoval||h.Util._isElement(T[D]))if(R.configurable)delete T[D];else return null;else if(h.Util._prepareToStringify(T[D])===null)if(R.configurable)delete T[D];else return null}return delete T.visitedByCircularReferenceRemoval,T},_assign(T,R){for(const D in R)T[D]=R[D];return T},_getFirstPointerId(T){return T.touches?T.changedTouches[0].identifier:T.pointerId||999},releaseCanvas(...T){e.Konva.releaseCanvasOnDestroy&&T.forEach(R=>{R.width=0,R.height=0})},drawRoundedRectPath(T,R,D,I){let U=0,O=0,N=0,z=0;typeof I=="number"?U=O=N=z=Math.min(I,R/2,D/2):(U=Math.min(I[0]||0,R/2,D/2),O=Math.min(I[1]||0,R/2,D/2),z=Math.min(I[2]||0,R/2,D/2),N=Math.min(I[3]||0,R/2,D/2)),T.moveTo(U,0),T.lineTo(R-O,0),T.arc(R-O,O,O,Math.PI*3/2,0,!1),T.lineTo(R,D-z),T.arc(R-z,D-z,z,0,Math.PI/2,!1),T.lineTo(N,D),T.arc(N,D-N,N,Math.PI/2,Math.PI,!1),T.lineTo(0,U),T.arc(U,U,U,Math.PI,Math.PI*3/2,!1)}}}(TM)),TM}var pS={},EM={},Pn={},HN;function Gt(){if(HN)return Pn;HN=1,Object.defineProperty(Pn,"__esModule",{value:!0}),Pn.RGBComponent=s,Pn.alphaComponent=i,Pn.getNumberValidator=a,Pn.getNumberOrArrayOfNumbersValidator=n,Pn.getNumberOrAutoValidator=r,Pn.getStringValidator=l,Pn.getStringOrGradientValidator=u,Pn.getFunctionValidator=f,Pn.getNumberArrayValidator=_,Pn.getBooleanValidator=g,Pn.getComponentValidator=y;const h=Rt(),e=_i();function t(v){return e.Util._isString(v)?'"'+v+'"':Object.prototype.toString.call(v)==="[object Number]"||e.Util._isBoolean(v)?v:Object.prototype.toString.call(v)}function s(v){return v>255?255:v<0?0:Math.round(v)}function i(v){return v>1?1:v<1e-4?1e-4:v}function a(){if(h.Konva.isUnminified)return function(v,x){return e.Util._isNumber(v)||e.Util.warn(t(v)+' is a not valid value for "'+x+'" attribute. The value should be a number.'),v}}function n(v){if(h.Konva.isUnminified)return function(x,C){let M=e.Util._isNumber(x),w=e.Util._isArray(x)&&x.length==v;return!M&&!w&&e.Util.warn(t(x)+' is a not valid value for "'+C+'" attribute. The value should be a number or Array<number>('+v+")"),x}}function r(){if(h.Konva.isUnminified)return function(v,x){var C=e.Util._isNumber(v),M=v==="auto";return C||M||e.Util.warn(t(v)+' is a not valid value for "'+x+'" attribute. The value should be a number or "auto".'),v}}function l(){if(h.Konva.isUnminified)return function(v,x){return e.Util._isString(v)||e.Util.warn(t(v)+' is a not valid value for "'+x+'" attribute. The value should be a string.'),v}}function u(){if(h.Konva.isUnminified)return function(v,x){const C=e.Util._isString(v),M=Object.prototype.toString.call(v)==="[object CanvasGradient]"||v&&v.addColorStop;return C||M||e.Util.warn(t(v)+' is a not valid value for "'+x+'" attribute. The value should be a string or a native gradient.'),v}}function f(){if(h.Konva.isUnminified)return function(v,x){return e.Util._isFunction(v)||e.Util.warn(t(v)+' is a not valid value for "'+x+'" attribute. The value should be a function.'),v}}function _(){if(h.Konva.isUnminified)return function(v,x){const C=Int8Array?Object.getPrototypeOf(Int8Array):null;return C&&v instanceof C||(e.Util._isArray(v)?v.forEach(function(M){e.Util._isNumber(M)||e.Util.warn('"'+x+'" attribute has non numeric element '+M+". Make sure that all elements are numbers.")}):e.Util.warn(t(v)+' is a not valid value for "'+x+'" attribute. The value should be a array of numbers.')),v}}function g(){if(h.Konva.isUnminified)return function(v,x){var C=v===!0||v===!1;return C||e.Util.warn(t(v)+' is a not valid value for "'+x+'" attribute. The value should be a boolean.'),v}}function y(v){if(h.Konva.isUnminified)return function(x,C){return x==null||e.Util.isObject(x)||e.Util.warn(t(x)+' is a not valid value for "'+C+'" attribute. The value should be an object with properties '+v),x}}return Pn}var WN;function Ut(){return WN||(WN=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h.Factory=void 0;const e=_i(),t=Gt(),s="get",i="set";h.Factory={addGetterSetter(a,n,r,l,u){h.Factory.addGetter(a,n,r),h.Factory.addSetter(a,n,l,u),h.Factory.addOverloadedGetterSetter(a,n)},addGetter(a,n,r){var l=s+e.Util._capitalize(n);a.prototype[l]=a.prototype[l]||function(){const u=this.attrs[n];return u===void 0?r:u}},addSetter(a,n,r,l){var u=i+e.Util._capitalize(n);a.prototype[u]||h.Factory.overWriteSetter(a,n,r,l)},overWriteSetter(a,n,r,l){var u=i+e.Util._capitalize(n);a.prototype[u]=function(f){return r&&f!==void 0&&f!==null&&(f=r.call(this,f,n)),this._setAttr(n,f),l&&l.call(this),this}},addComponentsGetterSetter(a,n,r,l,u){const f=r.length,_=e.Util._capitalize,g=s+_(n),y=i+_(n);a.prototype[g]=function(){const x={};for(let C=0;C<f;C++){const M=r[C];x[M]=this.getAttr(n+_(M))}return x};const v=(0,t.getComponentValidator)(r);a.prototype[y]=function(x){const C=this.attrs[n];l&&(x=l.call(this,x,n)),v&&v.call(this,x,n);for(const M in x)x.hasOwnProperty(M)&&this._setAttr(n+_(M),x[M]);return x||r.forEach(M=>{this._setAttr(n+_(M),void 0)}),this._fireChangeEvent(n,C,x),u&&u.call(this),this},h.Factory.addOverloadedGetterSetter(a,n)},addOverloadedGetterSetter(a,n){var r=e.Util._capitalize(n),l=i+r,u=s+r;a.prototype[n]=function(){return arguments.length?(this[l](arguments[0]),this):this[u]()}},addDeprecatedGetterSetter(a,n,r,l){e.Util.error("Adding deprecated "+n);const u=s+e.Util._capitalize(n),f=n+" property is deprecated and will be removed soon. Look at Konva change log for more information.";a.prototype[u]=function(){e.Util.error(f);const _=this.attrs[n];return _===void 0?r:_},h.Factory.addSetter(a,n,l,function(){e.Util.error(f)}),h.Factory.addOverloadedGetterSetter(a,n)},backCompat(a,n){e.Util.each(n,function(r,l){const u=a.prototype[l],f=s+e.Util._capitalize(r),_=i+e.Util._capitalize(r);function g(){u.apply(this,arguments),e.Util.error('"'+r+'" method is deprecated and will be removed soon. Use ""'+l+'" instead.')}a.prototype[r]=g,a.prototype[f]=g,a.prototype[_]=g})},afterSetFilter(){this._filterUpToDate=!1}}}(EM)),EM}var Cc={},wc={},qN;function Q6(){if(qN)return wc;qN=1,Object.defineProperty(wc,"__esModule",{value:!0}),wc.HitContext=wc.SceneContext=wc.Context=void 0;const h=_i(),e=Rt();function t(M){const w=[],T=M.length,R=h.Util;for(let D=0;D<T;D++){let I=M[D];R._isNumber(I)?I=Math.round(I*1e3)/1e3:R._isString(I)||(I=I+""),w.push(I)}return w}const s=",",i="(",a=")",n="([",r="])",l=";",u="()",f="=",_=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createLinearGradient","createPattern","createRadialGradient","drawImage","ellipse","fill","fillText","getImageData","createImageData","lineTo","moveTo","putImageData","quadraticCurveTo","rect","roundRect","restore","rotate","save","scale","setLineDash","setTransform","stroke","strokeText","transform","translate"],g=["fillStyle","strokeStyle","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","letterSpacing","lineCap","lineDashOffset","lineJoin","lineWidth","miterLimit","direction","font","textAlign","textBaseline","globalAlpha","globalCompositeOperation","imageSmoothingEnabled"],y=100;let v=class{constructor(w){this.canvas=w,e.Konva.enableTrace&&(this.traceArr=[],this._enableTrace())}fillShape(w){w.fillEnabled()&&this._fill(w)}_fill(w){}strokeShape(w){w.hasStroke()&&this._stroke(w)}_stroke(w){}fillStrokeShape(w){w.attrs.fillAfterStrokeEnabled?(this.strokeShape(w),this.fillShape(w)):(this.fillShape(w),this.strokeShape(w))}getTrace(w,T){let R=this.traceArr,D=R.length,I="",U,O,N,z;for(U=0;U<D;U++)O=R[U],N=O.method,N?(z=O.args,I+=N,w?I+=u:h.Util._isArray(z[0])?I+=n+z.join(s)+r:(T&&(z=z.map(X=>typeof X=="number"?Math.floor(X):X)),I+=i+z.join(s)+a)):(I+=O.property,w||(I+=f+O.val)),I+=l;return I}clearTrace(){this.traceArr=[]}_trace(w){let T=this.traceArr,R;T.push(w),R=T.length,R>=y&&T.shift()}reset(){const w=this.getCanvas().getPixelRatio();this.setTransform(1*w,0,0,1*w,0,0)}getCanvas(){return this.canvas}clear(w){const T=this.getCanvas();w?this.clearRect(w.x||0,w.y||0,w.width||0,w.height||0):this.clearRect(0,0,T.getWidth()/T.pixelRatio,T.getHeight()/T.pixelRatio)}_applyLineCap(w){const T=w.attrs.lineCap;T&&this.setAttr("lineCap",T)}_applyOpacity(w){const T=w.getAbsoluteOpacity();T!==1&&this.setAttr("globalAlpha",T)}_applyLineJoin(w){const T=w.attrs.lineJoin;T&&this.setAttr("lineJoin",T)}setAttr(w,T){this._context[w]=T}arc(w,T,R,D,I,U){this._context.arc(w,T,R,D,I,U)}arcTo(w,T,R,D,I){this._context.arcTo(w,T,R,D,I)}beginPath(){this._context.beginPath()}bezierCurveTo(w,T,R,D,I,U){this._context.bezierCurveTo(w,T,R,D,I,U)}clearRect(w,T,R,D){this._context.clearRect(w,T,R,D)}clip(...w){this._context.clip.apply(this._context,w)}closePath(){this._context.closePath()}createImageData(w,T){const R=arguments;if(R.length===2)return this._context.createImageData(w,T);if(R.length===1)return this._context.createImageData(w)}createLinearGradient(w,T,R,D){return this._context.createLinearGradient(w,T,R,D)}createPattern(w,T){return this._context.createPattern(w,T)}createRadialGradient(w,T,R,D,I,U){return this._context.createRadialGradient(w,T,R,D,I,U)}drawImage(w,T,R,D,I,U,O,N,z){const X=arguments,Y=this._context;X.length===3?Y.drawImage(w,T,R):X.length===5?Y.drawImage(w,T,R,D,I):X.length===9&&Y.drawImage(w,T,R,D,I,U,O,N,z)}ellipse(w,T,R,D,I,U,O,N){this._context.ellipse(w,T,R,D,I,U,O,N)}isPointInPath(w,T,R,D){return R?this._context.isPointInPath(R,w,T,D):this._context.isPointInPath(w,T,D)}fill(...w){this._context.fill.apply(this._context,w)}fillRect(w,T,R,D){this._context.fillRect(w,T,R,D)}strokeRect(w,T,R,D){this._context.strokeRect(w,T,R,D)}fillText(w,T,R,D){D?this._context.fillText(w,T,R,D):this._context.fillText(w,T,R)}measureText(w){return this._context.measureText(w)}getImageData(w,T,R,D){return this._context.getImageData(w,T,R,D)}lineTo(w,T){this._context.lineTo(w,T)}moveTo(w,T){this._context.moveTo(w,T)}rect(w,T,R,D){this._context.rect(w,T,R,D)}roundRect(w,T,R,D,I){this._context.roundRect(w,T,R,D,I)}putImageData(w,T,R){this._context.putImageData(w,T,R)}quadraticCurveTo(w,T,R,D){this._context.quadraticCurveTo(w,T,R,D)}restore(){this._context.restore()}rotate(w){this._context.rotate(w)}save(){this._context.save()}scale(w,T){this._context.scale(w,T)}setLineDash(w){this._context.setLineDash?this._context.setLineDash(w):"mozDash"in this._context?this._context.mozDash=w:"webkitLineDash"in this._context&&(this._context.webkitLineDash=w)}getLineDash(){return this._context.getLineDash()}setTransform(w,T,R,D,I,U){this._context.setTransform(w,T,R,D,I,U)}stroke(w){w?this._context.stroke(w):this._context.stroke()}strokeText(w,T,R,D){this._context.strokeText(w,T,R,D)}transform(w,T,R,D,I,U){this._context.transform(w,T,R,D,I,U)}translate(w,T){this._context.translate(w,T)}_enableTrace(){let w=this,T=_.length,R=this.setAttr,D,I;const U=function(O){let N=w[O],z;w[O]=function(){return I=t(Array.prototype.slice.call(arguments,0)),z=N.apply(w,arguments),w._trace({method:O,args:I}),z}};for(D=0;D<T;D++)U(_[D]);w.setAttr=function(){R.apply(w,arguments);const O=arguments[0];let N=arguments[1];(O==="shadowOffsetX"||O==="shadowOffsetY"||O==="shadowBlur")&&(N=N/this.canvas.getPixelRatio()),w._trace({property:O,val:N})}}_applyGlobalCompositeOperation(w){const T=w.attrs.globalCompositeOperation;!T||T==="source-over"||this.setAttr("globalCompositeOperation",T)}};wc.Context=v,g.forEach(function(M){Object.defineProperty(v.prototype,M,{get(){return this._context[M]},set(w){this._context[M]=w}})});class x extends v{constructor(w,{willReadFrequently:T=!1}={}){super(w),this._context=w._canvas.getContext("2d",{willReadFrequently:T})}_fillColor(w){const T=w.fill();this.setAttr("fillStyle",T),w._fillFunc(this)}_fillPattern(w){this.setAttr("fillStyle",w._getFillPattern()),w._fillFunc(this)}_fillLinearGradient(w){const T=w._getLinearGradient();T&&(this.setAttr("fillStyle",T),w._fillFunc(this))}_fillRadialGradient(w){const T=w._getRadialGradient();T&&(this.setAttr("fillStyle",T),w._fillFunc(this))}_fill(w){const T=w.fill(),R=w.getFillPriority();if(T&&R==="color"){this._fillColor(w);return}const D=w.getFillPatternImage();if(D&&R==="pattern"){this._fillPattern(w);return}const I=w.getFillLinearGradientColorStops();if(I&&R==="linear-gradient"){this._fillLinearGradient(w);return}const U=w.getFillRadialGradientColorStops();if(U&&R==="radial-gradient"){this._fillRadialGradient(w);return}T?this._fillColor(w):D?this._fillPattern(w):I?this._fillLinearGradient(w):U&&this._fillRadialGradient(w)}_strokeLinearGradient(w){const T=w.getStrokeLinearGradientStartPoint(),R=w.getStrokeLinearGradientEndPoint(),D=w.getStrokeLinearGradientColorStops(),I=this.createLinearGradient(T.x,T.y,R.x,R.y);if(D){for(let U=0;U<D.length;U+=2)I.addColorStop(D[U],D[U+1]);this.setAttr("strokeStyle",I)}}_stroke(w){const T=w.dash(),R=w.getStrokeScaleEnabled();if(w.hasStroke()){if(!R){this.save();const I=this.getCanvas().getPixelRatio();this.setTransform(I,0,0,I,0,0)}this._applyLineCap(w),T&&w.dashEnabled()&&(this.setLineDash(T),this.setAttr("lineDashOffset",w.dashOffset())),this.setAttr("lineWidth",w.strokeWidth()),w.getShadowForStrokeEnabled()||this.setAttr("shadowColor","rgba(0,0,0,0)"),w.getStrokeLinearGradientColorStops()?this._strokeLinearGradient(w):this.setAttr("strokeStyle",w.stroke()),w._strokeFunc(this),R||this.restore()}}_applyShadow(w){var T,R,D;const I=(T=w.getShadowRGBA())!==null&&T!==void 0?T:"black",U=(R=w.getShadowBlur())!==null&&R!==void 0?R:5,O=(D=w.getShadowOffset())!==null&&D!==void 0?D:{x:0,y:0},N=w.getAbsoluteScale(),z=this.canvas.getPixelRatio(),X=N.x*z,Y=N.y*z;this.setAttr("shadowColor",I),this.setAttr("shadowBlur",U*Math.min(Math.abs(X),Math.abs(Y))),this.setAttr("shadowOffsetX",O.x*X),this.setAttr("shadowOffsetY",O.y*Y)}}wc.SceneContext=x;class C extends v{constructor(w){super(w),this._context=w._canvas.getContext("2d",{willReadFrequently:!0})}_fill(w){this.save(),this.setAttr("fillStyle",w.colorKey),w._fillFuncHit(this),this.restore()}strokeShape(w){w.hasHitStroke()&&this._stroke(w)}_stroke(w){if(w.hasHitStroke()){const T=w.getStrokeScaleEnabled();if(!T){this.save();const I=this.getCanvas().getPixelRatio();this.setTransform(I,0,0,I,0,0)}this._applyLineCap(w);const R=w.hitStrokeWidth(),D=R==="auto"?w.strokeWidth():R;this.setAttr("lineWidth",D),this.setAttr("strokeStyle",w.colorKey),w._strokeFuncHit(this),T||this.restore()}}}return wc.HitContext=C,wc}var XN;function tw(){if(XN)return Cc;XN=1,Object.defineProperty(Cc,"__esModule",{value:!0}),Cc.HitCanvas=Cc.SceneCanvas=Cc.Canvas=void 0;const h=_i(),e=Q6(),t=Rt();let s;function i(){if(s)return s;const l=h.Util.createCanvasElement(),u=l.getContext("2d");return s=function(){const f=t.Konva._global.devicePixelRatio||1,_=u.webkitBackingStorePixelRatio||u.mozBackingStorePixelRatio||u.msBackingStorePixelRatio||u.oBackingStorePixelRatio||u.backingStorePixelRatio||1;return f/_}(),h.Util.releaseCanvas(l),s}let a=class{constructor(u){this.pixelRatio=1,this.width=0,this.height=0,this.isCache=!1;const _=(u||{}).pixelRatio||t.Konva.pixelRatio||i();this.pixelRatio=_,this._canvas=h.Util.createCanvasElement(),this._canvas.style.padding="0",this._canvas.style.margin="0",this._canvas.style.border="0",this._canvas.style.background="transparent",this._canvas.style.position="absolute",this._canvas.style.top="0",this._canvas.style.left="0"}getContext(){return this.context}getPixelRatio(){return this.pixelRatio}setPixelRatio(u){const f=this.pixelRatio;this.pixelRatio=u,this.setSize(this.getWidth()/f,this.getHeight()/f)}setWidth(u){this.width=this._canvas.width=u*this.pixelRatio,this._canvas.style.width=u+"px";const f=this.pixelRatio;this.getContext()._context.scale(f,f)}setHeight(u){this.height=this._canvas.height=u*this.pixelRatio,this._canvas.style.height=u+"px";const f=this.pixelRatio;this.getContext()._context.scale(f,f)}getWidth(){return this.width}getHeight(){return this.height}setSize(u,f){this.setWidth(u||0),this.setHeight(f||0)}toDataURL(u,f){try{return this._canvas.toDataURL(u,f)}catch{try{return this._canvas.toDataURL()}catch(g){return h.Util.error("Unable to get data URL. "+g.message+" For more info read https://konvajs.org/docs/posts/Tainted_Canvas.html."),""}}}};Cc.Canvas=a;class n extends a{constructor(u={width:0,height:0,willReadFrequently:!1}){super(u),this.context=new e.SceneContext(this,{willReadFrequently:u.willReadFrequently}),this.setSize(u.width,u.height)}}Cc.SceneCanvas=n;class r extends a{constructor(u={width:0,height:0}){super(u),this.hitCanvas=!0,this.context=new e.HitContext(this),this.setSize(u.width,u.height)}}return Cc.HitCanvas=r,Cc}var AM={},jN;function EL(){return jN||(jN=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h.DD=void 0;const e=Rt(),t=_i();h.DD={get isDragging(){let s=!1;return h.DD._dragElements.forEach(i=>{i.dragStatus==="dragging"&&(s=!0)}),s},justDragged:!1,get node(){let s;return h.DD._dragElements.forEach(i=>{s=i.node}),s},_dragElements:new Map,_drag(s){const i=[];h.DD._dragElements.forEach((a,n)=>{const{node:r}=a,l=r.getStage();l.setPointersPositions(s),a.pointerId===void 0&&(a.pointerId=t.Util._getFirstPointerId(s));const u=l._changedPointerPositions.find(f=>f.id===a.pointerId);if(u){if(a.dragStatus!=="dragging"){const f=r.dragDistance();if(Math.max(Math.abs(u.x-a.startPointerPos.x),Math.abs(u.y-a.startPointerPos.y))<f||(r.startDrag({evt:s}),!r.isDragging()))return}r._setDragPosition(s,a),i.push(r)}}),i.forEach(a=>{a.fire("dragmove",{type:"dragmove",target:a,evt:s},!0)})},_endDragBefore(s){const i=[];h.DD._dragElements.forEach(a=>{const{node:n}=a,r=n.getStage();if(s&&r.setPointersPositions(s),!r._changedPointerPositions.find(f=>f.id===a.pointerId))return;(a.dragStatus==="dragging"||a.dragStatus==="stopped")&&(h.DD.justDragged=!0,e.Konva._mouseListenClick=!1,e.Konva._touchListenClick=!1,e.Konva._pointerListenClick=!1,a.dragStatus="stopped");const u=a.node.getLayer()||a.node instanceof e.Konva.Stage&&a.node;u&&i.indexOf(u)===-1&&i.push(u)}),i.forEach(a=>{a.draw()})},_endDragAfter(s){h.DD._dragElements.forEach((i,a)=>{i.dragStatus==="stopped"&&i.node.fire("dragend",{type:"dragend",target:i.node,evt:s},!0),i.dragStatus!=="dragging"&&h.DD._dragElements.delete(a)})}},e.Konva.isBrowser&&(window.addEventListener("mouseup",h.DD._endDragBefore,!0),window.addEventListener("touchend",h.DD._endDragBefore,!0),window.addEventListener("touchcancel",h.DD._endDragBefore,!0),window.addEventListener("mousemove",h.DD._drag),window.addEventListener("touchmove",h.DD._drag),window.addEventListener("mouseup",h.DD._endDragAfter,!1),window.addEventListener("touchend",h.DD._endDragAfter,!1),window.addEventListener("touchcancel",h.DD._endDragAfter,!1))}(AM)),AM}var YN;function Mi(){if(YN)return pS;YN=1,Object.defineProperty(pS,"__esModule",{value:!0}),pS.Node=void 0;const h=_i(),e=Ut(),t=tw(),s=Rt(),i=EL(),a=Gt(),n="absoluteOpacity",r="allEventListeners",l="absoluteTransform",u="absoluteScale",f="canvas",_="Change",g="children",y="konva",v="listening",x="mouseenter",C="mouseleave",M="set",w="Shape",T=" ",R="stage",D="transform",I="Stage",U="visible",O=["xChange.konva","yChange.konva","scaleXChange.konva","scaleYChange.konva","skewXChange.konva","skewYChange.konva","rotationChange.konva","offsetXChange.konva","offsetYChange.konva","transformsEnabledChange.konva"].join(T);let N=1,z=class mD{constructor(F){this._id=N++,this.eventListeners={},this.attrs={},this.index=0,this._allEventListeners=null,this.parent=null,this._cache=new Map,this._attachedDepsListeners=new Map,this._lastPos=null,this._batchingTransformChange=!1,this._needClearTransformCache=!1,this._filterUpToDate=!1,this._isUnderCache=!1,this._dragEventId=null,this._shouldFireChangeEvents=!1,this.setAttrs(F),this._shouldFireChangeEvents=!0}hasChildren(){return!1}_clearCache(F){(F===D||F===l)&&this._cache.get(F)?this._cache.get(F).dirty=!0:F?this._cache.delete(F):this._cache.clear()}_getCache(F,q){let G=this._cache.get(F);return(G===void 0||(F===D||F===l)&&G.dirty===!0)&&(G=q.call(this),this._cache.set(F,G)),G}_calculate(F,q,G){if(!this._attachedDepsListeners.get(F)){const W=q.map(k=>k+"Change.konva").join(T);this.on(W,()=>{this._clearCache(F)}),this._attachedDepsListeners.set(F,!0)}return this._getCache(F,G)}_getCanvasCache(){return this._cache.get(f)}_clearSelfAndDescendantCache(F){this._clearCache(F),F===l&&this.fire("absoluteTransformChange")}clearCache(){if(this._cache.has(f)){const{scene:F,filter:q,hit:G}=this._cache.get(f);h.Util.releaseCanvas(F,q,G),this._cache.delete(f)}return this._clearSelfAndDescendantCache(),this._requestDraw(),this}cache(F){const q=F||{};let G={};(q.x===void 0||q.y===void 0||q.width===void 0||q.height===void 0)&&(G=this.getClientRect({skipTransform:!0,relativeTo:this.getParent()||void 0}));let W=Math.ceil(q.width||G.width),k=Math.ceil(q.height||G.height),K=q.pixelRatio,ee=q.x===void 0?Math.floor(G.x):q.x,V=q.y===void 0?Math.floor(G.y):q.y,Q=q.offset||0,se=q.drawBorder||!1,J=q.hitCanvasPixelRatio||1;if(!W||!k){h.Util.error("Can not cache the node. Width or height of the node equals 0. Caching is skipped.");return}const ie=Math.abs(Math.round(G.x)-ee)>.5?1:0,oe=Math.abs(Math.round(G.y)-V)>.5?1:0;W+=Q*2+ie,k+=Q*2+oe,ee-=Q,V-=Q;const he=new t.SceneCanvas({pixelRatio:K,width:W,height:k}),te=new t.SceneCanvas({pixelRatio:K,width:0,height:0,willReadFrequently:!0}),le=new t.HitCanvas({pixelRatio:J,width:W,height:k}),Se=he.getContext(),Ae=le.getContext();return le.isCache=!0,he.isCache=!0,this._cache.delete(f),this._filterUpToDate=!1,q.imageSmoothingEnabled===!1&&(he.getContext()._context.imageSmoothingEnabled=!1,te.getContext()._context.imageSmoothingEnabled=!1),Se.save(),Ae.save(),Se.translate(-ee,-V),Ae.translate(-ee,-V),this._isUnderCache=!0,this._clearSelfAndDescendantCache(n),this._clearSelfAndDescendantCache(u),this.drawScene(he,this),this.drawHit(le,this),this._isUnderCache=!1,Se.restore(),Ae.restore(),se&&(Se.save(),Se.beginPath(),Se.rect(0,0,W,k),Se.closePath(),Se.setAttr("strokeStyle","red"),Se.setAttr("lineWidth",5),Se.stroke(),Se.restore()),this._cache.set(f,{scene:he,filter:te,hit:le,x:ee,y:V}),this._requestDraw(),this}isCached(){return this._cache.has(f)}getClientRect(F){throw new Error('abstract "getClientRect" method call')}_transformedRect(F,q){const G=[{x:F.x,y:F.y},{x:F.x+F.width,y:F.y},{x:F.x+F.width,y:F.y+F.height},{x:F.x,y:F.y+F.height}];let W=1/0,k=1/0,K=-1/0,ee=-1/0;const V=this.getAbsoluteTransform(q);return G.forEach(function(Q){const se=V.point(Q);W===void 0&&(W=K=se.x,k=ee=se.y),W=Math.min(W,se.x),k=Math.min(k,se.y),K=Math.max(K,se.x),ee=Math.max(ee,se.y)}),{x:W,y:k,width:K-W,height:ee-k}}_drawCachedSceneCanvas(F){F.save(),F._applyOpacity(this),F._applyGlobalCompositeOperation(this);const q=this._getCanvasCache();F.translate(q.x,q.y);const G=this._getCachedSceneCanvas(),W=G.pixelRatio;F.drawImage(G._canvas,0,0,G.width/W,G.height/W),F.restore()}_drawCachedHitCanvas(F){const q=this._getCanvasCache(),G=q.hit;F.save(),F.translate(q.x,q.y),F.drawImage(G._canvas,0,0,G.width/G.pixelRatio,G.height/G.pixelRatio),F.restore()}_getCachedSceneCanvas(){let F=this.filters(),q=this._getCanvasCache(),G=q.scene,W=q.filter,k=W.getContext(),K,ee,V,Q;if(F){if(!this._filterUpToDate){const se=G.pixelRatio;W.setSize(G.width/G.pixelRatio,G.height/G.pixelRatio);try{for(K=F.length,k.clear(),k.drawImage(G._canvas,0,0,G.getWidth()/se,G.getHeight()/se),ee=k.getImageData(0,0,W.getWidth(),W.getHeight()),V=0;V<K;V++){if(Q=F[V],typeof Q!="function"){h.Util.error("Filter should be type of function, but got "+typeof Q+" instead. Please check correct filters");continue}Q.call(this,ee),k.putImageData(ee,0,0)}}catch(J){h.Util.error("Unable to apply filter. "+J.message+" This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.")}this._filterUpToDate=!0}return W}return G}on(F,q){if(this._cache&&this._cache.delete(r),arguments.length===3)return this._delegate.apply(this,arguments);let G=F.split(T),W=G.length,k,K,ee,V,Q;for(k=0;k<W;k++)K=G[k],ee=K.split("."),V=ee[0],Q=ee[1]||"",this.eventListeners[V]||(this.eventListeners[V]=[]),this.eventListeners[V].push({name:Q,handler:q});return this}off(F,q){let G=(F||"").split(T),W=G.length,k,K,ee,V,Q,se;if(this._cache&&this._cache.delete(r),!F)for(K in this.eventListeners)this._off(K);for(k=0;k<W;k++)if(ee=G[k],V=ee.split("."),Q=V[0],se=V[1],Q)this.eventListeners[Q]&&this._off(Q,se,q);else for(K in this.eventListeners)this._off(K,se,q);return this}dispatchEvent(F){const q={target:this,type:F.type,evt:F};return this.fire(F.type,q),this}addEventListener(F,q){return this.on(F,function(G){q.call(this,G.evt)}),this}removeEventListener(F){return this.off(F),this}_delegate(F,q,G){const W=this;this.on(F,function(k){const K=k.target.findAncestors(q,!0,W);for(let ee=0;ee<K.length;ee++)k=h.Util.cloneObject(k),k.currentTarget=K[ee],G.call(K[ee],k)})}remove(){return this.isDragging()&&this.stopDrag(),i.DD._dragElements.delete(this._id),this._remove(),this}_clearCaches(){this._clearSelfAndDescendantCache(l),this._clearSelfAndDescendantCache(n),this._clearSelfAndDescendantCache(u),this._clearSelfAndDescendantCache(R),this._clearSelfAndDescendantCache(U),this._clearSelfAndDescendantCache(v)}_remove(){this._clearCaches();const F=this.getParent();F&&F.children&&(F.children.splice(this.index,1),F._setChildrenIndices(),this.parent=null)}destroy(){return this.remove(),this.clearCache(),this}getAttr(F){const q="get"+h.Util._capitalize(F);return h.Util._isFunction(this[q])?this[q]():this.attrs[F]}getAncestors(){let F=this.getParent(),q=[];for(;F;)q.push(F),F=F.getParent();return q}getAttrs(){return this.attrs||{}}setAttrs(F){return this._batchTransformChanges(()=>{let q,G;if(!F)return this;for(q in F)q!==g&&(G=M+h.Util._capitalize(q),h.Util._isFunction(this[G])?this[G](F[q]):this._setAttr(q,F[q]))}),this}isListening(){return this._getCache(v,this._isListening)}_isListening(F){if(!this.listening())return!1;const G=this.getParent();return G&&G!==F&&this!==F?G._isListening(F):!0}isVisible(){return this._getCache(U,this._isVisible)}_isVisible(F){if(!this.visible())return!1;const G=this.getParent();return G&&G!==F&&this!==F?G._isVisible(F):!0}shouldDrawHit(F,q=!1){if(F)return this._isVisible(F)&&this._isListening(F);const G=this.getLayer();let W=!1;i.DD._dragElements.forEach(K=>{K.dragStatus==="dragging"&&(K.node.nodeType==="Stage"||K.node.getLayer()===G)&&(W=!0)});const k=!q&&!s.Konva.hitOnDragEnabled&&(W||s.Konva.isTransforming());return this.isListening()&&this.isVisible()&&!k}show(){return this.visible(!0),this}hide(){return this.visible(!1),this}getZIndex(){return this.index||0}getAbsoluteZIndex(){let F=this.getDepth(),q=this,G=0,W,k,K,ee;function V(se){for(W=[],k=se.length,K=0;K<k;K++)ee=se[K],G++,ee.nodeType!==w&&(W=W.concat(ee.getChildren().slice())),ee._id===q._id&&(K=k);W.length>0&&W[0].getDepth()<=F&&V(W)}const Q=this.getStage();return q.nodeType!==I&&Q&&V(Q.getChildren()),G}getDepth(){let F=0,q=this.parent;for(;q;)F++,q=q.parent;return F}_batchTransformChanges(F){this._batchingTransformChange=!0,F(),this._batchingTransformChange=!1,this._needClearTransformCache&&(this._clearCache(D),this._clearSelfAndDescendantCache(l)),this._needClearTransformCache=!1}setPosition(F){return this._batchTransformChanges(()=>{this.x(F.x),this.y(F.y)}),this}getPosition(){return{x:this.x(),y:this.y()}}getRelativePointerPosition(){const F=this.getStage();if(!F)return null;const q=F.getPointerPosition();if(!q)return null;const G=this.getAbsoluteTransform().copy();return G.invert(),G.point(q)}getAbsolutePosition(F){let q=!1,G=this.parent;for(;G;){if(G.isCached()){q=!0;break}G=G.parent}q&&!F&&(F=!0);const W=this.getAbsoluteTransform(F).getMatrix(),k=new h.Transform,K=this.offset();return k.m=W.slice(),k.translate(K.x,K.y),k.getTranslation()}setAbsolutePosition(F){const{x:q,y:G,...W}=this._clearTransform();this.attrs.x=q,this.attrs.y=G,this._clearCache(D);const k=this._getAbsoluteTransform().copy();return k.invert(),k.translate(F.x,F.y),F={x:this.attrs.x+k.getTranslation().x,y:this.attrs.y+k.getTranslation().y},this._setTransform(W),this.setPosition({x:F.x,y:F.y}),this._clearCache(D),this._clearSelfAndDescendantCache(l),this}_setTransform(F){let q;for(q in F)this.attrs[q]=F[q]}_clearTransform(){const F={x:this.x(),y:this.y(),rotation:this.rotation(),scaleX:this.scaleX(),scaleY:this.scaleY(),offsetX:this.offsetX(),offsetY:this.offsetY(),skewX:this.skewX(),skewY:this.skewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,F}move(F){let q=F.x,G=F.y,W=this.x(),k=this.y();return q!==void 0&&(W+=q),G!==void 0&&(k+=G),this.setPosition({x:W,y:k}),this}_eachAncestorReverse(F,q){let G=[],W=this.getParent(),k,K;if(!(q&&q._id===this._id)){for(G.unshift(this);W&&(!q||W._id!==q._id);)G.unshift(W),W=W.parent;for(k=G.length,K=0;K<k;K++)F(G[K])}}rotate(F){return this.rotation(this.rotation()+F),this}moveToTop(){if(!this.parent)return h.Util.warn("Node has no parent. moveToTop function is ignored."),!1;const F=this.index,q=this.parent.getChildren().length;return F<q-1?(this.parent.children.splice(F,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0):!1}moveUp(){if(!this.parent)return h.Util.warn("Node has no parent. moveUp function is ignored."),!1;const F=this.index,q=this.parent.getChildren().length;return F<q-1?(this.parent.children.splice(F,1),this.parent.children.splice(F+1,0,this),this.parent._setChildrenIndices(),!0):!1}moveDown(){if(!this.parent)return h.Util.warn("Node has no parent. moveDown function is ignored."),!1;const F=this.index;return F>0?(this.parent.children.splice(F,1),this.parent.children.splice(F-1,0,this),this.parent._setChildrenIndices(),!0):!1}moveToBottom(){if(!this.parent)return h.Util.warn("Node has no parent. moveToBottom function is ignored."),!1;const F=this.index;return F>0?(this.parent.children.splice(F,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0):!1}setZIndex(F){if(!this.parent)return h.Util.warn("Node has no parent. zIndex parameter is ignored."),this;(F<0||F>=this.parent.children.length)&&h.Util.warn("Unexpected value "+F+" for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to "+(this.parent.children.length-1)+".");const q=this.index;return this.parent.children.splice(q,1),this.parent.children.splice(F,0,this),this.parent._setChildrenIndices(),this}getAbsoluteOpacity(){return this._getCache(n,this._getAbsoluteOpacity)}_getAbsoluteOpacity(){let F=this.opacity();const q=this.getParent();return q&&!q._isUnderCache&&(F*=q.getAbsoluteOpacity()),F}moveTo(F){return this.getParent()!==F&&(this._remove(),F.add(this)),this}toObject(){let F=this.getAttrs(),q,G,W,k,K;const ee={attrs:{},className:this.getClassName()};for(q in F)G=F[q],K=h.Util.isObject(G)&&!h.Util._isPlainObject(G)&&!h.Util._isArray(G),!K&&(W=typeof this[q]=="function"&&this[q],delete F[q],k=W?W.call(this):null,F[q]=G,k!==G&&(ee.attrs[q]=G));return h.Util._prepareToStringify(ee)}toJSON(){return JSON.stringify(this.toObject())}getParent(){return this.parent}findAncestors(F,q,G){const W=[];q&&this._isMatch(F)&&W.push(this);let k=this.parent;for(;k;){if(k===G)return W;k._isMatch(F)&&W.push(k),k=k.parent}return W}isAncestorOf(F){return!1}findAncestor(F,q,G){return this.findAncestors(F,q,G)[0]}_isMatch(F){if(!F)return!1;if(typeof F=="function")return F(this);let q=F.replace(/ /g,"").split(","),G=q.length,W,k;for(W=0;W<G;W++)if(k=q[W],h.Util.isValidSelector(k)||(h.Util.warn('Selector "'+k+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".'),h.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".'),h.Util.warn("Konva is awesome, right?")),k.charAt(0)==="#"){if(this.id()===k.slice(1))return!0}else if(k.charAt(0)==="."){if(this.hasName(k.slice(1)))return!0}else if(this.className===k||this.nodeType===k)return!0;return!1}getLayer(){const F=this.getParent();return F?F.getLayer():null}getStage(){return this._getCache(R,this._getStage)}_getStage(){const F=this.getParent();return F?F.getStage():null}fire(F,q={},G){return q.target=q.target||this,G?this._fireAndBubble(F,q):this._fire(F,q),this}getAbsoluteTransform(F){return F?this._getAbsoluteTransform(F):this._getCache(l,this._getAbsoluteTransform)}_getAbsoluteTransform(F){let q;if(F)return q=new h.Transform,this._eachAncestorReverse(function(G){const W=G.transformsEnabled();W==="all"?q.multiply(G.getTransform()):W==="position"&&q.translate(G.x()-G.offsetX(),G.y()-G.offsetY())},F),q;{q=this._cache.get(l)||new h.Transform,this.parent?this.parent.getAbsoluteTransform().copyInto(q):q.reset();const G=this.transformsEnabled();if(G==="all")q.multiply(this.getTransform());else if(G==="position"){const W=this.attrs.x||0,k=this.attrs.y||0,K=this.attrs.offsetX||0,ee=this.attrs.offsetY||0;q.translate(W-K,k-ee)}return q.dirty=!1,q}}getAbsoluteScale(F){let q=this;for(;q;)q._isUnderCache&&(F=q),q=q.getParent();const W=this.getAbsoluteTransform(F).decompose();return{x:W.scaleX,y:W.scaleY}}getAbsoluteRotation(){return this.getAbsoluteTransform().decompose().rotation}getTransform(){return this._getCache(D,this._getTransform)}_getTransform(){var F,q;const G=this._cache.get(D)||new h.Transform;G.reset();const W=this.x(),k=this.y(),K=s.Konva.getAngle(this.rotation()),ee=(F=this.attrs.scaleX)!==null&&F!==void 0?F:1,V=(q=this.attrs.scaleY)!==null&&q!==void 0?q:1,Q=this.attrs.skewX||0,se=this.attrs.skewY||0,J=this.attrs.offsetX||0,ie=this.attrs.offsetY||0;return(W!==0||k!==0)&&G.translate(W,k),K!==0&&G.rotate(K),(Q!==0||se!==0)&&G.skew(Q,se),(ee!==1||V!==1)&&G.scale(ee,V),(J!==0||ie!==0)&&G.translate(-1*J,-1*ie),G.dirty=!1,G}clone(F){let q=h.Util.cloneObject(this.attrs),G,W,k,K,ee;for(G in F)q[G]=F[G];const V=new this.constructor(q);for(G in this.eventListeners)for(W=this.eventListeners[G],k=W.length,K=0;K<k;K++)ee=W[K],ee.name.indexOf(y)<0&&(V.eventListeners[G]||(V.eventListeners[G]=[]),V.eventListeners[G].push(ee));return V}_toKonvaCanvas(F){F=F||{};const q=this.getClientRect(),G=this.getStage(),W=F.x!==void 0?F.x:Math.floor(q.x),k=F.y!==void 0?F.y:Math.floor(q.y),K=F.pixelRatio||1,ee=new t.SceneCanvas({width:F.width||Math.ceil(q.width)||(G?G.width():0),height:F.height||Math.ceil(q.height)||(G?G.height():0),pixelRatio:K}),V=ee.getContext(),Q=new t.SceneCanvas({width:ee.width/ee.pixelRatio+Math.abs(W),height:ee.height/ee.pixelRatio+Math.abs(k),pixelRatio:ee.pixelRatio});return F.imageSmoothingEnabled===!1&&(V._context.imageSmoothingEnabled=!1),V.save(),(W||k)&&V.translate(-1*W,-1*k),this.drawScene(ee,void 0,Q),V.restore(),ee}toCanvas(F){return this._toKonvaCanvas(F)._canvas}toDataURL(F){F=F||{};const q=F.mimeType||null,G=F.quality||null,W=this._toKonvaCanvas(F).toDataURL(q,G);return F.callback&&F.callback(W),W}toImage(F){return new Promise((q,G)=>{try{const W=F==null?void 0:F.callback;W&&delete F.callback,h.Util._urlToImage(this.toDataURL(F),function(k){q(k),W==null||W(k)})}catch(W){G(W)}})}toBlob(F){return new Promise((q,G)=>{try{const W=F==null?void 0:F.callback;W&&delete F.callback,this.toCanvas(F).toBlob(k=>{q(k),W==null||W(k)},F==null?void 0:F.mimeType,F==null?void 0:F.quality)}catch(W){G(W)}})}setSize(F){return this.width(F.width),this.height(F.height),this}getSize(){return{width:this.width(),height:this.height()}}getClassName(){return this.className||this.nodeType}getType(){return this.nodeType}getDragDistance(){return this.attrs.dragDistance!==void 0?this.attrs.dragDistance:this.parent?this.parent.getDragDistance():s.Konva.dragDistance}_off(F,q,G){let W=this.eventListeners[F],k,K,ee;for(k=0;k<W.length;k++)if(K=W[k].name,ee=W[k].handler,(K!=="konva"||q==="konva")&&(!q||K===q)&&(!G||G===ee)){if(W.splice(k,1),W.length===0){delete this.eventListeners[F];break}k--}}_fireChangeEvent(F,q,G){this._fire(F+_,{oldVal:q,newVal:G})}addName(F){if(!this.hasName(F)){const q=this.name(),G=q?q+" "+F:F;this.name(G)}return this}hasName(F){if(!F)return!1;const q=this.name();return q?(q||"").split(/\s/g).indexOf(F)!==-1:!1}removeName(F){const q=(this.name()||"").split(/\s/g),G=q.indexOf(F);return G!==-1&&(q.splice(G,1),this.name(q.join(" "))),this}setAttr(F,q){const G=this[M+h.Util._capitalize(F)];return h.Util._isFunction(G)?G.call(this,q):this._setAttr(F,q),this}_requestDraw(){if(s.Konva.autoDrawEnabled){const F=this.getLayer()||this.getStage();F==null||F.batchDraw()}}_setAttr(F,q){const G=this.attrs[F];G===q&&!h.Util.isObject(q)||(q==null?delete this.attrs[F]:this.attrs[F]=q,this._shouldFireChangeEvents&&this._fireChangeEvent(F,G,q),this._requestDraw())}_setComponentAttr(F,q,G){let W;G!==void 0&&(W=this.attrs[F],W||(this.attrs[F]=this.getAttr(F)),this.attrs[F][q]=G,this._fireChangeEvent(F,W,G))}_fireAndBubble(F,q,G){if(q&&this.nodeType===w&&(q.target=this),!((F===x||F===C)&&(G&&(this===G||this.isAncestorOf&&this.isAncestorOf(G))||this.nodeType==="Stage"&&!G))){this._fire(F,q);const k=(F===x||F===C)&&G&&G.isAncestorOf&&G.isAncestorOf(this)&&!G.isAncestorOf(this.parent);(q&&!q.cancelBubble||!q)&&this.parent&&this.parent.isListening()&&!k&&(G&&G.parent?this._fireAndBubble.call(this.parent,F,q,G):this._fireAndBubble.call(this.parent,F,q))}}_getProtoListeners(F){var q,G,W;const k=(q=this._cache.get(r))!==null&&q!==void 0?q:{};let K=k==null?void 0:k[F];if(K===void 0){K=[];let ee=Object.getPrototypeOf(this);for(;ee;){const V=(W=(G=ee.eventListeners)===null||G===void 0?void 0:G[F])!==null&&W!==void 0?W:[];K.push(...V),ee=Object.getPrototypeOf(ee)}k[F]=K,this._cache.set(r,k)}return K}_fire(F,q){q=q||{},q.currentTarget=this,q.type=F;const G=this._getProtoListeners(F);if(G)for(var W=0;W<G.length;W++)G[W].handler.call(this,q);const k=this.eventListeners[F];if(k)for(var W=0;W<k.length;W++)k[W].handler.call(this,q)}draw(){return this.drawScene(),this.drawHit(),this}_createDragElement(F){const q=F?F.pointerId:void 0,G=this.getStage(),W=this.getAbsolutePosition();if(!G)return;const k=G._getPointerById(q)||G._changedPointerPositions[0]||W;i.DD._dragElements.set(this._id,{node:this,startPointerPos:k,offset:{x:k.x-W.x,y:k.y-W.y},dragStatus:"ready",pointerId:q})}startDrag(F,q=!0){i.DD._dragElements.has(this._id)||this._createDragElement(F);const G=i.DD._dragElements.get(this._id);G.dragStatus="dragging",this.fire("dragstart",{type:"dragstart",target:this,evt:F&&F.evt},q)}_setDragPosition(F,q){const G=this.getStage()._getPointerById(q.pointerId);if(!G)return;let W={x:G.x-q.offset.x,y:G.y-q.offset.y};const k=this.dragBoundFunc();if(k!==void 0){const K=k.call(this,W,F);K?W=K:h.Util.warn("dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.")}(!this._lastPos||this._lastPos.x!==W.x||this._lastPos.y!==W.y)&&(this.setAbsolutePosition(W),this._requestDraw()),this._lastPos=W}stopDrag(F){const q=i.DD._dragElements.get(this._id);q&&(q.dragStatus="stopped"),i.DD._endDragBefore(F),i.DD._endDragAfter(F)}setDraggable(F){this._setAttr("draggable",F),this._dragChange()}isDragging(){const F=i.DD._dragElements.get(this._id);return F?F.dragStatus==="dragging":!1}_listenDrag(){this._dragCleanup(),this.on("mousedown.konva touchstart.konva",function(F){if(!(!(F.evt.button!==void 0)||s.Konva.dragButtons.indexOf(F.evt.button)>=0)||this.isDragging())return;let W=!1;i.DD._dragElements.forEach(k=>{this.isAncestorOf(k.node)&&(W=!0)}),W||this._createDragElement(F)})}_dragChange(){if(this.attrs.draggable)this._listenDrag();else{if(this._dragCleanup(),!this.getStage())return;const q=i.DD._dragElements.get(this._id),G=q&&q.dragStatus==="dragging",W=q&&q.dragStatus==="ready";G?this.stopDrag():W&&i.DD._dragElements.delete(this._id)}}_dragCleanup(){this.off("mousedown.konva"),this.off("touchstart.konva")}isClientRectOnScreen(F={x:0,y:0}){const q=this.getStage();if(!q)return!1;const G={x:-F.x,y:-F.y,width:q.width()+2*F.x,height:q.height()+2*F.y};return h.Util.haveIntersection(G,this.getClientRect())}static create(F,q){return h.Util._isString(F)&&(F=JSON.parse(F)),this._createNode(F,q)}static _createNode(F,q){let G=mD.prototype.getClassName.call(F),W=F.children,k,K,ee;q&&(F.attrs.container=q),s.Konva[G]||(h.Util.warn('Can not find a node with class name "'+G+'". Fallback to "Shape".'),G="Shape");const V=s.Konva[G];if(k=new V(F.attrs),W)for(K=W.length,ee=0;ee<K;ee++)k.add(mD._createNode(W[ee]));return k}};pS.Node=z,z.prototype.nodeType="Node",z.prototype._attrsAffectingSize=[],z.prototype.eventListeners={},z.prototype.on.call(z.prototype,O,function(){if(this._batchingTransformChange){this._needClearTransformCache=!0;return}this._clearCache(D),this._clearSelfAndDescendantCache(l)}),z.prototype.on.call(z.prototype,"visibleChange.konva",function(){this._clearSelfAndDescendantCache(U)}),z.prototype.on.call(z.prototype,"listeningChange.konva",function(){this._clearSelfAndDescendantCache(v)}),z.prototype.on.call(z.prototype,"opacityChange.konva",function(){this._clearSelfAndDescendantCache(n)});const X=e.Factory.addGetterSetter;return X(z,"zIndex"),X(z,"absolutePosition"),X(z,"position"),X(z,"x",0,(0,a.getNumberValidator)()),X(z,"y",0,(0,a.getNumberValidator)()),X(z,"globalCompositeOperation","source-over",(0,a.getStringValidator)()),X(z,"opacity",1,(0,a.getNumberValidator)()),X(z,"name","",(0,a.getStringValidator)()),X(z,"id","",(0,a.getStringValidator)()),X(z,"rotation",0,(0,a.getNumberValidator)()),e.Factory.addComponentsGetterSetter(z,"scale",["x","y"]),X(z,"scaleX",1,(0,a.getNumberValidator)()),X(z,"scaleY",1,(0,a.getNumberValidator)()),e.Factory.addComponentsGetterSetter(z,"skew",["x","y"]),X(z,"skewX",0,(0,a.getNumberValidator)()),X(z,"skewY",0,(0,a.getNumberValidator)()),e.Factory.addComponentsGetterSetter(z,"offset",["x","y"]),X(z,"offsetX",0,(0,a.getNumberValidator)()),X(z,"offsetY",0,(0,a.getNumberValidator)()),X(z,"dragDistance",void 0,(0,a.getNumberValidator)()),X(z,"width",0,(0,a.getNumberValidator)()),X(z,"height",0,(0,a.getNumberValidator)()),X(z,"listening",!0,(0,a.getBooleanValidator)()),X(z,"preventDefault",!0,(0,a.getBooleanValidator)()),X(z,"filters",void 0,function(Y){return this._filterUpToDate=!1,Y}),X(z,"visible",!0,(0,a.getBooleanValidator)()),X(z,"transformsEnabled","all",(0,a.getStringValidator)()),X(z,"size"),X(z,"dragBoundFunc"),X(z,"draggable",!1,(0,a.getBooleanValidator)()),e.Factory.backCompat(z,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"}),pS}var mS={},KN;function sw(){if(KN)return mS;KN=1,Object.defineProperty(mS,"__esModule",{value:!0}),mS.Container=void 0;const h=Ut(),e=Mi(),t=Gt();let s=class extends e.Node{constructor(){super(...arguments),this.children=[]}getChildren(a){if(!a)return this.children||[];const n=this.children||[],r=[];return n.forEach(function(l){a(l)&&r.push(l)}),r}hasChildren(){return this.getChildren().length>0}removeChildren(){return this.getChildren().forEach(a=>{a.parent=null,a.index=0,a.remove()}),this.children=[],this._requestDraw(),this}destroyChildren(){return this.getChildren().forEach(a=>{a.parent=null,a.index=0,a.destroy()}),this.children=[],this._requestDraw(),this}add(...a){if(a.length===0)return this;if(a.length>1){for(let r=0;r<a.length;r++)this.add(a[r]);return this}const n=a[0];return n.getParent()?(n.moveTo(this),this):(this._validateAdd(n),n.index=this.getChildren().length,n.parent=this,n._clearCaches(),this.getChildren().push(n),this._fire("add",{child:n}),this._requestDraw(),this)}destroy(){return this.hasChildren()&&this.destroyChildren(),super.destroy(),this}find(a){return this._generalFind(a,!1)}findOne(a){const n=this._generalFind(a,!0);return n.length>0?n[0]:void 0}_generalFind(a,n){const r=[];return this._descendants(l=>{const u=l._isMatch(a);return u&&r.push(l),!!(u&&n)}),r}_descendants(a){let n=!1;const r=this.getChildren();for(const l of r){if(n=a(l),n)return!0;if(l.hasChildren()&&(n=l._descendants(a),n))return!0}return!1}toObject(){const a=e.Node.prototype.toObject.call(this);return a.children=[],this.getChildren().forEach(n=>{a.children.push(n.toObject())}),a}isAncestorOf(a){let n=a.getParent();for(;n;){if(n._id===this._id)return!0;n=n.getParent()}return!1}clone(a){const n=e.Node.prototype.clone.call(this,a);return this.getChildren().forEach(function(r){n.add(r.clone())}),n}getAllIntersections(a){const n=[];return this.find("Shape").forEach(r=>{r.isVisible()&&r.intersects(a)&&n.push(r)}),n}_clearSelfAndDescendantCache(a){var n;super._clearSelfAndDescendantCache(a),!this.isCached()&&((n=this.children)===null||n===void 0||n.forEach(function(r){r._clearSelfAndDescendantCache(a)}))}_setChildrenIndices(){var a;(a=this.children)===null||a===void 0||a.forEach(function(n,r){n.index=r}),this._requestDraw()}drawScene(a,n,r){const l=this.getLayer(),u=a||l&&l.getCanvas(),f=u&&u.getContext(),_=this._getCanvasCache(),g=_&&_.scene,y=u&&u.isCache;if(!this.isVisible()&&!y)return this;if(g){f.save();const v=this.getAbsoluteTransform(n).getMatrix();f.transform(v[0],v[1],v[2],v[3],v[4],v[5]),this._drawCachedSceneCanvas(f),f.restore()}else this._drawChildren("drawScene",u,n,r);return this}drawHit(a,n){if(!this.shouldDrawHit(n))return this;const r=this.getLayer(),l=a||r&&r.hitCanvas,u=l&&l.getContext(),f=this._getCanvasCache();if(f&&f.hit){u.save();const g=this.getAbsoluteTransform(n).getMatrix();u.transform(g[0],g[1],g[2],g[3],g[4],g[5]),this._drawCachedHitCanvas(u),u.restore()}else this._drawChildren("drawHit",l,n);return this}_drawChildren(a,n,r,l){var u;const f=n&&n.getContext(),_=this.clipWidth(),g=this.clipHeight(),y=this.clipFunc(),v=typeof _=="number"&&typeof g=="number"||y,x=r===this;if(v){f.save();const M=this.getAbsoluteTransform(r);let w=M.getMatrix();f.transform(w[0],w[1],w[2],w[3],w[4],w[5]),f.beginPath();let T;if(y)T=y.call(this,f,this);else{const R=this.clipX(),D=this.clipY();f.rect(R||0,D||0,_,g)}f.clip.apply(f,T),w=M.copy().invert().getMatrix(),f.transform(w[0],w[1],w[2],w[3],w[4],w[5])}const C=!x&&this.globalCompositeOperation()!=="source-over"&&a==="drawScene";C&&(f.save(),f._applyGlobalCompositeOperation(this)),(u=this.children)===null||u===void 0||u.forEach(function(M){M[a](n,r,l)}),C&&f.restore(),v&&f.restore()}getClientRect(a={}){var n;const r=a.skipTransform,l=a.relativeTo;let u,f,_,g,y={x:1/0,y:1/0,width:0,height:0};const v=this;(n=this.children)===null||n===void 0||n.forEach(function(M){if(!M.visible())return;const w=M.getClientRect({relativeTo:v,skipShadow:a.skipShadow,skipStroke:a.skipStroke});w.width===0&&w.height===0||(u===void 0?(u=w.x,f=w.y,_=w.x+w.width,g=w.y+w.height):(u=Math.min(u,w.x),f=Math.min(f,w.y),_=Math.max(_,w.x+w.width),g=Math.max(g,w.y+w.height)))});const x=this.find("Shape");let C=!1;for(let M=0;M<x.length;M++)if(x[M]._isVisible(this)){C=!0;break}return C&&u!==void 0?y={x:u,y:f,width:_-u,height:g-f}:y={x:0,y:0,width:0,height:0},r?y:this._transformedRect(y,l)}};return mS.Container=s,h.Factory.addComponentsGetterSetter(s,"clip",["x","y","width","height"]),h.Factory.addGetterSetter(s,"clipX",void 0,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(s,"clipY",void 0,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(s,"clipWidth",void 0,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(s,"clipHeight",void 0,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(s,"clipFunc"),mS}var CM={},nd={},QN;function $6(){if(QN)return nd;QN=1,Object.defineProperty(nd,"__esModule",{value:!0}),nd.getCapturedShape=s,nd.createEvent=i,nd.hasPointerCapture=a,nd.setPointerCapture=n,nd.releaseCapture=r;const h=Rt(),e=new Map,t=h.Konva._global.PointerEvent!==void 0;function s(l){return e.get(l)}function i(l){return{evt:l,pointerId:l.pointerId}}function a(l,u){return e.get(l)===u}function n(l,u){r(l),u.getStage()&&(e.set(l,u),t&&u._fire("gotpointercapture",i(new PointerEvent("gotpointercapture"))))}function r(l,u){const f=e.get(l);if(!f)return;const _=f.getStage();_&&_.content,e.delete(l),t&&f._fire("lostpointercapture",i(new PointerEvent("lostpointercapture")))}return nd}var $N;function poe(){return $N||($N=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h.Stage=h.stages=void 0;const e=_i(),t=Ut(),s=sw(),i=Rt(),a=tw(),n=EL(),r=Rt(),l=$6(),u="Stage",f="string",_="px",g="mouseout",y="mouseleave",v="mouseover",x="mouseenter",C="mousemove",M="mousedown",w="mouseup",T="pointermove",R="pointerdown",D="pointerup",I="pointercancel",U="lostpointercapture",O="pointerout",N="pointerleave",z="pointerover",X="pointerenter",Y="contextmenu",F="touchstart",q="touchend",G="touchmove",W="touchcancel",k="wheel",K=5,ee=[[x,"_pointerenter"],[M,"_pointerdown"],[C,"_pointermove"],[w,"_pointerup"],[y,"_pointerleave"],[F,"_pointerdown"],[G,"_pointermove"],[q,"_pointerup"],[W,"_pointercancel"],[v,"_pointerover"],[k,"_wheel"],[Y,"_contextmenu"],[R,"_pointerdown"],[T,"_pointermove"],[D,"_pointerup"],[I,"_pointercancel"],[U,"_lostpointercapture"]],V={mouse:{[O]:g,[N]:y,[z]:v,[X]:x,[T]:C,[R]:M,[D]:w,[I]:"mousecancel",pointerclick:"click",pointerdblclick:"dblclick"},touch:{[O]:"touchout",[N]:"touchleave",[z]:"touchover",[X]:"touchenter",[T]:G,[R]:F,[D]:q,[I]:W,pointerclick:"tap",pointerdblclick:"dbltap"},pointer:{[O]:O,[N]:N,[z]:z,[X]:X,[T]:T,[R]:R,[D]:D,[I]:I,pointerclick:"pointerclick",pointerdblclick:"pointerdblclick"}},Q=he=>he.indexOf("pointer")>=0?"pointer":he.indexOf("touch")>=0?"touch":"mouse",se=he=>{const te=Q(he);if(te==="pointer")return i.Konva.pointerEventsEnabled&&V.pointer;if(te==="touch")return V.touch;if(te==="mouse")return V.mouse};function J(he={}){return(he.clipFunc||he.clipWidth||he.clipHeight)&&e.Util.warn("Stage does not support clipping. Please use clip for Layers or Groups."),he}const ie="Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);";h.stages=[];class oe extends s.Container{constructor(te){super(J(te)),this._pointerPositions=[],this._changedPointerPositions=[],this._buildDOM(),this._bindContentEvents(),h.stages.push(this),this.on("widthChange.konva heightChange.konva",this._resizeDOM),this.on("visibleChange.konva",this._checkVisibility),this.on("clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva",()=>{J(this.attrs)}),this._checkVisibility()}_validateAdd(te){const le=te.getType()==="Layer",Se=te.getType()==="FastLayer";le||Se||e.Util.throw("You may only add layers to the stage.")}_checkVisibility(){if(!this.content)return;const te=this.visible()?"":"none";this.content.style.display=te}setContainer(te){if(typeof te===f){if(te.charAt(0)==="."){const Se=te.slice(1);te=document.getElementsByClassName(Se)[0]}else{var le;te.charAt(0)!=="#"?le=te:le=te.slice(1),te=document.getElementById(le)}if(!te)throw"Can not find container in document with id "+le}return this._setAttr("container",te),this.content&&(this.content.parentElement&&this.content.parentElement.removeChild(this.content),te.appendChild(this.content)),this}shouldDrawHit(){return!0}clear(){const te=this.children,le=te.length;for(let Se=0;Se<le;Se++)te[Se].clear();return this}clone(te){return te||(te={}),te.container=typeof document<"u"&&document.createElement("div"),s.Container.prototype.clone.call(this,te)}destroy(){super.destroy();const te=this.content;te&&e.Util._isInDocument(te)&&this.container().removeChild(te);const le=h.stages.indexOf(this);return le>-1&&h.stages.splice(le,1),e.Util.releaseCanvas(this.bufferCanvas._canvas,this.bufferHitCanvas._canvas),this}getPointerPosition(){const te=this._pointerPositions[0]||this._changedPointerPositions[0];return te?{x:te.x,y:te.y}:(e.Util.warn(ie),null)}_getPointerById(te){return this._pointerPositions.find(le=>le.id===te)}getPointersPositions(){return this._pointerPositions}getStage(){return this}getContent(){return this.content}_toKonvaCanvas(te){te=te||{},te.x=te.x||0,te.y=te.y||0,te.width=te.width||this.width(),te.height=te.height||this.height();const le=new a.SceneCanvas({width:te.width,height:te.height,pixelRatio:te.pixelRatio||1}),Se=le.getContext()._context,Ae=this.children;return(te.x||te.y)&&Se.translate(-1*te.x,-1*te.y),Ae.forEach(function(De){if(!De.isVisible())return;const Fe=De._toKonvaCanvas(te);Se.drawImage(Fe._canvas,te.x,te.y,Fe.getWidth()/Fe.getPixelRatio(),Fe.getHeight()/Fe.getPixelRatio())}),le}getIntersection(te){if(!te)return null;const le=this.children,Se=le.length,Ae=Se-1;for(let De=Ae;De>=0;De--){const Fe=le[De].getIntersection(te);if(Fe)return Fe}return null}_resizeDOM(){const te=this.width(),le=this.height();this.content&&(this.content.style.width=te+_,this.content.style.height=le+_),this.bufferCanvas.setSize(te,le),this.bufferHitCanvas.setSize(te,le),this.children.forEach(Se=>{Se.setSize({width:te,height:le}),Se.draw()})}add(te,...le){if(arguments.length>1){for(let Ae=0;Ae<arguments.length;Ae++)this.add(arguments[Ae]);return this}super.add(te);const Se=this.children.length;return Se>K&&e.Util.warn("The stage has "+Se+" layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group."),te.setSize({width:this.width(),height:this.height()}),te.draw(),i.Konva.isBrowser&&this.content.appendChild(te.canvas._canvas),this}getParent(){return null}getLayer(){return null}hasPointerCapture(te){return l.hasPointerCapture(te,this)}setPointerCapture(te){l.setPointerCapture(te,this)}releaseCapture(te){l.releaseCapture(te,this)}getLayers(){return this.children}_bindContentEvents(){i.Konva.isBrowser&&ee.forEach(([te,le])=>{this.content.addEventListener(te,Se=>{this[le](Se)},{passive:!1})})}_pointerenter(te){this.setPointersPositions(te);const le=se(te.type);le&&this._fire(le.pointerenter,{evt:te,target:this,currentTarget:this})}_pointerover(te){this.setPointersPositions(te);const le=se(te.type);le&&this._fire(le.pointerover,{evt:te,target:this,currentTarget:this})}_getTargetShape(te){let le=this[te+"targetShape"];return le&&!le.getStage()&&(le=null),le}_pointerleave(te){const le=se(te.type),Se=Q(te.type);if(!le)return;this.setPointersPositions(te);const Ae=this._getTargetShape(Se),De=!(i.Konva.isDragging()||i.Konva.isTransforming())||i.Konva.hitOnDragEnabled;Ae&&De?(Ae._fireAndBubble(le.pointerout,{evt:te}),Ae._fireAndBubble(le.pointerleave,{evt:te}),this._fire(le.pointerleave,{evt:te,target:this,currentTarget:this}),this[Se+"targetShape"]=null):De&&(this._fire(le.pointerleave,{evt:te,target:this,currentTarget:this}),this._fire(le.pointerout,{evt:te,target:this,currentTarget:this})),this.pointerPos=null,this._pointerPositions=[]}_pointerdown(te){const le=se(te.type),Se=Q(te.type);if(!le)return;this.setPointersPositions(te);let Ae=!1;this._changedPointerPositions.forEach(De=>{const Fe=this.getIntersection(De);if(n.DD.justDragged=!1,i.Konva["_"+Se+"ListenClick"]=!0,!Fe||!Fe.isListening()){this[Se+"ClickStartShape"]=void 0;return}i.Konva.capturePointerEventsEnabled&&Fe.setPointerCapture(De.id),this[Se+"ClickStartShape"]=Fe,Fe._fireAndBubble(le.pointerdown,{evt:te,pointerId:De.id}),Ae=!0;const ot=te.type.indexOf("touch")>=0;Fe.preventDefault()&&te.cancelable&&ot&&te.preventDefault()}),Ae||this._fire(le.pointerdown,{evt:te,target:this,currentTarget:this,pointerId:this._pointerPositions[0].id})}_pointermove(te){const le=se(te.type),Se=Q(te.type);if(!le||(i.Konva.isDragging()&&n.DD.node.preventDefault()&&te.cancelable&&te.preventDefault(),this.setPointersPositions(te),!(!(i.Konva.isDragging()||i.Konva.isTransforming())||i.Konva.hitOnDragEnabled)))return;const De={};let Fe=!1;const ot=this._getTargetShape(Se);this._changedPointerPositions.forEach(mt=>{const $e=l.getCapturedShape(mt.id)||this.getIntersection(mt),es=mt.id,ht={evt:te,pointerId:es},Pe=ot!==$e;if(Pe&&ot&&(ot._fireAndBubble(le.pointerout,{...ht},$e),ot._fireAndBubble(le.pointerleave,{...ht},$e)),$e){if(De[$e._id])return;De[$e._id]=!0}$e&&$e.isListening()?(Fe=!0,Pe&&($e._fireAndBubble(le.pointerover,{...ht},ot),$e._fireAndBubble(le.pointerenter,{...ht},ot),this[Se+"targetShape"]=$e),$e._fireAndBubble(le.pointermove,{...ht})):ot&&(this._fire(le.pointerover,{evt:te,target:this,currentTarget:this,pointerId:es}),this[Se+"targetShape"]=null)}),Fe||this._fire(le.pointermove,{evt:te,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id})}_pointerup(te){const le=se(te.type),Se=Q(te.type);if(!le)return;this.setPointersPositions(te);const Ae=this[Se+"ClickStartShape"],De=this[Se+"ClickEndShape"],Fe={};let ot=!1;this._changedPointerPositions.forEach(mt=>{const $e=l.getCapturedShape(mt.id)||this.getIntersection(mt);if($e){if($e.releaseCapture(mt.id),Fe[$e._id])return;Fe[$e._id]=!0}const es=mt.id,ht={evt:te,pointerId:es};let Pe=!1;i.Konva["_"+Se+"InDblClickWindow"]?(Pe=!0,clearTimeout(this[Se+"DblTimeout"])):n.DD.justDragged||(i.Konva["_"+Se+"InDblClickWindow"]=!0,clearTimeout(this[Se+"DblTimeout"])),this[Se+"DblTimeout"]=setTimeout(function(){i.Konva["_"+Se+"InDblClickWindow"]=!1},i.Konva.dblClickWindow),$e&&$e.isListening()?(ot=!0,this[Se+"ClickEndShape"]=$e,$e._fireAndBubble(le.pointerup,{...ht}),i.Konva["_"+Se+"ListenClick"]&&Ae&&Ae===$e&&($e._fireAndBubble(le.pointerclick,{...ht}),Pe&&De&&De===$e&&$e._fireAndBubble(le.pointerdblclick,{...ht}))):(this[Se+"ClickEndShape"]=null,i.Konva["_"+Se+"ListenClick"]&&this._fire(le.pointerclick,{evt:te,target:this,currentTarget:this,pointerId:es}),Pe&&this._fire(le.pointerdblclick,{evt:te,target:this,currentTarget:this,pointerId:es}))}),ot||this._fire(le.pointerup,{evt:te,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),i.Konva["_"+Se+"ListenClick"]=!1,te.cancelable&&Se!=="touch"&&Se!=="pointer"&&te.preventDefault()}_contextmenu(te){this.setPointersPositions(te);const le=this.getIntersection(this.getPointerPosition());le&&le.isListening()?le._fireAndBubble(Y,{evt:te}):this._fire(Y,{evt:te,target:this,currentTarget:this})}_wheel(te){this.setPointersPositions(te);const le=this.getIntersection(this.getPointerPosition());le&&le.isListening()?le._fireAndBubble(k,{evt:te}):this._fire(k,{evt:te,target:this,currentTarget:this})}_pointercancel(te){this.setPointersPositions(te);const le=l.getCapturedShape(te.pointerId)||this.getIntersection(this.getPointerPosition());le&&le._fireAndBubble(D,l.createEvent(te)),l.releaseCapture(te.pointerId)}_lostpointercapture(te){l.releaseCapture(te.pointerId)}setPointersPositions(te){const le=this._getContentPosition();let Se=null,Ae=null;te=te||window.event,te.touches!==void 0?(this._pointerPositions=[],this._changedPointerPositions=[],Array.prototype.forEach.call(te.touches,De=>{this._pointerPositions.push({id:De.identifier,x:(De.clientX-le.left)/le.scaleX,y:(De.clientY-le.top)/le.scaleY})}),Array.prototype.forEach.call(te.changedTouches||te.touches,De=>{this._changedPointerPositions.push({id:De.identifier,x:(De.clientX-le.left)/le.scaleX,y:(De.clientY-le.top)/le.scaleY})})):(Se=(te.clientX-le.left)/le.scaleX,Ae=(te.clientY-le.top)/le.scaleY,this.pointerPos={x:Se,y:Ae},this._pointerPositions=[{x:Se,y:Ae,id:e.Util._getFirstPointerId(te)}],this._changedPointerPositions=[{x:Se,y:Ae,id:e.Util._getFirstPointerId(te)}])}_setPointerPosition(te){e.Util.warn('Method _setPointerPosition is deprecated. Use "stage.setPointersPositions(event)" instead.'),this.setPointersPositions(te)}_getContentPosition(){if(!this.content||!this.content.getBoundingClientRect)return{top:0,left:0,scaleX:1,scaleY:1};const te=this.content.getBoundingClientRect();return{top:te.top,left:te.left,scaleX:te.width/this.content.clientWidth||1,scaleY:te.height/this.content.clientHeight||1}}_buildDOM(){if(this.bufferCanvas=new a.SceneCanvas({width:this.width(),height:this.height()}),this.bufferHitCanvas=new a.HitCanvas({pixelRatio:1,width:this.width(),height:this.height()}),!i.Konva.isBrowser)return;const te=this.container();if(!te)throw"Stage has no container. A container is required.";te.innerHTML="",this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.userSelect="none",this.content.className="konvajs-content",this.content.setAttribute("role","presentation"),te.appendChild(this.content),this._resizeDOM()}cache(){return e.Util.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes."),this}clearCache(){return this}batchDraw(){return this.getChildren().forEach(function(te){te.batchDraw()}),this}}h.Stage=oe,oe.prototype.nodeType=u,(0,r._registerNode)(oe),t.Factory.addGetterSetter(oe,"container"),i.Konva.isBrowser&&document.addEventListener("visibilitychange",()=>{h.stages.forEach(he=>{he.batchDraw()})})}(CM)),CM}var _S={},wM={},ZN;function ma(){return ZN||(ZN=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h.Shape=h.shapes=void 0;const e=Rt(),t=_i(),s=Ut(),i=Mi(),a=Gt(),n=Rt(),r=$6(),l="hasShadow",u="shadowRGBA",f="patternImage",_="linearGradient",g="radialGradient";let y;function v(){return y||(y=t.Util.createCanvasElement().getContext("2d"),y)}h.shapes={};function x(N){const z=this.attrs.fillRule;z?N.fill(z):N.fill()}function C(N){N.stroke()}function M(N){const z=this.attrs.fillRule;z?N.fill(z):N.fill()}function w(N){N.stroke()}function T(){this._clearCache(l)}function R(){this._clearCache(u)}function D(){this._clearCache(f)}function I(){this._clearCache(_)}function U(){this._clearCache(g)}class O extends i.Node{constructor(z){super(z);let X;for(;X=t.Util.getRandomColor(),!(X&&!(X in h.shapes)););this.colorKey=X,h.shapes[X]=this}getContext(){return t.Util.warn("shape.getContext() method is deprecated. Please do not use it."),this.getLayer().getContext()}getCanvas(){return t.Util.warn("shape.getCanvas() method is deprecated. Please do not use it."),this.getLayer().getCanvas()}getSceneFunc(){return this.attrs.sceneFunc||this._sceneFunc}getHitFunc(){return this.attrs.hitFunc||this._hitFunc}hasShadow(){return this._getCache(l,this._hasShadow)}_hasShadow(){return this.shadowEnabled()&&this.shadowOpacity()!==0&&!!(this.shadowColor()||this.shadowBlur()||this.shadowOffsetX()||this.shadowOffsetY())}_getFillPattern(){return this._getCache(f,this.__getFillPattern)}__getFillPattern(){if(this.fillPatternImage()){const X=v().createPattern(this.fillPatternImage(),this.fillPatternRepeat()||"repeat");if(X&&X.setTransform){const Y=new t.Transform;Y.translate(this.fillPatternX(),this.fillPatternY()),Y.rotate(e.Konva.getAngle(this.fillPatternRotation())),Y.scale(this.fillPatternScaleX(),this.fillPatternScaleY()),Y.translate(-1*this.fillPatternOffsetX(),-1*this.fillPatternOffsetY());const F=Y.getMatrix(),q=typeof DOMMatrix>"u"?{a:F[0],b:F[1],c:F[2],d:F[3],e:F[4],f:F[5]}:new DOMMatrix(F);X.setTransform(q)}return X}}_getLinearGradient(){return this._getCache(_,this.__getLinearGradient)}__getLinearGradient(){const z=this.fillLinearGradientColorStops();if(z){const X=v(),Y=this.fillLinearGradientStartPoint(),F=this.fillLinearGradientEndPoint(),q=X.createLinearGradient(Y.x,Y.y,F.x,F.y);for(let G=0;G<z.length;G+=2)q.addColorStop(z[G],z[G+1]);return q}}_getRadialGradient(){return this._getCache(g,this.__getRadialGradient)}__getRadialGradient(){const z=this.fillRadialGradientColorStops();if(z){const X=v(),Y=this.fillRadialGradientStartPoint(),F=this.fillRadialGradientEndPoint(),q=X.createRadialGradient(Y.x,Y.y,this.fillRadialGradientStartRadius(),F.x,F.y,this.fillRadialGradientEndRadius());for(let G=0;G<z.length;G+=2)q.addColorStop(z[G],z[G+1]);return q}}getShadowRGBA(){return this._getCache(u,this._getShadowRGBA)}_getShadowRGBA(){if(!this.hasShadow())return;const z=t.Util.colorToRGBA(this.shadowColor());if(z)return"rgba("+z.r+","+z.g+","+z.b+","+z.a*(this.shadowOpacity()||1)+")"}hasFill(){return this._calculate("hasFill",["fillEnabled","fill","fillPatternImage","fillLinearGradientColorStops","fillRadialGradientColorStops"],()=>this.fillEnabled()&&!!(this.fill()||this.fillPatternImage()||this.fillLinearGradientColorStops()||this.fillRadialGradientColorStops()))}hasStroke(){return this._calculate("hasStroke",["strokeEnabled","strokeWidth","stroke","strokeLinearGradientColorStops"],()=>this.strokeEnabled()&&this.strokeWidth()&&!!(this.stroke()||this.strokeLinearGradientColorStops()))}hasHitStroke(){const z=this.hitStrokeWidth();return z==="auto"?this.hasStroke():this.strokeEnabled()&&!!z}intersects(z){const X=this.getStage();if(!X)return!1;const Y=X.bufferHitCanvas;return Y.getContext().clear(),this.drawHit(Y,void 0,!0),Y.context.getImageData(Math.round(z.x),Math.round(z.y),1,1).data[3]>0}destroy(){return i.Node.prototype.destroy.call(this),delete h.shapes[this.colorKey],delete this.colorKey,this}_useBufferCanvas(z){var X;if(!((X=this.attrs.perfectDrawEnabled)!==null&&X!==void 0?X:!0))return!1;const F=z||this.hasFill(),q=this.hasStroke(),G=this.getAbsoluteOpacity()!==1;if(F&&q&&G)return!0;const W=this.hasShadow(),k=this.shadowForStrokeEnabled();return!!(F&&q&&W&&k)}setStrokeHitEnabled(z){t.Util.warn("strokeHitEnabled property is deprecated. Please use hitStrokeWidth instead."),z?this.hitStrokeWidth("auto"):this.hitStrokeWidth(0)}getStrokeHitEnabled(){return this.hitStrokeWidth()!==0}getSelfRect(){const z=this.size();return{x:this._centroid?-z.width/2:0,y:this._centroid?-z.height/2:0,width:z.width,height:z.height}}getClientRect(z={}){let X=!1,Y=this.getParent();for(;Y;){if(Y.isCached()){X=!0;break}Y=Y.getParent()}const F=z.skipTransform,q=z.relativeTo||X&&this.getStage()||void 0,G=this.getSelfRect(),k=!z.skipStroke&&this.hasStroke()&&this.strokeWidth()||0,K=G.width+k,ee=G.height+k,V=!z.skipShadow&&this.hasShadow(),Q=V?this.shadowOffsetX():0,se=V?this.shadowOffsetY():0,J=K+Math.abs(Q),ie=ee+Math.abs(se),oe=V&&this.shadowBlur()||0,he=J+oe*2,te=ie+oe*2,le={width:he,height:te,x:-(k/2+oe)+Math.min(Q,0)+G.x,y:-(k/2+oe)+Math.min(se,0)+G.y};return F?le:this._transformedRect(le,q)}drawScene(z,X,Y){const F=this.getLayer();let q=z||F.getCanvas(),G=q.getContext(),W=this._getCanvasCache(),k=this.getSceneFunc(),K=this.hasShadow(),ee,V;const Q=q.isCache,se=X===this;if(!this.isVisible()&&!se)return this;if(W){G.save();const ie=this.getAbsoluteTransform(X).getMatrix();return G.transform(ie[0],ie[1],ie[2],ie[3],ie[4],ie[5]),this._drawCachedSceneCanvas(G),G.restore(),this}if(!k)return this;if(G.save(),this._useBufferCanvas()&&!Q){ee=this.getStage();const ie=Y||ee.bufferCanvas;V=ie.getContext(),V.clear(),V.save(),V._applyLineJoin(this);var J=this.getAbsoluteTransform(X).getMatrix();V.transform(J[0],J[1],J[2],J[3],J[4],J[5]),k.call(this,V,this),V.restore();const oe=ie.pixelRatio;K&&G._applyShadow(this),G._applyOpacity(this),G._applyGlobalCompositeOperation(this),G.drawImage(ie._canvas,0,0,ie.width/oe,ie.height/oe)}else{if(G._applyLineJoin(this),!se){var J=this.getAbsoluteTransform(X).getMatrix();G.transform(J[0],J[1],J[2],J[3],J[4],J[5]),G._applyOpacity(this),G._applyGlobalCompositeOperation(this)}K&&G._applyShadow(this),k.call(this,G,this)}return G.restore(),this}drawHit(z,X,Y=!1){if(!this.shouldDrawHit(X,Y))return this;const F=this.getLayer(),q=z||F.hitCanvas,G=q&&q.getContext(),W=this.hitFunc()||this.sceneFunc(),k=this._getCanvasCache(),K=k&&k.hit;if(this.colorKey||t.Util.warn("Looks like your canvas has a destroyed shape in it. Do not reuse shape after you destroyed it. If you want to reuse shape you should call remove() instead of destroy()"),K){G.save();const V=this.getAbsoluteTransform(X).getMatrix();return G.transform(V[0],V[1],V[2],V[3],V[4],V[5]),this._drawCachedHitCanvas(G),G.restore(),this}if(!W)return this;if(G.save(),G._applyLineJoin(this),!(this===X)){const V=this.getAbsoluteTransform(X).getMatrix();G.transform(V[0],V[1],V[2],V[3],V[4],V[5])}return W.call(this,G,this),G.restore(),this}drawHitFromCache(z=0){const X=this._getCanvasCache(),Y=this._getCachedSceneCanvas(),F=X.hit,q=F.getContext(),G=F.getWidth(),W=F.getHeight();q.clear(),q.drawImage(Y._canvas,0,0,G,W);try{const k=q.getImageData(0,0,G,W),K=k.data,ee=K.length,V=t.Util._hexToRgb(this.colorKey);for(let Q=0;Q<ee;Q+=4)K[Q+3]>z?(K[Q]=V.r,K[Q+1]=V.g,K[Q+2]=V.b,K[Q+3]=255):K[Q+3]=0;q.putImageData(k,0,0)}catch(k){t.Util.error("Unable to draw hit graph from cached scene canvas. "+k.message)}return this}hasPointerCapture(z){return r.hasPointerCapture(z,this)}setPointerCapture(z){r.setPointerCapture(z,this)}releaseCapture(z){r.releaseCapture(z,this)}}h.Shape=O,O.prototype._fillFunc=x,O.prototype._strokeFunc=C,O.prototype._fillFuncHit=M,O.prototype._strokeFuncHit=w,O.prototype._centroid=!1,O.prototype.nodeType="Shape",(0,n._registerNode)(O),O.prototype.eventListeners={},O.prototype.on.call(O.prototype,"shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",T),O.prototype.on.call(O.prototype,"shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",R),O.prototype.on.call(O.prototype,"fillPriorityChange.konva fillPatternImageChange.konva fillPatternRepeatChange.konva fillPatternScaleXChange.konva fillPatternScaleYChange.konva fillPatternOffsetXChange.konva fillPatternOffsetYChange.konva fillPatternXChange.konva fillPatternYChange.konva fillPatternRotationChange.konva",D),O.prototype.on.call(O.prototype,"fillPriorityChange.konva fillLinearGradientColorStopsChange.konva fillLinearGradientStartPointXChange.konva fillLinearGradientStartPointYChange.konva fillLinearGradientEndPointXChange.konva fillLinearGradientEndPointYChange.konva",I),O.prototype.on.call(O.prototype,"fillPriorityChange.konva fillRadialGradientColorStopsChange.konva fillRadialGradientStartPointXChange.konva fillRadialGradientStartPointYChange.konva fillRadialGradientEndPointXChange.konva fillRadialGradientEndPointYChange.konva fillRadialGradientStartRadiusChange.konva fillRadialGradientEndRadiusChange.konva",U),s.Factory.addGetterSetter(O,"stroke",void 0,(0,a.getStringOrGradientValidator)()),s.Factory.addGetterSetter(O,"strokeWidth",2,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"fillAfterStrokeEnabled",!1),s.Factory.addGetterSetter(O,"hitStrokeWidth","auto",(0,a.getNumberOrAutoValidator)()),s.Factory.addGetterSetter(O,"strokeHitEnabled",!0,(0,a.getBooleanValidator)()),s.Factory.addGetterSetter(O,"perfectDrawEnabled",!0,(0,a.getBooleanValidator)()),s.Factory.addGetterSetter(O,"shadowForStrokeEnabled",!0,(0,a.getBooleanValidator)()),s.Factory.addGetterSetter(O,"lineJoin"),s.Factory.addGetterSetter(O,"lineCap"),s.Factory.addGetterSetter(O,"sceneFunc"),s.Factory.addGetterSetter(O,"hitFunc"),s.Factory.addGetterSetter(O,"dash"),s.Factory.addGetterSetter(O,"dashOffset",0,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"shadowColor",void 0,(0,a.getStringValidator)()),s.Factory.addGetterSetter(O,"shadowBlur",0,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"shadowOpacity",1,(0,a.getNumberValidator)()),s.Factory.addComponentsGetterSetter(O,"shadowOffset",["x","y"]),s.Factory.addGetterSetter(O,"shadowOffsetX",0,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"shadowOffsetY",0,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"fillPatternImage"),s.Factory.addGetterSetter(O,"fill",void 0,(0,a.getStringOrGradientValidator)()),s.Factory.addGetterSetter(O,"fillPatternX",0,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"fillPatternY",0,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"fillLinearGradientColorStops"),s.Factory.addGetterSetter(O,"strokeLinearGradientColorStops"),s.Factory.addGetterSetter(O,"fillRadialGradientStartRadius",0),s.Factory.addGetterSetter(O,"fillRadialGradientEndRadius",0),s.Factory.addGetterSetter(O,"fillRadialGradientColorStops"),s.Factory.addGetterSetter(O,"fillPatternRepeat","repeat"),s.Factory.addGetterSetter(O,"fillEnabled",!0),s.Factory.addGetterSetter(O,"strokeEnabled",!0),s.Factory.addGetterSetter(O,"shadowEnabled",!0),s.Factory.addGetterSetter(O,"dashEnabled",!0),s.Factory.addGetterSetter(O,"strokeScaleEnabled",!0),s.Factory.addGetterSetter(O,"fillPriority","color"),s.Factory.addComponentsGetterSetter(O,"fillPatternOffset",["x","y"]),s.Factory.addGetterSetter(O,"fillPatternOffsetX",0,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"fillPatternOffsetY",0,(0,a.getNumberValidator)()),s.Factory.addComponentsGetterSetter(O,"fillPatternScale",["x","y"]),s.Factory.addGetterSetter(O,"fillPatternScaleX",1,(0,a.getNumberValidator)()),s.Factory.addGetterSetter(O,"fillPatternScaleY",1,(0,a.getNumberValidator)()),s.Factory.addComponentsGetterSetter(O,"fillLinearGradientStartPoint",["x","y"]),s.Factory.addComponentsGetterSetter(O,"strokeLinearGradientStartPoint",["x","y"]),s.Factory.addGetterSetter(O,"fillLinearGradientStartPointX",0),s.Factory.addGetterSetter(O,"strokeLinearGradientStartPointX",0),s.Factory.addGetterSetter(O,"fillLinearGradientStartPointY",0),s.Factory.addGetterSetter(O,"strokeLinearGradientStartPointY",0),s.Factory.addComponentsGetterSetter(O,"fillLinearGradientEndPoint",["x","y"]),s.Factory.addComponentsGetterSetter(O,"strokeLinearGradientEndPoint",["x","y"]),s.Factory.addGetterSetter(O,"fillLinearGradientEndPointX",0),s.Factory.addGetterSetter(O,"strokeLinearGradientEndPointX",0),s.Factory.addGetterSetter(O,"fillLinearGradientEndPointY",0),s.Factory.addGetterSetter(O,"strokeLinearGradientEndPointY",0),s.Factory.addComponentsGetterSetter(O,"fillRadialGradientStartPoint",["x","y"]),s.Factory.addGetterSetter(O,"fillRadialGradientStartPointX",0),s.Factory.addGetterSetter(O,"fillRadialGradientStartPointY",0),s.Factory.addComponentsGetterSetter(O,"fillRadialGradientEndPoint",["x","y"]),s.Factory.addGetterSetter(O,"fillRadialGradientEndPointX",0),s.Factory.addGetterSetter(O,"fillRadialGradientEndPointY",0),s.Factory.addGetterSetter(O,"fillPatternRotation",0),s.Factory.addGetterSetter(O,"fillRule",void 0,(0,a.getStringValidator)()),s.Factory.backCompat(O,{dashArray:"dash",getDashArray:"getDash",setDashArray:"getDash",drawFunc:"sceneFunc",getDrawFunc:"getSceneFunc",setDrawFunc:"setSceneFunc",drawHitFunc:"hitFunc",getDrawHitFunc:"getHitFunc",setDrawHitFunc:"setHitFunc"})}(wM)),wM}var JN;function Z6(){if(JN)return _S;JN=1,Object.defineProperty(_S,"__esModule",{value:!0}),_S.Layer=void 0;const h=_i(),e=sw(),t=Mi(),s=Ut(),i=tw(),a=Gt(),n=ma(),r=Rt(),l="#",u="beforeDraw",f="draw",_=[{x:0,y:0},{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}],g=_.length;class y extends e.Container{constructor(x){super(x),this.canvas=new i.SceneCanvas,this.hitCanvas=new i.HitCanvas({pixelRatio:1}),this._waitingForDraw=!1,this.on("visibleChange.konva",this._checkVisibility),this._checkVisibility(),this.on("imageSmoothingEnabledChange.konva",this._setSmoothEnabled),this._setSmoothEnabled()}createPNGStream(){return this.canvas._canvas.createPNGStream()}getCanvas(){return this.canvas}getNativeCanvasElement(){return this.canvas._canvas}getHitCanvas(){return this.hitCanvas}getContext(){return this.getCanvas().getContext()}clear(x){return this.getContext().clear(x),this.getHitCanvas().getContext().clear(x),this}setZIndex(x){super.setZIndex(x);const C=this.getStage();return C&&C.content&&(C.content.removeChild(this.getNativeCanvasElement()),x<C.children.length-1?C.content.insertBefore(this.getNativeCanvasElement(),C.children[x+1].getCanvas()._canvas):C.content.appendChild(this.getNativeCanvasElement())),this}moveToTop(){t.Node.prototype.moveToTop.call(this);const x=this.getStage();return x&&x.content&&(x.content.removeChild(this.getNativeCanvasElement()),x.content.appendChild(this.getNativeCanvasElement())),!0}moveUp(){if(!t.Node.prototype.moveUp.call(this))return!1;const C=this.getStage();return!C||!C.content?!1:(C.content.removeChild(this.getNativeCanvasElement()),this.index<C.children.length-1?C.content.insertBefore(this.getNativeCanvasElement(),C.children[this.index+1].getCanvas()._canvas):C.content.appendChild(this.getNativeCanvasElement()),!0)}moveDown(){if(t.Node.prototype.moveDown.call(this)){const x=this.getStage();if(x){const C=x.children;x.content&&(x.content.removeChild(this.getNativeCanvasElement()),x.content.insertBefore(this.getNativeCanvasElement(),C[this.index+1].getCanvas()._canvas))}return!0}return!1}moveToBottom(){if(t.Node.prototype.moveToBottom.call(this)){const x=this.getStage();if(x){const C=x.children;x.content&&(x.content.removeChild(this.getNativeCanvasElement()),x.content.insertBefore(this.getNativeCanvasElement(),C[1].getCanvas()._canvas))}return!0}return!1}getLayer(){return this}remove(){const x=this.getNativeCanvasElement();return t.Node.prototype.remove.call(this),x&&x.parentNode&&h.Util._isInDocument(x)&&x.parentNode.removeChild(x),this}getStage(){return this.parent}setSize({width:x,height:C}){return this.canvas.setSize(x,C),this.hitCanvas.setSize(x,C),this._setSmoothEnabled(),this}_validateAdd(x){const C=x.getType();C!=="Group"&&C!=="Shape"&&h.Util.throw("You may only add groups and shapes to a layer.")}_toKonvaCanvas(x){return x=x||{},x.width=x.width||this.getWidth(),x.height=x.height||this.getHeight(),x.x=x.x!==void 0?x.x:this.x(),x.y=x.y!==void 0?x.y:this.y(),t.Node.prototype._toKonvaCanvas.call(this,x)}_checkVisibility(){this.visible()?this.canvas._canvas.style.display="block":this.canvas._canvas.style.display="none"}_setSmoothEnabled(){this.getContext()._context.imageSmoothingEnabled=this.imageSmoothingEnabled()}getWidth(){if(this.parent)return this.parent.width()}setWidth(){h.Util.warn('Can not change width of layer. Use "stage.width(value)" function instead.')}getHeight(){if(this.parent)return this.parent.height()}setHeight(){h.Util.warn('Can not change height of layer. Use "stage.height(value)" function instead.')}batchDraw(){return this._waitingForDraw||(this._waitingForDraw=!0,h.Util.requestAnimFrame(()=>{this.draw(),this._waitingForDraw=!1})),this}getIntersection(x){if(!this.isListening()||!this.isVisible())return null;let C=1,M=!1;for(;;){for(let w=0;w<g;w++){const T=_[w],R=this._getIntersection({x:x.x+T.x*C,y:x.y+T.y*C}),D=R.shape;if(D)return D;if(M=!!R.antialiased,!R.antialiased)break}if(M)C+=1;else return null}}_getIntersection(x){const C=this.hitCanvas.pixelRatio,M=this.hitCanvas.context.getImageData(Math.round(x.x*C),Math.round(x.y*C),1,1).data,w=M[3];if(w===255){const T=h.Util._rgbToHex(M[0],M[1],M[2]),R=n.shapes[l+T];return R?{shape:R}:{antialiased:!0}}else if(w>0)return{antialiased:!0};return{}}drawScene(x,C){const M=this.getLayer(),w=x||M&&M.getCanvas();return this._fire(u,{node:this}),this.clearBeforeDraw()&&w.getContext().clear(),e.Container.prototype.drawScene.call(this,w,C),this._fire(f,{node:this}),this}drawHit(x,C){const M=this.getLayer(),w=x||M&&M.hitCanvas;return M&&M.clearBeforeDraw()&&M.getHitCanvas().getContext().clear(),e.Container.prototype.drawHit.call(this,w,C),this}enableHitGraph(){return this.hitGraphEnabled(!0),this}disableHitGraph(){return this.hitGraphEnabled(!1),this}setHitGraphEnabled(x){h.Util.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening(x)}getHitGraphEnabled(x){return h.Util.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening()}toggleHitCanvas(){if(!this.parent||!this.parent.content)return;const x=this.parent;!!this.hitCanvas._canvas.parentNode?x.content.removeChild(this.hitCanvas._canvas):x.content.appendChild(this.hitCanvas._canvas)}destroy(){return h.Util.releaseCanvas(this.getNativeCanvasElement(),this.getHitCanvas()._canvas),super.destroy()}}return _S.Layer=y,y.prototype.nodeType="Layer",(0,r._registerNode)(y),s.Factory.addGetterSetter(y,"imageSmoothingEnabled",!0),s.Factory.addGetterSetter(y,"clearBeforeDraw",!0),s.Factory.addGetterSetter(y,"hitGraphEnabled",!0,(0,a.getBooleanValidator)()),_S}var gS={},e5;function moe(){if(e5)return gS;e5=1,Object.defineProperty(gS,"__esModule",{value:!0}),gS.FastLayer=void 0;const h=_i(),e=Z6(),t=Rt();let s=class extends e.Layer{constructor(a){super(a),this.listening(!1),h.Util.warn('Konva.Fast layer is deprecated. Please use "new Konva.Layer({ listening: false })" instead.')}};return gS.FastLayer=s,s.prototype.nodeType="FastLayer",(0,t._registerNode)(s),gS}var yS={},t5;function AL(){if(t5)return yS;t5=1,Object.defineProperty(yS,"__esModule",{value:!0}),yS.Group=void 0;const h=_i(),e=sw(),t=Rt();class s extends e.Container{_validateAdd(a){const n=a.getType();n!=="Group"&&n!=="Shape"&&h.Util.throw("You may only add groups and shapes to groups.")}}return yS.Group=s,s.prototype.nodeType="Group",(0,t._registerNode)(s),yS}var vS={},s5;function CL(){if(s5)return vS;s5=1,Object.defineProperty(vS,"__esModule",{value:!0}),vS.Animation=void 0;const h=Rt(),e=_i(),t=function(){return h.glob.performance&&h.glob.performance.now?function(){return h.glob.performance.now()}:function(){return new Date().getTime()}}();let s=class Fg{constructor(a,n){this.id=Fg.animIdCounter++,this.frame={time:0,timeDiff:0,lastTime:t(),frameRate:0},this.func=a,this.setLayers(n)}setLayers(a){let n=[];return a&&(n=Array.isArray(a)?a:[a]),this.layers=n,this}getLayers(){return this.layers}addLayer(a){const n=this.layers,r=n.length;for(let l=0;l<r;l++)if(n[l]._id===a._id)return!1;return this.layers.push(a),!0}isRunning(){const n=Fg.animations,r=n.length;for(let l=0;l<r;l++)if(n[l].id===this.id)return!0;return!1}start(){return this.stop(),this.frame.timeDiff=0,this.frame.lastTime=t(),Fg._addAnimation(this),this}stop(){return Fg._removeAnimation(this),this}_updateFrameObject(a){this.frame.timeDiff=a-this.frame.lastTime,this.frame.lastTime=a,this.frame.time+=this.frame.timeDiff,this.frame.frameRate=1e3/this.frame.timeDiff}static _addAnimation(a){this.animations.push(a),this._handleAnimation()}static _removeAnimation(a){const n=a.id,r=this.animations,l=r.length;for(let u=0;u<l;u++)if(r[u].id===n){this.animations.splice(u,1);break}}static _runFrames(){const a={},n=this.animations;for(let r=0;r<n.length;r++){const l=n[r],u=l.layers,f=l.func;l._updateFrameObject(t());const _=u.length;let g;if(f?g=f.call(l,l.frame)!==!1:g=!0,!!g)for(let y=0;y<_;y++){const v=u[y];v._id!==void 0&&(a[v._id]=v)}}for(const r in a)a.hasOwnProperty(r)&&a[r].batchDraw()}static _animationLoop(){const a=Fg;a.animations.length?(a._runFrames(),e.Util.requestAnimFrame(a._animationLoop)):a.animRunning=!1}static _handleAnimation(){this.animRunning||(this.animRunning=!0,e.Util.requestAnimFrame(this._animationLoop))}};return vS.Animation=s,s.animations=[],s.animIdCounter=0,s.animRunning=!1,vS}var RM={},i5;function _oe(){return i5||(i5=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h.Easings=h.Tween=void 0;const e=_i(),t=CL(),s=Mi(),i=Rt(),a={node:1,duration:1,easing:1,onFinish:1,yoyo:1},n=1,r=2,l=3,u=["fill","stroke","shadowColor"];let f=0;class _{constructor(v,x,C,M,w,T,R){this.prop=v,this.propFunc=x,this.begin=M,this._pos=M,this.duration=T,this._change=0,this.prevPos=0,this.yoyo=R,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.func=C,this._change=w-this.begin,this.pause()}fire(v){const x=this[v];x&&x()}setTime(v){v>this.duration?this.yoyo?(this._time=this.duration,this.reverse()):this.finish():v<0?this.yoyo?(this._time=0,this.play()):this.reset():(this._time=v,this.update())}getTime(){return this._time}setPosition(v){this.prevPos=this._pos,this.propFunc(v),this._pos=v}getPosition(v){return v===void 0&&(v=this._time),this.func(v,this.begin,this._change,this.duration)}play(){this.state=r,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onPlay")}reverse(){this.state=l,this._time=this.duration-this._time,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onReverse")}seek(v){this.pause(),this._time=v,this.update(),this.fire("onSeek")}reset(){this.pause(),this._time=0,this.update(),this.fire("onReset")}finish(){this.pause(),this._time=this.duration,this.update(),this.fire("onFinish")}update(){this.setPosition(this.getPosition(this._time)),this.fire("onUpdate")}onEnterFrame(){const v=this.getTimer()-this._startTime;this.state===r?this.setTime(v):this.state===l&&this.setTime(this.duration-v)}pause(){this.state=n,this.fire("onPause")}getTimer(){return new Date().getTime()}}class g{constructor(v){const x=this,C=v.node,M=C._id,w=v.easing||h.Easings.Linear,T=!!v.yoyo;let R,D;typeof v.duration>"u"?R=.3:v.duration===0?R=.001:R=v.duration,this.node=C,this._id=f++;const I=C.getLayer()||(C instanceof i.Konva.Stage?C.getLayers():null);I||e.Util.error("Tween constructor have `node` that is not in a layer. Please add node into layer first."),this.anim=new t.Animation(function(){x.tween.onEnterFrame()},I),this.tween=new _(D,function(U){x._tweenFunc(U)},w,0,1,R*1e3,T),this._addListeners(),g.attrs[M]||(g.attrs[M]={}),g.attrs[M][this._id]||(g.attrs[M][this._id]={}),g.tweens[M]||(g.tweens[M]={});for(D in v)a[D]===void 0&&this._addAttr(D,v[D]);this.reset(),this.onFinish=v.onFinish,this.onReset=v.onReset,this.onUpdate=v.onUpdate}_addAttr(v,x){const C=this.node,M=C._id;let w,T,R,D,I;const U=g.tweens[M][v];U&&delete g.attrs[M][U][v];let O=C.getAttr(v);if(e.Util._isArray(x))if(w=[],T=Math.max(x.length,O.length),v==="points"&&x.length!==O.length&&(x.length>O.length?(D=O,O=e.Util._prepareArrayForTween(O,x,C.closed())):(R=x,x=e.Util._prepareArrayForTween(x,O,C.closed()))),v.indexOf("fill")===0)for(let N=0;N<T;N++)if(N%2===0)w.push(x[N]-O[N]);else{const z=e.Util.colorToRGBA(O[N]);I=e.Util.colorToRGBA(x[N]),O[N]=z,w.push({r:I.r-z.r,g:I.g-z.g,b:I.b-z.b,a:I.a-z.a})}else for(let N=0;N<T;N++)w.push(x[N]-O[N]);else u.indexOf(v)!==-1?(O=e.Util.colorToRGBA(O),I=e.Util.colorToRGBA(x),w={r:I.r-O.r,g:I.g-O.g,b:I.b-O.b,a:I.a-O.a}):w=x-O;g.attrs[M][this._id][v]={start:O,diff:w,end:x,trueEnd:R,trueStart:D},g.tweens[M][v]=this._id}_tweenFunc(v){const x=this.node,C=g.attrs[x._id][this._id];let M,w,T,R,D,I,U,O;for(M in C){if(w=C[M],T=w.start,R=w.diff,O=w.end,e.Util._isArray(T))if(D=[],U=Math.max(T.length,O.length),M.indexOf("fill")===0)for(I=0;I<U;I++)I%2===0?D.push((T[I]||0)+R[I]*v):D.push("rgba("+Math.round(T[I].r+R[I].r*v)+","+Math.round(T[I].g+R[I].g*v)+","+Math.round(T[I].b+R[I].b*v)+","+(T[I].a+R[I].a*v)+")");else for(I=0;I<U;I++)D.push((T[I]||0)+R[I]*v);else u.indexOf(M)!==-1?D="rgba("+Math.round(T.r+R.r*v)+","+Math.round(T.g+R.g*v)+","+Math.round(T.b+R.b*v)+","+(T.a+R.a*v)+")":D=T+R*v;x.setAttr(M,D)}}_addListeners(){this.tween.onPlay=()=>{this.anim.start()},this.tween.onReverse=()=>{this.anim.start()},this.tween.onPause=()=>{this.anim.stop()},this.tween.onFinish=()=>{const v=this.node,x=g.attrs[v._id][this._id];x.points&&x.points.trueEnd&&v.setAttr("points",x.points.trueEnd),this.onFinish&&this.onFinish.call(this)},this.tween.onReset=()=>{const v=this.node,x=g.attrs[v._id][this._id];x.points&&x.points.trueStart&&v.points(x.points.trueStart),this.onReset&&this.onReset()},this.tween.onUpdate=()=>{this.onUpdate&&this.onUpdate.call(this)}}play(){return this.tween.play(),this}reverse(){return this.tween.reverse(),this}reset(){return this.tween.reset(),this}seek(v){return this.tween.seek(v*1e3),this}pause(){return this.tween.pause(),this}finish(){return this.tween.finish(),this}destroy(){const v=this.node._id,x=this._id,C=g.tweens[v];this.pause();for(const M in C)delete g.tweens[v][M];delete g.attrs[v][x]}}h.Tween=g,g.attrs={},g.tweens={},s.Node.prototype.to=function(y){const v=y.onFinish;y.node=this,y.onFinish=function(){this.destroy(),v&&v()},new g(y).play()},h.Easings={BackEaseIn(y,v,x,C){return x*(y/=C)*y*((1.70158+1)*y-1.70158)+v},BackEaseOut(y,v,x,C){return x*((y=y/C-1)*y*((1.70158+1)*y+1.70158)+1)+v},BackEaseInOut(y,v,x,C){let M=1.70158;return(y/=C/2)<1?x/2*(y*y*(((M*=1.525)+1)*y-M))+v:x/2*((y-=2)*y*(((M*=1.525)+1)*y+M)+2)+v},ElasticEaseIn(y,v,x,C,M,w){let T=0;return y===0?v:(y/=C)===1?v+x:(w||(w=C*.3),!M||M<Math.abs(x)?(M=x,T=w/4):T=w/(2*Math.PI)*Math.asin(x/M),-(M*Math.pow(2,10*(y-=1))*Math.sin((y*C-T)*(2*Math.PI)/w))+v)},ElasticEaseOut(y,v,x,C,M,w){let T=0;return y===0?v:(y/=C)===1?v+x:(w||(w=C*.3),!M||M<Math.abs(x)?(M=x,T=w/4):T=w/(2*Math.PI)*Math.asin(x/M),M*Math.pow(2,-10*y)*Math.sin((y*C-T)*(2*Math.PI)/w)+x+v)},ElasticEaseInOut(y,v,x,C,M,w){let T=0;return y===0?v:(y/=C/2)===2?v+x:(w||(w=C*(.3*1.5)),!M||M<Math.abs(x)?(M=x,T=w/4):T=w/(2*Math.PI)*Math.asin(x/M),y<1?-.5*(M*Math.pow(2,10*(y-=1))*Math.sin((y*C-T)*(2*Math.PI)/w))+v:M*Math.pow(2,-10*(y-=1))*Math.sin((y*C-T)*(2*Math.PI)/w)*.5+x+v)},BounceEaseOut(y,v,x,C){return(y/=C)<1/2.75?x*(7.5625*y*y)+v:y<2/2.75?x*(7.5625*(y-=1.5/2.75)*y+.75)+v:y<2.5/2.75?x*(7.5625*(y-=2.25/2.75)*y+.9375)+v:x*(7.5625*(y-=2.625/2.75)*y+.984375)+v},BounceEaseIn(y,v,x,C){return x-h.Easings.BounceEaseOut(C-y,0,x,C)+v},BounceEaseInOut(y,v,x,C){return y<C/2?h.Easings.BounceEaseIn(y*2,0,x,C)*.5+v:h.Easings.BounceEaseOut(y*2-C,0,x,C)*.5+x*.5+v},EaseIn(y,v,x,C){return x*(y/=C)*y+v},EaseOut(y,v,x,C){return-x*(y/=C)*(y-2)+v},EaseInOut(y,v,x,C){return(y/=C/2)<1?x/2*y*y+v:-x/2*(--y*(y-2)-1)+v},StrongEaseIn(y,v,x,C){return x*(y/=C)*y*y*y*y+v},StrongEaseOut(y,v,x,C){return x*((y=y/C-1)*y*y*y*y+1)+v},StrongEaseInOut(y,v,x,C){return(y/=C/2)<1?x/2*y*y*y*y*y+v:x/2*((y-=2)*y*y*y*y+2)+v},Linear(y,v,x,C){return x*y/C+v}}}(RM)),RM}var a5;function _D(){return a5||(a5=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h.Konva=void 0;const e=Rt(),t=_i(),s=Mi(),i=sw(),a=poe(),n=Z6(),r=moe(),l=AL(),u=EL(),f=ma(),_=CL(),g=_oe(),y=Q6(),v=tw();h.Konva=t.Util._assign(e.Konva,{Util:t.Util,Transform:t.Transform,Node:s.Node,Container:i.Container,Stage:a.Stage,stages:a.stages,Layer:n.Layer,FastLayer:r.FastLayer,Group:l.Group,DD:u.DD,Shape:f.Shape,shapes:f.shapes,Animation:_.Animation,Tween:g.Tween,Easings:g.Easings,Context:y.Context,Canvas:v.Canvas}),h.default=h.Konva}(bM)),bM}var SS={},n5;function goe(){if(n5)return SS;n5=1,Object.defineProperty(SS,"__esModule",{value:!0}),SS.Arc=void 0;const h=Ut(),e=ma(),t=Rt(),s=Gt(),i=Rt();let a=class extends e.Shape{_sceneFunc(r){const l=t.Konva.getAngle(this.angle()),u=this.clockwise();r.beginPath(),r.arc(0,0,this.outerRadius(),0,l,u),r.arc(0,0,this.innerRadius(),l,0,!u),r.closePath(),r.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(r){this.outerRadius(r/2)}setHeight(r){this.outerRadius(r/2)}getSelfRect(){const r=this.innerRadius(),l=this.outerRadius(),u=this.clockwise(),f=t.Konva.getAngle(u?360-this.angle():this.angle()),_=Math.cos(Math.min(f,Math.PI)),g=1,y=Math.sin(Math.min(Math.max(Math.PI,f),3*Math.PI/2)),v=Math.sin(Math.min(f,Math.PI/2)),x=_*(_>0?r:l),C=g*l,M=y*(y>0?r:l),w=v*(v>0?l:r);return{x,y:u?-1*w:M,width:C-x,height:w-M}}};return SS.Arc=a,a.prototype._centroid=!0,a.prototype.className="Arc",a.prototype._attrsAffectingSize=["innerRadius","outerRadius","angle","clockwise"],(0,i._registerNode)(a),h.Factory.addGetterSetter(a,"innerRadius",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(a,"outerRadius",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(a,"angle",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(a,"clockwise",!1,(0,s.getBooleanValidator)()),SS}var bS={},xS={},r5;function J6(){if(r5)return xS;r5=1,Object.defineProperty(xS,"__esModule",{value:!0}),xS.Line=void 0;const h=Ut(),e=Rt(),t=ma(),s=Gt();function i(r,l,u,f,_,g,y){const v=Math.sqrt(Math.pow(u-r,2)+Math.pow(f-l,2)),x=Math.sqrt(Math.pow(_-u,2)+Math.pow(g-f,2)),C=y*v/(v+x),M=y*x/(v+x),w=u-C*(_-r),T=f-C*(g-l),R=u+M*(_-r),D=f+M*(g-l);return[w,T,R,D]}function a(r,l){const u=r.length,f=[];for(let _=2;_<u-2;_+=2){const g=i(r[_-2],r[_-1],r[_],r[_+1],r[_+2],r[_+3],l);isNaN(g[0])||(f.push(g[0]),f.push(g[1]),f.push(r[_]),f.push(r[_+1]),f.push(g[2]),f.push(g[3]))}return f}class n extends t.Shape{constructor(l){super(l),this.on("pointsChange.konva tensionChange.konva closedChange.konva bezierChange.konva",function(){this._clearCache("tensionPoints")})}_sceneFunc(l){let u=this.points(),f=u.length,_=this.tension(),g=this.closed(),y=this.bezier(),v,x,C;if(f){if(l.beginPath(),l.moveTo(u[0],u[1]),_!==0&&f>4){for(v=this.getTensionPoints(),x=v.length,C=g?0:4,g||l.quadraticCurveTo(v[0],v[1],v[2],v[3]);C<x-2;)l.bezierCurveTo(v[C++],v[C++],v[C++],v[C++],v[C++],v[C++]);g||l.quadraticCurveTo(v[x-2],v[x-1],u[f-2],u[f-1])}else if(y)for(C=2;C<f;)l.bezierCurveTo(u[C++],u[C++],u[C++],u[C++],u[C++],u[C++]);else for(C=2;C<f;C+=2)l.lineTo(u[C],u[C+1]);g?(l.closePath(),l.fillStrokeShape(this)):l.strokeShape(this)}}getTensionPoints(){return this._getCache("tensionPoints",this._getTensionPoints)}_getTensionPoints(){return this.closed()?this._getTensionPointsClosed():a(this.points(),this.tension())}_getTensionPointsClosed(){const l=this.points(),u=l.length,f=this.tension(),_=i(l[u-2],l[u-1],l[0],l[1],l[2],l[3],f),g=i(l[u-4],l[u-3],l[u-2],l[u-1],l[0],l[1],f),y=a(l,f);return[_[2],_[3]].concat(y).concat([g[0],g[1],l[u-2],l[u-1],g[2],g[3],_[0],_[1],l[0],l[1]])}getWidth(){return this.getSelfRect().width}getHeight(){return this.getSelfRect().height}getSelfRect(){let l=this.points();if(l.length<4)return{x:l[0]||0,y:l[1]||0,width:0,height:0};this.tension()!==0?l=[l[0],l[1],...this._getTensionPoints(),l[l.length-2],l[l.length-1]]:l=this.points();let u=l[0],f=l[0],_=l[1],g=l[1],y,v;for(let x=0;x<l.length/2;x++)y=l[x*2],v=l[x*2+1],u=Math.min(u,y),f=Math.max(f,y),_=Math.min(_,v),g=Math.max(g,v);return{x:u,y:_,width:f-u,height:g-_}}}return xS.Line=n,n.prototype.className="Line",n.prototype._attrsAffectingSize=["points","bezier","tension"],(0,e._registerNode)(n),h.Factory.addGetterSetter(n,"closed",!1),h.Factory.addGetterSetter(n,"bezier",!1),h.Factory.addGetterSetter(n,"tension",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(n,"points",[],(0,s.getNumberArrayValidator)()),xS}var TS={},MM={},o5;function yoe(){return o5||(o5=1,function(h){Object.defineProperty(h,"__esModule",{value:!0}),h.t2length=h.getQuadraticArcLength=h.getCubicArcLength=h.binomialCoefficients=h.cValues=h.tValues=void 0,h.tValues=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],h.cValues=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],h.binomialCoefficients=[[1],[1,1],[1,2,1],[1,3,3,1]];const e=(n,r,l)=>{let u,f;const g=l/2;u=0;for(let y=0;y<20;y++)f=g*h.tValues[20][y]+g,u+=h.cValues[20][y]*s(n,r,f);return g*u};h.getCubicArcLength=e;const t=(n,r,l)=>{l===void 0&&(l=1);const u=n[0]-2*n[1]+n[2],f=r[0]-2*r[1]+r[2],_=2*n[1]-2*n[0],g=2*r[1]-2*r[0],y=4*(u*u+f*f),v=4*(u*_+f*g),x=_*_+g*g;if(y===0)return l*Math.sqrt(Math.pow(n[2]-n[0],2)+Math.pow(r[2]-r[0],2));const C=v/(2*y),M=x/y,w=l+C,T=M-C*C,R=w*w+T>0?Math.sqrt(w*w+T):0,D=C*C+T>0?Math.sqrt(C*C+T):0,I=C+Math.sqrt(C*C+T)!==0?T*Math.log(Math.abs((w+R)/(C+D))):0;return Math.sqrt(y)/2*(w*R-C*D+I)};h.getQuadraticArcLength=t;function s(n,r,l){const u=i(1,l,n),f=i(1,l,r),_=u*u+f*f;return Math.sqrt(_)}const i=(n,r,l)=>{const u=l.length-1;let f,_;if(u===0)return 0;if(n===0){_=0;for(let g=0;g<=u;g++)_+=h.binomialCoefficients[u][g]*Math.pow(1-r,u-g)*Math.pow(r,g)*l[g];return _}else{f=new Array(u);for(let g=0;g<u;g++)f[g]=u*(l[g+1]-l[g]);return i(n-1,r,f)}},a=(n,r,l)=>{let u=1,f=n/r,_=(n-l(f))/r,g=0;for(;u>.001;){const y=l(f+_),v=Math.abs(n-y)/r;if(v<u)u=v,f+=_;else{const x=l(f-_),C=Math.abs(n-x)/r;C<u?(u=C,f-=_):_/=2}if(g++,g>500)break}return f};h.t2length=a}(MM)),MM}var l5;function wL(){if(l5)return TS;l5=1,Object.defineProperty(TS,"__esModule",{value:!0}),TS.Path=void 0;const h=Ut(),e=ma(),t=Rt(),s=yoe();let i=class In extends e.Shape{constructor(n){super(n),this.dataArray=[],this.pathLength=0,this._readDataAttribute(),this.on("dataChange.konva",function(){this._readDataAttribute()})}_readDataAttribute(){this.dataArray=In.parsePathData(this.data()),this.pathLength=In.getPathLength(this.dataArray)}_sceneFunc(n){const r=this.dataArray;n.beginPath();let l=!1;for(let R=0;R<r.length;R++){const D=r[R].command,I=r[R].points;switch(D){case"L":n.lineTo(I[0],I[1]);break;case"M":n.moveTo(I[0],I[1]);break;case"C":n.bezierCurveTo(I[0],I[1],I[2],I[3],I[4],I[5]);break;case"Q":n.quadraticCurveTo(I[0],I[1],I[2],I[3]);break;case"A":var u=I[0],f=I[1],_=I[2],g=I[3],y=I[4],v=I[5],x=I[6],C=I[7],M=_>g?_:g,w=_>g?1:_/g,T=_>g?g/_:1;n.translate(u,f),n.rotate(x),n.scale(w,T),n.arc(0,0,M,y,y+v,1-C),n.scale(1/w,1/T),n.rotate(-x),n.translate(-u,-f);break;case"z":l=!0,n.closePath();break}}!l&&!this.hasFill()?n.strokeShape(this):n.fillStrokeShape(this)}getSelfRect(){let n=[];this.dataArray.forEach(function(y){if(y.command==="A"){const v=y.points[4],x=y.points[5],C=y.points[4]+x;let M=Math.PI/180;if(Math.abs(v-C)<M&&(M=Math.abs(v-C)),x<0)for(let w=v-M;w>C;w-=M){const T=In.getPointOnEllipticalArc(y.points[0],y.points[1],y.points[2],y.points[3],w,0);n.push(T.x,T.y)}else for(let w=v+M;w<C;w+=M){const T=In.getPointOnEllipticalArc(y.points[0],y.points[1],y.points[2],y.points[3],w,0);n.push(T.x,T.y)}}else if(y.command==="C")for(let v=0;v<=1;v+=.01){const x=In.getPointOnCubicBezier(v,y.start.x,y.start.y,y.points[0],y.points[1],y.points[2],y.points[3],y.points[4],y.points[5]);n.push(x.x,x.y)}else n=n.concat(y.points)});let r=n[0],l=n[0],u=n[1],f=n[1],_,g;for(let y=0;y<n.length/2;y++)_=n[y*2],g=n[y*2+1],isNaN(_)||(r=Math.min(r,_),l=Math.max(l,_)),isNaN(g)||(u=Math.min(u,g),f=Math.max(f,g));return{x:r,y:u,width:l-r,height:f-u}}getLength(){return this.pathLength}getPointAtLength(n){return In.getPointAtLengthOfDataArray(n,this.dataArray)}static getLineLength(n,r,l,u){return Math.sqrt((l-n)*(l-n)+(u-r)*(u-r))}static getPathLength(n){let r=0;for(let l=0;l<n.length;++l)r+=n[l].pathLength;return r}static getPointAtLengthOfDataArray(n,r){let l,u=0,f=r.length;if(!f)return null;for(;u<f&&n>r[u].pathLength;)n-=r[u].pathLength,++u;if(u===f)return l=r[u-1].points.slice(-2),{x:l[0],y:l[1]};if(n<.01)return l=r[u].points.slice(0,2),{x:l[0],y:l[1]};const _=r[u],g=_.points;switch(_.command){case"L":return In.getPointOnLine(n,_.start.x,_.start.y,g[0],g[1]);case"C":return In.getPointOnCubicBezier((0,s.t2length)(n,In.getPathLength(r),R=>(0,s.getCubicArcLength)([_.start.x,g[0],g[2],g[4]],[_.start.y,g[1],g[3],g[5]],R)),_.start.x,_.start.y,g[0],g[1],g[2],g[3],g[4],g[5]);case"Q":return In.getPointOnQuadraticBezier((0,s.t2length)(n,In.getPathLength(r),R=>(0,s.getQuadraticArcLength)([_.start.x,g[0],g[2]],[_.start.y,g[1],g[3]],R)),_.start.x,_.start.y,g[0],g[1],g[2],g[3]);case"A":var y=g[0],v=g[1],x=g[2],C=g[3],M=g[4],w=g[5],T=g[6];return M+=w*n/_.pathLength,In.getPointOnEllipticalArc(y,v,x,C,M,T)}return null}static getPointOnLine(n,r,l,u,f,_,g){_=_??r,g=g??l;const y=this.getLineLength(r,l,u,f);if(y<1e-10)return{x:r,y:l};if(u===r)return{x:_,y:g+(f>l?n:-n)};const v=(f-l)/(u-r),x=Math.sqrt(n*n/(1+v*v))*(u<r?-1:1),C=v*x;if(Math.abs(g-l-v*(_-r))<1e-10)return{x:_+x,y:g+C};const M=((_-r)*(u-r)+(g-l)*(f-l))/(y*y),w=r+M*(u-r),T=l+M*(f-l),R=this.getLineLength(_,g,w,T),D=Math.sqrt(n*n-R*R),I=Math.sqrt(D*D/(1+v*v))*(u<r?-1:1),U=v*I;return{x:w+I,y:T+U}}static getPointOnCubicBezier(n,r,l,u,f,_,g,y,v){function x(D){return D*D*D}function C(D){return 3*D*D*(1-D)}function M(D){return 3*D*(1-D)*(1-D)}function w(D){return(1-D)*(1-D)*(1-D)}const T=y*x(n)+_*C(n)+u*M(n)+r*w(n),R=v*x(n)+g*C(n)+f*M(n)+l*w(n);return{x:T,y:R}}static getPointOnQuadraticBezier(n,r,l,u,f,_,g){function y(w){return w*w}function v(w){return 2*w*(1-w)}function x(w){return(1-w)*(1-w)}const C=_*y(n)+u*v(n)+r*x(n),M=g*y(n)+f*v(n)+l*x(n);return{x:C,y:M}}static getPointOnEllipticalArc(n,r,l,u,f,_){const g=Math.cos(_),y=Math.sin(_),v={x:l*Math.cos(f),y:u*Math.sin(f)};return{x:n+(v.x*g-v.y*y),y:r+(v.x*y+v.y*g)}}static parsePathData(n){if(!n)return[];let r=n;const l=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];r=r.replace(new RegExp(" ","g"),",");for(var u=0;u<l.length;u++)r=r.replace(new RegExp(l[u],"g"),"|"+l[u]);const f=r.split("|"),_=[],g=[];let y=0,v=0;const x=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:e[-+]?\d+)?)/gi;let C;for(u=1;u<f.length;u++){let F=f[u],q=F.charAt(0);for(F=F.slice(1),g.length=0;C=x.exec(F);)g.push(C[0]);const G=[];for(let W=0,k=g.length;W<k;W++){if(g[W]==="00"){G.push(0,0);continue}const K=parseFloat(g[W]);isNaN(K)?G.push(0):G.push(K)}for(;G.length>0&&!isNaN(G[0]);){let W="",k=[];const K=y,ee=v;var M,w,T,R,D,I,U,O,N,z;switch(q){case"l":y+=G.shift(),v+=G.shift(),W="L",k.push(y,v);break;case"L":y=G.shift(),v=G.shift(),k.push(y,v);break;case"m":var X=G.shift(),Y=G.shift();if(y+=X,v+=Y,W="M",_.length>2&&_[_.length-1].command==="z"){for(let V=_.length-2;V>=0;V--)if(_[V].command==="M"){y=_[V].points[0]+X,v=_[V].points[1]+Y;break}}k.push(y,v),q="l";break;case"M":y=G.shift(),v=G.shift(),W="M",k.push(y,v),q="L";break;case"h":y+=G.shift(),W="L",k.push(y,v);break;case"H":y=G.shift(),W="L",k.push(y,v);break;case"v":v+=G.shift(),W="L",k.push(y,v);break;case"V":v=G.shift(),W="L",k.push(y,v);break;case"C":k.push(G.shift(),G.shift(),G.shift(),G.shift()),y=G.shift(),v=G.shift(),k.push(y,v);break;case"c":k.push(y+G.shift(),v+G.shift(),y+G.shift(),v+G.shift()),y+=G.shift(),v+=G.shift(),W="C",k.push(y,v);break;case"S":w=y,T=v,M=_[_.length-1],M.command==="C"&&(w=y+(y-M.points[2]),T=v+(v-M.points[3])),k.push(w,T,G.shift(),G.shift()),y=G.shift(),v=G.shift(),W="C",k.push(y,v);break;case"s":w=y,T=v,M=_[_.length-1],M.command==="C"&&(w=y+(y-M.points[2]),T=v+(v-M.points[3])),k.push(w,T,y+G.shift(),v+G.shift()),y+=G.shift(),v+=G.shift(),W="C",k.push(y,v);break;case"Q":k.push(G.shift(),G.shift()),y=G.shift(),v=G.shift(),k.push(y,v);break;case"q":k.push(y+G.shift(),v+G.shift()),y+=G.shift(),v+=G.shift(),W="Q",k.push(y,v);break;case"T":w=y,T=v,M=_[_.length-1],M.command==="Q"&&(w=y+(y-M.points[0]),T=v+(v-M.points[1])),y=G.shift(),v=G.shift(),W="Q",k.push(w,T,y,v);break;case"t":w=y,T=v,M=_[_.length-1],M.command==="Q"&&(w=y+(y-M.points[0]),T=v+(v-M.points[1])),y+=G.shift(),v+=G.shift(),W="Q",k.push(w,T,y,v);break;case"A":R=G.shift(),D=G.shift(),I=G.shift(),U=G.shift(),O=G.shift(),N=y,z=v,y=G.shift(),v=G.shift(),W="A",k=this.convertEndpointToCenterParameterization(N,z,y,v,U,O,R,D,I);break;case"a":R=G.shift(),D=G.shift(),I=G.shift(),U=G.shift(),O=G.shift(),N=y,z=v,y+=G.shift(),v+=G.shift(),W="A",k=this.convertEndpointToCenterParameterization(N,z,y,v,U,O,R,D,I);break}_.push({command:W||q,points:k,start:{x:K,y:ee},pathLength:this.calcLength(K,ee,W||q,k)})}(q==="z"||q==="Z")&&_.push({command:"z",points:[],start:void 0,pathLength:0})}return _}static calcLength(n,r,l,u){let f,_,g,y;const v=In;switch(l){case"L":return v.getLineLength(n,r,u[0],u[1]);case"C":return(0,s.getCubicArcLength)([n,u[0],u[2],u[4]],[r,u[1],u[3],u[5]],1);case"Q":return(0,s.getQuadraticArcLength)([n,u[0],u[2]],[r,u[1],u[3]],1);case"A":f=0;var x=u[4],C=u[5],M=u[4]+C,w=Math.PI/180;if(Math.abs(x-M)<w&&(w=Math.abs(x-M)),_=v.getPointOnEllipticalArc(u[0],u[1],u[2],u[3],x,0),C<0)for(y=x-w;y>M;y-=w)g=v.getPointOnEllipticalArc(u[0],u[1],u[2],u[3],y,0),f+=v.getLineLength(_.x,_.y,g.x,g.y),_=g;else for(y=x+w;y<M;y+=w)g=v.getPointOnEllipticalArc(u[0],u[1],u[2],u[3],y,0),f+=v.getLineLength(_.x,_.y,g.x,g.y),_=g;return g=v.getPointOnEllipticalArc(u[0],u[1],u[2],u[3],M,0),f+=v.getLineLength(_.x,_.y,g.x,g.y),f}return 0}static convertEndpointToCenterParameterization(n,r,l,u,f,_,g,y,v){const x=v*(Math.PI/180),C=Math.cos(x)*(n-l)/2+Math.sin(x)*(r-u)/2,M=-1*Math.sin(x)*(n-l)/2+Math.cos(x)*(r-u)/2,w=C*C/(g*g)+M*M/(y*y);w>1&&(g*=Math.sqrt(w),y*=Math.sqrt(w));let T=Math.sqrt((g*g*(y*y)-g*g*(M*M)-y*y*(C*C))/(g*g*(M*M)+y*y*(C*C)));f===_&&(T*=-1),isNaN(T)&&(T=0);const R=T*g*M/y,D=T*-y*C/g,I=(n+l)/2+Math.cos(x)*R-Math.sin(x)*D,U=(r+u)/2+Math.sin(x)*R+Math.cos(x)*D,O=function(G){return Math.sqrt(G[0]*G[0]+G[1]*G[1])},N=function(G,W){return(G[0]*W[0]+G[1]*W[1])/(O(G)*O(W))},z=function(G,W){return(G[0]*W[1]<G[1]*W[0]?-1:1)*Math.acos(N(G,W))},X=z([1,0],[(C-R)/g,(M-D)/y]),Y=[(C-R)/g,(M-D)/y],F=[(-1*C-R)/g,(-1*M-D)/y];let q=z(Y,F);return N(Y,F)<=-1&&(q=Math.PI),N(Y,F)>=1&&(q=0),_===0&&q>0&&(q=q-2*Math.PI),_===1&&q<0&&(q=q+2*Math.PI),[I,U,g,y,X,q,x,_]}};return TS.Path=i,i.prototype.className="Path",i.prototype._attrsAffectingSize=["data"],(0,t._registerNode)(i),h.Factory.addGetterSetter(i,"data"),TS}var h5;function voe(){if(h5)return bS;h5=1,Object.defineProperty(bS,"__esModule",{value:!0}),bS.Arrow=void 0;const h=Ut(),e=J6(),t=Gt(),s=Rt(),i=wL();let a=class extends e.Line{_sceneFunc(r){super._sceneFunc(r);const l=Math.PI*2,u=this.points();let f=u;const _=this.tension()!==0&&u.length>4;_&&(f=this.getTensionPoints());const g=this.pointerLength(),y=u.length;let v,x;if(_){const w=[f[f.length-4],f[f.length-3],f[f.length-2],f[f.length-1],u[y-2],u[y-1]],T=i.Path.calcLength(f[f.length-4],f[f.length-3],"C",w),R=i.Path.getPointOnQuadraticBezier(Math.min(1,1-g/T),w[0],w[1],w[2],w[3],w[4],w[5]);v=u[y-2]-R.x,x=u[y-1]-R.y}else v=u[y-2]-u[y-4],x=u[y-1]-u[y-3];const C=(Math.atan2(x,v)+l)%l,M=this.pointerWidth();this.pointerAtEnding()&&(r.save(),r.beginPath(),r.translate(u[y-2],u[y-1]),r.rotate(C),r.moveTo(0,0),r.lineTo(-g,M/2),r.lineTo(-g,-M/2),r.closePath(),r.restore(),this.__fillStroke(r)),this.pointerAtBeginning()&&(r.save(),r.beginPath(),r.translate(u[0],u[1]),_?(v=(f[0]+f[2])/2-u[0],x=(f[1]+f[3])/2-u[1]):(v=u[2]-u[0],x=u[3]-u[1]),r.rotate((Math.atan2(-x,-v)+l)%l),r.moveTo(0,0),r.lineTo(-g,M/2),r.lineTo(-g,-M/2),r.closePath(),r.restore(),this.__fillStroke(r))}__fillStroke(r){const l=this.dashEnabled();l&&(this.attrs.dashEnabled=!1,r.setLineDash([])),r.fillStrokeShape(this),l&&(this.attrs.dashEnabled=!0)}getSelfRect(){const r=super.getSelfRect(),l=this.pointerWidth()/2;return{x:r.x,y:r.y-l,width:r.width,height:r.height+l*2}}};return bS.Arrow=a,a.prototype.className="Arrow",(0,s._registerNode)(a),h.Factory.addGetterSetter(a,"pointerLength",10,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(a,"pointerWidth",10,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(a,"pointerAtBeginning",!1),h.Factory.addGetterSetter(a,"pointerAtEnding",!0),bS}var ES={},c5;function Soe(){if(c5)return ES;c5=1,Object.defineProperty(ES,"__esModule",{value:!0}),ES.Circle=void 0;const h=Ut(),e=ma(),t=Gt(),s=Rt();class i extends e.Shape{_sceneFunc(n){n.beginPath(),n.arc(0,0,this.attrs.radius||0,0,Math.PI*2,!1),n.closePath(),n.fillStrokeShape(this)}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(n){this.radius()!==n/2&&this.radius(n/2)}setHeight(n){this.radius()!==n/2&&this.radius(n/2)}}return ES.Circle=i,i.prototype._centroid=!0,i.prototype.className="Circle",i.prototype._attrsAffectingSize=["radius"],(0,s._registerNode)(i),h.Factory.addGetterSetter(i,"radius",0,(0,t.getNumberValidator)()),ES}var AS={},u5;function boe(){if(u5)return AS;u5=1,Object.defineProperty(AS,"__esModule",{value:!0}),AS.Ellipse=void 0;const h=Ut(),e=ma(),t=Gt(),s=Rt();let i=class extends e.Shape{_sceneFunc(n){const r=this.radiusX(),l=this.radiusY();n.beginPath(),n.save(),r!==l&&n.scale(1,l/r),n.arc(0,0,r,0,Math.PI*2,!1),n.restore(),n.closePath(),n.fillStrokeShape(this)}getWidth(){return this.radiusX()*2}getHeight(){return this.radiusY()*2}setWidth(n){this.radiusX(n/2)}setHeight(n){this.radiusY(n/2)}};return AS.Ellipse=i,i.prototype.className="Ellipse",i.prototype._centroid=!0,i.prototype._attrsAffectingSize=["radiusX","radiusY"],(0,s._registerNode)(i),h.Factory.addComponentsGetterSetter(i,"radius",["x","y"]),h.Factory.addGetterSetter(i,"radiusX",0,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(i,"radiusY",0,(0,t.getNumberValidator)()),AS}var CS={},d5;function xoe(){if(d5)return CS;d5=1,Object.defineProperty(CS,"__esModule",{value:!0}),CS.Image=void 0;const h=_i(),e=Ut(),t=ma(),s=Rt(),i=Gt();class a extends t.Shape{constructor(r){super(r),this._loadListener=()=>{this._requestDraw()},this.on("imageChange.konva",l=>{this._removeImageLoad(l.oldVal),this._setImageLoad()}),this._setImageLoad()}_setImageLoad(){const r=this.image();r&&r.complete||r&&r.readyState===4||r&&r.addEventListener&&r.addEventListener("load",this._loadListener)}_removeImageLoad(r){r&&r.removeEventListener&&r.removeEventListener("load",this._loadListener)}destroy(){return this._removeImageLoad(this.image()),super.destroy(),this}_useBufferCanvas(){const r=!!this.cornerRadius(),l=this.hasShadow();return r&&l?!0:super._useBufferCanvas(!0)}_sceneFunc(r){const l=this.getWidth(),u=this.getHeight(),f=this.cornerRadius(),_=this.attrs.image;let g;if(_){const y=this.attrs.cropWidth,v=this.attrs.cropHeight;y&&v?g=[_,this.cropX(),this.cropY(),y,v,0,0,l,u]:g=[_,0,0,l,u]}(this.hasFill()||this.hasStroke()||f)&&(r.beginPath(),f?h.Util.drawRoundedRectPath(r,l,u,f):r.rect(0,0,l,u),r.closePath(),r.fillStrokeShape(this)),_&&(f&&r.clip(),r.drawImage.apply(r,g))}_hitFunc(r){const l=this.width(),u=this.height(),f=this.cornerRadius();r.beginPath(),f?h.Util.drawRoundedRectPath(r,l,u,f):r.rect(0,0,l,u),r.closePath(),r.fillStrokeShape(this)}getWidth(){var r,l;return(r=this.attrs.width)!==null&&r!==void 0?r:(l=this.image())===null||l===void 0?void 0:l.width}getHeight(){var r,l;return(r=this.attrs.height)!==null&&r!==void 0?r:(l=this.image())===null||l===void 0?void 0:l.height}static fromURL(r,l,u=null){const f=h.Util.createImageElement();f.onload=function(){const _=new a({image:f});l(_)},f.onerror=u,f.crossOrigin="Anonymous",f.src=r}}return CS.Image=a,a.prototype.className="Image",(0,s._registerNode)(a),e.Factory.addGetterSetter(a,"cornerRadius",0,(0,i.getNumberOrArrayOfNumbersValidator)(4)),e.Factory.addGetterSetter(a,"image"),e.Factory.addComponentsGetterSetter(a,"crop",["x","y","width","height"]),e.Factory.addGetterSetter(a,"cropX",0,(0,i.getNumberValidator)()),e.Factory.addGetterSetter(a,"cropY",0,(0,i.getNumberValidator)()),e.Factory.addGetterSetter(a,"cropWidth",0,(0,i.getNumberValidator)()),e.Factory.addGetterSetter(a,"cropHeight",0,(0,i.getNumberValidator)()),CS}var bp={},f5;function Toe(){if(f5)return bp;f5=1,Object.defineProperty(bp,"__esModule",{value:!0}),bp.Tag=bp.Label=void 0;const h=Ut(),e=ma(),t=AL(),s=Gt(),i=Rt(),a=["fontFamily","fontSize","fontStyle","padding","lineHeight","text","width","height","pointerDirection","pointerWidth","pointerHeight"],n="Change.konva",r="none",l="up",u="right",f="down",_="left",g=a.length;let y=class extends t.Group{constructor(C){super(C),this.on("add.konva",function(M){this._addListeners(M.child),this._sync()})}getText(){return this.find("Text")[0]}getTag(){return this.find("Tag")[0]}_addListeners(C){let M=this,w;const T=function(){M._sync()};for(w=0;w<g;w++)C.on(a[w]+n,T)}getWidth(){return this.getText().width()}getHeight(){return this.getText().height()}_sync(){let C=this.getText(),M=this.getTag(),w,T,R,D,I,U,O;if(C&&M){switch(w=C.width(),T=C.height(),R=M.pointerDirection(),D=M.pointerWidth(),O=M.pointerHeight(),I=0,U=0,R){case l:I=w/2,U=-1*O;break;case u:I=w+D,U=T/2;break;case f:I=w/2,U=T+O;break;case _:I=-1*D,U=T/2;break}M.setAttrs({x:-1*I,y:-1*U,width:w,height:T}),C.setAttrs({x:-1*I,y:-1*U})}}};bp.Label=y,y.prototype.className="Label",(0,i._registerNode)(y);class v extends e.Shape{_sceneFunc(C){const M=this.width(),w=this.height(),T=this.pointerDirection(),R=this.pointerWidth(),D=this.pointerHeight(),I=this.cornerRadius();let U=0,O=0,N=0,z=0;typeof I=="number"?U=O=N=z=Math.min(I,M/2,w/2):(U=Math.min(I[0]||0,M/2,w/2),O=Math.min(I[1]||0,M/2,w/2),z=Math.min(I[2]||0,M/2,w/2),N=Math.min(I[3]||0,M/2,w/2)),C.beginPath(),C.moveTo(U,0),T===l&&(C.lineTo((M-R)/2,0),C.lineTo(M/2,-1*D),C.lineTo((M+R)/2,0)),C.lineTo(M-O,0),C.arc(M-O,O,O,Math.PI*3/2,0,!1),T===u&&(C.lineTo(M,(w-D)/2),C.lineTo(M+R,w/2),C.lineTo(M,(w+D)/2)),C.lineTo(M,w-z),C.arc(M-z,w-z,z,0,Math.PI/2,!1),T===f&&(C.lineTo((M+R)/2,w),C.lineTo(M/2,w+D),C.lineTo((M-R)/2,w)),C.lineTo(N,w),C.arc(N,w-N,N,Math.PI/2,Math.PI,!1),T===_&&(C.lineTo(0,(w+D)/2),C.lineTo(-1*R,w/2),C.lineTo(0,(w-D)/2)),C.lineTo(0,U),C.arc(U,U,U,Math.PI,Math.PI*3/2,!1),C.closePath(),C.fillStrokeShape(this)}getSelfRect(){let C=0,M=0,w=this.pointerWidth(),T=this.pointerHeight(),R=this.pointerDirection(),D=this.width(),I=this.height();return R===l?(M-=T,I+=T):R===f?I+=T:R===_?(C-=w*1.5,D+=w):R===u&&(D+=w*1.5),{x:C,y:M,width:D,height:I}}}return bp.Tag=v,v.prototype.className="Tag",(0,i._registerNode)(v),h.Factory.addGetterSetter(v,"pointerDirection",r),h.Factory.addGetterSetter(v,"pointerWidth",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(v,"pointerHeight",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(v,"cornerRadius",0,(0,s.getNumberOrArrayOfNumbersValidator)(4)),bp}var wS={},p5;function ek(){if(p5)return wS;p5=1,Object.defineProperty(wS,"__esModule",{value:!0}),wS.Rect=void 0;const h=Ut(),e=ma(),t=Rt(),s=_i(),i=Gt();class a extends e.Shape{_sceneFunc(r){const l=this.cornerRadius(),u=this.width(),f=this.height();r.beginPath(),l?s.Util.drawRoundedRectPath(r,u,f,l):r.rect(0,0,u,f),r.closePath(),r.fillStrokeShape(this)}}return wS.Rect=a,a.prototype.className="Rect",(0,t._registerNode)(a),h.Factory.addGetterSetter(a,"cornerRadius",0,(0,i.getNumberOrArrayOfNumbersValidator)(4)),wS}var RS={},m5;function Eoe(){if(m5)return RS;m5=1,Object.defineProperty(RS,"__esModule",{value:!0}),RS.RegularPolygon=void 0;const h=Ut(),e=ma(),t=Gt(),s=Rt();let i=class extends e.Shape{_sceneFunc(n){const r=this._getPoints();n.beginPath(),n.moveTo(r[0].x,r[0].y);for(let l=1;l<r.length;l++)n.lineTo(r[l].x,r[l].y);n.closePath(),n.fillStrokeShape(this)}_getPoints(){const n=this.attrs.sides,r=this.attrs.radius||0,l=[];for(let u=0;u<n;u++)l.push({x:r*Math.sin(u*2*Math.PI/n),y:-1*r*Math.cos(u*2*Math.PI/n)});return l}getSelfRect(){const n=this._getPoints();let r=n[0].x,l=n[0].y,u=n[0].x,f=n[0].y;return n.forEach(_=>{r=Math.min(r,_.x),l=Math.max(l,_.x),u=Math.min(u,_.y),f=Math.max(f,_.y)}),{x:r,y:u,width:l-r,height:f-u}}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(n){this.radius(n/2)}setHeight(n){this.radius(n/2)}};return RS.RegularPolygon=i,i.prototype.className="RegularPolygon",i.prototype._centroid=!0,i.prototype._attrsAffectingSize=["radius"],(0,s._registerNode)(i),h.Factory.addGetterSetter(i,"radius",0,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(i,"sides",0,(0,t.getNumberValidator)()),RS}var MS={},_5;function Aoe(){if(_5)return MS;_5=1,Object.defineProperty(MS,"__esModule",{value:!0}),MS.Ring=void 0;const h=Ut(),e=ma(),t=Gt(),s=Rt(),i=Math.PI*2;let a=class extends e.Shape{_sceneFunc(r){r.beginPath(),r.arc(0,0,this.innerRadius(),0,i,!1),r.moveTo(this.outerRadius(),0),r.arc(0,0,this.outerRadius(),i,0,!0),r.closePath(),r.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(r){this.outerRadius(r/2)}setHeight(r){this.outerRadius(r/2)}};return MS.Ring=a,a.prototype.className="Ring",a.prototype._centroid=!0,a.prototype._attrsAffectingSize=["innerRadius","outerRadius"],(0,s._registerNode)(a),h.Factory.addGetterSetter(a,"innerRadius",0,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(a,"outerRadius",0,(0,t.getNumberValidator)()),MS}var DS={},g5;function Coe(){if(g5)return DS;g5=1,Object.defineProperty(DS,"__esModule",{value:!0}),DS.Sprite=void 0;const h=Ut(),e=ma(),t=CL(),s=Gt(),i=Rt();let a=class extends e.Shape{constructor(r){super(r),this._updated=!0,this.anim=new t.Animation(()=>{const l=this._updated;return this._updated=!1,l}),this.on("animationChange.konva",function(){this.frameIndex(0)}),this.on("frameIndexChange.konva",function(){this._updated=!0}),this.on("frameRateChange.konva",function(){this.anim.isRunning()&&(clearInterval(this.interval),this._setInterval())})}_sceneFunc(r){const l=this.animation(),u=this.frameIndex(),f=u*4,_=this.animations()[l],g=this.frameOffsets(),y=_[f+0],v=_[f+1],x=_[f+2],C=_[f+3],M=this.image();if((this.hasFill()||this.hasStroke())&&(r.beginPath(),r.rect(0,0,x,C),r.closePath(),r.fillStrokeShape(this)),M)if(g){const w=g[l],T=u*2;r.drawImage(M,y,v,x,C,w[T+0],w[T+1],x,C)}else r.drawImage(M,y,v,x,C,0,0,x,C)}_hitFunc(r){const l=this.animation(),u=this.frameIndex(),f=u*4,_=this.animations()[l],g=this.frameOffsets(),y=_[f+2],v=_[f+3];if(r.beginPath(),g){const x=g[l],C=u*2;r.rect(x[C+0],x[C+1],y,v)}else r.rect(0,0,y,v);r.closePath(),r.fillShape(this)}_useBufferCanvas(){return super._useBufferCanvas(!0)}_setInterval(){const r=this;this.interval=setInterval(function(){r._updateIndex()},1e3/this.frameRate())}start(){if(this.isRunning())return;const r=this.getLayer();this.anim.setLayers(r),this._setInterval(),this.anim.start()}stop(){this.anim.stop(),clearInterval(this.interval)}isRunning(){return this.anim.isRunning()}_updateIndex(){const r=this.frameIndex(),l=this.animation(),u=this.animations(),f=u[l],_=f.length/4;r<_-1?this.frameIndex(r+1):this.frameIndex(0)}};return DS.Sprite=a,a.prototype.className="Sprite",(0,i._registerNode)(a),h.Factory.addGetterSetter(a,"animation"),h.Factory.addGetterSetter(a,"animations"),h.Factory.addGetterSetter(a,"frameOffsets"),h.Factory.addGetterSetter(a,"image"),h.Factory.addGetterSetter(a,"frameIndex",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(a,"frameRate",17,(0,s.getNumberValidator)()),h.Factory.backCompat(a,{index:"frameIndex",getIndex:"getFrameIndex",setIndex:"setFrameIndex"}),DS}var PS={},y5;function woe(){if(y5)return PS;y5=1,Object.defineProperty(PS,"__esModule",{value:!0}),PS.Star=void 0;const h=Ut(),e=ma(),t=Gt(),s=Rt();let i=class extends e.Shape{_sceneFunc(n){const r=this.innerRadius(),l=this.outerRadius(),u=this.numPoints();n.beginPath(),n.moveTo(0,0-l);for(let f=1;f<u*2;f++){const _=f%2===0?l:r,g=_*Math.sin(f*Math.PI/u),y=-1*_*Math.cos(f*Math.PI/u);n.lineTo(g,y)}n.closePath(),n.fillStrokeShape(this)}getWidth(){return this.outerRadius()*2}getHeight(){return this.outerRadius()*2}setWidth(n){this.outerRadius(n/2)}setHeight(n){this.outerRadius(n/2)}};return PS.Star=i,i.prototype.className="Star",i.prototype._centroid=!0,i.prototype._attrsAffectingSize=["innerRadius","outerRadius"],(0,s._registerNode)(i),h.Factory.addGetterSetter(i,"numPoints",5,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(i,"innerRadius",0,(0,t.getNumberValidator)()),h.Factory.addGetterSetter(i,"outerRadius",0,(0,t.getNumberValidator)()),PS}var Pg={},v5;function tk(){if(v5)return Pg;v5=1,Object.defineProperty(Pg,"__esModule",{value:!0}),Pg.Text=void 0,Pg.stringToArray=n;const h=_i(),e=Ut(),t=ma(),s=Rt(),i=Gt(),a=Rt();function n(se){return[...se].reduce((J,ie,oe,he)=>{if(new RegExp("\\p{Emoji}","u").test(ie)){const te=he[oe+1];te&&new RegExp("\\p{Emoji_Modifier}|\\u200D","u").test(te)?(J.push(ie+te),he[oe+1]=""):J.push(ie)}else new RegExp("\\p{Regional_Indicator}{2}","u").test(ie+(he[oe+1]||""))?J.push(ie+he[oe+1]):oe>0&&new RegExp("\\p{Mn}|\\p{Me}|\\p{Mc}","u").test(ie)?J[J.length-1]+=ie:ie&&J.push(ie);return J},[])}const r="auto",l="center",u="inherit",f="justify",_="Change.konva",g="2d",y="-",v="left",x="text",C="Text",M="top",w="bottom",T="middle",R="normal",D="px ",I=" ",U="right",O="rtl",N="word",z="char",X="none",Y="…",F=["direction","fontFamily","fontSize","fontStyle","fontVariant","padding","align","verticalAlign","lineHeight","text","width","height","wrap","ellipsis","letterSpacing"],q=F.length;function G(se){return se.split(",").map(J=>{J=J.trim();const ie=J.indexOf(" ")>=0,oe=J.indexOf('"')>=0||J.indexOf("'")>=0;return ie&&!oe&&(J=`"${J}"`),J}).join(", ")}let W;function k(){return W||(W=h.Util.createCanvasElement().getContext(g),W)}function K(se){se.fillText(this._partialText,this._partialTextX,this._partialTextY)}function ee(se){se.setAttr("miterLimit",2),se.strokeText(this._partialText,this._partialTextX,this._partialTextY)}function V(se){return se=se||{},!se.fillLinearGradientColorStops&&!se.fillRadialGradientColorStops&&!se.fillPatternImage&&(se.fill=se.fill||"black"),se}let Q=class extends t.Shape{constructor(J){super(V(J)),this._partialTextX=0,this._partialTextY=0;for(let ie=0;ie<q;ie++)this.on(F[ie]+_,this._setTextData);this._setTextData()}_sceneFunc(J){const ie=this.textArr,oe=ie.length;if(!this.text())return;let he=this.padding(),te=this.fontSize(),le=this.lineHeight()*te,Se=this.verticalAlign(),Ae=this.direction(),De=0,Fe=this.align(),ot=this.getWidth(),mt=this.letterSpacing(),$e=this.fill(),es=this.textDecoration(),ht=es.indexOf("underline")!==-1,Pe=es.indexOf("line-through")!==-1,Zi;Ae=Ae===u?J.direction:Ae;let zs=le/2,oi=T;if(s.Konva._fixTextRendering){const sn=this.measureSize("M");oi="alphabetic",zs=(sn.fontBoundingBoxAscent-sn.fontBoundingBoxDescent)/2+le/2}var lt=0,ti=0;for(Ae===O&&J.setAttr("direction",Ae),J.setAttr("font",this._getContextFont()),J.setAttr("textBaseline",oi),J.setAttr("textAlign",v),Se===T?De=(this.getHeight()-oe*le-he*2)/2:Se===w&&(De=this.getHeight()-oe*le-he*2),J.translate(he,De+he),Zi=0;Zi<oe;Zi++){var lt=0,ti=0,js=ie[Zi],Ys=js.text,Xe=js.width,Mt=js.lastInParagraph,rs,bs;if(J.save(),Fe===U?lt+=ot-Xe-he*2:Fe===l&&(lt+=(ot-Xe-he*2)/2),ht){J.save(),J.beginPath();const Hi=s.Konva._fixTextRendering?Math.round(te/4):Math.round(te/2),Wi=lt,Ji=zs+ti+Hi;J.moveTo(Wi,Ji),rs=Ys.split(" ").length-1,bs=Fe===f&&!Mt?ot-he*2:Xe,J.lineTo(Wi+Math.round(bs),Ji),J.lineWidth=te/15;const an=this._getLinearGradient();J.strokeStyle=an||$e,J.stroke(),J.restore()}if(Pe){J.save(),J.beginPath();const Hi=s.Konva._fixTextRendering?-Math.round(te/4):0;J.moveTo(lt,zs+ti+Hi),rs=Ys.split(" ").length-1,bs=Fe===f&&!Mt?ot-he*2:Xe,J.lineTo(lt+Math.round(bs),zs+ti+Hi),J.lineWidth=te/15;const Wi=this._getLinearGradient();J.strokeStyle=Wi||$e,J.stroke(),J.restore()}if(Ae!==O&&(mt!==0||Fe===f)){rs=Ys.split(" ").length-1;const Hi=n(Ys);for(let Wi=0;Wi<Hi.length;Wi++){const Ji=Hi[Wi];Ji===" "&&!Mt&&Fe===f&&(lt+=(ot-he*2-Xe)/rs),this._partialTextX=lt,this._partialTextY=zs+ti,this._partialText=Ji,J.fillStrokeShape(this),lt+=this.measureSize(Ji).width+mt}}else mt!==0&&J.setAttr("letterSpacing",`${mt}px`),this._partialTextX=lt,this._partialTextY=zs+ti,this._partialText=Ys,J.fillStrokeShape(this);J.restore(),oe>1&&(zs+=le)}}_hitFunc(J){const ie=this.getWidth(),oe=this.getHeight();J.beginPath(),J.rect(0,0,ie,oe),J.closePath(),J.fillStrokeShape(this)}setText(J){const ie=h.Util._isString(J)?J:J==null?"":J+"";return this._setAttr(x,ie),this}getWidth(){return this.attrs.width===r||this.attrs.width===void 0?this.getTextWidth()+this.padding()*2:this.attrs.width}getHeight(){return this.attrs.height===r||this.attrs.height===void 0?this.fontSize()*this.textArr.length*this.lineHeight()+this.padding()*2:this.attrs.height}getTextWidth(){return this.textWidth}getTextHeight(){return h.Util.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}measureSize(J){var ie,oe,he,te,le,Se,Ae,De,Fe,ot,mt;let $e=k(),es=this.fontSize(),ht;$e.save(),$e.font=this._getContextFont(),ht=$e.measureText(J),$e.restore();const Pe=es/100;return{actualBoundingBoxAscent:(ie=ht.actualBoundingBoxAscent)!==null&&ie!==void 0?ie:71.58203125*Pe,actualBoundingBoxDescent:(oe=ht.actualBoundingBoxDescent)!==null&&oe!==void 0?oe:0,actualBoundingBoxLeft:(he=ht.actualBoundingBoxLeft)!==null&&he!==void 0?he:-7.421875*Pe,actualBoundingBoxRight:(te=ht.actualBoundingBoxRight)!==null&&te!==void 0?te:75.732421875*Pe,alphabeticBaseline:(le=ht.alphabeticBaseline)!==null&&le!==void 0?le:0,emHeightAscent:(Se=ht.emHeightAscent)!==null&&Se!==void 0?Se:100*Pe,emHeightDescent:(Ae=ht.emHeightDescent)!==null&&Ae!==void 0?Ae:-20*Pe,fontBoundingBoxAscent:(De=ht.fontBoundingBoxAscent)!==null&&De!==void 0?De:91*Pe,fontBoundingBoxDescent:(Fe=ht.fontBoundingBoxDescent)!==null&&Fe!==void 0?Fe:21*Pe,hangingBaseline:(ot=ht.hangingBaseline)!==null&&ot!==void 0?ot:72.80000305175781*Pe,ideographicBaseline:(mt=ht.ideographicBaseline)!==null&&mt!==void 0?mt:-21*Pe,width:ht.width,height:es}}_getContextFont(){return this.fontStyle()+I+this.fontVariant()+I+(this.fontSize()+D)+G(this.fontFamily())}_addTextLine(J){this.align()===f&&(J=J.trim());const oe=this._getTextWidth(J);return this.textArr.push({text:J,width:oe,lastInParagraph:!1})}_getTextWidth(J){const ie=this.letterSpacing(),oe=J.length;return k().measureText(J).width+ie*oe}_setTextData(){let J=this.text().split(`
`),ie=+this.fontSize(),oe=0,he=this.lineHeight()*ie,te=this.attrs.width,le=this.attrs.height,Se=te!==r&&te!==void 0,Ae=le!==r&&le!==void 0,De=this.padding(),Fe=te-De*2,ot=le-De*2,mt=0,$e=this.wrap(),es=$e!==X,ht=$e!==z&&es,Pe=this.ellipsis();this.textArr=[],k().font=this._getContextFont();const Zi=Pe?this._getTextWidth(Y):0;for(let zs=0,oi=J.length;zs<oi;++zs){let lt=J[zs],ti=this._getTextWidth(lt);if(Se&&ti>Fe)for(;lt.length>0;){let js=0,Ys=n(lt).length,Xe="",Mt=0;for(;js<Ys;){const rs=js+Ys>>>1,bs=n(lt),sn=bs.slice(0,rs+1).join(""),La=this._getTextWidth(sn);(Pe&&Ae&&mt+he>ot?La+Zi:La)<=Fe?(js=rs+1,Xe=sn,Mt=La):Ys=rs}if(Xe){if(ht){const sn=n(lt),La=n(Xe),Hi=sn[La.length],Wi=Hi===I||Hi===y;let Ji;if(Wi&&Mt<=Fe)Ji=La.length;else{const an=La.lastIndexOf(I),su=La.lastIndexOf(y);Ji=Math.max(an,su)+1}Ji>0&&(js=Ji,Xe=sn.slice(0,js).join(""),Mt=this._getTextWidth(Xe))}if(Xe=Xe.trimRight(),this._addTextLine(Xe),oe=Math.max(oe,Mt),mt+=he,this._shouldHandleEllipsis(mt)){this._tryToAddEllipsisToLastLine();break}if(lt=n(lt).slice(js).join("").trimLeft(),lt.length>0&&(ti=this._getTextWidth(lt),ti<=Fe)){this._addTextLine(lt),mt+=he,oe=Math.max(oe,ti);break}}else break}else this._addTextLine(lt),mt+=he,oe=Math.max(oe,ti),this._shouldHandleEllipsis(mt)&&zs<oi-1&&this._tryToAddEllipsisToLastLine();if(this.textArr[this.textArr.length-1]&&(this.textArr[this.textArr.length-1].lastInParagraph=!0),Ae&&mt+he>ot)break}this.textHeight=ie,this.textWidth=oe}_shouldHandleEllipsis(J){const ie=+this.fontSize(),oe=this.lineHeight()*ie,he=this.attrs.height,te=he!==r&&he!==void 0,le=this.padding(),Se=he-le*2;return!(this.wrap()!==X)||te&&J+oe>Se}_tryToAddEllipsisToLastLine(){const J=this.attrs.width,ie=J!==r&&J!==void 0,oe=this.padding(),he=J-oe*2,te=this.ellipsis(),le=this.textArr[this.textArr.length-1];!le||!te||(ie&&(this._getTextWidth(le.text+Y)<he||(le.text=le.text.slice(0,le.text.length-3))),this.textArr.splice(this.textArr.length-1,1),this._addTextLine(le.text+Y))}getStrokeScaleEnabled(){return!0}_useBufferCanvas(){const J=this.textDecoration().indexOf("underline")!==-1||this.textDecoration().indexOf("line-through")!==-1,ie=this.hasShadow();return J&&ie?!0:super._useBufferCanvas()}};return Pg.Text=Q,Q.prototype._fillFunc=K,Q.prototype._strokeFunc=ee,Q.prototype.className=C,Q.prototype._attrsAffectingSize=["text","fontSize","padding","wrap","lineHeight","letterSpacing"],(0,a._registerNode)(Q),e.Factory.overWriteSetter(Q,"width",(0,i.getNumberOrAutoValidator)()),e.Factory.overWriteSetter(Q,"height",(0,i.getNumberOrAutoValidator)()),e.Factory.addGetterSetter(Q,"direction",u),e.Factory.addGetterSetter(Q,"fontFamily","Arial"),e.Factory.addGetterSetter(Q,"fontSize",12,(0,i.getNumberValidator)()),e.Factory.addGetterSetter(Q,"fontStyle",R),e.Factory.addGetterSetter(Q,"fontVariant",R),e.Factory.addGetterSetter(Q,"padding",0,(0,i.getNumberValidator)()),e.Factory.addGetterSetter(Q,"align",v),e.Factory.addGetterSetter(Q,"verticalAlign",M),e.Factory.addGetterSetter(Q,"lineHeight",1,(0,i.getNumberValidator)()),e.Factory.addGetterSetter(Q,"wrap",N),e.Factory.addGetterSetter(Q,"ellipsis",!1,(0,i.getBooleanValidator)()),e.Factory.addGetterSetter(Q,"letterSpacing",0,(0,i.getNumberValidator)()),e.Factory.addGetterSetter(Q,"text","",(0,i.getStringValidator)()),e.Factory.addGetterSetter(Q,"textDecoration",""),Pg}var LS={},S5;function Roe(){if(S5)return LS;S5=1,Object.defineProperty(LS,"__esModule",{value:!0}),LS.TextPath=void 0;const h=_i(),e=Ut(),t=ma(),s=wL(),i=tk(),a=Gt(),n=Rt(),r="",l="normal";function u(g){g.fillText(this.partialText,0,0)}function f(g){g.strokeText(this.partialText,0,0)}let _=class extends t.Shape{constructor(y){super(y),this.dummyCanvas=h.Util.createCanvasElement(),this.dataArray=[],this._readDataAttribute(),this.on("dataChange.konva",function(){this._readDataAttribute(),this._setTextData()}),this.on("textChange.konva alignChange.konva letterSpacingChange.konva kerningFuncChange.konva fontSizeChange.konva fontFamilyChange.konva",this._setTextData),this._setTextData()}_getTextPathLength(){return s.Path.getPathLength(this.dataArray)}_getPointAtLength(y){if(!this.attrs.data)return null;const v=this.pathLength;return y-1>v?null:s.Path.getPointAtLengthOfDataArray(y,this.dataArray)}_readDataAttribute(){this.dataArray=s.Path.parsePathData(this.attrs.data),this.pathLength=this._getTextPathLength()}_sceneFunc(y){y.setAttr("font",this._getContextFont()),y.setAttr("textBaseline",this.textBaseline()),y.setAttr("textAlign","left"),y.save();const v=this.textDecoration(),x=this.fill(),C=this.fontSize(),M=this.glyphInfo;v==="underline"&&y.beginPath();for(let w=0;w<M.length;w++){y.save();const T=M[w].p0;y.translate(T.x,T.y),y.rotate(M[w].rotation),this.partialText=M[w].text,y.fillStrokeShape(this),v==="underline"&&(w===0&&y.moveTo(0,C/2+1),y.lineTo(C,C/2+1)),y.restore()}v==="underline"&&(y.strokeStyle=x,y.lineWidth=C/20,y.stroke()),y.restore()}_hitFunc(y){y.beginPath();const v=this.glyphInfo;if(v.length>=1){const x=v[0].p0;y.moveTo(x.x,x.y)}for(let x=0;x<v.length;x++){const C=v[x].p1;y.lineTo(C.x,C.y)}y.setAttr("lineWidth",this.fontSize()),y.setAttr("strokeStyle",this.colorKey),y.stroke()}getTextWidth(){return this.textWidth}getTextHeight(){return h.Util.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}setText(y){return i.Text.prototype.setText.call(this,y)}_getContextFont(){return i.Text.prototype._getContextFont.call(this)}_getTextSize(y){const x=this.dummyCanvas.getContext("2d");x.save(),x.font=this._getContextFont();const C=x.measureText(y);return x.restore(),{width:C.width,height:parseInt(`${this.fontSize()}`,10)}}_setTextData(){const{width:y,height:v}=this._getTextSize(this.attrs.text);if(this.textWidth=y,this.textHeight=v,this.glyphInfo=[],!this.attrs.data)return null;const x=this.letterSpacing(),C=this.align(),M=this.kerningFunc(),w=Math.max(this.textWidth+((this.attrs.text||"").length-1)*x,0);let T=0;C==="center"&&(T=Math.max(0,this.pathLength/2-w/2)),C==="right"&&(T=Math.max(0,this.pathLength-w));const R=(0,i.stringToArray)(this.text());let D=T;for(let I=0;I<R.length;I++){const U=this._getPointAtLength(D);if(!U)return;let O=this._getTextSize(R[I]).width+x;if(R[I]===" "&&C==="justify"){const q=this.text().split(" ").length-1;O+=(this.pathLength-w)/q}const N=this._getPointAtLength(D+O);if(!N)return;const z=s.Path.getLineLength(U.x,U.y,N.x,N.y);let X=0;if(M)try{X=M(R[I-1],R[I])*this.fontSize()}catch{X=0}U.x+=X,N.x+=X,this.textWidth+=X;const Y=s.Path.getPointOnLine(X+z/2,U.x,U.y,N.x,N.y),F=Math.atan2(N.y-U.y,N.x-U.x);this.glyphInfo.push({transposeX:Y.x,transposeY:Y.y,text:R[I],rotation:F,p0:U,p1:N}),D+=O}}getSelfRect(){if(!this.glyphInfo.length)return{x:0,y:0,width:0,height:0};const y=[];this.glyphInfo.forEach(function(D){y.push(D.p0.x),y.push(D.p0.y),y.push(D.p1.x),y.push(D.p1.y)});let v=y[0]||0,x=y[0]||0,C=y[1]||0,M=y[1]||0,w,T;for(let D=0;D<y.length/2;D++)w=y[D*2],T=y[D*2+1],v=Math.min(v,w),x=Math.max(x,w),C=Math.min(C,T),M=Math.max(M,T);const R=this.fontSize();return{x:v-R/2,y:C-R/2,width:x-v+R,height:M-C+R}}destroy(){return h.Util.releaseCanvas(this.dummyCanvas),super.destroy()}};return LS.TextPath=_,_.prototype._fillFunc=u,_.prototype._strokeFunc=f,_.prototype._fillFuncHit=u,_.prototype._strokeFuncHit=f,_.prototype.className="TextPath",_.prototype._attrsAffectingSize=["text","fontSize","data"],(0,n._registerNode)(_),e.Factory.addGetterSetter(_,"data"),e.Factory.addGetterSetter(_,"fontFamily","Arial"),e.Factory.addGetterSetter(_,"fontSize",12,(0,a.getNumberValidator)()),e.Factory.addGetterSetter(_,"fontStyle",l),e.Factory.addGetterSetter(_,"align","left"),e.Factory.addGetterSetter(_,"letterSpacing",0,(0,a.getNumberValidator)()),e.Factory.addGetterSetter(_,"textBaseline","middle"),e.Factory.addGetterSetter(_,"fontVariant",l),e.Factory.addGetterSetter(_,"text",r),e.Factory.addGetterSetter(_,"textDecoration",""),e.Factory.addGetterSetter(_,"kerningFunc",void 0),LS}var IS={},b5;function Moe(){if(b5)return IS;b5=1,Object.defineProperty(IS,"__esModule",{value:!0}),IS.Transformer=void 0;const h=_i(),e=Ut(),t=Mi(),s=ma(),i=ek(),a=AL(),n=Rt(),r=Gt(),l=Rt(),u="tr-konva",f=["resizeEnabledChange","rotateAnchorOffsetChange","rotateEnabledChange","enabledAnchorsChange","anchorSizeChange","borderEnabledChange","borderStrokeChange","borderStrokeWidthChange","borderDashChange","anchorStrokeChange","anchorStrokeWidthChange","anchorFillChange","anchorCornerRadiusChange","ignoreStrokeChange","anchorStyleFuncChange"].map(O=>O+`.${u}`).join(" "),_="nodesRect",g=["widthChange","heightChange","scaleXChange","scaleYChange","skewXChange","skewYChange","rotationChange","offsetXChange","offsetYChange","transformsEnabledChange","strokeWidthChange"],y={"top-left":-45,"top-center":0,"top-right":45,"middle-right":-90,"middle-left":90,"bottom-left":-135,"bottom-center":180,"bottom-right":135},v="ontouchstart"in n.Konva._global;function x(O,N,z){if(O==="rotater")return z;N+=h.Util.degToRad(y[O]||0);const X=(h.Util.radToDeg(N)%360+360)%360;return h.Util._inRange(X,315+22.5,360)||h.Util._inRange(X,0,22.5)?"ns-resize":h.Util._inRange(X,45-22.5,45+22.5)?"nesw-resize":h.Util._inRange(X,90-22.5,90+22.5)?"ew-resize":h.Util._inRange(X,135-22.5,135+22.5)?"nwse-resize":h.Util._inRange(X,180-22.5,180+22.5)?"ns-resize":h.Util._inRange(X,225-22.5,225+22.5)?"nesw-resize":h.Util._inRange(X,270-22.5,270+22.5)?"ew-resize":h.Util._inRange(X,315-22.5,315+22.5)?"nwse-resize":(h.Util.error("Transformer has unknown angle for cursor detection: "+X),"pointer")}const C=["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"];function M(O){return{x:O.x+O.width/2*Math.cos(O.rotation)+O.height/2*Math.sin(-O.rotation),y:O.y+O.height/2*Math.cos(O.rotation)+O.width/2*Math.sin(O.rotation)}}function w(O,N,z){const X=z.x+(O.x-z.x)*Math.cos(N)-(O.y-z.y)*Math.sin(N),Y=z.y+(O.x-z.x)*Math.sin(N)+(O.y-z.y)*Math.cos(N);return{...O,rotation:O.rotation+N,x:X,y:Y}}function T(O,N){const z=M(O);return w(O,N,z)}function R(O,N,z){let X=N;for(let Y=0;Y<O.length;Y++){const F=n.Konva.getAngle(O[Y]),q=Math.abs(F-N)%(Math.PI*2);Math.min(q,Math.PI*2-q)<z&&(X=F)}return X}let D=0,I=class extends a.Group{constructor(N){super(N),this._movingAnchorName=null,this._transforming=!1,this._createElements(),this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.update=this.update.bind(this),this.on(f,this.update),this.getNode()&&this.update()}attachTo(N){return this.setNode(N),this}setNode(N){return h.Util.warn("tr.setNode(shape), tr.node(shape) and tr.attachTo(shape) methods are deprecated. Please use tr.nodes(nodesArray) instead."),this.setNodes([N])}getNode(){return this._nodes&&this._nodes[0]}_getEventNamespace(){return u+this._id}setNodes(N=[]){this._nodes&&this._nodes.length&&this.detach();const z=N.filter(Y=>Y.isAncestorOf(this)?(h.Util.error("Konva.Transformer cannot be an a child of the node you are trying to attach"),!1):!0);return this._nodes=N=z,N.length===1&&this.useSingleNodeRotation()?this.rotation(N[0].getAbsoluteRotation()):this.rotation(0),this._nodes.forEach(Y=>{const F=()=>{this.nodes().length===1&&this.useSingleNodeRotation()&&this.rotation(this.nodes()[0].getAbsoluteRotation()),this._resetTransformCache(),!this._transforming&&!this.isDragging()&&this.update()};if(Y._attrsAffectingSize.length){const q=Y._attrsAffectingSize.map(G=>G+"Change."+this._getEventNamespace()).join(" ");Y.on(q,F)}Y.on(g.map(q=>q+`.${this._getEventNamespace()}`).join(" "),F),Y.on(`absoluteTransformChange.${this._getEventNamespace()}`,F),this._proxyDrag(Y)}),this._resetTransformCache(),!!this.findOne(".top-left")&&this.update(),this}_proxyDrag(N){let z;N.on(`dragstart.${this._getEventNamespace()}`,X=>{z=N.getAbsolutePosition(),!this.isDragging()&&N!==this.findOne(".back")&&this.startDrag(X,!1)}),N.on(`dragmove.${this._getEventNamespace()}`,X=>{if(!z)return;const Y=N.getAbsolutePosition(),F=Y.x-z.x,q=Y.y-z.y;this.nodes().forEach(G=>{if(G===N||G.isDragging())return;const W=G.getAbsolutePosition();G.setAbsolutePosition({x:W.x+F,y:W.y+q}),G.startDrag(X)}),z=null})}getNodes(){return this._nodes||[]}getActiveAnchor(){return this._movingAnchorName}detach(){this._nodes&&this._nodes.forEach(N=>{N.off("."+this._getEventNamespace())}),this._nodes=[],this._resetTransformCache()}_resetTransformCache(){this._clearCache(_),this._clearCache("transform"),this._clearSelfAndDescendantCache("absoluteTransform")}_getNodeRect(){return this._getCache(_,this.__getNodeRect)}__getNodeShape(N,z=this.rotation(),X){const Y=N.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),F=N.getAbsoluteScale(X),q=N.getAbsolutePosition(X),G=Y.x*F.x-N.offsetX()*F.x,W=Y.y*F.y-N.offsetY()*F.y,k=(n.Konva.getAngle(N.getAbsoluteRotation())+Math.PI*2)%(Math.PI*2),K={x:q.x+G*Math.cos(k)+W*Math.sin(-k),y:q.y+W*Math.cos(k)+G*Math.sin(k),width:Y.width*F.x,height:Y.height*F.y,rotation:k};return w(K,-n.Konva.getAngle(z),{x:0,y:0})}__getNodeRect(){if(!this.getNode())return{x:-1e8,y:-1e8,width:0,height:0,rotation:0};const z=[];this.nodes().map(k=>{const K=k.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),ee=[{x:K.x,y:K.y},{x:K.x+K.width,y:K.y},{x:K.x+K.width,y:K.y+K.height},{x:K.x,y:K.y+K.height}],V=k.getAbsoluteTransform();ee.forEach(function(Q){const se=V.point(Q);z.push(se)})});const X=new h.Transform;X.rotate(-n.Konva.getAngle(this.rotation()));let Y=1/0,F=1/0,q=-1/0,G=-1/0;z.forEach(function(k){const K=X.point(k);Y===void 0&&(Y=q=K.x,F=G=K.y),Y=Math.min(Y,K.x),F=Math.min(F,K.y),q=Math.max(q,K.x),G=Math.max(G,K.y)}),X.invert();const W=X.point({x:Y,y:F});return{x:W.x,y:W.y,width:q-Y,height:G-F,rotation:n.Konva.getAngle(this.rotation())}}getX(){return this._getNodeRect().x}getY(){return this._getNodeRect().y}getWidth(){return this._getNodeRect().width}getHeight(){return this._getNodeRect().height}_createElements(){this._createBack(),C.forEach(N=>{this._createAnchor(N)}),this._createAnchor("rotater")}_createAnchor(N){const z=new i.Rect({stroke:"rgb(0, 161, 255)",fill:"white",strokeWidth:1,name:N+" _anchor",dragDistance:0,draggable:!0,hitStrokeWidth:v?10:"auto"}),X=this;z.on("mousedown touchstart",function(Y){X._handleMouseDown(Y)}),z.on("dragstart",Y=>{z.stopDrag(),Y.cancelBubble=!0}),z.on("dragend",Y=>{Y.cancelBubble=!0}),z.on("mouseenter",()=>{const Y=n.Konva.getAngle(this.rotation()),F=this.rotateAnchorCursor(),q=x(N,Y,F);z.getStage().content&&(z.getStage().content.style.cursor=q),this._cursorChange=!0}),z.on("mouseout",()=>{z.getStage().content&&(z.getStage().content.style.cursor=""),this._cursorChange=!1}),this.add(z)}_createBack(){const N=new s.Shape({name:"back",width:0,height:0,draggable:!0,sceneFunc(z,X){const Y=X.getParent(),F=Y.padding();z.beginPath(),z.rect(-F,-F,X.width()+F*2,X.height()+F*2),z.moveTo(X.width()/2,-F),Y.rotateEnabled()&&Y.rotateLineVisible()&&z.lineTo(X.width()/2,-Y.rotateAnchorOffset()*h.Util._sign(X.height())-F),z.fillStrokeShape(X)},hitFunc:(z,X)=>{if(!this.shouldOverdrawWholeArea())return;const Y=this.padding();z.beginPath(),z.rect(-Y,-Y,X.width()+Y*2,X.height()+Y*2),z.fillStrokeShape(X)}});this.add(N),this._proxyDrag(N),N.on("dragstart",z=>{z.cancelBubble=!0}),N.on("dragmove",z=>{z.cancelBubble=!0}),N.on("dragend",z=>{z.cancelBubble=!0}),this.on("dragmove",z=>{this.update()})}_handleMouseDown(N){if(this._transforming)return;this._movingAnchorName=N.target.name().split(" ")[0];const z=this._getNodeRect(),X=z.width,Y=z.height,F=Math.sqrt(Math.pow(X,2)+Math.pow(Y,2));this.sin=Math.abs(Y/F),this.cos=Math.abs(X/F),typeof window<"u"&&(window.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("touchmove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp,!0),window.addEventListener("touchend",this._handleMouseUp,!0)),this._transforming=!0;const q=N.target.getAbsolutePosition(),G=N.target.getStage().getPointerPosition();this._anchorDragOffset={x:G.x-q.x,y:G.y-q.y},D++,this._fire("transformstart",{evt:N.evt,target:this.getNode()}),this._nodes.forEach(W=>{W._fire("transformstart",{evt:N.evt,target:W})})}_handleMouseMove(N){let z,X,Y;const F=this.findOne("."+this._movingAnchorName),q=F.getStage();q.setPointersPositions(N);const G=q.getPointerPosition();let W={x:G.x-this._anchorDragOffset.x,y:G.y-this._anchorDragOffset.y};const k=F.getAbsolutePosition();this.anchorDragBoundFunc()&&(W=this.anchorDragBoundFunc()(k,W,N)),F.setAbsolutePosition(W);const K=F.getAbsolutePosition();if(k.x===K.x&&k.y===K.y)return;if(this._movingAnchorName==="rotater"){const Se=this._getNodeRect();z=F.x()-Se.width/2,X=-F.y()+Se.height/2;let Ae=Math.atan2(-X,z)+Math.PI/2;Se.height<0&&(Ae-=Math.PI);const Fe=n.Konva.getAngle(this.rotation())+Ae,ot=n.Konva.getAngle(this.rotationSnapTolerance()),$e=R(this.rotationSnaps(),Fe,ot)-Se.rotation,es=T(Se,$e);this._fitNodesInto(es,N);return}const ee=this.shiftBehavior();let V;ee==="inverted"?V=this.keepRatio()&&!N.shiftKey:ee==="none"?V=this.keepRatio():V=this.keepRatio()||N.shiftKey;var oe=this.centeredScaling()||N.altKey;if(this._movingAnchorName==="top-left"){if(V){var Q=oe?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-right").x(),y:this.findOne(".bottom-right").y()};Y=Math.sqrt(Math.pow(Q.x-F.x(),2)+Math.pow(Q.y-F.y(),2));var se=this.findOne(".top-left").x()>Q.x?-1:1,J=this.findOne(".top-left").y()>Q.y?-1:1;z=Y*this.cos*se,X=Y*this.sin*J,this.findOne(".top-left").x(Q.x-z),this.findOne(".top-left").y(Q.y-X)}}else if(this._movingAnchorName==="top-center")this.findOne(".top-left").y(F.y());else if(this._movingAnchorName==="top-right"){if(V){var Q=oe?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-left").x(),y:this.findOne(".bottom-left").y()};Y=Math.sqrt(Math.pow(F.x()-Q.x,2)+Math.pow(Q.y-F.y(),2));var se=this.findOne(".top-right").x()<Q.x?-1:1,J=this.findOne(".top-right").y()>Q.y?-1:1;z=Y*this.cos*se,X=Y*this.sin*J,this.findOne(".top-right").x(Q.x+z),this.findOne(".top-right").y(Q.y-X)}var ie=F.position();this.findOne(".top-left").y(ie.y),this.findOne(".bottom-right").x(ie.x)}else if(this._movingAnchorName==="middle-left")this.findOne(".top-left").x(F.x());else if(this._movingAnchorName==="middle-right")this.findOne(".bottom-right").x(F.x());else if(this._movingAnchorName==="bottom-left"){if(V){var Q=oe?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-right").x(),y:this.findOne(".top-right").y()};Y=Math.sqrt(Math.pow(Q.x-F.x(),2)+Math.pow(F.y()-Q.y,2));var se=Q.x<F.x()?-1:1,J=F.y()<Q.y?-1:1;z=Y*this.cos*se,X=Y*this.sin*J,F.x(Q.x-z),F.y(Q.y+X)}ie=F.position(),this.findOne(".top-left").x(ie.x),this.findOne(".bottom-right").y(ie.y)}else if(this._movingAnchorName==="bottom-center")this.findOne(".bottom-right").y(F.y());else if(this._movingAnchorName==="bottom-right"){if(V){var Q=oe?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-left").x(),y:this.findOne(".top-left").y()};Y=Math.sqrt(Math.pow(F.x()-Q.x,2)+Math.pow(F.y()-Q.y,2));var se=this.findOne(".bottom-right").x()<Q.x?-1:1,J=this.findOne(".bottom-right").y()<Q.y?-1:1;z=Y*this.cos*se,X=Y*this.sin*J,this.findOne(".bottom-right").x(Q.x+z),this.findOne(".bottom-right").y(Q.y+X)}}else console.error(new Error("Wrong position argument of selection resizer: "+this._movingAnchorName));var oe=this.centeredScaling()||N.altKey;if(oe){const Se=this.findOne(".top-left"),Ae=this.findOne(".bottom-right"),De=Se.x(),Fe=Se.y(),ot=this.getWidth()-Ae.x(),mt=this.getHeight()-Ae.y();Ae.move({x:-De,y:-Fe}),Se.move({x:ot,y:mt})}const he=this.findOne(".top-left").getAbsolutePosition();z=he.x,X=he.y;const te=this.findOne(".bottom-right").x()-this.findOne(".top-left").x(),le=this.findOne(".bottom-right").y()-this.findOne(".top-left").y();this._fitNodesInto({x:z,y:X,width:te,height:le,rotation:n.Konva.getAngle(this.rotation())},N)}_handleMouseUp(N){this._removeEvents(N)}getAbsoluteTransform(){return this.getTransform()}_removeEvents(N){var z;if(this._transforming){this._transforming=!1,typeof window<"u"&&(window.removeEventListener("mousemove",this._handleMouseMove),window.removeEventListener("touchmove",this._handleMouseMove),window.removeEventListener("mouseup",this._handleMouseUp,!0),window.removeEventListener("touchend",this._handleMouseUp,!0));const X=this.getNode();D--,this._fire("transformend",{evt:N,target:X}),(z=this.getLayer())===null||z===void 0||z.batchDraw(),X&&this._nodes.forEach(Y=>{var F;Y._fire("transformend",{evt:N,target:Y}),(F=Y.getLayer())===null||F===void 0||F.batchDraw()}),this._movingAnchorName=null}}_fitNodesInto(N,z){const X=this._getNodeRect(),Y=1;if(h.Util._inRange(N.width,-this.padding()*2-Y,Y)){this.update();return}if(h.Util._inRange(N.height,-this.padding()*2-Y,Y)){this.update();return}const F=new h.Transform;if(F.rotate(n.Konva.getAngle(this.rotation())),this._movingAnchorName&&N.width<0&&this._movingAnchorName.indexOf("left")>=0){const V=F.point({x:-this.padding()*2,y:0});N.x+=V.x,N.y+=V.y,N.width+=this.padding()*2,this._movingAnchorName=this._movingAnchorName.replace("left","right"),this._anchorDragOffset.x-=V.x,this._anchorDragOffset.y-=V.y}else if(this._movingAnchorName&&N.width<0&&this._movingAnchorName.indexOf("right")>=0){const V=F.point({x:this.padding()*2,y:0});this._movingAnchorName=this._movingAnchorName.replace("right","left"),this._anchorDragOffset.x-=V.x,this._anchorDragOffset.y-=V.y,N.width+=this.padding()*2}if(this._movingAnchorName&&N.height<0&&this._movingAnchorName.indexOf("top")>=0){const V=F.point({x:0,y:-this.padding()*2});N.x+=V.x,N.y+=V.y,this._movingAnchorName=this._movingAnchorName.replace("top","bottom"),this._anchorDragOffset.x-=V.x,this._anchorDragOffset.y-=V.y,N.height+=this.padding()*2}else if(this._movingAnchorName&&N.height<0&&this._movingAnchorName.indexOf("bottom")>=0){const V=F.point({x:0,y:this.padding()*2});this._movingAnchorName=this._movingAnchorName.replace("bottom","top"),this._anchorDragOffset.x-=V.x,this._anchorDragOffset.y-=V.y,N.height+=this.padding()*2}if(this.boundBoxFunc()){const V=this.boundBoxFunc()(X,N);V?N=V:h.Util.warn("boundBoxFunc returned falsy. You should return new bound rect from it!")}const q=1e7,G=new h.Transform;G.translate(X.x,X.y),G.rotate(X.rotation),G.scale(X.width/q,X.height/q);const W=new h.Transform,k=N.width/q,K=N.height/q;this.flipEnabled()===!1?(W.translate(N.x,N.y),W.rotate(N.rotation),W.translate(N.width<0?N.width:0,N.height<0?N.height:0),W.scale(Math.abs(k),Math.abs(K))):(W.translate(N.x,N.y),W.rotate(N.rotation),W.scale(k,K));const ee=W.multiply(G.invert());this._nodes.forEach(V=>{var Q;const se=V.getParent().getAbsoluteTransform(),J=V.getTransform().copy();J.translate(V.offsetX(),V.offsetY());const ie=new h.Transform;ie.multiply(se.copy().invert()).multiply(ee).multiply(se).multiply(J);const oe=ie.decompose();V.setAttrs(oe),(Q=V.getLayer())===null||Q===void 0||Q.batchDraw()}),this.rotation(h.Util._getRotation(N.rotation)),this._nodes.forEach(V=>{this._fire("transform",{evt:z,target:V}),V._fire("transform",{evt:z,target:V})}),this._resetTransformCache(),this.update(),this.getLayer().batchDraw()}forceUpdate(){this._resetTransformCache(),this.update()}_batchChangeChild(N,z){this.findOne(N).setAttrs(z)}update(){var N;const z=this._getNodeRect();this.rotation(h.Util._getRotation(z.rotation));const X=z.width,Y=z.height,F=this.enabledAnchors(),q=this.resizeEnabled(),G=this.padding(),W=this.anchorSize(),k=this.find("._anchor");k.forEach(ee=>{ee.setAttrs({width:W,height:W,offsetX:W/2,offsetY:W/2,stroke:this.anchorStroke(),strokeWidth:this.anchorStrokeWidth(),fill:this.anchorFill(),cornerRadius:this.anchorCornerRadius()})}),this._batchChangeChild(".top-left",{x:0,y:0,offsetX:W/2+G,offsetY:W/2+G,visible:q&&F.indexOf("top-left")>=0}),this._batchChangeChild(".top-center",{x:X/2,y:0,offsetY:W/2+G,visible:q&&F.indexOf("top-center")>=0}),this._batchChangeChild(".top-right",{x:X,y:0,offsetX:W/2-G,offsetY:W/2+G,visible:q&&F.indexOf("top-right")>=0}),this._batchChangeChild(".middle-left",{x:0,y:Y/2,offsetX:W/2+G,visible:q&&F.indexOf("middle-left")>=0}),this._batchChangeChild(".middle-right",{x:X,y:Y/2,offsetX:W/2-G,visible:q&&F.indexOf("middle-right")>=0}),this._batchChangeChild(".bottom-left",{x:0,y:Y,offsetX:W/2+G,offsetY:W/2-G,visible:q&&F.indexOf("bottom-left")>=0}),this._batchChangeChild(".bottom-center",{x:X/2,y:Y,offsetY:W/2-G,visible:q&&F.indexOf("bottom-center")>=0}),this._batchChangeChild(".bottom-right",{x:X,y:Y,offsetX:W/2-G,offsetY:W/2-G,visible:q&&F.indexOf("bottom-right")>=0}),this._batchChangeChild(".rotater",{x:X/2,y:-this.rotateAnchorOffset()*h.Util._sign(Y)-G,visible:this.rotateEnabled()}),this._batchChangeChild(".back",{width:X,height:Y,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),dash:this.borderDash(),x:0,y:0});const K=this.anchorStyleFunc();K&&k.forEach(ee=>{K(ee)}),(N=this.getLayer())===null||N===void 0||N.batchDraw()}isTransforming(){return this._transforming}stopTransform(){if(this._transforming){this._removeEvents();const N=this.findOne("."+this._movingAnchorName);N&&N.stopDrag()}}destroy(){return this.getStage()&&this._cursorChange&&this.getStage().content&&(this.getStage().content.style.cursor=""),a.Group.prototype.destroy.call(this),this.detach(),this._removeEvents(),this}toObject(){return t.Node.prototype.toObject.call(this)}clone(N){return t.Node.prototype.clone.call(this,N)}getClientRect(){return this.nodes().length>0?super.getClientRect():{x:0,y:0,width:0,height:0}}};IS.Transformer=I,I.isTransforming=()=>D>0;function U(O){return O instanceof Array||h.Util.warn("enabledAnchors value should be an array"),O instanceof Array&&O.forEach(function(N){C.indexOf(N)===-1&&h.Util.warn("Unknown anchor name: "+N+". Available names are: "+C.join(", "))}),O||[]}return I.prototype.className="Transformer",(0,l._registerNode)(I),e.Factory.addGetterSetter(I,"enabledAnchors",C,U),e.Factory.addGetterSetter(I,"flipEnabled",!0,(0,r.getBooleanValidator)()),e.Factory.addGetterSetter(I,"resizeEnabled",!0),e.Factory.addGetterSetter(I,"anchorSize",10,(0,r.getNumberValidator)()),e.Factory.addGetterSetter(I,"rotateEnabled",!0),e.Factory.addGetterSetter(I,"rotateLineVisible",!0),e.Factory.addGetterSetter(I,"rotationSnaps",[]),e.Factory.addGetterSetter(I,"rotateAnchorOffset",50,(0,r.getNumberValidator)()),e.Factory.addGetterSetter(I,"rotateAnchorCursor","crosshair"),e.Factory.addGetterSetter(I,"rotationSnapTolerance",5,(0,r.getNumberValidator)()),e.Factory.addGetterSetter(I,"borderEnabled",!0),e.Factory.addGetterSetter(I,"anchorStroke","rgb(0, 161, 255)"),e.Factory.addGetterSetter(I,"anchorStrokeWidth",1,(0,r.getNumberValidator)()),e.Factory.addGetterSetter(I,"anchorFill","white"),e.Factory.addGetterSetter(I,"anchorCornerRadius",0,(0,r.getNumberValidator)()),e.Factory.addGetterSetter(I,"borderStroke","rgb(0, 161, 255)"),e.Factory.addGetterSetter(I,"borderStrokeWidth",1,(0,r.getNumberValidator)()),e.Factory.addGetterSetter(I,"borderDash"),e.Factory.addGetterSetter(I,"keepRatio",!0),e.Factory.addGetterSetter(I,"shiftBehavior","default"),e.Factory.addGetterSetter(I,"centeredScaling",!1),e.Factory.addGetterSetter(I,"ignoreStroke",!1),e.Factory.addGetterSetter(I,"padding",0,(0,r.getNumberValidator)()),e.Factory.addGetterSetter(I,"nodes"),e.Factory.addGetterSetter(I,"node"),e.Factory.addGetterSetter(I,"boundBoxFunc"),e.Factory.addGetterSetter(I,"anchorDragBoundFunc"),e.Factory.addGetterSetter(I,"anchorStyleFunc"),e.Factory.addGetterSetter(I,"shouldOverdrawWholeArea",!1),e.Factory.addGetterSetter(I,"useSingleNodeRotation",!0),e.Factory.backCompat(I,{lineEnabled:"borderEnabled",rotateHandlerOffset:"rotateAnchorOffset",enabledHandlers:"enabledAnchors"}),IS}var OS={},x5;function Doe(){if(x5)return OS;x5=1,Object.defineProperty(OS,"__esModule",{value:!0}),OS.Wedge=void 0;const h=Ut(),e=ma(),t=Rt(),s=Gt(),i=Rt();let a=class extends e.Shape{_sceneFunc(r){r.beginPath(),r.arc(0,0,this.radius(),0,t.Konva.getAngle(this.angle()),this.clockwise()),r.lineTo(0,0),r.closePath(),r.fillStrokeShape(this)}getWidth(){return this.radius()*2}getHeight(){return this.radius()*2}setWidth(r){this.radius(r/2)}setHeight(r){this.radius(r/2)}};return OS.Wedge=a,a.prototype.className="Wedge",a.prototype._centroid=!0,a.prototype._attrsAffectingSize=["radius"],(0,i._registerNode)(a),h.Factory.addGetterSetter(a,"radius",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(a,"angle",0,(0,s.getNumberValidator)()),h.Factory.addGetterSetter(a,"clockwise",!1),h.Factory.backCompat(a,{angleDeg:"angle",getAngleDeg:"getAngle",setAngleDeg:"setAngle"}),OS}var NS={},T5;function Poe(){if(T5)return NS;T5=1,Object.defineProperty(NS,"__esModule",{value:!0}),NS.Blur=void 0;const h=Ut(),e=Mi(),t=Gt();function s(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}const i=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],a=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function n(l,u){const f=l.data,_=l.width,g=l.height;let y,v,x,C,M,w,T,R,D,I,U,O,N,z,X,Y,F,q,G,W,k,K,ee,V;const Q=u+u+1,se=_-1,J=g-1,ie=u+1,oe=ie*(ie+1)/2,he=new s,te=i[u],le=a[u];let Se=null,Ae=he,De=null,Fe=null;for(x=1;x<Q;x++)Ae=Ae.next=new s,x===ie&&(Se=Ae);for(Ae.next=he,T=w=0,v=0;v<g;v++){for(Y=F=q=G=R=D=I=U=0,O=ie*(W=f[w]),N=ie*(k=f[w+1]),z=ie*(K=f[w+2]),X=ie*(ee=f[w+3]),R+=oe*W,D+=oe*k,I+=oe*K,U+=oe*ee,Ae=he,x=0;x<ie;x++)Ae.r=W,Ae.g=k,Ae.b=K,Ae.a=ee,Ae=Ae.next;for(x=1;x<ie;x++)C=w+((se<x?se:x)<<2),R+=(Ae.r=W=f[C])*(V=ie-x),D+=(Ae.g=k=f[C+1])*V,I+=(Ae.b=K=f[C+2])*V,U+=(Ae.a=ee=f[C+3])*V,Y+=W,F+=k,q+=K,G+=ee,Ae=Ae.next;for(De=he,Fe=Se,y=0;y<_;y++)f[w+3]=ee=U*te>>le,ee!==0?(ee=255/ee,f[w]=(R*te>>le)*ee,f[w+1]=(D*te>>le)*ee,f[w+2]=(I*te>>le)*ee):f[w]=f[w+1]=f[w+2]=0,R-=O,D-=N,I-=z,U-=X,O-=De.r,N-=De.g,z-=De.b,X-=De.a,C=T+((C=y+u+1)<se?C:se)<<2,Y+=De.r=f[C],F+=De.g=f[C+1],q+=De.b=f[C+2],G+=De.a=f[C+3],R+=Y,D+=F,I+=q,U+=G,De=De.next,O+=W=Fe.r,N+=k=Fe.g,z+=K=Fe.b,X+=ee=Fe.a,Y-=W,F-=k,q-=K,G-=ee,Fe=Fe.next,w+=4;T+=_}for(y=0;y<_;y++){for(F=q=G=Y=D=I=U=R=0,w=y<<2,O=ie*(W=f[w]),N=ie*(k=f[w+1]),z=ie*(K=f[w+2]),X=ie*(ee=f[w+3]),R+=oe*W,D+=oe*k,I+=oe*K,U+=oe*ee,Ae=he,x=0;x<ie;x++)Ae.r=W,Ae.g=k,Ae.b=K,Ae.a=ee,Ae=Ae.next;for(M=_,x=1;x<=u;x++)w=M+y<<2,R+=(Ae.r=W=f[w])*(V=ie-x),D+=(Ae.g=k=f[w+1])*V,I+=(Ae.b=K=f[w+2])*V,U+=(Ae.a=ee=f[w+3])*V,Y+=W,F+=k,q+=K,G+=ee,Ae=Ae.next,x<J&&(M+=_);for(w=y,De=he,Fe=Se,v=0;v<g;v++)C=w<<2,f[C+3]=ee=U*te>>le,ee>0?(ee=255/ee,f[C]=(R*te>>le)*ee,f[C+1]=(D*te>>le)*ee,f[C+2]=(I*te>>le)*ee):f[C]=f[C+1]=f[C+2]=0,R-=O,D-=N,I-=z,U-=X,O-=De.r,N-=De.g,z-=De.b,X-=De.a,C=y+((C=v+ie)<J?C:J)*_<<2,R+=Y+=De.r=f[C],D+=F+=De.g=f[C+1],I+=q+=De.b=f[C+2],U+=G+=De.a=f[C+3],De=De.next,O+=W=Fe.r,N+=k=Fe.g,z+=K=Fe.b,X+=ee=Fe.a,Y-=W,F-=k,q-=K,G-=ee,Fe=Fe.next,w+=_}}const r=function(u){const f=Math.round(this.blurRadius());f>0&&n(u,f)};return NS.Blur=r,h.Factory.addGetterSetter(e.Node,"blurRadius",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),NS}var FS={},E5;function Loe(){if(E5)return FS;E5=1,Object.defineProperty(FS,"__esModule",{value:!0}),FS.Brighten=void 0;const h=Ut(),e=Mi(),t=Gt(),s=function(i){const a=this.brightness()*255,n=i.data,r=n.length;for(let l=0;l<r;l+=4)n[l]+=a,n[l+1]+=a,n[l+2]+=a};return FS.Brighten=s,h.Factory.addGetterSetter(e.Node,"brightness",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),FS}var BS={},A5;function Ioe(){if(A5)return BS;A5=1,Object.defineProperty(BS,"__esModule",{value:!0}),BS.Contrast=void 0;const h=Ut(),e=Mi(),t=Gt(),s=function(i){const a=Math.pow((this.contrast()+100)/100,2),n=i.data,r=n.length;let l=150,u=150,f=150;for(let _=0;_<r;_+=4)l=n[_],u=n[_+1],f=n[_+2],l/=255,l-=.5,l*=a,l+=.5,l*=255,u/=255,u-=.5,u*=a,u+=.5,u*=255,f/=255,f-=.5,f*=a,f+=.5,f*=255,l=l<0?0:l>255?255:l,u=u<0?0:u>255?255:u,f=f<0?0:f>255?255:f,n[_]=l,n[_+1]=u,n[_+2]=f};return BS.Contrast=s,h.Factory.addGetterSetter(e.Node,"contrast",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),BS}var US={},C5;function Ooe(){if(C5)return US;C5=1,Object.defineProperty(US,"__esModule",{value:!0}),US.Emboss=void 0;const h=Ut(),e=Mi(),t=_i(),s=Gt(),i=function(a){const n=this.embossStrength()*10,r=this.embossWhiteLevel()*255,l=this.embossDirection(),u=this.embossBlend(),f=a.data,_=a.width,g=a.height,y=_*4;let v=0,x=0,C=g;switch(l){case"top-left":v=-1,x=-1;break;case"top":v=-1,x=0;break;case"top-right":v=-1,x=1;break;case"right":v=0,x=1;break;case"bottom-right":v=1,x=1;break;case"bottom":v=1,x=0;break;case"bottom-left":v=1,x=-1;break;case"left":v=0,x=-1;break;default:t.Util.error("Unknown emboss direction: "+l)}do{const M=(C-1)*y;let w=v;C+w<1&&(w=0),C+w>g&&(w=0);const T=(C-1+w)*_*4;let R=_;do{const D=M+(R-1)*4;let I=x;R+I<1&&(I=0),R+I>_&&(I=0);const U=T+(R-1+I)*4,O=f[D]-f[U],N=f[D+1]-f[U+1],z=f[D+2]-f[U+2];let X=O;const Y=X>0?X:-X,F=N>0?N:-N,q=z>0?z:-z;if(F>Y&&(X=N),q>Y&&(X=z),X*=n,u){const G=f[D]+X,W=f[D+1]+X,k=f[D+2]+X;f[D]=G>255?255:G<0?0:G,f[D+1]=W>255?255:W<0?0:W,f[D+2]=k>255?255:k<0?0:k}else{let G=r-X;G<0?G=0:G>255&&(G=255),f[D]=f[D+1]=f[D+2]=G}}while(--R)}while(--C)};return US.Emboss=i,h.Factory.addGetterSetter(e.Node,"embossStrength",.5,(0,s.getNumberValidator)(),h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"embossWhiteLevel",.5,(0,s.getNumberValidator)(),h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"embossDirection","top-left",void 0,h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"embossBlend",!1,void 0,h.Factory.afterSetFilter),US}var zS={},w5;function Noe(){if(w5)return zS;w5=1,Object.defineProperty(zS,"__esModule",{value:!0}),zS.Enhance=void 0;const h=Ut(),e=Mi(),t=Gt();function s(a,n,r,l,u){const f=r-n,_=u-l;if(f===0)return l+_/2;if(_===0)return l;let g=(a-n)/f;return g=_*g+l,g}const i=function(a){const n=a.data,r=n.length;let l=n[0],u=l,f,_=n[1],g=_,y,v=n[2],x=v,C;const M=this.enhance();if(M===0)return;for(let X=0;X<r;X+=4)f=n[X+0],f<l?l=f:f>u&&(u=f),y=n[X+1],y<_?_=y:y>g&&(g=y),C=n[X+2],C<v?v=C:C>x&&(x=C);u===l&&(u=255,l=0),g===_&&(g=255,_=0),x===v&&(x=255,v=0);let w,T,R,D,I,U,O,N,z;M>0?(T=u+M*(255-u),R=l-M*(l-0),I=g+M*(255-g),U=_-M*(_-0),N=x+M*(255-x),z=v-M*(v-0)):(w=(u+l)*.5,T=u+M*(u-w),R=l+M*(l-w),D=(g+_)*.5,I=g+M*(g-D),U=_+M*(_-D),O=(x+v)*.5,N=x+M*(x-O),z=v+M*(v-O));for(let X=0;X<r;X+=4)n[X+0]=s(n[X+0],l,u,R,T),n[X+1]=s(n[X+1],_,g,U,I),n[X+2]=s(n[X+2],v,x,z,N)};return zS.Enhance=i,h.Factory.addGetterSetter(e.Node,"enhance",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),zS}var kS={},R5;function Foe(){if(R5)return kS;R5=1,Object.defineProperty(kS,"__esModule",{value:!0}),kS.Grayscale=void 0;const h=function(e){const t=e.data,s=t.length;for(let i=0;i<s;i+=4){const a=.34*t[i]+.5*t[i+1]+.16*t[i+2];t[i]=a,t[i+1]=a,t[i+2]=a}};return kS.Grayscale=h,kS}var VS={},M5;function Boe(){if(M5)return VS;M5=1,Object.defineProperty(VS,"__esModule",{value:!0}),VS.HSL=void 0;const h=Ut(),e=Mi(),t=Gt();h.Factory.addGetterSetter(e.Node,"hue",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"saturation",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"luminance",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter);const s=function(i){const a=i.data,n=a.length,r=1,l=Math.pow(2,this.saturation()),u=Math.abs(this.hue()+360)%360,f=this.luminance()*127,_=r*l*Math.cos(u*Math.PI/180),g=r*l*Math.sin(u*Math.PI/180),y=.299*r+.701*_+.167*g,v=.587*r-.587*_+.33*g,x=.114*r-.114*_-.497*g,C=.299*r-.299*_-.328*g,M=.587*r+.413*_+.035*g,w=.114*r-.114*_+.293*g,T=.299*r-.3*_+1.25*g,R=.587*r-.586*_-1.05*g,D=.114*r+.886*_-.2*g;let I,U,O,N;for(let z=0;z<n;z+=4)I=a[z+0],U=a[z+1],O=a[z+2],N=a[z+3],a[z+0]=y*I+v*U+x*O+f,a[z+1]=C*I+M*U+w*O+f,a[z+2]=T*I+R*U+D*O+f,a[z+3]=N};return VS.HSL=s,VS}var GS={},D5;function Uoe(){if(D5)return GS;D5=1,Object.defineProperty(GS,"__esModule",{value:!0}),GS.HSV=void 0;const h=Ut(),e=Mi(),t=Gt(),s=function(i){const a=i.data,n=a.length,r=Math.pow(2,this.value()),l=Math.pow(2,this.saturation()),u=Math.abs(this.hue()+360)%360,f=r*l*Math.cos(u*Math.PI/180),_=r*l*Math.sin(u*Math.PI/180),g=.299*r+.701*f+.167*_,y=.587*r-.587*f+.33*_,v=.114*r-.114*f-.497*_,x=.299*r-.299*f-.328*_,C=.587*r+.413*f+.035*_,M=.114*r-.114*f+.293*_,w=.299*r-.3*f+1.25*_,T=.587*r-.586*f-1.05*_,R=.114*r+.886*f-.2*_;let D,I,U,O;for(let N=0;N<n;N+=4)D=a[N+0],I=a[N+1],U=a[N+2],O=a[N+3],a[N+0]=g*D+y*I+v*U,a[N+1]=x*D+C*I+M*U,a[N+2]=w*D+T*I+R*U,a[N+3]=O};return GS.HSV=s,h.Factory.addGetterSetter(e.Node,"hue",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"saturation",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"value",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),GS}var HS={},P5;function zoe(){if(P5)return HS;P5=1,Object.defineProperty(HS,"__esModule",{value:!0}),HS.Invert=void 0;const h=function(e){const t=e.data,s=t.length;for(let i=0;i<s;i+=4)t[i]=255-t[i],t[i+1]=255-t[i+1],t[i+2]=255-t[i+2]};return HS.Invert=h,HS}var WS={},L5;function koe(){if(L5)return WS;L5=1,Object.defineProperty(WS,"__esModule",{value:!0}),WS.Kaleidoscope=void 0;const h=Ut(),e=Mi(),t=_i(),s=Gt(),i=function(r,l,u){const f=r.data,_=l.data,g=r.width,y=r.height,v=u.polarCenterX||g/2,x=u.polarCenterY||y/2;let C=Math.sqrt(v*v+x*x),M=g-v,w=y-x;const T=Math.sqrt(M*M+w*w);C=T>C?T:C;const R=y,D=g,I=360/D*Math.PI/180;for(let U=0;U<D;U+=1){const O=Math.sin(U*I),N=Math.cos(U*I);for(let z=0;z<R;z+=1){M=Math.floor(v+C*z/R*N),w=Math.floor(x+C*z/R*O);let X=(w*g+M)*4;const Y=f[X+0],F=f[X+1],q=f[X+2],G=f[X+3];X=(U+z*g)*4,_[X+0]=Y,_[X+1]=F,_[X+2]=q,_[X+3]=G}}},a=function(r,l,u){const f=r.data,_=l.data,g=r.width,y=r.height,v=u.polarCenterX||g/2,x=u.polarCenterY||y/2;let C=Math.sqrt(v*v+x*x),M=g-v,w=y-x;const T=Math.sqrt(M*M+w*w);C=T>C?T:C;const R=y,D=g,I=0;let U,O;for(M=0;M<g;M+=1)for(w=0;w<y;w+=1){const N=M-v,z=w-x,X=Math.sqrt(N*N+z*z)*R/C;let Y=(Math.atan2(z,N)*180/Math.PI+360+I)%360;Y=Y*D/360,U=Math.floor(Y),O=Math.floor(X);let F=(O*g+U)*4;const q=f[F+0],G=f[F+1],W=f[F+2],k=f[F+3];F=(w*g+M)*4,_[F+0]=q,_[F+1]=G,_[F+2]=W,_[F+3]=k}},n=function(r){const l=r.width,u=r.height;let f,_,g,y,v,x,C,M,w,T,R=Math.round(this.kaleidoscopePower());const D=Math.round(this.kaleidoscopeAngle()),I=Math.floor(l*(D%360)/360);if(R<1)return;const U=t.Util.createCanvasElement();U.width=l,U.height=u;const O=U.getContext("2d").getImageData(0,0,l,u);t.Util.releaseCanvas(U),i(r,O,{polarCenterX:l/2,polarCenterY:u/2});let N=l/Math.pow(2,R);for(;N<=8;)N=N*2,R-=1;N=Math.ceil(N);let z=N,X=0,Y=z,F=1;for(I+N>l&&(X=z,Y=0,F=-1),_=0;_<u;_+=1)for(f=X;f!==Y;f+=F)g=Math.round(f+I)%l,w=(l*_+g)*4,v=O.data[w+0],x=O.data[w+1],C=O.data[w+2],M=O.data[w+3],T=(l*_+f)*4,O.data[T+0]=v,O.data[T+1]=x,O.data[T+2]=C,O.data[T+3]=M;for(_=0;_<u;_+=1)for(z=Math.floor(N),y=0;y<R;y+=1){for(f=0;f<z+1;f+=1)w=(l*_+f)*4,v=O.data[w+0],x=O.data[w+1],C=O.data[w+2],M=O.data[w+3],T=(l*_+z*2-f-1)*4,O.data[T+0]=v,O.data[T+1]=x,O.data[T+2]=C,O.data[T+3]=M;z*=2}a(O,r,{})};return WS.Kaleidoscope=n,h.Factory.addGetterSetter(e.Node,"kaleidoscopePower",2,(0,s.getNumberValidator)(),h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"kaleidoscopeAngle",0,(0,s.getNumberValidator)(),h.Factory.afterSetFilter),WS}var qS={},I5;function Voe(){if(I5)return qS;I5=1,Object.defineProperty(qS,"__esModule",{value:!0}),qS.Mask=void 0;const h=Ut(),e=Mi(),t=Gt();function s(g,y,v){let x=(v*g.width+y)*4;const C=[];return C.push(g.data[x++],g.data[x++],g.data[x++],g.data[x++]),C}function i(g,y){return Math.sqrt(Math.pow(g[0]-y[0],2)+Math.pow(g[1]-y[1],2)+Math.pow(g[2]-y[2],2))}function a(g){const y=[0,0,0];for(let v=0;v<g.length;v++)y[0]+=g[v][0],y[1]+=g[v][1],y[2]+=g[v][2];return y[0]/=g.length,y[1]/=g.length,y[2]/=g.length,y}function n(g,y){const v=s(g,0,0),x=s(g,g.width-1,0),C=s(g,0,g.height-1),M=s(g,g.width-1,g.height-1),w=y||10;if(i(v,x)<w&&i(x,M)<w&&i(M,C)<w&&i(C,v)<w){const T=a([x,v,M,C]),R=[];for(let D=0;D<g.width*g.height;D++){const I=i(T,[g.data[D*4],g.data[D*4+1],g.data[D*4+2]]);R[D]=I<w?0:255}return R}}function r(g,y){for(let v=0;v<g.width*g.height;v++)g.data[4*v+3]=y[v]}function l(g,y,v){const x=[1,1,1,1,0,1,1,1,1],C=Math.round(Math.sqrt(x.length)),M=Math.floor(C/2),w=[];for(let T=0;T<v;T++)for(let R=0;R<y;R++){const D=T*y+R;let I=0;for(let U=0;U<C;U++)for(let O=0;O<C;O++){const N=T+U-M,z=R+O-M;if(N>=0&&N<v&&z>=0&&z<y){const X=N*y+z,Y=x[U*C+O];I+=g[X]*Y}}w[D]=I===255*8?255:0}return w}function u(g,y,v){const x=[1,1,1,1,1,1,1,1,1],C=Math.round(Math.sqrt(x.length)),M=Math.floor(C/2),w=[];for(let T=0;T<v;T++)for(let R=0;R<y;R++){const D=T*y+R;let I=0;for(let U=0;U<C;U++)for(let O=0;O<C;O++){const N=T+U-M,z=R+O-M;if(N>=0&&N<v&&z>=0&&z<y){const X=N*y+z,Y=x[U*C+O];I+=g[X]*Y}}w[D]=I>=255*4?255:0}return w}function f(g,y,v){const x=[.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111,.1111111111111111],C=Math.round(Math.sqrt(x.length)),M=Math.floor(C/2),w=[];for(let T=0;T<v;T++)for(let R=0;R<y;R++){const D=T*y+R;let I=0;for(let U=0;U<C;U++)for(let O=0;O<C;O++){const N=T+U-M,z=R+O-M;if(N>=0&&N<v&&z>=0&&z<y){const X=N*y+z,Y=x[U*C+O];I+=g[X]*Y}}w[D]=I}return w}const _=function(g){const y=this.threshold();let v=n(g,y);return v&&(v=l(v,g.width,g.height),v=u(v,g.width,g.height),v=f(v,g.width,g.height),r(g,v)),g};return qS.Mask=_,h.Factory.addGetterSetter(e.Node,"threshold",0,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),qS}var XS={},O5;function Goe(){if(O5)return XS;O5=1,Object.defineProperty(XS,"__esModule",{value:!0}),XS.Noise=void 0;const h=Ut(),e=Mi(),t=Gt(),s=function(i){const a=this.noise()*255,n=i.data,r=n.length,l=a/2;for(let u=0;u<r;u+=4)n[u+0]+=l-2*l*Math.random(),n[u+1]+=l-2*l*Math.random(),n[u+2]+=l-2*l*Math.random()};return XS.Noise=s,h.Factory.addGetterSetter(e.Node,"noise",.2,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),XS}var jS={},N5;function Hoe(){if(N5)return jS;N5=1,Object.defineProperty(jS,"__esModule",{value:!0}),jS.Pixelate=void 0;const h=Ut(),e=_i(),t=Mi(),s=Gt(),i=function(a){let n=Math.ceil(this.pixelSize()),r=a.width,l=a.height,u,f,_,g,y,v,x,C=Math.ceil(r/n),M=Math.ceil(l/n),w,T,R,D,I,U,O,N=a.data;if(n<=0){e.Util.error("pixelSize value can not be <= 0");return}for(I=0;I<C;I+=1)for(U=0;U<M;U+=1){for(g=0,y=0,v=0,x=0,w=I*n,T=w+n,R=U*n,D=R+n,O=0,u=w;u<T;u+=1)if(!(u>=r))for(f=R;f<D;f+=1)f>=l||(_=(r*f+u)*4,g+=N[_+0],y+=N[_+1],v+=N[_+2],x+=N[_+3],O+=1);for(g=g/O,y=y/O,v=v/O,x=x/O,u=w;u<T;u+=1)if(!(u>=r))for(f=R;f<D;f+=1)f>=l||(_=(r*f+u)*4,N[_+0]=g,N[_+1]=y,N[_+2]=v,N[_+3]=x)}};return jS.Pixelate=i,h.Factory.addGetterSetter(t.Node,"pixelSize",8,(0,s.getNumberValidator)(),h.Factory.afterSetFilter),jS}var YS={},F5;function Woe(){if(F5)return YS;F5=1,Object.defineProperty(YS,"__esModule",{value:!0}),YS.Posterize=void 0;const h=Ut(),e=Mi(),t=Gt(),s=function(i){const a=Math.round(this.levels()*254)+1,n=i.data,r=n.length,l=255/a;for(let u=0;u<r;u+=1)n[u]=Math.floor(n[u]/l)*l};return YS.Posterize=s,h.Factory.addGetterSetter(e.Node,"levels",.5,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),YS}var KS={},B5;function qoe(){if(B5)return KS;B5=1,Object.defineProperty(KS,"__esModule",{value:!0}),KS.RGB=void 0;const h=Ut(),e=Mi(),t=Gt(),s=function(i){const a=i.data,n=a.length,r=this.red(),l=this.green(),u=this.blue();for(let f=0;f<n;f+=4){const _=(.34*a[f]+.5*a[f+1]+.16*a[f+2])/255;a[f]=_*r,a[f+1]=_*l,a[f+2]=_*u,a[f+3]=a[f+3]}};return KS.RGB=s,h.Factory.addGetterSetter(e.Node,"red",0,function(i){return this._filterUpToDate=!1,i>255?255:i<0?0:Math.round(i)}),h.Factory.addGetterSetter(e.Node,"green",0,function(i){return this._filterUpToDate=!1,i>255?255:i<0?0:Math.round(i)}),h.Factory.addGetterSetter(e.Node,"blue",0,t.RGBComponent,h.Factory.afterSetFilter),KS}var QS={},U5;function Xoe(){if(U5)return QS;U5=1,Object.defineProperty(QS,"__esModule",{value:!0}),QS.RGBA=void 0;const h=Ut(),e=Mi(),t=Gt(),s=function(i){const a=i.data,n=a.length,r=this.red(),l=this.green(),u=this.blue(),f=this.alpha();for(let _=0;_<n;_+=4){const g=1-f;a[_]=r*f+a[_]*g,a[_+1]=l*f+a[_+1]*g,a[_+2]=u*f+a[_+2]*g}};return QS.RGBA=s,h.Factory.addGetterSetter(e.Node,"red",0,function(i){return this._filterUpToDate=!1,i>255?255:i<0?0:Math.round(i)}),h.Factory.addGetterSetter(e.Node,"green",0,function(i){return this._filterUpToDate=!1,i>255?255:i<0?0:Math.round(i)}),h.Factory.addGetterSetter(e.Node,"blue",0,t.RGBComponent,h.Factory.afterSetFilter),h.Factory.addGetterSetter(e.Node,"alpha",1,function(i){return this._filterUpToDate=!1,i>1?1:i<0?0:i}),QS}var $S={},z5;function joe(){if(z5)return $S;z5=1,Object.defineProperty($S,"__esModule",{value:!0}),$S.Sepia=void 0;const h=function(e){const t=e.data,s=t.length;for(let i=0;i<s;i+=4){const a=t[i+0],n=t[i+1],r=t[i+2];t[i+0]=Math.min(255,a*.393+n*.769+r*.189),t[i+1]=Math.min(255,a*.349+n*.686+r*.168),t[i+2]=Math.min(255,a*.272+n*.534+r*.131)}};return $S.Sepia=h,$S}var ZS={},k5;function Yoe(){if(k5)return ZS;k5=1,Object.defineProperty(ZS,"__esModule",{value:!0}),ZS.Solarize=void 0;const h=function(e){const t=e.data,s=e.width,i=e.height,a=s*4;let n=i;do{const r=(n-1)*a;let l=s;do{const u=r+(l-1)*4;let f=t[u],_=t[u+1],g=t[u+2];f>127&&(f=255-f),_>127&&(_=255-_),g>127&&(g=255-g),t[u]=f,t[u+1]=_,t[u+2]=g}while(--l)}while(--n)};return ZS.Solarize=h,ZS}var JS={},V5;function Koe(){if(V5)return JS;V5=1,Object.defineProperty(JS,"__esModule",{value:!0}),JS.Threshold=void 0;const h=Ut(),e=Mi(),t=Gt(),s=function(i){const a=this.threshold()*255,n=i.data,r=n.length;for(let l=0;l<r;l+=1)n[l]=n[l]<a?0:255};return JS.Threshold=s,h.Factory.addGetterSetter(e.Node,"threshold",.5,(0,t.getNumberValidator)(),h.Factory.afterSetFilter),JS}var G5;function Qoe(){if(G5)return fS;G5=1,Object.defineProperty(fS,"__esModule",{value:!0}),fS.Konva=void 0;const h=_D(),e=goe(),t=voe(),s=Soe(),i=boe(),a=xoe(),n=Toe(),r=J6(),l=wL(),u=ek(),f=Eoe(),_=Aoe(),g=Coe(),y=woe(),v=tk(),x=Roe(),C=Moe(),M=Doe(),w=Poe(),T=Loe(),R=Ioe(),D=Ooe(),I=Noe(),U=Foe(),O=Boe(),N=Uoe(),z=zoe(),X=koe(),Y=Voe(),F=Goe(),q=Hoe(),G=Woe(),W=qoe(),k=Xoe(),K=joe(),ee=Yoe(),V=Koe();return fS.Konva=h.Konva.Util._assign(h.Konva,{Arc:e.Arc,Arrow:t.Arrow,Circle:s.Circle,Ellipse:i.Ellipse,Image:a.Image,Label:n.Label,Tag:n.Tag,Line:r.Line,Path:l.Path,Rect:u.Rect,RegularPolygon:f.RegularPolygon,Ring:_.Ring,Sprite:g.Sprite,Star:y.Star,Text:v.Text,TextPath:x.TextPath,Transformer:C.Transformer,Wedge:M.Wedge,Filters:{Blur:w.Blur,Brighten:T.Brighten,Contrast:R.Contrast,Emboss:D.Emboss,Enhance:I.Enhance,Grayscale:U.Grayscale,HSL:O.HSL,HSV:N.HSV,Invert:z.Invert,Kaleidoscope:X.Kaleidoscope,Mask:Y.Mask,Noise:F.Noise,Pixelate:q.Pixelate,Posterize:G.Posterize,RGB:W.RGB,RGBA:k.RGBA,Sepia:K.Sepia,Solarize:ee.Solarize,Threshold:V.Threshold}}),fS}var $oe=AA.exports,H5;function Zoe(){if(H5)return AA.exports;H5=1,Object.defineProperty($oe,"__esModule",{value:!0});const h=Qoe();return AA.exports=h.Konva,AA.exports}var Joe=Zoe();const W5=JC(Joe);var oA={exports:{}},q5;function ele(){return q5||(q5=1,function(h,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Konva=void 0;var t=_D();Object.defineProperty(e,"Konva",{enumerable:!0,get:function(){return t.Konva}});const s=_D();h.exports=s.Konva}(oA,oA.exports)),oA.exports}var tle=ele();const C2=JC(tle);var DM={exports:{}},PM={exports:{}};/**
 * @license React
 * react-reconciler.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var X5;function sle(){return X5||(X5=1,function(h){h.exports=function(e){function t(d,p,b,A){return new dw(d,p,b,A)}function s(){}function i(d){var p="https://react.dev/errors/"+d;if(1<arguments.length){p+="?args[]="+encodeURIComponent(arguments[1]);for(var b=2;b<arguments.length;b++)p+="&args[]="+encodeURIComponent(arguments[b])}return"Minified React error #"+d+"; visit "+p+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function a(d){var p=d,b=d;if(d.alternate)for(;p.return;)p=p.return;else{d=p;do p=d,(p.flags&4098)!==0&&(b=p.return),d=p.return;while(d)}return p.tag===3?b:null}function n(d){if(a(d)!==d)throw Error(i(188))}function r(d){var p=d.alternate;if(!p){if(p=a(d),p===null)throw Error(i(188));return p!==d?null:d}for(var b=d,A=p;;){var L=b.return;if(L===null)break;var B=L.alternate;if(B===null){if(A=L.return,A!==null){b=A;continue}break}if(L.child===B.child){for(B=L.child;B;){if(B===b)return n(L),d;if(B===A)return n(L),p;B=B.sibling}throw Error(i(188))}if(b.return!==A.return)b=L,A=B;else{for(var Z=!1,ne=L.child;ne;){if(ne===b){Z=!0,b=L,A=B;break}if(ne===A){Z=!0,A=L,b=B;break}ne=ne.sibling}if(!Z){for(ne=B.child;ne;){if(ne===b){Z=!0,b=B,A=L;break}if(ne===A){Z=!0,A=B,b=L;break}ne=ne.sibling}if(!Z)throw Error(i(189))}}if(b.alternate!==A)throw Error(i(190))}if(b.tag!==3)throw Error(i(188));return b.stateNode.current===b?d:p}function l(d){var p=d.tag;if(p===5||p===26||p===27||p===6)return d;for(d=d.child;d!==null;){if(p=l(d),p!==null)return p;d=d.sibling}return null}function u(d){var p=d.tag;if(p===5||p===26||p===27||p===6)return d;for(d=d.child;d!==null;){if(d.tag!==4&&(p=u(d),p!==null))return p;d=d.sibling}return null}function f(d){return d===null||typeof d!="object"?null:(d=M_&&d[M_]||d["@@iterator"],typeof d=="function"?d:null)}function _(d){if(d==null)return null;if(typeof d=="function")return d.$$typeof===Of?null:d.displayName||d.name||null;if(typeof d=="string")return d;switch(d){case ec:return"Fragment";case R_:return"Profiler";case Df:return"StrictMode";case Lf:return"Suspense";case If:return"SuspenseList";case tc:return"Activity"}if(typeof d=="object")switch(d.$$typeof){case Il:return"Portal";case Do:return(d.displayName||"Context")+".Provider";case Zy:return(d._context.displayName||"Context")+".Consumer";case Fr:var p=d.render;return d=d.displayName,d||(d=p.displayName||p.name||"",d=d!==""?"ForwardRef("+d+")":"ForwardRef"),d;case Br:return p=d.displayName||null,p!==null?p:_(d.type)||"Memo";case va:p=d._payload,d=d._init;try{return _(d(p))}catch{}}return null}function g(d){return{current:d}}function y(d){0>Fo||(d.current=No[Fo],No[Fo]=null,Fo--)}function v(d,p){Fo++,No[Fo]=d.current,d.current=p}function x(d){return d>>>=0,d===0?32:31-(IT(d)/U_|0)|0}function C(d){var p=d&42;if(p!==0)return p;switch(d&-d){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return d&4194048;case 4194304:case 8388608:case 16777216:case 33554432:return d&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return d}}function M(d,p,b){var A=d.pendingLanes;if(A===0)return 0;var L=0,B=d.suspendedLanes,Z=d.pingedLanes;d=d.warmLanes;var ne=A&134217727;return ne!==0?(A=ne&~B,A!==0?L=C(A):(Z&=ne,Z!==0?L=C(Z):b||(b=ne&~d,b!==0&&(L=C(b))))):(ne=A&~B,ne!==0?L=C(ne):Z!==0?L=C(Z):b||(b=A&~d,b!==0&&(L=C(b)))),L===0?0:p!==0&&p!==L&&(p&B)===0&&(B=L&-L,b=p&-p,B>=b||B===32&&(b&4194048)!==0)?p:L}function w(d,p){return(d.pendingLanes&~(d.suspendedLanes&~d.pingedLanes)&p)===0}function T(d,p){switch(d){case 1:case 2:case 4:case 8:case 64:return p+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return p+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function R(){var d=Xf;return Xf<<=1,(Xf&4194048)===0&&(Xf=256),d}function D(){var d=Pu;return Pu<<=1,(Pu&62914560)===0&&(Pu=4194304),d}function I(d){for(var p=[],b=0;31>b;b++)p.push(d);return p}function U(d,p){d.pendingLanes|=p,p!==268435456&&(d.suspendedLanes=0,d.pingedLanes=0,d.warmLanes=0)}function O(d,p,b,A,L,B){var Z=d.pendingLanes;d.pendingLanes=b,d.suspendedLanes=0,d.pingedLanes=0,d.warmLanes=0,d.expiredLanes&=b,d.entangledLanes&=b,d.errorRecoveryDisabledLanes&=b,d.shellSuspendCounter=0;var ne=d.entanglements,de=d.expirationTimes,we=d.hiddenUpdates;for(b=Z&~b;0<b;){var Le=31-ka(b),Be=1<<Le;ne[Le]=0,de[Le]=-1;var Ue=we[Le];if(Ue!==null)for(we[Le]=null,Le=0;Le<Ue.length;Le++){var ut=Ue[Le];ut!==null&&(ut.lane&=-536870913)}b&=~Be}A!==0&&N(d,A,0),B!==0&&L===0&&d.tag!==0&&(d.suspendedLanes|=B&~(Z&~p))}function N(d,p,b){d.pendingLanes|=p,d.suspendedLanes&=~p;var A=31-ka(p);d.entangledLanes|=p,d.entanglements[A]=d.entanglements[A]|1073741824|b&4194090}function z(d,p){var b=d.entangledLanes|=p;for(d=d.entanglements;b;){var A=31-ka(b),L=1<<A;L&p|d[A]&p&&(d[A]|=p),b&=~L}}function X(d){switch(d){case 2:d=1;break;case 8:d=4;break;case 32:d=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:d=128;break;case 268435456:d=134217728;break;default:d=0}return d}function Y(d){return d&=-d,2<d?8<d?(d&134217727)!==0?32:268435456:8:2}function F(d){if(typeof BT=="function"&&UT(d),ba&&typeof ba.setStrictMode=="function")try{ba.setStrictMode(Ul,d)}catch{}}function q(d){if(V_===void 0)try{throw Error()}catch(b){var p=b.stack.trim().match(/\n( *(at )?)/);V_=p&&p[1]||"",Ev=-1<b.stack.indexOf(`
    at`)?" (<anonymous>)":-1<b.stack.indexOf("@")?"@unknown:0:0":""}return`
`+V_+d+Ev}function G(d,p){if(!d||G_)return"";G_=!0;var b=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var A={DetermineComponentFrameRoot:function(){try{if(p){var Be=function(){throw Error()};if(Object.defineProperty(Be.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(Be,[])}catch(ut){var Ue=ut}Reflect.construct(d,[],Be)}else{try{Be.call()}catch(ut){Ue=ut}d.call(Be.prototype)}}else{try{throw Error()}catch(ut){Ue=ut}(Be=d())&&typeof Be.catch=="function"&&Be.catch(function(){})}}catch(ut){if(ut&&Ue&&typeof ut.stack=="string")return[ut.stack,Ue.stack]}return[null,null]}};A.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var L=Object.getOwnPropertyDescriptor(A.DetermineComponentFrameRoot,"name");L&&L.configurable&&Object.defineProperty(A.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var B=A.DetermineComponentFrameRoot(),Z=B[0],ne=B[1];if(Z&&ne){var de=Z.split(`
`),we=ne.split(`
`);for(L=A=0;A<de.length&&!de[A].includes("DetermineComponentFrameRoot");)A++;for(;L<we.length&&!we[L].includes("DetermineComponentFrameRoot");)L++;if(A===de.length||L===we.length)for(A=de.length-1,L=we.length-1;1<=A&&0<=L&&de[A]!==we[L];)L--;for(;1<=A&&0<=L;A--,L--)if(de[A]!==we[L]){if(A!==1||L!==1)do if(A--,L--,0>L||de[A]!==we[L]){var Le=`
`+de[A].replace(" at new "," at ");return d.displayName&&Le.includes("<anonymous>")&&(Le=Le.replace("<anonymous>",d.displayName)),Le}while(1<=A&&0<=L);break}}}finally{G_=!1,Error.prepareStackTrace=b}return(b=d?d.displayName||d.name:"")?q(b):""}function W(d){switch(d.tag){case 26:case 27:case 5:return q(d.type);case 16:return q("Lazy");case 13:return q("Suspense");case 19:return q("SuspenseList");case 0:case 15:return G(d.type,!1);case 11:return G(d.type.render,!1);case 1:return G(d.type,!0);case 31:return q("Activity");default:return""}}function k(d){try{var p="";do p+=W(d),d=d.return;while(d);return p}catch(b){return`
Error generating stack: `+b.message+`
`+b.stack}}function K(d,p){if(typeof d=="object"&&d!==null){var b=H_.get(d);return b!==void 0?b:(p={value:d,source:p,stack:k(p)},H_.set(d,p),p)}return{value:d,source:p,stack:k(p)}}function ee(d,p){zl[kl++]=Lu,zl[kl++]=Yf,Yf=d,Lu=p}function V(d,p,b){xa[Va++]=Zn,xa[Va++]=Vr,xa[Va++]=Vl,Vl=d;var A=Zn;d=Vr;var L=32-ka(A)-1;A&=~(1<<L),b+=1;var B=32-ka(p)+L;if(30<B){var Z=L-L%5;B=(A&(1<<Z)-1).toString(32),A>>=Z,L-=Z,Zn=1<<32-ka(p)+L|b<<L|A,Vr=B+d}else Zn=1<<B|b<<L|A,Vr=d}function Q(d){d.return!==null&&(ee(d,1),V(d,1,0))}function se(d){for(;d===Yf;)Yf=zl[--kl],zl[kl]=null,Lu=zl[--kl],zl[kl]=null;for(;d===Vl;)Vl=xa[--Va],xa[Va]=null,Vr=xa[--Va],xa[Va]=null,Zn=xa[--Va],xa[Va]=null}function J(d,p){v(Gl,p),v(nc,d),v(Ls,null),d=ev(p),y(Ls),v(Ls,d)}function ie(){y(Ls),y(nc),y(Gl)}function oe(d){d.memoizedState!==null&&v(Kf,d);var p=Ls.current,b=tv(p,d.type);p!==b&&(v(nc,d),v(Ls,b))}function he(d){nc.current===d&&(y(Ls),y(nc)),Kf.current===d&&(y(Kf),Lo?zr._currentValue=za:zr._currentValue2=za)}function te(d){var p=Error(i(418,""));throw ot(K(p,d)),Av}function le(d,p){if(!Ba)throw Error(i(175));RT(d.stateNode,d.type,d.memoizedProps,p,d)||te(d)}function Se(d){for(Vs=d.return;Vs;)switch(Vs.tag){case 5:case 13:Yt=!1;return;case 27:case 3:Yt=!0;return;default:Vs=Vs.return}}function Ae(d){if(!Ba||d!==Vs)return!1;if(!zt)return Se(d),zt=!0,!1;var p=d.tag;if(Et?p!==3&&p!==27&&(p!==5||yv(d.type)&&!Po(d.type,d.memoizedProps))&&ci&&te(d):p!==3&&(p!==5||yv(d.type)&&!Po(d.type,d.memoizedProps))&&ci&&te(d),Se(d),p===13){if(!Ba)throw Error(i(316));if(d=d.memoizedState,d=d!==null?d.dehydrated:null,!d)throw Error(i(317));ci=N_(d)}else ci=Et&&p===27?mv(d.type,ci):Vs?TT(d.stateNode):null;return!0}function De(){Ba&&(ci=Vs=null,zt=!1)}function Fe(){var d=Jn;return d!==null&&(ha===null?ha=d:ha.push.apply(ha,d),Jn=null),d}function ot(d){Jn===null?Jn=[d]:Jn.push(d)}function mt(d,p){return d===p&&(d!==0||1/d===1/p)||d!==d&&p!==p}function $e(d,p,b){Lo?(v(Qf,p._currentValue),p._currentValue=b):(v(Qf,p._currentValue2),p._currentValue2=b)}function es(d){var p=Qf.current;Lo?d._currentValue=p:d._currentValue2=p,y(Qf)}function ht(d,p,b){for(;d!==null;){var A=d.alternate;if((d.childLanes&p)!==p?(d.childLanes|=p,A!==null&&(A.childLanes|=p)):A!==null&&(A.childLanes&p)!==p&&(A.childLanes|=p),d===b)break;d=d.return}}function Pe(d,p,b,A){var L=d.child;for(L!==null&&(L.return=d);L!==null;){var B=L.dependencies;if(B!==null){var Z=L.child;B=B.firstContext;e:for(;B!==null;){var ne=B;B=L;for(var de=0;de<p.length;de++)if(ne.context===p[de]){B.lanes|=b,ne=B.alternate,ne!==null&&(ne.lanes|=b),ht(B.return,b,d),A||(Z=null);break e}B=ne.next}}else if(L.tag===18){if(Z=L.return,Z===null)throw Error(i(341));Z.lanes|=b,B=Z.alternate,B!==null&&(B.lanes|=b),ht(Z,b,d),Z=null}else Z=L.child;if(Z!==null)Z.return=L;else for(Z=L;Z!==null;){if(Z===d){Z=null;break}if(L=Z.sibling,L!==null){L.return=Z.return,Z=L;break}Z=Z.return}L=Z}}function Zi(d,p,b,A){d=null;for(var L=p,B=!1;L!==null;){if(!B){if((L.flags&524288)!==0)B=!0;else if((L.flags&262144)!==0)break}if(L.tag===10){var Z=L.alternate;if(Z===null)throw Error(i(387));if(Z=Z.memoizedProps,Z!==null){var ne=L.type;un(L.pendingProps.value,Z.value)||(d!==null?d.push(ne):d=[ne])}}else if(L===Kf.current){if(Z=L.alternate,Z===null)throw Error(i(387));Z.memoizedState.memoizedState!==L.memoizedState.memoizedState&&(d!==null?d.push(zr):d=[zr])}L=L.return}d!==null&&Pe(p,d,b,A),p.flags|=262144}function zs(d){for(d=d.firstContext;d!==null;){var p=d.context;if(!un(Lo?p._currentValue:p._currentValue2,d.memoizedValue))return!0;d=d.next}return!1}function oi(d){er=d,ra=null,d=d.dependencies,d!==null&&(d.firstContext=null)}function lt(d){return js(er,d)}function ti(d,p){return er===null&&oi(d),js(d,p)}function js(d,p){var b=Lo?p._currentValue:p._currentValue2;if(p={context:p,memoizedValue:b,next:null},ra===null){if(d===null)throw Error(i(308));ra=p,d.dependencies={lanes:0,firstContext:p},d.flags|=524288}else ra=ra.next=p;return b}function Ys(){return{controller:new zT,data:new Map,refCount:0}}function Xe(d){d.refCount--,d.refCount===0&&kT($f,function(){d.controller.abort()})}function Mt(d){d!==Hl&&d.next===null&&(Hl===null?Zf=Hl=d:Hl=Hl.next=d),Iu=!0,W_||(W_=!0,Ji())}function rs(d,p){if(!Jf&&Iu){Jf=!0;do for(var b=!1,A=Zf;A!==null;){if(d!==0){var L=A.pendingLanes;if(L===0)var B=0;else{var Z=A.suspendedLanes,ne=A.pingedLanes;B=(1<<31-ka(42|d)+1)-1,B&=L&~(Z&~ne),B=B&201326741?B&201326741|1:B?B|2:0}B!==0&&(b=!0,Wi(A,B))}else B=vt,B=M(A,A===Wt?B:0,A.cancelPendingCommit!==null||A.timeoutHandle!==An),(B&3)===0||w(A,B)||(b=!0,Wi(A,B));A=A.next}while(b);Jf=!1}}function bs(){sn()}function sn(){Iu=W_=!1;var d=0;Bo!==0&&(iv()&&(d=Bo),Bo=0);for(var p=ls(),b=null,A=Zf;A!==null;){var L=A.next,B=La(A,p);B===0?(A.next=null,b===null?Zf=L:b.next=L,L===null&&(Hl=b)):(b=A,(d!==0||(B&3)!==0)&&(Iu=!0)),A=L}rs(d)}function La(d,p){for(var b=d.suspendedLanes,A=d.pingedLanes,L=d.expirationTimes,B=d.pendingLanes&-62914561;0<B;){var Z=31-ka(B),ne=1<<Z,de=L[Z];de===-1?((ne&b)===0||(ne&A)!==0)&&(L[Z]=T(ne,p)):de<=p&&(d.expiredLanes|=ne),B&=~ne}if(p=Wt,b=vt,b=M(d,d===p?b:0,d.cancelPendingCommit!==null||d.timeoutHandle!==An),A=d.callbackNode,b===0||d===p&&(Zt===2||Zt===9)||d.cancelPendingCommit!==null)return A!==null&&A!==null&&z_(A),d.callbackNode=null,d.callbackPriority=0;if((b&3)===0||w(d,b)){if(p=b&-b,p===d.callbackPriority)return p;switch(A!==null&&z_(A),Y(b)){case 2:case 8:b=NT;break;case 32:b=k_;break;case 268435456:b=FT;break;default:b=k_}return A=Hi.bind(null,d),b=jf(b,A),d.callbackPriority=p,d.callbackNode=b,p}return A!==null&&A!==null&&z_(A),d.callbackPriority=2,d.callbackNode=null,2}function Hi(d,p){if(vi!==0&&vi!==5)return d.callbackNode=null,d.callbackPriority=0,null;var b=d.callbackNode;if(En()&&d.callbackNode!==b)return null;var A=vt;return A=M(d,d===Wt?A:0,d.cancelPendingCommit!==null||d.timeoutHandle!==An),A===0?null:(Rf(d,A,p),La(d,ls()),d.callbackNode!=null&&d.callbackNode===b?Hi.bind(null,d):null)}function Wi(d,p){if(En())return null;Rf(d,p,!0)}function Ji(){rv?iT(function(){(Ke&6)!==0?jf(Ii,bs):sn()}):jf(Ii,bs)}function an(){return Bo===0&&(Bo=R()),Bo}function su(d,p){if(Ou===null){var b=Ou=[];tr=0,xs=an(),Wl={status:"pending",value:void 0,then:function(A){b.push(A)}}}return tr++,p.then(iu,iu),p}function iu(){if(--tr===0&&Ou!==null){Wl!==null&&(Wl.status="fulfilled");var d=Ou;Ou=null,xs=0,Wl=null;for(var p=0;p<d.length;p++)(0,d[p])()}}function nw(d,p){var b=[],A={status:"pending",value:null,reason:null,then:function(L){b.push(L)}};return d.then(function(){A.status="fulfilled",A.value=p;for(var L=0;L<b.length;L++)(0,b[L])(p)},function(L){for(A.status="rejected",A.reason=L,L=0;L<b.length;L++)(0,b[L])(void 0)}),A}function km(){var d=Bs.current;return d!==null?d:Wt.pooledCache}function nf(d,p){p===null?v(Bs,Bs.current):v(Bs,p.pool)}function Vm(){var d=km();return d===null?null:{parent:Lo?$t._currentValue:$t._currentValue2,pool:d}}function yl(d,p){if(un(d,p))return!0;if(typeof d!="object"||d===null||typeof p!="object"||p===null)return!1;var b=Object.keys(d),A=Object.keys(p);if(b.length!==A.length)return!1;for(A=0;A<b.length;A++){var L=b[A];if(!yw.call(p,L)||!un(d[L],p[L]))return!1}return!0}function wx(d){return d=d.status,d==="fulfilled"||d==="rejected"}function rf(){}function my(d,p,b){switch(b=d[b],b===void 0?d.push(p):b!==p&&(p.then(rf,rf),p=b),p.status){case"fulfilled":return p.value;case"rejected":throw d=p.reason,Hm(d),d;default:if(typeof p.status=="string")p.then(rf,rf);else{if(d=Wt,d!==null&&100<d.shellSuspendCounter)throw Error(i(482));d=p,d.status="pending",d.then(function(A){if(p.status==="pending"){var L=p;L.status="fulfilled",L.value=A}},function(A){if(p.status==="pending"){var L=p;L.status="rejected",L.reason=A}})}switch(p.status){case"fulfilled":return p.value;case"rejected":throw d=p.reason,Hm(d),d}throw Ga=p,Nu}}function Gm(){if(Ga===null)throw Error(i(459));var d=Ga;return Ga=null,d}function Hm(d){if(d===Nu||d===vs)throw Error(i(483))}function of(){for(var d=rc,p=wv=rc=0;p<d;){var b=dn[p];dn[p++]=null;var A=dn[p];dn[p++]=null;var L=dn[p];dn[p++]=null;var B=dn[p];if(dn[p++]=null,A!==null&&L!==null){var Z=A.pending;Z===null?L.next=L:(L.next=Z.next,Z.next=L),A.pending=L}B!==0&&_a(b,L,B)}}function Wm(d,p,b,A){dn[rc++]=d,dn[rc++]=p,dn[rc++]=b,dn[rc++]=A,wv|=A,d.lanes|=A,d=d.alternate,d!==null&&(d.lanes|=A)}function Tr(d,p,b,A){return Wm(d,p,b,A),_o(d)}function si(d,p){return Wm(d,null,null,p),_o(d)}function _a(d,p,b){d.lanes|=b;var A=d.alternate;A!==null&&(A.lanes|=b);for(var L=!1,B=d.return;B!==null;)B.childLanes|=b,A=B.alternate,A!==null&&(A.childLanes|=b),B.tag===22&&(d=B.stateNode,d===null||d._visibility&1||(L=!0)),d=B,B=B.return;return d.tag===3?(B=d.stateNode,L&&p!==null&&(L=31-ka(b),d=B.hiddenUpdates,A=d[L],A===null?d[L]=[p]:A.push(p),p.lane=b|536870912),B):null}function _o(d){if(50<eh)throw eh=0,Q_=null,Error(i(185));for(var p=d.return;p!==null;)d=p,p=d.return;return d.tag===3?d.stateNode:null}function lf(d){d.updateQueue={baseState:d.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function _y(d,p){d=d.updateQueue,p.updateQueue===d&&(p.updateQueue={baseState:d.baseState,firstBaseUpdate:d.firstBaseUpdate,lastBaseUpdate:d.lastBaseUpdate,shared:d.shared,callbacks:null})}function vl(d){return{lane:d,tag:0,payload:null,callback:null,next:null}}function go(d,p,b){var A=d.updateQueue;if(A===null)return null;if(A=A.shared,(Ke&2)!==0){var L=A.pending;return L===null?p.next=p:(p.next=L.next,L.next=p),A.pending=p,p=_o(d),_a(d,null,b),p}return Wm(d,A,p,b),_o(d)}function yo(d,p,b){if(p=p.updateQueue,p!==null&&(p=p.shared,(b&4194048)!==0)){var A=p.lanes;A&=d.pendingLanes,b|=A,p.lanes=b,z(d,b)}}function hf(d,p){var b=d.updateQueue,A=d.alternate;if(A!==null&&(A=A.updateQueue,b===A)){var L=null,B=null;if(b=b.firstBaseUpdate,b!==null){do{var Z={lane:b.lane,tag:b.tag,payload:b.payload,callback:null,next:null};B===null?L=B=Z:B=B.next=Z,b=b.next}while(b!==null);B===null?L=B=p:B=B.next=p}else L=B=p;b={baseState:A.baseState,firstBaseUpdate:L,lastBaseUpdate:B,shared:A.shared,callbacks:A.callbacks},d.updateQueue=b;return}d=b.lastBaseUpdate,d===null?b.firstBaseUpdate=p:d.next=p,b.lastBaseUpdate=p}function Er(){if(Ta){var d=Wl;if(d!==null)throw d}}function Ar(d,p,b,A){Ta=!1;var L=d.updateQueue;Gr=!1;var B=L.firstBaseUpdate,Z=L.lastBaseUpdate,ne=L.shared.pending;if(ne!==null){L.shared.pending=null;var de=ne,we=de.next;de.next=null,Z===null?B=we:Z.next=we,Z=de;var Le=d.alternate;Le!==null&&(Le=Le.updateQueue,ne=Le.lastBaseUpdate,ne!==Z&&(ne===null?Le.firstBaseUpdate=we:ne.next=we,Le.lastBaseUpdate=de))}if(B!==null){var Be=L.baseState;Z=0,Le=we=de=null,ne=B;do{var Ue=ne.lane&-536870913,ut=Ue!==ne.lane;if(ut?(vt&Ue)===Ue:(A&Ue)===Ue){Ue!==0&&Ue===xs&&(Ta=!0),Le!==null&&(Le=Le.next={lane:0,tag:ne.tag,payload:ne.payload,callback:null,next:null});e:{var Rn=d,th=ne;Ue=p;var Mn=b;switch(th.tag){case 1:if(Rn=th.payload,typeof Rn=="function"){Be=Rn.call(Mn,Be,Ue);break e}Be=Rn;break e;case 3:Rn.flags=Rn.flags&-65537|128;case 0:if(Rn=th.payload,Ue=typeof Rn=="function"?Rn.call(Mn,Be,Ue):Rn,Ue==null)break e;Be=Zh({},Be,Ue);break e;case 2:Gr=!0}}Ue=ne.callback,Ue!==null&&(d.flags|=64,ut&&(d.flags|=8192),ut=L.callbacks,ut===null?L.callbacks=[Ue]:ut.push(Ue))}else ut={lane:Ue,tag:ne.tag,payload:ne.payload,callback:ne.callback,next:null},Le===null?(we=Le=ut,de=Be):Le=Le.next=ut,Z|=Ue;if(ne=ne.next,ne===null){if(ne=L.shared.pending,ne===null)break;ut=ne,ne=ut.next,ut.next=null,L.lastBaseUpdate=ut,L.shared.pending=null}}while(!0);Le===null&&(de=Be),L.baseState=de,L.firstBaseUpdate=we,L.lastBaseUpdate=Le,B===null&&(L.shared.lanes=0),fi|=Z,d.lanes=Z,d.memoizedState=Be}}function au(d,p){if(typeof d!="function")throw Error(i(191,d));d.call(p)}function Ih(d,p){var b=d.callbacks;if(b!==null)for(d.callbacks=null,d=0;d<b.length;d++)au(b[d],p)}function gi(d,p){d=ai,v(ep,d),v(oa,p),ai=d|p.baseLanes}function qm(){v(ep,ai),v(oa,oa.current)}function Xm(){ai=ep.current,y(oa),y(ep)}function ys(){throw Error(i(321))}function Sl(d,p){if(p===null)return!1;for(var b=0;b<p.length&&b<d.length;b++)if(!un(d[b],p[b]))return!1;return!0}function gy(d,p,b,A,L,B){return ui=B,pt=p,p.memoizedState=null,p.updateQueue=null,p.lanes=0,je.H=d===null||d.memoizedState===null?oc:Rv,Uo=!1,B=b(A,L),Uo=!1,ql&&(B=vy(p,b,A,L)),yy(d),B}function yy(d){je.H=Xl;var p=It!==null&&It.next!==null;if(ui=0,Ts=It=pt=null,sr=!1,Fu=0,ir=null,p)throw Error(i(300));d===null||at||(d=d.dependencies,d!==null&&zs(d)&&(at=!0))}function vy(d,p,b,A){pt=d;var L=0;do{if(ql&&(ir=null),Fu=0,ql=!1,25<=L)throw Error(i(301));if(L+=1,Ts=It=null,d.updateQueue!=null){var B=d.updateQueue;B.lastEffect=null,B.events=null,B.stores=null,B.memoCache!=null&&(B.memoCache.index=0)}je.H=VT,B=p(b,A)}while(ql);return B}function rw(){var d=je.H,p=d.useState()[0];return p=typeof p.then=="function"?Oh(p):p,d=d.useState()[0],(It!==null?It.memoizedState:null)!==d&&(pt.flags|=1024),p}function nu(){var d=fn!==0;return fn=0,d}function ru(d,p,b){p.updateQueue=d.updateQueue,p.flags&=-2053,d.lanes&=~b}function Yn(d){if(sr){for(d=d.memoizedState;d!==null;){var p=d.queue;p!==null&&(p.pending=null),d=d.next}sr=!1}ui=0,Ts=It=pt=null,ql=!1,Fu=fn=0,ir=null}function ea(){var d={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Ts===null?pt.memoizedState=Ts=d:Ts=Ts.next=d,Ts}function ii(){if(It===null){var d=pt.alternate;d=d!==null?d.memoizedState:null}else d=It.next;var p=Ts===null?pt.memoizedState:Ts.next;if(p!==null)Ts=p,It=d;else{if(d===null)throw pt.alternate===null?Error(i(467)):Error(i(310));It=d,d={memoizedState:It.memoizedState,baseState:It.baseState,baseQueue:It.baseQueue,queue:It.queue,next:null},Ts===null?pt.memoizedState=Ts=d:Ts=Ts.next=d}return Ts}function bl(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function Oh(d){var p=Fu;return Fu+=1,ir===null&&(ir=[]),d=my(ir,d,p),p=pt,(Ts===null?p.memoizedState:Ts.next)===null&&(p=p.alternate,je.H=p===null||p.memoizedState===null?oc:Rv),d}function ou(d){if(d!==null&&typeof d=="object"){if(typeof d.then=="function")return Oh(d);if(d.$$typeof===Do)return lt(d)}throw Error(i(438,String(d)))}function Sy(d){var p=null,b=pt.updateQueue;if(b!==null&&(p=b.memoCache),p==null){var A=pt.alternate;A!==null&&(A=A.updateQueue,A!==null&&(A=A.memoCache,A!=null&&(p={data:A.data.map(function(L){return L.slice()}),index:0})))}if(p==null&&(p={data:[],index:0}),b===null&&(b=bl(),pt.updateQueue=b),b.memoCache=p,b=p.data[p.index],b===void 0)for(b=p.data[p.index]=Array(d),A=0;A<d;A++)b[A]=Jy;return p.index++,b}function Cr(d,p){return typeof p=="function"?p(d):p}function ga(d){var p=ii();return jm(p,It,d)}function jm(d,p,b){var A=d.queue;if(A===null)throw Error(i(311));A.lastRenderedReducer=b;var L=d.baseQueue,B=A.pending;if(B!==null){if(L!==null){var Z=L.next;L.next=B.next,B.next=Z}p.baseQueue=L=B,A.pending=null}if(B=d.baseState,L===null)d.memoizedState=B;else{p=L.next;var ne=Z=null,de=null,we=p,Le=!1;do{var Be=we.lane&-536870913;if(Be!==we.lane?(vt&Be)===Be:(ui&Be)===Be){var Ue=we.revertLane;if(Ue===0)de!==null&&(de=de.next={lane:0,revertLane:0,action:we.action,hasEagerState:we.hasEagerState,eagerState:we.eagerState,next:null}),Be===xs&&(Le=!0);else if((ui&Ue)===Ue){we=we.next,Ue===xs&&(Le=!0);continue}else Be={lane:0,revertLane:we.revertLane,action:we.action,hasEagerState:we.hasEagerState,eagerState:we.eagerState,next:null},de===null?(ne=de=Be,Z=B):de=de.next=Be,pt.lanes|=Ue,fi|=Ue;Be=we.action,Uo&&b(B,Be),B=we.hasEagerState?we.eagerState:b(B,Be)}else Ue={lane:Be,revertLane:we.revertLane,action:we.action,hasEagerState:we.hasEagerState,eagerState:we.eagerState,next:null},de===null?(ne=de=Ue,Z=B):de=de.next=Ue,pt.lanes|=Be,fi|=Be;we=we.next}while(we!==null&&we!==p);if(de===null?Z=B:de.next=ne,!un(B,d.memoizedState)&&(at=!0,Le&&(b=Wl,b!==null)))throw b;d.memoizedState=B,d.baseState=Z,d.baseQueue=de,A.lastRenderedState=B}return L===null&&(A.lanes=0),[d.memoizedState,A.dispatch]}function by(d){var p=ii(),b=p.queue;if(b===null)throw Error(i(311));b.lastRenderedReducer=d;var A=b.dispatch,L=b.pending,B=p.memoizedState;if(L!==null){b.pending=null;var Z=L=L.next;do B=d(B,Z.action),Z=Z.next;while(Z!==L);un(B,p.memoizedState)||(at=!0),p.memoizedState=B,p.baseQueue===null&&(p.baseState=B),b.lastRenderedState=B}return[B,A]}function cf(d,p,b){var A=pt,L=ii(),B=zt;if(B){if(b===void 0)throw Error(i(407));b=b()}else b=p();var Z=!un((It||L).memoizedState,b);Z&&(L.memoizedState=b,at=!0),L=L.queue;var ne=Rx.bind(null,A,L,d);if(Bh(2048,8,ne,[d]),L.getSnapshot!==p||Z||Ts!==null&&Ts.memoizedState.tag&1){if(A.flags|=2048,xl(9,vo(),uf.bind(null,A,L,b,p),null),Wt===null)throw Error(i(349));B||(ui&124)!==0||xy(A,p,b)}return b}function xy(d,p,b){d.flags|=16384,d={getSnapshot:p,value:b},p=pt.updateQueue,p===null?(p=bl(),pt.updateQueue=p,p.stores=[d]):(b=p.stores,b===null?p.stores=[d]:b.push(d))}function uf(d,p,b,A){p.value=b,p.getSnapshot=A,nn(p)&&Ym(d)}function Rx(d,p,b){return b(function(){nn(p)&&Ym(d)})}function nn(d){var p=d.getSnapshot;d=d.value;try{var b=p();return!un(d,b)}catch{return!0}}function Ym(d){var p=si(d,2);p!==null&&ia(p,d,2)}function Km(d){var p=ea();if(typeof d=="function"){var b=d;if(d=b(),Uo){F(!0);try{b()}finally{F(!1)}}}return p.memoizedState=p.baseState=d,p.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Cr,lastRenderedState:d},p}function Qm(d,p,b,A){return d.baseState=b,jm(d,It,typeof A=="function"?A:Cr)}function lu(d,p,b,A,L){if(gf(d))throw Error(i(485));if(d=p.action,d!==null){var B={payload:L,action:d,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(Z){B.listeners.push(Z)}};je.T!==null?b(!0):B.isTransition=!1,A(B),b=p.pending,b===null?(B.next=p.pending=B,Ty(p,B)):(B.next=b.next,p.pending=b.next=B)}}function Ty(d,p){var b=p.action,A=p.payload,L=d.state;if(p.isTransition){var B=je.T,Z={};je.T=Z;try{var ne=b(L,A),de=je.S;de!==null&&de(Z,ne),Ey(d,p,ne)}catch(we){Ay(d,p,we)}finally{je.T=B}}else try{B=b(L,A),Ey(d,p,B)}catch(we){Ay(d,p,we)}}function Ey(d,p,b){b!==null&&typeof b=="object"&&typeof b.then=="function"?b.then(function(A){Nh(d,p,A)},function(A){return Ay(d,p,A)}):Nh(d,p,b)}function Nh(d,p,b){p.status="fulfilled",p.value=b,Cy(p),d.state=b,p=d.pending,p!==null&&(b=p.next,b===p?d.pending=null:(b=b.next,p.next=b,Ty(d,b)))}function Ay(d,p,b){var A=d.pending;if(d.pending=null,A!==null){A=A.next;do p.status="rejected",p.reason=b,Cy(p),p=p.next;while(p!==A)}d.action=null}function Cy(d){d=d.listeners;for(var p=0;p<d.length;p++)(0,d[p])()}function wy(d,p){return p}function $m(d,p){if(zt){var b=Wt.formState;if(b!==null){e:{var A=pt;if(zt){if(ci){var L=bT(ci,Yt);if(L){ci=TT(L),A=xT(L);break e}}te(A)}A=!1}A&&(p=b[0])}}b=ea(),b.memoizedState=b.baseState=p,A={pending:null,lanes:0,dispatch:null,lastRenderedReducer:wy,lastRenderedState:p},b.queue=A,b=t_.bind(null,pt,A),A.dispatch=b,A=Km(!1);var B=fu.bind(null,pt,!1,A.queue);return A=ea(),L={state:p,dispatch:null,action:d,pending:null},A.queue=L,b=lu.bind(null,pt,L,B,b),L.dispatch=b,A.memoizedState=d,[p,b,!1]}function Mx(d){var p=ii();return Dx(p,It,d)}function Dx(d,p,b){if(p=jm(d,p,wy)[0],d=ga(Cr)[0],typeof p=="object"&&p!==null&&typeof p.then=="function")try{var A=Oh(p)}catch(Z){throw Z===Nu?vs:Z}else A=p;p=ii();var L=p.queue,B=L.dispatch;return b!==p.memoizedState&&(pt.flags|=2048,xl(9,vo(),Zm.bind(null,L,b),null)),[A,B,d]}function Zm(d,p){d.action=p}function Jm(d){var p=ii(),b=It;if(b!==null)return Dx(p,b,d);ii(),p=p.memoizedState,b=ii();var A=b.queue.dispatch;return b.memoizedState=d,[p,A,!1]}function xl(d,p,b,A){return d={tag:d,create:b,deps:A,inst:p,next:null},p=pt.updateQueue,p===null&&(p=bl(),pt.updateQueue=p),b=p.lastEffect,b===null?p.lastEffect=d.next=d:(A=b.next,b.next=d,d.next=A,p.lastEffect=d),d}function vo(){return{destroy:void 0,resource:void 0}}function Fh(){return ii().memoizedState}function df(d,p,b,A){var L=ea();A=A===void 0?null:A,pt.flags|=d,L.memoizedState=xl(1|p,vo(),b,A)}function Bh(d,p,b,A){var L=ii();A=A===void 0?null:A;var B=L.memoizedState.inst;It!==null&&A!==null&&Sl(A,It.memoizedState.deps)?L.memoizedState=xl(p,B,b,A):(pt.flags|=d,L.memoizedState=xl(1|p,B,b,A))}function Ry(d,p){df(8390656,8,d,p)}function hu(d,p){Bh(2048,8,d,p)}function wr(d,p){return Bh(4,2,d,p)}function e_(d,p){return Bh(4,4,d,p)}function cu(d,p){if(typeof p=="function"){d=d();var b=p(d);return function(){typeof b=="function"?b():p(null)}}if(p!=null)return d=d(),p.current=d,function(){p.current=null}}function So(d,p,b){b=b!=null?b.concat([d]):null,Bh(4,4,cu.bind(null,p,d),b)}function ff(){}function pf(d,p){var b=ii();p=p===void 0?null:p;var A=b.memoizedState;return p!==null&&Sl(p,A[1])?A[0]:(b.memoizedState=[d,p],d)}function My(d,p){var b=ii();p=p===void 0?null:p;var A=b.memoizedState;if(p!==null&&Sl(p,A[1]))return A[0];if(A=d(),Uo){F(!0);try{d()}finally{F(!1)}}return b.memoizedState=[A,p],A}function uu(d,p,b){return b===void 0||(ui&1073741824)!==0?d.memoizedState=p:(d.memoizedState=b,d=Xh(),pt.lanes|=d,fi|=d,b)}function mf(d,p,b,A){return un(b,p)?b:oa.current!==null?(d=uu(d,b,A),un(d,p)||(at=!0),d):(ui&42)===0?(at=!0,d.memoizedState=b):(d=Xh(),pt.lanes|=d,fi|=d,p)}function Dy(d,p,b,A,L){var B=$n();Li(B!==0&&8>B?B:8);var Z=je.T,ne={};je.T=ne,fu(d,!1,p,b);try{var de=L(),we=je.S;if(we!==null&&we(ne,de),de!==null&&typeof de=="object"&&typeof de.then=="function"){var Le=nw(de,A);xo(d,p,Le,Pi(d))}else xo(d,p,A,Pi(d))}catch(Be){xo(d,p,{then:function(){},status:"rejected",reason:Be},Pi())}finally{Li(B),je.T=Z}}function ya(d){var p=d.memoizedState;if(p!==null)return p;p={memoizedState:za,baseState:za,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Cr,lastRenderedState:za},next:null};var b={};return p.next={memoizedState:b,baseState:b,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Cr,lastRenderedState:b},next:null},d.memoizedState=p,d=d.alternate,d!==null&&(d.memoizedState=p),p}function bo(){return lt(zr)}function _f(){return ii().memoizedState}function du(){return ii().memoizedState}function ow(d){for(var p=d.return;p!==null;){switch(p.tag){case 24:case 3:var b=Pi();d=vl(b);var A=go(p,d,b);A!==null&&(ia(A,p,b),yo(A,p,b)),p={cache:Ys()},d.payload=p;return}p=p.return}}function Py(d,p,b){var A=Pi();b={lane:A,revertLane:0,action:b,hasEagerState:!1,eagerState:null,next:null},gf(d)?Px(p,b):(b=Tr(d,p,b,A),b!==null&&(ia(b,d,A),Lx(b,p,A)))}function t_(d,p,b){var A=Pi();xo(d,p,b,A)}function xo(d,p,b,A){var L={lane:A,revertLane:0,action:b,hasEagerState:!1,eagerState:null,next:null};if(gf(d))Px(p,L);else{var B=d.alternate;if(d.lanes===0&&(B===null||B.lanes===0)&&(B=p.lastRenderedReducer,B!==null))try{var Z=p.lastRenderedState,ne=B(Z,b);if(L.hasEagerState=!0,L.eagerState=ne,un(ne,Z))return Wm(d,p,L,0),Wt===null&&of(),!1}catch{}finally{}if(b=Tr(d,p,L,A),b!==null)return ia(b,d,A),Lx(b,p,A),!0}return!1}function fu(d,p,b,A){if(A={lane:2,revertLane:an(),action:A,hasEagerState:!1,eagerState:null,next:null},gf(d)){if(p)throw Error(i(479))}else p=Tr(d,b,A,2),p!==null&&ia(p,d,2)}function gf(d){var p=d.alternate;return d===pt||p!==null&&p===pt}function Px(d,p){ql=sr=!0;var b=d.pending;b===null?p.next=p:(p.next=b.next,b.next=p),d.pending=p}function Lx(d,p,b){if((b&4194048)!==0){var A=p.lanes;A&=d.pendingLanes,b|=A,p.lanes=b,z(d,b)}}function s_(d){var p=Bu;return Bu+=1,Hr===null&&(Hr=[]),my(Hr,d,p)}function Uh(d,p){p=p.props.ref,d.ref=p!==void 0?p:null}function i_(d,p){throw p.$$typeof===Jx?Error(i(525)):(d=Object.prototype.toString.call(p),Error(i(31,d==="[object Object]"?"object with keys {"+Object.keys(p).join(", ")+"}":d)))}function Ix(d){var p=d._init;return p(d._payload)}function Ox(d){function p(me,ce){if(d){var ve=me.deletions;ve===null?(me.deletions=[ce],me.flags|=16):ve.push(ce)}}function b(me,ce){if(!d)return null;for(;ce!==null;)p(me,ce),ce=ce.sibling;return null}function A(me){for(var ce=new Map;me!==null;)me.key!==null?ce.set(me.key,me):ce.set(me.index,me),me=me.sibling;return ce}function L(me,ce){return me=Ro(me,ce),me.index=0,me.sibling=null,me}function B(me,ce,ve){return me.index=ve,d?(ve=me.alternate,ve!==null?(ve=ve.index,ve<ce?(me.flags|=67108866,ce):ve):(me.flags|=67108866,ce)):(me.flags|=1048576,ce)}function Z(me){return d&&me.alternate===null&&(me.flags|=67108866),me}function ne(me,ce,ve,Re){return ce===null||ce.tag!==6?(ce=Qh(ve,me.mode,Re),ce.return=me,ce):(ce=L(ce,ve),ce.return=me,ce)}function de(me,ce,ve,Re){var ke=ve.type;return ke===ec?Le(me,ce,ve.props.children,Re,ve.key):ce!==null&&(ce.elementType===ke||typeof ke=="object"&&ke!==null&&ke.$$typeof===va&&Ix(ke)===ce.type)?(ce=L(ce,ve.props),Uh(ce,ve),ce.return=me,ce):(ce=xu(ve.type,ve.key,ve.props,null,me.mode,Re),Uh(ce,ve),ce.return=me,ce)}function we(me,ce,ve,Re){return ce===null||ce.tag!==4||ce.stateNode.containerInfo!==ve.containerInfo||ce.stateNode.implementation!==ve.implementation?(ce=Mf(ve,me.mode,Re),ce.return=me,ce):(ce=L(ce,ve.children||[]),ce.return=me,ce)}function Le(me,ce,ve,Re,ke){return ce===null||ce.tag!==7?(ce=Qn(ve,me.mode,Re,ke),ce.return=me,ce):(ce=L(ce,ve),ce.return=me,ce)}function Be(me,ce,ve){if(typeof ce=="string"&&ce!==""||typeof ce=="number"||typeof ce=="bigint")return ce=Qh(""+ce,me.mode,ve),ce.return=me,ce;if(typeof ce=="object"&&ce!==null){switch(ce.$$typeof){case Jh:return ve=xu(ce.type,ce.key,ce.props,null,me.mode,ve),Uh(ve,ce),ve.return=me,ve;case Il:return ce=Mf(ce,me.mode,ve),ce.return=me,ce;case va:var Re=ce._init;return ce=Re(ce._payload),Be(me,ce,ve)}if(Ol(ce)||f(ce))return ce=Qn(ce,me.mode,ve,null),ce.return=me,ce;if(typeof ce.then=="function")return Be(me,s_(ce),ve);if(ce.$$typeof===Do)return Be(me,ti(me,ce),ve);i_(me,ce)}return null}function Ue(me,ce,ve,Re){var ke=ce!==null?ce.key:null;if(typeof ve=="string"&&ve!==""||typeof ve=="number"||typeof ve=="bigint")return ke!==null?null:ne(me,ce,""+ve,Re);if(typeof ve=="object"&&ve!==null){switch(ve.$$typeof){case Jh:return ve.key===ke?de(me,ce,ve,Re):null;case Il:return ve.key===ke?we(me,ce,ve,Re):null;case va:return ke=ve._init,ve=ke(ve._payload),Ue(me,ce,ve,Re)}if(Ol(ve)||f(ve))return ke!==null?null:Le(me,ce,ve,Re,null);if(typeof ve.then=="function")return Ue(me,ce,s_(ve),Re);if(ve.$$typeof===Do)return Ue(me,ce,ti(me,ve),Re);i_(me,ve)}return null}function ut(me,ce,ve,Re,ke){if(typeof Re=="string"&&Re!==""||typeof Re=="number"||typeof Re=="bigint")return me=me.get(ve)||null,ne(ce,me,""+Re,ke);if(typeof Re=="object"&&Re!==null){switch(Re.$$typeof){case Jh:return me=me.get(Re.key===null?ve:Re.key)||null,de(ce,me,Re,ke);case Il:return me=me.get(Re.key===null?ve:Re.key)||null,we(ce,me,Re,ke);case va:var is=Re._init;return Re=is(Re._payload),ut(me,ce,ve,Re,ke)}if(Ol(Re)||f(Re))return me=me.get(ve)||null,Le(ce,me,Re,ke,null);if(typeof Re.then=="function")return ut(me,ce,ve,s_(Re),ke);if(Re.$$typeof===Do)return ut(me,ce,ve,ti(ce,Re),ke);i_(ce,Re)}return null}function Rn(me,ce,ve,Re){for(var ke=null,is=null,et=ce,qt=ce=0,Si=null;et!==null&&qt<ve.length;qt++){et.index>qt?(Si=et,et=null):Si=et.sibling;var Xt=Ue(me,et,ve[qt],Re);if(Xt===null){et===null&&(et=Si);break}d&&et&&Xt.alternate===null&&p(me,et),ce=B(Xt,ce,qt),is===null?ke=Xt:is.sibling=Xt,is=Xt,et=Si}if(qt===ve.length)return b(me,et),zt&&ee(me,qt),ke;if(et===null){for(;qt<ve.length;qt++)et=Be(me,ve[qt],Re),et!==null&&(ce=B(et,ce,qt),is===null?ke=et:is.sibling=et,is=et);return zt&&ee(me,qt),ke}for(et=A(et);qt<ve.length;qt++)Si=ut(et,me,qt,ve[qt],Re),Si!==null&&(d&&Si.alternate!==null&&et.delete(Si.key===null?qt:Si.key),ce=B(Si,ce,qt),is===null?ke=Si:is.sibling=Si,is=Si);return d&&et.forEach(function(Vo){return p(me,Vo)}),zt&&ee(me,qt),ke}function th(me,ce,ve,Re){if(ve==null)throw Error(i(151));for(var ke=null,is=null,et=ce,qt=ce=0,Si=null,Xt=ve.next();et!==null&&!Xt.done;qt++,Xt=ve.next()){et.index>qt?(Si=et,et=null):Si=et.sibling;var Vo=Ue(me,et,Xt.value,Re);if(Vo===null){et===null&&(et=Si);break}d&&et&&Vo.alternate===null&&p(me,et),ce=B(Vo,ce,qt),is===null?ke=Vo:is.sibling=Vo,is=Vo,et=Si}if(Xt.done)return b(me,et),zt&&ee(me,qt),ke;if(et===null){for(;!Xt.done;qt++,Xt=ve.next())Xt=Be(me,Xt.value,Re),Xt!==null&&(ce=B(Xt,ce,qt),is===null?ke=Xt:is.sibling=Xt,is=Xt);return zt&&ee(me,qt),ke}for(et=A(et);!Xt.done;qt++,Xt=ve.next())Xt=ut(et,me,qt,Xt.value,Re),Xt!==null&&(d&&Xt.alternate!==null&&et.delete(Xt.key===null?qt:Xt.key),ce=B(Xt,ce,qt),is===null?ke=Xt:is.sibling=Xt,is=Xt);return d&&et.forEach(function(vw){return p(me,vw)}),zt&&ee(me,qt),ke}function Mn(me,ce,ve,Re){if(typeof ve=="object"&&ve!==null&&ve.type===ec&&ve.key===null&&(ve=ve.props.children),typeof ve=="object"&&ve!==null){switch(ve.$$typeof){case Jh:e:{for(var ke=ve.key;ce!==null;){if(ce.key===ke){if(ke=ve.type,ke===ec){if(ce.tag===7){b(me,ce.sibling),Re=L(ce,ve.props.children),Re.return=me,me=Re;break e}}else if(ce.elementType===ke||typeof ke=="object"&&ke!==null&&ke.$$typeof===va&&Ix(ke)===ce.type){b(me,ce.sibling),Re=L(ce,ve.props),Uh(Re,ve),Re.return=me,me=Re;break e}b(me,ce);break}else p(me,ce);ce=ce.sibling}ve.type===ec?(Re=Qn(ve.props.children,me.mode,Re,ve.key),Re.return=me,me=Re):(Re=xu(ve.type,ve.key,ve.props,null,me.mode,Re),Uh(Re,ve),Re.return=me,me=Re)}return Z(me);case Il:e:{for(ke=ve.key;ce!==null;){if(ce.key===ke)if(ce.tag===4&&ce.stateNode.containerInfo===ve.containerInfo&&ce.stateNode.implementation===ve.implementation){b(me,ce.sibling),Re=L(ce,ve.children||[]),Re.return=me,me=Re;break e}else{b(me,ce);break}else p(me,ce);ce=ce.sibling}Re=Mf(ve,me.mode,Re),Re.return=me,me=Re}return Z(me);case va:return ke=ve._init,ve=ke(ve._payload),Mn(me,ce,ve,Re)}if(Ol(ve))return Rn(me,ce,ve,Re);if(f(ve)){if(ke=f(ve),typeof ke!="function")throw Error(i(150));return ve=ke.call(ve),th(me,ce,ve,Re)}if(typeof ve.then=="function")return Mn(me,ce,s_(ve),Re);if(ve.$$typeof===Do)return Mn(me,ce,ti(me,ve),Re);i_(me,ve)}return typeof ve=="string"&&ve!==""||typeof ve=="number"||typeof ve=="bigint"?(ve=""+ve,ce!==null&&ce.tag===6?(b(me,ce.sibling),Re=L(ce,ve),Re.return=me,me=Re):(b(me,ce),Re=Qh(ve,me.mode,Re),Re.return=me,me=Re),Z(me)):b(me,ce)}return function(me,ce,ve,Re){try{Bu=0;var ke=Mn(me,ce,ve,Re);return Hr=null,ke}catch(et){if(et===Nu||et===vs)throw et;var is=t(29,et,null,me.mode);return is.lanes=Re,is.return=me,is}finally{}}}function Tl(d){var p=d.alternate;v(st,st.current&1),v(Cn,d),Wr===null&&(p===null||oa.current!==null||p.memoizedState!==null)&&(Wr=d)}function Nx(d){if(d.tag===22){if(v(st,st.current),v(Cn,d),Wr===null){var p=d.alternate;p!==null&&p.memoizedState!==null&&(Wr=d)}}else To()}function To(){v(st,st.current),v(Cn,Cn.current)}function Eo(d){y(Cn),Wr===d&&(Wr=null),y(st)}function a_(d){for(var p=d;p!==null;){if(p.tag===13){var b=p.memoizedState;if(b!==null&&(b=b.dehydrated,b===null||Vf(b)||O_(b)))return p}else if(p.tag===19&&p.memoizedProps.revealOrder!==void 0){if((p.flags&128)!==0)return p}else if(p.child!==null){p.child.return=p,p=p.child;continue}if(p===d)break;for(;p.sibling===null;){if(p.return===null||p.return===d)return null;p=p.return}p.sibling.return=p.return,p=p.sibling}return null}function Ly(d,p,b,A){p=d.memoizedState,b=b(A,p),b=b==null?p:Zh({},p,b),d.memoizedState=b,d.lanes===0&&(d.updateQueue.baseState=b)}function Fx(d,p,b,A,L,B,Z){return d=d.stateNode,typeof d.shouldComponentUpdate=="function"?d.shouldComponentUpdate(A,B,Z):p.prototype&&p.prototype.isPureReactComponent?!yl(b,A)||!yl(L,B):!0}function n_(d,p,b,A){d=p.state,typeof p.componentWillReceiveProps=="function"&&p.componentWillReceiveProps(b,A),typeof p.UNSAFE_componentWillReceiveProps=="function"&&p.UNSAFE_componentWillReceiveProps(b,A),p.state!==d&&hs.enqueueReplaceState(p,p.state,null)}function zh(d,p){var b=p;if("ref"in p){b={};for(var A in p)A!=="ref"&&(b[A]=p[A])}if(d=d.defaultProps){b===p&&(b=Zh({},b));for(var L in d)b[L]===void 0&&(b[L]=d[L])}return b}function r_(d,p){try{var b=d.onUncaughtError;b(p.value,{componentStack:p.stack})}catch(A){setTimeout(function(){throw A})}}function Bx(d,p,b){try{var A=d.onCaughtError;A(b.value,{componentStack:b.stack,errorBoundary:p.tag===1?p.stateNode:null})}catch(L){setTimeout(function(){throw L})}}function o_(d,p,b){return b=vl(b),b.tag=3,b.payload={element:null},b.callback=function(){r_(d,p)},b}function Ux(d){return d=vl(d),d.tag=3,d}function zx(d,p,b,A){var L=b.type.getDerivedStateFromError;if(typeof L=="function"){var B=A.value;d.payload=function(){return L(B)},d.callback=function(){Bx(p,b,A)}}var Z=b.stateNode;Z!==null&&typeof Z.componentDidCatch=="function"&&(d.callback=function(){Bx(p,b,A),typeof L!="function"&&(jr===null?jr=new Set([this]):jr.add(this));var ne=A.stack;this.componentDidCatch(A.value,{componentStack:ne!==null?ne:""})})}function lw(d,p,b,A,L){if(b.flags|=32768,A!==null&&typeof A=="object"&&typeof A.then=="function"){if(p=b.alternate,p!==null&&Zi(p,b,L,!0),b=Cn.current,b!==null){switch(b.tag){case 13:return Wr===null?Fs():b.alternate===null&&Gs===0&&(Gs=3),b.flags&=-257,b.flags|=65536,b.lanes=L,A===Xi?b.flags|=16384:(p=b.updateQueue,p===null?b.updateQueue=new Set([A]):p.add(A),Kh(d,A,L)),!1;case 22:return b.flags|=65536,A===Xi?b.flags|=16384:(p=b.updateQueue,p===null?(p={transitions:null,markerInstances:null,retryQueue:new Set([A])},b.updateQueue=p):(b=p.retryQueue,b===null?p.retryQueue=new Set([A]):b.add(A)),Kh(d,A,L)),!1}throw Error(i(435,b.tag))}return Kh(d,A,L),Fs(),!1}if(zt)return p=Cn.current,p!==null?((p.flags&65536)===0&&(p.flags|=256),p.flags|=65536,p.lanes=L,A!==Av&&(d=Error(i(422),{cause:A}),ot(K(d,b)))):(A!==Av&&(p=Error(i(423),{cause:A}),ot(K(p,b))),d=d.current.alternate,d.flags|=65536,L&=-L,d.lanes|=L,A=K(A,b),L=o_(d.stateNode,A,L),hf(d,L),Gs!==4&&(Gs=2)),!1;var B=Error(i(520),{cause:A});if(B=K(B,b),$l===null?$l=[B]:$l.push(B),Gs!==4&&(Gs=2),p===null)return!0;A=K(A,b),b=p;do{switch(b.tag){case 3:return b.flags|=65536,d=L&-L,b.lanes|=d,d=o_(b.stateNode,A,d),hf(b,d),!1;case 1:if(p=b.type,B=b.stateNode,(b.flags&128)===0&&(typeof p.getDerivedStateFromError=="function"||B!==null&&typeof B.componentDidCatch=="function"&&(jr===null||!jr.has(B))))return b.flags|=65536,L&=-L,b.lanes|=L,L=Ux(L),zx(L,d,b,A),hf(b,L),!1}b=b.return}while(b!==null);return!1}function qi(d,p,b,A){p.child=d===null?Mv(p,null,b,A):zo(p,d.child,b,A)}function kx(d,p,b,A,L){b=b.render;var B=p.ref;if("ref"in A){var Z={};for(var ne in A)ne!=="ref"&&(Z[ne]=A[ne])}else Z=A;return oi(p),A=gy(d,p,b,Z,B,L),ne=nu(),d!==null&&!at?(ru(d,p,L),rn(d,p,L)):(zt&&ne&&Q(p),p.flags|=1,qi(d,p,A,L),p.child)}function Vx(d,p,b,A,L){if(d===null){var B=b.type;return typeof B=="function"&&!Ky(B)&&B.defaultProps===void 0&&b.compare===null?(p.tag=15,p.type=B,Gx(d,p,B,A,L)):(d=xu(b.type,null,A,p,p.mode,L),d.ref=p.ref,d.return=p,p.child=d)}if(B=d.child,!Vh(d,L)){var Z=B.memoizedProps;if(b=b.compare,b=b!==null?b:yl,b(Z,A)&&d.ref===p.ref)return rn(d,p,L)}return p.flags|=1,d=Ro(B,A),d.ref=p.ref,d.return=p,p.child=d}function Gx(d,p,b,A,L){if(d!==null){var B=d.memoizedProps;if(yl(B,A)&&d.ref===p.ref)if(at=!1,p.pendingProps=A=B,Vh(d,L))(d.flags&131072)!==0&&(at=!0);else return p.lanes=d.lanes,rn(d,p,L)}return kh(d,p,b,A,L)}function Hx(d,p,b){var A=p.pendingProps,L=A.children,B=d!==null?d.memoizedState:null;if(A.mode==="hidden"){if((p.flags&128)!==0){if(A=B!==null?B.baseLanes|b:b,d!==null){for(L=p.child=d.child,B=0;L!==null;)B=B|L.lanes|L.childLanes,L=L.sibling;p.childLanes=B&~A}else p.childLanes=0,p.child=null;return Wx(d,p,A,b)}if((b&536870912)!==0)p.memoizedState={baseLanes:0,cachePool:null},d!==null&&nf(p,B!==null?B.cachePool:null),B!==null?gi(p,B):qm(),Nx(p);else return p.lanes=p.childLanes=536870912,Wx(d,p,B!==null?B.baseLanes|b:b,b)}else B!==null?(nf(p,B.cachePool),gi(p,B),To(),p.memoizedState=null):(d!==null&&nf(p,null),qm(),To());return qi(d,p,L,b),p.child}function Wx(d,p,b,A){var L=km();return L=L===null?null:{parent:Lo?$t._currentValue:$t._currentValue2,pool:L},p.memoizedState={baseLanes:b,cachePool:L},d!==null&&nf(p,null),qm(),Nx(p),d!==null&&Zi(d,p,A,!0),null}function pu(d,p){var b=p.ref;if(b===null)d!==null&&d.ref!==null&&(p.flags|=4194816);else{if(typeof b!="function"&&typeof b!="object")throw Error(i(284));(d===null||d.ref!==b)&&(p.flags|=4194816)}}function kh(d,p,b,A,L){return oi(p),b=gy(d,p,b,A,void 0,L),A=nu(),d!==null&&!at?(ru(d,p,L),rn(d,p,L)):(zt&&A&&Q(p),p.flags|=1,qi(d,p,b,L),p.child)}function qx(d,p,b,A,L,B){return oi(p),p.updateQueue=null,b=vy(p,A,b,L),yy(d),A=nu(),d!==null&&!at?(ru(d,p,B),rn(d,p,B)):(zt&&A&&Q(p),p.flags|=1,qi(d,p,b,B),p.child)}function Iy(d,p,b,A,L){if(oi(p),p.stateNode===null){var B=ac,Z=b.contextType;typeof Z=="object"&&Z!==null&&(B=lt(Z)),B=new b(A,B),p.memoizedState=B.state!==null&&B.state!==void 0?B.state:null,B.updater=hs,p.stateNode=B,B._reactInternals=p,B=p.stateNode,B.props=A,B.state=p.memoizedState,B.refs={},lf(p),Z=b.contextType,B.context=typeof Z=="object"&&Z!==null?lt(Z):ac,B.state=p.memoizedState,Z=b.getDerivedStateFromProps,typeof Z=="function"&&(Ly(p,b,Z,A),B.state=p.memoizedState),typeof b.getDerivedStateFromProps=="function"||typeof B.getSnapshotBeforeUpdate=="function"||typeof B.UNSAFE_componentWillMount!="function"&&typeof B.componentWillMount!="function"||(Z=B.state,typeof B.componentWillMount=="function"&&B.componentWillMount(),typeof B.UNSAFE_componentWillMount=="function"&&B.UNSAFE_componentWillMount(),Z!==B.state&&hs.enqueueReplaceState(B,B.state,null),Ar(p,A,B,L),Er(),B.state=p.memoizedState),typeof B.componentDidMount=="function"&&(p.flags|=4194308),A=!0}else if(d===null){B=p.stateNode;var ne=p.memoizedProps,de=zh(b,ne);B.props=de;var we=B.context,Le=b.contextType;Z=ac,typeof Le=="object"&&Le!==null&&(Z=lt(Le));var Be=b.getDerivedStateFromProps;Le=typeof Be=="function"||typeof B.getSnapshotBeforeUpdate=="function",ne=p.pendingProps!==ne,Le||typeof B.UNSAFE_componentWillReceiveProps!="function"&&typeof B.componentWillReceiveProps!="function"||(ne||we!==Z)&&n_(p,B,A,Z),Gr=!1;var Ue=p.memoizedState;B.state=Ue,Ar(p,A,B,L),Er(),we=p.memoizedState,ne||Ue!==we||Gr?(typeof Be=="function"&&(Ly(p,b,Be,A),we=p.memoizedState),(de=Gr||Fx(p,b,de,A,Ue,we,Z))?(Le||typeof B.UNSAFE_componentWillMount!="function"&&typeof B.componentWillMount!="function"||(typeof B.componentWillMount=="function"&&B.componentWillMount(),typeof B.UNSAFE_componentWillMount=="function"&&B.UNSAFE_componentWillMount()),typeof B.componentDidMount=="function"&&(p.flags|=4194308)):(typeof B.componentDidMount=="function"&&(p.flags|=4194308),p.memoizedProps=A,p.memoizedState=we),B.props=A,B.state=we,B.context=Z,A=de):(typeof B.componentDidMount=="function"&&(p.flags|=4194308),A=!1)}else{B=p.stateNode,_y(d,p),Z=p.memoizedProps,Le=zh(b,Z),B.props=Le,Be=p.pendingProps,Ue=B.context,we=b.contextType,de=ac,typeof we=="object"&&we!==null&&(de=lt(we)),ne=b.getDerivedStateFromProps,(we=typeof ne=="function"||typeof B.getSnapshotBeforeUpdate=="function")||typeof B.UNSAFE_componentWillReceiveProps!="function"&&typeof B.componentWillReceiveProps!="function"||(Z!==Be||Ue!==de)&&n_(p,B,A,de),Gr=!1,Ue=p.memoizedState,B.state=Ue,Ar(p,A,B,L),Er();var ut=p.memoizedState;Z!==Be||Ue!==ut||Gr||d!==null&&d.dependencies!==null&&zs(d.dependencies)?(typeof ne=="function"&&(Ly(p,b,ne,A),ut=p.memoizedState),(Le=Gr||Fx(p,b,Le,A,Ue,ut,de)||d!==null&&d.dependencies!==null&&zs(d.dependencies))?(we||typeof B.UNSAFE_componentWillUpdate!="function"&&typeof B.componentWillUpdate!="function"||(typeof B.componentWillUpdate=="function"&&B.componentWillUpdate(A,ut,de),typeof B.UNSAFE_componentWillUpdate=="function"&&B.UNSAFE_componentWillUpdate(A,ut,de)),typeof B.componentDidUpdate=="function"&&(p.flags|=4),typeof B.getSnapshotBeforeUpdate=="function"&&(p.flags|=1024)):(typeof B.componentDidUpdate!="function"||Z===d.memoizedProps&&Ue===d.memoizedState||(p.flags|=4),typeof B.getSnapshotBeforeUpdate!="function"||Z===d.memoizedProps&&Ue===d.memoizedState||(p.flags|=1024),p.memoizedProps=A,p.memoizedState=ut),B.props=A,B.state=ut,B.context=de,A=Le):(typeof B.componentDidUpdate!="function"||Z===d.memoizedProps&&Ue===d.memoizedState||(p.flags|=4),typeof B.getSnapshotBeforeUpdate!="function"||Z===d.memoizedProps&&Ue===d.memoizedState||(p.flags|=1024),A=!1)}return B=A,pu(d,p),A=(p.flags&128)!==0,B||A?(B=p.stateNode,b=A&&typeof b.getDerivedStateFromError!="function"?null:B.render(),p.flags|=1,d!==null&&A?(p.child=zo(p,d.child,null,L),p.child=zo(p,null,b,L)):qi(d,p,b,L),p.memoizedState=B.state,d=p.child):d=rn(d,p,L),d}function Oy(d,p,b,A){return De(),p.flags|=256,qi(d,p,b,A),p.child}function l_(d){return{baseLanes:d,cachePool:Vm()}}function h_(d,p,b){return d=d!==null?d.childLanes&~b:0,p&&(d|=wn),d}function Ny(d,p,b){var A=p.pendingProps,L=!1,B=(p.flags&128)!==0,Z;if((Z=B)||(Z=d!==null&&d.memoizedState===null?!1:(st.current&2)!==0),Z&&(L=!0,p.flags&=-129),Z=(p.flags&32)!==0,p.flags&=-33,d===null){if(zt){if(L?Tl(p):To(),zt){var ne=ci,de;(de=ne)&&(ne=mw(ne,Yt),ne!==null?(p.memoizedState={dehydrated:ne,treeContext:Vl!==null?{id:Zn,overflow:Vr}:null,retryLane:536870912,hydrationErrors:null},de=t(18,null,null,0),de.stateNode=ne,de.return=p,p.child=de,Vs=p,ci=null,de=!0):de=!1),de||te(p)}if(ne=p.memoizedState,ne!==null&&(ne=ne.dehydrated,ne!==null))return O_(ne)?p.lanes=32:p.lanes=536870912,null;Eo(p)}return ne=A.children,A=A.fallback,L?(To(),L=p.mode,ne=c_({mode:"hidden",children:ne},L),A=Qn(A,L,b,null),ne.return=p,A.return=p,ne.sibling=A,p.child=ne,L=p.child,L.memoizedState=l_(b),L.childLanes=h_(d,Z,b),p.memoizedState=Ea,A):(Tl(p),El(p,ne))}if(de=d.memoizedState,de!==null&&(ne=de.dehydrated,ne!==null)){if(B)p.flags&256?(Tl(p),p.flags&=-257,p=Fy(d,p,b)):p.memoizedState!==null?(To(),p.child=d.child,p.flags|=128,p=null):(To(),L=A.fallback,ne=p.mode,A=c_({mode:"visible",children:A.children},ne),L=Qn(L,ne,b,null),L.flags|=2,A.return=p,L.return=p,A.sibling=L,p.child=A,zo(p,d.child,null,b),A=p.child,A.memoizedState=l_(b),A.childLanes=h_(d,Z,b),p.memoizedState=Ea,p=L);else if(Tl(p),O_(ne))Z=ST(ne).digest,A=Error(i(419)),A.stack="",A.digest=Z,ot({value:A,source:null,stack:null}),p=Fy(d,p,b);else if(at||Zi(d,p,b,!1),Z=(b&d.childLanes)!==0,at||Z){if(Z=Wt,Z!==null&&(A=b&-b,A=(A&42)!==0?1:X(A),A=(A&(Z.suspendedLanes|b))!==0?0:A,A!==0&&A!==de.retryLane))throw de.retryLane=A,si(d,A),ia(Z,d,A),Ot;Vf(ne)||Fs(),p=Fy(d,p,b)}else Vf(ne)?(p.flags|=192,p.child=d.child,p=null):(d=de.treeContext,Ba&&(ci=_v(ne),Vs=p,zt=!0,Jn=null,Yt=!1,d!==null&&(xa[Va++]=Zn,xa[Va++]=Vr,xa[Va++]=Vl,Zn=d.id,Vr=d.overflow,Vl=p)),p=El(p,A.children),p.flags|=4096);return p}return L?(To(),L=A.fallback,ne=p.mode,de=d.child,B=de.sibling,A=Ro(de,{mode:"hidden",children:A.children}),A.subtreeFlags=de.subtreeFlags&65011712,B!==null?L=Ro(B,L):(L=Qn(L,ne,b,null),L.flags|=2),L.return=p,A.return=p,A.sibling=L,p.child=A,A=L,L=p.child,ne=d.child.memoizedState,ne===null?ne=l_(b):(de=ne.cachePool,de!==null?(B=Lo?$t._currentValue:$t._currentValue2,de=de.parent!==B?{parent:B,pool:B}:de):de=Vm(),ne={baseLanes:ne.baseLanes|b,cachePool:de}),L.memoizedState=ne,L.childLanes=h_(d,Z,b),p.memoizedState=Ea,A):(Tl(p),b=d.child,d=b.sibling,b=Ro(b,{mode:"visible",children:A.children}),b.return=p,b.sibling=null,d!==null&&(Z=p.deletions,Z===null?(p.deletions=[d],p.flags|=16):Z.push(d)),p.child=b,p.memoizedState=null,b)}function El(d,p){return p=c_({mode:"visible",children:p},d.mode),p.return=d,d.child=p}function c_(d,p){return d=t(22,d,null,p),d.lanes=0,d.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null},d}function Fy(d,p,b){return zo(p,d.child,null,b),d=El(p,p.pendingProps.children),d.flags|=2,p.memoizedState=null,d}function Xx(d,p,b){d.lanes|=p;var A=d.alternate;A!==null&&(A.lanes|=p),ht(d.return,p,b)}function u_(d,p,b,A,L){var B=d.memoizedState;B===null?d.memoizedState={isBackwards:p,rendering:null,renderingStartTime:0,last:A,tail:b,tailMode:L}:(B.isBackwards=p,B.rendering=null,B.renderingStartTime=0,B.last=A,B.tail=b,B.tailMode=L)}function By(d,p,b){var A=p.pendingProps,L=A.revealOrder,B=A.tail;if(qi(d,p,A.children,b),A=st.current,(A&2)!==0)A=A&1|2,p.flags|=128;else{if(d!==null&&(d.flags&128)!==0)e:for(d=p.child;d!==null;){if(d.tag===13)d.memoizedState!==null&&Xx(d,b,p);else if(d.tag===19)Xx(d,b,p);else if(d.child!==null){d.child.return=d,d=d.child;continue}if(d===p)break e;for(;d.sibling===null;){if(d.return===null||d.return===p)break e;d=d.return}d.sibling.return=d.return,d=d.sibling}A&=1}switch(v(st,A),L){case"forwards":for(b=p.child,L=null;b!==null;)d=b.alternate,d!==null&&a_(d)===null&&(L=b),b=b.sibling;b=L,b===null?(L=p.child,p.child=null):(L=b.sibling,b.sibling=null),u_(p,!1,L,b,B);break;case"backwards":for(b=null,L=p.child,p.child=null;L!==null;){if(d=L.alternate,d!==null&&a_(d)===null){p.child=L;break}d=L.sibling,L.sibling=b,b=L,L=d}u_(p,!0,b,null,B);break;case"together":u_(p,!1,null,null,void 0);break;default:p.memoizedState=null}return p.child}function rn(d,p,b){if(d!==null&&(p.dependencies=d.dependencies),fi|=p.lanes,(b&p.childLanes)===0)if(d!==null){if(Zi(d,p,b,!1),(b&p.childLanes)===0)return null}else return null;if(d!==null&&p.child!==d.child)throw Error(i(153));if(p.child!==null){for(d=p.child,b=Ro(d,d.pendingProps),p.child=b,b.return=p;d.sibling!==null;)d=d.sibling,b=b.sibling=Ro(d,d.pendingProps),b.return=p;b.sibling=null}return p.child}function Vh(d,p){return(d.lanes&p)!==0?!0:(d=d.dependencies,!!(d!==null&&zs(d)))}function hw(d,p,b){switch(p.tag){case 3:J(p,p.stateNode.containerInfo),$e(p,$t,d.memoizedState.cache),De();break;case 27:case 5:oe(p);break;case 4:J(p,p.stateNode.containerInfo);break;case 10:$e(p,p.type,p.memoizedProps.value);break;case 13:var A=p.memoizedState;if(A!==null)return A.dehydrated!==null?(Tl(p),p.flags|=128,null):(b&p.child.childLanes)!==0?Ny(d,p,b):(Tl(p),d=rn(d,p,b),d!==null?d.sibling:null);Tl(p);break;case 19:var L=(d.flags&128)!==0;if(A=(b&p.childLanes)!==0,A||(Zi(d,p,b,!1),A=(b&p.childLanes)!==0),L){if(A)return By(d,p,b);p.flags|=128}if(L=p.memoizedState,L!==null&&(L.rendering=null,L.tail=null,L.lastEffect=null),v(st,st.current),A)break;return null;case 22:case 23:return p.lanes=0,Hx(d,p,b);case 24:$e(p,$t,d.memoizedState.cache)}return rn(d,p,b)}function yf(d,p,b){if(d!==null)if(d.memoizedProps!==p.pendingProps)at=!0;else{if(!Vh(d,b)&&(p.flags&128)===0)return at=!1,hw(d,p,b);at=(d.flags&131072)!==0}else at=!1,zt&&(p.flags&1048576)!==0&&V(p,Lu,p.index);switch(p.lanes=0,p.tag){case 16:e:{d=p.pendingProps;var A=p.elementType,L=A._init;if(A=L(A._payload),p.type=A,typeof A=="function")Ky(A)?(d=zh(A,d),p.tag=1,p=Iy(null,p,A,d,b)):(p.tag=0,p=kh(null,p,A,d,b));else{if(A!=null){if(L=A.$$typeof,L===Fr){p.tag=11,p=kx(null,p,A,d,b);break e}else if(L===Br){p.tag=14,p=Vx(null,p,A,d,b);break e}}throw p=_(A)||A,Error(i(306,p,""))}}return p;case 0:return kh(d,p,p.type,p.pendingProps,b);case 1:return A=p.type,L=zh(A,p.pendingProps),Iy(d,p,A,L,b);case 3:e:{if(J(p,p.stateNode.containerInfo),d===null)throw Error(i(387));var B=p.pendingProps;L=p.memoizedState,A=L.element,_y(d,p),Ar(p,B,null,b);var Z=p.memoizedState;if(B=Z.cache,$e(p,$t,B),B!==L.cache&&Pe(p,[$t],b,!0),Er(),B=Z.element,Ba&&L.isDehydrated)if(L={element:B,isDehydrated:!1,cache:Z.cache},p.updateQueue.baseState=L,p.memoizedState=L,p.flags&256){p=Oy(d,p,B,b);break e}else if(B!==A){A=K(Error(i(424)),p),ot(A),p=Oy(d,p,B,b);break e}else for(Ba&&(ci=AT(p.stateNode.containerInfo),Vs=p,zt=!0,Jn=null,Yt=!0),b=Mv(p,null,B,b),p.child=b;b;)b.flags=b.flags&-3|4096,b=b.sibling;else{if(De(),B===A){p=rn(d,p,b);break e}qi(d,p,B,b)}p=p.child}return p;case 26:if(Sa)return pu(d,p),d===null?(b=Wf(p.type,null,p.pendingProps,null))?p.memoizedState=b:zt||(p.stateNode=kr(p.type,p.pendingProps,Gl.current,p)):p.memoizedState=Wf(p.type,d.memoizedProps,p.pendingProps,d.memoizedState),null;case 27:if(Et)return oe(p),d===null&&Et&&zt&&(A=p.stateNode=qf(p.type,p.pendingProps,Gl.current,Ls.current,!1),Vs=p,Yt=!0,ci=CT(p.type,A,ci)),qi(d,p,p.pendingProps.children,b),pu(d,p),d===null&&(p.flags|=4194304),p.child;case 5:return d===null&&zt&&(_w(p.type,p.pendingProps,Ls.current),(L=A=ci)&&(A=wT(A,p.type,p.pendingProps,Yt),A!==null?(p.stateNode=A,Vs=p,ci=ET(A),Yt=!1,L=!0):L=!1),L||te(p)),oe(p),L=p.type,B=p.pendingProps,Z=d!==null?d.memoizedProps:null,A=B.children,Po(L,B)?A=null:Z!==null&&Po(L,Z)&&(p.flags|=32),p.memoizedState!==null&&(L=gy(d,p,rw,null,null,b),Lo?zr._currentValue=L:zr._currentValue2=L),pu(d,p),qi(d,p,A,b),p.child;case 6:return d===null&&zt&&(Mu(p.pendingProps,Ls.current),(d=b=ci)&&(b=pw(b,p.pendingProps,Yt),b!==null?(p.stateNode=b,Vs=p,ci=null,d=!0):d=!1),d||te(p)),null;case 13:return Ny(d,p,b);case 4:return J(p,p.stateNode.containerInfo),A=p.pendingProps,d===null?p.child=zo(p,null,A,b):qi(d,p,A,b),p.child;case 11:return kx(d,p,p.type,p.pendingProps,b);case 7:return qi(d,p,p.pendingProps,b),p.child;case 8:return qi(d,p,p.pendingProps.children,b),p.child;case 12:return qi(d,p,p.pendingProps.children,b),p.child;case 10:return A=p.pendingProps,$e(p,p.type,A.value),qi(d,p,A.children,b),p.child;case 9:return L=p.type._context,A=p.pendingProps.children,oi(p),L=lt(L),A=A(L),p.flags|=1,qi(d,p,A,b),p.child;case 14:return Vx(d,p,p.type,p.pendingProps,b);case 15:return Gx(d,p,p.type,p.pendingProps,b);case 19:return By(d,p,b);case 31:return A=p.pendingProps,b=p.mode,A={mode:A.mode,children:A.children},d===null?(b=c_(A,b),b.ref=p.ref,p.child=b,b.return=p,p=b):(b=Ro(d.child,A),b.ref=p.ref,p.child=b,b.return=p,p=b),p;case 22:return Hx(d,p,b);case 24:return oi(p),A=lt($t),d===null?(L=km(),L===null&&(L=Wt,B=Ys(),L.pooledCache=B,B.refCount++,B!==null&&(L.pooledCacheLanes|=b),L=B),p.memoizedState={parent:A,cache:L},lf(p),$e(p,$t,L)):((d.lanes&b)!==0&&(_y(d,p),Ar(p,null,null,b),Er()),L=d.memoizedState,B=p.memoizedState,L.parent!==A?(L={parent:A,cache:A},p.memoizedState=L,p.lanes===0&&(p.memoizedState=p.updateQueue.baseState=L),$e(p,$t,A)):(A=B.cache,$e(p,$t,A),A!==L.cache&&Pe(p,[$t],b,!0))),qi(d,p,p.pendingProps.children,b),p.child;case 29:throw p.pendingProps}throw Error(i(156,p.tag))}function Ia(d){d.flags|=4}function Uy(d,p){if(d!==null&&d.child===p.child)return!1;if((p.flags&16)!==0)return!0;for(d=p.child;d!==null;){if((d.flags&13878)!==0||(d.subtreeFlags&13878)!==0)return!0;d=d.sibling}return!1}function vf(d,p,b,A){if(Dt)for(b=p.child;b!==null;){if(b.tag===5||b.tag===6)Ks(d,b.stateNode);else if(!(b.tag===4||Et&&b.tag===27)&&b.child!==null){b.child.return=b,b=b.child;continue}if(b===p)break;for(;b.sibling===null;){if(b.return===null||b.return===p)return;b=b.return}b.sibling.return=b.return,b=b.sibling}else if(Ur)for(var L=p.child;L!==null;){if(L.tag===5){var B=L.stateNode;b&&A&&(B=dv(B,L.type,L.memoizedProps)),Ks(d,B)}else if(L.tag===6)B=L.stateNode,b&&A&&(B=fv(B,L.memoizedProps)),Ks(d,B);else if(L.tag!==4){if(L.tag===22&&L.memoizedState!==null)B=L.child,B!==null&&(B.return=L),vf(d,L,!0,!0);else if(L.child!==null){L.child.return=L,L=L.child;continue}}if(L===p)break;for(;L.sibling===null;){if(L.return===null||L.return===p)return;L=L.return}L.sibling.return=L.return,L=L.sibling}}function d_(d,p,b,A){var L=!1;if(Ur)for(var B=p.child;B!==null;){if(B.tag===5){var Z=B.stateNode;b&&A&&(Z=dv(Z,B.type,B.memoizedProps)),cv(d,Z)}else if(B.tag===6)Z=B.stateNode,b&&A&&(Z=fv(Z,B.memoizedProps)),cv(d,Z);else if(B.tag!==4){if(B.tag===22&&B.memoizedState!==null)L=B.child,L!==null&&(L.return=B),d_(d,B,!0,!0),L=!0;else if(B.child!==null){B.child.return=B,B=B.child;continue}}if(B===p)break;for(;B.sibling===null;){if(B.return===null||B.return===p)return L;B=B.return}B.sibling.return=B.return,B=B.sibling}return L}function zy(d,p){if(Ur&&Uy(d,p)){d=p.stateNode;var b=d.containerInfo,A=hv();d_(A,p,!1,!1),d.pendingChildren=A,Ia(p),vT(b,A)}}function f_(d,p,b,A){if(Dt)d.memoizedProps!==A&&Ia(p);else if(Ur){var L=d.stateNode,B=d.memoizedProps;if((d=Uy(d,p))||B!==A){var Z=Ls.current;B=kf(L,b,B,A,!d,null),B===L?p.stateNode=L:(Ff(B,b,A,Z)&&Ia(p),p.stateNode=B,d?vf(B,p,!1,!1):Ia(p))}else p.stateNode=L}}function p_(d,p,b){if(hi(p,b)){if(d.flags|=16777216,!P_(p,b))if(b_())d.flags|=8192;else throw Ga=Xi,q_}else d.flags&=-16777217}function jx(d,p){if(LT(p)){if(d.flags|=16777216,!Io(p))if(b_())d.flags|=8192;else throw Ga=Xi,q_}else d.flags&=-16777217}function m_(d,p){p!==null&&(d.flags|=4),d.flags&16384&&(p=d.tag!==22?D():536870912,d.lanes|=p,mn|=p)}function Sf(d,p){if(!zt)switch(d.tailMode){case"hidden":p=d.tail;for(var b=null;p!==null;)p.alternate!==null&&(b=p),p=p.sibling;b===null?d.tail=null:b.sibling=null;break;case"collapsed":b=d.tail;for(var A=null;b!==null;)b.alternate!==null&&(A=b),b=b.sibling;A===null?p||d.tail===null?d.tail=null:d.tail.sibling=null:A.sibling=null}}function ks(d){var p=d.alternate!==null&&d.alternate.child===d.child,b=0,A=0;if(p)for(var L=d.child;L!==null;)b|=L.lanes|L.childLanes,A|=L.subtreeFlags&65011712,A|=L.flags&65011712,L.return=d,L=L.sibling;else for(L=d.child;L!==null;)b|=L.lanes|L.childLanes,A|=L.subtreeFlags,A|=L.flags,L.return=d,L=L.sibling;return d.subtreeFlags|=A,d.childLanes=b,p}function cw(d,p,b){var A=p.pendingProps;switch(se(p),p.tag){case 31:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return ks(p),null;case 1:return ks(p),null;case 3:return b=p.stateNode,A=null,d!==null&&(A=d.memoizedState.cache),p.memoizedState.cache!==A&&(p.flags|=2048),es($t),ie(),b.pendingContext&&(b.context=b.pendingContext,b.pendingContext=null),(d===null||d.child===null)&&(Ae(p)?Ia(p):d===null||d.memoizedState.isDehydrated&&(p.flags&256)===0||(p.flags|=1024,Fe())),zy(d,p),ks(p),null;case 26:if(Sa){b=p.type;var L=p.memoizedState;return d===null?(Ia(p),L!==null?(ks(p),jx(p,L)):(ks(p),p_(p,b,A))):L?L!==d.memoizedState?(Ia(p),ks(p),jx(p,L)):(ks(p),p.flags&=-16777217):(Dt?d.memoizedProps!==A&&Ia(p):f_(d,p,b,A),ks(p),p_(p,b,A)),null}case 27:if(Et){if(he(p),b=Gl.current,L=p.type,d!==null&&p.stateNode!=null)Dt?d.memoizedProps!==A&&Ia(p):f_(d,p,L,A);else{if(!A){if(p.stateNode===null)throw Error(i(166));return ks(p),null}d=Ls.current,Ae(p)?le(p,d):(d=qf(L,A,b,d,!0),p.stateNode=d,Ia(p))}return ks(p),null}case 5:if(he(p),b=p.type,d!==null&&p.stateNode!=null)f_(d,p,b,A);else{if(!A){if(p.stateNode===null)throw Error(i(166));return ks(p),null}d=Ls.current,Ae(p)?le(p,d):(L=os(b,A,Gl.current,d,p),vf(L,p,!1,!1),p.stateNode=L,Ff(L,b,A,d)&&Ia(p))}return ks(p),p_(p,p.type,p.pendingProps),null;case 6:if(d&&p.stateNode!=null)b=d.memoizedProps,Dt?b!==A&&Ia(p):Ur&&(b!==A?(p.stateNode=Fl(A,Gl.current,Ls.current,p),Ia(p)):p.stateNode=d.stateNode);else{if(typeof A!="string"&&p.stateNode===null)throw Error(i(166));if(d=Gl.current,b=Ls.current,Ae(p)){if(!Ba)throw Error(i(176));if(d=p.stateNode,b=p.memoizedProps,A=null,L=Vs,L!==null)switch(L.tag){case 27:case 5:A=L.memoizedProps}Gf(d,b,p,A)||te(p)}else p.stateNode=Fl(A,d,b,p)}return ks(p),null;case 13:if(A=p.memoizedState,d===null||d.memoizedState!==null&&d.memoizedState.dehydrated!==null){if(L=Ae(p),A!==null&&A.dehydrated!==null){if(d===null){if(!L)throw Error(i(318));if(!Ba)throw Error(i(344));if(L=p.memoizedState,L=L!==null?L.dehydrated:null,!L)throw Error(i(317));gv(L,p)}else De(),(p.flags&128)===0&&(p.memoizedState=null),p.flags|=4;ks(p),L=!1}else L=Fe(),d!==null&&d.memoizedState!==null&&(d.memoizedState.hydrationErrors=L),L=!0;if(!L)return p.flags&256?(Eo(p),p):(Eo(p),null)}if(Eo(p),(p.flags&128)!==0)return p.lanes=b,p;if(b=A!==null,d=d!==null&&d.memoizedState!==null,b){A=p.child,L=null,A.alternate!==null&&A.alternate.memoizedState!==null&&A.alternate.memoizedState.cachePool!==null&&(L=A.alternate.memoizedState.cachePool.pool);var B=null;A.memoizedState!==null&&A.memoizedState.cachePool!==null&&(B=A.memoizedState.cachePool.pool),B!==L&&(A.flags|=2048)}return b!==d&&b&&(p.child.flags|=8192),m_(p,p.updateQueue),ks(p),null;case 4:return ie(),zy(d,p),d===null&&sT(p.stateNode.containerInfo),ks(p),null;case 10:return es(p.type),ks(p),null;case 19:if(y(st),L=p.memoizedState,L===null)return ks(p),null;if(A=(p.flags&128)!==0,B=L.rendering,B===null)if(A)Sf(L,!1);else{if(Gs!==0||d!==null&&(d.flags&128)!==0)for(d=p.child;d!==null;){if(B=a_(d),B!==null){for(p.flags|=128,Sf(L,!1),d=B.updateQueue,p.updateQueue=d,m_(p,d),p.subtreeFlags=0,d=b,b=p.child;b!==null;)li(b,d),b=b.sibling;return v(st,st.current&1|2),p.child}d=d.sibling}L.tail!==null&&ls()>Vu&&(p.flags|=128,A=!0,Sf(L,!1),p.lanes=4194304)}else{if(!A)if(d=a_(B),d!==null){if(p.flags|=128,A=!0,d=d.updateQueue,p.updateQueue=d,m_(p,d),Sf(L,!0),L.tail===null&&L.tailMode==="hidden"&&!B.alternate&&!zt)return ks(p),null}else 2*ls()-L.renderingStartTime>Vu&&b!==536870912&&(p.flags|=128,A=!0,Sf(L,!1),p.lanes=4194304);L.isBackwards?(B.sibling=p.child,p.child=B):(d=L.last,d!==null?d.sibling=B:p.child=B,L.last=B)}return L.tail!==null?(p=L.tail,L.rendering=p,L.tail=p.sibling,L.renderingStartTime=ls(),p.sibling=null,d=st.current,v(st,A?d&1|2:d&1),p):(ks(p),null);case 22:case 23:return Eo(p),Xm(),A=p.memoizedState!==null,d!==null?d.memoizedState!==null!==A&&(p.flags|=8192):A&&(p.flags|=8192),A?(b&536870912)!==0&&(p.flags&128)===0&&(ks(p),p.subtreeFlags&6&&(p.flags|=8192)):ks(p),b=p.updateQueue,b!==null&&m_(p,b.retryQueue),b=null,d!==null&&d.memoizedState!==null&&d.memoizedState.cachePool!==null&&(b=d.memoizedState.cachePool.pool),A=null,p.memoizedState!==null&&p.memoizedState.cachePool!==null&&(A=p.memoizedState.cachePool.pool),A!==b&&(p.flags|=2048),d!==null&&y(Bs),null;case 24:return b=null,d!==null&&(b=d.memoizedState.cache),p.memoizedState.cache!==b&&(p.flags|=2048),es($t),ks(p),null;case 25:return null;case 30:return null}throw Error(i(156,p.tag))}function on(d,p){switch(se(p),p.tag){case 1:return d=p.flags,d&65536?(p.flags=d&-65537|128,p):null;case 3:return es($t),ie(),d=p.flags,(d&65536)!==0&&(d&128)===0?(p.flags=d&-65537|128,p):null;case 26:case 27:case 5:return he(p),null;case 13:if(Eo(p),d=p.memoizedState,d!==null&&d.dehydrated!==null){if(p.alternate===null)throw Error(i(340));De()}return d=p.flags,d&65536?(p.flags=d&-65537|128,p):null;case 19:return y(st),null;case 4:return ie(),null;case 10:return es(p.type),null;case 22:case 23:return Eo(p),Xm(),d!==null&&y(Bs),d=p.flags,d&65536?(p.flags=d&-65537|128,p):null;case 24:return es($t),null;case 25:return null;default:return null}}function mu(d,p){switch(se(p),p.tag){case 3:es($t),ie();break;case 26:case 27:case 5:he(p);break;case 4:ie();break;case 13:Eo(p);break;case 19:y(st);break;case 10:es(p.type);break;case 22:case 23:Eo(p),Xm(),d!==null&&y(Bs);break;case 24:es($t)}}function _u(d,p){try{var b=p.updateQueue,A=b!==null?b.lastEffect:null;if(A!==null){var L=A.next;b=L;do{if((b.tag&d)===d){A=void 0;var B=b.create,Z=b.inst;A=B(),Z.destroy=A}b=b.next}while(b!==L)}}catch(ne){Qt(p,p.return,ne)}}function Ao(d,p,b){try{var A=p.updateQueue,L=A!==null?A.lastEffect:null;if(L!==null){var B=L.next;A=B;do{if((A.tag&d)===d){var Z=A.inst,ne=Z.destroy;if(ne!==void 0){Z.destroy=void 0,L=p;var de=b,we=ne;try{we()}catch(Le){Qt(L,de,Le)}}}A=A.next}while(A!==B)}}catch(Le){Qt(p,p.return,Le)}}function ky(d){var p=d.updateQueue;if(p!==null){var b=d.stateNode;try{Ih(p,b)}catch(A){Qt(d,d.return,A)}}}function Vy(d,p,b){b.props=zh(d.type,d.memoizedProps),b.state=d.memoizedState;try{b.componentWillUnmount()}catch(A){Qt(d,p,A)}}function Gh(d,p){try{var b=d.ref;if(b!==null){switch(d.tag){case 26:case 27:case 5:var A=Au(d.stateNode);break;case 30:A=d.stateNode;break;default:A=d.stateNode}typeof b=="function"?d.refCleanup=b(A):b.current=A}}catch(L){Qt(d,p,L)}}function Rr(d,p){var b=d.ref,A=d.refCleanup;if(b!==null)if(typeof A=="function")try{A()}catch(L){Qt(d,p,L)}finally{d.refCleanup=null,d=d.alternate,d!=null&&(d.refCleanup=null)}else if(typeof b=="function")try{b(null)}catch(L){Qt(d,p,L)}else b.current=null}function Hh(d){var p=d.type,b=d.memoizedProps,A=d.stateNode;try{lv(A,p,b,d)}catch(L){Qt(d,d.return,L)}}function bf(d,p,b){try{uT(d.stateNode,d.type,b,p,d)}catch(A){Qt(d,d.return,A)}}function gu(d){return d.tag===5||d.tag===3||(Sa?d.tag===26:!1)||(Et?d.tag===27&&ic(d.type):!1)||d.tag===4}function xf(d){e:for(;;){for(;d.sibling===null;){if(d.return===null||gu(d.return))return null;d=d.return}for(d.sibling.return=d.return,d=d.sibling;d.tag!==5&&d.tag!==6&&d.tag!==18;){if(Et&&d.tag===27&&ic(d.type)||d.flags&2||d.child===null||d.tag===4)continue e;d.child.return=d,d=d.child}if(!(d.flags&2))return d.stateNode}}function __(d,p,b){var A=d.tag;if(A===5||A===6)d=d.stateNode,p?fT(b,d,p):hT(b,d);else if(A!==4&&(Et&&A===27&&ic(d.type)&&(b=d.stateNode,p=null),d=d.child,d!==null))for(__(d,p,b),d=d.sibling;d!==null;)__(d,p,b),d=d.sibling}function Mr(d,p,b){var A=d.tag;if(A===5||A===6)d=d.stateNode,p?dT(b,d,p):lT(b,d);else if(A!==4&&(Et&&A===27&&ic(d.type)&&(b=d.stateNode),d=d.child,d!==null))for(Mr(d,p,b),d=d.sibling;d!==null;)Mr(d,p,b),d=d.sibling}function Wh(d,p,b){d=d.containerInfo;try{uv(d,b)}catch(A){Qt(p,p.return,A)}}function g_(d){var p=d.stateNode,b=d.memoizedProps;try{xv(d.type,b,p,d)}catch(A){Qt(d,d.return,A)}}function Yx(d,p){for(Nl(d.containerInfo),yt=p;yt!==null;)if(d=yt,p=d.child,(d.subtreeFlags&1024)!==0&&p!==null)p.return=d,yt=p;else for(;yt!==null;){d=yt;var b=d.alternate;switch(p=d.flags,d.tag){case 0:break;case 11:case 15:break;case 1:if((p&1024)!==0&&b!==null){p=void 0;var A=d,L=b.memoizedProps;b=b.memoizedState;var B=A.stateNode;try{var Z=zh(A.type,L,A.elementType===A.type);p=B.getSnapshotBeforeUpdate(Z,b),B.__reactInternalSnapshotBeforeUpdate=p}catch(ne){Qt(A,A.return,ne)}}break;case 3:(p&1024)!==0&&Dt&&I_(d.stateNode.containerInfo);break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((p&1024)!==0)throw Error(i(163))}if(p=d.sibling,p!==null){p.return=d.return,yt=p;break}yt=d.return}}function Al(d,p,b){var A=b.flags;switch(b.tag){case 0:case 11:case 15:Co(d,b),A&4&&_u(5,b);break;case 1:if(Co(d,b),A&4)if(d=b.stateNode,p===null)try{d.componentDidMount()}catch(Z){Qt(b,b.return,Z)}else{var L=zh(b.type,p.memoizedProps);p=p.memoizedState;try{d.componentDidUpdate(L,p,d.__reactInternalSnapshotBeforeUpdate)}catch(Z){Qt(b,b.return,Z)}}A&64&&ky(b),A&512&&Gh(b,b.return);break;case 3:if(Co(d,b),A&64&&(d=b.updateQueue,d!==null)){if(p=null,b.child!==null)switch(b.child.tag){case 27:case 5:p=Au(b.child.stateNode);break;case 1:p=b.child.stateNode}try{Ih(d,p)}catch(Z){Qt(b,b.return,Z)}}break;case 27:Et&&p===null&&A&4&&g_(b);case 26:case 5:Co(d,b),p===null&&A&4&&Hh(b),A&512&&Gh(b,b.return);break;case 12:Co(d,b);break;case 13:Co(d,b),A&4&&Kx(d,b),A&64&&(d=b.memoizedState,d!==null&&(d=d.dehydrated,d!==null&&(b=na.bind(null,b),pv(d,b))));break;case 22:if(A=b.memoizedState!==null||la,!A){p=p!==null&&p.memoizedState!==null||Es,L=la;var B=Es;la=A,(Es=p)&&!B?yi(d,b,(b.subtreeFlags&8772)!==0):Co(d,b),la=L,Es=B}break;case 30:break;default:Co(d,b)}}function Gy(d){var p=d.alternate;p!==null&&(d.alternate=null,Gy(p)),d.child=null,d.deletions=null,d.sibling=null,d.tag===5&&(p=d.stateNode,p!==null&&Ua(p)),d.stateNode=null,d.return=null,d.dependencies=null,d.memoizedProps=null,d.memoizedState=null,d.pendingProps=null,d.stateNode=null,d.updateQueue=null}function Sn(d,p,b){for(b=b.child;b!==null;)y_(d,p,b),b=b.sibling}function y_(d,p,b){if(ba&&typeof ba.onCommitFiberUnmount=="function")try{ba.onCommitFiberUnmount(Ul,b)}catch{}switch(b.tag){case 26:if(Sa){Es||Rr(b,p),Sn(d,p,b),b.memoizedState?Sv(b.memoizedState):b.stateNode&&cn(b.stateNode);break}case 27:if(Et){Es||Rr(b,p);var A=Ss,L=di;ic(b.type)&&(Ss=b.stateNode,di=!1),Sn(d,p,b),B_(b.stateNode),Ss=A,di=L;break}case 5:Es||Rr(b,p);case 6:if(Dt){if(A=Ss,L=di,Ss=null,Sn(d,p,b),Ss=A,di=L,Ss!==null)if(di)try{mT(Ss,b.stateNode)}catch(B){Qt(b,p,B)}else try{pT(Ss,b.stateNode)}catch(B){Qt(b,p,B)}}else Sn(d,p,b);break;case 18:Dt&&Ss!==null&&(di?PT(Ss,b.stateNode):F_(Ss,b.stateNode));break;case 4:Dt?(A=Ss,L=di,Ss=b.stateNode.containerInfo,di=!0,Sn(d,p,b),Ss=A,di=L):(Ur&&Wh(b.stateNode,b,hv()),Sn(d,p,b));break;case 0:case 11:case 14:case 15:Es||Ao(2,b,p),Es||Ao(4,b,p),Sn(d,p,b);break;case 1:Es||(Rr(b,p),A=b.stateNode,typeof A.componentWillUnmount=="function"&&Vy(b,p,A)),Sn(d,p,b);break;case 21:Sn(d,p,b);break;case 22:Es=(A=Es)||b.memoizedState!==null,Sn(d,p,b),Es=A;break;default:Sn(d,p,b)}}function Kx(d,p){if(Ba&&p.memoizedState===null&&(d=p.alternate,d!==null&&(d=d.memoizedState,d!==null&&(d=d.dehydrated,d!==null))))try{DT(d)}catch(b){Qt(p,p.return,b)}}function uw(d){switch(d.tag){case 13:case 19:var p=d.stateNode;return p===null&&(p=d.stateNode=new qr),p;case 22:return d=d.stateNode,p=d._retryCache,p===null&&(p=d._retryCache=new qr),p;default:throw Error(i(435,d.tag))}}function Hy(d,p){var b=uw(d);p.forEach(function(A){var L=C_.bind(null,d,A);b.has(A)||(b.add(A),A.then(L,L))})}function ta(d,p){var b=p.deletions;if(b!==null)for(var A=0;A<b.length;A++){var L=b[A],B=d,Z=p;if(Dt){var ne=Z;e:for(;ne!==null;){switch(ne.tag){case 27:if(Et){if(ic(ne.type)){Ss=ne.stateNode,di=!1;break e}break}case 5:Ss=ne.stateNode,di=!1;break e;case 3:case 4:Ss=ne.stateNode.containerInfo,di=!0;break e}ne=ne.return}if(Ss===null)throw Error(i(160));y_(B,Z,L),Ss=null,di=!1}else y_(B,Z,L);B=L.alternate,B!==null&&(B.return=null),L.return=null}if(p.subtreeFlags&13878)for(p=p.child;p!==null;)Wy(p,d),p=p.sibling}function Wy(d,p){var b=d.alternate,A=d.flags;switch(d.tag){case 0:case 11:case 14:case 15:ta(p,d),sa(d),A&4&&(Ao(3,d,d.return),_u(3,d),Ao(5,d,d.return));break;case 1:ta(p,d),sa(d),A&512&&(Es||b===null||Rr(b,b.return)),A&64&&la&&(d=d.updateQueue,d!==null&&(A=d.callbacks,A!==null&&(b=d.shared.hiddenCallbacks,d.shared.hiddenCallbacks=b===null?A:b.concat(A))));break;case 26:if(Sa){var L=pn;if(ta(p,d),sa(d),A&512&&(Es||b===null||Rr(b,b.return)),A&4){A=b!==null?b.memoizedState:null;var B=d.memoizedState;b===null?B===null?d.stateNode===null?d.stateNode=Du(L,d.type,d.memoizedProps,d):bv(L,d.type,d.stateNode):d.stateNode=vv(L,B,d.memoizedProps):A!==B?(A===null?b.stateNode!==null&&cn(b.stateNode):Sv(A),B===null?bv(L,d.type,d.stateNode):vv(L,B,d.memoizedProps)):B===null&&d.stateNode!==null&&bf(d,d.memoizedProps,b.memoizedProps)}break}case 27:if(Et){ta(p,d),sa(d),A&512&&(Es||b===null||Rr(b,b.return)),b!==null&&A&4&&bf(d,d.memoizedProps,b.memoizedProps);break}case 5:if(ta(p,d),sa(d),A&512&&(Es||b===null||Rr(b,b.return)),Dt){if(d.flags&32){L=d.stateNode;try{_T(L)}catch(Le){Qt(d,d.return,Le)}}A&4&&d.stateNode!=null&&(L=d.memoizedProps,bf(d,L,b!==null?b.memoizedProps:L)),A&1024&&(sp=!0)}break;case 6:if(ta(p,d),sa(d),A&4&&Dt){if(d.stateNode===null)throw Error(i(162));A=d.memoizedProps,b=b!==null?b.memoizedProps:A,L=d.stateNode;try{cT(L,b,A)}catch(Le){Qt(d,d.return,Le)}}break;case 3:if(Sa?(Bl(),L=pn,pn=sc(p.containerInfo),ta(p,d),pn=L):ta(p,d),sa(d),A&4){if(Dt&&Ba&&b!==null&&b.memoizedState.isDehydrated)try{MT(p.containerInfo)}catch(Le){Qt(d,d.return,Le)}if(Ur){A=p.containerInfo,b=p.pendingChildren;try{uv(A,b)}catch(Le){Qt(d,d.return,Le)}}}sp&&(sp=!1,bn(d));break;case 4:Sa?(b=pn,pn=sc(d.stateNode.containerInfo),ta(p,d),sa(d),pn=b):(ta(p,d),sa(d)),A&4&&Ur&&Wh(d.stateNode,d,d.stateNode.pendingChildren);break;case 12:ta(p,d),sa(d);break;case 13:ta(p,d),sa(d),d.child.flags&8192&&d.memoizedState!==null!=(b!==null&&b.memoizedState!==null)&&(j_=ls()),A&4&&(A=d.updateQueue,A!==null&&(d.updateQueue=null,Hy(d,A)));break;case 22:L=d.memoizedState!==null;var Z=b!==null&&b.memoizedState!==null,ne=la,de=Es;if(la=ne||L,Es=de||Z,ta(p,d),Es=de,la=ne,sa(d),A&8192&&(p=d.stateNode,p._visibility=L?p._visibility&-2:p._visibility|1,L&&(b===null||Z||la||Es||Di(d)),Dt)){e:if(b=null,Dt)for(p=d;;){if(p.tag===5||Sa&&p.tag===26){if(b===null){Z=b=p;try{B=Z.stateNode,L?gT(B):L_(Z.stateNode,Z.memoizedProps)}catch(Le){Qt(Z,Z.return,Le)}}}else if(p.tag===6){if(b===null){Z=p;try{var we=Z.stateNode;L?Ru(we):yT(we,Z.memoizedProps)}catch(Le){Qt(Z,Z.return,Le)}}}else if((p.tag!==22&&p.tag!==23||p.memoizedState===null||p===d)&&p.child!==null){p.child.return=p,p=p.child;continue}if(p===d)break e;for(;p.sibling===null;){if(p.return===null||p.return===d)break e;b===p&&(b=null),p=p.return}b===p&&(b=null),p.sibling.return=p.return,p=p.sibling}}A&4&&(A=d.updateQueue,A!==null&&(b=A.retryQueue,b!==null&&(A.retryQueue=null,Hy(d,b))));break;case 19:ta(p,d),sa(d),A&4&&(A=d.updateQueue,A!==null&&(d.updateQueue=null,Hy(d,A)));break;case 30:break;case 21:break;default:ta(p,d),sa(d)}}function sa(d){var p=d.flags;if(p&2){try{if(Dt){for(var b,A=d.return;A!==null;){if(gu(A)){b=A;break}A=A.return}if(b==null)throw Error(i(160));switch(b.tag){case 27:if(Et){var L=b.stateNode,B=xf(d);Mr(d,B,L);break}case 5:var Z=b.stateNode;b.flags&32&&(_T(Z),b.flags&=-33);var ne=xf(d);Mr(d,ne,Z);break;case 3:case 4:var de=b.stateNode.containerInfo,we=xf(d);__(d,we,de);break;default:throw Error(i(161))}}}catch(Le){Qt(d,d.return,Le)}d.flags&=-3}p&4096&&(d.flags&=-4097)}function bn(d){if(d.subtreeFlags&1024)for(d=d.child;d!==null;){var p=d;bn(p),p.tag===5&&p.flags&1024&&nv(p.stateNode),d=d.sibling}}function Co(d,p){if(p.subtreeFlags&8772)for(p=p.child;p!==null;)Al(d,p.alternate,p),p=p.sibling}function Di(d){for(d=d.child;d!==null;){var p=d;switch(p.tag){case 0:case 11:case 14:case 15:Ao(4,p,p.return),Di(p);break;case 1:Rr(p,p.return);var b=p.stateNode;typeof b.componentWillUnmount=="function"&&Vy(p,p.return,b),Di(p);break;case 27:Et&&B_(p.stateNode);case 26:case 5:Rr(p,p.return),Di(p);break;case 22:p.memoizedState===null&&Di(p);break;case 30:Di(p);break;default:Di(p)}d=d.sibling}}function yi(d,p,b){for(b=b&&(p.subtreeFlags&8772)!==0,p=p.child;p!==null;){var A=p.alternate,L=d,B=p,Z=B.flags;switch(B.tag){case 0:case 11:case 15:yi(L,B,b),_u(4,B);break;case 1:if(yi(L,B,b),A=B,L=A.stateNode,typeof L.componentDidMount=="function")try{L.componentDidMount()}catch(we){Qt(A,A.return,we)}if(A=B,L=A.updateQueue,L!==null){var ne=A.stateNode;try{var de=L.shared.hiddenCallbacks;if(de!==null)for(L.shared.hiddenCallbacks=null,L=0;L<de.length;L++)au(de[L],ne)}catch(we){Qt(A,A.return,we)}}b&&Z&64&&ky(B),Gh(B,B.return);break;case 27:Et&&g_(B);case 26:case 5:yi(L,B,b),b&&A===null&&Z&4&&Hh(B),Gh(B,B.return);break;case 12:yi(L,B,b);break;case 13:yi(L,B,b),b&&Z&4&&Kx(L,B);break;case 22:B.memoizedState===null&&yi(L,B,b),Gh(B,B.return);break;case 30:break;default:yi(L,B,b)}p=p.sibling}}function Cl(d,p){var b=null;d!==null&&d.memoizedState!==null&&d.memoizedState.cachePool!==null&&(b=d.memoizedState.cachePool.pool),d=null,p.memoizedState!==null&&p.memoizedState.cachePool!==null&&(d=p.memoizedState.cachePool.pool),d!==b&&(d!=null&&d.refCount++,b!=null&&Xe(b))}function Tf(d,p){d=null,p.alternate!==null&&(d=p.alternate.memoizedState.cache),p=p.memoizedState.cache,p!==d&&(p.refCount++,d!=null&&Xe(d))}function ln(d,p,b,A){if(p.subtreeFlags&10256)for(p=p.child;p!==null;)Ef(d,p,b,A),p=p.sibling}function Ef(d,p,b,A){var L=p.flags;switch(p.tag){case 0:case 11:case 15:ln(d,p,b,A),L&2048&&_u(9,p);break;case 1:ln(d,p,b,A);break;case 3:ln(d,p,b,A),L&2048&&(d=null,p.alternate!==null&&(d=p.alternate.memoizedState.cache),p=p.memoizedState.cache,p!==d&&(p.refCount++,d!=null&&Xe(d)));break;case 12:if(L&2048){ln(d,p,b,A),d=p.stateNode;try{var B=p.memoizedProps,Z=B.id,ne=B.onPostCommit;typeof ne=="function"&&ne(Z,p.alternate===null?"mount":"update",d.passiveEffectDuration,-0)}catch(de){Qt(p,p.return,de)}}else ln(d,p,b,A);break;case 13:ln(d,p,b,A);break;case 23:break;case 22:B=p.stateNode,Z=p.alternate,p.memoizedState!==null?B._visibility&2?ln(d,p,b,A):Dr(d,p):B._visibility&2?ln(d,p,b,A):(B._visibility|=2,wl(d,p,b,A,(p.subtreeFlags&10256)!==0)),L&2048&&Cl(Z,p);break;case 24:ln(d,p,b,A),L&2048&&Tf(p.alternate,p);break;default:ln(d,p,b,A)}}function wl(d,p,b,A,L){for(L=L&&(p.subtreeFlags&10256)!==0,p=p.child;p!==null;){var B=d,Z=p,ne=b,de=A,we=Z.flags;switch(Z.tag){case 0:case 11:case 15:wl(B,Z,ne,de,L),_u(8,Z);break;case 23:break;case 22:var Le=Z.stateNode;Z.memoizedState!==null?Le._visibility&2?wl(B,Z,ne,de,L):Dr(B,Z):(Le._visibility|=2,wl(B,Z,ne,de,L)),L&&we&2048&&Cl(Z.alternate,Z);break;case 24:wl(B,Z,ne,de,L),L&&we&2048&&Tf(Z.alternate,Z);break;default:wl(B,Z,ne,de,L)}p=p.sibling}}function Dr(d,p){if(p.subtreeFlags&10256)for(p=p.child;p!==null;){var b=d,A=p,L=A.flags;switch(A.tag){case 22:Dr(b,A),L&2048&&Cl(A.alternate,A);break;case 24:Dr(b,A),L&2048&&Tf(A.alternate,A);break;default:Dr(b,A)}p=p.sibling}}function Rl(d){if(d.subtreeFlags&ji)for(d=d.child;d!==null;)Af(d),d=d.sibling}function Af(d){switch(d.tag){case 26:Rl(d),d.flags&ji&&(d.memoizedState!==null?Oo(pn,d.memoizedState,d.memoizedProps):zf(d.type,d.memoizedProps));break;case 5:Rl(d),d.flags&ji&&zf(d.type,d.memoizedProps);break;case 3:case 4:if(Sa){var p=pn;pn=sc(d.stateNode.containerInfo),Rl(d),pn=p}else Rl(d);break;case 22:d.memoizedState===null&&(p=d.alternate,p!==null&&p.memoizedState!==null?(p=ji,ji=16777216,Rl(d),ji=p):Rl(d));break;default:Rl(d)}}function qh(d){var p=d.alternate;if(p!==null&&(d=p.child,d!==null)){p.child=null;do p=d.sibling,d.sibling=null,d=p;while(d!==null)}}function Cf(d){var p=d.deletions;if((d.flags&16)!==0){if(p!==null)for(var b=0;b<p.length;b++){var A=p[b];yt=A,Pr(A,d)}qh(d)}if(d.subtreeFlags&10256)for(d=d.child;d!==null;)Oa(d),d=d.sibling}function Oa(d){switch(d.tag){case 0:case 11:case 15:Cf(d),d.flags&2048&&Ao(9,d,d.return);break;case 3:Cf(d);break;case 12:Cf(d);break;case 22:var p=d.stateNode;d.memoizedState!==null&&p._visibility&2&&(d.return===null||d.return.tag!==13)?(p._visibility&=-3,yu(d)):Cf(d);break;default:Cf(d)}}function yu(d){var p=d.deletions;if((d.flags&16)!==0){if(p!==null)for(var b=0;b<p.length;b++){var A=p[b];yt=A,Pr(A,d)}qh(d)}for(d=d.child;d!==null;){switch(p=d,p.tag){case 0:case 11:case 15:Ao(8,p,p.return),yu(p);break;case 22:b=p.stateNode,b._visibility&2&&(b._visibility&=-3,yu(p));break;default:yu(p)}d=d.sibling}}function Pr(d,p){for(;yt!==null;){var b=yt;switch(b.tag){case 0:case 11:case 15:Ao(8,b,p);break;case 23:case 22:if(b.memoizedState!==null&&b.memoizedState.cachePool!==null){var A=b.memoizedState.cachePool.pool;A!=null&&A.refCount++}break;case 24:Xe(b.memoizedState.cache)}if(A=b.child,A!==null)A.return=b,yt=A;else e:for(b=d;yt!==null;){A=yt;var L=A.sibling,B=A.return;if(Gy(A),A===b){yt=null;break e}if(L!==null){L.return=B,yt=L;break e}yt=B}}}function v_(d){var p=tT(d);if(p!=null){if(typeof p.memoizedProps["data-testname"]!="string")throw Error(i(364));return p}if(d=aT(d),d===null)throw Error(i(362));return d.stateNode.current}function vu(d,p){var b=d.tag;switch(p.$$typeof){case jl:if(d.type===p.value)return!0;break;case Yi:e:{for(p=p.value,d=[d,0],b=0;b<d.length;){var A=d[b++],L=A.tag,B=d[b++],Z=p[B];if(L!==5&&L!==26&&L!==27||!wu(A)){for(;Z!=null&&vu(A,Z);)B++,Z=p[B];if(B===p.length){p=!0;break e}else for(A=A.child;A!==null;)d.push(A,B),A=A.sibling}}p=!1}return p;case zu:if((b===5||b===26||b===27)&&ov(d.stateNode,p.value))return!0;break;case lc:if((b===5||b===6||b===26||b===27)&&(d=rT(d),d!==null&&0<=d.indexOf(p.value)))return!0;break;case ku:if((b===5||b===26||b===27)&&(d=d.memoizedProps["data-testname"],typeof d=="string"&&d.toLowerCase()===p.value.toLowerCase()))return!0;break;default:throw Error(i(365))}return!1}function wo(d){switch(d.$$typeof){case jl:return"<"+(_(d.value)||"Unknown")+">";case Yi:return":has("+(wo(d)||"")+")";case zu:return'[role="'+d.value+'"]';case lc:return'"'+d.value+'"';case ku:return'[data-testname="'+d.value+'"]';default:throw Error(i(365))}}function S_(d,p){var b=[];d=[d,0];for(var A=0;A<d.length;){var L=d[A++],B=L.tag,Z=d[A++],ne=p[Z];if(B!==5&&B!==26&&B!==27||!wu(L)){for(;ne!=null&&vu(L,ne);)Z++,ne=p[Z];if(Z===p.length)b.push(L);else for(L=L.child;L!==null;)d.push(L,Z),L=L.sibling}}return b}function wf(d,p){if(!Cu)throw Error(i(363));d=v_(d),d=S_(d,p),p=[],d=Array.from(d);for(var b=0;b<d.length;){var A=d[b++],L=A.tag;if(L===5||L===26||L===27)wu(A)||p.push(A.stateNode);else for(A=A.child;A!==null;)d.push(A),A=A.sibling}return p}function Pi(){if((Ke&2)!==0&&vt!==0)return vt&-vt;if(je.T!==null){var d=xs;return d!==0?d:an()}return sv()}function Xh(){wn===0&&(wn=(vt&536870912)===0||zt?R():536870912);var d=Cn.current;return d!==null&&(d.flags|=32),wn}function ia(d,p,b){(d===Wt&&(Zt===2||Zt===9)||d.cancelPendingCommit!==null)&&(Tn(d,0),Na(d,vt,wn,!1)),U(d,b),((Ke&2)===0||d!==Wt)&&(d===Wt&&((Ke&2)===0&&(Ql|=b),Gs===4&&Na(d,vt,wn,!1)),Mt(d))}function Rf(d,p,b){if((Ke&6)!==0)throw Error(i(327));var A=!b&&(p&124)===0&&(p&d.expiredLanes)===0||w(d,p),L=A?Ir(d,p):Ht(d,p,!0),B=A;do{if(L===0){Xr&&!A&&Na(d,p,0,!1);break}else{if(b=d.current.alternate,B&&!xn(b)){L=Ht(d,p,!1),B=!1;continue}if(L===2){if(B=p,d.errorRecoveryDisabledLanes&B)var Z=0;else Z=d.pendingLanes&-536870913,Z=Z!==0?Z:Z&536870912?536870912:0;if(Z!==0){p=Z;e:{var ne=d;L=$l;var de=Ba&&ne.current.memoizedState.isDehydrated;if(de&&(Tn(ne,Z).flags|=256),Z=Ht(ne,Z,!1),Z!==2){if(ip&&!de){ne.errorRecoveryDisabledLanes|=B,Ql|=B,L=4;break e}B=ha,ha=L,B!==null&&(ha===null?ha=B:ha.push.apply(ha,B))}L=Z}if(B=!1,L!==2)continue}}if(L===1){Tn(d,0),Na(d,p,0,!0);break}e:{switch(A=d,B=L,B){case 0:case 1:throw Error(i(345));case 4:if((p&4194048)!==p)break;case 6:Na(A,p,wn,!ko);break e;case 2:ha=null;break;case 3:case 5:break;default:throw Error(i(329))}if((p&62914560)===p&&(L=j_+300-ls(),10<L)){if(Na(A,p,wn,!ko),M(A,0,!0)!==0)break e;A.timeoutHandle=D_(hn.bind(null,A,b,ha,ap,Zl,p,wn,Ql,mn,ko,B,2,-0,0),L);break e}hn(A,b,ha,ap,Zl,p,wn,Ql,mn,ko,B,0,-0,0)}}break}while(!0);Mt(d)}function hn(d,p,b,A,L,B,Z,ne,de,we,Le,Be,Ue,ut){if(d.timeoutHandle=An,Be=p.subtreeFlags,(Be&8192||(Be&16785408)===16785408)&&(Uf(),Af(p),Be=av(),Be!==null)){d.cancelPendingCommit=Be(Yy.bind(null,d,p,B,b,A,L,Z,ne,de,Le,1,Ue,ut)),Na(d,B,Z,!we);return}Yy(d,p,B,b,A,L,Z,ne,de)}function xn(d){for(var p=d;;){var b=p.tag;if((b===0||b===11||b===15)&&p.flags&16384&&(b=p.updateQueue,b!==null&&(b=b.stores,b!==null)))for(var A=0;A<b.length;A++){var L=b[A],B=L.getSnapshot;L=L.value;try{if(!un(B(),L))return!1}catch{return!1}}if(b=p.child,p.subtreeFlags&16384&&b!==null)b.return=p,p=b;else{if(p===d)break;for(;p.sibling===null;){if(p.return===null||p.return===d)return!0;p=p.return}p.sibling.return=p.return,p=p.sibling}}return!0}function Na(d,p,b,A){p&=~X_,p&=~Ql,d.suspendedLanes|=p,d.pingedLanes&=~p,A&&(d.warmLanes|=p),A=d.expirationTimes;for(var L=p;0<L;){var B=31-ka(L),Z=1<<B;A[B]=-1,L&=~Z}b!==0&&N(d,b,p)}function Lr(){return(Ke&6)===0?(rs(0),!1):!0}function Kn(){if(ct!==null){if(Zt===0)var d=ct.return;else d=ct,ra=er=null,Yn(d),Hr=null,Bu=0,d=ct;for(;d!==null;)mu(d.alternate,d),d=d.return;ct=null}}function Tn(d,p){var b=d.timeoutHandle;b!==An&&(d.timeoutHandle=An,Bf(b)),b=d.cancelPendingCommit,b!==null&&(d.cancelPendingCommit=null,b()),Kn(),Wt=d,ct=b=Ro(d.current,null),vt=p,Zt=0,Aa=null,ko=!1,Xr=w(d,p),ip=!1,mn=wn=X_=Ql=fi=Gs=0,ha=$l=null,Zl=!1,(p&8)!==0&&(p|=p&32);var A=d.entangledLanes;if(A!==0)for(d=d.entanglements,A&=p;0<A;){var L=31-ka(A),B=1<<L;p|=d[L],A&=~B}return ai=p,of(),b}function qy(d,p){pt=null,je.H=Xl,p===Nu||p===vs?(p=Gm(),Zt=3):p===q_?(p=Gm(),Zt=4):Zt=p===Ot?8:p!==null&&typeof p=="object"&&typeof p.then=="function"?6:1,Aa=p,ct===null&&(Gs=1,r_(d,K(p,d.current)))}function b_(){var d=Cn.current;return d===null?!0:(vt&4194048)===vt?Wr===null:(vt&62914560)===vt||(vt&536870912)!==0?d===Wr:!1}function x_(){var d=je.H;return je.H=Xl,d===null?Xl:d}function aa(){var d=je.A;return je.A=Uu,d}function Fs(){Gs=4,ko||(vt&4194048)!==vt&&Cn.current!==null||(Xr=!0),(fi&134217727)===0&&(Ql&134217727)===0||Wt===null||Na(Wt,vt,wn,!1)}function Ht(d,p,b){var A=Ke;Ke|=2;var L=x_(),B=aa();(Wt!==d||vt!==p)&&(ap=null,Tn(d,p)),p=!1;var Z=Gs;e:do try{if(Zt!==0&&ct!==null){var ne=ct,de=Aa;switch(Zt){case 8:Kn(),Z=6;break e;case 3:case 2:case 9:case 6:Cn.current===null&&(p=!0);var we=Zt;if(Zt=0,Aa=null,Yh(d,ne,de,we),b&&Xr){Z=0;break e}break;default:we=Zt,Zt=0,Aa=null,Yh(d,ne,de,we)}}jh(),Z=Gs;break}catch(Le){qy(d,Le)}while(!0);return p&&d.shellSuspendCounter++,ra=er=null,Ke=A,je.H=L,je.A=B,ct===null&&(Wt=null,vt=0,of()),Z}function jh(){for(;ct!==null;)Ml(ct)}function Ir(d,p){var b=Ke;Ke|=2;var A=x_(),L=aa();Wt!==d||vt!==p?(ap=null,Vu=ls()+500,Tn(d,p)):Xr=w(d,p);e:do try{if(Zt!==0&&ct!==null){p=ct;var B=Aa;t:switch(Zt){case 1:Zt=0,Aa=null,Yh(d,p,B,1);break;case 2:case 9:if(wx(B)){Zt=0,Aa=null,jy(p);break}p=function(){Zt!==2&&Zt!==9||Wt!==d||(Zt=7),Mt(d)},B.then(p,p);break e;case 3:Zt=7;break e;case 4:Zt=5;break e;case 7:wx(B)?(Zt=0,Aa=null,jy(p)):(Zt=0,Aa=null,Yh(d,p,B,7));break;case 5:var Z=null;switch(ct.tag){case 26:Z=ct.memoizedState;case 5:case 27:var ne=ct,de=ne.type,we=ne.pendingProps;if(Z?Io(Z):P_(de,we)){Zt=0,Aa=null;var Le=ne.sibling;if(Le!==null)ct=Le;else{var Be=ne.return;Be!==null?(ct=Be,Dl(Be)):ct=null}break t}}Zt=0,Aa=null,Yh(d,p,B,5);break;case 6:Zt=0,Aa=null,Yh(d,p,B,6);break;case 8:Kn(),Gs=6;break e;default:throw Error(i(462))}}Xy();break}catch(Ue){qy(d,Ue)}while(!0);return ra=er=null,je.H=A,je.A=L,Ke=b,ct!==null?0:(Wt=null,vt=0,of(),Gs)}function Xy(){for(;ct!==null&&!gw();)Ml(ct)}function Ml(d){var p=yf(d.alternate,d,ai);d.memoizedProps=d.pendingProps,p===null?Dl(d):ct=p}function jy(d){var p=d,b=p.alternate;switch(p.tag){case 15:case 0:p=qx(b,p,p.pendingProps,p.type,void 0,vt);break;case 11:p=qx(b,p,p.pendingProps,p.type.render,p.ref,vt);break;case 5:Yn(p);default:mu(b,p),p=ct=li(p,ai),p=yf(b,p,ai)}d.memoizedProps=d.pendingProps,p===null?Dl(d):ct=p}function Yh(d,p,b,A){ra=er=null,Yn(p),Hr=null,Bu=0;var L=p.return;try{if(lw(d,L,p,b,vt)){Gs=1,r_(d,K(b,d.current)),ct=null;return}}catch(B){if(L!==null)throw ct=L,B;Gs=1,r_(d,K(b,d.current)),ct=null;return}p.flags&32768?(zt||A===1?d=!0:Xr||(vt&536870912)!==0?d=!1:(ko=d=!0,(A===2||A===9||A===3||A===6)&&(A=Cn.current,A!==null&&A.tag===13&&(A.flags|=16384))),Su(p,d)):Dl(p)}function Dl(d){var p=d;do{if((p.flags&32768)!==0){Su(p,ko);return}d=p.return;var b=cw(p.alternate,p,ai);if(b!==null){ct=b;return}if(p=p.sibling,p!==null){ct=p;return}ct=p=d}while(p!==null);Gs===0&&(Gs=5)}function Su(d,p){do{var b=on(d.alternate,d);if(b!==null){b.flags&=32767,ct=b;return}if(b=d.return,b!==null&&(b.flags|=32768,b.subtreeFlags=0,b.deletions=null),!p&&(d=d.sibling,d!==null)){ct=d;return}ct=d=b}while(d!==null);Gs=6,ct=null}function Yy(d,p,b,A,L,B,Z,ne,de){d.cancelPendingCommit=null;do En();while(vi!==0);if((Ke&6)!==0)throw Error(i(327));if(p!==null){if(p===d.current)throw Error(i(177));if(B=p.lanes|p.childLanes,B|=wv,O(d,b,B,Z,ne,de),d===Wt&&(ct=Wt=null,vt=0),Gu=p,Jl=d,Hu=b,Y_=B,K_=L,hc=A,(p.subtreeFlags&10256)!==0||(p.flags&10256)!==0?(d.callbackNode=null,d.callbackPriority=0,Qx(k_,function(){return Nr(),null})):(d.callbackNode=null,d.callbackPriority=0),A=(p.flags&13878)!==0,(p.subtreeFlags&13878)!==0||A){A=je.T,je.T=null,L=$n(),Li(2),Z=Ke,Ke|=4;try{Yx(d,p,b)}finally{Ke=Z,Li(L),je.T=A}}vi=1,bu(),T_(),Pl()}}function bu(){if(vi===1){vi=0;var d=Jl,p=Gu,b=(p.flags&13878)!==0;if((p.subtreeFlags&13878)!==0||b){b=je.T,je.T=null;var A=$n();Li(2);var L=Ke;Ke|=4;try{Wy(p,d),gt(d.containerInfo)}finally{Ke=L,Li(A),je.T=b}}d.current=p,vi=2}}function T_(){if(vi===2){vi=0;var d=Jl,p=Gu,b=(p.flags&8772)!==0;if((p.subtreeFlags&8772)!==0||b){b=je.T,je.T=null;var A=$n();Li(2);var L=Ke;Ke|=4;try{Al(d,p.alternate,p)}finally{Ke=L,Li(A),je.T=b}}vi=3}}function Pl(){if(vi===4||vi===3){vi=0,OT();var d=Jl,p=Gu,b=Hu,A=hc;(p.subtreeFlags&10256)!==0||(p.flags&10256)!==0?vi=5:(vi=0,Gu=Jl=null,Or(d,d.pendingLanes));var L=d.pendingLanes;if(L===0&&(jr=null),Y(b),p=p.stateNode,ba&&typeof ba.onCommitFiberRoot=="function")try{ba.onCommitFiberRoot(Ul,p,void 0,(p.current.flags&128)===128)}catch{}if(A!==null){p=je.T,L=$n(),Li(2),je.T=null;try{for(var B=d.onRecoverableError,Z=0;Z<A.length;Z++){var ne=A[Z];B(ne.value,{componentStack:ne.stack})}}finally{je.T=p,Li(L)}}(Hu&3)!==0&&En(),Mt(d),L=d.pendingLanes,(b&4194090)!==0&&(L&42)!==0?d===Q_?eh++:(eh=0,Q_=d):eh=0,rs(0)}}function Or(d,p){(d.pooledCacheLanes&=p)===0&&(p=d.pooledCache,p!=null&&(d.pooledCache=null,Xe(p)))}function En(d){return bu(),T_(),Pl(),Nr()}function Nr(){if(vi!==5)return!1;var d=Jl,p=Y_;Y_=0;var b=Y(Hu),A=32>b?32:b;b=je.T;var L=$n();try{Li(A),je.T=null,A=K_,K_=null;var B=Jl,Z=Hu;if(vi=0,Gu=Jl=null,Hu=0,(Ke&6)!==0)throw Error(i(331));var ne=Ke;if(Ke|=4,Oa(B.current),Ef(B,B.current,Z,A),Ke=ne,rs(0,!1),ba&&typeof ba.onPostCommitFiberRoot=="function")try{ba.onPostCommitFiberRoot(Ul,B)}catch{}return!0}finally{Li(L),je.T=b,Or(d,p)}}function E_(d,p,b){p=K(b,p),p=o_(d.stateNode,p,2),d=go(d,p,2),d!==null&&(U(d,2),Mt(d))}function Qt(d,p,b){if(d.tag===3)E_(d,d,b);else for(;p!==null;){if(p.tag===3){E_(p,d,b);break}else if(p.tag===1){var A=p.stateNode;if(typeof p.type.getDerivedStateFromError=="function"||typeof A.componentDidCatch=="function"&&(jr===null||!jr.has(A))){d=K(b,d),b=Ux(2),A=go(p,b,2),A!==null&&(zx(b,A,p,d),U(A,2),Mt(A));break}}p=p.return}}function Kh(d,p,b){var A=d.pingCache;if(A===null){A=d.pingCache=new Kl;var L=new Set;A.set(p,L)}else L=A.get(p),L===void 0&&(L=new Set,A.set(p,L));L.has(b)||(ip=!0,L.add(b),d=A_.bind(null,d,p,b),p.then(d,d))}function A_(d,p,b){var A=d.pingCache;A!==null&&A.delete(p),d.pingedLanes|=d.suspendedLanes&b,d.warmLanes&=~b,Wt===d&&(vt&b)===b&&(Gs===4||Gs===3&&(vt&62914560)===vt&&300>ls()-j_?(Ke&2)===0&&Tn(d,0):X_|=b,mn===vt&&(mn=0)),Mt(d)}function Ll(d,p){p===0&&(p=D()),d=si(d,p),d!==null&&(U(d,p),Mt(d))}function na(d){var p=d.memoizedState,b=0;p!==null&&(b=p.retryLane),Ll(d,b)}function C_(d,p){var b=0;switch(d.tag){case 13:var A=d.stateNode,L=d.memoizedState;L!==null&&(b=L.retryLane);break;case 19:A=d.stateNode;break;case 22:A=d.stateNode._retryCache;break;default:throw Error(i(314))}A!==null&&A.delete(p),Ll(d,b)}function Qx(d,p){return jf(d,p)}function dw(d,p,b,A){this.tag=d,this.key=b,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=p,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=A,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ky(d){return d=d.prototype,!(!d||!d.isReactComponent)}function Ro(d,p){var b=d.alternate;return b===null?(b=t(d.tag,p,d.key,d.mode),b.elementType=d.elementType,b.type=d.type,b.stateNode=d.stateNode,b.alternate=d,d.alternate=b):(b.pendingProps=p,b.type=d.type,b.flags=0,b.subtreeFlags=0,b.deletions=null),b.flags=d.flags&65011712,b.childLanes=d.childLanes,b.lanes=d.lanes,b.child=d.child,b.memoizedProps=d.memoizedProps,b.memoizedState=d.memoizedState,b.updateQueue=d.updateQueue,p=d.dependencies,b.dependencies=p===null?null:{lanes:p.lanes,firstContext:p.firstContext},b.sibling=d.sibling,b.index=d.index,b.ref=d.ref,b.refCleanup=d.refCleanup,b}function li(d,p){d.flags&=65011714;var b=d.alternate;return b===null?(d.childLanes=0,d.lanes=p,d.child=null,d.subtreeFlags=0,d.memoizedProps=null,d.memoizedState=null,d.updateQueue=null,d.dependencies=null,d.stateNode=null):(d.childLanes=b.childLanes,d.lanes=b.lanes,d.child=b.child,d.subtreeFlags=0,d.deletions=null,d.memoizedProps=b.memoizedProps,d.memoizedState=b.memoizedState,d.updateQueue=b.updateQueue,d.type=b.type,p=b.dependencies,d.dependencies=p===null?null:{lanes:p.lanes,firstContext:p.firstContext}),d}function xu(d,p,b,A,L,B){var Z=0;if(A=d,typeof d=="function")Ky(d)&&(Z=1);else if(typeof d=="string")Z=Sa&&Et?Hf(d,b,Ls.current)?26:Tv(d)?27:5:Sa?Hf(d,b,Ls.current)?26:5:Et&&Tv(d)?27:5;else e:switch(d){case tc:return d=t(31,b,p,L),d.elementType=tc,d.lanes=B,d;case ec:return Qn(b.children,L,B,p);case Df:Z=8,L|=24;break;case R_:return d=t(12,b,p,L|2),d.elementType=R_,d.lanes=B,d;case Lf:return d=t(13,b,p,L),d.elementType=Lf,d.lanes=B,d;case If:return d=t(19,b,p,L),d.elementType=If,d.lanes=B,d;default:if(typeof d=="object"&&d!==null)switch(d.$$typeof){case Pf:case Do:Z=10;break e;case Zy:Z=9;break e;case Fr:Z=11;break e;case Br:Z=14;break e;case va:Z=16,A=null;break e}Z=29,b=Error(i(130,d===null?"null":typeof d,"")),A=null}return p=t(Z,b,p,L),p.elementType=d,p.type=A,p.lanes=B,p}function Qn(d,p,b,A){return d=t(7,d,A,p),d.lanes=b,d}function Qh(d,p,b){return d=t(6,d,null,p),d.lanes=b,d}function Mf(d,p,b){return p=t(4,d.children!==null?d.children:[],d.key,p),p.lanes=b,p.stateNode={containerInfo:d.containerInfo,pendingChildren:null,implementation:d.implementation},p}function Tu(d,p,b,A,L,B,Z,ne){this.tag=1,this.containerInfo=d,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=An,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=I(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=I(0),this.hiddenUpdates=I(null),this.identifierPrefix=A,this.onUncaughtError=L,this.onCaughtError=B,this.onRecoverableError=Z,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=ne,this.incompleteTransitions=new Map}function $h(d,p,b,A,L,B,Z,ne,de,we,Le,Be){return d=new Tu(d,p,b,Z,ne,de,we,Be),p=1,B===!0&&(p|=24),B=t(3,null,null,p),d.current=B,B.stateNode=d,p=Ys(),p.refCount++,d.pooledCache=p,p.refCount++,B.memoizedState={element:A,isDehydrated:b,cache:p},lf(B),d}function $x(d){return d?(d=ac,d):ac}function Qy(d){var p=d._reactInternals;if(p===void 0)throw typeof d.render=="function"?Error(i(188)):(d=Object.keys(d).join(","),Error(i(268,d)));return d=r(p),d=d!==null?l(d):null,d===null?null:Au(d.stateNode)}function Zx(d,p,b,A,L,B){L=$x(L),A.context===null?A.context=L:A.pendingContext=L,A=vl(p),A.payload={element:b},B=B===void 0?null:B,B!==null&&(A.callback=B),b=go(d,A,p),b!==null&&(ia(b,d,p),yo(b,d,p))}function $y(d,p){if(d=d.memoizedState,d!==null&&d.dehydrated!==null){var b=d.retryLane;d.retryLane=b!==0&&b<p?b:p}}function Mo(d,p){$y(d,p),(d=d.alternate)&&$y(d,p)}var _t={},w_=ew(),Fa=TL(),Zh=Object.assign,Jx=Symbol.for("react.element"),Jh=Symbol.for("react.transitional.element"),Il=Symbol.for("react.portal"),ec=Symbol.for("react.fragment"),Df=Symbol.for("react.strict_mode"),R_=Symbol.for("react.profiler"),Pf=Symbol.for("react.provider"),Zy=Symbol.for("react.consumer"),Do=Symbol.for("react.context"),Fr=Symbol.for("react.forward_ref"),Lf=Symbol.for("react.suspense"),If=Symbol.for("react.suspense_list"),Br=Symbol.for("react.memo"),va=Symbol.for("react.lazy"),tc=Symbol.for("react.activity"),Jy=Symbol.for("react.memo_cache_sentinel"),M_=Symbol.iterator,Of=Symbol.for("react.client.reference"),Ol=Array.isArray,je=w_.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,eT=e.rendererVersion,Eu=e.rendererPackageName,Nf=e.extraDevToolsConfig,Au=e.getPublicInstance,ev=e.getRootHostContext,tv=e.getChildHostContext,Nl=e.prepareForCommit,gt=e.resetAfterCommit,os=e.createInstance;e.cloneMutableInstance;var Ks=e.appendInitialChild,Ff=e.finalizeInitialChildren,Po=e.shouldSetTextContent,Fl=e.createTextInstance;e.cloneMutableTextInstance;var D_=e.scheduleTimeout,Bf=e.cancelTimeout,An=e.noTimeout,Lo=e.isPrimaryRenderer;e.warnsIfNotActing;var Dt=e.supportsMutation,Ur=e.supportsPersistence,Ba=e.supportsHydration,tT=e.getInstanceFromNode;e.beforeActiveInstanceBlur;var sT=e.preparePortalMount;e.prepareScopeUpdate,e.getInstanceFromScope;var Li=e.setCurrentUpdatePriority,$n=e.getCurrentUpdatePriority,sv=e.resolveUpdatePriority;e.trackSchedulerEvent,e.resolveEventType,e.resolveEventTimeStamp;var iv=e.shouldAttemptEagerTransition,Ua=e.detachDeletedInstance;e.requestPostPaintCallback;var hi=e.maySuspendCommit,P_=e.preloadInstance,Uf=e.startSuspendingCommit,zf=e.suspendInstance;e.suspendOnActiveViewTransition;var av=e.waitForCommitToBeReady,za=e.NotPendingTransition,zr=e.HostTransitionContext,nv=e.resetFormInstance;e.bindToConsole;var rv=e.supportsMicrotasks,iT=e.scheduleMicrotask,Cu=e.supportsTestSelectors,aT=e.findFiberRoot,nT=e.getBoundingRect,rT=e.getTextContent,wu=e.isHiddenSubtree,ov=e.matchAccessibilityRole,oT=e.setFocusIfFocusable,fw=e.setupIntersectionObserver,lT=e.appendChild,hT=e.appendChildToContainer,cT=e.commitTextUpdate,lv=e.commitMount,uT=e.commitUpdate,dT=e.insertBefore,fT=e.insertInContainerBefore,pT=e.removeChild,mT=e.removeChildFromContainer,_T=e.resetTextContent,gT=e.hideInstance,Ru=e.hideTextInstance,L_=e.unhideInstance,yT=e.unhideTextInstance;e.cancelViewTransitionName,e.cancelRootViewTransitionName,e.restoreRootViewTransitionName,e.cloneRootViewTransitionContainer,e.removeRootViewTransitionClone,e.measureClonedInstance,e.hasInstanceChanged,e.hasInstanceAffectedParent,e.startViewTransition,e.startGestureTransition,e.stopGestureTransition,e.getCurrentGestureOffset,e.subscribeToGestureDirection,e.createViewTransitionInstance;var I_=e.clearContainer;e.createFragmentInstance,e.updateFragmentInstanceFiber,e.commitNewChildToFragmentInstance,e.deleteChildFromFragmentInstance;var kf=e.cloneInstance,hv=e.createContainerChildSet,cv=e.appendChildToContainerChildSet,vT=e.finalizeContainerChildren,uv=e.replaceContainerChildren,dv=e.cloneHiddenInstance,fv=e.cloneHiddenTextInstance,Vf=e.isSuspenseInstancePending,O_=e.isSuspenseInstanceFallback,ST=e.getSuspenseInstanceFallbackErrorDetails,pv=e.registerSuspenseInstanceRetry,bT=e.canHydrateFormStateMarker,xT=e.isFormStateMarkerMatching,TT=e.getNextHydratableSibling,mv=e.getNextHydratableSiblingAfterSingleton,ET=e.getFirstHydratableChild,AT=e.getFirstHydratableChildWithinContainer,_v=e.getFirstHydratableChildWithinSuspenseInstance,CT=e.getFirstHydratableChildWithinSingleton,wT=e.canHydrateInstance,pw=e.canHydrateTextInstance,mw=e.canHydrateSuspenseInstance,RT=e.hydrateInstance,Gf=e.hydrateTextInstance,gv=e.hydrateSuspenseInstance,N_=e.getNextHydratableInstanceAfterSuspenseInstance,MT=e.commitHydratedContainer,DT=e.commitHydratedSuspenseInstance,F_=e.clearSuspenseBoundary,PT=e.clearSuspenseBoundaryFromContainer,yv=e.shouldDeleteUnhydratedTailInstances;e.diffHydratedPropsForDevWarnings,e.diffHydratedTextForDevWarnings,e.describeHydratableInstanceForDevWarnings;var _w=e.validateHydratableInstance,Mu=e.validateHydratableTextInstance,Sa=e.supportsResources,Hf=e.isHostHoistableType,sc=e.getHoistableRoot,Wf=e.getResource,vv=e.acquireResource,Sv=e.releaseResource,Du=e.hydrateHoistable,bv=e.mountHoistable,cn=e.unmountHoistable,kr=e.createHoistableInstance,Bl=e.prepareToCommitHoistables,LT=e.mayResourceSuspendCommit,Io=e.preloadResource,Oo=e.suspendResource,Et=e.supportsSingletons,qf=e.resolveSingletonInstance,xv=e.acquireSingletonInstance,B_=e.releaseSingletonInstance,Tv=e.isHostSingletonType,ic=e.isSingletonScope,No=[],Fo=-1,ac={},ka=Math.clz32?Math.clz32:x,IT=Math.log,U_=Math.LN2,Xf=256,Pu=4194304,jf=Fa.unstable_scheduleCallback,z_=Fa.unstable_cancelCallback,gw=Fa.unstable_shouldYield,OT=Fa.unstable_requestPaint,ls=Fa.unstable_now,Ii=Fa.unstable_ImmediatePriority,NT=Fa.unstable_UserBlockingPriority,k_=Fa.unstable_NormalPriority,FT=Fa.unstable_IdlePriority,BT=Fa.log,UT=Fa.unstable_setDisableYieldValue,Ul=null,ba=null,V_,Ev,G_=!1,H_=new WeakMap,zl=[],kl=0,Yf=null,Lu=0,xa=[],Va=0,Vl=null,Zn=1,Vr="",Ls=g(null),nc=g(null),Gl=g(null),Kf=g(null),Vs=null,ci=null,zt=!1,Jn=null,Yt=!1,Av=Error(i(519)),un=typeof Object.is=="function"?Object.is:mt,Qf=g(null),er=null,ra=null,zT=typeof AbortController<"u"?AbortController:function(){var d=[],p=this.signal={aborted:!1,addEventListener:function(b,A){d.push(A)}};this.abort=function(){p.aborted=!0,d.forEach(function(b){return b()})}},kT=Fa.unstable_scheduleCallback,$f=Fa.unstable_NormalPriority,$t={$$typeof:Do,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0},Zf=null,Hl=null,W_=!1,Iu=!1,Jf=!1,Bo=0,Ou=null,tr=0,xs=0,Wl=null,Cv=je.S;je.S=function(d,p){typeof p=="object"&&p!==null&&typeof p.then=="function"&&su(d,p),Cv!==null&&Cv(d,p)};var Bs=g(null),yw=Object.prototype.hasOwnProperty,Nu=Error(i(460)),q_=Error(i(474)),vs=Error(i(542)),Xi={then:function(){}},Ga=null,dn=[],rc=0,wv=0,Gr=!1,Ta=!1,oa=g(null),ep=g(0),ui=0,pt=null,It=null,Ts=null,sr=!1,ql=!1,Uo=!1,fn=0,Fu=0,ir=null,tp=0,Xl={readContext:lt,use:ou,useCallback:ys,useContext:ys,useEffect:ys,useImperativeHandle:ys,useLayoutEffect:ys,useInsertionEffect:ys,useMemo:ys,useReducer:ys,useRef:ys,useState:ys,useDebugValue:ys,useDeferredValue:ys,useTransition:ys,useSyncExternalStore:ys,useId:ys,useHostTransitionStatus:ys,useFormState:ys,useActionState:ys,useOptimistic:ys,useMemoCache:ys,useCacheRefresh:ys},oc={readContext:lt,use:ou,useCallback:function(d,p){return ea().memoizedState=[d,p===void 0?null:p],d},useContext:lt,useEffect:Ry,useImperativeHandle:function(d,p,b){b=b!=null?b.concat([d]):null,df(4194308,4,cu.bind(null,p,d),b)},useLayoutEffect:function(d,p){return df(4194308,4,d,p)},useInsertionEffect:function(d,p){df(4,2,d,p)},useMemo:function(d,p){var b=ea();p=p===void 0?null:p;var A=d();if(Uo){F(!0);try{d()}finally{F(!1)}}return b.memoizedState=[A,p],A},useReducer:function(d,p,b){var A=ea();if(b!==void 0){var L=b(p);if(Uo){F(!0);try{b(p)}finally{F(!1)}}}else L=p;return A.memoizedState=A.baseState=L,d={pending:null,lanes:0,dispatch:null,lastRenderedReducer:d,lastRenderedState:L},A.queue=d,d=d.dispatch=Py.bind(null,pt,d),[A.memoizedState,d]},useRef:function(d){var p=ea();return d={current:d},p.memoizedState=d},useState:function(d){d=Km(d);var p=d.queue,b=t_.bind(null,pt,p);return p.dispatch=b,[d.memoizedState,b]},useDebugValue:ff,useDeferredValue:function(d,p){var b=ea();return uu(b,d,p)},useTransition:function(){var d=Km(!1);return d=Dy.bind(null,pt,d.queue,!0,!1),ea().memoizedState=d,[!1,d]},useSyncExternalStore:function(d,p,b){var A=pt,L=ea();if(zt){if(b===void 0)throw Error(i(407));b=b()}else{if(b=p(),Wt===null)throw Error(i(349));(vt&124)!==0||xy(A,p,b)}L.memoizedState=b;var B={value:b,getSnapshot:p};return L.queue=B,Ry(Rx.bind(null,A,B,d),[d]),A.flags|=2048,xl(9,vo(),uf.bind(null,A,B,b,p),null),b},useId:function(){var d=ea(),p=Wt.identifierPrefix;if(zt){var b=Vr,A=Zn;b=(A&~(1<<32-ka(A)-1)).toString(32)+b,p="«"+p+"R"+b,b=fn++,0<b&&(p+="H"+b.toString(32)),p+="»"}else b=tp++,p="«"+p+"r"+b.toString(32)+"»";return d.memoizedState=p},useHostTransitionStatus:bo,useFormState:$m,useActionState:$m,useOptimistic:function(d){var p=ea();p.memoizedState=p.baseState=d;var b={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return p.queue=b,p=fu.bind(null,pt,!0,b),b.dispatch=p,[d,p]},useMemoCache:Sy,useCacheRefresh:function(){return ea().memoizedState=ow.bind(null,pt)}},Rv={readContext:lt,use:ou,useCallback:pf,useContext:lt,useEffect:hu,useImperativeHandle:So,useInsertionEffect:wr,useLayoutEffect:e_,useMemo:My,useReducer:ga,useRef:Fh,useState:function(){return ga(Cr)},useDebugValue:ff,useDeferredValue:function(d,p){var b=ii();return mf(b,It.memoizedState,d,p)},useTransition:function(){var d=ga(Cr)[0],p=ii().memoizedState;return[typeof d=="boolean"?d:Oh(d),p]},useSyncExternalStore:cf,useId:_f,useHostTransitionStatus:bo,useFormState:Mx,useActionState:Mx,useOptimistic:function(d,p){var b=ii();return Qm(b,It,d,p)},useMemoCache:Sy,useCacheRefresh:du},VT={readContext:lt,use:ou,useCallback:pf,useContext:lt,useEffect:hu,useImperativeHandle:So,useInsertionEffect:wr,useLayoutEffect:e_,useMemo:My,useReducer:by,useRef:Fh,useState:function(){return by(Cr)},useDebugValue:ff,useDeferredValue:function(d,p){var b=ii();return It===null?uu(b,d,p):mf(b,It.memoizedState,d,p)},useTransition:function(){var d=by(Cr)[0],p=ii().memoizedState;return[typeof d=="boolean"?d:Oh(d),p]},useSyncExternalStore:cf,useId:_f,useHostTransitionStatus:bo,useFormState:Jm,useActionState:Jm,useOptimistic:function(d,p){var b=ii();return It!==null?Qm(b,It,d,p):(b.baseState=d,[d,b.queue.dispatch])},useMemoCache:Sy,useCacheRefresh:du},Hr=null,Bu=0,zo=Ox(!0),Mv=Ox(!1),Cn=g(null),Wr=null,st=g(0),hs={enqueueSetState:function(d,p,b){d=d._reactInternals;var A=Pi(),L=vl(A);L.payload=p,b!=null&&(L.callback=b),p=go(d,L,A),p!==null&&(ia(p,d,A),yo(p,d,A))},enqueueReplaceState:function(d,p,b){d=d._reactInternals;var A=Pi(),L=vl(A);L.tag=1,L.payload=p,b!=null&&(L.callback=b),p=go(d,L,A),p!==null&&(ia(p,d,A),yo(p,d,A))},enqueueForceUpdate:function(d,p){d=d._reactInternals;var b=Pi(),A=vl(b);A.tag=2,p!=null&&(A.callback=p),p=go(d,A,b),p!==null&&(ia(p,d,b),yo(p,d,b))}},Tt=typeof reportError=="function"?reportError:function(d){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var p=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof d=="object"&&d!==null&&typeof d.message=="string"?String(d.message):String(d),error:d});if(!window.dispatchEvent(p))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",d);return}console.error(d)},Ot=Error(i(461)),at=!1,Ea={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null},la=!1,Es=!1,sp=!1,qr=typeof WeakSet=="function"?WeakSet:Set,yt=null,Ss=null,di=!1,pn=null,ji=8192,Uu={getCacheForType:function(d){var p=lt($t),b=p.data.get(d);return b===void 0&&(b=d(),p.data.set(d,b)),b}},jl=0,Yi=1,zu=2,ku=3,lc=4;if(typeof Symbol=="function"&&Symbol.for){var Yl=Symbol.for;jl=Yl("selector.component"),Yi=Yl("selector.has_pseudo_class"),zu=Yl("selector.role"),ku=Yl("selector.test_id"),lc=Yl("selector.text")}var Kl=typeof WeakMap=="function"?WeakMap:Map,Ke=0,Wt=null,ct=null,vt=0,Zt=0,Aa=null,ko=!1,Xr=!1,ip=!1,ai=0,Gs=0,fi=0,Ql=0,X_=0,wn=0,mn=0,$l=null,ha=null,Zl=!1,j_=0,Vu=1/0,ap=null,jr=null,vi=0,Jl=null,Gu=null,Hu=0,Y_=0,K_=null,hc=null,eh=0,Q_=null;return _t.attemptContinuousHydration=function(d){if(d.tag===13){var p=si(d,67108864);p!==null&&ia(p,d,67108864),Mo(d,67108864)}},_t.attemptHydrationAtCurrentPriority=function(d){if(d.tag===13){var p=Pi();p=X(p);var b=si(d,p);b!==null&&ia(b,d,p),Mo(d,p)}},_t.attemptSynchronousHydration=function(d){switch(d.tag){case 3:if(d=d.stateNode,d.current.memoizedState.isDehydrated){var p=C(d.pendingLanes);if(p!==0){for(d.pendingLanes|=2,d.entangledLanes|=2;p;){var b=1<<31-ka(p);d.entanglements[1]|=b,p&=~b}Mt(d),(Ke&6)===0&&(Vu=ls()+500,rs(0))}}break;case 13:p=si(d,2),p!==null&&ia(p,d,2),Lr(),Mo(d,2)}},_t.batchedUpdates=function(d,p){return d(p)},_t.createComponentSelector=function(d){return{$$typeof:jl,value:d}},_t.createContainer=function(d,p,b,A,L,B,Z,ne,de,we){return $h(d,p,!1,null,b,A,B,Z,ne,de,we,null)},_t.createHasPseudoClassSelector=function(d){return{$$typeof:Yi,value:d}},_t.createHydrationContainer=function(d,p,b,A,L,B,Z,ne,de,we,Le,Be,Ue){return d=$h(b,A,!0,d,L,B,ne,de,we,Le,Be,Ue),d.context=$x(null),b=d.current,A=Pi(),A=X(A),L=vl(A),L.callback=p??null,go(b,L,A),p=A,d.current.lanes=p,U(d,p),Mt(d),d},_t.createPortal=function(d,p,b){var A=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Il,key:A==null?null:""+A,children:d,containerInfo:p,implementation:b}},_t.createRoleSelector=function(d){return{$$typeof:zu,value:d}},_t.createTestNameSelector=function(d){return{$$typeof:ku,value:d}},_t.createTextSelector=function(d){return{$$typeof:lc,value:d}},_t.defaultOnCaughtError=function(d){console.error(d)},_t.defaultOnRecoverableError=function(d){Tt(d)},_t.defaultOnUncaughtError=function(d){Tt(d)},_t.deferredUpdates=function(d){var p=je.T,b=$n();try{return Li(32),je.T=null,d()}finally{Li(b),je.T=p}},_t.discreteUpdates=function(d,p,b,A,L){var B=je.T,Z=$n();try{return Li(2),je.T=null,d(p,b,A,L)}finally{Li(Z),je.T=B,Ke===0&&(Vu=ls()+500)}},_t.findAllNodes=wf,_t.findBoundingRects=function(d,p){if(!Cu)throw Error(i(363));p=wf(d,p),d=[];for(var b=0;b<p.length;b++)d.push(nT(p[b]));for(p=d.length-1;0<p;p--){b=d[p];for(var A=b.x,L=A+b.width,B=b.y,Z=B+b.height,ne=p-1;0<=ne;ne--)if(p!==ne){var de=d[ne],we=de.x,Le=we+de.width,Be=de.y,Ue=Be+de.height;if(A>=we&&B>=Be&&L<=Le&&Z<=Ue){d.splice(p,1);break}else if(A!==we||b.width!==de.width||Ue<B||Be>Z){if(!(B!==Be||b.height!==de.height||Le<A||we>L)){we>A&&(de.width+=we-A,de.x=A),Le<L&&(de.width=L-we),d.splice(p,1);break}}else{Be>B&&(de.height+=Be-B,de.y=B),Ue<Z&&(de.height=Z-Be),d.splice(p,1);break}}}return d},_t.findHostInstance=Qy,_t.findHostInstanceWithNoPortals=function(d){return d=r(d),d=d!==null?u(d):null,d===null?null:Au(d.stateNode)},_t.findHostInstanceWithWarning=function(d){return Qy(d)},_t.flushPassiveEffects=En,_t.flushSyncFromReconciler=function(d){var p=Ke;Ke|=1;var b=je.T,A=$n();try{if(Li(2),je.T=null,d)return d()}finally{Li(A),je.T=b,Ke=p,(Ke&6)===0&&rs(0)}},_t.flushSyncWork=Lr,_t.focusWithin=function(d,p){if(!Cu)throw Error(i(363));for(d=v_(d),p=S_(d,p),p=Array.from(p),d=0;d<p.length;){var b=p[d++],A=b.tag;if(!wu(b)){if((A===5||A===26||A===27)&&oT(b.stateNode))return!0;for(b=b.child;b!==null;)p.push(b),b=b.sibling}}return!1},_t.getFindAllNodesFailureDescription=function(d,p){if(!Cu)throw Error(i(363));var b=0,A=[];d=[v_(d),0];for(var L=0;L<d.length;){var B=d[L++],Z=B.tag,ne=d[L++],de=p[ne];if((Z!==5&&Z!==26&&Z!==27||!wu(B))&&(vu(B,de)&&(A.push(wo(de)),ne++,ne>b&&(b=ne)),ne<p.length))for(B=B.child;B!==null;)d.push(B,ne),B=B.sibling}if(b<p.length){for(d=[];b<p.length;b++)d.push(wo(p[b]));return`findAllNodes was able to match part of the selector:
  `+(A.join(" > ")+`

No matching component was found for:
  `)+d.join(" > ")}return null},_t.getPublicRootInstance=function(d){if(d=d.current,!d.child)return null;switch(d.child.tag){case 27:case 5:return Au(d.child.stateNode);default:return d.child.stateNode}},_t.injectIntoDevTools=function(){var d={bundleType:0,version:eT,rendererPackageName:Eu,currentDispatcherRef:je,reconcilerVersion:"19.1.0"};if(Nf!==null&&(d.rendererConfig=Nf),typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u")d=!1;else{var p=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(p.isDisabled||!p.supportsFiber)d=!0;else{try{Ul=p.inject(d),ba=p}catch{}d=!!p.checkDCE}}return d},_t.isAlreadyRendering=function(){return(Ke&6)!==0},_t.observeVisibleRects=function(d,p,b,A){if(!Cu)throw Error(i(363));d=wf(d,p);var L=fw(d,b,A).disconnect;return{disconnect:function(){L()}}},_t.shouldError=function(){return null},_t.shouldSuspend=function(){return!1},_t.startHostTransition=function(d,p,b,A){if(d.tag!==5)throw Error(i(476));var L=ya(d).queue;Dy(d,L,p,za,b===null?s:function(){var B=ya(d).next.queue;return xo(d,B,{},Pi()),b(A)})},_t.updateContainer=function(d,p,b,A){var L=p.current,B=Pi();return Zx(L,B,d,p,b,A),B},_t.updateContainerSync=function(d,p,b,A){return Zx(p.current,2,d,p,b,A),2},_t},h.exports.default=h.exports,Object.defineProperty(h.exports,"__esModule",{value:!0})}(PM)),PM.exports}var j5;function ile(){return j5||(j5=1,DM.exports=sle()),DM.exports}var ale=ile();const nle=JC(ale);var LM={exports:{}},Rc={};/**
 * @license React
 * react-reconciler-constants.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Y5;function rle(){return Y5||(Y5=1,Rc.ConcurrentRoot=1,Rc.ContinuousEventPriority=8,Rc.DefaultEventPriority=32,Rc.DiscreteEventPriority=2,Rc.IdleEventPriority=268435456,Rc.LegacyRoot=0,Rc.NoEventPriority=0),Rc}var K5;function ole(){return K5||(K5=1,LM.exports=rle()),LM.exports}var iw=ole(),lle=Rt();const Q5={children:!0,ref:!0,key:!0,style:!0,forwardedRef:!0,unstable_applyCache:!0,unstable_applyDrawHitFromCache:!0};let $5=!1,Z5=!1;const RL=".react-konva-event",hle=`ReactKonva: You have a Konva node with draggable = true and position defined but no onDragMove or onDragEnd events are handled.
Position of a node will be changed during drag&drop, so you should update state of the react app as well.
Consider to add onDragMove or onDragEnd events.
For more info see: https://github.com/konvajs/react-konva/issues/256
`,cle=`ReactKonva: You are using "zIndex" attribute for a Konva node.
react-konva may get confused with ordering. Just define correct order of elements in your render function of a component.
For more info see: https://github.com/konvajs/react-konva/issues/194
`,ule={};function aw(h,e,t=ule){if(!$5&&"zIndex"in e&&(console.warn(cle),$5=!0),!Z5&&e.draggable){var s=e.x!==void 0||e.y!==void 0,i=e.onDragEnd||e.onDragMove;s&&!i&&(console.warn(hle),Z5=!0)}for(var a in t)if(!Q5[a]){var n=a.slice(0,2)==="on",r=t[a]!==e[a];if(n&&r){var l=a.substr(2).toLowerCase();l.substr(0,7)==="content"&&(l="content"+l.substr(7,1).toUpperCase()+l.substr(8)),h.off(l,t[a])}var u=!e.hasOwnProperty(a);u&&h.setAttr(a,void 0)}var f=e._useStrictMode,_={},g=!1;const y={};for(var a in e)if(!Q5[a]){var n=a.slice(0,2)==="on",v=t[a]!==e[a];if(n&&v){var l=a.substr(2).toLowerCase();l.substr(0,7)==="content"&&(l="content"+l.substr(7,1).toUpperCase()+l.substr(8)),e[a]&&(y[l]=e[a])}!n&&(e[a]!==t[a]||f&&e[a]!==h.getAttr(a))&&(g=!0,_[a]=e[a])}g&&(h.setAttrs(_),af(h));for(var l in y)h.on(l+RL,y[l])}function af(h){if(!lle.Konva.autoDrawEnabled){var e=h.getLayer()||h.getStage();e&&e.batchDraw()}}var IM=TL();const sk={},dle={};C2.Node.prototype._applyProps=aw;let ik=iw.DefaultEventPriority;function fle(h,e){if(typeof e=="string"){console.error(`Do not use plain text as child of Konva.Node. You are using text: ${e}`);return}h.add(e),af(h)}function ple(h,e,t){let s=C2[h];s||(console.error(`Konva has no node with the type ${h}. Group will be used instead. If you use minimal version of react-konva, just import required nodes into Konva: "import "konva/lib/shapes/${h}"  If you want to render DOM elements as part of canvas tree take a look into this demo: https://konvajs.github.io/docs/react/DOM_Portal.html`),s=C2.Group);const i={},a={};for(var n in e)if(n!=="ref"){var r=n.slice(0,2)==="on";r?a[n]=e[n]:i[n]=e[n]}const l=new s(i);return aw(l,a),l}function mle(h,e,t){console.error(`Text components are not supported for now in ReactKonva. Your text is: "${h}"`)}function _le(h,e,t){return!1}function gle(h){return h}function yle(){return null}function vle(){return null}function Sle(h,e,t,s){return dle}function ble(){}function xle(h){}function Tle(h,e){return!1}function Ele(){return sk}function Ale(){return sk}const Cle=setTimeout,wle=clearTimeout,Rle=!0,Mle=h=>{h()},Dle=-1;function Ple(h,e){return!1}const Lle=!1,Ile=!1,Ole=!0,Nle=!1,Fle=!1;function Ble(h,e){e.parent===h?e.moveToTop():h.add(e),af(h)}function Ule(h,e){e.parent===h?e.moveToTop():h.add(e),af(h)}function ak(h,e,t){e._remove(),h.add(e),e.setZIndex(t.getZIndex()),af(h)}function zle(h,e,t){ak(h,e,t)}function kle(h,e){e.destroy(),e.off(RL),af(h)}function Vle(h,e){e.destroy(),e.off(RL),af(h)}function Gle(h,e,t){console.error(`Text components are not yet supported in ReactKonva. You text is: "${t}"`)}function Hle(h,e,t){}function Wle(h,e,t,s){aw(h,s,t)}function qle(h){h.hide(),af(h)}function Xle(h){}function jle(h,e){(e.visible==null||e.visible)&&h.show()}function Yle(h,e){}function Kle(h){}function Qle(){}function $le(){return iw.DefaultEventPriority}function Zle(){}function Jle(){return null}function ehe(h){ik=h}function the(){return ik}function she(){return iw.DiscreteEventPriority}function ihe(){return!1}function ahe(){}function nhe(){return!1}function rhe(){return!0}function ohe(){}function lhe(){}function hhe(){return null}const che=null;function uhe(){}const dhe=Object.freeze(Object.defineProperty({__proto__:null,NotPendingTransition:che,appendChild:Ble,appendChildToContainer:Ule,appendInitialChild:fle,cancelTimeout:wle,clearContainer:Kle,commitMount:Hle,commitTextUpdate:Gle,commitUpdate:Wle,createInstance:ple,createTextInstance:mle,detachDeletedInstance:Qle,finalizeInitialChildren:_le,getChildHostContext:Ale,getCurrentEventPriority:$le,getCurrentUpdatePriority:the,getInstanceFromScope:Jle,getPublicInstance:gle,getRootHostContext:Ele,hideInstance:qle,hideTextInstance:Xle,idlePriority:IM.unstable_IdlePriority,insertBefore:ak,insertInContainerBefore:zle,isPrimaryRenderer:Lle,maySuspendCommit:nhe,noTimeout:Dle,now:IM.unstable_now,preloadInstance:rhe,prepareForCommit:yle,preparePortalMount:vle,prepareScopeUpdate:Zle,prepareUpdate:Sle,removeChild:kle,removeChildFromContainer:Vle,requestPostPaintCallback:ahe,resetAfterCommit:ble,resetFormInstance:uhe,resetTextContent:xle,resolveUpdatePriority:she,run:IM.unstable_runWithPriority,scheduleMicrotask:Mle,scheduleTimeout:Cle,setCurrentUpdatePriority:ehe,shouldAttemptEagerTransition:ihe,shouldDeprioritizeSubtree:Tle,shouldSetTextContent:Ple,startSuspendingCommit:ohe,supportsHydration:Fle,supportsMicrotasks:Rle,supportsMutation:Ole,supportsPersistence:Nle,suspendInstance:lhe,unhideInstance:jle,unhideTextInstance:Yle,waitForCommitToBeReady:hhe,warnsIfNotActing:Ile},Symbol.toStringTag,{value:"Module"}));function nk(h,e,t){if(!h)return;if(t(h)===!0)return h;let s=h.child;for(;s;){const i=nk(s,e,t);if(i)return i;s=s.sibling}}function rk(h){try{return Object.defineProperties(h,{_currentRenderer:{get(){return null},set(){}},_currentRenderer2:{get(){return null},set(){}}})}catch{return h}}const ML=rk(ds.createContext(null));class ok extends ds.Component{render(){return ds.createElement(ML.Provider,{value:this._reactInternals},this.props.children)}}function fhe(){const h=ds.useContext(ML);if(h===null)throw new Error("its-fine: useFiber must be called within a <FiberProvider />!");const e=ds.useId();return ds.useMemo(()=>{for(const t of[h,h==null?void 0:h.alternate]){if(!t)continue;const s=nk(t,!1,i=>{let a=i.memoizedState;for(;a;){if(a.memoizedState===e)return!0;a=a.next}});if(s)return s}},[h,e])}const phe=Symbol.for("react.context"),mhe=h=>h!==null&&typeof h=="object"&&"$$typeof"in h&&h.$$typeof===phe;function _he(){const h=fhe(),[e]=ds.useState(()=>new Map);e.clear();let t=h;for(;t;){const s=t.type;mhe(s)&&s!==ML&&!e.has(s)&&e.set(s,ds.use(rk(s))),t=t.return}return e}function ghe(){const h=_he();return ds.useMemo(()=>Array.from(h.keys()).reduce((e,t)=>s=>ds.createElement(e,null,ds.createElement(t.Provider,{...s,value:h.get(t)})),e=>ds.createElement(ok,{...e})),[h])}if(Ci.version.indexOf("19")===-1)throw new Error("react-konva version 19 is only compatible with React 19. Make sure to have the last version of react-konva and react or downgrade react-konva to version 18.");function yhe(h){const e=Ci.useRef({});return Ci.useLayoutEffect(()=>{e.current=h}),Ci.useLayoutEffect(()=>()=>{e.current={}},[]),e.current}const vhe=()=>{const h=Ci.useRef(0);return Ci.useMemo(()=>{h.current++},[]),h.current>1},She=h=>{const e=Ci.useRef(null),t=Ci.useRef(null),s=Ci.useRef(null),i=yhe(h),a=ghe(),n=Ci.useRef(!1),r=u=>{const{forwardedRef:f}=h;f&&(typeof f=="function"?f(u):f.current=u)},l=vhe();return Ci.useLayoutEffect(()=>n.current&&l?()=>{n.current=!1,r(null),Bg.updateContainer(null,s.current,null),t.current.destroy()}:(n.current=!0,t.current=new C2.Stage({width:h.width,height:h.height,container:e.current}),r(t.current),s.current=Bg.createContainer(t.current,iw.ConcurrentRoot,null,!1,null,"",console.error,console.error,console.error,null),Bg.updateContainer(Ci.createElement(a,{},h.children),s.current,null,()=>{}),()=>{l||(r(null),Bg.updateContainer(null,s.current,null),t.current.destroy())}),[]),Ci.useLayoutEffect(()=>{r(t.current),aw(t.current,h,i),Bg.updateContainer(Ci.createElement(a,{},h.children),s.current,null)}),Ci.createElement("div",{ref:e,id:h.id,accessKey:h.accessKey,className:h.className,role:h.role,style:h.style,tabIndex:h.tabIndex,title:h.title})},lA="Layer",bhe="Group",eb="Rect",xhe="Circle",hA="Line",Bg=nle(dhe);Bg.injectIntoDevTools({findHostInstanceByFiber:()=>null,bundleType:0,version:Ci.version,rendererPackageName:"react-konva"});const The=Ci.forwardRef((h,e)=>Ci.createElement(ok,{},Ci.createElement(She,{...h,forwardedRef:e}))),Ehe=ds.forwardRef(({gridSize:h=10,totalWidth:e=400,totalHeight:t=400,indicatorOpacity:s=1,cornerColors:i=["#FF5733","#33FF57","#3357FF","#F033FF"],_onCellEnter:a=()=>{},onLatentChange:n=()=>{},isLoading:r=!1},l)=>{const u=e/h,f=t/h,_=ds.useRef(null),[g,y]=ds.useState(()=>{const V=Array.from({length:h},()=>Array(h).fill(!1));try{const Q=localStorage.getItem("cachedCells");if(Q){const se=JSON.parse(Q);if(Array.isArray(se)&&se.length===h&&se.every(J=>Array.isArray(J)&&J.length===h))return se.map(J=>J.map(ie=>!!ie))}}catch{}return V}),v=ds.useCallback((V,Q)=>{y(se=>{if(se[V][Q])return se;const J=se.map(ie=>ie.slice());J[V][Q]=!0;try{localStorage.setItem("cachedCells",JSON.stringify(J))}catch{}return J})},[]);ds.useEffect(()=>(window.markCellCached=v,()=>{delete window.markCellCached}),[v]);const x=1,C=h-2,M=h>2?x+Math.floor(Math.random()*(C-x+1)):Math.floor(h/2),w=h>2?x+Math.floor(Math.random()*(C-x+1)):Math.floor(h/2),T=(w+.5)*u,R=(M+.5)*f,[D,I]=ds.useState([M,w]),[U,O]=ds.useState({x:T,y:R}),N=ds.useRef(!1),[z,X]=ds.useState(!1),Y=ds.useRef(null),F=ds.useRef(null),q=ds.useCallback((V,Q)=>{const se=(Q+.5)*u,J=(V+.5)*f;O({x:se,y:J}),X(!0)},[u,f]);ds.useImperativeHandle(l,()=>({setActiveCell:q}),[q]),ds.useEffect(()=>{n(M,w,U.x/e,U.y/t)},[]),ds.useEffect(()=>{if(z)return;const V=Y.current;if(!V)return;const Q=V.getLayer();if(!Q)return;const se=new W5.Animation(J=>{const ie=(J==null?void 0:J.time)??0,oe=1+.1*Math.sin(ie/250);V.scale({x:oe,y:oe}),V.opacity(.8+.2*Math.sin(ie/250))},Q);return se.start(),()=>{se.stop(),V.scale({x:1,y:1}),V.opacity(s)}},[z,s]),ds.useEffect(()=>{const V=F.current;if(!V)return;let Q=null;if(r){V.dash([6,4]),V.dashEnabled(!0);const se=V.getLayer();se&&(Q=new W5.Animation(J=>{const ie=(J==null?void 0:J.timeDiff)??0,oe=V.dashOffset();V.dashOffset(oe+ie*.1)},se),Q.start())}else V.dash([]),V.dashOffset(0),V.dashEnabled(!1);return()=>{Q&&Q.stop()}},[r]);const G=[0,0],W=(V,Q)=>(G[0]=Math.max(0,Math.min(h-1,Q/f|0)),G[1]=Math.max(0,Math.min(h-1,V/u|0)),G);ds.useEffect(()=>{const V=W(U.x,U.y);(V[0]!==D[0]||V[1]!==D[1])&&(I([V[0],V[1]]),n(V[0],V[1],U.x/e,U.y/t))},[U,D,u,f,h,n,e,t,W]);const k=()=>{N.current=!0,z||X(!0)},K=V=>{const Q=V.target.position(),se=Math.max(0,Math.min(e,Q.x)),J=Math.max(0,Math.min(t,Q.y));V.target.position({x:se,y:J}),O({x:se,y:J}),z||X(!0)},ee=()=>{N.current=!1};return qa.jsxs(The,{ref:_,width:e,height:t,style:{touchAction:"none"},children:[qa.jsxs(lA,{listening:!1,children:[qa.jsx(eb,{width:e,height:t,fillLinearGradientStartPoint:{x:0,y:0},fillLinearGradientEndPoint:{x:e,y:0},fillLinearGradientColorStops:[0,i[0],1,i[1]]}),qa.jsx(eb,{width:e,height:t,opacity:.5,fillLinearGradientStartPoint:{x:0,y:0},fillLinearGradientEndPoint:{x:0,y:t},fillLinearGradientColorStops:[0,"transparent",1,i[3]]}),qa.jsx(eb,{width:e,height:t,opacity:.5,fillLinearGradientStartPoint:{x:e,y:0},fillLinearGradientEndPoint:{x:e,y:t},fillLinearGradientColorStops:[0,"transparent",1,i[2]]})]}),qa.jsx(lA,{listening:!1,children:g.map((V,Q)=>V.map((se,J)=>se&&qa.jsx(eb,{x:J*u,y:Q*f,width:u,height:f,fill:"rgba(255,255,255,0.12)"},`${Q}-${J}`)))}),qa.jsxs(lA,{listening:!1,children:[Array.from({length:h+1},(V,Q)=>qa.jsx(hA,{points:[Q*u,0,Q*u,t],stroke:"#777",strokeWidth:1},`v${Q}`)),Array.from({length:h+1},(V,Q)=>qa.jsx(hA,{points:[0,Q*f,e,Q*f],stroke:"#777",strokeWidth:1},`h${Q}`)),qa.jsx(eb,{x:0,y:0,width:e,height:t,stroke:"#009775",strokeWidth:2,cornerRadius:4})]}),qa.jsx(lA,{children:qa.jsxs(bhe,{ref:Y,x:U.x,y:U.y,draggable:!0,onDragStart:k,onDragMove:K,onDragEnd:ee,opacity:s,children:[qa.jsx(xhe,{ref:F,name:"indicatorCore",radius:16,fill:"#ffffff",stroke:r?"#ffa500":"#009775",strokeWidth:2,shadowColor:"black",shadowBlur:4,shadowOpacity:.4,shadowOffset:{x:2,y:2}}),qa.jsx(hA,{points:[-6,-2,6,-2],stroke:"#009775",strokeWidth:2,lineCap:"round"}),qa.jsx(hA,{points:[-6,2,6,2],stroke:"#009775",strokeWidth:2,lineCap:"round"})]})})]})});window.pc=wre;const lk="data/compressed_head_models_512_16x16";let w2={},gD=0;async function Ahe(){try{const h=await fetch(`${lk}/latent-viewer-meta.json`);if(!h.ok)throw new Error(`HTTP ${h.status}`);const e=await h.json();e&&typeof e=="object"&&(w2=e.cellBytes||{},gD=e.totalBytes||0,console.log(`Loaded metadata: ${Object.keys(w2).length} models, ${(gD/1024/1024).toFixed(1)} MB total`))}catch(h){console.error("Failed to load metadata",h),console.warn("Cache progress will not be available")}}window._pendingSwitchModelDir=null;window.switchModel=async h=>{window._pendingSwitchModelDir=h};const J5=window.switchModel;function Che(h){const e=/model_c(\d+)_r(\d+)/.exec(h);if(!e)return null;const t=parseInt(e[1],10);return[parseInt(e[2],10),t]}let yD=!1;const Ab=16;let DL=0;const vD=new Set;let Qo=null,Zp=null,tb=!1;function PL(h,e){return`model_c${e.toString().padStart(2,"0")}_r${h.toString().padStart(2,"0")}`}function OM(h,e){return`${lk}/${PL(h,e)}`}function whe(){try{const h=localStorage.getItem("cachedCells");if(h){const e=JSON.parse(h);if(Array.isArray(e)&&e.length===Ab){for(let t=0;t<Ab;t++)for(let s=0;s<Ab;s++)if(e[t][s]){const i=PL(t,s);DL+=w2[i]||0,vD.add(`${t},${s}`)}}}}catch{}}let Bn=null,ja=null,rh=null;function Rhe(h){Bn||(Bn=document.createElement("div"),Bn.textContent="Loading model...",Object.assign(Bn.style,{marginTop:"0px",padding:"4px 12px",background:"rgba(0,0,0,0.6)",color:"#fff",fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',fontSize:"13px",fontWeight:"400",borderRadius:"9999px",pointerEvents:"none",userSelect:"none",backdropFilter:"blur(2px)",visibility:"hidden"}),h.appendChild(Bn))}function eF(h){ja||(ja=document.getElementById("statusArea")),ja?h?(ja.textContent="Loading model...",ja.style.color="#bbb"):ja.textContent="":Bn&&(Bn.style.visibility=h?"visible":"hidden")}function SD(){if(yD)return;yD=!0;const h=document.querySelector("pc-app");if(!h){console.error("<pc-app> not found in DOM");return}Ahe().then(()=>{whe(),Mhe(),Dhe(),Phe(),Zp==null||Zp()}),h.addEventListener("ready",()=>{d0(pD,"cameraControls"),d0(ioe,"xrControllers"),d0(aoe,"xrNavigation");const e=h.app,t=document.getElementById("bgColorPicker");if(t){const s=i=>{if(!/^#?[0-9a-fA-F]{6}$/.test(i))return;const a=i.startsWith("#")?i.substring(1):i,n=parseInt(a.substring(0,2),16)/255,r=parseInt(a.substring(2,4),16)/255,l=parseInt(a.substring(4,6),16)/255,u=e.root.findByName("camera");u&&u.camera&&u.camera.clearColor.set(n,r,l,1)};s(t.value),t.addEventListener("input",()=>{s(t.value)})}Lhe(h)},{once:!0})}function Mhe(){const h=document.getElementById("latentGrid");if(!h){console.error("Grid container not found");return}const e=Ci.createRef(),t=document.getElementById("downloadAllBtn"),s=document.getElementById("downloadStatus"),i=()=>{if(!s)return;const n=(DL/(1024*1024)).toFixed(1),r=(gD/(1024*1024)).toFixed(1);s.textContent=`${n} MB / ${r} MB`};i(),Zp=i;function a(){Qo&&t&&(Qo.canceled=!0,t.classList.remove("downloading"),t.title="Download and cache all models",tb=!1)}window.cancelBulkDownload=a,h.addEventListener("pointerdown",a),t&&t.addEventListener("click",async()=>{var r,l;if(Qo){Qo.canceled=!0,Qo=null,t.classList.remove("downloading"),t.title="Download and cache all models";return}window.switchModel===J5&&await new Promise(u=>{const f=setInterval(()=>{window.switchModel!==J5&&(clearInterval(f),u())},50)}),Qo={canceled:!1},t.classList.add("downloading"),t.title="Cancel download";let n=[];try{const u=localStorage.getItem("cachedCells");u&&(n=JSON.parse(u))}catch{n=[]}try{for(let u=0;u<Ab;u++){for(let f=0;f<Ab&&!Qo.canceled;f++)if(!((r=n[u])!=null&&r[f])){tb=!0,(l=e.current)==null||l.setActiveCell(u,f);try{await window.switchModel(OM(u,f))}catch(_){console.error(`Error loading model during bulk download: ${OM(u,f)}`,_),Qo.canceled=!0;break}if(tb=!1,Qo.canceled)break;n[u]||(n[u]=[]),n[u][f]=!0}if(Qo.canceled)break}}finally{t.classList.remove("downloading"),t.title="Download and cache all models",Qo=null,tb=!1}});try{const n=uoe.createRoot(h),r=h.closest(".latent-section");r&&Rhe(r);let l=!1;const u=()=>{n.render(Ci.createElement(Ehe,{ref:e,gridSize:16,totalWidth:200,totalHeight:200,indicatorOpacity:.7,cornerColors:["#009775","#662d91","#662d91","#009775"],isLoading:l,onLatentChange:(f,_)=>{var y;if(tb)return;(y=window.cancelBulkDownload)==null||y.call(window);const g=OM(f,_);window.switchModel(g)}}))};u(),window.setGridLoading=f=>{l=f,u()}}catch(n){console.error("Error rendering grid:",n)}}function Dhe(){const h=document.getElementById("fullscreenBtn");if(!h)return;const e=document.querySelector(".container");h.addEventListener("click",()=>{if(e)if(document.fullscreenElement){const t=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;t==null||t.call(document)}else{const t=e.requestFullscreen||e.webkitRequestFullscreen||e.msRequestFullscreen;t==null||t.call(e)}})}function Phe(){const h=document.getElementById("settingsBtn"),e=document.getElementById("settingsPanel");!h||!e||(h.addEventListener("click",t=>{t.stopPropagation(),e.classList.toggle("show")}),document.addEventListener("click",t=>{!e.contains(t.target)&&t.target!==h&&e.classList.remove("show")}),document.addEventListener("keydown",t=>{t.key==="Escape"&&e.classList.contains("show")&&e.classList.remove("show")}))}function Lhe(h){const e=h.app;let t=r(),s=null,i=0,a=!1,n=null;e.root.addChild(t);function r(){const f=new Kt("gsplat-holder");return f.addComponent("gsplat",{asset:null}),f}function l(f){f!=null&&f.resource&&typeof f.resource=="object"&&"destroy"in f.resource&&f.resource.destroy(),f&&e.assets.remove(f)}async function u(f){var M,w;if(a){n=f;return}a=!0,rh!==null&&clearTimeout(rh),rh=window.setTimeout(()=>{var T;ja||(ja=document.getElementById("statusArea")),ja?(ja.textContent="Loading model...",ja.style.color="#bbb"):Bn&&(Bn.textContent="Loading model...",Bn.style.background="rgba(0,0,0,0.6)"),eF(!0),(T=window.setGridLoading)==null||T.call(window,!0),rh=null},200),console.log(`Switching to model: ${f}`);const _=++i;if(s){const T=(M=s.gsplat)==null?void 0:M.asset;s.destroy(),l(T),s=null}const g=new URL(`${f}/meta.json`,document.baseURI).href,y=new Ye(`gsplat-${f}`,"gsplat",{url:g});e.assets.add(y);const v=r();e.root.addChild(v),s=v;let x=null;const C=(T,R)=>{var I;const D=(I=T.file)==null?void 0:I.url;typeof D=="string"&&D.includes(`${f}/`)&&(x=R instanceof Error?R:new Error(String(R)))};e.assets.on("error",C);try{const T=await fetch(g);if(!T.ok)throw new Error(`Meta file not found for model '${f}' (HTTP ${T.status})`);const R=await T.json();if(!R||!R.means)throw new Error(`Invalid meta.json for model '${f}' (missing means)`);if(y.data=R,await new Promise((D,I)=>{y.once("load",D),y.once("error",I),e.assets.load(y)}),x)throw x;if(_!==i){v.destroy(),l(y);return}if(v.gsplat.asset=y,x||(await new Promise(D=>{let U=0;const O=()=>{var N;(N=v.gsplat.instance)!=null&&N.sorter?v.gsplat.instance.sorter.once("updated",D):++U<5?setTimeout(O,50*U):setTimeout(D,300)};O()}),x))throw x;if(_!==i){v.destroy(),l(y);return}if(await new Promise(D=>{e.once("frameend",()=>{var U,O,N;if(_!==i){D();return}if(t&&t!==v){const z=(U=t.gsplat)==null?void 0:U.asset;t.destroy(),l(z)}t=v,s=null;const I=Che(f);if(I){(O=window.markCellCached)==null||O.call(window,I[0],I[1]);const z=`${I[0]},${I[1]}`;if(!vD.has(z)){const X=PL(I[0],I[1]);DL+=w2[X]||0,vD.add(z),Zp==null||Zp()}}if(typeof e.renderNextFrame=="function"&&e.renderNextFrame(),a=!1,n||(rh!==null&&(clearTimeout(rh),rh=null),eF(!1),(N=window.setGridLoading)==null||N.call(window,!1)),n){const z=n;n=null,u(z)}D()})}),x)throw x}catch(T){console.error(`Failed to load ${f}`,T),v.destroy(),l(y),a=!1,n=null,rh!==null&&(clearTimeout(rh),rh=null),ja||(ja=document.getElementById("statusArea")),ja?(ja.textContent="Error loading model",ja.style.color="#ff6666"):Bn&&(Bn.textContent="Error loading model",Bn.style.background="rgba(128,0,0,0.8)",Bn.style.visibility="visible"),(w=window.setGridLoading)==null||w.call(window,!1)}finally{e.assets.off("error",C)}}if(window.switchModel=u,window._pendingSwitchModelDir){const f=window._pendingSwitchModelDir;window._pendingSwitchModelDir=null,u(f)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",SD):SD();window.addEventListener("load",()=>{yD||SD()});
